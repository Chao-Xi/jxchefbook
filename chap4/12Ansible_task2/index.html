
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Chef&Ansible Automation 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../11Ansible_task1/">
      
      
        <link rel="next" href="../13Ansible_int/">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.5">
    
    
      
        <title>L12 任务中心之Ansible进阶篇 - Jacob Chef&Ansible Automation Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l12-ansible" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Chef&amp;Ansible Automation Book" class="md-header__button md-logo" aria-label="Jacob Chef&Ansible Automation Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Chef&Ansible Automation Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L12 任务中心之Ansible进阶篇
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxchefbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxchefbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Chef&amp;Ansible Automation Book" class="md-nav__button md-logo" aria-label="Jacob Chef&Ansible Automation Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Chef&Ansible Automation Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxchefbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxchefbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learning Chef
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Learning Chef
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Chef 介绍和安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Ruby和Chef语法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 如何写 Chef 配方 & chef-apply
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 用Test Kitchen管理沙盒测试环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 用 Chef 户端管理节点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 撰写和使用菜谱
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial7_attributes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 Chef 属性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Chef 服务器同时管理多个节点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 社区以及Chef-Client菜谱
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial10_zero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Chef zero
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial11_databag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十一节 数概包Databag
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 角色
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial13_env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial14_test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 测试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial15_term/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十五节 词汇表
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/chef_tutorial16_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十六节 Chef Tutorial Interview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Chef Opt & Adv
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Chef Opt & Adv
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Chef Roles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Cookbook Versioning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 How to Perform Chef Knife SSL Check and Fetch to Verify Certificate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 12 Chef Knife Cookbook Command Examples
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_op1_kinfe_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 knife search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Chef Quick CheatSheet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Chef Cookbook Sample LAMP
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Chef Cookbook Sample LAMP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/chef_basic5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Creating My First Chef Cookbook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/chef_basic6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Creating LAMP Chef Cookbook Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learning Ansible
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Learning Ansible
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../1ansible_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L1 Ansible Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2ansible_over_install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L2 Ansible Install(MacOs) and Environment Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../3play_task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L3 Task Execution management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../4Ansible_variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L4 Ansible Variable Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../5Complex_roles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L5 Managing complex playbooks with roles and ansible galaxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../6Secret_management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L6 Working with Secrets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../7Network_management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L7 Network Management with Ansible
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../8idempotentence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L8 Idempotentence with Ansible play
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../9Ansible_interview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L9 Ansible Interview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../10Ansible_learn_ppt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L10 Ansible 自动化运维工具PPT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../11Ansible_task1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L11 任务中心之Ansible基础篇
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    L12 任务中心之Ansible进阶篇
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    L12 任务中心之Ansible进阶篇
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1ansible-playbook" class="md-nav__link">
    1、ansible-playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2playbook" class="md-nav__link">
    2、playbook 核心元素
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3ansible-playbook" class="md-nav__link">
    3、ansible-playbook命令
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4ansible-playbook-setup" class="md-nav__link">
    4、ansible-playbook setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5ansible-playbook-set_fact" class="md-nav__link">
    5、ansible-playbook set_fact
  </a>
  
    <nav class="md-nav" aria-label="5、ansible-playbook set_fact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fact" class="md-nav__link">
    手动采集 fact
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fact_1" class="md-nav__link">
    fact缓存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fact_2" class="md-nav__link">
    关闭fact（提高执行效率）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6ansible-playbook" class="md-nav__link">
    6、ansible-playbook 变量
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-ansible-playbook-template" class="md-nav__link">
    7 ansible-playbook template
  </a>
  
    <nav class="md-nav" aria-label="7 ansible-playbook template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    算术运算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when" class="md-nav__link">
    when 条件语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with_tiems" class="md-nav__link">
    迭代变量 with_tiems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-if" class="md-nav__link">
    流程控制、循环 for 与 if
  </a>
  
    <nav class="md-nav" aria-label="流程控制、循环 for 与 if">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forconfj2" class="md-nav__link">
    for.conf.j2 文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forconf" class="md-nav__link">
    查看生成 for.conf 文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    字典形式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-suser-is-defined-suser" class="md-nav__link">
    {% if s.user is defined %}判断 是否有 s.user 这个变量
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-handles" class="md-nav__link">
    8 handles 示范
  </a>
  
    <nav class="md-nav" aria-label="8 handles 示范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-tags" class="md-nav__link">
    9 Tags示范
  </a>
  
    <nav class="md-nav" aria-label="9 Tags示范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9-1-tags" class="md-nav__link">
    9-1 tags
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-ansible-vault" class="md-nav__link">
    10 ansible-vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-ansible-console" class="md-nav__link">
    11 ansible-console
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-ansible-roles" class="md-nav__link">
    12 ansible Roles
  </a>
  
    <nav class="md-nav" aria-label="12 ansible Roles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roles-tags" class="md-nav__link">
    roles tags 标签
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roles-when" class="md-nav__link">
    roles when 语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-vars" class="md-nav__link">
    extra-vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2demo" class="md-nav__link">
    附上2个Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../13Ansible_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L13 Ansible 面试知识点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../14Ansible_containerd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L14 Ansible Role批量部署Containerd服务
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    HashiCorp Certified Terraform Associate
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            HashiCorp Certified Terraform Associate
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1hashicorp_certified_terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HashiCorp Certified Terraform Associate Learning Path
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2terraform_cs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Cheat Sheet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3terraform_lock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    .terraform.lock.hcl 简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4terraform_var/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    terraform.tfvars 与 variables.tf 的区别
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5terraform_random/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform: Random 简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/6terraform_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Top Terraform Interview Questions and Answers (2022)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/7terraform_provider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform provider update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/8terraform_docker_jenkins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform install Jenkins in Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/9terraform_local/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    解决Terraform初始化慢~配置本地离线源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/10terraform_adv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform(Troubleshooting/Data Sources/Existing Resource)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/11tf_adv_exam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Exam(Backend/Command/Script/Others)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/12terraform_jenkins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12 Adding Terraform to a CI/CD Pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/13terraform_cmt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Integrating with Configuration Managers(Anisble)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Puppet Learning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Puppet Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/1pp_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Puppet - Overview & Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/2pp_install_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Puppet - 安装, 配置以及验证
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/3pp_coding_style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Puppet - 编码风格
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/4pp_key_comps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Puppet - 核心模块
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/5pp_resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 Puppet - 资源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/6pp_tmp_cls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Puppet - 模板 & 类
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/7pp_func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Puppet - Function
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/8pp_env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Puppet - 环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/9app_type_pr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 Puppet - 类型和提供者
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/10pp_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10 Puppet - RESTful API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/11pp_proj1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11 Puppet - Live Project 1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ArgoCD Learning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            ArgoCD Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7_argocd/1Intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Introduction to Continuous Delivery
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1ansible-playbook" class="md-nav__link">
    1、ansible-playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2playbook" class="md-nav__link">
    2、playbook 核心元素
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3ansible-playbook" class="md-nav__link">
    3、ansible-playbook命令
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4ansible-playbook-setup" class="md-nav__link">
    4、ansible-playbook setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5ansible-playbook-set_fact" class="md-nav__link">
    5、ansible-playbook set_fact
  </a>
  
    <nav class="md-nav" aria-label="5、ansible-playbook set_fact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fact" class="md-nav__link">
    手动采集 fact
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fact_1" class="md-nav__link">
    fact缓存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fact_2" class="md-nav__link">
    关闭fact（提高执行效率）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6ansible-playbook" class="md-nav__link">
    6、ansible-playbook 变量
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-ansible-playbook-template" class="md-nav__link">
    7 ansible-playbook template
  </a>
  
    <nav class="md-nav" aria-label="7 ansible-playbook template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    算术运算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when" class="md-nav__link">
    when 条件语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with_tiems" class="md-nav__link">
    迭代变量 with_tiems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-if" class="md-nav__link">
    流程控制、循环 for 与 if
  </a>
  
    <nav class="md-nav" aria-label="流程控制、循环 for 与 if">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forconfj2" class="md-nav__link">
    for.conf.j2 文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forconf" class="md-nav__link">
    查看生成 for.conf 文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    字典形式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-suser-is-defined-suser" class="md-nav__link">
    {% if s.user is defined %}判断 是否有 s.user 这个变量
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-handles" class="md-nav__link">
    8 handles 示范
  </a>
  
    <nav class="md-nav" aria-label="8 handles 示范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-tags" class="md-nav__link">
    9 Tags示范
  </a>
  
    <nav class="md-nav" aria-label="9 Tags示范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9-1-tags" class="md-nav__link">
    9-1 tags
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-ansible-vault" class="md-nav__link">
    10 ansible-vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-ansible-console" class="md-nav__link">
    11 ansible-console
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-ansible-roles" class="md-nav__link">
    12 ansible Roles
  </a>
  
    <nav class="md-nav" aria-label="12 ansible Roles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roles-tags" class="md-nav__link">
    roles tags 标签
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roles-when" class="md-nav__link">
    roles when 语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-vars" class="md-nav__link">
    extra-vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2demo" class="md-nav__link">
    附上2个Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l12-ansible"><strong>L12 任务中心之Ansible进阶篇</strong></h1>
<h2 id="1ansible-playbook"><strong>1、<code>ansible-playbook</code></strong></h2>
<p><strong>playbook &amp; yml 说明</strong></p>
<ul>
<li>playbook 由一个或多个 play 组成.</li>
<li>playbook 中 每个play 必须包含 hosts 和 tasks.</li>
<li>playbook 以 yaml 语法编写.<ul>
<li>可读性强</li>
<li>脚本语言交互性能力强</li>
<li>使用实现语言的数据类型</li>
<li>一致性的信息模型</li>
<li>易于实现</li>
<li>基于流模式处理</li>
<li>表达能力好, 扩展性强</li>
<li>YAML 约定以 <code>---</code> 开头 和 开始不同的<code>play</code> .</li>
<li>YAML 以 <code>#</code> 作为注释.</li>
<li>YAML 必须统一缩进, 空格 与 <code>tab</code> 不能混用, 缩进的级别也必须相同, 同级缩进代表同样的级别.</li>
<li>YAML 文件内容 是大小写敏感的, 跟 <code>Linux</code>一样区分大小写.</li>
<li>YAML <code>key/value</code> 形式可写在同一行也可以换行写. 同行使用 : 隔开.</li>
<li>YAML 一个完整的代码块功能最少包含2个元素. 如 <code>name: task</code></li>
<li>YAML 一个 name 下只能包含一个 task</li>
<li>YAML - 开头的为列表,<code>key/value</code> 形式的为字典.</li>
<li>YAML 特性</li>
</ul>
</li>
</ul>
<h2 id="2playbook"><strong>2、playbook 核心元素</strong></h2>
<ul>
<li>hosts 远程主机列表 ( <code>ip_addr/hostname/groupname</code> )</li>
<li>tasks 任务集, 任务列表, 有两种写法。<ul>
<li>action: module args action 参数。</li>
<li>module: args 参数 (一般使用这种)。</li>
<li><code>ignore_errors</code>: True 当前 task 出错时仍然会向下执行。</li>
</ul>
</li>
<li>varniables 内置变量或自定义变量在 playbook 文件中调用。</li>
<li>templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件。</li>
<li>handles 与 notity 结合使用, 由特定条件触发的操作, 满足条件执行, 否则不执行。</li>
<li>tags 标签 指定任务执行, 用于执行一个 playbook 中的部分代码. 主要用于测试ansible的语法与执行验证。</li>
</ul>
<h2 id="3ansible-playbook"><strong>3、<code>ansible-playbook</code>命令</strong></h2>
<p><code>ansible-playbook</code>
    * <code>-C --check</code> Check 检查脚本运行情况, 不会在远程服务器里运行。
    * <code>--list-hosts</code> 列出执行此任务的主机。
    * <code>--list-tasks</code> 列出任务组的具体任务列表。
    * <code>--limit</code> 只对主机列表中的某台主机执行。
    * <code>-v -vv -vvv</code> 显示详细的执行DEBUG信息过程, 多个v参数等于DEBUG信息的叠加，显示更为详细</p>
<h2 id="4ansible-playbook-setup"><strong>4、<code>ansible-playbook setup</code></strong></h2>
<p>介绍: 这个模块默认会被<code>playbooks</code>自动调用，用于收集远程主机的相关变量信息，获取到变量信息可以被playbooks调用。针对 setup模块，我们经常使用的是 <code>fact</code> ，在此只对<code>fact</code>做详细讲解，其他的就不过多叙述了，如果想了解详细信息，可以访问官方文档获取帮助。</p>
<ul>
<li><code>fact</code> 是<code>ansible</code>模块<code>setup</code>的功能，主要用于获取相关信息作为变量继承给playbook子任务调用。</li>
<li><code>gather_facts</code>:</li>
</ul>
<pre><code># ansible k3s-cluster -m setup
ubuntu20-bj03 | SUCCESS =&gt; {
    &quot;ansible_facts&quot;: {
        &quot;ansible_all_ipv4_addresses&quot;: [
            &quot;10.0.16.4&quot;
        ],
        &quot;ansible_all_ipv6_addresses&quot;: [
            &quot;fe80::5054:ff:fed6:42a8&quot;
        ],
        &quot;ansible_apparmor&quot;: {
            &quot;status&quot;: &quot;enabled&quot;
        },
        &quot;ansible_architecture&quot;: &quot;x86_64&quot;,
        &quot;ansible_bios_date&quot;: &quot;04/01/2014&quot;,
        &quot;ansible_bios_vendor&quot;: &quot;SeaBIOS&quot;,
        &quot;ansible_bios_version&quot;: &quot;seabios-1.9.1-qemu-project.org&quot;,
        &quot;ansible_board_asset_tag&quot;: &quot;NA&quot;,
        &quot;ansible_board_name&quot;: &quot;NA&quot;,
        &quot;ansible_board_serial&quot;: &quot;NA&quot;,
        &quot;ansible_board_vendor&quot;: &quot;NA&quot;,
        &quot;ansible_board_version&quot;: &quot;NA&quot;,
        &quot;ansible_chassis_asset_tag&quot;: &quot;NA&quot;,
        &quot;ansible_chassis_serial&quot;: &quot;NA&quot;,
        &quot;ansible_chassis_vendor&quot;: &quot;Smdbmds&quot;,
        &quot;ansible_chassis_version&quot;: &quot;3.0&quot;,

        # 多余的冗余信息就不放了，自己可以执行验证下。
        # setup获得变量信息，都可以用于继承给playbook调用。
}
</code></pre>
<p>自定义Fact</p>
<p><strong>手动设置:</strong></p>
<p>ansible除了能获取到内置的fact的变量信息，还可以手动为某个主机组或者主机定制本地<strong>fact</strong>。</p>
<p><strong>本地 <code>fact</code>默认存放宿主机的<code>/etc/ansible/facts.d</code>目录下，支持的文件格式为<code>ini</code>、<code>json</code></strong>。</p>
<p>加载后的fact的key是<code>ansible_local</code>的特殊变量。</p>
<p><strong><code>denis_test.fact</code></strong></p>
<pre><code>[general]
package = vsftpd
service = vsftpd
state = starte
</code></pre>
<p><strong><code>setup_facts.yaml</code></strong></p>
<pre><code>---
- name: Install Remote Facts
  hosts: k3s-cluster
  vars: 
    remote_dir: /etc/ansible/facts.d
    facts_file: denis_test.fact
  tasks:
    - name: Create Directory
      file:
        state: directory
        recurse: yes
        path: &quot;{{ remote_dir }}&quot;
    - name: Install the new facts
      copy:
        src: &quot;{{ facts_file }}&quot;
        dest: &quot;{{ remote_dir }}&quot;
</code></pre>
<p><strong>执行测试</strong></p>
<pre><code># ansible-playbook setup_facts.yaml

# ansible test -m setup        
ubuntu20-bj03 | SUCCESS =&gt; {
    &quot;ansible_facts&quot;: {

        # -----分隔符-----

        &quot;ansible_local&quot;: {
            &quot;custom&quot;: {
                &quot;general&quot;: {
                    &quot;package&quot;: &quot;vsftpd&quot;,
                    &quot;service&quot;: &quot;vsftpd&quot;,
                    &quot;state&quot;: &quot;started&quot;
                }
            }
        },

        # -----分隔符-----
</code></pre>
<p><strong>调用测试</strong></p>
<p><strong><code>deniss_test.yaml</code></strong></p>
<pre><code>- name: Install Apache and starts the service
  hosts: k3s-cluster
  tasks:
    - name: Install Package
      yum: 
        name: &quot;{{ ansible_facts.ansible_local.custom.general.package }}&quot;
        state: latest
    - name: Start Service
      service: 
        name: &quot;{{ ansible_facts.ansible_local.custom.general.service }}&quot;
        state: &quot;{{ ansible_facts.ansible_local.custom.general.state }}&quot;
</code></pre>
<h2 id="5ansible-playbook-set_fact"><strong>5、<code>ansible-playbook set_fact</code></strong></h2>
<p>使用<code>set_fact</code>设置新的变量</p>
<ul>
<li><code>set_fact</code>可以自定义变量通过template或者变量的方式在playbook中继承使用。</li>
<li>如：假设你需要获取一个进程使用的内存的使用率，必须通过<code>set_fact</code>来进行计算之后得出结果，并将其值在playbook中继承使用。</li>
</ul>
<p><strong><code>deniss_fact_demo.yaml</code></strong></p>
<pre><code>- name: set_fact demo
  hosts: k3s-cluster
  tasks:
    - name: Calculate InnoDB buffer pool size
      set_fact: innodb_buffer_pool_size_mb=&quot;{{ ansible_memtotal_mb / 2 |int }}&quot;      
    - debug: var=innodb_buffer_pool_size_mb
</code></pre>
<p>执行测试</p>
<pre><code># ansible-playbook deniss_fact_demo.yaml 
PLAY [set_fact demo] *****************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Calculate InnoDB buffer pool size] ************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [debug] ****************************************************************************************************************************************************************
ok: [ubuntu20-bj03] =&gt; {
    &quot;innodb_buffer_pool_size_mb&quot;: &quot;2911.2&quot;
}

PLAY RECAP ******************************************************************************************************************************************************************
ubuntu20-bj03                : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</code></pre>
<h3 id="fact"><strong>手动采集 fact</strong></h3>
<p><strong><code>gather_facts: False</code></strong></p>
<p>我们在运行<code>playbook</code>的时候，Ansible会先<code>ssh</code>连接被控端采集<code>fact</code>，如果被控制端的<code>ssh</code>还没有完成运行，就会导致整个<code>playbook</code>执行失败。</p>
<p><strong>解决这个问题，可以先在配置中关闭<code>fact</code>采集，然后在<code>task</code>中通过<code>wait_for</code>探测被控端ssh端口是否正常监听，然后在task中在手动setup模块来采集fact</strong></p>
<pre><code>- hosts: k3s-cluster
  name: test demo 
  gather_facts: False
  tasks：
    - name: wait for ssh to be running
      local_action: wait_for port=22 host=&quot;{{ inventory_hostname }}&quot; search_regex=OpenSSH
    - name: gather facts
      setup:
</code></pre>
<h3 id="fact_1"><strong>fact缓存</strong></h3>
<p>如果在playbook中需要继承fact，可启用fact缓存来提高效率。</p>
<p><strong>fact支持缓存 json、memcached、redis</strong></p>
<p>ansible.cfg中的配置说明:</p>
<p>json 以json格式文件作为fact缓存后端，ansible将会把采集的fact写入到宿主机的本地目录，最好是SSD硬盘。</p>
<p>redis 使用redis做缓存。</p>
<p>memcached 使用memcached做缓存。</p>
<ul>
<li><strong>smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts</strong>；</li>
<li><strong>implicit 表示默认收集 facts，要禁止收集，必须使用 <code>gather_facts: False</code>；</strong></li>
<li><strong>explicit 则表示默认不收集，要显式收集，必须使用 <code>gather_facts: Ture</code></strong>。</li>
</ul>
<pre><code>[defaults]
gathering = smart
# 缓存时间
fact_caching_timeout = 86400    
fact_caching = {jsonfile/redis/memcached}
# 指定ansible包含fact的json文件位置，如果目录不存在，会自动创建
# local
fact_caching_connection = /tmp/ansible_fact_cache
# redis
fact_caching_connection = 127.0.0.1:6379:admin
# memcached
fact_caching_connection = ['127.0.0.1:11211']
</code></pre>
<h3 id="fact_2"><strong>关闭fact（提高执行效率）</strong></h3>
<p>在配置中关闭fact，整个playbookfact变量将不会在显示，可以提高执行效率，但是有时候又需要使用 facts 中的信息，这时候可以按照上述设置 facts 的缓存，在空闲的时候收集 facts，缓存下来，在需要的时候直接读取缓存进行引用。</p>
<pre><code># playbook 配置
- hosts: k3s-cluster
  gather_facts: no
# ansible.cfg 配置  
[defaults]
gathering = explicit
</code></pre>
<h2 id="6ansible-playbook"><strong>6、<code>ansible-playbook</code> 变量</strong></h2>
<p>变量名要求: 只允许使用 <strong>字母 、数字 、 <code>_</code></strong> 组成, 而且只能以 <strong>字母</strong> 开头。</p>
<p>内置的公共变量:</p>
<ul>
<li><strong><code>ansible k3s-cluster -m setup -a 'filter=*addresses*'</code>  可使用 <code>filter</code> 参数进行过滤</strong></li>
<li><strong>使用 <code>ansible k3s-cluster -m setup</code> 可以获取到主机的系统变量名称</strong></li>
</ul>
<p><strong>通过文件自定义变量:</strong></p>
<ul>
<li><strong>对主机组中的主机单独定义变量, 优先级高于公共变量</strong>。</li>
<li>对主机组中的所有主机定义统一变量, 优先级低于对单独主机定义的变量。</li>
<li><code>/etc/ansible/hosts</code> 文件中定义</li>
</ul>
<pre><code>[appserver]
# 定义变量 node_id
10.0.8.2 node_id=17

# 对主机组 定义统一变量 domain_name
[k3s-cluster:vars]
domain_name=deniss.wang
</code></pre>
<p><strong>使用变量灵活配置不同主机的 <code>hostname</code></strong></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  tasks:
    - name: set hostname
      hostname: name={{ node_id }}.{{ domain_name }}
</code></pre>
<p>通过命令行定义变量: 通过命令行定义的变量优先级是最高的</p>
<pre><code>ansible-playbook -e varname=valur
</code></pre>
<p>在 playbook 文件里 定义变量.</p>
<ul>
<li><strong>通过 <code>{{ 变量名 }}</code> 使用变量，另外需要注意的是，如果有中文，需要使用<code>""</code>把变量括起来。</strong></li>
<li><strong>通过 <code>vars:</code> 列表 定义多个 变量.</strong></li>
</ul>
<pre><code>---
- hosts: k3s-cluster
  remote_user: root

  # 定义变量
  vars:
    - pkg_name: httpd
    - env_name: prod

  tasks:
    - name: {{ env_name }} install {{ pkg_name }}
      yum: name={{ pkg_name }}
</code></pre>
<p>通过定义单独的变量文件 用于统一存放变量, 可避免变量的重复定义。</p>
<ul>
<li>定义单独的 变量文件, 只需要将所有变量以 <code>key: value</code> 形式写入到 <code>yaml</code>文件中既可。</li>
<li>在 <code>playbook</code> 文件中, 只需要使用 <code>vars_files:</code> 指定 yaml 文件路径既可。</li>
</ul>
<p><strong><code>vars.yaml</code> 变量文件</strong></p>
<pre><code>---
pkg_name: httpd
file_name: deniss.wang
</code></pre>
<p><strong><code>install.yaml</code></strong></p>
<pre><code>---
- hosts: k3s-cluster
  remote_user: root

  # 配置模板文件
  vars_files:
    # 指定文件的路径
    - vars.yaml

  tasks:
    - name: install {{ pkg_name }}
      yum: name={{ pkg_name }}
    - name: create {{ file_name }} file
      file: name=/tmp/{{ file_name }}.txt state=touch
</code></pre>
<p>执行 playbook 操作</p>
<pre><code># ansible-playbook install.yaml
PLAY [k3s-cluster] *******************************************************************************************************

TASK [Gathering Facts] *******************************************************************************************
ok: [10.0.8.2]

TASK [install httpd] *********************************************************************************************
changed: [10.0.8.2]

TASK [create deniss.wang file] **************************************************************************************
changed: [10.0.8.2]

PLAY RECAP *******************************************************************************************************
10.0.8.2                  : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<h2 id="7-ansible-playbook-template"><strong>7 ansible-playbook template</strong></h2>
<p><code>template</code> 是<code>ansible-playbook</code>一个模块，用于存放生成配置的模板，使用jinja2语言编写，后缀为<code>xx.j2</code>，只能用于 playbook。</p>
<p><code>templates</code>文件, 可嵌套引用脚本。</p>
<ul>
<li>字符串: 使用单引号或双引号.</li>
<li>数字: 整数, 浮点数.</li>
<li>列表: [A1, A2, …]</li>
<li>元组: (B1, B2, …)</li>
<li>字典: {key1:value1, key2:value2, …}</li>
<li>布尔值: true/false</li>
<li>算术运算: <code>+, -, *, /, //, %, **</code></li>
<li>比较操作: <code>==, !=, &gt;, &gt;=, &lt;, &lt;=</code></li>
<li>逻辑运算: <code>and, or, not</code></li>
<li>流表达式: <code>for, if, when</code></li>
<li>Jinja2 语法：</li>
</ul>
<p>templates 根据模板块文件动态生成对应的配置文件</p>
<ul>
<li><strong>templates的模板文件必须存放于 <code>templates</code> 目录下, 并且以 <code>.j2</code> 为后缀</strong>。</li>
<li><strong>templates 目录需要与 <code>playbook</code> 的 <code>yaml</code> 文件在同级目录中</strong>。</li>
</ul>
<pre><code># tree nginx/
|-- nginx.yaml
|-- templates   
    |-- nginx.conf.j2
</code></pre>
<h3 id="_1"><strong>算术运算</strong></h3>
<p><strong><code>nginx.conf.j2</code></strong></p>
<pre><code>user nginx;
# 这里使用 环境变量 vcpus * 2，会根据操作系统CPU自动生成。
worker_processes {{ ansible_processor_vcpus * 2 }};
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 10240;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
}
</code></pre>
<p><strong>nginx.yaml</strong></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: nginx template conf
      # 如果yaml与templates在同一目录, src直接写.j2文件
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
      notify:
        - restart nginx
    - name: start nginx
      service: name=nginx state=started enabled=yes

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
</code></pre>
<h3 id="when"><strong>when 条件语句</strong></h3>
<p>when 条件语句 例子</p>
<pre><code># tree nginx
|-- nginx.yaml
|-- templates   
    |-- nginx.conf.centos7.j2   
    |-- nginx.conf.centos8.j2
</code></pre>
<p><strong>playbook 文件</strong></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template centos 7 conf
      # 如果 yaml 与 templates 在同一目录, src 直接写.j2 文件。
      template: src=nginx.conf.centos7.j2 dest=/etc/nginx/nginx.conf
      # 使用 when 语句进行判断 如果变量为 &quot;7&quot; 执行以下操作
      when: ansible_distribution_major_version == &quot;7&quot;
      notify:
        - restart nginx
    - name: template centos 8 conf
      # 同上
      template: src=nginx.conf.centos8.j2 dest=/etc/nginx/nginx.conf
      # 使用 when 语句进行判断 如果变量为 'Ubuntu' 且版本为20 执行以下操作
   when: (ansible_distribution == &quot;Ubuntu&quot; and ansible_distribution_major_version == &quot;20&quot;
      notify:
        - restart nginx
    - name: start nginx
      service: name=nginx state=started enabled=yes

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
</code></pre>
<p>执行 playbook 文件</p>
<p><strong><code>skipping</code> 状态表示跳过执行这个 TASK。</strong></p>
<pre><code>
# ansible-playbook nginx.yml

PLAY [k3s-cluster] *******************************************************************************************

TASK [Gathering Facts] *******************************************************************************
ok: [10.0.8.2]

TASK [install nginx] *********************************************************************************
ok: [10.0.8.2]

TASK [template centos 7 conf] ************************************************************************
changed: [10.0.8.2]

TASK [template centos 8 conf] ************************************************************************
skipping: [10.0.8.2]

TASK [start nginx] ***********************************************************************************
ok: [10.0.8.2]

RUNNING HANDLER [restart nginx] **********************************************************************
changed: [10.0.3.13]

PLAY RECAP *******************************************************************************************
10.0.8.2      : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
</code></pre>
<h3 id="with_tiems"><strong>迭代变量 <code>with_tiems</code></strong></h3>
<ul>
<li>迭代<code>with_items</code> 执行重复任务。</li>
<li>对于迭代选项, 固定变量名为 item 。</li>
<li>在 task 中使用 <code>with_items</code>指定需要迭代的元素列表。</li>
</ul>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  tasks:
    - name: create multi files
      # {{ item }} 为内置特殊变量, 代表 with_items 列表中的内容
      file: name=/tmp/{{ item }} state=touch
      with_items:
        - file_one
        - file_two
        - file_three
        - file_four
    - name: install multi software
      yum: name={{ item }}
      with_items:
        - vsftpd
        - net-tools
        - iftop
</code></pre>
<p><strong>代嵌套子变量 (字典)</strong></p>
<ul>
<li>迭代嵌套子变量.</li>
<li>对迭代中的变量进行嵌套关联的操作.</li>
</ul>
<p>playbook 文件</p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  tasks:
    - name: create some files
      # {{ item }} 为特殊变量, 代表 with_itmes 列表中的内容
      file: name=/tmp/{{ item }} state=touch
      with_items:
        - file_one
        - file_two
        - file_three
        - file_four

    - name: create multi group
      group: name={{ item }}
      with_items:
        - jinja2_file1
        - jinja2_file2
        - jinja2_file3
        - jinja2_file4

    - name: create multi user
      # 使用 item.key值 进行引用
      user: name={{ item.name }} group={{ item.group }}
      # 使用 字典 定义 嵌套的子 变量
      with_items:
        - { name: 'file_one', group: 'jinja2_file1' }
        - { name: 'file_two', group: 'jinja2_file2' }
        - { name: 'file_three', group: 'jinja2_file3' }
        - { name: 'file_four', group: 'jinja2_file4' }

    - name: permission multi files
      file: name=/tmp/{{ item.name }} owner={{ item.name }} group={{ item.group }}
      with_items:
        - { file: 'file_one', name: 'file_one', group: 'jinja2_file1' }
        - { file: 'file_two', name: 'file_two', group: 'jinja2_file2' }
        - { file: 'file_three', name: 'file_three', group: 'jinja2_file3' }
        - { file: 'file_four', name: 'file_four', group: 'jinja2_file4' }
</code></pre>
<p>执行 playbook 文件</p>
<p><strong><code>ansible-playbook file.yml</code></strong></p>
<pre><code>PLAY [k3s-cluster] *****************************************************************************************

TASK [Gathering Facts] *****************************************************************************
ok: [10.0.8.2]

TASK [create multi files] ***************************************************************************
changed: [10.0.8.2] =&gt; (item=file_one)
changed: [10.0.8.2] =&gt; (item=file_two)
changed: [10.0.8.2] =&gt; (item=file_three)
changed: [10.0.8.2] =&gt; (item=file_four)

TASK [create multi group] ***************************************************************************
changed: [10.0.8.2] =&gt; (item=jinja2_file1)
changed: [10.0.8.2] =&gt; (item=jinja2_file2)
changed: [10.0.8.2] =&gt; (item=jinja2_file3)
changed: [10.0.8.2] =&gt; (item=jinja2_file4)

TASK [create multi user] ****************************************************************************
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file1', u'name': u'file_one'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file2', u'name': u'file_two'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file3', u'name': u'file_three'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file4', u'name': u'file_four'})

TASK [permission multi files] ***********************************************************************
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file1', u'name': u'file_one', u'file': u'file1'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file2', u'name': u'file_two', u'file': u'file2'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file3', u'name': u'file_three', u'file': u'file3'})
changed: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file4', u'name': u'file_four', u'file': u'file4'})

PLAY RECAP *****************************************************************************************
10.0.8.2    : ok=5    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<h3 id="for-if"><strong>流程控制、循环 for 与 if</strong></h3>
<p>for 循环</p>
<p><strong><code>{% for 语句块 %} ... {% endfor %}</code></strong></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  vars:
    # 列表
    listen_port:
      - 80
      - 81
      - 82
    # 字典
    service:
      - name: web1
        domain: deniss.wang
        port: 9090
        user: nginx
        path: /var/www/html 
      - name: web2
        domain: deniss.wang
        port: 9091
        user: nginx
        path: /var/www/html
      - name: web3
        domain: deniss.wang
        port: 9092
        user: nginx
        path: /var/www/html

  tasks:
    - name: copy template conf
      template: src=for.conf.j2 dest=/tmp/for.conf
</code></pre>
<h4 id="forconfj2"><code>for.conf.j2</code> 文件</h4>
<p><strong><code>{% for port in listen_port %}</code>语句<code>listen_port</code> 为 <code>playbook</code>中定义的 <code>vars</code> 。</strong></p>
<pre><code>{% for port in listen_port %}

server {
   listen {{ port }}
}

{% endfor %}
</code></pre>
<h4 id="forconf"><strong>查看生成 <code>for.conf</code> 文件</strong></h4>
<pre><code># cat /root/for.conf

server {
   listen 80
}


server {
   listen 81
}


server {
   listen 82
}
</code></pre>
<h4 id="_2"><strong>字典形式</strong></h4>
<p><code>nginx.yaml</code></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  vars:
    # 字典的形式
    service:
      - name: web1
        domain: deniss.wang
        port: 9090
        user: nginx
        path: /var/www/html
      - name: web2
        domain: deniss.wang
        port: 9091
        user: nginx
        path: /var/www/html
      - name: web3
        domain: deniss.wang
        port: 9092
        user: nginx
        path: /var/www/html

  tasks:
    - name: copy template conf
      template: src=nginx.conf.j2 dest=/tmp/nginx.conf
</code></pre>
<p><strong><code>nginx.conf.j2</code> 文件，放在templates下面</strong></p>
<pre><code>{% for s in service %}
user {{ s.user }};
worker_processes {{ ansible_processor_vcpus * 2 }};
pid /run/nginx.pid;
    server {
        listen       {{ s.port }} default_server;
        listen       [::]:{{ s.port }} default_server;
        server_name  {{ s.name }}.{{ s.domain }};
        root         {{ s.path }};
    }

{% endfor %}
</code></pre>
<p><strong>if 流程控制</strong>: <code>{% if 语句块 %} ... {% else %} ... {% endif %}</code></p>
<p><strong>playbook 文件</strong></p>
<p>其中 web1, web2 不传 user 变量，web3 传 user 变量。</p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  vars:
    # 字典
    service:
      - name: web1
        domain: deniss.wang
        port: 90
        path: /var/www/html

      - name: web2
        domain: deniss.wang
        port: 91
        path: /var/www/html

      - name: web3
        domain: deniss.wang
        port: 92
        user: nginx
        path: /var/www/html

  tasks:
    - name: copy template conf
      template: src=nginx2.conf.j2 dest=/tmp/nginx2.conf
</code></pre>
<p><strong><code>nginx2.conf.j2</code> 文件</strong></p>
<h4 id="if-suser-is-defined-suser"><code>{% if s.user is defined %}</code>判断 是否有 <code>s.user</code> 这个变量</h4>
<pre><code>{% for s in service %}

{% if s.user is defined %}
user {{ s.user }};
{% else %}
user root;
{% endif %}
worker_processes {{ ansible_processor_vcpus * 2 }};
pid /run/nginx.pid;
    server {
        listen       {{ s.port }} default_server;
        server_name  {{ s.name }}.{{ s.domain }};
        root         {{ s.path }};
    }

{% endfor %}
</code></pre>
<p><strong>查看生成后的 <code>nginx2.conf</code></strong></p>
<ul>
<li>第一个server 不包含 <code>s.user</code> 变量 所以 <code>user root;</code></li>
<li>第二个server 不包含 <code>s.user</code> 变量 所以 <code>user root</code>;</li>
<li>第三个server 包含 <code>s.user</code> 变量 所以 <code>user nginx</code>; 等于变量值</li>
</ul>
<pre><code>
# cat  nginx2.conf
user root;
worker_processes 4;
pid /run/nginx.pid;
    server {
        listen       90 default_server;
        server_name  web1.deniss.wang;
        root         /var/www/html;
    }


user root;
worker_processes 4;
pid /run/nginx.pid;
    server {
        listen       91 default_server;
        server_name  web2.deniss.wang;
        root         /var/www/html;
    }


user nginx;
worker_processes 4;
pid /run/nginx.pid;
    server {
        listen       92 default_server;
        server_name  web3.deniss.wang;
        root         /var/www/html;
    }
</code></pre>
<p><strong>tasks 示范</strong></p>
<p>定义一组执行任务，可以包含多个模块的集合。</p>
<p>Demo</p>
<pre><code>---
# 指定主机组
- hosts: k3s-cluster
  # 开启提权，指定用户
  become: yes
  become_user: root

  # 任务
  tasks:
    # 任务的名称
    - name: ping server
      ping:
    - name: echo hostname
      # shell 为模块名, 后面等同于 -a '' 参数
      shell: hostname
    - name: touch file
      file: name=/tmp/file.txt state=touch
    - name: echo file
      shell: ls -l /tmp/file.txt
    - name: write file
      shell: echo &quot;hello world&quot; &gt; /tmp/file.txt
    - name: copy module write file
      copy: content=&quot;hello deniss\n&quot; dest=/tmp/deniss.txt
    - name: display file content
      shell: cat /tmp/file.txt
      register: display_content1
    - name: show
      debug: var=display_content1.stdout verbosity=0
    - name: display copy module file content
      shell: cat /tmp/deniss.txt
      register: display_content2
    - name: show
      debug: var=display_content2.stdout verbosity=0
</code></pre>
<pre><code># ansible-playbook hello.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [ping server] *******************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [echo hostname] *****************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [touch file] ********************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [echo file] *********************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [write file] ********************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [copy module write file] ********************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [display file content] **********************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [show] **************************************************************************************************************************************************************************
ok: [ubuntu20-bj03] =&gt; {
    &quot;display_content1.stdout&quot;: &quot;hello world&quot;
}

TASK [display copy module file content] **********************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [show] **************************************************************************************************************************************************************************
ok: [ubuntu20-bj03] =&gt; {
    &quot;display_content2.stdout&quot;: &quot;hello deniss&quot;
}

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=11   changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>状态释义:</p>
<ul>
<li><code>ok</code> : ok 未修改文件元数据，绿色</li>
<li><code>changed</code> : 数据有修改，黄色</li>
</ul>
<h2 id="8-handles"><strong>8 handles 示范</strong></h2>
<p>handles 与 notity 结合的例子</p>
<p>同一个name 下可以定义多个 notify 配置关联到不同的 handlers 中。</p>
<pre><code>---
# 指定主机组
- hosts: k3s-cluster
  # 开启提权，指定用户
  become: yes
  become_user: root

  tasks:
    - name: copy httpd.conf
      copy: src=~/ansible/httpd.conf dest=/etc/httpd/conf/httpd.conf backup=yes
      # 关联多个触发器的写法
      notify:
        - restart httpd
        - check status httpd
        - check network port
</code></pre>
<h3 id="demo"><strong>Demo</strong></h3>
<p><strong>Centos</strong></p>
<pre><code>---
# 指定主机组
- hosts: k3s-cluster
  # 开启提权，指定用户
  become: yes
  become_user: root

  tasks:
    - name: install httpd
      yum: name=httpd
    - name: copy httpd.conf
      copy: src=/opt/ansible/conf/httpd.conf dest=/etc/httpd/conf/httpd.conf backup=yes
      # 此任务 如果有变动会触发如下定义名称的触发器
      notify: restart httpd
    - name: start httpd
      service: name=httpd state=started enabled=yes

  # 触发器, 需要配置 notify 触发
  handlers:
    - name: restart httpd
      service: name=httpd state=restarted
</code></pre>
<p><strong>Ubuntu</strong></p>
<pre><code>---
# 指定主机组
- hosts: k3s-cluster
  # 开启提权，指定用户
  become: yes
  become_user: root

  tasks:
    - name: Update apt-get repo and cache
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
    - name: Install Vsftpd
      apt:
        name: vsftpd
    - name: copy vsftpd.conf
      copy: src=/opt/ansible/conf/vsftpd.conf dest=/etc/vsftpd.conf backup=yes
      notify: restart vsftpd
    - name: start vsftpd
      service: name=vsftpd state=started enabled=yes
  # 配置 notify 触发，修改配置文件的时候生效。
  handlers:
    - name: restart vsftpd
      service: name=vsftpd state=restarted
</code></pre>
<p>执行安装vsftpd PlayBook</p>
<pre><code># ansible-playbook install_vsftpd.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Update apt-get repo and cache] *************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Install Vsftpd] ****************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [copy vsftpd.conf] **************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [start vsftpd] ******************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>修改vsftpd文件以后会触发重启操作。</p>
<pre><code># ansible-playbook install_pkg.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Update apt-get repo and cache] *************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Install Vsftpd] ****************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [copy vsftpd.conf] **************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [start vsftpd] ******************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

RUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************
changed: [ubuntu20-bj03]

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p><strong>修改vsftpd文件以后会触发重启操作。</strong></p>
<pre><code># ansible-playbook install_pkg.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Update apt-get repo and cache] *************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [Install Vsftpd] ****************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [copy vsftpd.conf] **************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

TASK [start vsftpd] ******************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

RUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************
changed: [ubuntu20-bj03]

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<h2 id="9-tags"><strong>9 Tags示范</strong></h2>
<h4 id="9-1-tags"><strong>9-1 tags</strong></h4>
<ul>
<li>定义了 tags 后可通过定义的 tags 单独运行该 tags来执行指定的tasks， 运行多个可用 , 号分隔。</li>
<li>多个不同的任务中可以定义相同的 tags。</li>
</ul>
<pre><code>---
# 指定主机组
- hosts: k3s-cluster
  # 开启提权，指定用户
  become: yes
  become_user: root

  tasks:
    - name: Update apt-get repo and cache
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
    - name: Install Vsftpd
      apt:
        name: vsftpd
    - name: copy vsftpd.conf
      copy: src=conf/vsftpd.conf dest=/etc/vsftpd.conf backup=yes
      notify: restart vsftpd
      # 定义标签
      tags: cpconf      
    - name: start vsftpd
      service: name=vsftpd state=started enabled=yes
      # 定义标签
      tags: upvsftpd      
  # 配置 notify 触发，修改配置文件的时候生效。
  handlers:
    - name: restart vsftpd
      service: name=vsftpd state=restarted     
</code></pre>
<p><strong><code>-t</code> 指定标签执行</strong></p>
<pre><code># ansible-playbook -t upvsftpd  install_vsftpd.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [start vsftpd] ******************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

# ansible-playbook -t cpconf  install_vsftpd.yaml
PLAY [k3s-cluster] *******************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************
ok: [ubuntu20-bj03]

TASK [copy vsftpd.conf] **************************************************************************************************************************************************************
changed: [ubuntu20-bj03]

RUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************
changed: [ubuntu20-bj03]

PLAY RECAP ***************************************************************************************************************************************************************************
ubuntu20-bj03              : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<h2 id="10-ansible-vault"><strong>10 ansible-vault</strong></h2>
<ul>
<li>playbook 文件加密工具。</li>
<li><code>ansible-vault encrypt hello.yaml</code></li>
<li><code>encrypt: AES256</code> 加密 ( 会提示输入密码 )。</li>
<li><code>view</code>: 加密的情况下 查看 原来的内容。</li>
<li><code>edit</code>: 编辑加密的 playbook 文件。</li>
<li><code>decrypt</code>: 解密。</li>
<li><code>rekey</code>: 修改加密密码。</li>
</ul>
<h2 id="11-ansible-console"><strong>11 <code>ansible-console</code></strong></h2>
<p><code>ansible-console</code>: 可交互执行命令, 支持 Tab 键。</p>
<pre><code># ansible-consoleWelcome to the ansible console.Type help or ? to list commands.deniss.wang@all (10)[f:5]$
</code></pre>
<p><code>root@all (10) [f:5]$</code></p>
<ul>
<li><code>root</code>当前执行用户。</li>
<li><code>all</code> 表示当前主机列表。</li>
<li><code>(10)</code> 表示当前主机清单下包含 10 台主机。</li>
<li><code>[f:5]</code>: 表示并发执行任务数为 5 个。。</li>
</ul>
<h2 id="12-ansible-roles"><strong>12 ansible Roles</strong></h2>
<ul>
<li>Roles 角色是 Ansible v1.2 版本新加入特性，用于层次性、结构化的组织 playbook。</li>
<li>Roles 能够根据层次结构自动加载- 变量文件、tasks、handler、template 文件等. 简单来讲就是将 这些文件归类到各自单独的文件目录中, 使 playbook 文件可以更好的通过 include 这些文件目录。</li>
<li>Roles 一般用于基于 主机构建服务 的场景中, 但也可以用于构建 守护进程 等场景。</li>
<li>Roles 默认的目录为 <code>/etc/ansible/roles</code> 。</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap4_12_1.png" title="Body image" /></p>
<p>目录结构说明</p>
<ul>
<li>playbook.yml - 剧本文件</li>
<li>app 具体的角色项目名称, 比如 Nginx、PHP、Apache</li>
<li>files 用于存放由copy 或script 模块调用的文件</li>
<li><code>templates</code> 用于存放 Jinja2 模板, template 模块会自动在此目录中寻找 Jinja2 模板文件</li>
<li><code>tasks</code>  main.yml文件为入口, 用于定义此角色的任务列表, 此文件可以使用include包含其它的位于此目录的 task 文件</li>
<li><code>handlers</code>main.yml文件为入口, 用于定义此角色中触发条件时执行的动作</li>
<li><code>vars</code> main.yml文件为入口，用于定义此角色用到的变量</li>
<li><code>defaults</code> main.yml文件为入口， 用于为当前角色设定默认变量</li>
<li><code>meta</code> main.yml文件为入口，用于定义此角色的特殊设定及其依赖关系</li>
<li>
<p><code>roles:</code> 所有的角色必须放在roles目录下, 这个目录可以自定义位置，默认的位置在 <code>/etc/ansible/roles</code></p>
</li>
<li>
<p><strong>nginx roles</strong></p>
</li>
</ul>
<pre><code># tree .

|-- nginx
    |-- defaults
    |-- files
    |-- handlers
    |-- meta
    |-- tasks
    |-- templates
    |-- vars
</code></pre>
<ul>
<li>创建对应的文件</li>
</ul>
<pre><code>
# tree  roles/
roles/
|-- nginx
    |-- defaults
    |-- files
    |-- handlers
    |-- meta
    |-- tasks
    |   |-- group.yaml
    |   |-- main.yaml
    |   |-- restart.yaml
    |   |-- start.yaml
    |   |-- template.yaml
    |   |-- user.yaml
    |   |-- yum.yaml
    |-- templates
    |   |-- nginx.conf.j2
    |-- vars
</code></pre>
<p><strong><code>/etc/ansible/nginx_roles.yml</code> 与 roles存放位置在同一目录。</strong></p>
<pre><code>---
- hosts: k3s-cluster
  become: yes
  become_user: root

  # 选择 调用的 roles 属性
  roles:
      # 调用定义好的role，存放在roles目录中。
    - role: nginx
</code></pre>
<p><code>/etc/ansible/roles/nginx/tasks/main.yml</code> 入口文件 配置 task 执行顺序。</p>
<ul>
<li><code>- include: roles/httpd/tasks/copyfile.yml</code></li>
<li>跨 roles 调用 tasks，需要写 roles 目录级的全路径。 </li>
</ul>
<p>如:</p>
<pre><code>- include: group.yml
- include: user.yml
- include: yum.yml
- include: template.yml
- include: start.yml
</code></pre>
<p><code>/etc/ansible/roles/nginx/tasks/group.yml</code> 单独的 tasks 文件只写单独的内容 如下:</p>
<p><code>- name: create group
  group: name=nginx gid=80</code></p>
<p><strong>执行 <code>nginx_roles.yml</code> 文件</strong></p>
<pre><code># ansible-playbook nginx_roles.yml

PLAY [k3s-cluster] ****************************************************************************************

TASK [Gathering Facts] ****************************************************************************
ok: [10.0.8.2]

TASK [nginx : create group] ***********************************************************************
changed: [10.0.8.2]

TASK [nginx : create user] ************************************************************************
changed: [10.0.8.2]

TASK [nginx : install package] ********************************************************************
changed: [10.0.8.2]

TASK [nginx : copy conf] **************************************************************************
changed: [10.0.8.2]

TASK [nginx : start service] **********************************************************************
changed: [10.0.8.2]

PLAY RECAP ****************************************************************************************
10.0.8.2   : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<h3 id="roles-tags"><strong>roles tags 标签</strong></h3>
<p>在 playbook 文件中 对 roles 配置相应的 tags 。</p>
<pre><code>- hosts: k3s-cluster
  become: yes
  become_user: root


  # 选择 roles 属性
  roles:
    # 配置相应的 tags 用 { } 引用
    - { role: nginx, tags: ['web', 'nginx'] }
    - { role: mysql, tags: ['db', 'mysql'] }
    - { role: redis, tags: ['db', 'redis'] }
    - { role: golang, tags: ['web', 'golang'] }
    - { role: vue, tags: ['web', 'vue'] }   
    - { role: app_demo, tags: &quot;app_demo&quot; }
</code></pre>
<p>跟上面的用法一样，通过 <code>ansible-playbook -t</code> 参数指定 tags 进行单独调用</p>
<p>如下指定 tags 为 web 的 role 执行，其中会依次执行nginx 、golang、vue的roles。</p>
<pre><code># ansible-playbook -t web playbook.yml
</code></pre>
<h3 id="roles-when"><strong>roles when 语句</strong></h3>
<p>对 role 进行条件的判断.</p>
<p><strong><code>ansible_distribution_major_version == "7"</code></strong></p>
<pre><code>---
- hosts: all
  become: yes
  become_user: root

  # 选择 roles 属性
  roles:
    # 配置相应的 tags 用 { } 引用
    - { role: nginx, tags: ['web', 'nginx'] }
    - { role: mysql, tags: ['db', 'mysql'] }
    - { role: redis, tags: ['db', 'redis'] }
    # 只针对操作系统为 Centos7 的执行
    - { role: golang, tags: ['web', 'golang'], when: ansible_distribution_major_version == &quot;7&quot; }
    # 只针对操作系统为 Ubuntu20 的执行
    - { role: vue, tags: ['web', 'vue'], when: (ansible_distribution == &quot;Ubuntu&quot; and ansible_distribution_major_version == &quot;20&quot;)}
    - { role: app, tags: &quot;app&quot; }
</code></pre>
<h3 id="extra-vars"><strong><code>extra-vars</code></strong></h3>
<ul>
<li><code>--extra-vars</code> 执行 playboook 的时候以参数方式传入变量。</li>
</ul>
<pre><code>
# 以变量方式传参
ansible-playbook deploy.yaml --extra-vars &quot;hosts=k3s-cluster user=ubuntu&quot; 
# 以json格式传参
ansible-playbook deploy.yaml --extra-vars &quot;{'app_name':'nginx', 'pkg_name':'vsftpd'}&quot;
# 以json文件方式传参
ansible-playbook deploy.yml --extra-vars &quot;@test_vars.json&quot;
</code></pre>
<h3 id="2demo"><strong>附上2个Demo</strong></h3>
<p>Ubuntu 安装软件，传入参数即可安装软件。</p>
<pre><code>---
# 定义集群，并设置提权root，
- hosts: all
  become: yes
  become_user: root

  vars:
    # 传入参数
    - DEPLOY_USER: ubuntu
    - APP_NAME: '{{ app_name }}'

  tasks:
    - name: 更新 apt-get 仓库以及缓存
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
    - name: 安装 {{ APP_NAME }} 程序
      apt:
        name: &quot;{{ APP_NAME }}&quot;
    # - name: &quot;复制 {{ APP_NAME }} 配置文件&quot;
    #   copy: src=./conf/vsftpd.conf dest=/etc/{{ APP_NAME }}.conf backup=yes
    #   notify: restart {{ APP_NAME }} # 此处必须与handlers一致
    #   # 定义标签
    #   tags: copyconf
    - name: &quot;启动 {{ APP_NAME }} 服务&quot;
      service: name={{ APP_NAME }} state=started enabled=yes
      # 定义标签
      tags: startvsftpd

  # 配置 notify 触发，修改配置文件的时候生效。
  handlers:
    - name: restart {{ APP_NAME }}
      service: name={{ APP_NAME }} state=restarted
</code></pre>
<p>发布流程，Demo中的具体实现逻辑</p>
<pre><code>---
- hosts: all
  gather_facts: no

  vars:
    # OSS参数
    - OSS_URL: 'https://repo.opendevops.cn'
    - OSS_PATH: 'codo/codo-api/cclib/production'
    - OSS_FILE: 'xxxxx_20211020181130_dispatch-service-0.0.7.jar'
    - OSS_FILE_KEY: '?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
    # 部署参数
    - DEPLOY_USER: '{{ deploy_user }}' # &quot;ubuntu&quot;
    - APP_NAME: '{{ app_name }}' # &quot;tomcat&quot;
    - APP_DIR:  '{{ app_dir }}' # &quot;/tmp&quot;
    - DING_URL: '{{ ding_url }}'
    - DING_TOKEN: '{{ ding_token }}'

  tasks:

    - name: &quot;验证 {{ inventory_hostname }} SSH 端口&quot;
      local_action: wait_for port=22 host=&quot;{{ inventory_hostname }}&quot; search_regex=OpenSSH
    - name: gather facts
      setup:    

    - name: &quot;钉钉 {{ ding_url }} {{ ding_token }}&quot;
      shell: &quot;echo {{ ding_url }}&quot;   
      register: print_ding_url

    - name: &quot;获取当前发布主机IP&quot;
      shell: &quot;curl http://ip.me&quot;   
      register: get_ip_addr
    - name: &quot;获取当前发布主机IP SDTOUT&quot;  
      debug: var=get_ip_addr.stdout

    - name: &quot;获取当前发布主机名称&quot;
      shell: &quot;hostname&quot;
      register: get_hostname
    - name: &quot;获取当前发布主机名称 SDTOUT&quot;
      debug: var=get_hostname

    # 发布的一些动作
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 目录&quot;
      file:
        path: &quot;{{ APP_DIR }}/{{ APP_NAME }}&quot;
        state: directory
        mode: '0755'   
      register: create_dir
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 目录 STDOUT&quot;
      debug: var=create_dir

    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 程序包下载&quot;            
      shell: &quot;wget {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }}'{{ OSS_FILE_KEY }}' -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}&quot;
      args:
        chdir: /opt/
        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}
      register: download_file
      #notify: restart {{ APP_NAME }}
    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 程序包下载 CMD&quot;
      debug: var=download_file.cmd

    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 改名&quot;
      shell: &quot;new_file_name=`ls {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }} |awk -F'_' '{print $3}'` &amp;&amp; echo ${new_file_name} &amp;&amp; mv {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }} {{ APP_DIR }}/{{ APP_NAME }}/${new_file_name}&quot;
      args:
        chdir: /opt/
        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}
      register: move_file
    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 改名 STDOUT&quot;
      debug: var=move_file.stdout

   - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 权限修改&quot;
      file:
        path: &quot;{{ APP_DIR }}/{{ APP_NAME }}&quot;
        state: directory
        owner: &quot;{{ DEPLOY_USER }}&quot;
        group: &quot;{{ DEPLOY_USER }}&quot;
        recurse: yes
      register: changed_permissions
    - name: &quot;APP {{ APP_NAME }} 权限修改 STDOUT&quot;
      debug: var=changed_permissions

    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 服务重启&quot;      
      shell: &quot;echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}&quot;
      register: restart_service
      notify: restart {{ APP_NAME }}
    - name: &quot;发布主机: {{ get_hostname.stdout }} APP {{ APP_NAME }} 服务重启 SDTOUT&quot;
      debug: var=restart_service.cmd

    # 发布完成后的验证
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 进程状态&quot;      
      shell: &quot;echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}&quot;
      args:
        chdir: /opt/
        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}
      register: process_status
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 进程状态 STDOUT&quot;
      debug: var=process_status.stdout      

    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 服务状态&quot;      
      shell: &quot;echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}&quot;
      args:
        chdir: /opt/
        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}
      register: service_status
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 服务状态 STDOUT&quot;
       debug: var=service_status.stdout  

    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 接口状态&quot;      
      shell: &quot;curl -s -L %{http_code} {{ OSS_URL }}  | grep \&quot;Welcome!\&quot; |awk '{print $1}'&quot;
      args:
        chdir: /opt/
        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}
      register: interface_status
    - name: &quot;发布主机: {{ get_hostname.stdout }} 验证 {{ APP_NAME }} 接口状态 STDOUT&quot;
      debug: var=interface_status.stdout

  # 重启服务
  handlers:
    - name: restart {{ APP_NAME }}
      service: name={{ APP_NAME }} state=restarted   
</code></pre>
<p>执行参数</p>
<pre><code># 变量
ansible-playbook -C deploy.yaml -e &quot;ding_url=ding.opendevops.cn app_name=tomcat app_dir=/tmp/deniss deploy_user=ubuntu, ding_token=qwerty&amp;^%FDSFBSNFXZ&amp;^%%&quot;
# json
ansible-playbook -C deploy.yaml --extra-vars &quot;{'app_name':'tomcat', 'deploy_user':'ubuntu', 'app_dir':'/tmp/deniss', 'ding_url':'ding.opendevops.cn', 'ding_token':'qwerty&amp;^%FDSFBSNFXZ&amp;^%%'}&quot;
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
    
  </body>
</html>
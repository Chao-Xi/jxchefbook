
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Chef&Ansible Automation 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../chef_tutorial10_zero/">
      
      
        <link rel="next" href="../chef_tutorial12/">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.5">
    
    
      
        <title>第十一节 数概包Databag - Jacob Chef&Ansible Automation Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#databag" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Chef&amp;Ansible Automation Book" class="md-header__button md-logo" aria-label="Jacob Chef&Ansible Automation Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Chef&Ansible Automation Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第十一节 数概包Databag
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxchefbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxchefbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Chef&amp;Ansible Automation Book" class="md-nav__button md-logo" aria-label="Jacob Chef&Ansible Automation Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Chef&Ansible Automation Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxchefbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxchefbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learning Chef
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Learning Chef
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Chef 介绍和安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Ruby和Chef语法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 如何写 Chef 配方 & chef-apply
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 用Test Kitchen管理沙盒测试环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 用 Chef 户端管理节点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 撰写和使用菜谱
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial7_attributes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 Chef 属性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Chef 服务器同时管理多个节点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 社区以及Chef-Client菜谱
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial10_zero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Chef zero
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第十一节 数概包Databag
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第十一节 数概包Databag
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chef" class="md-nav__link">
    数据包是唯一的Chef内建的用来存储和访问节点间通用的数据的机制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1knife" class="md-nav__link">
    1、使用Knife在命令行进行数据包的基本操作
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、在配方单中使用数据包项目的数据创建本地用户
  </a>
  
    <nav class="md-nav" aria-label="2、在配方单中使用数据包项目的数据创建本地用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    验证用户
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、加密数据包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4chef-valut" class="md-nav__link">
    4、Chef-valut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、本节小结
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 角色
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial13_env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial14_test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 测试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial15_term/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十五节 词汇表
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../chef_tutorial16_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十六节 Chef Tutorial Interview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Chef Opt & Adv
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Chef Opt & Adv
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Chef Roles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Cookbook Versioning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 How to Perform Chef Knife SSL Check and Fetch to Verify Certificate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 12 Chef Knife Cookbook Command Examples
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_op1_kinfe_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 knife search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/chef_adv3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Chef Quick CheatSheet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Chef Cookbook Sample LAMP
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Chef Cookbook Sample LAMP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/chef_basic5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Creating My First Chef Cookbook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/chef_basic6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Creating LAMP Chef Cookbook Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learning Ansible
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Learning Ansible
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1ansible_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L1 Ansible Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2ansible_over_install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L2 Ansible Install(MacOs) and Environment Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3play_task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L3 Task Execution management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4Ansible_variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L4 Ansible Variable Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/5Complex_roles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L5 Managing complex playbooks with roles and ansible galaxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/6Secret_management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L6 Working with Secrets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/7Network_management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L7 Network Management with Ansible
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/8idempotentence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L8 Idempotentence with Ansible play
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/9Ansible_interview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L9 Ansible Interview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/10Ansible_learn_ppt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L10 Ansible 自动化运维工具PPT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/11Ansible_task1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L11 任务中心之Ansible基础篇
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/12Ansible_task2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L12 任务中心之Ansible进阶篇
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/13Ansible_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L13 Ansible 面试知识点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/14Ansible_containerd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L14 Ansible Role批量部署Containerd服务
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    HashiCorp Certified Terraform Associate
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            HashiCorp Certified Terraform Associate
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1hashicorp_certified_terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HashiCorp Certified Terraform Associate Learning Path
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2terraform_cs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Cheat Sheet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3terraform_lock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    .terraform.lock.hcl 简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4terraform_var/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    terraform.tfvars 与 variables.tf 的区别
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5terraform_random/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform: Random 简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/6terraform_int/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Top Terraform Interview Questions and Answers (2022)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/7terraform_provider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform provider update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/8terraform_docker_jenkins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform install Jenkins in Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/9terraform_local/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    解决Terraform初始化慢~配置本地离线源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/10terraform_adv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform(Troubleshooting/Data Sources/Existing Resource)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/11tf_adv_exam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Exam(Backend/Command/Script/Others)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/12terraform_jenkins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12 Adding Terraform to a CI/CD Pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/13terraform_cmt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Integrating with Configuration Managers(Anisble)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Puppet Learning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Puppet Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/1pp_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Puppet - Overview & Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/2pp_install_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Puppet - 安装, 配置以及验证
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/3pp_coding_style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Puppet - 编码风格
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/4pp_key_comps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Puppet - 核心模块
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/5pp_resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 Puppet - 资源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/6pp_tmp_cls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Puppet - 模板 & 类
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/7pp_func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Puppet - Function
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/8pp_env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Puppet - 环境
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/9app_type_pr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 Puppet - 类型和提供者
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/10pp_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10 Puppet - RESTful API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6_pp/11pp_proj1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11 Puppet - Live Project 1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ArgoCD Learning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            ArgoCD Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7_argocd/1Intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Introduction to Continuous Delivery
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chef" class="md-nav__link">
    数据包是唯一的Chef内建的用来存储和访问节点间通用的数据的机制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1knife" class="md-nav__link">
    1、使用Knife在命令行进行数据包的基本操作
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、在配方单中使用数据包项目的数据创建本地用户
  </a>
  
    <nav class="md-nav" aria-label="2、在配方单中使用数据包项目的数据创建本地用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    验证用户
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、加密数据包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4chef-valut" class="md-nav__link">
    4、Chef-valut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、本节小结
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="databag"><strong>第十一节  数概包Databag</strong></h1>
<ul>
<li>使用Knife在命令行进行数据包的基本操作</li>
<li>在配方单中使用数据包项目的数据创建本地用户</li>
<li>加密数据包 </li>
<li>Chef-valut</li>
</ul>
<p><strong><code>Chef</code>服务器支持存储全局的、可以在不同点上节点上使用的数据存储。这个功能称作数据包（<code>data bag</code>)</strong>。 </p>
<p><strong>在<code>Chef</code>的概念中，数据包是包含代表你的基础架构而并不针对某一个节点的信息的容器。数据包包含需要在多个节点共享的信息</strong></p>
<ul>
<li>通用的密码 </li>
<li>软件安装的许可证钥匙 </li>
<li>通用的用户或组的列表</li>
</ul>
<p><strong>除了数据包外,<code>Chef</code>节点之间无法共享数据</strong>。</p>
<p><img alt="Alt Image Text" src="../../images/11_1.png" title="body image" /> </p>
<p><strong>虽然<code>chef-client</code>会在成功运行后发送节点的属性信息到<code>Chef</code>服务器，但是如图所示，某一节点无法直接访问其他节点的信息</strong>。 </p>
<p><img alt="Alt Image Text" src="../../images/11_2.png" title="body image" /> </p>
<h3 id="chef"><strong>数据包是唯一的Chef内建的用来存储和访问节点间通用的数据的机制</strong></h3>
<p><img alt="Alt Image Text" src="../../images/11_3.png" title="body image" /> </p>
<p>展示了数据包的样子。</p>
<ul>
<li>每个数据包包含一个或多个项目。</li>
<li>每个项目都是一个以<code>JSON</code>格式表示的键值对儿集合。</li>
<li>根据约定，一个数据包中的每个项目应该共享一样的键；然而不同数据包中的项目的键可以完全不一样。</li>
</ul>
<p>当然这只是约定，技术上，可以在任何数据包项目中存储任何的键和值。根据<code>JSON</code>格式，字符串需要被双引号引用，而整数值则不需要。值也可以为字符串或整数的列表。</p>
<p><img alt="Alt Image Text" src="../../images/11_4.png" title="body image" /> </p>
<h2 id="1knife"><strong>1、使用Knife在命令行进行数据包的基本操作</strong></h2>
<p>让我们以用<code>knife</code>命令在命令行执行一个搜索查询开始, 假设想确保我们的员工<code>alice</code>和<code>bob</code>在所有节点上都有他们的用户账户， 则可以用数据包来存错这些这样一来， 解决方案 
蔽以将新员工添加到这个列表中井自剩触们的账户。 数据包是最好的因为我们想让用户列表在所有节点上都可以访问。</p>
<p>Use the same dual command prompt setup you used there. Start the chef-zero server on an open port in one window. We will be using port <code>9501</code> in the examples in this chapter:</p>
<pre><code>$ cd chap10/chef-playground
$ chef-zero --port 9501
</code></pre>
<pre><code>$ cd chef-playground
</code></pre>
<p>在<code>chef-playground</code>目录中创建<code>data-bags</code>子目录。同时，创建一个新的数据包井命名为 <code>users</code>。可以通过在<code>data_bags</code>目录下创建一个新的<code>users</code>目录来完成。 </p>
<pre><code>$ mkdir -p data_bags/users
</code></pre>
<p><strong><code>chef-playground/data_bags/users/alice.json</code></strong></p>
<pre><code>{
  &quot;id&quot;: &quot;alice&quot;,
  &quot;comment&quot;: &quot;Alice Jones&quot;,
  &quot;uid&quot;: 2000,
  &quot;gid&quot;: 0,
  &quot;home&quot;: &quot;/home/alice&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;
}
</code></pre>
<p><strong><code>chef-playground/data_bags/users/bob.json</code></strong></p>
<pre><code>{
  &quot;id&quot;: &quot;bob&quot;,
  &quot;comment&quot;: &quot;Bob Smith&quot;,
  &quot;uid&quot;: 2001,
  &quot;gid&quot;: 0,
  &quot;home&quot;: &quot;/home/bob&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;
}
</code></pre>
<p>在<code>Chef</code>服务器上创建名为<code>users</code>的数据包，运行<code>knife data create</code>命令 </p>
<pre><code>$ knife data_bag create users
Created data_bag[users]
</code></pre>
<p>创建数据包项目，运行<code>knife data_bag from file</code>命令。</p>
<p><code>knife data_bag from file</code>命令假设表示数据包项目的<code>.json</code>文件在<code>data_bag</code>，目录下的以数据包名字命名的子目录中： </p>
<pre><code>$ knife data_bag from file users alice.json
Updated data_bag_item[users::alice]

$ knife data_bag from file users bob.json
Updated data_bag_item[users::bob]
</code></pre>
<p>要搜索服务器上的数据包，以数据包名字作为<code>index</code>参数使用<code>knife search</code>。在本例中， 我们的数据包名为<code>users</code>。以下命令将搜索我们在<code>users</code>数据包中创建的所有数据包项目： </p>
<pre><code>$ knife search users &quot;*:*&quot;
2 items found

chef_type: data_bag_item
comment:   Alice Jones
data_bag:  users
gid:       0
home:      /home/alice
id:        alice
shell:     /bin/bash
uid:       2000

chef_type: data_bag_item
comment:   Bob Smith
data_bag:  users
gid:       0
home:      /home/bob
id:        bob
shell:     /bin/bash
uid:       2001
</code></pre>
<p><strong>可以在搜索查询中指定特定的键值对儿</strong>。以下查询将返回<code>users</code>数据包中拥有<code>Id == alice</code> 数据的数据包项目： </p>
<pre><code>≈
1 items found

chef_type: data_bag_item
comment:   Alice Jones
data_bag:  users
gid:       0
home:      /home/alice
id:        alice
shell:     /bin/bash
uid:       2000
</code></pre>
<p><strong>查询的内容是数据包项目中的内容而不是节点的属性</strong>。</p>
<p>比如，以下查询将返回在<code>users</code>数据 包中<code>id</code>的值是<code>alice</code>或<code>bob的</code>数据包项目： </p>
<pre><code>$ knife search users &quot;id:alice OR id:bob&quot; 
2 items found

chef_type: data_bag_item
comment:   Alice Jones
data_bag:  users
gid:       0
home:      /home/alice
id:        alice
shell:     /bin/bash
uid:       2000

chef_type: data_bag_item
comment:   Bob Smith
data_bag:  users
gid:       0
home:      /home/bob
id:        bob
shell:     /bin/bash
uid:       2001
</code></pre>
<p>搜索结果可以由<code>-a</code>参数过滤。比如<code>-a shell</code>只返回结果中<code>shell</code>的值：  </p>
<pre><code>$ knife search users &quot;*:*&quot; -a shell
2 items found

:
  shell: /bin/bash

:
  shell: /bin/bash
</code></pre>
<h2 id="2"><strong>2、在配方单中使用数据包项目的数据创建本地用户</strong></h2>
<p>到现在为止，我们创建几个数据包项目, 并用我们来表示用户账户，但我们尚末实际在配方单中使用数据包项目的数据创建本地用户来创建这些用户账户。 让我们用<code>chef</code>菜谱根据这些数据来创建这些账户</p>
<pre><code>$ cd /chef-playground/cookbooks

</code></pre>
<p>然后在<code>chef_playground/cookbooks</code>目录下生成一个<code>users</code>菜谱。</p>
<p><strong>Chef Development Kit:</strong></p>
<pre><code>$ chef generate cookbook users
$ cd users
</code></pre>
<p><strong>Chef Client:</strong></p>
<pre><code>$ knife cookbook create users --cookbook-path .
$ cd users
$ kitchen init --create-gemfile
$ bundle install
</code></pre>
<pre><code>$ chef generate cookbook users
Generating cookbook users
- Ensuring correct cookbook content
- Committing cookbook files to git

Your cookbook is ready. Type `cd users` to enter it.

There are several commands you can run to get started locally developing and testing your cookbook.
Type `delivery local --help` to see a full list of local testing commands.

Why not start by writing an InSpec test? Tests for the default recipe are stored at:

test/integration/default/default_test.rb

If you'd prefer to dive right in, the default recipe can be found at:

recipes/default.rb
</code></pre>
<p>注意我们在<code>provisioner:</code>中添加<code>data_bags_path</code>来指定数据包的位置。 </p>
<pre><code>provisioner:
  name: chef_zero
  data_bags_path: ../../data_bags
</code></pre>
<p><code>data_bags_path</code>是一个指向<code>chef_playground/databags</code>目录（在上一节我们在这个目录中创建了数据包夹和项目文件）的相对路径。这和我们在过的关于<code>node</code>测试数据的例子类似 </p>
<p><strong><code>data_bags_path:</code>指向的目录中的所有文件将作为数据包上传到<code>chef-zero</code>服务器。在生 产环境中数据包的数据通常不会包含在菜谱文件结构中。</strong></p>
<p>我们将测试数据存储在<code>chef_playground/databags</code>而不是在<code>users</code>菜谱的<code>cookbooks/users</code>文件结构中 </p>
<p><strong><code>/users/kitchen.yml</code></strong></p>
<pre><code>---
driver:
  name: vagrant
  provider: vmware_desktop

provisioner:
  name: chef_zero
  data_bags_path: ../../data_bags
  always_update_cookbooks: true

platforms:
  - name: centos65
    driver:
      box: learningchef/centos65
      box_url: learningchef/centos65

suites:
  - name: default
    run_list:
      - recipe[users::default]
    attributes:
</code></pre>
<p>让我们写一个配方单来查询<code>user</code>数据包中定义的用户数据并为每个数据包项目创建一个相应的本地用户。</p>
<p>你可以使用<code>search(）</code>方法来执行数据包查询就像在搜索节点一样。然后，可以使用<code>Chef</code>的<code>use</code>资源基干数据包中定义的数据创建用户。 </p>
<p><strong><code>cookbooks/users/recipes/default.rb</code></strong></p>
<pre><code>#
# Cookbook:: users
# Recipe:: default
#
# Copyright:: 2019, The Authors, All Rights Reserved.
search(&quot;users&quot;, &quot;*:*&quot;).each do |user_data|
    user user_data[&quot;id&quot;] do
      comment user_data[&quot;comment&quot;]
      uid user_data[&quot;uid&quot;]
      gid user_data[&quot;gid&quot;]
      home user_data[&quot;home&quot;]
      shell user_data[&quot;shell&quot;]
    end
end
</code></pre>
<p><strong>我们使用<code>each do</code>结构。在这里，遍历数据包的每个项目并将每个项目的内容存在<code>user_data</code>变量中。<code>user_data</code>是一个字典（哈希）包含数据包项目的键值对儿</strong> </p>
<p><strong><code>search(）</code>代码块中的<code>user</code>语句是一个<code>Chef</code>资源。<code>user</code>资源在节点上创建本地用户。它接受以下属性:</strong> </p>
<ul>
<li><code>comment</code> 关于要创建的用户的信白 </li>
<li><code>uid</code> 以数字表示的用户ID </li>
<li><code>gid</code> 以数字表示的用户的组的ID </li>
<li><code>home</code> 用户跟目录的位置 </li>
<li><code>shell</code> 用户登录的壳 </li>
</ul>
<p>在我们的配方单中的代码读取<code>user_data</code>哈希并将其传递进<code>Chef</code>的<code>user</code>资源</p>
<p><strong>现在运行<code>kitchen converge</code>如果一切正确，<code>Test Kitchen</code>应该上传菜谱代码到沙盒环境 并在<code>cehf-zero</code>实例中创建数据包</strong>。</p>
<p>然后在沙盒节点上运行菜谱代码并查询我们的数据包项目以及通过使用<code>user</code>资源创建相应的用户 </p>
<pre><code>$ kitchen converge
-----&gt; Starting Kitchen (v2.3.3)
-----&gt; Creating &lt;default-centos65&gt;...
       ==&gt; vagrant: A new version of Vagrant is available: 2.2.6 (installed version: 2.2.5)!
       ==&gt; vagrant: To upgrade visit: https://www.vagrantup.com/downloads.html

       Bringing machine 'default' up with 'vmware_desktop' provider...
       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...
       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...
       ==&gt; default: Verifying vmnet devices are healthy...
       ==&gt; default: Preparing network adapters...
       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant
       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may
       WARNING: prevent proper networking setup. Below is the detected VMX setting:
       WARNING: 
       WARNING:   ethernet0.pcislotnumber = &quot;33&quot;
       WARNING: 
       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually
       WARNING: applied via the Vagrantfile:
       WARNING: 
       WARNING:   Vagrant.configure(2) do |config|
       WARNING:     config.vm.provider :vmware_desktop do |vmware|
       WARNING:       vmware.vmx[&quot;ethernet0.pcislotnumber&quot;] = &quot;33&quot;
       WARNING:     end
       WARNING:   end
       WARNING: 
       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting
       ==&gt; default: Fixed port collision for 22 =&gt; 2222. Now on port 2201.
       ==&gt; default: Starting the VMware VM...
       ==&gt; default: Waiting for the VM to receive an address...
       ==&gt; default: Forwarding ports...
           default: -- 22 =&gt; 2201
       ==&gt; default: Waiting for machine to boot. This may take a few minutes...
           default: SSH address: 127.0.0.1:2201
           default: SSH username: vagrant
           default: SSH auth method: private key
           default: 
           default: Vagrant insecure key detected. Vagrant will automatically replace
           default: this with a newly generated keypair for better security.
           default: 
           default: Inserting generated public key within guest...
           default: Removing insecure key from the guest if it's present...
           default: Key inserted! Disconnecting and reconnecting using new SSH key...
       ==&gt; default: Machine booted and ready!
       ==&gt; default: Setting hostname...
       ==&gt; default: Configuring network adapters within the VM...
       ==&gt; default: Machine not provisioned because `--no-provision` is specified.
       [SSH] Established
       Vagrant instance &lt;default-centos65&gt; created.
       Finished creating &lt;default-centos65&gt; (0m41.51s).
-----&gt; Converging &lt;default-centos65&gt;...
       Preparing files for transfer
$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.
$$$$$$ Ignored run_list: [&quot;recipe[users::default]&quot;]
       Policy lock file doesn't exist, running `chef install` for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.rb...
       Building policy users
       Expanded run list: recipe[users::default]
       Caching Cookbooks...
       Installing users &gt;= 0.0.0 from path

       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.lock.json
       Policy revision id: 263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc
       Updating policy lock using `chef update`
       Attributes already up to date
       Building policy users
       Expanded run list: recipe[users::default]
       Caching Cookbooks...
       Installing users &gt;= 0.0.0 from path

       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.lock.json
       Policy revision id: 263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc
       Preparing dna.json
       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1...
       Exported policy 'users' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1

       To converge this system with the exported policy, run:
         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1
         chef-client -z
       Removing non-cookbook files before transfer
       Preparing data_bags
       Preparing validation.pem
       Preparing client.rb
-----&gt; Installing Chef install only if missing package
       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh
       Trying wget...
       Trying curl...
       Download complete.
       el 6 x86_64
       Getting information for chef stable  for el...
       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64
         to file /tmp/install.sh.3170/metadata.txt
       trying wget...
       trying curl...
       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2
       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473
       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm
       version  15.5.17
       downloaded metadata file looks valid...
       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm
         to file /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm
       trying wget...
       trying curl...
       Comparing checksum with sha256sum...

       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING

       You are installing a package without a version pin.  If you are installing
       on production servers via an automated process this is DANGEROUS and you will
       be upgraded without warning on new releases, even to new major releases.
       Letting the version float is only appropriate in desktop, test, development or
       CI/CD environments.

       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING

       Installing chef 
       installing with rpm...
       warning: /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY
       Preparing...                ########################################### [100%]
          1:chef                   ########################################### [100%]
       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io
       Transferring files to &lt;default-centos65&gt;
       +---------------------------------------------+
       ✔ 2 product licenses accepted.
       +---------------------------------------------+
       Starting Chef Infra Client, version 15.5.17
       Creating a new client identity for default-centos65 using the validator key.
       Using policy 'users' at revision '263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc'
       resolving cookbooks for run list: [&quot;users::default@0.1.0 (6ad8a6c)&quot;]
       Synchronizing Cookbooks:
         - users (0.1.0)
       Installing Cookbook Gems:
       Compiling Cookbooks...
       Converging 2 resources
       Recipe: users::default
         * linux_user[alice] action create
           - create user alice
         * linux_user[bob] action create
           - create user bob

       Running handlers:
       Running handlers complete
       Chef Infra Client finished, 2/2 resources updated in 01 seconds
       Downloading files from &lt;default-centos65&gt;
       Finished converging &lt;default-centos65&gt; (1m43.52s).
-----&gt; Kitchen is finished. (2m25.60s)
</code></pre>
<h3 id="_1">验证用户</h3>
<p>让我们来验证<code>Chef</code>在沙盒环境中创建了相应的用户。登录到沙盒环境，然后运行<code>getent</code> <code>password</code>来验证我们的用户存在。完成后退回到宿主机器： </p>
<pre><code>$ kitchen login 
Last login: Fri Dec  6 03:25:26 2019 from 172.16.72.2
Welcome to your Packer-built virtual machine.
[vagrant@default-centos65 ~]$  getent passwd alice
alice:x:2000:0:Alice Jones:/home/alice:/bin/bash
[vagrant@default-centos65 ~]$ getent passwd bob
bob:x:2001:0:Bob Smith:/home/bob:/bin/bash
</code></pre>
<p>可以在<code>users</code>数据包中再添加一个新用户的信息。让我们来添加一个名为<code>eve</code>的用户。回到<code>chef-playground</code>目录并创建·chef-playground/data_bags/users/eve.json·文件，</p>
<pre><code>{
  &quot;id&quot;: &quot;eve&quot;,
  &quot;comment&quot;: &quot;Eavesdrop&quot;,
  &quot;uid&quot;: 2002,
  &quot;gid&quot;: 0,
  &quot;home&quot;: &quot;/home/eve&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;
}
</code></pre>
<pre><code>$ cd chef-playground
$ knife data_bag from file users eve.json
Updated data_bag_item[users::eve]
</code></pre>
<p>Make your <code>users</code> recipe the current working directory.</p>
<pre><code>$ cd cookbooks/users/
</code></pre>
<pre><code>$ kitchen converge
$ kitchen login
Last login: Fri Dec  6 03:33:27 2019 from 172.16.72.2
Welcome to your Packer-built virtual machine.
[vagrant@default-centos65 ~]$ getent passwd eve
eve:x:2002:0:Eavesdrop:/home/eve:/bin/bash
</code></pre>
<p>你会注意到<code>Chef</code>创建了<code>eve</code>账号。你的配方单是数据驱动的基于<code>users</code>数据包中的数据创建相应的用户。</p>
<p>每当数据包中的数据改变时节点将在下次<code>Chef</code>运行时应用这些改变而井不需要对配方单代码做出任何改变 </p>
<h2 id="3"><strong>3、加密数据包</strong></h2>
<p>数据包项目可以被共享密钥加密使其可以在<code>Chef</code>服务器中存储高度安全的信包。比如 可以使用加密数据包存储 </p>
<ul>
<li>SSL证书 </li>
<li>SSH密钥 </li>
<li>密码 </li>
<li>许可证号码 </li>
</ul>
<p>因为节点的属性是以明文存储的―即使每个节点无法访问其他节点的属胜―这不代表这些属性是安全的。加密数据包是存储私密信息很好的选择虽然这些私密信息往往不是针对某一个节点，但即使你只想为某一个节点加密一些信息也依然可以使用 </p>
<p>当使用<code>knife data bag create</code>命令创建一个数据包时，一个包含秘钥的文件被传递进来，数据包的内容被这个密钥加密后存储.当节点试图解密并访问数据包内容，他需要使用一个秘钥</p>
<p><img alt="Alt Image Text" src="../../images/11_5.png" title="body image" /> </p>
<p>让我们来做一个加密数据包的实例。确保<code>chef-playground</code>目录为你的当前工作目录 </p>
<ul>
<li>首先生成一个作为密钥的密码， 以下命令将生成一个512字节的随机密钥井保存至 <strong><code>encrypted_data_bag_secret</code></strong></li>
</ul>
<pre><code>$ openssl rand -base64 512 | tr -d '\r\n' &gt; encrypted_data_bag_secret
</code></pre>
<p>当使用对称秘钥加密时，往往密码应该由机器生成而不是人工指定， 因此我们使用<code>openssl</code>工具生成一个<code>512</code>字节的随机密钥。</p>
<p>为了表示密钥中的进制数州我们告诉<code>openssl</code>用<code>base64</code>编码来将二进制数据表示为ASCII字符串， 此外，由于<code>openssl</code>命令的默认输出包含换行符等在不同平台下不同的字符， 我们使用<code>tr</code>命令来移除秘钥中此类字符， 这样确保了密钥中的字节在不同平台下依然会相通 </p>
<p>作为测试，假设让我们创建一个包含访问信用卡付款系统的<code>API</code>秘钥的<code>.json</code>文件作为数据包项目， 很明显我们希望将这些信急加密。</p>
<p>假设这个数据包项目包含<code>id:</code>以及<code>api_key</code>来存储<code>API</code>密钥</p>
<p>首先创建数据包目录</p>
<pre><code>$ mkdir -p data_bags/api_keys
</code></pre>
<p><strong><code>chef-playground/data_bags/api_keys/payment.json</code></strong></p>
<pre><code>{
  &quot;id&quot;: &quot;payment&quot;,
  &quot;api_key&quot;: &quot;592c879e-f37d-43e6-8b54-8c2d97cf04d4&quot;
}
</code></pre>
<pre><code>$ knife data bag create api_keys
Created data_bag[api_keys]
</code></pre>
<p><strong>当数据包项目需要加密时,使用<code>--secret-file</code>参数来传递密钥</strong> </p>
<pre><code>$ knife data bag from file api_keys payment.json \
--secret-file encrypted_data_bag_secret data_bag_item[api_keys::payment]
</code></pre>
<p>如何知迈我们创建的数据包项目在服务器上是否被加密？让我们通过<code>knife dtata bag</code>命令但并不传递密钥看看 </p>
<pre><code>$ knife data bag show api_keys payment
WARNING: Encrypted data bag detected, but no secret provided for decoding. Displaying encrypted data.
api_key:
  auth_tag:       eWn37afy9KpD7ACCsBipnA==

  cipher:         aes-256-gcm
  encrypted_data: iLnKRDbkTwcC4cs5KJL92Fip2SjRooYovBSskpBvZuUyNrEnEJv4sOGhRFSb
  VVTIGpl+tRDZ/w==

  iv:             +yBoizTgPaUdgh6k

  version:        3
id:      payment
</code></pre>
<p>看起来加密了，不是吗？ </p>
<p>你在输出中看不到api_key内容的原文。只有<code>id：</code>是明文表示。</p>
<p><strong><code>id：</code>不能被加密 ，因为服务器需要使用它来索引以及搜索加密的数据。</strong></p>
<p>如果想解密数据包项目的数据，如下所示，使用<code>--secret-fil</code>e参数，可以看到输出中项目的值是原文： </p>
<pre><code>$ knife data bag show api_keys payment \
&gt; --secret-file encrypted_data_bag_secret
Encrypted data bag detected, decrypting with provided secret.
api_key: 592c879e-f37d-43e6-8b54-8c2d97cf04d4
id:      payment
</code></pre>
<p>有一个问题<code>Chef</code>公司并未对此提供官方的解决方案。</p>
<p>节点如何得到用来解密数据包的密钥？节点需要获得这个密钥才能访问加密数据包的内容，不幸的事，Chef不能将这些密钥存储在被E们加密的同一个系统中，这样违反了计算机安全的核心原则。因此 当你使用加密数据包时，需要解决分发密钥的问题。 </p>
<p>幸运的是我们下一节将讲述一个第三方的解决方案使用比<code>cehf-valut</code>工具来进行密钥的分发。<code>chef-valut</code>已经被包含在<code>Chef</code>开发包中 </p>
<h2 id="4chef-valut"><strong>4、Chef-valut</strong></h2>
<blockquote>
<p>For those using Chef Client, you will need to install an additional gem to use chef-vault. Run the following to install the chef-vault gem:</p>
</blockquote>
<pre><code>$ sudo gem install chef-vault --no-ri --no-rdoc
</code></pre>
<p>在开始试用<code>chef-vault</code>之前，让我们为<code>devhost</code>节点从<code>chef-zero</code>服务器注册一个个正式的客户端密钥。</p>
<p>现在，如果运行<code>knife client list</code>，你会注意到<code>devhost</code>并不在客户端列表中。</p>
<p><strong>我们的 <code>Chef</code>服务器并不知道<code>devhost</code>是一个合法节点，也不知道这个节点拥有允许它在服务器上存储数据的客户端密钥</strong>。</p>
<p>要使用<code>chef-vault</code>来让节点访问加密数据包项目，我们需要让该节点满足这两个条件。 </p>
<pre><code>cd chap10/chef-repo/playground
$ knife client list
ja-validator
node-centos65.vagrantup.com
$ knife node list

</code></pre>
<blockquote>
<p>注意：对于这个试验，节点列表必须为空，因为我们在第11章中创建的假节点并没有相应的客户 
端密钥。如果你看到有任何节点列出，重启<code>chef-zero</code>服务器将它们消除即可。 </p>
</blockquote>
<p>在开发工作站（我们将在<code>chef-playground/.chef/knife.rb</code>中将其称作<code>devhost</code>）上生成一对新的私钥、公钥。因为<code>chef一zero</code>并不检查.</p>
<p><code>chef-playground/.chef/knife.rb</code>文件的内容，所以我们可以重新生成。然而，如果重新生成客户端密钥，就需要在<code>Chef</code>服务器上存有与其相应的公钥。运行以下命令重新生成客户端密钥。 </p>
<pre><code>$  knife client create devhost  --disable-editing --file .chef/devhost.pem
Created client[devhost]
</code></pre>
<p><code>--admin</code>选项允许其创建的客户端针对它相对的节点以外的其他节点使用<code>knife client show</code>和<code>knife node commands</code>背后的<code>API</code>。默认情况下，<code>knife client create</code>将客户端 信息显示在一个编辑器内，允许你在。</p>
<p><code>client.pem</code>密钥生成之前对客户端作出修改。在我们的例子中，默认值就可以满足我们的要求，因此我们传递<code>--disable-editing</code>参数来直接使用默认值。<code>--file</code>参数将客户端密钥。<code>client.pem</code>写出到一个指定的文件。</p>
<pre><code>$ knife client list
chef-validator
chef-webui
devhost
</code></pre>
<p>运行以下命令，创建一个和客户端相符的节点： </p>
<pre><code>$ knife node create devhost --disable-editing
Created node[devhost]
</code></pre>
<p>现在<code>devhost</code>同时显示在节点列表中。做的这个过程模拟了真实环境中当一个新节点（机器）注册时发生的事情―生成客户端密钥、创建节点并与<code>Chef</code>服务器注册。 </p>
<pre><code>$ knife node list
devhost
</code></pre>
<p>现了创建一个新的密数据包，并使用<code>chef-vault</code>.假设我们需要用它来存储<code>root</code>密码。 创建<code>chef-plauground/data_bags/passwords</code>目录来存储数据包项目<code>.json</code>文件</p>
<p><strong>Linux/Mac OS X:</strong></p>
<pre><code>$ mkdir -p data_bags/passwords
</code></pre>
<p><strong><code>chef-playground/data_bags/passwords/mysql_root.json</code></strong></p>
<pre><code>{
   &quot;id&quot;: &quot;mysql_root&quot;,
   &quot;password&quot;: &quot;This is a very secure password&quot;
}
</code></pre>
<p><code>chef-vault</code>会安装一个<code>knife</code>命令的插件来管理加密数据包。</p>
<p><strong>这个插件将<code>chef-valut</code>的命令整合到<code>knife vault</code>命令中。运行以下命令来创建一个加密数据包项目并用<code>chef-vdult</code> 管理密钥</strong>： </p>
<pre><code>$ knife vault create passwords mysql_root --json data_bags/passwords/mysql_root.json --search &quot;*:*&quot;  --mode client
</code></pre>
<p>必须通过<code>--search</code>或<code>--admin</code>参数指定拥有合法客户端密钥的用户或节点．在我们的例子， 因为没有设定<code>admin</code>用户的客户端密钥如果运行<code>knife client list</code>, 是看不到<code>admin</code>用户的。 </p>
<p>使<code>chef</code>服务器时必须，使用<code>node client</code>选项 </p>
<p><code>knife vault</code>命令的用法和<code>chef data_bags</code>不同。</p>
<p><code>chef-vault</code>只有在<code>Chef</code>服务器拥有有效的<code>客户端＿密钥</code>时才可以加密数据在<code>chef-zero</code>工。环境下达可能不易配置我们在本节中到现在为止的例子中做了能在<code>chef-zero</code>环境下展示<code>chef-valut</code>的 <code>chef-valut</code>最少的工作 </p>
<pre><code>$ knife data bag show passwords mysql_root
WARNING: Encrypted data bag detected, but no secret provided for decoding. Displaying encrypted data.
id:       mysql_root
password:
  auth_tag:       XRKutwTzzRuQ+QuVHzZMRQ==

  cipher:         aes-256-gcm
  encrypted_data: 2w/iYmF9EdWmTqM4x3SfRpdP8N8dau9Eop87LY80ufKbQ8ivVbyODYlr4ocM
  tEWiSQ==

  iv:             pifuG1R7a9rH9/o0

  version:        3
</code></pre>
<pre><code>$ knife vault show passwords mysql_root --mode client
id:       mysql_root
password: This is a very secure password
</code></pre>
<h2 id="4"><strong>4、本节小结</strong></h2>
<ul>
<li>使用Knife在命令行进行数据包的基本操作</li>
<li>在配方单中使用数据包项目的数据创建本地用户</li>
<li>加密数据包</li>
<li>Chef-valut</li>
</ul>
<pre><code>$ knife data_bag create users
$ knife data_bag from file users alice.json
$ knife search users &quot;*:*&quot;
$ knife search users &quot;*:*&quot;
$ knife search users &quot;id:alice OR id:bob&quot; 
$ knife search users &quot;*:*&quot; -a shell


$ knife data bag create api_keys
$ knife data bag from file api_keys payment.json \
--secret-file encrypted_data_bag_secret data_bag_item[api_keys::payment]
$ knife data bag show api_keys payment

$ sudo gem install chef-vault --no-ri --no-rdoc
$ knife client create devhost  --disable-editing --file .chef/devhost.pem
$ knife client list
$ knife node create devhost --disable-editing
$ knife vault create passwords mysql_root --json data_bags/passwords/mysql_root.json --search &quot;*:*&quot;  --mode client
$ knife data bag show passwords mysql_root
$ knife vault show passwords mysql_root --mode client
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
    
  </body>
</html>
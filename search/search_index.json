{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u624b\u6478\u624b Chef &amp; Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b","text":"<p>Started at March. 2021 By Jacob Xi </p> <p></p>"},{"location":"#_1","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<p>\u672c\u4e66\u662f\u672c\u4eba\u7684\u201c\u624b\u6478\u624b\u6218\u672f\u6559\u7a0b\u201d\u7cfb\u5217\u7684\u7b2c\u56db\u672c\uff0c\u5386\u7ecf\u4e24\u4e2a\u6708\u7684\u65f6\u95f4\uff0c\u7ec8\u4e8e\u5728\u8fd8\u6ca1\u6709\u5f00\u82b1\ud83c\udf38\uff0c\u5929\u5929\u4e0b\u96e8\u2614\ufe0f\uff0c\u51b7\u7684\u8981\u6b7b\u7684\u4e09\u6708\ud83e\udd76\u5b8c\u5de5\u4e86\uff0c\u611f\u8c22\u5bb6\u4eba\uff0c\u670b\u53cb\uff0c\u540c\u4e8b\u4eec\u7684\u652f\u6301\u4e0e\u7406\u89e3\uff0c\u4e5f\u611f\u8c22\u6240\u5728team\u540c\u4e8b\u4eec\u7684\u5e2e\u52a9\u4e0e\u6307\u5bfc\u3002# \u6700\u8fd1\u770b\u4e86\u201c\u5927\u800c\u4e0d\u5012\u201d\uff0c\u201c\u53d1\u6761\u5973\u5b69\u201d\uff0c\u201c\u4f60\u4e00\u751f\u7684\u6545\u4e8b\u201d\uff0cOnly the book can calm me down\u3002</p>"},{"location":"#previous-on","title":"Previous on \u624b\u6478\u624b","text":"<p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p>"},{"location":"#ansible-vs-chef","title":"Ansible vs Chef","text":"<p>Ansible calls its configuration files \u201cplaybooks\u201d, while Chef calls them \u201ccookbooks\u201d.</p> <p>End of story. We\u2019re done.</p>"},{"location":"#setting-it-up","title":"Setting it Up:","text":"<p>Chef operates with a master-client architecture. The server part runs on the master machine, while the client portion runs as an agent on every client machine. Chef also has an extra component named \u201cworkstation\u201d that stores all of the configurations that are tested then pushed to the central server.</p> <p>Ansible only uses a master running on the server machine, but no agents running on the client machine. It uses an SSH connection to log in to the client systems or the nodes you want to configure, and the client machine VM has no need for special setup.</p>"},{"location":"#source-of-truth","title":"Source of Truth:","text":"<p>Source of Truth is defined as the authoritative configuration of a given set of systems or system. Ansible\u2019s source of truth comes from its deployed playbooks, which are perfect as source control systems, while</p> <p>Chef relies on its own server as the source of truth, and those servers require uploaded cookbooks, which means making sure the latter are consistent and identical.</p>"},{"location":"#managing-the-tools","title":"Managing the Tools:","text":"<p>With Chef, the client pulls configurations from the server. The configurations are in Ruby DSL, so you need to have programming skills in order to manage those configurations.</p> <p>Ansible uses YAML (Yet Another Markup Language) to manage configurations, a language that\u2019s similar to English, and the server pushes the configurations to the individual nodes.</p>"},{"location":"#_2","title":"\u672c\u4e66\u4e3b\u8981\u5185\u5bb9","text":"<p>\u672c\u4e66\u5171\u56db\u7ae0\uff0c\u4e3b\u8981\u4ecb\u7ecdChef\u548cAnsible\u7684\u4f7f\u7528\u8bed\u6cd5\uff0c\u5e38\u7528\u547d\u4ee4\u4ee5\u53ca\u751f\u4ea7\u6848\u4f8b\u3002 </p> <p>Chef \u4e3b\u8981\u4ecb\u7ecd\u4e86\u5e38\u7528\u7684Chef\u8bed\u6cd5\uff0ccookbook\u7684\u521b\u5efa\u4ee5\u53caapply, Kitchen\u7ba1\u7406\u865a\u62df\u673a\uff0cOhai\u5c5e\u6027\uff0cRecipes\u7684\u64b0\u5199\uff0c\u5c5e\u6027\uff0cdatabag, \u89d2\u8272\uff0c\u73af\u5883\u7684\u83b7\u53d6\uff0cchef-zero\u4ee5\u53cachef-solot\u7684\u4f7f\u7528\uff0c\u81ea\u52a8\u5316\u6d4b\u8bd5Recipes\uff0cKnife\u7684\u4f7f\u7528\u6280\u5de7\u4ee5\u53caLAMP\u7684Chef CookBook</p> <p>Ansible \u4e3b\u8981\u4ecb\u7ecd\u4e86\u5e38\u7528\u7684Ansible\u8bed\u6cd5\uff0cplaybook\u7684\u521b\u5efa\uff0cTask\u7684\u521b\u5efa\uff0cJinja\u8d4b\u503c\u7684Variable, \u89d2\u8272\u7684\u521b\u5efa\uff0c ansible-valut\u7ba1\u7406\u5bc6\u7801\uff0cansible\u5bf9\u7f51\u7edc\u7684\u7ba1\u7406\uff0c\u4ee5\u53ca\u5982\u4f55\u66f4\u597d\u7684\u5b9e\u73b0\u5e42\u7b49\u6027</p>"},{"location":"#comment-ca-va-cest-moi","title":"Comment ca va? C'est Moi","text":"<p>Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. </p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. </p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p>"},{"location":"#_3","title":"\u76ee\u5f55\u5927\u7eb2","text":"<ul> <li>\u7b2c\u4e00\u7ae0 Learning Chef<ul> <li>\u7b2c\u4e00\u8282 Chef \u4ecb\u7ecd\u548c\u5b89\u88c5</li> <li>\u7b2c\u4e8c\u8282 Ruby\u548cChef\u8bed\u6cd5</li> <li>\u7b2c\u4e09\u8282 \u5982\u4f55\u5199 Chef \u914d\u65b9 &amp; chef-apply</li> <li>\u7b2c\u56db\u8282 \u7528Test Kitchen\u7ba1\u7406\u6c99\u76d2\u6d4b\u8bd5\u73af\u5883</li> <li>\u7b2c\u4e94\u8282 \u7528 Chef \u6237\u7aef\u7ba1\u7406\u8282\u70b9</li> <li>\u7b2c\u516d\u8282 \u64b0\u5199\u548c\u4f7f\u7528\u83dc\u8c31</li> <li>\u7b2c\u4e03\u8282 \u5c5e\u6027</li> <li>\u7b2c\u516b\u8282 Chef \u670d\u52a1\u5668\u540c\u65f6\u7ba1\u7406\u591a\u4e2a\u8282\u70b9</li> <li>\u7b2c\u4e5d\u8282 \u793e\u533a\u4ee5\u53caChef-Client\u83dc\u8c31</li> <li>\u7b2c\u5341\u8282 Chef zero</li> <li>\u7b2c\u5341\u4e00\u8282 \u6570\u6982\u5305Databag</li> <li>\u7b2c\u5341\u4e8c\u8282 \u89d2\u8272</li> <li>\u7b2c\u5341\u4e09\u8282 \u73af\u5883</li> <li>\u7b2c\u5341\u56db\u8282 \u6d4b\u8bd5</li> <li>\u7b2c\u5341\u4e94\u8282 \u8bcd\u6c47\u8868</li> </ul> </li> <li>\u7b2c\u4e8c\u7ae0 Chef Opt &amp; Adv<ul> <li>\u7b2c\u4e00\u8282 Chef Roles</li> <li>\u7b2c\u4e8c\u8282 Cookbook Versioning</li> <li>\u7b2c\u4e09\u8282 How to Perform Chef Knife SSL Check and Fetch to Verify Certificate</li> <li>\u7b2c\u56db\u8282 12 Chef Knife Cookbook Command Examples </li> <li>\u7b2c\u4e94\u8282 knife search</li> <li>\u7b2c\u516d\u8282 Chef Quick CheatSheet</li> </ul> </li> <li>\u7b2c\u4e09\u7ae0 Chef Cookbook Sample LAMP<ul> <li>\u7b2c\u4e00\u8282 Creating My First Chef Cookbook</li> <li>\u7b2c\u4e8c\u8282 Creating LAMP Chef Cookbook Analysis </li> </ul> </li> <li>\u7b2c\u56db\u7ae0  Learning Ansible<ul> <li>L1 Ansible Introduction </li> <li>L2 Ansible Install(MacOs) and Environment Setup</li> <li>L3 Task Execution management</li> <li>L4 Ansible Variable Management</li> <li>L5 Managing complex playbooks with roles and ansible galaxy</li> <li>L6 Working with Secrets</li> <li>L7 Network Management with Ansible</li> <li>L8 Idempotentence with Ansible play</li> <li>L9 Ansible Interview</li> <li>L10 Ansible \u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177PPT</li> <li>L11 \u4efb\u52a1\u4e2d\u5fc3\u4e4bAnsible\u57fa\u7840\u7bc7</li> <li>L12 \u4efb\u52a1\u4e2d\u5fc3\u4e4bAnsible\u8fdb\u9636\u7bc7</li> <li>L13 Ansible \u9762\u8bd5\u77e5\u8bc6\u70b9</li> </ul> </li> <li>\u7b2c\u4e94\u7ae0 Certified Terraform Associate<ul> <li>HashiCorp Certified Terraform Associate Learning Path</li> <li>Terraform Cheat Sheet </li> </ul> </li> </ul>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>\u672c\u4eba\u5c06\u5e26\u6765\u624b\u6478\u624b\u6218\u672f\u6559\u7a0b\u66f4\u591a\u7684\u5185\u5bb9\u548c\u6587\u7ae0\uff0c \u63a5\u4e0b\u6765\u7684\u5c06\u5728Datatase, \u5f00\u53d1\u6027\u80fd&amp;Linux, Azure900, Azure103, AWS Solution Arcitect, AWS Big Data Speciality, Istio, Python\u5e26\u6765\u66f4\u591a\u66f4\u5168\u9762\u7684\u7535\u5b50\u4e66\uff0c\u656c\u8bf7\u671f\u5f85\u3002</p> <p></p>"},{"location":"chap1/chef_tutorial1/","title":"\u7b2c\u4e00\u8282 Chef \u4ecb\u7ecd\u548c\u5b89\u88c5","text":"<ul> <li>Chef\u662f\u4ec0\u4e48 </li> <li>\u4e3a\u4ec0\u4e48\u4f01\u4e1a\u9700\u8981Chef </li> <li>\u5728Linux\u4e0b\u5b89\u88c5Chef\u5f00\u53d1\u5de5\u5177</li> <li>\u5728<code>Mac OS X</code>\u4e0b\u5b89\u88c5<code>Chef</code>\u5f00\u53d1\u5de5\u5177</li> </ul>"},{"location":"chap1/chef_tutorial1/#1chef","title":"1\u3001Chef\u662f\u4ec0\u4e48","text":"<p><code>Chef</code>\u662f\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u548c\u7ba1\u7406\u7269\u7406\u6570\u636e\u4e2d\u5fc3\u6216\u4e91\u4e2d\u57fa\u7840\u67b6\u6784\u7684\u81ea\u52a8\u5316\u5e73\u53f0\u3002\u53ef\u4ee5\u628a\u5b83\u90e8\u7f72\u5230\u516c\u53f8\u6700\u9002\u5408\u7684\u57fa\u7840\u67b6\u6784\u7c7b\u578b\u4e2d\u3002\u53ef\u4ee5\u7528<code>Chef</code>\u6765\u52a0\u901f\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\uff0c\u751a\u81f3\u5b8c\u6210\u6301\u7eed\u90e8\u7f72\u6d41\u7a0b\u3002</p> <p><code>Chef</code>\u7684\u5173\u952e\u5a01\u529b\u5728\u4e8e\u5b83\u5c06\u57fa\u7840\u67b6\u6784\u53d8\u4e3a\u4ee3\u7801\u3002 \u7528\u4ee3\u7801\u6765\u8868\u793a\u57fa\u7840\u67b6\u6784\u610f\u5473\u7740\u8ba1\u7b97\u73af\u5883\u62e5\u6709\u4e00\u4e9b\u4e0e\u5176\u5e94\u7528\u7a0b\u5e8f\u4e00\u6837\u7684\u5c5e\u6027\u3002</p> <ul> <li>\u57fa\u7840\u67b6\u6784\u53ef\u4ee5\u6709\u4e0d\u540c\u7248\u672c\u3002 </li> <li>\u57fa\u7840\u67b6\u6784\u53ef\u4ee5\u88ab\u968f\u65f6\u91cd\u5efa\u3002 </li> <li>\u57fa\u7840\u67b6\u6784\u53ef\u4ee5\u62e5\u6709\u5b8c\u6574\u7684\u6d4b\u8bd5\u6765\u4fdd\u8bc1\u6b63\u786e\u6027\u3002 </li> </ul> <p>\u56fe\u5c55\u793a\u4e86<code>Chef</code>\u7684\u57fa\u672c\u67b6\u6784\u3002 </p> <p><code>Chef</code>\u5f00\u53d1\u5305\u7684\u7ec4\u4ef6\u53ef\u4ee5\u5e2e\u52a9\u652f\u6301\u4f60\u5728\u5f00\u53d1\u673a\u5668\u4e0a\u5199<code>Chef</code>\u4ee3\u7801\uff1b<code>Chef</code>\u670d\u52a1\u5668\u7684\u7ec4\u4ef6\u53ef\u4ee5\u5e2e \u52a9\u5ef6\u4f38\u914d\u7f6e\u7ba1\u7406\u80fd\u529b\uff0c\u4f7f\u4f60\u53ef\u4ee5\u7ba1\u7406\u6210\u767e\u4e0a\u5343\u6216\u66f4\u591a\u7684\u670d\u52a1\u5668\u3002 </p>"},{"location":"chap1/chef_tutorial1/#2chef","title":"2\u3001\u4e3a\u4ec0\u4e48\u4f01\u4e1a\u9700\u8981Chef","text":"<p>\u5f53<code>Adam Jacob</code>\u57282009\u5e74\u6700\u5f00\u59cb\u521b\u5efa<code>Che</code>\u65f6\uff0c\u4ed6\u6709\u4e09\u4e2a\u91cd\u8981\u7684\u89c2\u70b9\u6765\u89e3\u51b3\u4ed6\u5728\u5176\u4ed6\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u4e2d\u770b\u5230\u7684\u4e0d\u8db3\u3002 </p> <ol> <li>\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5e94\u8be5\u5bf9\u4e91\u57fa\u7840\u67b6\u6784\u63d0\u4f9b\u9876\u7ea7\u652f\u6301\u3002 </li> <li>\u4efb\u4f55\u4e00\u4e2a\u57fa\u7840\u67b6\u6784\u90fd\u662f\u72ec\u4e00\u65e0\u4e8c\u7684\u3002\u590d\u6742\u7684\u4f01\u4e1a\u57fa\u7840\u67b6\u6784\u8981\u80fd\u591f\u6781\u5927\u5730\u5f97\u76ca\u4e8e\u5c06\u5176IT\u57fa\u7840\u67b6\u6784\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u6d41\u7a0b\u4ee5\u4ee3\u7801\u6765\u5efa\u6a21\u3002 </li> <li>\u5353\u8d8a\u7684\u5de5\u5177\u548c\u70b9\u5b50\u6765\u6e90\u4e8e\u6d3b\u8dc3\u7684\u7528\u6237\u793e\u533a\u3002\u5149\u9760\u4e00\u4e2a\u4eba\u7684\u529b\u91cf\u662f\u4e0d\u591f\u7684\u3002 </li> </ol> <p></p>"},{"location":"chap1/chef_tutorial1/#2-1","title":"2-1 \u591a\u79cd\u7528\u6cd5","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u5f88\u591a\u65b9\u5f0f\u4f7f\u7528Chef. <code>Chef</code>\u53ef\u4ee5\u5728\u65e0\u670d\u52a1\u5668\u6a21\u5f0f\u72ec\u7acb\u8fd0\u884c\u6216\u914d\u5408\u4e2d\u592e\u670d\u52a1\u5668\uff08<code>Chef</code>\u670d\u52a1\u5668\uff09\u8fd0\u884c\u3002\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u63a8\u9001\u6216\u62c9\uff08\u8f6e\u8be2\uff09\u6a21\u5f0f\uff08\u6216\u4e24\u79cd\u7ed3\u5408\uff09 \u6765\u505a\u90e8\u7f72\u3002</p>"},{"location":"chap1/chef_tutorial1/#_1","title":"\u900f\u660e","text":"<p><code>Chef</code>\u5206\u6790\u5e73\u53f0\u5f3a\u5316<code>Chef</code>\uff0c\u8ba9\u4f60\u53ef\u4ee5\u5728\u91cd\u8981\u6539\u53d8\u751f\u6548\u7684\u65f6\u5019\u6536\u5230\u901a\u77e5\u6765\u4fdd\u8bc1\u5bf9\u6807\u51c6\u7684\u9075\u5faa\u3002 </p> <p><code>Chef</code>\u72ec\u7279\u7684\u7279\u6027\u4f53\u73b0\u51fa\u5f3a\u5927\u7684\u7075\u6d3b\u6027\u3002\u4f60\u4e0d\u9700\u8981\u4e3a\u9002\u5e94<code>Chef</code>\u800c\u6323\u624e\uff0c\u800c\u662f\u8ba9Chef\u9002\u5e94\u4f60 \u548c\u4f60\u7684\u73af\u5883\u3002\u4f60\u53ef\u4ee5\u90e8\u7f72\u5230\u4e91\u6216\u672c\u5730\u57fa\u7840\u67b6\u6784\uff0c\u4e5f\u53ef\u4ee5\u5728\u4ee3\u7801\u4e2d\u63cf\u8ff0\u4efb\u4f55\u8d44\u6e90\uff0c\u65e0\u8bba\u5b83\u4eec\u548c\u6807\u51c6\u7684\u914d\u7f6e\u6709\u591a\u4e48\u4e0d\u540c\u3002 </p> <p>\u4f7f\u7528<code>Chef</code>\uff0c\u901a\u5e38\u5e76\u4e0d\u9700\u8981\u4ece\u96f6\u5f00\u59cb\u5199\u63cf\u8ff0\u57fa\u7840\u67b6\u6784\u7684\u4ee3\u7801\u3002\u8bb8\u591a\u6807\u51c6\u7684\u57fa\u7840\u67b6\u6784\u914d\u7f6e\u548c \u4efb\u52a1\u7684\u83dc\u8c31\u90fd\u5df2\u7ecf\u5728<code>Chef</code>\u8d85\u5e02\uff08<code>https://supermarket.chef.io/</code>\uff09\u4e2d\uff0c\u514d\u8d39\u7684\u3002 </p> <p>\u4e00\u65e6\u638c\u63e1<code>Chef</code>\uff0c\u5c31\u53ef\u4ee5\u7528\u5b83\u6765\u505a\u4ee5\u4e0b\u4e8b\u60c5\u3002 </p> <ul> <li>\u5b8c\u5168\u81ea\u52a8\u5316\u90e8\u7f72\uff0c\u5305\u62ec\u5185\u90e8\u548c\u9762\u5411\u7528\u6237\u7684\u7cfb\u7edf\u3002 </li> <li>\u81ea\u52a8\u5316\u4f38\u7f29\u57fa\u7840\u67b6\u6784\u3002 </li> <li>\u8ba9\u57fa\u7840\u67b6\u6784\u81ea\u6211\u4fee\u590d\u3002 </li> </ul> <p>\u4e3e\u4f8b\u800c\u8a00\uff0cTom Hallet\u4f7f\u7528<code>Chef</code>\u521b\u5efa\u4e86\u4e00\u4e2a\u53eb<code>SoloWizard</code>\u7684\u5de5\u5177\u6765\u81ea\u52a8\u5316\u5176<code>Mac OS X</code>\u5f00\u53d1\u673a\u5668\u7684\u90e8\u7f72\u3002</p> <p>SoloWizard\u57fa\u4e8e<code>Pivotal Labs</code>\u6240\u505a\u7684\u4fc3\u8fdb\u5f00\u53d1\u8005\u548c\u6700\u7ec8\u7528\u6237\u4f7f\u7528\u81ea\u52a8\u5316\u7684\u5de5\u4f5c\u3002\u6b63\u50cf\u56fe\u4e2d\u6240\u793a\uff0c<code>SoloWizard</code>\u5141\u8bb8\u4f60\u4e00\u952e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5f00\u53d1\u73af\u5883\u3002\u4f60\u751a\u81f3\u53ef\u4ee5\u901a \u8fc7\u5728\u4e00\u4e2a\u7b80\u5355\u7684\u7f51\u7ad9\u4e0a\u505a\u9009\u62e9\u6765\u4e2a\u6027\u5316\u8f93\u51fa\u7684\u811a\u672c\u3002\u6b64\u5de5\u5177\u5728<code>Solo Wizard</code>\u7f51\u7ad9\uff08<code>http://www.solowizard.com</code>\uff09\u53ef\u4ee5\u627e\u5230\u3002 </p> <p></p>"},{"location":"chap1/chef_tutorial1/#3linuxchef","title":"3\u3001\u5728Linux\u4e0b\u5b89\u88c5Chef\u5f00\u53d1\u5de5\u5177","text":"<p>\u5728Linux\u4e0a\u5b89\u88c5Chef\u5f00\u53d1\u4e0a\u5177\u9700\u8981\u8fde\u63a5\u4e92\u8054\u7f51\u4ee5\u53ca\u5bf9\u4f7f\u7528\u7684\u5fc3\u5e99\u62e5\u6709root\u6743\u9650\u3002</p> <p>\u8bbf\u95ee<code>Chef</code>\u4e0b\u8f7d\u9875\u9762(<code>https://downloads.chef.io/chefdk</code>)\uff0c \u9488\u5bf9\u81ea\u5df1\u7684Linux\u7c7b\u578b\u548c\u7248\u672c\u4e0b\u8f7d\u5408\u9002\u7684\u5b89\u88c5\u5305\u3002</p> <p>\u70b9\u51fb<code>Chef Development Kit (Chefdk\u5f00\u53d1\u5305\uff09</code>\u94fe\u63a5.</p> <p></p> <p>\u5982\u679c\u9488\u5bf9\u5177\u4f53<code>Linux</code>\u7248\u672c\u6ca1\u6709\u53ef\u7528\u7684<code>Chef</code>\u5f00\u53d1\u5305\u7684\u5b89\u88c5\u7a0b\u5e8f\uff0c\u9700\u8981\u5b89\u88c5\u9488\u5bf9\u7684<code>Chef</code>\u5ba2\u6237\u7aef\u4ee5\u53ca\u4e00\u4e9b\u989d\u5916\u7684\u5de5\u5177\u3002\u8bb0\u4f4f\uff0c\u4f7f\u7528Chef\u5f00\u53d1\u5305\u5b89\u88c5\u7a0b\u5e8f\u5341\u5206\u4fbf\u4e0d\u662f\u5fc5\u987b\u7684\uff0c\u56e0\u6b64\u6ca1\u6709\u4e5f\u6ca1\u4ec0\u4e48\u5927\u4e0d\u4e86\u7684\u3002\u5728\u6b64\u60c5\u51b5\u4e00\u5382\uff0c\u56de\u5230<code>Chef</code>\u4e0b\u8f7d\u9875\u9762 <code>https://downloads.chef.io/</code>\uff09\u5e76\u9009\u62e9\u4e0b\u8f7d\u3001\u5b89\u88c5<code>Chef Client</code> (Chef\u5ba2\u6237\u7aef\uff09\u3002</p> <p>\u5728\u4e0b\u8f7d\u9875\u800c<code>Chef Client</code> (<code>Chef</code>\u5ba2\u6237\u7aef\uff09\u4e0b\uff0c\u9009\u62e9<code>Linux</code>\u5206\u53d1\u7c7b\u578b\u548c\u7248\u672c\uff0c\u9009\u62e9\u597d\u540e\uff0c\u5c06\u5f97\u5230\u5b89\u88c5\u5305\u7684\u4e0b\u8f7d\u94fe\u63a5\u3002 </p> <p></p> <p>To start with the installation procedure, install the pre-requirement packages before installing Chef application. Execute the following command.</p> <pre><code>sudo  yum install -y wget curl git\n</code></pre> <p>After installing the pre-required packages, download the Chefdk package from its official site by running the wget command followed by the download link.</p> <pre><code>$ wget  https://packages.chef.io/files/stable/chefdk/4.5.0/el/7/chefdk-4.5.0-1.el7.x86_64.rpm\n--2019-11-17 10:23:12--  https://packages.chef.io/files/stable/chefdk/4.5.0/el/7/chefdk-4.5.0-1.el7.x86_64.rpm\nResolving packages.chef.io (packages.chef.io)... 151.101.194.110, 151.101.2.110, 151.101.66.110, ...\nConnecting to packages.chef.io (packages.chef.io)|151.101.194.110|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 95156237 (91M) [application/x-rpm]\nSaving to: 'chefdk-4.5.0-1.el7.x86_64.rpm'\n\n100%[===================================================================================================================================&gt;] 95,156,237   787KB/s   in 6m 37s\n\n2019-11-17 10:29:50 (234 KB/s) - 'chefdk-4.5.0-1.el7.x86_64.rpm' saved [95156237/95156237\n</code></pre> <p>The package is downloaded to the target system. Next install the chefdk by executing the rpm command.</p> <pre><code>$ sudo rpm -ivh chefdk-4.5.0-1.el7.x86_64.rpm\nwarning: chefdk-4.5.0-1.el7.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\nPreparing...                          ################################# [100%]\nUpdating / installing...\n   1:chefdk-4.5.0-1.el7               ################################# [100%]\nThank you for installing ChefDK!\nYou can find some tips on getting started at https://learn.chef.io\n</code></pre> <p>Chef\u5f00\u53d1\u5305\u7684\u5b89\u88c5\u7a0b\u5e8f\u4f1a\u81ea\u52a8\u5c06<code>Chef</code>\u548c<code>Ruby</code>\u5b89\u88c5\u5230<code>/opt/chefdk/emhedded</code>\u76ee\u5f55\uff0c\u8fd9\u4e9b\u76ee\u5f55 \u901a\u5e38\u5c01\uff1a\u4e0d\u4f1a\u5728\u9ed8\u8ba4\u73af\u5883\u7684\u8def\u5f84\uff08<code>PATH</code>)\u4e2d\u3002</p> <p>Chef\u5f00\u53d1\u5305\u5305\u542b\u4e00\u4e2a<code>chef shell-init</code>\u547d\u4ee4\u6765\u66f4\u6539\u73b0\u6709\u58f3\u73af\u5883\u6765\u4f7f\u7528\u8fd9\u4e9b\u8def\u5f84\u3002\u5047\u8bbe\u4f7f\u7528 <code>Linux</code>\u7684\u9ed8\u8ba4bash\u58f3\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u6c38\u4e45\u6027\u542f\u7528\u8fd9\u4e2a\u8def\u5f84\uff08<code>PATH</code>)\u8bbe\u7f6e\u3002 </p> <p>\u5b89\u88c5Chef\u5f00\u53d1\u5305\uff1a </p> <pre><code>echo 'eval \"$(chef shell-init bash)\"' &gt;&gt; ~/.bash_profile\n</code></pre> <p><code>Chef</code>\u5ba2\u6237\u7aef\u5b89\u88c5</p> <pre><code>export PATH='/opt/chef/embedded/bin:$PATH \n</code></pre> <p>\u66f4\u6539<code>\uff04HOPE/.bash_profile</code>\u4ee5\u540e\uff0c\u9700\u8981\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u6267\u884c<code>source</code>\u6765\u8bbe\u5b9a\u6b63\u786e\u7684\u8def\u5f84 (<code>*PATH</code>)\u3002\u6216\u8005\u53ef\u4ee5\u5f7b\u5e95\u5173\u95ed\u5e76\u91cd\u542f\u547d\u4ee4\u884c\u7a0b\u5e8f\u6765\u91cd\u65b0\u52a0\u8f7d<code>$HOME/.bash_profile</code></p> <pre><code>$ source $HOME/.bash_profile \n</code></pre>"},{"location":"chap1/chef_tutorial1/#3-1-linuxchefchef","title":"3-1 \u9a8c\u8bc1Linux\u4e0b\u7684Chef\u5f00\u53d1\u5305\u3001Chef\u5ba2\u6237\u7aef\u5b89\u88c5","text":"<p>\u53d6\u51b3\u4e8e\u5b89\u88c5\u7684\u662f<code>Chef</code>\u5f00\u53d1\u5305\u8fd8\u662f<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u786e\u4fdd\u5728\u4ee5<code>$PATH</code>\u66f4\u6539\u540e\u7cfb\u7edf\u4f7f\u7528\u5728<code>opt/chefdk/embedded/bin</code>(Chef\u5f00\u53d1\u5305\uff09\u6216<code>/opt/chef/embedded/bin</code>(Chef\u5ba2\u6237\u7aef\uff09\u7684<code>Ruby</code>\u811a\u672c\u5f15\u64ce\u3002\u5728\u547d\u4ee4\u884c\u6267\u884c<code>which ruby</code>\uff0c\u4f1a\u770b\u5230\u5982\u4e0b\u7ed3\u679c\u3002 </p> <p>\u5982\u679c\u5b89\u88c5\u7684\u662f<code>Chef</code>\u5f00\u53d1\u5305 </p> <pre><code>$ which ruby\n/opt/chefdk/embedded/bin/ruby\n</code></pre> <p>\u5982\u679c\u5b89\u88c5\u7684\u662f<code>Chef</code>\u5ba2\u6237\u7aef</p> <pre><code>$ which ruby\n/opt/chef/embedded/bin/ruby\n</code></pre> <p>The Chef application is installed successfully in your system. You can also verify the ChefDK installation procedure by running the following command.</p> <pre><code>$ chef verify\n+---------------------------------------------+\n            Chef License Acceptance\n\nBefore you can continue, 3 product licenses\nmust be accepted. View the license at\nhttps://www.chef.io/end-user-license-agreement/\n\nLicenses that need accepting:\n  * Chef Development Kit\n  * Chef Infra Client\n  * Chef InSpec\n\nDo you accept the 3 product licenses (yes/no)?\n\n&gt; yes\n\nPersisting 3 product licenses...\n\u2714 3 product licenses persisted.\n...\n</code></pre> <pre><code>$ chef-client --version\nChef Infra Client: 15.4.45\n</code></pre>"},{"location":"chap1/chef_tutorial1/#3-2-linuxchefchef","title":"3-2 \u9a8c\u8bc1Linux\u4e0b\u5378\u8f7dChef\u5f00\u53d1\u5305\u3001Chef\u5ba2\u6237\u7aef","text":"<p>\u5728RedHat\u4f01\u4e1a<code>Linux</code>\u7cfb\u7edf\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528<code>rpm</code>\u6765\u5374\u8f7d<code>Chef</code>\u5f00\u53d1\u5305\u548c<code>Chef</code>\u5ba2\u6237\u7aef\u3002 </p> <p><code>Chef</code>\u5f00\u53d1\u5305\u5374\u8f7d\uff1a</p> <pre><code>$ rpm -qa chefdk \n$ sudo yum remove -y \n\uff03\u5982\u679c\u4f60\u5b89\u88c5\u4e86\u5176\u4ed6\u7684Ruby\u7a0b\u5e8f\uff08gems)\uff0c\u624b\u52a8\u5220\u9664/opt/chefdk\n$ sudo rm -rf/ opt/chefdk \n\uff03\u4ece\uff04HOME/.bash_profile\u5220\u9664Chef\u7684\u8def\u5f84 \n</code></pre> <p><code>Chef</code>\u5ba2\u6237\u7aef\u5374\u8f7d\uff1a</p> <pre><code>$ rpm -qa chef \n$ sudo yum remove -y &lt;package&gt; \n\uff03\u5982\u679c\u4f60\u5b89\u88c5\u4e86\u5176\u4ed6\u7684Ruby\u7a0b\u5e8f\uff08gems)\uff0c\u624b\u52a8\u5220\u9664\uff0fopt/chef \n$ sudo rm\u4e00rf/opt/chef \n\uff03\u4ece\uff04HOME/.bash_profile\u5220\u9664Chef\u7684\u8def\u5f84 \n</code></pre>"},{"location":"chap1/chef_tutorial1/#3-3-linuxtest-kitchenchef","title":"3-3 \u5728Linux\u4e0b\u5b89\u88c5<code>Test Kitchen</code>\uff08\u5982\u679c\u524d\u9762\u9009\u62e9\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u800c\u4e0d\u662f\u5f00\u53d1\u5305\uff09","text":"<p>\u5728\u6709\u4e9b\u52a8\u624b\u7ec3\u4e60\u4e2d\uff0c\u4f1a\u4f7f\u7528<code>Test Kitchen</code>\u6765\u521b\u5efa\u865a\u62df\u7684\u6c99\u4f17\u73af\u9b42\u3002<code>Chef</code>\u5ba2\u6237\u7aef\u5b89\u88c5\u7a0b\u5e8f\u7247\u4e0d\u5b89\u88c5<code>Test Kitchen</code>\uff0c\u56e0\u6b64\u9700\u8981\u4f60\u624b\u52a8\u5b89\u88c5\u3002 </p> <p>\u9700\u8981\u5b89\u88c5<code>test-kitchen</code>\u7684<code>Ruby</code>\u7a0b\u5e8f(gems) <code>gem</code>\u6307\u7528<code>Ruby</code>\u5199\u5e76\u5206\u53d1\u7684\u5e93\u6216\u5e94\u7528\u7a0b\u5e8f \u53ef\u4ee5\u60f3\u8c61<code>gem</code>\u4e3a<code>Ruby</code>\u7a0b\u5e8f\u7684\u5b89\u88c5\u7a0b\u5e8f\u3002</p> <p>\u4ee5<code>root</code>\u6743\u9650\u8fd0\u884c<code>gem install</code>\u547d\u4ee4\u53ef\u4ee5\u5b89\u88c5<code>test\u4e00kitchen</code>\u7a0b\u5e8f, <code>--no-ri</code>\u548c\u00b7no rdoc`\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7\u514d\u9664\u5b89\u88c5\u548c\u521b\u5efa\u6587\u6863\u6765\u8282\u7701\u65f6\u95f4 </p> <pre><code>sudo gem install test-kitchen --no-ri  --no-rdoc \n</code></pre>"},{"location":"chap1/chef_tutorial1/#3-4-ruby","title":"3-4 Ruby \u7a0b\u5e8f\u88ab\u5b89\u88c5\u5230\u54ea\u4e86","text":"<pre><code>$ gem env\nRubyGems Environment:\n  - RUBYGEMS VERSION: 3.0.3\n  - RUBY VERSION: 2.6.5 (2019-10-01 patchlevel 114) [x86_64-linux]\n  - INSTALLATION DIRECTORY: /home/vagrant/.chefdk/gem/ruby/2.6.0\n  - USER INSTALLATION DIRECTORY: /home/vagrant/.chefdk/gem/ruby/2.6.0\n  - RUBY EXECUTABLE: /opt/chefdk/embedded/bin/ruby\n  - GIT EXECUTABLE: /usr/bin/git\n  - EXECUTABLE DIRECTORY: /home/vagrant/.chefdk/gem/ruby/2.6.0/bin\n  - SPEC CACHE DIRECTORY: /home/vagrant/.gem/specs\n  - SYSTEM CONFIGURATION DIRECTORY: /opt/chefdk/embedded/etc\n  - RUBYGEMS PLATFORMS:\n    - ruby\n</code></pre>"},{"location":"chap1/chef_tutorial1/#linuxtest-kitchenchef","title":"\u9a8c\u8bc1Linux\u4e0b<code>Test Kitchen</code>\u7684\u5b89\u88c5\uff08\u5982\u679c\u524d\u9762\u9009\u62e9\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u800c\u4e0d\u662f\u5f00\u53d1\u5305\uff09","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>gem list</code>\u547d\u4ee4\u6765\u9a8c\u8bc1<code>test-kitchen</code>\u7684\u5b89\u88c5\u3002\u5982\u679c<code>Test Kitchen</code>\u5df2\u7ecf\u5b89\u88c5\uff0c <code>gem list</code>\u547d\u4ee4\u4f1a\u663e\u793a\u7ed3\u679c<code>true</code>:</p> <pre><code>gem list test-kitchen -i\ntrue\n</code></pre>"},{"location":"chap1/chef_tutorial1/#4mac-os-xchef","title":"4\u3001\u5728<code>Mac OS X</code>\u4e0b\u5b89\u88c5<code>Chef</code>\u5f00\u53d1\u5de5\u5177","text":"<p>https://downloads.chef.io/chefdk/4.5.0</p> <p><code>Chef</code>\u5f00\u53d1\u5305\u7684\u5b89\u88c5\u7a0b\u5e8f\u4f1a\u81ea\u52a8\u5c06<code>Chef</code>\u548c<code>Ruby</code>\u5b89\u88c5\u5230<code>/opt/chefdk/embedded</code>\u76ee\u5f55\uff0c\u8fd9\u4e9b\u76ee\u5f55\u901a\u5e38\u4e0d\u4f1a\u5728\u9ed8\u8ba4\u73af\u5883\u7684\u8def\u5f84(PATH)\u4e2d</p> <p><code>Chef</code>\u5f00\u53d1\u5305\u5305\u542b\u4e00\u4e2a<code>chef shell-init</code>\u547d\u4ee4\u6765\u66f4\u6539\u73b0\u6709\u58f3\u73af\u5883\u6765\u4f7f\u7528\u8fd9\u4e9b\u8def\u5f84\u3002\u5047\u8bbe\u4f7f\u7528  <code>Mac Os</code>\u9ed8\u8ba4<code>bash</code>\u58f3\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u6c38\u4e45\u6027\u542f\u7528\u8fd9\u4e2a\u8def\u5f84(<code>PATH</code>)\u8bbe\u7f6e\u3002</p> <p></p> <p>\u5b89\u88c5Chef\u5f00\u53d1\u5305</p> <pre><code>echo 'eval \"$(chef shell-init bash)\"' &gt;&gt; ~/.bash_profile\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u5408\u9002\u7684<code>Chef</code>\u5f00\u53d1\u5305\u7248\u672c\u800c\u9009\u62e9\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\uff0c<code>Chef</code>\u548c<code>Ruby</code>\u5c06\u88ab\u5b89\u88c5\u5230<code>/opt/chefdk/embedded</code></p> <p>\u6211\u4eec\u63a8\u8350\u4f60\u628a\u8fd9\u4e2ab\u52a0\u4f4d\u7f6e\u52a0\u5230\u4ee5\u4e0b\u7684\u8def\u5f84\uff08<code>PATH</code>)\u4e2d\u3002 \u53ef\u4ee5\u628a\u8fd9\u4e00\u884c\u52a0\u5165\u5230<code>$HOME/.bash_profile</code>\u6587\u4ef6\uff0c\u6216\u5728\u542f\u52a8\u914d\u7f6e\u548c\u8bbe\u5b9a\u4e2d\u7684\u6307\u5b9a\u5176\u4ed6\u914d\u7f6e\u6587\u4ef6\uff08<code>profile</code>)\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f\u5176\u4ed6\u547d\u4ee4\u884c\u58f3 </p> <pre><code>export PATH=\"/opt/chef/embedded/bin:$PATH\" \n</code></pre> <p>\u66f4\u6539<code>\uff04HOME/.bash_profile</code>\u4ee5\u540e\uff0c\u9700\u8981\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u6267\u884c<code>source</code>\u6765\u8bbe\u5b9a\u6b63\u786e\u7684\u8def\u5f84  (<code>$PATH</code>\uff09\u3002\u6216\u8005\u53ef\u4ee5\u5f7b\u5e95\u5173\u95ed\u5e76\u91cd\u542f\u547d\u4ee4\u884c\u7a0b\u5e8f\u6765\u91cd\u65b0\u52a0\u8f7d<code>\uff04HOME/bash_profile</code>: </p> <pre><code>source $HOME/.bash_profile \n</code></pre> <p>\u53d6\u51b3\u4e8e\u5b89\u88c5\u7684\u662f<code>Chef</code>\u5f00\u53d1\u5305\u8fd8\u662f<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u786e\u4fdd\u5728\u4ee5\u4e0a<code>$PATH</code>\u66f4\u6539\u540e\u7cfb\u7edf\u4f7f\u7528\u5728<code>/opt/chefdk/embedded/bin</code> (Chef\u5f00\u53d1\u5305\uff09\u6216<code>opt/chef/embedded/bin</code> (Chef\u5ba2\u6237\u7aef\uff09\u7684<code>Ruby</code>\u811a\u672c\u5f15\u64ce\u3002\u5728\u547d\u4ee4\u884c\u6267\u884c<code>which ruby</code>\uff0c\u4f1a\u770b\u5230\u5982\u4e0b\u7ed3\u679c\u3002 </p> <p>\u5982\u679c\u5b89\u88c5\u7684\u662fChef\u5f00\u53d1\u5305\uff1a </p> <pre><code>$ which ruby\n/opt/chefdk/embedded/bin/ruby\n</code></pre> <p>\u5982\u679c\u5b89\u88c5\u7684\u662f<code>Chef</code>\u5ba2\u6237\u7aef\uff1a</p> <pre><code>$which ruby \n/opt/chef/embedded/bin/ruby\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u5f97\u5230\u4efb\u4f55\u7ed3\u679c\uff0c\u6216\u5982\u679c\u7ed3\u679c\u4e0d\u662f<code>/opt/chefdk/embedded/bin/ruby</code>\u6216<code>opt/chef/embedded/bin/ruby</code>\uff0c\u901a\u5e38\u8bf4\u660e\u4f60\u6ca1\u6709\u5b89\u88c5\u6210\u529f\u6216\u8def\u5f84\u6ca1\u6709\u6b63\u786e\u8bbe\u5b9a\u3002\u5e94\u518d\u6b21\u786e\u8ba4\u6b63\u786e\u5b8c\u6210\u4e86\u4ee5\u4e0a\u6240\u6709\u6b65\u9aa4\u3002 </p> <pre><code>$ ls /opt/chefdk/bin\nberks               chef-service-manager        dco             ohai\nchef                chef-shell          delivery            print_execution_environment\nchef-apply          chef-solo           foodcritic          push-apply\nchef-client         chef-vault          inspec              pushy-client\nchef-resource-inspector     chef-windows-service        kitchen             pushy-service-manager\nchef-run            cookstyle           knife\n</code></pre>"},{"location":"chap1/chef_tutorial1/#4-1-mac-ostest-kitchenchef","title":"4-1 \u5728<code>Mac OS</code>\u4e0b\u5b89\u88c5<code>Test Kitchen</code>\uff08\u5982\u679c\u524d\u9762\u9009\u62e9\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u800c\u4e0d\u662f\u5f00\u53d1\u5305\uff09","text":"<p>\u5728\u6709\u4e9b\u52a8\u624b\u7ec3\u4e60\u4e2d\uff0c\u4f1a\u4f7f\u7528<code>Test Kitchen</code>\u6765\u521b\u5efa\u865a\u62df\u7684\u6c99\u4f17\u73af\u9b42\u3002<code>Chef</code>\u5ba2\u6237\u7aef\u5b89\u88c5\u7a0b\u5e8f\u7247\u4e0d\u5b89\u88c5<code>Test Kitchen</code>\uff0c\u56e0\u6b64\u9700\u8981\u4f60\u624b\u52a8\u5b89\u88c5\u3002 </p> <p>\u9700\u8981\u5b89\u88c5<code>test-kitchen</code>\u7684<code>Ruby</code>\u7a0b\u5e8f(gems) <code>gem</code>\u6307\u7528<code>Ruby</code>\u5199\u5e76\u5206\u53d1\u7684\u5e93\u6216\u5e94\u7528\u7a0b\u5e8f \u53ef\u4ee5\u60f3\u8c61<code>gem</code>\u4e3a<code>Ruby</code>\u7a0b\u5e8f\u7684\u5b89\u88c5\u7a0b\u5e8f\u3002</p> <p>\u4ee5<code>root</code>\u6743\u9650\u8fd0\u884c<code>gem install</code>\u547d\u4ee4\u53ef\u4ee5\u5b89\u88c5<code>test\u4e00kitchen</code>\u7a0b\u5e8f, <code>--no-ri</code>\u548c<code>no rdoc</code>\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7\u514d\u9664\u5b89\u88c5\u548c\u521b\u5efa\u6587\u6863\u6765\u8282\u7701\u65f6\u95f4 </p> <pre><code>sudo gem install test-kitchen --no-ri  -no-rdoc \n</code></pre>"},{"location":"chap1/chef_tutorial1/#4-2-mac-ostest-kitchenchef","title":"4-2 \u9a8c\u8bc1<code>Mac OS</code>\u4e0b<code>Test Kitchen</code>\u7684\u5b89\u88c5\uff08\u5982\u679c\u524d\u9762\u9009\u62e9\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u800c\u4e0d\u662f\u5f00\u53d1\u5305\uff09","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>gem list</code>\u547d\u4ee4\u6765\u9a8c\u8bc1<code>test-kitchen</code>\u7684\u5b89\u88c5\u3002\u5982\u679c<code>Test Kitchen</code>\u5df2\u7ecf\u5b89\u88c5\uff0c <code>gem list</code>\u547d\u4ee4\u4f1a\u663e\u793a\u7ed3\u679c<code>true</code>:</p> <pre><code>gem list test-kitchen -i\ntrue\n</code></pre>"},{"location":"chap1/chef_tutorial1/#5","title":"5\u3001\u672c\u8282\u603b\u7ed3","text":"<ul> <li>Chef\u662f\u4ec0\u4e48</li> <li>\u4e3a\u4ec0\u4e48\u4f01\u4e1a\u9700\u8981Chef</li> <li>\u5728Linux\u4e0b\u5b89\u88c5Chef\u5f00\u53d1\u5de5\u5177</li> <li>\u5728Mac OS X\u4e0b\u5b89\u88c5Chef\u5f00\u53d1\u5de5\u5177</li> </ul> <pre><code>$ chef verify\n$ chef-client --version\n</code></pre>"},{"location":"chap1/chef_tutorial10_zero/","title":"\u7b2c\u5341\u8282 Chef zero","text":"<ul> <li>Test Kitchen and Chef Zero</li> <li>\u7528<code>Chef-Playground</code> \u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u8fd0\u884c<code>Chef-Zero</code> </li> </ul>"},{"location":"chap1/chef_tutorial10_zero/#1","title":"1\u3001\u641c\u7d22","text":"<ul> <li>\u7528<code>Knife</code>\u4ece\u547d\u4ee4\u884c\u641c\u7d22 </li> <li>\u4f7f\u7528<code>Test Kitchen</code>\u4ece\u914d\u65b9\u5355\u4e2d\u641c\u7d22</li> </ul> <p>\u66f4\u5c11\u7684\u5185\u5b58\u542f\u52a8\u4e00\u4e2aChef\u670d\u52a1\u5668\u4f5c\u4e3a\u6d4b\u8bd5\u7528\u9014\u5c82\u4e0d\u662f\u5f88\u597d\u3002\u4e3a\u6b64<code>Chef</code>\u5f00\u53d1\u5305\u5305\u542b\u4e2a\u7cbe\u7b80\u7248\u672c\u7684<code>Chef</code>\u670d\u52a1\u5668\u79f0\u4f5c<code>chef-zero</code>.</p> <p><code>chef_zero</code>\u53ef\u4ee5\u4f7f\u7528\u5740\u5c11<code>20MB</code>\u5185\u5b58\u6765\u8fd0\u884c\u56e0\u4e3a\u5b83\u5f88\u5c0f\u6240\u4ee5\u542f\u52a8\u5f88\u5feb\u56e0\u6b64\u5f88\u9002\u5408\u7528 \u4f5c\u6d4b\u8bd5\u3002\u7531\u4e8e\u8981\u8ba9<code>Chef</code>\u670d\u52a1\u5668\u7528\u6781\u5c11\u7684\u5185\u5b58\u5373\u53ef\u8fd0\u884c\uff0c<code>chef-zero</code>\u4e5f\u4f5c\u51fa\u4e86\u4e00\u4e9b\u727a\u7272\u5b83\u6ca1\u6709\u7f51\u9875\u7528\u6237\u754c\u9762\u4e5f\u5c0f\u4f1a\u6c38\u4e45\u5b58\u50a8\u4efb\u4f55\u6570\u636e\u4e00\u65e6<code>Chef Zero</code>\u505c\u6b62\u8fd0\u884c, \u6240\u6709\u6570\u636e\u90fd\u5c06\u4e22\u5931\u4f46\u5bf9\u4e8e\u6d4b\u8bd5\u73af\u5883\u4f60\u4e95\u4e0d\u9700\u8981\u7f51\u9875\u7528\u6237\u754c\u9762\u6216\u6c38\u4e45\u6570\u636e\u4fdd\u5b58\u3002 </p> <p><code>Test-Kitchen</code>\u63d0\u4f9b\u5bf9<code>chef-zero</code>\u7684\u5185\u5efa\u652f\u6301\u3002\u8ba9\u6211\u4eec\u7528\u4e00\u4e2a\u4f8b\u5b50\u6765\u5c55\u793a\u5982\u4f55\u901a\u8fc7<code>Test-Kitchen</code>\u6765\u4f7f\u7528<code>chef-zero</code>\u3002 \u901a\u8fc7\u4f7f\u7528<code>chef-zero</code>\u4f5c\u4e3a\u6a21\u62df\u7684<code>chef</code>\u670d\u52a1\u5668\u6765\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u8fd0\u884c<code>chef-client</code>\u6d4b\u8bd5\u83dc\u8c31\uff0c\u4f60\u53ef\u4ee5\u6d4b\u8bd5\u5230\u83dc\u8c31\u4e2d\u4f7f\u7528<code>Chef</code>\u670d\u52a1\u5668\u529f\u80fd\u7684\u90e8\u5206</p>"},{"location":"chap1/chef_tutorial10_zero/#2test-kitchen-and-chef-zero","title":"2\u3001Test Kitchen and Chef Zero","text":"<p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook zero\n$ cd zero\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create zero --cookbook-path .\n$ cd zero\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <pre><code>$ chef generate cookbook zero\nGenerating cookbook zero\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd zero` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <p><code>chap10/zero/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  always_update_cookbooks: true\n# client_rb:\n#   chef_license: accept\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[zero::default]\n    attributes:\n</code></pre> <pre><code>$ kitchen converge\n</code></pre> <p><code>Test-Kitchen</code>\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u914d\u7f6e<code>chef-zero</code>\u7684\u5185\u5efa\u652f\u6301</p> <ol> <li>\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef</li> <li>\u5728<code>/tmp/kitchen</code> \u521b\u5efa\u5047\u7684 <code>validation.pem</code> and <code>client.pem</code> </li> <li>\u5728<code>/tmp/kitchen</code> \u751f\u6210 <code>client.rb</code> (<code>chef-client</code>\u7684\u914d\u7f6e\u6587\u4ef6) </li> <li>\u5728 <code>/tmp/kitchen</code>\u751f\u6210\u5305\u542b\u8fd0\u884c\u6e05\u5355<code>dna.json</code>\u7684\u6587\u4ef6</li> <li>\u5728 <code>/tmp/kitchen/cookbooks</code>\u540c\u6b65\u5bbf\u4e3b\u673a\u4e0a\u7684\u83dc\u8c31</li> <li>\u672c\u5730\u6a21\u5f0f\u8fd0\u884c<code>chef-client</code></li> </ol> <pre><code>cd zero/\nchef-client --local-mode --log_level --chef-zero-port 8889 --json-attributes dna.json\n</code></pre> <pre><code>$ chef-client --local-mode  --chef-zero-port 8889\n[2019-12-04T10:39:59+08:00] WARN: No config file found or specified on command line. Using command line options instead.\n[2019-12-04T10:39:59+08:00] WARN: No cookbooks directory found at or above current directory.  Assuming /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/zero.\nStarting Chef Infra Client, version 15.4.45\nresolving cookbooks for run list: []\nSynchronizing Cookbooks:\nInstalling Cookbook Gems:\nCompiling Cookbooks...\n[2019-12-04T10:40:03+08:00] WARN: Node C02Z155JLVDR has an empty run list.\nConverging 0 resources\n\nRunning handlers:\nRunning handlers complete\nChef Infra Client finished, 0/0 resources updated in 03 seconds\n</code></pre> <p>\u9700\u8981\u8bb0\u4f4f\u7684\u4e00\u4e2a\u91cd\u8981\u7684\u4e8b\u60c5\u662f\u8fd0\u884c<code>Chef</code>\u5ba2\u6237\u7aef\u65f6<code>Test Kitchen</code>\u5728\u540e\u53f0\u8fd0\u884c<code>chef-zero</code> \u4e95\u5728<code>Chef</code>\u884c\u7ed3\u675f\u540e\u5c06\u5176\u505c\u6b62\u3002</p> <p>\u5b83\u5e76\u4e0d\u4f1a\u4fdd\u6301<code>chef-zero</code>\u8fd0\u884c\u4e5f\u4e0d\u4f1a\u914d\u7f6e<code>knife</code>\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u8fd0\u884c\u3002<code>knife</code>\u662f\u548c<code>Chef</code>\u670d\u52a1\u5668\u4ea4\u4e92\u7684\u4e3b\u8981\u547d\u4ee4\u884c\u5de5\u5177\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\u6a21\u62df<code>knife</code>\u5c06\u5e26\u6765\u66f4\u591a\u4fbf\u5229</p>"},{"location":"chap1/chef_tutorial10_zero/#3chef-playground-chef-zero","title":"3\u3001\u7528<code>Chef-Playground</code> \u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u8fd0\u884c<code>Chef-Zero</code>","text":"<p>\u4e5f\u53ef\u4ee5\u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u8fd0\u884c<code>chef-zero</code>\u3002\u4f60\u53ef\u80fd\u60f3\u8fd9\u6837\u505a\u7684\u539f\u56e0\u5927\u6982\u4f1a\u662f\u8fd9\u6837\u53ef\u4ee5\u4f7f\u7528<code>knife</code>\u5de5\u5177\u3002 </p> <p>\u5f53\u4f60\u60f3\u548c<code>Chef</code>\u670d\u52a1\u5668\u4ea4\u4e92\u65f6\u5373\u4f7f\u4f7f\u7528<code>Test Kitchen</code>\u4e5f\u4f1a\u53d1\u73b0\u9700\u8981\u5728\u5bbf\u4e3b\u5f00\u53d1\u673a\u5668\u4e0a\u8fd0\u884c<code>knife</code>\u3002</p> <p>\u5373\u4f7f\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\u67d0\u4e9b, <code>Chef</code>\u670d\u52a1\u5668\u7684\u529f\u80fd\uff0c \u6bd4\u5982\u6570\u636e\u5305\u6216\u641c\u7d22\uff0c \u90fd\u80fd\u5f97\u76ca\u5e72\u4f7f\u7528<code>knife</code>\u5de5\u5177\u3002 </p> <p>\u6211\u4eec\u4f1a\u521b\u5efa\u4e00\u4e2a\u53eb<code>chef-playground</code>\u7684\u9879\u76ee\u76ee\u5f55\uff0c\u5176\u4f5c\u7528\u7c7b\u4f3c\u7ae0\u4e2d\u7684<code>chef_repo</code>\u4f46\u4f7f\u7528<code>chef-zero</code>\u3002\u6211\u4eec\u6267\u884c\u7684\u6b65\u9aa4\u4e0e\u524d\u9762\u7684\u7c7b\u4f3c\u3002 l</p> <ol> <li>\u5047\u8bbe<code>Chef</code>\u53ef\u6237\u7aef\u6216<code>Chef</code>\u5f00\u53d1\u5305\u5df2\u7ecf\u5b89\u88c5 </li> <li>\u521b\u5efa\u5047\u7684\u548c<code>validation.pem</code> and <code>client.pem</code>\u94a5\u5319\u3002 </li> <li>\u521b\u5efa<code>knife.rb</code>(<code>knife</code>\u914d\u7f6e\u6587\u4ef6\uff09\u3002 </li> <li>\u8fd0\u884c<code>chef-zero</code>\u3002 </li> <li>\u4e0e\u6a21\u62df<code>Chef</code>\u670d\u52a1\u5668<code>chef-zero</code>\u6765\u540c\u6b65\u83dc\u8c31 </li> <li>\u8fd0\u884c<code>knife</code></li> </ol> <pre><code>$ mkdir chef-playground\n$ cd chef-playground/\n$ mkdir .chef\n$  cd .chef/\n</code></pre> <p><code>ssh-keygen</code>\u751f\u6210\u5ba2\u6237\u94a5\u5319(-P \u9009\u9879\u63d0\u4f9b\u4e3a\u94a5\u5319\u6dfb\u52a0\u5bc6\u7801\u7684\u529f\u80fd\u5728\u6b64\u6211\u4eec\u4e0d\u9700\u8981\u5bc6\u7801\uff0c\u6240\u4ee5\u4f7f\u7528\u4e24\u4e2a\u53cc\u5f15\u53f7\u6765\u63d0\u4f9b\u4e00\u4e2a\u7a7a\u5bc6\u7801\u3002\uff09 </p> <pre><code>$ ssh-keygen -f devhost.pem -t rsa -P \"\"\n$ ssh-keygen -f validation.pem -P \"\"\n</code></pre> <pre><code>$ ls\ndevhost.pem             devhost.pem.pub         validation.pem          validation.pem.pub\n</code></pre> <p>\u5728<code>chef-playground/.chef</code>\u76ee\u5f55\u4e2d\u521b\u5efa\u540d\u4e3a<code>knife.rb</code>\u7684\u6587\u4ef6 </p> <p><code>chef-playground/.chef/knife.rb</code></p> <pre><code>chef_repo = File.join(File.dirname(__FILE__), \"..\")\n\nchef_server_url \"http://127.0.0.1:9501\"\nnode_name       \"devhost\"\nclient_key      File.join(File.dirname(__FILE__), \"devhost.pem\")\ncookbook_path   \"#{chef_repo}/cookbooks\"\ncache_type      \"BasicFile\"\ncache_options   :path =&gt; \"#{chef_repo}/checksums\"\n</code></pre> <p>\u6700\u540e\u6253\u5f00\u4e00\u4e2a\u65b0\u7684\u547d\u4ee4\u884c\u7a97\u53e3\u4e95\u8fd0\u884c<code>chef-zero</code></p> <p>\u50cf\u4ee5\u4e0b\u4ee3\u7801\u4e00\u6837\u8fd0\u884c<code>chef-zero</code>\u4f20\u9012\u4e00\u4e2a\u9ed8\u8ba4\u7aef\u53e3<code>8889</code>\u4ee5\u5916\u7684\u7aef\u53e3\uff0c \u4ee5\u907f\u514d\u548c\u5176\u4ed6\u672c\u5730\u6a21\u5f0f\u8fd0\u884c\u7684<code>Chef</code>\u5de5\u5177\u51b2\u7a81\u3002\u5982\u679c\u8fd9\u91cc\u5efa\u8bae\u7684<code>9501</code>\u7aef\u53e3\u4e5f\u6709\u51b2\u7a81\u53ef\u4ee5\u8bd5\u8bd5\u5176\u4ed6\u7aef\u53e3 </p> <pre><code>$ cd chef-playground\n$ chef-zero --port 9501\n&gt;&gt; Starting Chef Zero (v14.0.13)...\n&gt;&gt; WEBrick (v1.5.0) on Rack (v2.0.7) is listening at http://127.0.0.1:9501\n&gt;&gt; Press CTRL+C to stop\n\n</code></pre> <p>You can run chef-zero in \u201cdaemonized\u201d mode by passing in the --daemon parameter. Chef-zero will detach itself from the current command line process and run in the background.</p> <pre><code>$ tree -al ../chef-playground/\n../chef-playground/\n\u2514\u2500\u2500 .chef\n    \u251c\u2500\u2500 devhost.pem\n    \u251c\u2500\u2500 devhost.pem.pub\n    \u251c\u2500\u2500 knife.rb\n    \u251c\u2500\u2500 validation.pem\n    \u2514\u2500\u2500 validation.pem.pub\n\n1 directory, 5 files\n</code></pre> <p>knife\u5de5\u5177\u5c06\u4f1a\u9ed8\u8ba4\u5728<code>\uff04HOME/.chef</code>\u76ee\u5f55\u4e2d\u5bfb\u627e\u914d\u7f6e\u6587\u4ef6\u53ca\u94a5\u5319\u3002\u5982\u679c\u5728\u9ed8\u8ba4\u4f4d\u7f6e\u6ca1\u627e\u5230\uff0c\u5b83\u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u6811\u4e2d\u7684\u6bcf\u5c42\u7ed3\u6784\u5bfb\u627e<code>chef</code>\u76ee\u5f55\u3002\u5047\u8bbe\u4f60\u548c\u51e0\u4e2a\u4e0d\u540c\u9879\u76ee\u7684<code>chef</code>\u670d\u52a1\u5668\u7fa4\u96c6\u5de5\u4f5c\uff0c\u53ef\u4ee5\u5c06\u4e0d\u540c\u7684<code>.chef</code>\u76ee\u5f55\u653e\u5728\u5408\u9002\u7684\u9879\u76ee\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982<code>chef-playground/.chef</code> </p> <pre><code>$ knife client list\nERROR: Chef::Exceptions::InvalidPrivateKey: The file /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/.chef/devhost.pem \nor :raw_key option does not contain a correctly formatted private key or the key is encrypted.\n       The key file should begin with '-----BEGIN RSA PRIVATE KEY-----' and end with '-----END RSA PRIVATE KEY-----'\n</code></pre> <p>I have an OpenSSH format key and want a PEM format key.</p> <p>Changed from <code>BEGIN OPENSSH PRIVATE KEY</code> to <code>BEGIN RSA PRIVATE KEY</code></p> <pre><code>$  cd .chef/\n$ ssh-keygen -p -N \"\" -m pem -f devhost.pem\nKey has comment '@C02Z155JLVDR'\nYour identification has been saved with the new passphrase\n</code></pre> <pre><code>$ knife client list\nchef-validator\nchef-webui\n</code></pre> <p>\u8bf4\u660e\uff1a\u672c\u4e66\u4e2d\u6211\u4eec\u4e0d\u4f1a\u4f7f\u7528<code>knife --local-mode</code>,\u4f46\u9700\u8981\u63d0\u53ca\u7684\u662f\u548c<code>chef-client</code>\u4e00\u6837,<code>knife</code>\u5de5\u5177\u901a\u8fc7<code>--local-mode</code>\u9009\u9879\u652f\u6301\u672c\u5730\u6a21\u5f0f<code>chef\u4e00zero</code>\u3002 \u4f7f\u7528\u672c\u5730\u6a21\u5f0f\u7684\u4f18\u70b9\u662f<code>knife</code>\u4f1a\u81ea\u52a8\u4e3a\u4f60\u542f\u52a8<code>chef-zero</code></p> <p>\u56e0\u6b64\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u5728\u672c\u5730\u6a21\u5f0f\u8fd0\u884c<code>knife</code>\u6765\u67e5\u770b\u5ba2\u6237\u7aef\uff0c\u5b83\u5df2\u4f1a\u81ea\u52a8\u542f\u52a8<code>chef-zero</code>\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0d\u4f1a\u4e0e\u5df2\u7ecf\u5f00\u542f\u7684<code>chef-zero</code>\u5b9e\u4f8b\u51b2\u7a81\uff0c \u56e0\u4e3a\u4f60\u6ca1\u6709\u4f7f\u7528\u9ed8\u8ba4\u7aef\u53e3 <code>8889</code>\u3002 </p> <pre><code>$knife client list --local-mode \n</code></pre> <p>\u7136\u800c\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u5b83\u7684\u8f93\u51fa\u4e0e<code>knife</code>\u5728\u5ba2\u6237\u7aef\u6a21\u5f0f\u8fd0\u884c\u65f6\u6709\u6240\u4e0d\u540c.</p> <pre><code>$ mkdir nodes\n$ cd nodes\n</code></pre> <p>\u521b\u5efa\u4e09\u4e2a\u6587\u4ef6</p> <pre><code>$ touch atwood.json snowman.json susu.json\n</code></pre> <pre><code>$ tree -a .\n.\n\u251c\u2500\u2500 .chef\n\u2502   \u251c\u2500\u2500 devhost.pem\n\u2502   \u251c\u2500\u2500 devhost.pem.pub\n\u2502   \u251c\u2500\u2500 knife.rb\n\u2502   \u251c\u2500\u2500 validation.pem\n\u2502   \u2514\u2500\u2500 validation.pem.pub\n\u2514\u2500\u2500 nodes\n    \u251c\u2500\u2500 atwood.json\n    \u251c\u2500\u2500 snowman.json\n    \u2514\u2500\u2500 susu.json\n\n2 directories, 8 files\n</code></pre> <p><code>nodes/atwood.json</code></p> <pre><code>{\n  \"name\": \"atwood\",\n  \"chef_type\": \"node\",\n  \"json_class\": \"Chef::Node\",\n  \"chef_environment\": \"_default\",\n  \"run_list\": [\"recipe[apache]\", \"recipe[motd]\"],\n  \"automatic\": {\n    \"ipaddress\": \"192.168.33.31\",\n    \"hostname\": \"atwood\",\n    \"fqdn\": \"atwood.playground.local\",\n    \"os\": \"linux\",\n    \"os_version\": \"2.6.32-431.el6.x86_64\",\n    \"platform\": \"centos\",\n    \"platform_version\": \"6.5\",\n    \"platform_family\": \"rhel\",\n    \"recipes\": [\"apache\", \"motd\"]\n  }\n}\n</code></pre> <p><code>nodes/snowman.json</code></p> <pre><code>{\n  \"name\": \"snowman\",\n  \"chef_type\": \"node\",\n  \"json_class\": \"Chef::Node\",\n  \"chef_environment\": \"_default\",\n  \"run_list\": [\"recipe[apache]\", \"recipe[motd]\", \"recipe[motd-attributes]\"],\n  \"automatic\": {\n    \"ipaddress\": \"192.168.33.32\",\n    \"hostname\": \"snowman\",\n    \"fqdn\": \"snowman.playground.local\",\n    \"os\": \"linux\",\n    \"os_version\": \"3.13.0-24-generic\",\n    \"platform\": \"ubuntu\",\n    \"platform_version\": \"14.04\",\n    \"platform_family\": \"debian\",\n    \"recipes\": [\"apache\", \"motd\", \"motd-attributes\"]\n  }\n}\n</code></pre> <p><code>nodes/susu.json</code></p> <pre><code>{\n  \"name\": \"susu\",\n  \"chef_type\": \"node\",\n  \"json_class\": \"Chef::Node\",\n  \"chef_environment\": \"_default\",\n  \"run_list\": [\"recipe[apache]\", \"recipe[motd]\"],\n  \"automatic\": {\n    \"ipaddress\": \"192.168.33.33\",\n    \"hostname\": \"susu\",\n    \"fqdn\": \"susu.playground.local\",\n    \"os\": \"linux\",\n    \"os_version\": \"2.6.32-431.el6.x86_64\",\n    \"platform\": \"centos\",\n    \"platform_version\": \"6.5\",\n    \"platform_family\": \"rhel\",\n    \"recipes\": [\"apache\", \"motd\"]\n  }\n}\n</code></pre> <p>\u4e00\u65e6\u5728<code>nodes/</code>\u76ee\u5f55\u521b\u5efa\u8fd9\u4e9b\u6587\u4ef6. \u786e\u4fdd\u56de\u5230<code>chef-playground</code>\u4f5c\u4e3a\u5f53\u524d\u76ee\u5f55\u3002\u7136\u540e\u8fd0\u884c<code>knife upload</code>\u547d\u4ee4\u6765\u5728\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u8fd9\u4e9b\u8282\u70b9\u3002\u5728</p> <p>\u540e\u9762\u7684\u7ae0\u8282\u4e2d\u6211\u4eec\u5c06\u7ecf\u5e38\u5728\u8fd0\u884c\u5176\u4ed6<code>knife</code>\u547d\u4ee4\u524d\u4f7f\u7528<code>knife upload</code>\u6765\u4e0a\u4f20\u8282\u70b9\u4fe1\u606f\u5230\u670d\u52a1\u5668\uff1a </p> <pre><code>$ knife upload nodes\nCreated nodes/snowman.json\nCreated nodes/susu.json\nCreated nodes/atwood.json\n</code></pre>"},{"location":"chap1/chef_tutorial10_zero/#4","title":"4\u3001\u641c\u7d22","text":"<p><code>Chef</code>\u7684\u641c\u7d22\u529f\u80fd\u63d0\u4f9b\u4ee3\u8be2\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e0a\u7d22\u5f15\u7684\u6570\u636e\u7684\u80fd\u529b\u3002<code>Chef</code>\u670d\u52a1\u5668\u6267\u884c\u6307\u5b9a\u7684\u641c \u7d22\u5148\u8be2\u4e95\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u53ef\u4ee5\u5728\u547d\u4ee4\u884c\u4f7f\u7528<code>knife</code>\u547d\u4ee4\u6216\u5728\u914d\u65b9\u5355\u4e2d\u7528\u4ee3\u7801\u6267\u884c\u641c\u7d22\u67e5\u8be2\u3002\u6bd4\u5982\u53ef\u4ee5\u5149\u8be2\u8fd0\u884c\u67d0\u4e2a\u7279\u5b9a\u63f4\u4f5c\u7cfb\u7edf\u6216\u8f6f\u4ef6\u7684\u6240\u6709\u7cfb\u7edf\u7684\u540d\u5b87\u548c\u6025\u6570 </p> <p>\u4ece\u547d\u4ee4\u884c\u641c\u7d22\u8ba9\u6211\u4eec\u4ece\u5728\u547d\u4ee4\u884c\u4f7f\u7528<code>knife</code>\u547d\u4ee4\u6267\u884c\u641c\u7d20\u4ee3\u8be2\u5f00\u59cb\uff0c \u8ba9\u6211\u4eec\u4e2d\u521b\u5efa\u7684<code>chef-playground/</code>\u76ee\u5f55\uff0c \u4ee5\u53ca\u4e00\u6837\u7684\u53cc\u547d\u4ee4\u884c\u6a21\u5f0f\uff0c \u5728\u5176\u4e2d\u4e2d\u4e00\u4e2a\u547d\u4ee4\u884c\u4e2d\u7528\u4e00\u4e2a\u5f00\u653e\u7684\u7aef\u53e3\u542f\u52a8<code>chef-zero</code>\u670d\u52a1\u5668\u3002</p> <pre><code>$ chef-zero --port 9501\n&gt;&gt; Starting Chef Zero (v14.0.13)...\n&gt;&gt; WEBrick (v1.5.0) on Rack (v2.0.7) is listening at http://127.0.0.1:9501\n&gt;&gt; Press CTRL+C to stop\n</code></pre> <pre><code>$  knife upload nodes\nCreated nodes/snowman.json\nCreated nodes/susu.json\nCreated nodes/atwood.json\n</code></pre>"},{"location":"chap1/chef_tutorial10_zero/#5knife","title":"5\u3001\u7528<code>Knife</code>\u4ece\u547d\u4ee4\u884c\u641c\u7d22","text":"<p>\u4e5f\u53ef\u4ee5\u5728\u751f\u4ea7\u73af\u5883\u4e2d<code>knife search</code>\u547d\u4ee4\u6267\u884c\u641c\u7d22\u3002<code>knife</code>\u7684\u6773\u8be2\u8bed\u6cd5\u5982\u4e0b </p> <pre><code>$ knife search &lt;index&gt; &lt;search_query&gt;\n</code></pre> <p>\u7d22\u5f15\u53ef\u4ee5\u662f\u4ee5\u4e0b\u4efb\u610f\u4e00\u9879</p> <ul> <li><code>node</code>(\u8282\u70b9\uff09 </li> <li><code>client</code>\uff08\u5ba2\u6237\u7aef\uff09 </li> <li><code>environment</code>\uff08\u73af\u5883\uff09 </li> <li><code>role</code>\uff08\u89d2\u8272\uff09 </li> <li>&lt;\u6548\u636e\u5305\u7684\u540d\u5b57\uff1e </li> </ul> <p></p> <p>Chef\u4f7f\u7528<code>Apache solr</code>\u6765\u8fdb\u884c\u641c\u7d22\u548c\u7d22\u5f15\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c06\u6267\u884c\u4e2a\u5bf9\u6240\u6709\u8282\u70b9\u7684\u641c\u7d22\u67e5\u8be2\u4e95\u5229\u7528<code>solar</code>\u641c\u67d4\u67e5\u8be2<code>\u201c*:*.\u201d</code>\u8fd4\u56de\u7ed3\u679c\u3002 </p> <p>\u53ef\u4ee5\u770b\u5230\u521a\u521a\u901a\u8fc7<code>knife upload</code>\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u7684\u8282\u70b9\u6570\u636e\u3002\u7ed3\u679c\u663e\u793a<code>Chef</code>\u6b63\u5728\u7ba1\u7406\u4e09\u4e2a\u8282\u70b9\uff0e </p> <pre><code>$ knife search node \"*:*\"\n3 items found\n\nNode Name:   atwood\nEnvironment: _default\nFQDN:        atwood.playground.local\nIP:          192.168.33.31\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    recipe[apache], recipe[motd], recipe[motd-attributes]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:        \n\nNode Name:   susu\nEnvironment: _default\nFQDN:        susu.playground.local\nIP:          192.168.33.33\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:  \n</code></pre> <p>Chef search queries use the Solr <code>\u201c&lt;attribute&gt;:&lt;search_pattern&gt;\u201d</code> form:</p> <pre><code>$ knife search node \"ipaddress:192.168.33.32\"\n\n1 items found\n\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    recipe[apache], recipe[motd], recipe[motd-attributes]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:  \n</code></pre> <p>Use an asterisk (<code>\u201c*\u201d</code>) within a search query to perform a wildcard search matching 0 or more characters:</p> <pre><code>knife search node \"ipaddress:192.*\"\nknife search node \"platfo*:centos\"\n</code></pre> <p>Use a question mark (<code>\u201c?\u201d</code>) to match any single character:</p> <pre><code>knife search node \"platform_version:14.0?\"\n\n</code></pre> <p>You can add specific key-value pairs in the query part of the knife search command line.</p> <pre><code>$ knife search node \"hostname:snowman\"\n1 items found\n\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    recipe[apache], recipe[motd], recipe[motd-attributes]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:        \n</code></pre> <p>\u8bf4\u660e\u53ef\u4ee5\u901a\u8fc7\u4f7f<code>--long</code>\u9009\u9879\u8fd0\u884c<code>knife \uff1c\u7d22\u5f15&gt; show</code>\u547d\u4ee4\u5f97\u5230\u4e00\u4e2a\u53ef\u4ee5\u5728\u641c\u7d22\u4e2d\u4f7f\u7528\u7684\u5c5e\u6027\u540d\u5b57\u7684\u5217\u8868\u3002\u5b83\u4f1a\u663e\u793a\u6240\u6709\u4f60\u6307\u5b9a\u7684\u7d22\u5f15\u4e2d\u7684\u53ef\u7528\u7684\u5c5e\u6027\u3002\u6bd4\u5982\u8bf4\uff0c\u6211\u4eec\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4 </p> <pre><code>$ knife node show  snowman --long\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    recipe[apache], recipe[motd], recipe[motd-attributes]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:        \nAttributes:\ntags:\n\nDefault Attributes:\n\nOverride Attributes:\n\nAutomatic Attributes (Ohai Data):\nfqdn:             snowman.playground.local\nhostname:         snowman\nipaddress:        192.168.33.32\nos:               linux\nos_version:       3.13.0-24-generic\nplatform:         ubuntu\nplatform_family:  debian\nplatform_version: 14.04\nrecipes:\n  apache\n  motd\n  motd-attributes\n</code></pre> <p>\u641c\u7d22\u67e5\u8be2\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u7c7b\u4f3c<code>OR</code>\u7684\u5e03\u5c14\u5173\u952e\u5b57\u6307\u5b9a\u591a\u4e2a\u952e\u503c\u5bf9\u513f\u3002\u6bd4\u5982\u4ee5\u4e0b\u67e5\u8be2\u8fd4\u662f<code>alice</code>\u6216<code>bob</code>\u7684\u8282\u70b9\uff1a </p> <pre><code> knife search node \"name:susu OR name:atwood\"\n2 items found\n\nNode Name:   atwood\nEnvironment: _default\nFQDN:        atwood.playground.local\nIP:          192.168.33.31\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n\nNode Name:   susu\nEnvironment: _default\nFQDN:        susu.playground.local\nIP:          192.168.33.33\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n</code></pre> <p>\u540c\u7406\u5982\u679c\u60f3\u8fd4\u56de\u6240\u6709\u7684\u6761\u4ef6\u7684\u603b\u548c\u67e5\u8be2\u4e2d\u4e5f\u53ef\u4ee5\u4f7f\u7528\u903b\u8f91<code>AND</code>\u6765\u66ff\u4ee3\u903b\u8f91<code>OR</code> </p> <pre><code>$ knife search node \"ipaddress:192* AND platform:ubuntu\"\n1 items found\n\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    recipe[apache], recipe[motd], recipe[motd-attributes]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:       \n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>-a</code>\u53c2\u6570\u6765\u8fc7\u6ee4\u641c\u7d22\u7ed3\u679c\u3002\u6bd4\u5982\u4f7f\u7528<code>-a ipaddress</code>\u9009\u9879\u5c06\u53ea\u8fd4\u56de<code>ipaddress</code>\u5c5e\u6027\uff1b </p> <pre><code>$ knife search node \"*:*\" -a ipaddress\n3 items found\n\natwood:\n  ipaddress: 192.168.33.31\n\nsnowman:\n  ipaddress: 192.168.33.32\n\nsusu:\n  ipaddress: 192.168.33.33\n</code></pre>"},{"location":"chap1/chef_tutorial10_zero/#6test-kitchen","title":"6\u3001\u4f7f\u7528Test Kitchen\u4ece\u914d\u65b9\u5355\u4e2d\u641c\u7d22","text":"<p>\u5728<code>Chef</code>\u4ee3\u7801\u91cc\u9762\uff0c\u4e5f\u53ef\u4ee5\u6267\u884c\u641c\u7d22\u67e5\u8be2\u672c\u8282\u6211\u4eec\u4f1a\u7528<code>Test Kitchen</code>\u5199\u4e00\u4e2a\u83dc\u8c31\u5e76\u7528<code>chef_zero</code>\u6267\u884c\u641c\u7d22\u3002</p> <pre><code>$ mkdir cookbooks\n$ cd cookbooks\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook nodes\n$ cd nodes\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create nodes --cookbook-path .\n$ cd nodes\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <pre><code>$ chef generate cookbook nodes\nGenerating cookbook nodes\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd nodes` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <ul> <li><code>cookbooks/nodes/kitchen.yml</code></li> </ul> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  nodes_path: ../../nodes\n  always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[nodes::default]\n    attributes:\n</code></pre> <p>\u8ba9\u6211\u4eec\u6765\u5199\u4e00\u4e2a\u6267\u884c\u50cf\u4e0a\u4e00\u8282\u4e00\u6837\u7684\u641c\u7d22\u67e5\u8be2\u7684\u914d\u65b9\u5355\u3002<code>Chef</code>\u63d0\u4f9b\u4e86\u4e00\u4e2a\u53ef\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528\u7684<code>search(\uff09</code>\u65b9\u6cd5\u3002</p> <p>\u5b83\u63a5\u53d7\u4e24\u4e2a\u53c2\u6570\u548c\u5728\u547d\u4ee4\u884c\u4e2d\u4f7f\u7528<code>knife search</code>\u7c7b\u4f3c</p> <p>search(\u7d22\u5f15\u641c\u7d22\u67e5\u8be2\uff09: </p> <ul> <li>\u7d22\u5f15 </li> </ul> <p>\u652f\u6301\u7684\u7d22\u5f15\u6709\uff1a<code>node</code>, <code>client</code>, <code>environment</code>, <code>role</code>\u548c<code>\uff1c\u6570\u636e\u5305\u7684\u540d\u5b57\uff1e</code></p> <ul> <li>\u641c\u7d22\u67e5\u8be2</li> </ul> <p>\u641c\u7d22\u67e5\u8be2<code>Apache Solr</code>\u5f0f\u7684 </p> <p><code>/nodes/recipes/default.rb</code></p> <pre><code>#\n# Cookbook Name:: users\n# Recipe:: default\n#\n# Copyright (C) 2014\n#\n#\n#\n\n# Print every node name matching the search pattern\nsearch(\"node\", \"*:*\").each do |matching_node|\n  log matching_node.to_s\nend\n</code></pre> <p>The <code>.each</code> statement in <code>recipes/default.rb</code> is a looping construct specific to Ruby.</p> <pre><code>counter = 0\nwhile counter &lt; 5\n  puts counter\n  counter = counter + 1\nend\n</code></pre> <p>\u867d\u7136\u4ee5\u4e0a\u4ee3\u7801\u662f\u5b8c\u5168\u6709\u6548\u7684<code>Ruby</code>\u4ee3\u7801\uff0c\u5728Ruby\u4e2d\u66f4\u901a\u4fd7\u7684\u5199\u6cd5\u662f\u4f7f\u7528\uff0eeach\u8fed\u4ee3\u5668\u4ece\u4e00 \u4e2a\u6570\u7ec4\u4e2d\u904d\u5386\u5e76\u8fd4\u56de\u6240\u6709\u7684\u5143\u7d20\u3002</p> <p><code>do..end</code>\u4ee3\u7801\u5757\u6bd4\u6211\u4eec\u5230\u73b0\u5728\u4e3a\u6b62\u6240\u8bb2\u8ff0\u8fc7\u7684\u66f4\u590d\u6742\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u5b9a\u4e49\u4e00\u4e2a\u6ca1\u6709\u540d\u5b57\u7684\u65b9\u6cd5\u3002\u540c\u65f6\uff0c\u4f60\u53ef\u4ee5\u7ed9\u8fd9\u4e2a\u6ca1\u6709\u540d\u5b57\u7684\u65b9\u6cd5\u901a\u8fc7\u4e24\u4e2a\u7ad6\u7ebf\u7b26\u53f7\uff08<code>II</code>)\u4f20\u9012\u4e00\u4e2a\u6216\u66f4\u591a\u53c2\u6570\uff0c\u5c31\u50cf\u4ee5\u4e0b\u4f8b\u5b50\u4e2d\u7684<code>|counter|</code>. </p> <p>\u5728\u4ee5\u4e0b\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4f20\u9012\u4e00\u4e2a\u4ee3\u7801\u5757\u7ed9<code>(0..5).each</code>\u3002\u5f53\u4f60\u7ed9\u4e00\u4e2a\u8fed\u4ee3\u5668\u4f20\u9012\u4e00\u4e2a\u4ee3\u7801\u5757\u5bf9\u5b83\u5c06\u4e3a\u6bcf\u4e00\u4e2a\u5143\u7d20\u6267\u884c\u6307\u5b9a\u7684\u65b9\u6cd5\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d<code>\uff080..5)</code>\u8303\u56f4\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u90fd\u4f1a\u88ab\u4ee5<code>|counter|</code>\u53d8\u91cf\u4f20\u9012\u5230\u6211\u4eec\u7684\u4ee3\u7801\u5757\u3002</p> <p>\u4ee3\u7801\u5757\u4e2d\u7684\u4ee3\u7801\u4f7f\u7528\u8fd9\u4e2a\u53d8\u91cf\u6765\u6253\u5370\u6bcf\u4e2a\u503c\uff1a </p> <pre><code>(0..5).each do |counter|\n  puts counter\nend\n</code></pre> <p>\u6211\u4eec\u505a\u4e86\u7c7b\u4f3c\u7684\u4e8b\u60c5, \u904d\u5386\u6bcf\u4e2a<code>search()</code>\u8fd4\u56de\u7684\u7ed3\u679c, \u5c06\u6bcf\u4e2a\u7ed3\u679c\u7684\u5185\u5bb9\u5728\u540e\u9762\u7684\u4ee3\u7801\u5757\u4ee5<code>matching_node</code>\u53d8\u5168\u4ee3\u8868\u3002<code>matching_node</code>\u662f\u4e00\u4e2a\u5305\u542b\u8282\u70b9\u5c5e\u6027\u952e\u503c\u5bf9\u513f\u7684\u54c8\u5e0c\u3002</p> <p>\u4ee3\u7801\u5757\u4e2d\u7684\u4ee3\u7801\u8bfb\u53d6<code>matching_node\u7684</code>\u5185\u5bb9\u5e76\u4f7f\u7528<code>to_s</code>\u65b9\u6cd5\u901a\u8fc7\u4f7f\u7528<code>log</code>\u6253\u5370<code>matchimg_node</code>\u5bf9\u8c61\u7684\u5b57\u7b26\u4e32\u8868\u8fbe\u5f62\u5f0f\u3002\u5728\u672c\u4f8b\u4e2d<code>matching_node</code>\u7684\u5b87\u7b26\u4e32\u8868\u8fbe\u5f62\u5f0f\u5c31\u662f\u8282\u70b9\u7684\u540d </p> <pre><code>$ kitchen converge\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Fixed port collision for 22 =&gt; 2222. Now on port 2201.\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2201\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2201\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m46.40s).\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[nodes::default]\"]\n       Policy lock file doesn't exist, running `chef install` for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/nodes/Policyfile.rb...\n       Building policy nodes\n       Expanded run list: recipe[nodes::default]\n       Caching Cookbooks...\n       Installing nodes &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/nodes/Policyfile.lock.json\n       Policy revision id: c2340b0ef105fd212326f7001a4309c5bcb2d73d39e6cec5e6d23fee42fa0d68\n       Updating policy lock using `chef update`\n       Attributes already up to date\n       Building policy nodes\n       Expanded run list: recipe[nodes::default]\n       Caching Cookbooks...\n       Installing nodes &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/nodes/Policyfile.lock.json\n       Policy revision id: c2340b0ef105fd212326f7001a4309c5bcb2d73d39e6cec5e6d23fee42fa0d68\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191205-75016-n73yz4...\n       Exported policy 'nodes' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191205-75016-n73yz4\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191205-75016-n73yz4\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing nodes\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       el 6 x86_64\n       Getting information for chef stable  for el...\n       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64\n         to file /tmp/install.sh.3170/metadata.txt\n       trying wget...\n       trying curl...\n       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2\n       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473\n       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n       version  15.5.17\n       downloaded metadata file looks valid...\n       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n         to file /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm\n       trying wget...\n       trying curl...\n       Comparing checksum with sha256sum...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       Using policy 'nodes' at revision 'c2340b0ef105fd212326f7001a4309c5bcb2d73d39e6cec5e6d23fee42fa0d68'\n       resolving cookbooks for run list: [\"nodes::default@0.1.0 (f791f0b)\"]\n       Synchronizing Cookbooks:\n         - nodes (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 4 resources\n       Recipe: nodes::default\n         * log[node[atwood]] action write\n\n         * log[node[default-centos65]] action write\n\n         * log[node[snowman]] action write\n\n         * log[node[susu]] action write\n\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 4/4 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m33.65s).\n-----&gt; Kitchen is finished. (1m20.65s)\n</code></pre>"},{"location":"chap1/chef_tutorial10_zero/#7","title":"7\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>Test Kitchen and Chef Zero</li> <li>\u7528<code>Chef-Playground</code> \u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u8fd0\u884cChef-Zero</li> </ul> <pre><code>$ chef-client --local-mode  --chef-zero-port 8889\n$ chef-zero --port 9501\n$ knife client list\n$ knife client list --local-mode \n$ knife upload nodes\n\n\n$ knife search &lt;index&gt; &lt;search_query&gt;\n$ knife search node \"*:*\"\n$ knife search node \"ipaddress:192.168.33.32\"\n$ knife search node \"ipaddress:192.*\"\n$ knife search node \"platfo*:centos\"\n$ knife search node \"platform_version:14.0?\"\n$ knife node show  snowman --long\n$ knife search node \"name:susu OR name:atwood\"\n$ knife search node \"ipaddress:192* AND platform:ubuntu\"\n$ knife search node \"*:*\" -a ipaddress\n</code></pre>"},{"location":"chap1/chef_tutorial11_databag/","title":"\u7b2c\u5341\u4e00\u8282  \u6570\u6982\u5305Databag","text":"<ul> <li>\u4f7f\u7528Knife\u5728\u547d\u4ee4\u884c\u8fdb\u884c\u6570\u636e\u5305\u7684\u57fa\u672c\u64cd\u4f5c</li> <li>\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\u521b\u5efa\u672c\u5730\u7528\u6237</li> <li>\u52a0\u5bc6\u6570\u636e\u5305 </li> <li>Chef-valut</li> </ul> <p><code>Chef</code>\u670d\u52a1\u5668\u652f\u6301\u5b58\u50a8\u5168\u5c40\u7684\u3001\u53ef\u4ee5\u5728\u4e0d\u540c\u70b9\u4e0a\u8282\u70b9\u4e0a\u4f7f\u7528\u7684\u6570\u636e\u5b58\u50a8\u3002\u8fd9\u4e2a\u529f\u80fd\u79f0\u4f5c\u6570\u636e\u5305\uff08<code>data bag</code>)\u3002 </p> <p>\u5728<code>Chef</code>\u7684\u6982\u5ff5\u4e2d\uff0c\u6570\u636e\u5305\u662f\u5305\u542b\u4ee3\u8868\u4f60\u7684\u57fa\u7840\u67b6\u6784\u800c\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e00\u4e2a\u8282\u70b9\u7684\u4fe1\u606f\u7684\u5bb9\u5668\u3002\u6570\u636e\u5305\u5305\u542b\u9700\u8981\u5728\u591a\u4e2a\u8282\u70b9\u5171\u4eab\u7684\u4fe1\u606f</p> <ul> <li>\u901a\u7528\u7684\u5bc6\u7801 </li> <li>\u8f6f\u4ef6\u5b89\u88c5\u7684\u8bb8\u53ef\u8bc1\u94a5\u5319 </li> <li>\u901a\u7528\u7684\u7528\u6237\u6216\u7ec4\u7684\u5217\u8868</li> </ul> <p>\u9664\u4e86\u6570\u636e\u5305\u5916,<code>Chef</code>\u8282\u70b9\u4e4b\u95f4\u65e0\u6cd5\u5171\u4eab\u6570\u636e\u3002</p> <p> </p> <p>\u867d\u7136<code>chef-client</code>\u4f1a\u5728\u6210\u529f\u8fd0\u884c\u540e\u53d1\u9001\u8282\u70b9\u7684\u5c5e\u6027\u4fe1\u606f\u5230<code>Chef</code>\u670d\u52a1\u5668\uff0c\u4f46\u662f\u5982\u56fe\u6240\u793a\uff0c\u67d0\u4e00\u8282\u70b9\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u5176\u4ed6\u8282\u70b9\u7684\u4fe1\u606f\u3002 </p> <p> </p>"},{"location":"chap1/chef_tutorial11_databag/#chef","title":"\u6570\u636e\u5305\u662f\u552f\u4e00\u7684Chef\u5185\u5efa\u7684\u7528\u6765\u5b58\u50a8\u548c\u8bbf\u95ee\u8282\u70b9\u95f4\u901a\u7528\u7684\u6570\u636e\u7684\u673a\u5236","text":"<p>\u5c55\u793a\u4e86\u6570\u636e\u5305\u7684\u6837\u5b50\u3002</p> <ul> <li>\u6bcf\u4e2a\u6570\u636e\u5305\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u9879\u76ee\u3002</li> <li>\u6bcf\u4e2a\u9879\u76ee\u90fd\u662f\u4e00\u4e2a\u4ee5<code>JSON</code>\u683c\u5f0f\u8868\u793a\u7684\u952e\u503c\u5bf9\u513f\u96c6\u5408\u3002</li> <li>\u6839\u636e\u7ea6\u5b9a\uff0c\u4e00\u4e2a\u6570\u636e\u5305\u4e2d\u7684\u6bcf\u4e2a\u9879\u76ee\u5e94\u8be5\u5171\u4eab\u4e00\u6837\u7684\u952e\uff1b\u7136\u800c\u4e0d\u540c\u6570\u636e\u5305\u4e2d\u7684\u9879\u76ee\u7684\u952e\u53ef\u4ee5\u5b8c\u5168\u4e0d\u4e00\u6837\u3002</li> </ul> <p>\u5f53\u7136\u8fd9\u53ea\u662f\u7ea6\u5b9a\uff0c\u6280\u672f\u4e0a\uff0c\u53ef\u4ee5\u5728\u4efb\u4f55\u6570\u636e\u5305\u9879\u76ee\u4e2d\u5b58\u50a8\u4efb\u4f55\u7684\u952e\u548c\u503c\u3002\u6839\u636e<code>JSON</code>\u683c\u5f0f\uff0c\u5b57\u7b26\u4e32\u9700\u8981\u88ab\u53cc\u5f15\u53f7\u5f15\u7528\uff0c\u800c\u6574\u6570\u503c\u5219\u4e0d\u9700\u8981\u3002\u503c\u4e5f\u53ef\u4ee5\u4e3a\u5b57\u7b26\u4e32\u6216\u6574\u6570\u7684\u5217\u8868\u3002</p> <p> </p>"},{"location":"chap1/chef_tutorial11_databag/#1knife","title":"1\u3001\u4f7f\u7528Knife\u5728\u547d\u4ee4\u884c\u8fdb\u884c\u6570\u636e\u5305\u7684\u57fa\u672c\u64cd\u4f5c","text":"<p>\u8ba9\u6211\u4eec\u4ee5\u7528<code>knife</code>\u547d\u4ee4\u5728\u547d\u4ee4\u884c\u6267\u884c\u4e00\u4e2a\u641c\u7d22\u67e5\u8be2\u5f00\u59cb, \u5047\u8bbe\u60f3\u786e\u4fdd\u6211\u4eec\u7684\u5458\u5de5<code>alice</code>\u548c<code>bob</code>\u5728\u6240\u6709\u8282\u70b9\u4e0a\u90fd\u6709\u4ed6\u4eec\u7684\u7528\u6237\u8d26\u6237\uff0c \u5219\u53ef\u4ee5\u7528\u6570\u636e\u5305\u6765\u5b58\u9519\u8fd9\u4e9b\u8fd9\u6837\u4e00\u6765\uff0c \u89e3\u51b3\u65b9\u6848  \u853d\u4ee5\u5c06\u65b0\u5458\u5de5\u6dfb\u52a0\u5230\u8fd9\u4e2a\u5217\u8868\u4e2d\u4e95\u81ea\u5269\u89e6\u4eec\u7684\u8d26\u6237\u3002 \u6570\u636e\u5305\u662f\u6700\u597d\u7684\u56e0\u4e3a\u6211\u4eec\u60f3\u8ba9\u7528\u6237\u5217\u8868\u5728\u6240\u6709\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u8bbf\u95ee\u3002</p> <p>Use the same dual command prompt setup you used there. Start the chef-zero server on an open port in one window. We will be using port <code>9501</code> in the examples in this chapter:</p> <pre><code>$ cd chap10/chef-playground\n$ chef-zero --port 9501\n</code></pre> <pre><code>$ cd chef-playground\n</code></pre> <p>\u5728<code>chef-playground</code>\u76ee\u5f55\u4e2d\u521b\u5efa<code>data-bags</code>\u5b50\u76ee\u5f55\u3002\u540c\u65f6\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5305\u4e95\u547d\u540d\u4e3a <code>users</code>\u3002\u53ef\u4ee5\u901a\u8fc7\u5728<code>data_bags</code>\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684<code>users</code>\u76ee\u5f55\u6765\u5b8c\u6210\u3002 </p> <pre><code>$ mkdir -p data_bags/users\n</code></pre> <p><code>chef-playground/data_bags/users/alice.json</code></p> <pre><code>{\n  \"id\": \"alice\",\n  \"comment\": \"Alice Jones\",\n  \"uid\": 2000,\n  \"gid\": 0,\n  \"home\": \"/home/alice\",\n  \"shell\": \"/bin/bash\"\n}\n</code></pre> <p><code>chef-playground/data_bags/users/bob.json</code></p> <pre><code>{\n  \"id\": \"bob\",\n  \"comment\": \"Bob Smith\",\n  \"uid\": 2001,\n  \"gid\": 0,\n  \"home\": \"/home/bob\",\n  \"shell\": \"/bin/bash\"\n}\n</code></pre> <p>\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u540d\u4e3a<code>users</code>\u7684\u6570\u636e\u5305\uff0c\u8fd0\u884c<code>knife data create</code>\u547d\u4ee4 </p> <pre><code>$ knife data_bag create users\nCreated data_bag[users]\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u5305\u9879\u76ee\uff0c\u8fd0\u884c<code>knife data_bag from file</code>\u547d\u4ee4\u3002</p> <p><code>knife data_bag from file</code>\u547d\u4ee4\u5047\u8bbe\u8868\u793a\u6570\u636e\u5305\u9879\u76ee\u7684<code>.json</code>\u6587\u4ef6\u5728<code>data_bag</code>\uff0c\u76ee\u5f55\u4e0b\u7684\u4ee5\u6570\u636e\u5305\u540d\u5b57\u547d\u540d\u7684\u5b50\u76ee\u5f55\u4e2d\uff1a </p> <pre><code>$ knife data_bag from file users alice.json\nUpdated data_bag_item[users::alice]\n\n$ knife data_bag from file users bob.json\nUpdated data_bag_item[users::bob]\n</code></pre> <p>\u8981\u641c\u7d22\u670d\u52a1\u5668\u4e0a\u7684\u6570\u636e\u5305\uff0c\u4ee5\u6570\u636e\u5305\u540d\u5b57\u4f5c\u4e3a<code>index</code>\u53c2\u6570\u4f7f\u7528<code>knife search</code>\u3002\u5728\u672c\u4f8b\u4e2d\uff0c \u6211\u4eec\u7684\u6570\u636e\u5305\u540d\u4e3a<code>users</code>\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c06\u641c\u7d22\u6211\u4eec\u5728<code>users</code>\u6570\u636e\u5305\u4e2d\u521b\u5efa\u7684\u6240\u6709\u6570\u636e\u5305\u9879\u76ee\uff1a </p> <pre><code>$ knife search users \"*:*\"\n2 items found\n\nchef_type: data_bag_item\ncomment:   Alice Jones\ndata_bag:  users\ngid:       0\nhome:      /home/alice\nid:        alice\nshell:     /bin/bash\nuid:       2000\n\nchef_type: data_bag_item\ncomment:   Bob Smith\ndata_bag:  users\ngid:       0\nhome:      /home/bob\nid:        bob\nshell:     /bin/bash\nuid:       2001\n</code></pre> <p>\u53ef\u4ee5\u5728\u641c\u7d22\u67e5\u8be2\u4e2d\u6307\u5b9a\u7279\u5b9a\u7684\u952e\u503c\u5bf9\u513f\u3002\u4ee5\u4e0b\u67e5\u8be2\u5c06\u8fd4\u56de<code>users</code>\u6570\u636e\u5305\u4e2d\u62e5\u6709<code>Id == alice</code> \u6570\u636e\u7684\u6570\u636e\u5305\u9879\u76ee\uff1a </p> <pre><code>\u2248\n1 items found\n\nchef_type: data_bag_item\ncomment:   Alice Jones\ndata_bag:  users\ngid:       0\nhome:      /home/alice\nid:        alice\nshell:     /bin/bash\nuid:       2000\n</code></pre> <p>\u67e5\u8be2\u7684\u5185\u5bb9\u662f\u6570\u636e\u5305\u9879\u76ee\u4e2d\u7684\u5185\u5bb9\u800c\u4e0d\u662f\u8282\u70b9\u7684\u5c5e\u6027\u3002</p> <p>\u6bd4\u5982\uff0c\u4ee5\u4e0b\u67e5\u8be2\u5c06\u8fd4\u56de\u5728<code>users</code>\u6570\u636e \u5305\u4e2d<code>id</code>\u7684\u503c\u662f<code>alice</code>\u6216<code>bob\u7684</code>\u6570\u636e\u5305\u9879\u76ee\uff1a </p> <pre><code>$ knife search users \"id:alice OR id:bob\" \n2 items found\n\nchef_type: data_bag_item\ncomment:   Alice Jones\ndata_bag:  users\ngid:       0\nhome:      /home/alice\nid:        alice\nshell:     /bin/bash\nuid:       2000\n\nchef_type: data_bag_item\ncomment:   Bob Smith\ndata_bag:  users\ngid:       0\nhome:      /home/bob\nid:        bob\nshell:     /bin/bash\nuid:       2001\n</code></pre> <p>\u641c\u7d22\u7ed3\u679c\u53ef\u4ee5\u7531<code>-a</code>\u53c2\u6570\u8fc7\u6ee4\u3002\u6bd4\u5982<code>-a shell</code>\u53ea\u8fd4\u56de\u7ed3\u679c\u4e2d<code>shell</code>\u7684\u503c\uff1a  </p> <pre><code>$ knife search users \"*:*\" -a shell\n2 items found\n\n:\n  shell: /bin/bash\n\n:\n  shell: /bin/bash\n</code></pre>"},{"location":"chap1/chef_tutorial11_databag/#2","title":"2\u3001\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\u521b\u5efa\u672c\u5730\u7528\u6237","text":"<p>\u5230\u73b0\u5728\u4e3a\u6b62\uff0c\u6211\u4eec\u521b\u5efa\u51e0\u4e2a\u6570\u636e\u5305\u9879\u76ee, \u5e76\u7528\u6211\u4eec\u6765\u8868\u793a\u7528\u6237\u8d26\u6237\uff0c\u4f46\u6211\u4eec\u5c1a\u672b\u5b9e\u9645\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\u521b\u5efa\u672c\u5730\u7528\u6237\u6765\u521b\u5efa\u8fd9\u4e9b\u7528\u6237\u8d26\u6237\u3002 \u8ba9\u6211\u4eec\u7528<code>chef</code>\u83dc\u8c31\u6839\u636e\u8fd9\u4e9b\u6570\u636e\u6765\u521b\u5efa\u8fd9\u4e9b\u8d26\u6237</p> <pre><code>$ cd /chef-playground/cookbooks\n\n</code></pre> <p>\u7136\u540e\u5728<code>chef_playground/cookbooks</code>\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a<code>users</code>\u83dc\u8c31\u3002</p> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook users\n$ cd users\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create users --cookbook-path .\n$ cd users\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <pre><code>$ chef generate cookbook users\nGenerating cookbook users\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd users` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u5728<code>provisioner:</code>\u4e2d\u6dfb\u52a0<code>data_bags_path</code>\u6765\u6307\u5b9a\u6570\u636e\u5305\u7684\u4f4d\u7f6e\u3002 </p> <pre><code>provisioner:\n  name: chef_zero\n  data_bags_path: ../../data_bags\n</code></pre> <p><code>data_bags_path</code>\u662f\u4e00\u4e2a\u6307\u5411<code>chef_playground/databags</code>\u76ee\u5f55\uff08\u5728\u4e0a\u4e00\u8282\u6211\u4eec\u5728\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u521b\u5efa\u4e86\u6570\u636e\u5305\u5939\u548c\u9879\u76ee\u6587\u4ef6\uff09\u7684\u76f8\u5bf9\u8def\u5f84\u3002\u8fd9\u548c\u6211\u4eec\u5728\u8fc7\u7684\u5173\u4e8e<code>node</code>\u6d4b\u8bd5\u6570\u636e\u7684\u4f8b\u5b50\u7c7b\u4f3c </p> <p><code>data_bags_path:</code>\u6307\u5411\u7684\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u5c06\u4f5c\u4e3a\u6570\u636e\u5305\u4e0a\u4f20\u5230<code>chef-zero</code>\u670d\u52a1\u5668\u3002\u5728\u751f \u4ea7\u73af\u5883\u4e2d\u6570\u636e\u5305\u7684\u6570\u636e\u901a\u5e38\u4e0d\u4f1a\u5305\u542b\u5728\u83dc\u8c31\u6587\u4ef6\u7ed3\u6784\u4e2d\u3002</p> <p>\u6211\u4eec\u5c06\u6d4b\u8bd5\u6570\u636e\u5b58\u50a8\u5728<code>chef_playground/databags</code>\u800c\u4e0d\u662f\u5728<code>users</code>\u83dc\u8c31\u7684<code>cookbooks/users</code>\u6587\u4ef6\u7ed3\u6784\u4e2d </p> <p><code>/users/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  data_bags_path: ../../data_bags\n  always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[users::default]\n    attributes:\n</code></pre> <p>\u8ba9\u6211\u4eec\u5199\u4e00\u4e2a\u914d\u65b9\u5355\u6765\u67e5\u8be2<code>user</code>\u6570\u636e\u5305\u4e2d\u5b9a\u4e49\u7684\u7528\u6237\u6570\u636e\u5e76\u4e3a\u6bcf\u4e2a\u6570\u636e\u5305\u9879\u76ee\u521b\u5efa\u4e00\u4e2a\u76f8\u5e94\u7684\u672c\u5730\u7528\u6237\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528<code>search(\uff09</code>\u65b9\u6cd5\u6765\u6267\u884c\u6570\u636e\u5305\u67e5\u8be2\u5c31\u50cf\u5728\u641c\u7d22\u8282\u70b9\u4e00\u6837\u3002\u7136\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>Chef</code>\u7684<code>use</code>\u8d44\u6e90\u57fa\u5e72\u6570\u636e\u5305\u4e2d\u5b9a\u4e49\u7684\u6570\u636e\u521b\u5efa\u7528\u6237\u3002 </p> <p><code>cookbooks/users/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: users\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\nsearch(\"users\", \"*:*\").each do |user_data|\n    user user_data[\"id\"] do\n      comment user_data[\"comment\"]\n      uid user_data[\"uid\"]\n      gid user_data[\"gid\"]\n      home user_data[\"home\"]\n      shell user_data[\"shell\"]\n    end\nend\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528<code>each do</code>\u7ed3\u6784\u3002\u5728\u8fd9\u91cc\uff0c\u904d\u5386\u6570\u636e\u5305\u7684\u6bcf\u4e2a\u9879\u76ee\u5e76\u5c06\u6bcf\u4e2a\u9879\u76ee\u7684\u5185\u5bb9\u5b58\u5728<code>user_data</code>\u53d8\u91cf\u4e2d\u3002<code>user_data</code>\u662f\u4e00\u4e2a\u5b57\u5178\uff08\u54c8\u5e0c\uff09\u5305\u542b\u6570\u636e\u5305\u9879\u76ee\u7684\u952e\u503c\u5bf9\u513f </p> <p><code>search(\uff09</code>\u4ee3\u7801\u5757\u4e2d\u7684<code>user</code>\u8bed\u53e5\u662f\u4e00\u4e2a<code>Chef</code>\u8d44\u6e90\u3002<code>user</code>\u8d44\u6e90\u5728\u8282\u70b9\u4e0a\u521b\u5efa\u672c\u5730\u7528\u6237\u3002\u5b83\u63a5\u53d7\u4ee5\u4e0b\u5c5e\u6027: </p> <ul> <li><code>comment</code> \u5173\u4e8e\u8981\u521b\u5efa\u7684\u7528\u6237\u7684\u4fe1\u767d </li> <li><code>uid</code> \u4ee5\u6570\u5b57\u8868\u793a\u7684\u7528\u6237ID </li> <li><code>gid</code> \u4ee5\u6570\u5b57\u8868\u793a\u7684\u7528\u6237\u7684\u7ec4\u7684ID </li> <li><code>home</code> \u7528\u6237\u8ddf\u76ee\u5f55\u7684\u4f4d\u7f6e </li> <li><code>shell</code> \u7528\u6237\u767b\u5f55\u7684\u58f3 </li> </ul> <p>\u5728\u6211\u4eec\u7684\u914d\u65b9\u5355\u4e2d\u7684\u4ee3\u7801\u8bfb\u53d6<code>user_data</code>\u54c8\u5e0c\u5e76\u5c06\u5176\u4f20\u9012\u8fdb<code>Chef</code>\u7684<code>user</code>\u8d44\u6e90</p> <p>\u73b0\u5728\u8fd0\u884c<code>kitchen converge</code>\u5982\u679c\u4e00\u5207\u6b63\u786e\uff0c<code>Test Kitchen</code>\u5e94\u8be5\u4e0a\u4f20\u83dc\u8c31\u4ee3\u7801\u5230\u6c99\u76d2\u73af\u5883 \u5e76\u5728<code>cehf-zero</code>\u5b9e\u4f8b\u4e2d\u521b\u5efa\u6570\u636e\u5305\u3002</p> <p>\u7136\u540e\u5728\u6c99\u76d2\u8282\u70b9\u4e0a\u8fd0\u884c\u83dc\u8c31\u4ee3\u7801\u5e76\u67e5\u8be2\u6211\u4eec\u7684\u6570\u636e\u5305\u9879\u76ee\u4ee5\u53ca\u901a\u8fc7\u4f7f\u7528<code>user</code>\u8d44\u6e90\u521b\u5efa\u76f8\u5e94\u7684\u7528\u6237 </p> <pre><code>$ kitchen converge\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       ==&gt; vagrant: A new version of Vagrant is available: 2.2.6 (installed version: 2.2.5)!\n       ==&gt; vagrant: To upgrade visit: https://www.vagrantup.com/downloads.html\n\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Fixed port collision for 22 =&gt; 2222. Now on port 2201.\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2201\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2201\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m41.51s).\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[users::default]\"]\n       Policy lock file doesn't exist, running `chef install` for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.rb...\n       Building policy users\n       Expanded run list: recipe[users::default]\n       Caching Cookbooks...\n       Installing users &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.lock.json\n       Policy revision id: 263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc\n       Updating policy lock using `chef update`\n       Attributes already up to date\n       Building policy users\n       Expanded run list: recipe[users::default]\n       Caching Cookbooks...\n       Installing users &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap10/chef-playground/cookbooks/users/Policyfile.lock.json\n       Policy revision id: 263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1...\n       Exported policy 'users' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191206-83494-uckuo1\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing data_bags\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       el 6 x86_64\n       Getting information for chef stable  for el...\n       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64\n         to file /tmp/install.sh.3170/metadata.txt\n       trying wget...\n       trying curl...\n       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2\n       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473\n       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n       version  15.5.17\n       downloaded metadata file looks valid...\n       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n         to file /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm\n       trying wget...\n       trying curl...\n       Comparing checksum with sha256sum...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3170/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       Using policy 'users' at revision '263bb112d0b5a701a8ad5ee38e0a9b0f95d2ab849722f5a6738fcc588c9593fc'\n       resolving cookbooks for run list: [\"users::default@0.1.0 (6ad8a6c)\"]\n       Synchronizing Cookbooks:\n         - users (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 2 resources\n       Recipe: users::default\n         * linux_user[alice] action create\n           - create user alice\n         * linux_user[bob] action create\n           - create user bob\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 2/2 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (1m43.52s).\n-----&gt; Kitchen is finished. (2m25.60s)\n</code></pre>"},{"location":"chap1/chef_tutorial11_databag/#_1","title":"\u9a8c\u8bc1\u7528\u6237","text":"<p>\u8ba9\u6211\u4eec\u6765\u9a8c\u8bc1<code>Chef</code>\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u521b\u5efa\u4e86\u76f8\u5e94\u7684\u7528\u6237\u3002\u767b\u5f55\u5230\u6c99\u76d2\u73af\u5883\uff0c\u7136\u540e\u8fd0\u884c<code>getent</code> <code>password</code>\u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u7528\u6237\u5b58\u5728\u3002\u5b8c\u6210\u540e\u9000\u56de\u5230\u5bbf\u4e3b\u673a\u5668\uff1a </p> <pre><code>$ kitchen login \nLast login: Fri Dec  6 03:25:26 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$  getent passwd alice\nalice:x:2000:0:Alice Jones:/home/alice:/bin/bash\n[vagrant@default-centos65 ~]$ getent passwd bob\nbob:x:2001:0:Bob Smith:/home/bob:/bin/bash\n</code></pre> <p>\u53ef\u4ee5\u5728<code>users</code>\u6570\u636e\u5305\u4e2d\u518d\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7528\u6237\u7684\u4fe1\u606f\u3002\u8ba9\u6211\u4eec\u6765\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a<code>eve</code>\u7684\u7528\u6237\u3002\u56de\u5230<code>chef-playground</code>\u76ee\u5f55\u5e76\u521b\u5efa\u00b7chef-playground/data_bags/users/eve.json\u00b7\u6587\u4ef6\uff0c</p> <pre><code>{\n  \"id\": \"eve\",\n  \"comment\": \"Eavesdrop\",\n  \"uid\": 2002,\n  \"gid\": 0,\n  \"home\": \"/home/eve\",\n  \"shell\": \"/bin/bash\"\n}\n</code></pre> <pre><code>$ cd chef-playground\n$ knife data_bag from file users eve.json\nUpdated data_bag_item[users::eve]\n</code></pre> <p>Make your <code>users</code> recipe the current working directory.</p> <pre><code>$ cd cookbooks/users/\n</code></pre> <pre><code>$ kitchen converge\n$ kitchen login\nLast login: Fri Dec  6 03:33:27 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ getent passwd eve\neve:x:2002:0:Eavesdrop:/home/eve:/bin/bash\n</code></pre> <p>\u4f60\u4f1a\u6ce8\u610f\u5230<code>Chef</code>\u521b\u5efa\u4e86<code>eve</code>\u8d26\u53f7\u3002\u4f60\u7684\u914d\u65b9\u5355\u662f\u6570\u636e\u9a71\u52a8\u7684\u57fa\u4e8e<code>users</code>\u6570\u636e\u5305\u4e2d\u7684\u6570\u636e\u521b\u5efa\u76f8\u5e94\u7684\u7528\u6237\u3002</p> <p>\u6bcf\u5f53\u6570\u636e\u5305\u4e2d\u7684\u6570\u636e\u6539\u53d8\u65f6\u8282\u70b9\u5c06\u5728\u4e0b\u6b21<code>Chef</code>\u8fd0\u884c\u65f6\u5e94\u7528\u8fd9\u4e9b\u6539\u53d8\u800c\u4e95\u4e0d\u9700\u8981\u5bf9\u914d\u65b9\u5355\u4ee3\u7801\u505a\u51fa\u4efb\u4f55\u6539\u53d8 </p>"},{"location":"chap1/chef_tutorial11_databag/#3","title":"3\u3001\u52a0\u5bc6\u6570\u636e\u5305","text":"<p>\u6570\u636e\u5305\u9879\u76ee\u53ef\u4ee5\u88ab\u5171\u4eab\u5bc6\u94a5\u52a0\u5bc6\u4f7f\u5176\u53ef\u4ee5\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u5b58\u50a8\u9ad8\u5ea6\u5b89\u5168\u7684\u4fe1\u5305\u3002\u6bd4\u5982 \u53ef\u4ee5\u4f7f\u7528\u52a0\u5bc6\u6570\u636e\u5305\u5b58\u50a8 </p> <ul> <li>SSL\u8bc1\u4e66 </li> <li>SSH\u5bc6\u94a5 </li> <li>\u5bc6\u7801 </li> <li>\u8bb8\u53ef\u8bc1\u53f7\u7801 </li> </ul> <p>\u56e0\u4e3a\u8282\u70b9\u7684\u5c5e\u6027\u662f\u4ee5\u660e\u6587\u5b58\u50a8\u7684\u2015\u5373\u4f7f\u6bcf\u4e2a\u8282\u70b9\u65e0\u6cd5\u8bbf\u95ee\u5176\u4ed6\u8282\u70b9\u7684\u5c5e\u80dc\u2015\u8fd9\u4e0d\u4ee3\u8868\u8fd9\u4e9b\u5c5e\u6027\u662f\u5b89\u5168\u7684\u3002\u52a0\u5bc6\u6570\u636e\u5305\u662f\u5b58\u50a8\u79c1\u5bc6\u4fe1\u606f\u5f88\u597d\u7684\u9009\u62e9\u867d\u7136\u8fd9\u4e9b\u79c1\u5bc6\u4fe1\u606f\u5f80\u5f80\u4e0d\u662f\u9488\u5bf9\u67d0\u4e00\u4e2a\u8282\u70b9\uff0c\u4f46\u5373\u4f7f\u4f60\u53ea\u60f3\u4e3a\u67d0\u4e00\u4e2a\u8282\u70b9\u52a0\u5bc6\u4e00\u4e9b\u4fe1\u606f\u4e5f\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528 </p> <p>\u5f53\u4f7f\u7528<code>knife data bag create</code>\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5305\u65f6\uff0c\u4e00\u4e2a\u5305\u542b\u79d8\u94a5\u7684\u6587\u4ef6\u88ab\u4f20\u9012\u8fdb\u6765\uff0c\u6570\u636e\u5305\u7684\u5185\u5bb9\u88ab\u8fd9\u4e2a\u5bc6\u94a5\u52a0\u5bc6\u540e\u5b58\u50a8.\u5f53\u8282\u70b9\u8bd5\u56fe\u89e3\u5bc6\u5e76\u8bbf\u95ee\u6570\u636e\u5305\u5185\u5bb9\uff0c\u4ed6\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u79d8\u94a5</p> <p> </p> <p>\u8ba9\u6211\u4eec\u6765\u505a\u4e00\u4e2a\u52a0\u5bc6\u6570\u636e\u5305\u7684\u5b9e\u4f8b\u3002\u786e\u4fdd<code>chef-playground</code>\u76ee\u5f55\u4e3a\u4f60\u7684\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 </p> <ul> <li>\u9996\u5148\u751f\u6210\u4e00\u4e2a\u4f5c\u4e3a\u5bc6\u94a5\u7684\u5bc6\u7801\uff0c \u4ee5\u4e0b\u547d\u4ee4\u5c06\u751f\u6210\u4e00\u4e2a512\u5b57\u8282\u7684\u968f\u673a\u5bc6\u94a5\u4e95\u4fdd\u5b58\u81f3 <code>encrypted_data_bag_secret</code></li> </ul> <pre><code>$ openssl rand -base64 512 | tr -d '\\r\\n' &gt; encrypted_data_bag_secret\n</code></pre> <p>\u5f53\u4f7f\u7528\u5bf9\u79f0\u79d8\u94a5\u52a0\u5bc6\u65f6\uff0c\u5f80\u5f80\u5bc6\u7801\u5e94\u8be5\u7531\u673a\u5668\u751f\u6210\u800c\u4e0d\u662f\u4eba\u5de5\u6307\u5b9a\uff0c \u56e0\u6b64\u6211\u4eec\u4f7f\u7528<code>openssl</code>\u5de5\u5177\u751f\u6210\u4e00\u4e2a<code>512</code>\u5b57\u8282\u7684\u968f\u673a\u5bc6\u94a5\u3002</p> <p>\u4e3a\u4e86\u8868\u793a\u5bc6\u94a5\u4e2d\u7684\u8fdb\u5236\u6570\u5dde\u6211\u4eec\u544a\u8bc9<code>openssl</code>\u7528<code>base64</code>\u7f16\u7801\u6765\u5c06\u4e8c\u8fdb\u5236\u6570\u636e\u8868\u793a\u4e3aASCII\u5b57\u7b26\u4e32\uff0c \u6b64\u5916\uff0c\u7531\u4e8e<code>openssl</code>\u547d\u4ee4\u7684\u9ed8\u8ba4\u8f93\u51fa\u5305\u542b\u6362\u884c\u7b26\u7b49\u5728\u4e0d\u540c\u5e73\u53f0\u4e0b\u4e0d\u540c\u7684\u5b57\u7b26\uff0c \u6211\u4eec\u4f7f\u7528<code>tr</code>\u547d\u4ee4\u6765\u79fb\u9664\u79d8\u94a5\u4e2d\u6b64\u7c7b\u5b57\u7b26\uff0c \u8fd9\u6837\u786e\u4fdd\u4e86\u5bc6\u94a5\u4e2d\u7684\u5b57\u8282\u5728\u4e0d\u540c\u5e73\u53f0\u4e0b\u4f9d\u7136\u4f1a\u76f8\u901a </p> <p>\u4f5c\u4e3a\u6d4b\u8bd5\uff0c\u5047\u8bbe\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5305\u542b\u8bbf\u95ee\u4fe1\u7528\u5361\u4ed8\u6b3e\u7cfb\u7edf\u7684<code>API</code>\u79d8\u94a5\u7684<code>.json</code>\u6587\u4ef6\u4f5c\u4e3a\u6570\u636e\u5305\u9879\u76ee\uff0c \u5f88\u660e\u663e\u6211\u4eec\u5e0c\u671b\u5c06\u8fd9\u4e9b\u4fe1\u6025\u52a0\u5bc6\u3002</p> <p>\u5047\u8bbe\u8fd9\u4e2a\u6570\u636e\u5305\u9879\u76ee\u5305\u542b<code>id:</code>\u4ee5\u53ca<code>api_key</code>\u6765\u5b58\u50a8<code>API</code>\u5bc6\u94a5</p> <p>\u9996\u5148\u521b\u5efa\u6570\u636e\u5305\u76ee\u5f55</p> <pre><code>$ mkdir -p data_bags/api_keys\n</code></pre> <p><code>chef-playground/data_bags/api_keys/payment.json</code></p> <pre><code>{\n  \"id\": \"payment\",\n  \"api_key\": \"592c879e-f37d-43e6-8b54-8c2d97cf04d4\"\n}\n</code></pre> <pre><code>$ knife data bag create api_keys\nCreated data_bag[api_keys]\n</code></pre> <p>\u5f53\u6570\u636e\u5305\u9879\u76ee\u9700\u8981\u52a0\u5bc6\u65f6,\u4f7f\u7528<code>--secret-file</code>\u53c2\u6570\u6765\u4f20\u9012\u5bc6\u94a5 </p> <pre><code>$ knife data bag from file api_keys payment.json \\\n--secret-file encrypted_data_bag_secret data_bag_item[api_keys::payment]\n</code></pre> <p>\u5982\u4f55\u77e5\u8fc8\u6211\u4eec\u521b\u5efa\u7684\u6570\u636e\u5305\u9879\u76ee\u5728\u670d\u52a1\u5668\u4e0a\u662f\u5426\u88ab\u52a0\u5bc6\uff1f\u8ba9\u6211\u4eec\u901a\u8fc7<code>knife dtata bag</code>\u547d\u4ee4\u4f46\u5e76\u4e0d\u4f20\u9012\u5bc6\u94a5\u770b\u770b </p> <pre><code>$ knife data bag show api_keys payment\nWARNING: Encrypted data bag detected, but no secret provided for decoding. Displaying encrypted data.\napi_key:\n  auth_tag:       eWn37afy9KpD7ACCsBipnA==\n\n  cipher:         aes-256-gcm\n  encrypted_data: iLnKRDbkTwcC4cs5KJL92Fip2SjRooYovBSskpBvZuUyNrEnEJv4sOGhRFSb\n  VVTIGpl+tRDZ/w==\n\n  iv:             +yBoizTgPaUdgh6k\n\n  version:        3\nid:      payment\n</code></pre> <p>\u770b\u8d77\u6765\u52a0\u5bc6\u4e86\uff0c\u4e0d\u662f\u5417\uff1f </p> <p>\u4f60\u5728\u8f93\u51fa\u4e2d\u770b\u4e0d\u5230api_key\u5185\u5bb9\u7684\u539f\u6587\u3002\u53ea\u6709<code>id\uff1a</code>\u662f\u660e\u6587\u8868\u793a\u3002</p> <p><code>id\uff1a</code>\u4e0d\u80fd\u88ab\u52a0\u5bc6 \uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u5b83\u6765\u7d22\u5f15\u4ee5\u53ca\u641c\u7d22\u52a0\u5bc6\u7684\u6570\u636e\u3002</p> <p>\u5982\u679c\u60f3\u89e3\u5bc6\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u4f7f\u7528<code>--secret-fil</code>e\u53c2\u6570\uff0c\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e2d\u9879\u76ee\u7684\u503c\u662f\u539f\u6587\uff1a </p> <pre><code>$ knife data bag show api_keys payment \\\n&gt; --secret-file encrypted_data_bag_secret\nEncrypted data bag detected, decrypting with provided secret.\napi_key: 592c879e-f37d-43e6-8b54-8c2d97cf04d4\nid:      payment\n</code></pre> <p>\u6709\u4e00\u4e2a\u95ee\u9898<code>Chef</code>\u516c\u53f8\u5e76\u672a\u5bf9\u6b64\u63d0\u4f9b\u5b98\u65b9\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u8282\u70b9\u5982\u4f55\u5f97\u5230\u7528\u6765\u89e3\u5bc6\u6570\u636e\u5305\u7684\u5bc6\u94a5\uff1f\u8282\u70b9\u9700\u8981\u83b7\u5f97\u8fd9\u4e2a\u5bc6\u94a5\u624d\u80fd\u8bbf\u95ee\u52a0\u5bc6\u6570\u636e\u5305\u7684\u5185\u5bb9\uff0c\u4e0d\u5e78\u7684\u4e8b\uff0cChef\u4e0d\u80fd\u5c06\u8fd9\u4e9b\u5bc6\u94a5\u5b58\u50a8\u5728\u88abE\u4eec\u52a0\u5bc6\u7684\u540c\u4e00\u4e2a\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u6837\u8fdd\u53cd\u4e86\u8ba1\u7b97\u673a\u5b89\u5168\u7684\u6838\u5fc3\u539f\u5219\u3002\u56e0\u6b64 \u5f53\u4f60\u4f7f\u7528\u52a0\u5bc6\u6570\u636e\u5305\u65f6\uff0c\u9700\u8981\u89e3\u51b3\u5206\u53d1\u5bc6\u94a5\u7684\u95ee\u9898\u3002 </p> <p>\u5e78\u8fd0\u7684\u662f\u6211\u4eec\u4e0b\u4e00\u8282\u5c06\u8bb2\u8ff0\u4e00\u4e2a\u7b2c\u4e09\u65b9\u7684\u89e3\u51b3\u65b9\u6848\u4f7f\u7528\u6bd4<code>cehf-valut</code>\u5de5\u5177\u6765\u8fdb\u884c\u5bc6\u94a5\u7684\u5206\u53d1\u3002<code>chef-valut</code>\u5df2\u7ecf\u88ab\u5305\u542b\u5728<code>Chef</code>\u5f00\u53d1\u5305\u4e2d </p>"},{"location":"chap1/chef_tutorial11_databag/#4chef-valut","title":"4\u3001Chef-valut","text":"<p>For those using Chef Client, you will need to install an additional gem to use chef-vault. Run the following to install the chef-vault gem:</p> <pre><code>$ sudo gem install chef-vault --no-ri --no-rdoc\n</code></pre> <p>\u5728\u5f00\u59cb\u8bd5\u7528<code>chef-vault</code>\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u4e3a<code>devhost</code>\u8282\u70b9\u4ece<code>chef-zero</code>\u670d\u52a1\u5668\u6ce8\u518c\u4e00\u4e2a\u4e2a\u6b63\u5f0f\u7684\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002</p> <p>\u73b0\u5728\uff0c\u5982\u679c\u8fd0\u884c<code>knife client list</code>\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230<code>devhost</code>\u5e76\u4e0d\u5728\u5ba2\u6237\u7aef\u5217\u8868\u4e2d\u3002</p> <p>\u6211\u4eec\u7684 <code>Chef</code>\u670d\u52a1\u5668\u5e76\u4e0d\u77e5\u9053<code>devhost</code>\u662f\u4e00\u4e2a\u5408\u6cd5\u8282\u70b9\uff0c\u4e5f\u4e0d\u77e5\u9053\u8fd9\u4e2a\u8282\u70b9\u62e5\u6709\u5141\u8bb8\u5b83\u5728\u670d\u52a1\u5668\u4e0a\u5b58\u50a8\u6570\u636e\u7684\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002</p> <p>\u8981\u4f7f\u7528<code>chef-vault</code>\u6765\u8ba9\u8282\u70b9\u8bbf\u95ee\u52a0\u5bc6\u6570\u636e\u5305\u9879\u76ee\uff0c\u6211\u4eec\u9700\u8981\u8ba9\u8be5\u8282\u70b9\u6ee1\u8db3\u8fd9\u4e24\u4e2a\u6761\u4ef6\u3002 </p> <pre><code>cd chap10/chef-repo/playground\n$ knife client list\nja-validator\nnode-centos65.vagrantup.com\n$ knife node list\n\n</code></pre> <p>\u6ce8\u610f\uff1a\u5bf9\u4e8e\u8fd9\u4e2a\u8bd5\u9a8c\uff0c\u8282\u70b9\u5217\u8868\u5fc5\u987b\u4e3a\u7a7a\uff0c\u56e0\u4e3a\u6211\u4eec\u5728\u7b2c11\u7ae0\u4e2d\u521b\u5efa\u7684\u5047\u8282\u70b9\u5e76\u6ca1\u6709\u76f8\u5e94\u7684\u5ba2\u6237  \u7aef\u5bc6\u94a5\u3002\u5982\u679c\u4f60\u770b\u5230\u6709\u4efb\u4f55\u8282\u70b9\u5217\u51fa\uff0c\u91cd\u542f<code>chef-zero</code>\u670d\u52a1\u5668\u5c06\u5b83\u4eec\u6d88\u9664\u5373\u53ef\u3002 </p> <p>\u5728\u5f00\u53d1\u5de5\u4f5c\u7ad9\uff08\u6211\u4eec\u5c06\u5728<code>chef-playground/.chef/knife.rb</code>\u4e2d\u5c06\u5176\u79f0\u4f5c<code>devhost</code>\uff09\u4e0a\u751f\u6210\u4e00\u5bf9\u65b0\u7684\u79c1\u94a5\u3001\u516c\u94a5\u3002\u56e0\u4e3a<code>chef\u4e00zero</code>\u5e76\u4e0d\u68c0\u67e5.</p> <p><code>chef-playground/.chef/knife.rb</code>\u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u751f\u6210\u3002\u7136\u800c\uff0c\u5982\u679c\u91cd\u65b0\u751f\u6210\u5ba2\u6237\u7aef\u5bc6\u94a5\uff0c\u5c31\u9700\u8981\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e0a\u5b58\u6709\u4e0e\u5176\u76f8\u5e94\u7684\u516c\u94a5\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u91cd\u65b0\u751f\u6210\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002 </p> <pre><code>$  knife client create devhost  --disable-editing --file .chef/devhost.pem\nCreated client[devhost]\n</code></pre> <p><code>--admin</code>\u9009\u9879\u5141\u8bb8\u5176\u521b\u5efa\u7684\u5ba2\u6237\u7aef\u9488\u5bf9\u5b83\u76f8\u5bf9\u7684\u8282\u70b9\u4ee5\u5916\u7684\u5176\u4ed6\u8282\u70b9\u4f7f\u7528<code>knife client show</code>\u548c<code>knife node commands</code>\u80cc\u540e\u7684<code>API</code>\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>knife client create</code>\u5c06\u5ba2\u6237\u7aef \u4fe1\u606f\u663e\u793a\u5728\u4e00\u4e2a\u7f16\u8f91\u5668\u5185\uff0c\u5141\u8bb8\u4f60\u5728\u3002</p> <p><code>client.pem</code>\u5bc6\u94a5\u751f\u6210\u4e4b\u524d\u5bf9\u5ba2\u6237\u7aef\u4f5c\u51fa\u4fee\u6539\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u9ed8\u8ba4\u503c\u5c31\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\uff0c\u56e0\u6b64\u6211\u4eec\u4f20\u9012<code>--disable-editing</code>\u53c2\u6570\u6765\u76f4\u63a5\u4f7f\u7528\u9ed8\u8ba4\u503c\u3002<code>--file</code>\u53c2\u6570\u5c06\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002<code>client.pem</code>\u5199\u51fa\u5230\u4e00\u4e2a\u6307\u5b9a\u7684\u6587\u4ef6\u3002</p> <pre><code>$ knife client list\nchef-validator\nchef-webui\ndevhost\n</code></pre> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u521b\u5efa\u4e00\u4e2a\u548c\u5ba2\u6237\u7aef\u76f8\u7b26\u7684\u8282\u70b9\uff1a </p> <pre><code>$ knife node create devhost --disable-editing\nCreated node[devhost]\n</code></pre> <p>\u73b0\u5728<code>devhost</code>\u540c\u65f6\u663e\u793a\u5728\u8282\u70b9\u5217\u8868\u4e2d\u3002\u505a\u7684\u8fd9\u4e2a\u8fc7\u7a0b\u6a21\u62df\u4e86\u771f\u5b9e\u73af\u5883\u4e2d\u5f53\u4e00\u4e2a\u65b0\u8282\u70b9\uff08\u673a\u5668\uff09\u6ce8\u518c\u65f6\u53d1\u751f\u7684\u4e8b\u60c5\u2015\u751f\u6210\u5ba2\u6237\u7aef\u5bc6\u94a5\u3001\u521b\u5efa\u8282\u70b9\u5e76\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u6ce8\u518c\u3002 </p> <pre><code>$ knife node list\ndevhost\n</code></pre> <p>\u73b0\u4e86\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5bc6\u6570\u636e\u5305\uff0c\u5e76\u4f7f\u7528<code>chef-vault</code>.\u5047\u8bbe\u6211\u4eec\u9700\u8981\u7528\u5b83\u6765\u5b58\u50a8<code>root</code>\u5bc6\u7801\u3002 \u521b\u5efa<code>chef-plauground/data_bags/passwords</code>\u76ee\u5f55\u6765\u5b58\u50a8\u6570\u636e\u5305\u9879\u76ee<code>.json</code>\u6587\u4ef6</p> <p>Linux/Mac OS X:</p> <pre><code>$ mkdir -p data_bags/passwords\n</code></pre> <p><code>chef-playground/data_bags/passwords/mysql_root.json</code></p> <pre><code>{\n   \"id\": \"mysql_root\",\n   \"password\": \"This is a very secure password\"\n}\n</code></pre> <p><code>chef-vault</code>\u4f1a\u5b89\u88c5\u4e00\u4e2a<code>knife</code>\u547d\u4ee4\u7684\u63d2\u4ef6\u6765\u7ba1\u7406\u52a0\u5bc6\u6570\u636e\u5305\u3002</p> <p>\u8fd9\u4e2a\u63d2\u4ef6\u5c06<code>chef-valut</code>\u7684\u547d\u4ee4\u6574\u5408\u5230<code>knife vault</code>\u547d\u4ee4\u4e2d\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a\u52a0\u5bc6\u6570\u636e\u5305\u9879\u76ee\u5e76\u7528<code>chef-vdult</code> \u7ba1\u7406\u5bc6\u94a5\uff1a </p> <pre><code>$ knife vault create passwords mysql_root --json data_bags/passwords/mysql_root.json --search \"*:*\"  --mode client\n</code></pre> <p>\u5fc5\u987b\u901a\u8fc7<code>--search</code>\u6216<code>--admin</code>\u53c2\u6570\u6307\u5b9a\u62e5\u6709\u5408\u6cd5\u5ba2\u6237\u7aef\u5bc6\u94a5\u7684\u7528\u6237\u6216\u8282\u70b9\uff0e\u5728\u6211\u4eec\u7684\u4f8b\u5b50\uff0c \u56e0\u4e3a\u6ca1\u6709\u8bbe\u5b9a<code>admin</code>\u7528\u6237\u7684\u5ba2\u6237\u7aef\u5bc6\u94a5\u5982\u679c\u8fd0\u884c<code>knife client list</code>, \u662f\u770b\u4e0d\u5230<code>admin</code>\u7528\u6237\u7684\u3002 </p> <p>\u4f7f<code>chef</code>\u670d\u52a1\u5668\u65f6\u5fc5\u987b\uff0c\u4f7f\u7528<code>node client</code>\u9009\u9879 </p> <p><code>knife vault</code>\u547d\u4ee4\u7684\u7528\u6cd5\u548c<code>chef data_bags</code>\u4e0d\u540c\u3002</p> <p><code>chef-vault</code>\u53ea\u6709\u5728<code>Chef</code>\u670d\u52a1\u5668\u62e5\u6709\u6709\u6548\u7684<code>\u5ba2\u6237\u7aef\uff3f\u5bc6\u94a5</code>\u65f6\u624d\u53ef\u4ee5\u52a0\u5bc6\u6570\u636e\u5728<code>chef-zero</code>\u5de5\u3002\u73af\u5883\u4e0b\u8fbe\u53ef\u80fd\u4e0d\u6613\u914d\u7f6e\u6211\u4eec\u5728\u672c\u8282\u4e2d\u5230\u73b0\u5728\u4e3a\u6b62\u7684\u4f8b\u5b50\u4e2d\u505a\u4e86\u80fd\u5728<code>chef-zero</code>\u73af\u5883\u4e0b\u5c55\u793a<code>chef-valut</code>\u7684 <code>chef-valut</code>\u6700\u5c11\u7684\u5de5\u4f5c </p> <pre><code>$ knife data bag show passwords mysql_root\nWARNING: Encrypted data bag detected, but no secret provided for decoding. Displaying encrypted data.\nid:       mysql_root\npassword:\n  auth_tag:       XRKutwTzzRuQ+QuVHzZMRQ==\n\n  cipher:         aes-256-gcm\n  encrypted_data: 2w/iYmF9EdWmTqM4x3SfRpdP8N8dau9Eop87LY80ufKbQ8ivVbyODYlr4ocM\n  tEWiSQ==\n\n  iv:             pifuG1R7a9rH9/o0\n\n  version:        3\n</code></pre> <pre><code>$ knife vault show passwords mysql_root --mode client\nid:       mysql_root\npassword: This is a very secure password\n</code></pre>"},{"location":"chap1/chef_tutorial11_databag/#4","title":"4\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u4f7f\u7528Knife\u5728\u547d\u4ee4\u884c\u8fdb\u884c\u6570\u636e\u5305\u7684\u57fa\u672c\u64cd\u4f5c</li> <li>\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\u521b\u5efa\u672c\u5730\u7528\u6237</li> <li>\u52a0\u5bc6\u6570\u636e\u5305</li> <li>Chef-valut</li> </ul> <pre><code>$ knife data_bag create users\n$ knife data_bag from file users alice.json\n$ knife search users \"*:*\"\n$ knife search users \"*:*\"\n$ knife search users \"id:alice OR id:bob\" \n$ knife search users \"*:*\" -a shell\n\n\n$ knife data bag create api_keys\n$ knife data bag from file api_keys payment.json \\\n--secret-file encrypted_data_bag_secret data_bag_item[api_keys::payment]\n$ knife data bag show api_keys payment\n\n$ sudo gem install chef-vault --no-ri --no-rdoc\n$ knife client create devhost  --disable-editing --file .chef/devhost.pem\n$ knife client list\n$ knife node create devhost --disable-editing\n$ knife vault create passwords mysql_root --json data_bags/passwords/mysql_root.json --search \"*:*\"  --mode client\n$ knife data bag show passwords mysql_root\n$ knife vault show passwords mysql_root --mode client\n</code></pre>"},{"location":"chap1/chef_tutorial12/","title":"\u7b2c\u5341\u4e8c\u8282 \u89d2\u8272","text":"<ul> <li>\u521b\u5efa\u4e00\u4e2a\u7f51\u9875\u670d\u52a1\u5668\u89d2\u8272</li> <li>\u5c5e\u6027\u548c\u89d2\u8272 </li> <li>\u89d2\u8272\u548c\u641c\u7d22</li> <li>\u89d2\u8272\u83dc\u8c31 </li> </ul> <p>\u89d2\u8272\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5c06\u57fa\u7840\u67b6\u6784\u5185\u7684\u4e0d\u540c\u670d\u52a1\u5206\u7c7b\u5982\u56fe</p> <p></p> <p>\u89d2\u8272\u53ef\u4ee5\u7528\u6765\u8868\u793a\u57fa\u7840\u67b6\u6784\u5185\u7684\u4e0d\u540c\u670d\u52a1\u5668:</p> <ul> <li>\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\u5668 </li> <li>\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668 </li> <li>\u6570\u636e\u5e93\u7ec4\u5b58 </li> <li>\u6570\u636e\u5e93 </li> <li>\u76d1\u89c6\u670d\u52a1\u5668 </li> </ul> <p>\u53ef\u4ee5\u901a\u8fc7\u89d2\u8272\u65b9\u4fbf\u5730\u6307\u5b9a\u914d\u65b9\u5355\u548c\u5c5e\u6027\uff0c\u5c06\u67d0\u53f0\u670d\u52a1\u5668\u914d\u7f6e\u6210\u7406\u60f3\u7684\u670d\u52a1\u5668\u3002\u901a\u8fc7\u4f7f\u7528\u89d2\u8272\u53ef\u4ee5\u540c\u65f6\u5c06\u8bb8\u591a\u8282\u70b9\u914d\u7f6e\u6210\u67d0\u79cd\u670d\u52a1\u5668\u800c\u65e0\u9700\u91cd\u590d\u5de5\u4f5c </p> <p>\u9664\u4e86\u8fd9\u4e9b\u660e\u663e\u7684\u89d2\u8272\uff08\u6bd4\u5982\u201d\u7f51\u9875\u670d\u52a1\u5668\u201c\uff09\u4ee5\u5916\uff0c\u5c06\u4e9b\u5e38\u7528\u7684\u529f\u80fd\u96c6\u5408\u5728\u4e00\u8d77\u4f5c\u4e3a\u4e00\u4e2a\u89d2\u8272\u4e5f\u662f\u5f88\u5e38\u89c1\u7684\u3002\u6700\u660e\u663e\u7684\u4f8b\u5b50\u662f\u521b\u5efa\u4e00\u4e2a\u5305\u542b\u5893\u7840\u67b6\u6784\u5185\u94f6\u4e00\u4e2a\u8282\u70b9\u90fd\u9700\u8981 \u884c\u7684\u914d\u65b9\u5355\u57fa\u672c\u89d2\u8272\uff0c\u7136\u540e\u8ba9\u6bcf\u4e2a\u5176\u4ed6\u89d2\u8272\u5305\u542b\u8fd9\u4e2a\u57fa\u672c\u89d2\u8272\u3002 </p>"},{"location":"chap1/chef_tutorial12/#1","title":"1\u3001\u521b\u5efa\u4e00\u4e2a\u7f51\u9875\u670d\u52a1\u5668\u89d2\u8272","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u548c\u521b\u5efa\u6570\u636e\u5305\u7684\u540c\u6837\u65b9\u6cd5\u521b\u5efa\u89d2\u8272\u3002\u9ed8\u8ba4\u6e05\u51b5\u4e0b\uff0c\u6211\u4eec\u5c06\u89d2\u8272\u6587\u4ef6\u4fdd\u5b58\u5728<code>chef-playground</code>\u76ee\u5f55\u4e0b\u7684<code>roles</code>\u76ee\u5f55\u3002 </p> <pre><code>$ cd chap10/chef-playground\n$  chef-zero --port 9501\n&gt;&gt; Starting Chef Zero (v14.0.13)...\n&gt;&gt; WEBrick (v1.5.0) on Rack (v2.0.7) is listening at http://127.0.0.1:9501\n&gt;&gt; Press CTRL+C to stop\n</code></pre> <pre><code>$ cd chef-playground\n\n$ knife upload nodes\nCreated nodes/snowman.json\nCreated nodes/susu.json\nCreated nodes/atwood.json\n</code></pre> <pre><code>$ mkdir roles\n</code></pre> <p>\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a<code>.json</code>\u6587\u4ef6\u6765\u8868\u793a\u89d2\u8272\u7684\u6570\u636e\u3002</p> <p>\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u89d2\u8272\u5305\u542b<code>name</code>:\uff08\u540d\u5b57\uff09\u3001 <code>description</code>:\uff08\u63cf\u8ff0\uff09\u548c<code>run_list</code>\uff08\u8fd0\u884c\u6e05\u5355\uff09\u3002</p> <p>\u4e00\u4e2a\u89d2\u8272\u53ef\u4ee5\u7528\u6765\u628a\u4e00\u4e2a\u5f88\u957f\u7684\u914d\u65b9\u5355\u6e05\u5355\u7ec4\u7ec7\u6210\u4e00\u4e2a\u5355\u4f4d\u3002\u4e0b\u9762\u6211\u4eec\u4f7f\u7528\u793a\u4f8b14-I\u4e2d\u6240\u793a\u7684\u4ee3\u7801\u521b\u5efa<code>chef-playground/roles/webserver.json</code>\u6587\u4ef6 </p> <pre><code>$ touch roles/webserver.json \n</code></pre> <pre><code>{\n  \"name\": \"webserver\",\n  \"description\": \"Web Server\",\n  \"json_class\": \"Chef::Role\",\n  \"chef_type\": \"role\",\n  \"run_list\": [\n    \"recipe[motd]\",\n    \"recipe[users]\",\n    \"recipe[apache]\"\n  ]\n}\n</code></pre> <p>\u7136\u540e\u8fd0\u884c<code>knife role from file</code>\u547d\u4ee4\u5c06<code>webserver.json</code>\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\uff0c\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u521b\u5efa\u8fd9\u4e2a\u89d2\u8272\u3002</p> <p>\u548c\u6570\u636e\u5305\u4e00\u6837<code>knife role from file</code>\u547d\u4ee4\u5047\u8bbe<code>webserver.json</code>\u4f4d\u4e8e\u540d\u4e3a<code>roles</code>\u7684\u5b50\u76ee\u5f55\u4e2d\uff0c\u800c\u4e0d\u662f\u5728\u5f53\u524d\u76ee\u5f55 </p> <pre><code>$ knife role from file webserver.json\nUpdated Role webserver\n</code></pre> <p>\u7d27\u63a5\u7740\u8ba9\u6211\u4eec\u8fd0\u884c<code>knife show role</code>\u67e5\u770b\u521a\u521a\u5728\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u7684<code>webserver</code>\u89d2\u8272 </p> <pre><code>$ knife role show webserver\nchef_type:           role\ndefault_attributes:\ndescription:         Web Server\nenv_run_lists:\njson_class:          Chef::Role\nname:                webserver\noverride_attributes:\nrun_list:\n  recipe[motd]\n  recipe[users]\n  recipe[apache]\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7<code>knife node set</code>\u547d\u4ee4\u5728\u670d\u52a1\u5668\u4e0a\u8bbe\u5b9a\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u3002\u8ba9\u6211\u4eec\u5c06<code>snowman</code>\u8282\u70b9\u7684 \u8fd0\u884c\u6e05\u5355\u8bbe\u5b9a\u4e3a\u521a\u521a\u521b\u5efa\u7684<code>webserver</code>\u89d2\u8272 </p> <pre><code>$ knife node run_list set snowman \"role[webserver]\"\nsnowman:\n  run_list: role[webserver]\n</code></pre> <p>\u5728<code>Chef</code>\u8fd0\u884c\u65f6\uff0c\u8fd0\u884c\u6e05\u5355\u4e2d\u7684\u7f51\u9875\u670d\u52a1\u5668(<code>webserver</code>)\u89d2\u8272\u5c06\u5c55\u5f00\u81f3\u8be5\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355 </p> <ul> <li><code>recipe[motd]</code></li> <li><code>recipe[users]</code></li> <li><code>recipe[apache]</code></li> </ul> <p>\u89d2\u8272\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5141\u8bb8\u4f60\u6309\u529f\u80fd\u5c06\u57fa\u7840\u67b6\u6784\u52a0\u4ee5\u5206\u7c7b\u3002\u4e00\u4e2a\u89d2\u8272\u5305\u542b\u5f88\u591a\u914d\u65b9\u5355\u662f\u5f88\u5e38\u89c1\u7684\u5982\u679c\u6ca1\u6709\u89d2\u8272\u529f\u80fd\uff0c\u60f3\u8c61\u4e00\u4e0b\u4f60\u9700\u8981\u91cd\u590d\u5c06\u6570\u5341\u4e2a\u914d\u65b9\u5355\u4e00\u6dfb\u52a0 \u5230\u6570\u767e\u4e2a\u8282\u70b9\u7684\u6bcf\u4e2a\u8fd0\u884c\u6e05\u5355\u4e2d\u3002\u89d2\u8272\u4f7f\u8fd9\u9879\u5de5\u4f5c\u53d8\u5f97\u5341\u5206\u5bb9\u6613\u3002 </p>"},{"location":"chap1/chef_tutorial12/#2","title":"**2\u3001\u5c5e\u6027\u548c\u89d2\u8272 **","text":"<p>\u89d2\u8272\u540c\u65f6\u53ef\u4ee5\u5305\u542b\u5c5e\u6027\u3002 </p> <p>\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a<code>.json</code>\u6587\u4ef6\u6765\u8868\u793a\u4e00\u4e2a\u57fa\u672c\u89d2\u8272\u3002\u8fd9\u4e2a\u89d2\u8272\u5305\u542b\u6211\u4eec\u5728\u524d\u9762\u63a8\u8350\u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684<code>chef-client::delete_validation</code>\u548c<code>chef-client::default</code>\u914d\u65b9\u5355\u3002</p> <p>\u5728\u8fd9\u4e2a\u6848\u4f8b\u4e2d\uff0c\u6211\u4eec\u540c\u65f6\u9700\u8981\u8bbe\u5b9a\u4e00\u4e2a\u5c5e\u6027\u544a<code>chef-client::default</code>\u914d\u65b9\u5355\u6211\u4eec\u5e0c\u671b\u4f7f\u7528 <code>runit</code>\u4f5c\u4e3a<code>init_style</code>\u7684\u503c\u3002</p> <p><code>touch roles/base.json</code></p> <pre><code>{\n    \"name\": \"base\",\n    \"description\": \"Common recipes for all nodes\",\n    \"json_class\": \"Chef::Role\",\n    \"chef_type\": \"role\",\n    \"run_list\": [\n      \"recipe[chef-client::delete_validation]\",\n      \"recipe[chef-client]\"\n    ],\n    \"default_attributes\": {\n      \"chef_client\": {\n        \"init_style\": \"runit\"\n      }\n    }\n  }\n</code></pre> <pre><code>$ knife role from file base.json\nUpdated Role base\n</code></pre> <pre><code> knife role show base\nchef_type:           role\ndefault_attributes:\n  chef_client:\n    init_style: runit\ndescription:         Common recipes for all nodes\nenv_run_lists:\njson_class:          Chef::Role\nname:                base\noverride_attributes:\nrun_list:\n  recipe[chef-client::delete_validation]\n  recipe[chef-client]\n</code></pre> <p>\u6211\u4eec\u63a8\u8350\u5728\u89d2\u8272\u4e2d\u53ea\u4f7f\u7528\u9ed8\u8ba4\u4f18\u5148\u7ea7\u7684\u5c5e\u6027\u8fd9\u6837\u53ef\u4ee5\u8ba9\u591a\u4e2a\u6765\u6e90\u7684\u5c5e\u6027\u7ec4\u5408\u66f4\u5bb9\u6613\u7406\u89e3 </p> <p>\u7531\u4e8e\u89d2\u8272\u53ef\u4ee5\u5305\u542b\u5c5e\u6027\u5154\u8272\u4e2d\u7684\u5c5e\u80dc\u4e5f\u5728\u6240\u6709\u5c5e\u6027\u4e2d\u4f63\u6709\u5b83\u7684\u4f18\u5148\u7ea7\u3002</p> <p>\u6211\u4eec\u5c55\u793a\u5c5e\u6027\u4f18\u5148\u7ea7\u7684\u7ed3\u6784\uff0c</p> <ul> <li>\u89d2\u8272\u7684\u5c5e\u6027\u53ef\u4ee5\u91cd\u5199\u914d\u65b9\u5355\u6216\u5c5e\u6027\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5c5e\u6027</li> <li>\u4f46\u4f18\u5148\u7ea7\u6bd4<code>ohai</code>\u5b9a\u4e49\u7684\u81ea\u52a8\u5c5e\u6027\u8981\u4f4e </li> <li>\u89d2\u8272\u4e2d\u7684\u5c5e\u6027\u8bbe\u8ba1\u4e3a\u5168\u5c40\u8bbe\u5b9a</li> <li>\u5e76\u6bd4\u5728\u83dc\u8bd7\u4e2d\u8bbe\u5b9a\u7684\u5c5e\u6027\u62e5\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\u3002 </li> </ul> <p></p>"},{"location":"chap1/chef_tutorial12/#3","title":"3\u3001\u89d2\u8272\u548c\u641c\u7d22","text":"<p><code>Chef</code>\u641c\u7d22\u529f\u80fd\u652f\u6301\u89d2\u8272\u3002\u4ee5\u4e0b\u4f8b\u5b50\u5c55\u793a\u5982\u4f55\u641c\u7d22\u5305\u542b\u67d0\u4e2a\u914d\u65b9\u5355\u7684\u89d2\u8272\u3002\u6ce8\u610f\uff0c\u5fc5\u987b\u4f7f\u7528<code>\\</code>\u5b57\u7b26\u6765\u8f6c\u4e49\u67e5\u8be2\u5b57\u7b26\u4e32\u4e2d\u7684<code>[</code>\u548c<code>]</code> </p> <pre><code>$ knife search role \"run_list:recipe\\[apache\\]\"\n1 items found\n\nchef_type:           role\ndefault_attributes:\ndescription:         Web Server\nenv_run_lists:\njson_class:          Chef::Role\nname:                webserver\noverride_attributes:\nrun_list:\n  recipe[motd]\n  recipe[users]\n  recipe[apache]\n</code></pre> <p>\u7531\u4e8e\u5728\u89d2\u8272\u4e2d\u7684\u8fd0\u884c\u6e05\u5355\u53ef\u4ee5\u5c55\u5f00\uff08\u5305\u542b\u5176\u4ed6\u89d2\u8272\u6216\u914d\u65b9\u5355\uff09\uff0c\u8981\u641c\u7d22\u4e00\u4e2a\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a </p> <pre><code>knife search node \"recipe:&lt;recipe_name&gt;\"\n</code></pre> <p>When you <code>do not</code> want the search to include the expanded set of recipes within roles</p> <pre><code>knife search node \"recipes:&lt;recipe name&gt;\"\n</code></pre> <p>When you <code>do</code> want the search to expand role references</p> <p>\u8ba9\u6211\u4eec\u91cd\u65b0\u6765\u770b\u65e9\u5148\u4f7f\u7528\u7684<code>webserver</code>\u89d2\u8272\u6848\u4f8b</p> <ul> <li> <p>\u5c06<code>webserver</code>\u89d2\u8272\u52a0\u4eba\u5230<code>snowman</code>\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u3002\u5f53<code>Chef</code>\u8fd0\u884c\u65f6<code>webserver</code>\u89d2\u8272\u5c55\u5f00\u5b9e\u9645\u8282\u70b9\u5c06\u8fd0\u884c\u4ee5\u4e0b<code>web server</code>\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u5305\u542b\u7684\u914d\u65b9\u5355\uff1a </p> </li> <li> <p>recipe[motd]</p> </li> <li>recipe[users]</li> <li>recipe[apache]</li> </ul> <p>\u7136\u800c\u5982\u679c\u901a\u8fc7<code>recipe:</code>\u8fdb\u884c\u641c\u7d22\uff0c\u6bd4\u5982\u641c\u7d22<code>recipe[apache::config]</code>\u7ed3\u679c\u4e2d\u4e0d\u4f1a\u5f97\u5230 <code>snowman</code>\u8282\u70b9\uff1a </p> <pre><code>$ knife search node \"recipe:apache\"\n2 items found\n\nNode Name:   atwood\nEnvironment: _default\nFQDN:        atwood.playground.local\nIP:          192.168.33.31\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n\nNode Name:   susu\nEnvironment: _default\nFQDN:        susu.playground.local\nIP:          192.168.33.33\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n</code></pre> <p>\u56e0\u4e3a<code>snowman</code>\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u5e76\u6ca1\u6709\u76f4\u63a5\u5f15\u7528<code>recipe[apache::config]</code> <code>snowman</code>\u8282\u5305\u542b<code>\"role[webserner]\"</code>\u89d2\u8272\u5c55\u5f00\u540e\u624d\u5305\u542b<code>\"recipe[apache]\"</code>\u914d\u65b9\u5355\u3002</p> <p>\u7136\u800c\u5982\u679c\u4f7f\u7528<code>recipes:</code>\u8fdb\u884c\u641c\u7d22\u7ed3\u679c\u4e2d\u4f1a\u5f97\u5230<code>snowman</code>\u8282\u70b9\uff0e </p> <p>NOTE</p> <p>Similar to the square bracket characters <code>([])</code>, the colon (<code>::</code>) characters in a cookbook recipe reference must be individually escaped on a command line with the backslash (<code>\\</code>) character: chef-client<code>\\:\\:</code>config. This is treated as if it were <code>chef-client::config</code>.</p> <pre><code>  knife search node \"recipes:apache\"\n3 items found\n\nNode Name:   atwood\nEnvironment: _default\nFQDN:        atwood.playground.local\nIP:          192.168.33.31\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags:        \n\nNode Name:   snowman\nEnvironment: _default\nFQDN:        snowman.playground.local\nIP:          192.168.33.32\nRun List:    role[webserver]\nRoles:       \nRecipes:     apache, motd, motd-attributes\nPlatform:    ubuntu 14.04\nTags:        \n\nNode Name:   susu\nEnvironment: _default\nFQDN:        susu.playground.local\nIP:          192.168.33.33\nRun List:    recipe[apache], recipe[motd]\nRoles:       \nRecipes:     apache, motd\nPlatform:    centos 6.5\nTags: \n</code></pre> <p>\u529d\u4e8e\u901a\u8fc7\u89d2\u8272\u641c\u7d22\u8282\u70b9\u4e5f\u4e00\u6837\u53ef\u4ee5\u6307\u5b9a\u662f\u5426\u5c55\u5f00\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355 </p> <pre><code>knife search node role:&lt;role_name&gt;\n</code></pre> <p>When you do not want the search to include the expanded set of role references</p> <pre><code>knife search node \"roles:&lt;role_name&gt;\"\n</code></pre> <p>When you do want the search to expand role references</p>"},{"location":"chap1/chef_tutorial12/#4","title":"4\u3001\u89d2\u8272\u83dc\u8c31","text":"<p>\u5f53\u4e00\u4e2a\u89d2\u8272\u88ab\u6539\u53d8\u65f6\uff0c\u5b83\u4f1a\u5b9e\u65f6\u5f71\u54cd\u6574\u4e2a\u57fa\u7840\u67b6\u6784\u3002\u7136\u800c\u76ee\u524d\u89d2\u8272\u8fd8\u4e0d\u652f\u6301\u591a\u7248\u672c\uff0e </p> <p>\u901a\u5e38\uff0c\u8fd0\u884c\u6e05\u5355\u5bf9\u6b64\u7684\u5f71\u54cd\u6700\u5927\u3002\u4e3e\u4f8b\u800c\u8a00<code>Chef</code>\u57fa\u7840\u67b6\u6784\u7684\u5176\u4e2d\u4e00\u540d\u5de5\u7a0b\u5e08\u51b3\u5b9a\u5c06<code>recipe[apache]</code>\u914d\u65b9\u5355\u4ece\u6211\u4eec\u672c\u7ae0\u524d\u9762\u4f7f\u7528\u7684<code>webserver</code>\u89d2\u8272\u4e2d\u79fb\u9664\u5047\u8bbe\u8fd9\u4f4d\u5de5\u7a0b\u5e08 </p> <p>\u8fd9\u6837\u505a\u56e0\u4e3a\u5979\u4e0d\u60f3\u8ba9\u7f51\u9875\u670d\u52a1\u5668\u9ed8\u8ba4\u4f7f\u7528<code>Apache</code>\u800c\u60f3\u8ba9\u5f00\u53d1\u83dc\u8c31\u7684\u5de5\u7a0b\u5e08\u51b3\u5b9a\u4f7f\u7528<code>Apache</code>\u8fd8\u662f<code>Nginx</code>\u670d\u52a1\u5668 </p> <pre><code>{\n  \"name\": \"webserver\",\n  \"description\": \"Web Server\",\n  \"json_class\": \"Chef::Role\",\n  \"chef_type\": \"role\",\n  \"run_list\": [\n    \"recipe[motd]\",\n    \"recipe[users]\"\n  ]\n}\n</code></pre> <p>\u5982\u679c<code>webserver</code>\u89d2\u8272\u5728\u57fa\u7840\u67b6\u6784\u4e2d\u88ab\u5e7f\u6cdb\u4f7f\u7528\uff0c\u4ee5\u4e0a\u7684\u6539\u53d8\u5c31\u4f1a\u5bf9\u5047\u8bbe<code>recipe[apache]</code>\u914d \u65b9\u5355\u4f1a\u5728<code>webserver</code>\u89d2\u8272\u4e2d\u5b58\u5728\u7684\u83dc\u8c31\u9020\u6210\u610f\u6599\u4e4b\u5916\u7684\u5f71\u54cd\u3002</p> <p>\u76f8\u53cd\uff0c\u5982\u679c\u5de5\u7a0b\u5e08\u4eec\u90fd\u76f8\u5f53 \u8c28\u614e\u800c\u4e0d\u6562\u5bf9\u73b0\u6709\u89d2\u8272\u505a\u51fa\u6539\u53d8\uff0c\u5219\u4f1a\u9020\u6210\u62e5\u6709\u8bb8\u591a\u529f\u80fd\u7c7b\u4f3c\u4f46\u540d\u5b57\u4e0d\u540c\u7684\u89d2\u8272\u3002</p> <p>\u4e3e\u4f8b\u800c\u8a00<code>Chef</code>\u5de5\u7a0b\u5e08\u53ef\u80fd\u4f1a\u521b\u5efa\u4e24\u4e2a\u65b0\u7684\u89d2\u8272<code>webserver-apache</code>\u548c<code>webservex-nginx</code>\u66f4\u8bf7\u695a\u5730\u8868\u660e\u5979\u60f3\u7528\u8fd9\u4e9b\u6765\u8865\u5145\u73b0\u6709\u7684<code>webserver</code>\u89d2\u8272\u7684\u610f\u56fe </p> <p>\u56e0\u4e3a\u83dc\u8c31\u662f\u652f\u6301\u7248\u672c\u7684\u8bb8\u591a<code>Chef</code>\u5de5\u7a0b\u5e08\u4f7f\u7528\u89d2\u8272\u83dc\u8c31\u6765\u4ee3\u66ff\u89d2\u8272\u4e2d\u7684\u8fd0\u884c\u6e05\u5355 \u5b83\u4eec\u4ecd\u7136\u4f7f\u7528\u89d2\u8272\u4e2d\u7684\u5c5e\u6027\u53ea\u662f\u628a\u8fd0\u884c\u6e05\u5355\u79fb\u5230\u4e86\u83dc\u8c31\u4e2d\u3002</p> <p>\u4e00\u4e2a\u914d\u65b9\u5355\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528<code>include_recipe</code>\u547d\u4ee4\u6765\u8f7b\u677e\u6a21\u62df\u8fd0\u884c\u6e05\u5355\u4f8b.</p> <p>\u5982\u5728\u6211\u4eec\u7684\u5b9e\u4f8b\u4e2d\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>webserver</code>\u83dc\u8c31\uff1a </p> <pre><code>include_recipe \"motd\"\ninclude_recipe \"user\"\ninclude_recipe \"apache\"\n</code></pre> <p>\u4f5c\u4e3a\u5206\u7c7b\u7528\u9014\u4ee5\u53ca\u4f7f\u7528\u89d2\u8272\u5c5e\u6027\uff0c\u8282\u70b9\u4ecd\u7136\u9002\u7528<code>webserver</code>\u89d2\u8272\uff0c<code>webserver</code>\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u4ec5\u5305\u542b<code>webserver</code>\u83dc\u8c31\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u4ecd\u7136\u53ef\u4ee5\u901a\u8fc7\u641c\u7d22\u627e\u5230\u6240\u6709\u7f51\u9875\u670d\u52a1\u5668\uff1a </p> <pre><code>knife search node role:webserver\n</code></pre> <p>\u5728\u8fd9\u4e2a\u60c5\u666f\u4e2d\uff0c<code>webserver</code>\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355\u4e3a\u7a7a\uff0c\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u5219\u5305\u542b <code>recipe[webserver]</code>\u83dc\u8c31\uff08\u4e5f\u53ef\u4ee5\u5c06<code>recipe[webserver]</code>\u83dc\u8c31\u4f5c\u4e3a<code>webserver</code>\u89d2\u8272\u7684\u552f\u4e00\u8fd0\u884c\u6e05\u5355\u9879\u76ee\uff0c\u7136\u540e\u8282\u70b9\u4ecd\u7136\u5305\u542b<code>webserver</code>\u89d2\u8272\uff09\u3002</p> <p>\u83dc\u8c31\u652f\u6301\u591a\u7248\u672c\uff0c\u914d\u5408\u4f7f\u7528\u4e0b\u4e00\u7ae0\u5c06\u4f1a\u4ecb\u7ecd\u7684\u73af\u5883\u529f\u80fd\uff0c\u4f60\u53ef\u4ee5\u6307\u5b9a\u54ea\u4e9b\u8282\u70b9\u4f7f\u7528\u54ea\u4e9b\u7279\u5b9a\u7248\u672c\u7684\u83dc\u8c31\u3002\u8fd9\u79f0\u4e3a\u8282\u70b9\u7684\u7248\u672c\u8ba1\u5212 </p>"},{"location":"chap1/chef_tutorial12/#5","title":"5\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u521b\u5efa\u4e00\u4e2a\u7f51\u9875\u670d\u52a1\u5668\u89d2\u8272</li> <li>\u5c5e\u6027\u548c\u89d2\u8272</li> <li>\u89d2\u8272\u548c\u641c\u7d22</li> <li>\u89d2\u8272\u83dc\u8c31</li> </ul> <pre><code>$ knife role from file webserver.json\n$ knife role show webserver\n$ knife node run_list set snowman \"role[webserver]\"\n$ knife search role \"run_list:recipe\\[apache\\]\"\n$ knife search node \"recipes:&lt;recipe name&gt;\"\n$ knife search node \"recipe:apache\"\n$ knife search node \"roles:&lt;role_name&gt;\"\n$ knife search node role:webserver\n</code></pre>"},{"location":"chap1/chef_tutorial13_env/","title":"\u7b2c\u5341\u4e09\u8282 \u73af\u5883","text":"<p><code>Chef</code>\u670d\u52a1\u5668\u652f\u6301\u201c\u73af\u5883\u201d\u529f\u80fd\u4e3a\u8f6f\u4ef6\u5f00\u53d1\u751f\u547d\u5468\u671f\u4e2d\u7684\u6bcf\u4e00\u4e2a\u9636\u6bb5\u5efa\u6a21</p> <p></p> <p>\u73af\u5883\u53cd\u6620\u6a21\u5f0f\u548c\u5de5\u4f5c\u6d41\uff0c \u53ef\u4ee5\u7528\u6765\u8868\u793a\u5e94\u7528\u7a0b\u5e8f\u7684\u5404\u4e2a\u751f\u547d\u9636\u6bb5</p> <ul> <li>\u5f00\u53d1 </li> <li>\u6d4b\u8bd5 </li> <li>\u6a21\u62df\u751f\u4ea7\u73af\u5883 </li> <li>\u751f\u4ea7\u73af\u5883 </li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Chef</code>\u670d\u52a1\u5668\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a<code>default</code>\u7684\u73af\u5883\u3002 </p> <p>\u73af\u5883\u53ef\u4ee5\u5305\u542b\u914d\u7f6e\u57fa\u7840\u67b6\u6784\u6240\u9700\u7684\u5c5e\u6027, \u6bd4\u5982 \u67d0</p> <ul> <li>\u4ed8\u6b3e\u670d\u52a1<code>API</code>\u7684<code>URL</code> </li> <li>\u7a0b\u5e8f\u5305\u5b58\u50a8\u6e90\u7684\u4f4d\u7f6e </li> <li>\u6240\u9700\u4f7f\u7528\u7684<code>Chef</code>\u914d\u7f6e\u6587\u4ef6\u7684\u7248\u672c </li> </ul> <p>\u548c\u89d2\u8272\u4e0d\u4e00\u6837\uff0c\u73af\u5883\u652f\u6301\u7248\u672c\u7ea6\u675f\uff08\u6307\u5b9a\u5728\u8be5\u73af\u5883\u4e0b\u4f7f\u7528\u7684\u83dc\u8c31\u7684\u7248\u672c\uff09\uff0c\u56e0\u6b64\u5141\u8bb8\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e0a\u5bf9\u4e0d\u540c\u7684\u73af\u5883\u63d0\u4f9b\u4e0d\u540c\u7684\u8d44\u6e90\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8ba4\u4e3a\u5982\u679c\u4f7f\u7528<code>Test Kitchen</code>\u8fdb\u884c\u6d4b\u8bd5\u4e95\u5728\u6d4b\u8bd5\u540e\u9500\u6bc1\u4fa7\u8bd5\u8282\u70b9\u4fbf\u4e0d\u9700\u8981\u4f7f\u7528\u591a\u4e2a\u73af\u5883\uff0c\u4f46\u4e8b\u5b9e\u4e0d\u662f\u8fd9\u6837\uff0c\u5373\u4f7f\u4f60\u4f7f\u7528<code>Test Kitchen</code>\u5e38\u5e38\u4e5f\u4f1a\u5e0c\u671b\u5728\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u524d\u5728\u548c\u751f\u4ea7\u73af\u5883\u7c7b\u4f3c\u7684\u771f\u5b9e\u7684\u670d\u52a1\u5668\u73af\u5883\u4e2d\u90e8\u7f72\u81ea\u5df1\u7684<code>Chef</code>\u914d\u7f6e\u4ee3\u7801 </p>"},{"location":"chap1/chef_tutorial13_env/#1","title":"1\u3001\u521b\u5efa\u4e00\u4e2a\u5f00\u53d1\u73af\u5883","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u50cf\u521b\u5efa<code>Chef</code>\u6570\u636e\u5305\u6216\u89d2\u8272\u4e00\u6837\u7684\u65b9\u6cd5\u521b\u5efa\u73af\u5883\u3002\u5728\u672c\u4e66\u7684\u4f8b\u5b50\u4e2d\u6211\u4eec\u53ef\u4ee5\u5728<code>chef-playground</code>\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a\u8868\u793a\u73af\u5883\u7684\u76ee\u5f55,\u9ed8\u8ba4\u53ef\u547d\u540d\u4e3a<code>envrionments</code>\u3002 </p> <pre><code>$ chef-zero --port 9501\n&gt;&gt; Starting Chef Zero (v14.0.13)...\n&gt;&gt; WEBrick (v1.5.0) on Rack (v2.0.7) is listening at http://127.0.0.1:9501\n&gt;&gt; Press CTRL+C to stop\n...\n</code></pre> <pre><code>$ cd chef-playground\n$ mkdir environments\n</code></pre> <p>\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a<code>.json</code>\u6587\u4ef6\u6765\u8868\u793a\u65b0\u7684\u73af\u5883\u3002\u57fa\u672c\u7684\u73af\u5883\u9700\u8981\u62e5\u6709<code>name:\uff08\u540d\u5b57\uff09</code>\u548c <code>description:\uff08\u63cf\u8ff0\uff09</code>\u73af\u5883\u4e5f\u540c\u65f6\u53ef\u4ee5\u5305\u542b\u5bf9\u83dc\u8c31\u7684\u7248\u672c\u7ea6\u675f\u3002</p> <p>\u80fd\u591f\u5728\u67d0\u4e2a\u73af\u5883\u5185\u6307\u5b9a\u7279\u5b9a\u7684\u83dc\u8bb2\u7248\u672c\u662f\u73af\u5883\u6700\u6709\u7528\u7684\u529f\u80fd, \u8bf7\u521b\u5efa<code>chef-playground/roles/dev.json</code>\u6587\u4ef6 </p> <p><code>chef-playground/environments/dev.json</code></p> <pre><code>{\n  \"name\": \"dev\",\n  \"description\": \"For developers!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.2.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\"\n}\n</code></pre> <p>\u8fd0\u884c<code>knife environment from file</code>\u5e76\u4f20\u9012\u521a\u521b\u5efa\u7684<code>dev.json</code>\u6587\u4ef6\u3002</p> <p><code>knife environment from file</code>\u547d\u4ee4\u4f1a\u5047\u8bbe<code>dev.json</code>\u6587\u4ef6\u5728\u540d\u4e3a<code>environment</code>\u7684\u5b50\u76ee\u5f55\u4e2d\u800c\u4e0d\u662f\u5f53\u524d\u76ee\u5f55</p> <pre><code>$ knife environment from file dev.json\nUpdated Environment dev\n</code></pre> <pre><code>$ knife environment show dev\nchef_type:           environment\ncookbook_versions:\n  apache: = 0.2.0\ndefault_attributes:\ndescription:         For developers!\njson_class:          Chef::Environment\nname:                dev\noverride_attributes:\n</code></pre>"},{"location":"chap1/chef_tutorial13_env/#2","title":"2\u3001\u5c5e\u6027\u548c\u73af\u5883","text":"<p>\u73af\u5883\u53ef\u4ee5\u5305\u542b\u5c5e\u6027\u8ba9\u6211\u4eec\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u8868\u793a\u751f\u4ea7\uff08<code>production</code>) \u73af\u5883\u7684<code>.json</code>\u6587\u4ef6, \u8fd9\u4e2a\u73af\u5883\u5c06\u4f1a\u7ea6\u675f<code>apache</code>\u83dc\u8c31\u7684\u7248\u672c\u5230<code>0.1.1</code>\u7248\u672c</p> <p>\u540c\u65f6\uff0c \u8ba9\u6211\u4eec\u786e\u4fdd\u5728\u751f\u4ea7\u73af\u5883\u4e0b \u6bcf\u65e5\u6d88\u6025\u663e\u793a\u4e00\u4e2a\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u81ea\u5df1\u7684\u7279\u522b\u7259\u8096\u606f\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u6765\u521b\u5efa<code>chef-playground/roles/production.json</code>\u6587\u4ef6</p> <p><code>chef-playground/roles/production.json</code></p> <pre><code>{\n  \"name\": \"production\",\n  \"description\": \"For prods!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.1.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\",\n  \"override_attributes\": {\n    \"motd\": {\n      \"message\": \"A production-worthy message of the day\"\n    }\n  }\n}\n</code></pre> <pre><code>$  knife environment from file production.json\nUpdated Environment production\n\n$ knife environment show production\nchef_type:           environment\ncookbook_versions:\n  apache: = 0.1.0\ndefault_attributes:\ndescription:         For prods!\njson_class:          Chef::Environment\nname:                production\noverride_attributes:\n  motd:\n    message: A production-worthy message of the day\n</code></pre> <p>\u8003\u8651\u5230\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u522b\u65f6\u73af\u5883\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u53ef\u80fd\u4f1a\u4f7f\u6574\u4e2a\u6e89\u5ff5\u53d8\u5f97\u6709\u4e9b\u590d\u6742\u3002\u5982\u56fe\u6240\u793a\uff0c\u73af\u5883\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u6bd4\u89d2\u8272\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u4f4e\uff0c\u4f46\u6bd4\u83dc\u8c31\u914d\u65b9\u5355\u6216\u5c5e\u6027\u6587\u4ef6\u7684\u5c5e\u6027\u4f18\u5148\u7ea7\u9ad8 </p> <p></p> <p>\u7531\u4e8e\u73af\u5883\u53ef\u4ee5\u641c\u76d6\u5e76\u6307\u5b9a\u7279\u5b9a\u7684\u83dc\u8c31\u7248\u672c\uff0c\u73af\u5883\u7684\u5c5e\u6027\u4e5f\u5e94\u62e5\u6709\u6bd4\u9ed8\u8ba4\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7</p> <p>\u56e0\u6b64\u5728\u4f7f\u7528\u73af\u586b\u5c5e\u6027\u65f6\u5f80\u5f80\u4f7f\u7528<code>override attributes</code>\u800c\u4e0d\u662f<code>default attributes</code></p> <pre><code>override_attributes:\n  motd:\n    message: A production-worthy message of the day\n</code></pre>"},{"location":"chap1/chef_tutorial13_env/#3","title":"3\u3001\u5b8c\u6574\u5b9e\u4f8b","text":"<p><code>apache</code>\u83dc\u8c31\u5e76\u4f7f\u7528\u8981\u5728\u751f\u4ea7\u73af\u9b54\u5dfe\u7528\u5230\u7684\u73af\u5883\u548c\u89d2\u8272\u6765\u8fdb\u884c\u6b21\u5b8c\u6574\u7684\u5b9e\u4f8b\u3002 </p>"},{"location":"chap1/chef_tutorial13_env/#3-1","title":"3-1 \u6a21\u62df\u751f\u4ea7\u73af\u5883","text":"<p>\u521b\u5efa\u4e2a\u540d\u4e3a<code>cehf-zero</code>\u7684\u76ee\u5f55\u3002\u5176\u7ed3\u6784\u4e0e<code>chef-playgound</code>\u548c<code>chef-repo</code>\u5dee\u4e0d\u591a\u62e5\u6709<code>cookbooks</code>, <code>environments,</code> \u548c <code>roles</code>\u5b50\u76ee\u5f55\u53e3\u5728\u521b\u5efa\u8fd9\u4e2a\u76ee\u5f55\u540e\u5c06\u5176\u4f5c\u4e3a\u5de5\u4f5c\u76ee\u5f55\uff1a </p> <pre><code>$ mkdir chef-zero\n$ cd chef-zero\n</code></pre> <p>\u8ba9\u6211\u4eec\u5047\u8bbe\u6211\u4eec\u7684<code>apache</code>\u83dc\u8c31\u5df2\u7ecf\u51c6\u5907\u5c31\u7eea, \u6211\u4eec\u5c06\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u5c5e\u6027\u73af\u9b44\u548c\u89d2\u8272, \u9996\u5148\u8ba9\u6211\u4eec\u7528<code>Test Kitchen</code>\u6765\u6a21\u62df\u751f\u4ea7\u73af\u5883\u3002 </p> <p><code>chef-zero/environments</code>\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u73af\u5883\u5b9a\u4e49\u3002\u8fd9\u4f1a\u4ee3\u8868\u4e00\u4e2a<code>production</code>\uff08\u751f\u4ea7\uff09\u73af\u5883\uff0e\u5728\u6b64\u73af\u5883\u4e2d\u6211\u4eec\u4e5f\u5c06\u4ee5\u91cd\u5199\u7ea7\u522b\u5b9a\u4e49<code>node['motd']['message']</code>\u5c5e\u6027 </p> <p><code>chef-zero/environments/production.json</code></p> <pre><code>{\n  \"name\": \"production\",\n  \"description\": \"For prods!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.1.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\",\n  \"override_attributes\": {\n    \"motd\": {\n      \"message\": \"A production-worthy message of the day\"\n    }\n  }\n}\n</code></pre> <pre><code>$ mkdir roles\n$ touch /roles/webserver.json\n</code></pre> <p>\u6211\u4eec\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u4e00\u4e2a<code>webserver</code>\u89d2\u8272\u6765\u8868\u793a\u7f51\u9875\u670d\u52a1\u5668\u8282\u70b9\u3002\u521b\u5efa<code>chef-zero/roles/webserver.json</code>\u6587\u4ef6\u3002\u5b83\u7684\u8fd0\u884c\u6e05\u5355\u5305\u542b<code>apahce</code>\u914d\u65b9\u5355\u548c\u9ed8\u8ba4\u7ea7\u522b\u7684<code>node['apache']['port']</code>\u5c5e\u6027\u3002\u6211\u4eec\u5c06\u4f7f\u7528\u8fd9\u4e2a\u5c5e\u6027\u6765\u5c55\u793a\u5982\u4f55\u6839\u636e\u73af\u5883\u6539\u53d8\u83dc\u8c31\u7684\u884c\u4e3a </p> <p><code>chef-zero/roles/webserver.json</code></p> <pre><code>{\n  \"name\": \"webserver\",\n  \"description\": \"Web Server\",\n  \"json_class\": \"Chef::Role\",\n  \"chef_type\": \"role\",\n  \"default_attributes\": {\n    \"apache\": {\n      \"port\": 80\n    }\n  },\n  \"run_list\": [\n    \"recipe[apache]\"\n  ]\n}\n</code></pre> <pre><code>$ tree chef-zero/\nchef-zero/\n\u251c\u2500\u2500 cookbooks\n\u251c\u2500\u2500 environments\n\u2502   \u2514\u2500\u2500 production.json\n\u2514\u2500\u2500 roles\n    \u2514\u2500\u2500 webserver.json\n\n3 directories, 2 files\n</code></pre> <p>\u6211\u4eec\u5c06\u4e3a\u672c\u7ae0\u7684\u4f8b\u5b50\u521b\u5efa\u4e2a\u65b0\u7248\u672c\u7684<code>apache</code>\u83dc\u8c31\uff0c\u5411\u5b83\u6dfb\u52a0\u4e00\u4e9b\u65b0\u4e1c\u897f\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>chef generate cookbook</code>\u6216<code>knife cookbook create</code>\u547d\u4ee4\u521b\u5efa<code>apache</code>\u83dc\u8c31\u53d6\u51b3\u4e8e \u4f60\u4f7f\u7528<code>Chef</code>\u7814\u53d1\u5305\u8fd8\u662f\u5ba2\u6237\u7aef\u3002 </p> <p>Chef Development Kit:</p> <pre><code>$ cd cookbooks\n$ chef generate cookbook apache\n$ cd apache\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create apache --cookbook-path .\n$ cd apache\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p>\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u7528<code>chef_zero</code>\u542f\u52a8\u5668\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u7528\u5230<code>Chef</code>\u670d\u52a1\u5668\u7684\u529f\u80fd\u3002\u786e\u4fdd<code>provisoner\uff1a</code>\u677f\u5757\u8bbe\u5b9a\u4e86\u6b63\u786e\u7684\u503c\u3002\u6211\u4eec\u9700\u8981<code>Test Kitchen</code>\u4e3a\u6211\u4eec\u542f\u52a8<code>Chef Zero</code>\u5b9e\u4f8b\u3002 </p> <p>\u540c\u65f6\u5728<code>provisioner\uff1a</code>\u4e2d\uff0c\u544a\u8bc9<code>Test Kitchen</code>\u5728\u54ea\u91cc\u5bfb\u627e<code>roles</code>\u548c<code>environments</code>\u76ee\u5f55(\u76f8\u5bf9\u4e8e<code>kitchen.yml</code>\u7684\u4f4d\u7f6e\uff09: </p> <pre><code>provisioner:\n  name: chef_zero\n  nodes_path: ../../nodes\n  environments_path: ../../environments\n  always_update_cookbooks: true\n</code></pre> <p>\u6ce8\u610f\uff0c\u6211\u4eec\u5728<code>suites\uff1a</code>\u8bbe\u5b9a\u4e2d\u8bbe\u5b9a<code>Test Kitchen</code>\u5957\u4ef6\u540d\u5b57\u4e3a<code>prod</code></p> <p>\u6bcf\u4e00\u4e2a\u73af\u5883\u90fd\u4f1a\u62e5\u6709\u5b83\u81ea\u5df1\u7684\u6d4b\u8bd5\u5957\u4ef6\u914d\u7f6e\uff0c\u6211\u4eec\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u533a\u5206\u5b83\u4eec\u7684\u6d4b\u8bd5\u914d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u8bbe\u5b9a\u6d4b\u8bd5\u751f\u4ea7\u73af\u5883\u7684\u5957\u4ef6\u540d\u4e3a<code>prod</code></p> <p>\u540c\u65f6\uff0c\u6211\u4eec\u501f\u6b64\u4ecb\u7ecd<code>suites:</code>\u8bbe\u5b9a\u7684\u65b0\u8bed\u53e5\u3002</p> <p>\u901a\u8fc7<code>client_rb</code>\u548c<code>environment</code>\u8bed\u53e5\u4e3a\u6211\u4eec\u7684\u6c99\u76d2\u8282\u70b9\u5728\u5b83\u7684<code>/etc/chef/client.rb</code>\u4e2d\u8bbe\u5b9a\u73af\u5883 </p> <pre><code>suites:\n  - name: prod\n    provisioner:\n      client_rb:\n        environment: production\n  ...\n</code></pre> <p>\u4e00\u4e2a\u8282\u70b9\u5728\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u96b6\u5c5e\u4e8e\u4e00\u4e2a\u73af\u5883\u3002\u73af\u5883\u5728\u8282\u70b9\u7684<code>/etc/chef/client.rb</code>\u6587\u4ef6\u4e2d\u6307\u5b9a\u3002 \u5982\u679c\u6587\u4ef6\u4e2d\u6ca1\u6709\u8bbe\u5b9a\u73af\u5883\uff0c\u8282\u70b9\u5219\u4f7f\u7528\u9ed8\u8ba4\u73af\u5883\uff0c\u540d\u4e3a<code>defau1t</code>\u3002 </p> <p>\u5728\u6b64\u865a\u62df\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u7528<code>Test Kitchen</code>\u5c06\u60f3\u8981\u7684\u73af\u5883\u5199\u5230\u6d4b\u8bd5\u8282\u70b9\u7684<code>/etc/chef/client.rb</code>\u6587\u4ef6\u4e2d</p> <p>\u7136\u800c\u5728\u771f\u5b9e\u73af\u5883\u4e2d\uff0c\u5e94\u8be5\u7528<code>chef-client::config</code>\u914d\u65b9\u5355\u6765\u8bbe\u5b9a\u76ee\u6807\u8282\u70b9\u7684<code>/etc/chef/client.rb</code>\u6587\u4ef6\u4e2d\u7684<code>environment</code>\u8bbe\u5b9a\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u4ee5\u4e0b\u5c5e\u6027\u6765\u63a7\u5236\u8bbe\u5b9a\u7684<code>ssl_verify_node</code>\u4e00\u6837\uff1a </p> <pre><code>node.default['chef_client']['config']['environment'] = 'production'\n</code></pre> <p>\u4ee5\u4e0b\u4f8b\u5b50\u540c\u65f6\u5c55\u793a\u4e86\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>suites:</code>\u8bbe\u5b9a\u6765\u8bbe\u5b9a<code>private_network</code>\uff08\u79c1\u6709\u7f51\u7edc\uff09IP\u5730\u5740</p> <pre><code>suites:\n  - name: prod\n  ...\n  driver:\n    network:\n    - [\"private_network\", {ip: \"192.168.33.15\"}]\n</code></pre> <p>\u5f53\u4e00\u4e2a\u503c\u5728<code>Test Kitchen</code>\u7684<code>provisioner:</code>\u4e2d\u88ab\u8bbe\u5b9a\u65f6\u4f1a\u62ab\u7ee7\u627f\u5230\u6240\u6709<code>suites:</code>\u8bbe\u5b9a\u4e2d\uff0e</p> <p>\u5728\u672c\u4f8b\u4e2d\u6211\u4eec\u53ea\u60f3\u8981\u6211\u4eec\u751f\u4ea7\u73af\u63a9\u7684\u6d4b\u8bd5\u6c99\u76d2\u73af\u5883\u62e5\u6709\u4e0d\u540c\u7684IP\u5730\u5740\u56e0\u6b64\u6211\u4eec\u53ea\u5728<code>suites</code>\u4e0b\u6211\u4eec\u7684\u7279\u5b9a\u73af\u5883\u5185\u6307\u5b9a<code>private_network</code>\u8bbe\u5b9a </p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  nodes_path: ../../nodes\n  environments_path: ../../environments\n  always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: prod\n    provisioner:\n      client_rb:\n        environment: production\n    driver:\n      network:\n      - [\"private_network\", {ip: \"192.168.33.15\"}]\n    run_list:\n      - recipe[apache::default]\n    attributes:\n</code></pre> <p>\u4f7f\u7528<code>kitchen list</code>\u68c0\u67e5<code>kitchen.yml</code>\u5426\u6709\u8bed\u6cd5\u9519\u8bef\u3002\u8f93\u51fa\u5e94\u8be5\u548c\u4e00\u4e0b\u7c7b\u4f3c</p> <pre><code>$ kitchen list\nInstance       Driver   Provisioner  Verifier  Transport  Last Action    Last Error\nprod-centos65  Vagrant  ChefZero     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre> <p>\u7f16\u8f91<code>apache/metadata.rb</code>\u6587\u4ef6, \u586b\u5165<code>maintainer</code>, <code>maintainer_email</code>, and <code>license</code>\u4fe1\u606f\u3002</p> <pre><code>name 'apache'\nmaintainer 'ja xi'\nmaintainer_email 'jx@ss.com'\nlicense 'All Rights Reserved'\ndescription 'Installs/Configures apache'\nlong_description 'Installs/Configures apache'\nversion '0.1.0'\nchef_version '&gt;= 14.0'\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u4f1a\u5728\u8fbe\u4e2a\u7248\u672c\u7684<code>apache</code>\u83dc\u8c31\u4e2d\u4f7f\u7528\u5c5e\u6027\u8bf7\u521b\u5efa<code>default.rb</code>\u5c5e\u6027\u6587\u4ef6\u3002 </p> <p>Chef Development Kit:</p> <pre><code>$ chef generate attribute default\n</code></pre> <p>Chef Client:</p> <pre><code>$ touch attributes/default.rb\n</code></pre> <pre><code>$ chef generate attribute default\nRecipe: code_generator::attribute\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/attributes] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/attributes\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/attributes/default.rb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/attributes/default.rb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/attributes/default.rb from none to e3b0c4\n    (diff output suppressed by config)\n</code></pre> <p>\u5982\u793a\u4f8b<code>attributes/default.rb</code>\u4e2d\u8bbe\u5b9a\u4e00\u4e9b\u9ed8\u8ba4\u5c5e\u6027\u3002\u4e3a\u4e86\u5c55\u793a\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u6211\u4eec\u5728\u8fd9\u8bbe\u5b9a<code>node['apache']['port']</code>\u548c<code>node['motd']['message']</code>\u7684\u9ed8\u8ba4\u503c\u4e95\u8bbe\u5b9a\u6210\u4e0e\u5728\u89d2\u8272\u548c\u73af\u5883\u6587\u4ef6\u4e2d\u4e0d\u540c\u7684\u503c\u53e3\u6211\u4eec\u540c\u65f6\u4e5f\u6dfb\u52a0\u4e86\u4e00\u4e2a<code>node['apache']['document_root']</code>\u5c5e\u6027\u6765\u8bbe\u5b9a\u7f51\u9875\u670d\u52a1\u5668<code>index.html</code>\u6587\u4ef6\u7684\u4f4d\u7f6e</p> <pre><code>touch attributes/default.rb\n</code></pre> <p><code>/apache/attributes/default.rb</code></p> <pre><code>default['apache']['document_root'] = '/var/www/html'\ndefault['apache']['port'] = 3333\ndefault['motd']['message'] = 'Default message'\n</code></pre>"},{"location":"chap1/chef_tutorial13_env/#recipesdefaultrb","title":"<code>recipes/default.rb</code>","text":"<p>\u52a0\u4e00\u4e2a\u65b0\u7684<code>template</code>\u8d44\u6e90\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u521b\u5efa<code>custom.conf</code>\u6587\u4ef6\u4ee5\u53ca<code>directory</code>\u8d44\u6e90\u4ee5\u521b\u5efa\u6240\u9700\u7684\u76ee\u5f55\u3002</p> <p><code>custom.conf</code>\u5373\u53ef\u662f\u4e00\u4e2a\u914d\u7f6e<code>apache</code>\u7f51\u9875\u670d\u52a1\u5668\u8bbe\u5b9a\u7684\u53ef\u9009\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u5728\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u5c06\u8bbe\u5b9a\u9ed8\u8ba4\u7684\u76d1\u542c\u7aef\u53e3\u548c\u6587\u6863\u6839\u76ee\u5f55\u3002 </p> <pre><code>template '/etc/httpd/conf.d/custom.conf' do\n  ...\n  variables(\n    :document_root =&gt; node['apache']['document_root'],\n    :port =&gt; node['apache']['port']\n  )\n  ...\nend\n</code></pre> <p>\u5728\u521b\u5efa\u6a21\u677f\u6587\u4ef6\u65f6, \u4f60\u53ef\u4ee5\u901a\u8fc7<code>varibales()</code>\u5c5e\u6027\u4f20\u9012\u4e00\u4e2a\u6620\u5c04\u6765\u6307\u5b9a\u6a21\u677f\u4e2d\u53d8\u91cf\u7684\u503c\u3002 \u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u4ece\u914d\u65b9\u5355\u4e2d\u4f20\u9012\u53d8\u91cf\u7ed9\u6a21\u677f\uff0c \u4f7f\u6a21\u677f\u4e2d\u4e5f\u53ef\u4ee5\u4f7f\u7528\u66f4\u77ed\u7684\u53d8\u91cf\u540d</p> <p><code>apache/recipes/default.rb</code></p> <pre><code>#\n# Cookbook Name:: apache\n# Recipe:: default\n#\n# Copyright (C) 2014\n#\n#\n#\n\npackage 'httpd'\n\nservice 'httpd' do\n  action [ :enable, :start ]\nend\n\n# Add a template for Apache virtual host configuration\ntemplate '/etc/httpd/conf.d/custom.conf' do\n  source 'custom.erb'\n  mode '0644'\n  variables(\n    :document_root =&gt; node['apache']['document_root'],\n    :port =&gt; node['apache']['port']\n  )\n  notifies :restart, 'service[httpd]'\nend\n\ndocument_root = node['apache']['document_root']\n\n# Add a directory resource to create the document_root\ndirectory document_root do\n  mode '0755'\n  recursive true\nend\n\ntemplate \"#{document_root}/index.html\" do\n  source 'index.html.erb'\n  mode '0644'\n  variables(\n    :message =&gt; node['motd']['message'],\n    :port =&gt; node['apache']['port']\n  )\nend\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate template index.html\n</code></pre> <p>Chef Client - Linux/Mac OS X:</p> <pre><code>$ touch templates/default/index.html.erb\n</code></pre> <pre><code>$ chef generate template index.html\nRecipe: code_generator::template\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/templates] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/templates\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/templates/index.html.erb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/templates/index.html.erb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap11/chef-zero/cookbooks/apache/templates/index.html.erb from n\none to e3b0c4\n    (diff output suppressed by config)\n</code></pre> <p><code>/templates/default/index.hmtl.erb</code></p> <pre><code>&lt;html&gt;\n  &lt;body&gt;\n    &lt;h1&gt;&lt;%= @message %&gt;&lt;/h1&gt;\n    &lt;%= node[\"ipaddress\"] %&gt;:&lt;%= @port %&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate template custom\n</code></pre> <p>Chef Client - Linux/Mac OS X:</p> <pre><code>$ touch templates/default/custom.erb\n</code></pre> <p>\u586b\u5145\u6587\u4ef6\u5185\u5bb9\u3002\u6211\u4eec\u4f7f\u7528\u8fd9\u4e2a<code>apache</code>\u914d\u7f6e\u6587\u4ef6\u6765\u8bbe\u5b9a\u7f51\u9875\u670d\u52a1\u5668\u76d1\u542c\u7684\u7aef\u53e3\uff08<code>Listen</code>\u8bbe\u7f6e\uff09\u4ee5\u53ca<code>DocumentRoot</code>\u8bbe\u7f6e\u3002 </p> <p>\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u901a\u8fc7<code>&lt;% %&gt;</code>\u683c\u5f0f\u5199\u6761\u4ef6\u903b\u8f91\uff08\u800c\u7528<code>\uff1c\uff05= %&gt;</code>\u6765\u8868\u793a\u53d8\u91cf\uff09\u3002</p> <p>\u540c\u65f6\uff0c\u5982\u679c\u7ed3\u5c3e\u7684\u7b26\u53f7\u4ee5\u6a2a\u6760\u5f00\u5934\uff0c\u6bd4\u5982<code>-%&gt;</code>\u8fd9\u4e00\u884c\u5c06\u4e0d\u4f1a\u88ab\u6e32\u67d3\u5728\u8f93\u51fa\u7684\u6587\u4ef6\u4e2d\u3002</p> <p>\u8fd9\u4e09\u884c\u5c06\u88ab\u5904\u7406<code>&lt;% if @port != 80 -%&gt;</code>, Listen <code>&lt;%= @port %&gt;</code> and <code>&lt;% end -%&gt;</code>\u800c\u4e0d\u4f1a\u90fd\u8f93\u51fa\u3002\u5f53\u8f93\u51fa\u6700\u540e\u7684\u7ed3\u679c\u6587\u4ef6\u65f6\uff0c\u8fd9\u4e09\u884c\u53d8\u4e3a\u4e00\u884cListen <code>&lt;%= @port %&gt;</code>\u56e0\u4e3a\u5176\u4ed6\u4e24\u884c\u7684\u7ed3\u5c3e\u7b26\u53f7\u4e3a <code>-%&gt;</code>, \u540c\u65f6, \u8f93\u51fa\u7684\u8fd9\u4e00\u884c\u53ea\u6709\u5f53<code>if</code>\u8bed\u65ec\u4e2d\u7684\u6761\u4ef6\u8fd4\u56de\u771f\u65f6\u624d\u4f1a\u5761\u8f74\u51fa\u5426\u5219\u5c06\u4f1a\u88ab\u7565\u8fc7</p> <p>\u6211\u4eec\u9700\u8981\u8fbe\u6837\u7684\u6761\u4ef6\u903b\u8f91\u56e0\u4e3a<code>apache</code>\u53ea\u6709\u5728\u76d1\u542c\u7aef\u53e3\u4e0d\u4e3a<code>80</code>\u65f6\u624d\u9700\u8981\u5728\u914d\u7f6e\u6587\u95e8\u4e2d\u6307\u5b9a <code>Listen</code>\u914d\u7f6e\u3002\u5982\u679c\u7aef\u53e3<code>80</code>\u4e95\u5728<code>Listen</code>\u4e2d\u6307\u5b9a\uff0c<code>apache</code>\u5c06\u4f1a\u62a5\u9519\u3002</p> <p><code>/templates/default/custom.erb</code></p> <pre><code>&lt;% if @port != 80 -%&gt;  \n  Listen &lt;%= @port %&gt; \n&lt;% end -%&gt;\n\n&lt;VirtualHost *:&lt;%= @port %&gt;&gt;\n  ServerAdmin webmaster@localhost\n\n  DocumentRoot &lt;%= @document_root %&gt;\n  &lt;Directory /&gt;\n    Options FollowSymLinks\n    AllowOverride None\n  &lt;/Directory&gt;\n  &lt;Directory &lt;%= @document_root %&gt;&gt;\n    Options Indexes FollowSymLinks MultiViews\n    AllowOverride None\n    Order allow,deny\n    allow from all\n  &lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>\u8fd9\u4e00\u884c\u4e0d\u4f1a\u5199\u5165\u5230\u6700\u7ec8\u8f93\u51fa\u7684\u6587\u4ef6 </li> <li>\u53ea\u6709\u8fd9\u4e00\u884c\u5c06\u4f1a\u5199\u5165\u5230\u8f93\u51fa\u7684\u6587\u4ef6 </li> <li>\u8fd9\u4e00\u884c\u4e0d\u5199\u5165\u5230\u6700\u7ec8\u8f93\u51fa\u51fa\u7684\u6587\u4ef6 </li> </ul> <p></p>"},{"location":"chap1/chef_tutorial13_env/#3-2","title":"3-2 \u6a21\u62df\u5f00\u53d1\u73af\u5883","text":"<p>\u5047\u8bbe\u6211\u4eec\u8981\u5bf9<code>apache</code>\u83dc\u8c31\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684\u5f00\u53d1\u5468\u671f\uff0c \u52a0\u4e00\u4e9b\u65b0\u7684\u529f\u80fd\u3002\u5bf9\u4e8e\u672c\u620f\u7684\u5c55\u793a\u610f\u56fe \u6211\u4eec\u4e0d\u5728\u4e4e\u65b0\u529f\u80fd\u5177\u4f53\u662f\u4ec0\u4e48\uff0c \u53ea\u5e0c\u671b\u65b0\u7684\u5f00\u53d1\u4e0d\u4f1a\u5f62\u54cd\u73b0\u6709\u7684\u751f\u4ea7\u73af\u5883\u4e0b\u7684<code>0.1.0</code>\u7248\u672c\u7684\u83dc\u8c10\u3002\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a<code>dev</code>\u73af\u5883\u8fdb\u884c\u5f00\u53d1</p> <p><code>apache/metadata.rb</code></p> <pre><code>name             'apache'\nmaintainer       'Mischa Taylor'\nmaintainer_email 'mischa@misheska.com'\nlicense          'MIT'\ndescription      'Installs/Configures apache'\nlong_description 'Installs/Configures apache'\nversion          '0.2.0'\n</code></pre> <pre><code>$ kitchen converge prod-centos65\n...\n       Missing Cookbooks:\n       ------------------\n       Could not satisfy version constraints for: apache\n...\nChef Client failed. 0 resources updated in 1.626076356 seconds\n       [2014-08-22T17:59:26-07:00] ERROR: 412 \"Precondition Failed \"\n       [2014-08-22T17:59:26-07:00] FATAL: Chef::Exceptions::ChildConvergeError:\n       Chef run process exited unsuccessfully (exit code 1)\n&gt;&gt;&gt;&gt;&gt;&gt; Converge failed on instance &lt;prod-centos65&gt;.\n&gt;&gt;&gt;&gt;&gt;&gt; Please see .kitchen/logs/prod-centos65.log for more\ndetails\n&gt;&gt;&gt;&gt;&gt;&gt; ------Exception-------\n&gt;&gt;&gt;&gt;&gt;&gt; Class: Kitchen::ActionFailed\n&gt;&gt;&gt;&gt;&gt;&gt; Message: SSH exited (1) for command: [sudo -E\nchef-client -z --config /tmp/kitchen/client.rb --log_level info\n--chef-zero-port 8889 --json-attributes /tmp/kitchen/dna.json]\n&gt;&gt;&gt;&gt;&gt;&gt; ----------------------\n</code></pre> <p><code>environments/dev.json</code></p> <pre><code>{\n  \"name\": \"dev\",\n  \"description\": \"For developers!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.2.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\",\n  \"override_attributes\": {\n    \"apache\": {\n      \"port\": 8080\n    },\n    \"motd\": {\n      \"message\": \"Developers, developers, developers!\"\n    }\n  }\n}\n</code></pre> <p><code>apache/.kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  nodes_path: ../../nodes\n  environments_path: ../../environments\n  # always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: prod\n    provisioner:\n      client_rb:\n        environment: production\n    driver:\n      network:\n      - [\"private_network\", {ip: \"192.168.33.15\"}]\n    run_list:\n      - recipe[apache::default]\n    attributes:\n\n  - name: dev\n    provisioner:\n      client_rb:\n        environment: dev\n    driver:\n      network:\n      - [\"private_network\", {ip: \"192.168.33.16\"}]\n    run_list:\n      - recipe[apache::default]\n    attributes:\n</code></pre> <pre><code>$ kitchen list\nInstance       Driver   Provisioner  Last Action\nprod-centos65  Vagrant  ChefZero     Converged\ndev-centos65   Vagrant  ChefZero     &lt;Not Created&gt;\n</code></pre> <pre><code>$ kitchen converge dev-centos65\n</code></pre> <p></p>"},{"location":"chap1/chef_tutorial13_env/#4","title":"4\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u521b\u5efa\u4e00\u4e2a\u5f00\u53d1\u73af\u5883 </li> <li>\u5c5e\u6027\u548c\u73af\u5883 </li> <li>\u5b8c\u6574\u5b9e\u4f8b</li> </ul> <pre><code>$ knife environment from file dev.json\n$ knife environment show dev\n$ knife environment show production\n$ chef generate template index.html\n$ chef generate template custom\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/","title":"\u7b2c\u5341\u56db\u8282 \u6d4b\u8bd5","text":"<ul> <li>\u91cd\u6e29Apache\u83dc\u8c31 </li> <li>\u4f7f\u7528<code>Serverspec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li><code>RSpec DSL</code>\u8bed\u6cd5 </li> <li>\u4f7f\u7528<code>Foodcritic</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5 </li> <li>\u4f7f\u7528<code>ChefSpec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u4f7f\u7528<code>Let</code>\u8fdb\u884c\u60f0\u6027\u6c42\u503c </li> <li>\u5728<code>spec_helper.rb</code>\u4e2d\u5171\u4eab\u6d4b\u8bd5\u4ee3\u7801</li> </ul> <p>\u5173\u4e8e\u6d4b\u8bd5\u4f7f\u7528\u7c7b\u4f3c<code>Chef</code>\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u53ef\u4ee5\u5e2e\u4f60\u5b9e\u73b050\uff05\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u9a8c\u8bc1\u3002\u56e0\u4e3a\u7531Chef\u8fdb\u884c \u7684\u57fa\u7840\u67b6\u6784\u81ea\u52a8\u5316\u5177\u5907\u53ef\u91cd\u590d\u6027\uff0c\u5b83\u5f88\u81ea\u7136\u5730\u4f7f\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u73af\u5883\u66f4\u5bb9\u6613\u8fdb\u884c\u6d4b\u8bd5\u3002</p> <p>\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u5c31\u4ecb\u7ecd<code>Test Kitchen</code>\u7684\u539f\u56e0\uff0c\u8fd9\u6837\u4f60\u53ef\u4ee5\u80fd\u5728\u5b9e\u8df5\u4e2d\u7406\u89e3\u5230\u8fd9\u4e2a\u6982\u5ff5\u3002\u5728\u6574\u672c\u4e66\u7684\u5404\u4e2a\u7ae0\u8282\u4e2d\uff0c\u90fd\u4f7f\u7528<code>Test Kitchen</code>\u5c06<code>Chef</code>\u4ee3\u7801\u90e8\u7f72\u5230\u672c\u5730\u7684\u6c99\u76d2\u6d4b\u8bd5\u73af\u5883\u5e76\u8fdb\u884c\u6d4b\u8bd5\u548c\u9a8c\u8bc1\uff0c\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u786e\u4fdd\u5982\u679c\u5c06\u540c\u6837\u7684\u4ee3\u7801\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff0c\u5176\u7ed3\u679c\u4e00\u6837\u3002 </p> <p>\u81ea\u52a8\u5316\u6d4b\u8bd5\u9664\u4e86\u4f7f\u7528<code>Chef</code>\u4ee5\u5916\u7684\u53e6\u591650%\uff0c\u5219\u662f\u5173\u4e8e\u6d4b\u8bd5\u548c\u90e8\u7f72\u81ea\u52a8\u5316\u4ee3\u7801\u7684\u7b56\u7565\u3002\u5c31\u50cf\u5728\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u65f6\u6700\u597d\u4e00\u70b9\u4e00\u70b9\u6e10\u8fdb\u5f0f\u90e8\u7f72\u4e00\u6837\uff0c\u5728\u6700\u7406\u60f3\u7684\u60c5\u51b5\u4e0b\uff0c\u90e8\u7f72\u57fa\u7840\u67b6\u6784\u7684\u6539\u53d8\u4e00\u6837\u4e5f\u6700\u597d\u662f\u4e00\u6b65\u4e00\u6b65\u6e10\u8fdb\u5f0f\u8fdb\u884c\u3002\u56fe\u5c55\u793a\u4e86\u7406\u60f3\u7684\u6e10\u8fdb\u5f0f\u5f00\u53d1-\u6d4b\u8bd5\u4e00\u90e8\u7f72\u5468\u671f\u3002\u8fd9\u6837\u7684\u7b56\u7565\u53ef\u4ee5\u5e2e\u52a9\u4fdd\u8bc1\u5b8c\u6210\u8db3\u591f\u7684\u6d4b\u8bd5\uff0c\u4ece\u800c\u5f97\u5230\u9ad8\u8d28\u91cf\u7684\u57fa\u7840\u67b6\u6784\u548c\u5e94\u7528\u7a0b\u5e8f\u3002 </p> <p></p> <p>\u6e10\u8fdb\u5f0f\u77ed\u671f\u5f00\u53d1\u5468\u671f\u76f8\u53cd\u7684\u957f\u671f\u5f00\u53d1\u5468\u671f\uff08\u5f00\u53d1\u5b8c\u5f88\u5927\u7684\u65b0\u529f\u80fd\u518d\u8003\u8651\u90e8\u7f72\uff09\u4e2d\uff0c\u4f60\u5f88\u96be\u9884\u6d4b\u4ec0\u4e48\u65f6\u5019\u5f00\u53d1\u7ed3\u675f\uff1b\u800c\u5982\u679c\u6d4b\u8bd5\u7559\u5728\u6700\u540e\u4e00\u523b\u624d\u8fdb\u884c\uff0c\u5f80\u5f80\u9700\u8981\u4f7f\u7528\u66f4\u957f\u7684\u65f6\u95f4\u6d4b\u8bd5\u5f88\u5927\u7684\u65b0\u529f\u80fd\uff1b\u56e0\u800c\u6d4b\u8bd5\u65f6\u95f4\u5f80\u5f80\u88ab\u7f29\u77ed\u800c\u727a\u7272\u4ea7\u54c1\u8d28\u91cf\u3002</p> <p>\u8fd9\u6837\u7684\u4e60\u60ef\u540c\u6837\u4f1a\u5f62\u6210\u201c\u5e94\u7528\u5f00\u53d1\u5b8c\u4e86\uff0c\u73b0\u5728\u8ba9\u8fd0\u7ef4\u53bb\u90e8\u5427\u201d\u8fd9\u6837\u7684\u60c5\u5f62\u2015\u5e94\u7528\u5728\u5f00\u53d1\u73af\u5883\u5b8c\u7f8e\u8fd0\u884c\uff0c\u5374\u65e0\u6cd5\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fd0\u4f5c\u3002\u7c7b\u4f3c<code>Chef</code>\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5c1d\u8bd5\u89e3\u51b3\u7684\u6b63\u662f\u8fd9\u4e2a\u95ee\u9898\u3002 </p> <p></p> <p>\u518d\u8005\uff0c\u5bfb\u627e\u548c\u4fee\u590d\u8f6f\u4ef6\u548c\u57fa\u7840\u67b6\u6784\u4ee3\u7801\u4e2d\u7684\u95ee\u9898\u662f\u9700\u8981\u6210\u672c\u7684\uff0c\u800c\u4e14\u53d1\u73b0\u95ee\u9898\u7684\u65f6\u95f4\u8d8a\u63a5\u8fd1\u5468\u671f\u7ed3\u675f\u4fee\u590d\u8fd9\u4e9b\u95ee\u9898\u7684\u6210\u672c\u5c31\u8d8a\u9ad8\u3002\u56fe\u5c55\u793a\u4e86\u5728\u5f00\u53d1\u6d41\u7a0b\u4e2d\u4fee\u590d\u95ee\u9898\u7684\u76f8\u5bf9\u6210\u672c\u3002\u5728\u8fd9\u4e2a\u89d2\u5ea6\u770b\uff0c\u57fa\u7840\u67b6\u6784\u4ee3\u7801\u9075\u5faa\u540c\u6837\u7684\u9053\u7406\uff1a </p> <ul> <li>\u9700\u6c42 </li> <li>\u8bbe\u8ba1 </li> <li>\u5f00\u53d1</li> <li>\u5f00\u53d1\u6d4b\u8bd5 </li> <li>\u6574\u5408\u6d4b\u8bd5 </li> <li>\u751f\u4ea7\u73af\u5883 </li> </ul> <p></p> <p>\u5728\u9700\u6c42\u548c\u8bbe\u8ba1\u9636\u6bb5\u5bfb\u627e\u548c\u89e3\u51b3\u95ee\u9898\u5e76\u4e0d\u662f\u90a3\u4e48\u6602\u8d35\uff0c \u7136\u800c\u5728\u540e\u9762\u9636\u6bb5\u8d70\u5f7b\u8d8a\u8fdc\uff0c\u4fee\u590d\u95ee\u9898\u7684\u6210\u672c\u5219\u8d8a\u9ad8\u3002</p> <p>\u7b49\u5230\u6240\u6709\u5f00\u53d1\u4ee3\u7801\u90fd\u5b8c\u6210\u65f6\u518d\u5c1d\u8bd5\u5bfb\u627e\u95ee\u9898\uff0c \u76f8\u6bd4\u4e00\u65e9\u5c31\u53d1\u73b0\u95ee\u9898\u9700\u8981\u7684\u6210\u672c\u82b1\u8d39\u8981\u9ad8\u51fa20\u81f350\u500d.</p> <p>\u5982\u679c\u4ee3\u7801\u5df2\u7ecf\u90ce\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff0c \u4fee\u590d\u95ee\u9898\u7684\u82b1\u8d39\u76f8\u6bd4\u65e9\u671f\u9ad8150\u500d</p> <p>\u8fd9\u5e94\u8be5\u63d0\u9192\u4f60\u5728\u505aChe\u9887\u76ee\u65f6\u5e94\u505a\u5230\u4ee5\u4e0b\u51e0\u70b9\u3002 </p> <ol> <li>\u7b2c\u4e00\u6b21\u5c31\u505a\u5bf9\u4ee5\u514d\u672a\u6765\u518d\u4fee\u590d\u95ee\u9898 </li> <li>\u8d8a\u65e9\u53d1\u73b0\u95ee\u5306\u8d8a\u597d\u8d8a\u63a5\u8fd1\u5199\u4ee3\u7801\u7684\u65f6\u65cf\u5c31\u53d1\u781a\u95ee\u8d8a\u8d8a\u7acb\u597d </li> <li>\u5c3d\u53ef\u80fd\u505a\u6e10\u8fdb\u5f0f\u7684\u5c0f\u6539\u53d8\u80e1\u8bd5\u5c0f\u7684\u6539\u53d8\u8981\u5bb9\u6613\u5f88\u591a </li> </ol> <p><code>Chef</code>\u5305\u542b\u53ef\u4ee5\u5e2e\u4f60\u505a\u5230\u8fbe\u4e9b\u76ee\u6807\u7684\u6d4b\u8bd5\u5de5\u5176\u3002\u6240\u793a<code>Chef</code>\u63d0\u4f9b\u591a\u79cd\u4fa7\u8bd5\u5de5\u5177\u5728\u4f60\u64b0\u5199\u83dc\u8c31\u65f6\u5c3d\u65e9\u5bf9\u4ee3\u7801\u4e2d\u7684\u95ee\u9898\u63d0\u4f9b\u53cd\u9988 </p> <p></p> <p>\u6709\u591a\u79cd\u4e0d\u540c\u7684\u6d4b\u8bd5\u5de5\u5177\uff0c\u56e0\u4e3a\u662f\u6bcf\u4e2a\u5de5\u5177\u9488\u5bf9\u83dc\u8c31\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u7684\u7279\u5b9a\u9636\u6bb5\u3002\u4ee5\u4e0b\u662f\u5bf9\u6bcf \u79cd\u6d4b\u8bd5\u5de5\u5177\u7684\u6982\u89c8\u4ee5\u53ca\u4f60\u5e94\u8be5\u5728\u4ec0\u4e48\u65f6\u5019\u4f7f\u7528\u5b83\uff1a</p> <ul> <li>\u5728\u7f16\u8f91\u5668\u4e2d\u6253\u5165Chef\u4ee3\u7801\u7684\u65f6\u5019 </li> <li>\u4f7f\u7528<code>Foodcritic</code>\u53ef\u4ee5\u5206\u6790\u4f60\u7684<code>Chef</code>\u7f16\u7a0b\u98ce\u683c\u3002 </li> <li>\u5728\u90e8\u7f72\u5230\u6d4b\u8bd5\u8282\u70b9\u4e4b\u524d </li> <li>\u4f7f\u7528<code>ChefSpec</code>\u53ef\u4ee5\u5e2e\u52a9\u4f60\u4fdd\u8bc1\u4ee3\u7801\u7684\u7ec4\u7ec7\u548c\u6587\u6863\u7b26\u5408\u6807\u51c6\u3002 </li> <li>\u5728\u90e8\u7f72\u5230\u6d4b\u8bd5\u8282\u70b9\u540e </li> <li>\u4f7f\u7528<code>Serverspec</code>\u9a8c\u8bc1\u83dc\u8c31\u4ea7\u751f\u7684\u884c\u4e3a\u4e0e\u9884\u671f\u76f8\u7b26\u3002 </li> </ul> <p>\u5982\u679c\u4f7f\u7528<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u9700\u8981\u5b89\u88c5\u4e00\u4e9b\u989d\u5916\u7684Ruby\u5e94\u7528\u6765\u652f\u6301\u81ea\u52a8\u5316\u6d4b\u8bd5\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\u672c\u7ae0\u6240\u9700\u7684\u5de5\u5177\uff1a </p> <pre><code>$ sudo gem install foodcritic --no-ri --no-rdoc\n$ sudo gem install chefspec --no-ri --no-rdoc\n</code></pre> <p>\u5982\u679c\u662fChef\u5f00\u53d1\u5305\uff0c\u90a3\u5b83\u5df1\u7ecf\u5305\u542b\u6240\u6709\u6240\u9700\u5de5\u5177\u4e86\u3002 </p>"},{"location":"chap1/chef_tutorial14_test/#1apache","title":"1\u3001\u91cd\u6e29Apache\u83dc\u8c31","text":"<p>Generate a cookbook called apache-test.</p> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook apache-test\n$ cd apache-test\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create apache-test --cookbook-path .\n$ cd apache-test\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p><code>apache-test/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n      network:\n      - [\"private_network\", {ip: \"192.168.33.38\"}]\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[apache-test::default]\n    attributes:\n</code></pre> <p><code>apache-test/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: apache-test\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\npackage \"httpd\"\n\nservice \"httpd\" do\n  action [ :enable, :start ]\nend\n\ntemplate \"/var/www/html/index.html\" do\n  source 'index.html.erb'\n  mode '0644'\nend\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate template index.html\n</code></pre> <p>Chef Client:</p> <pre><code>$ touch templates/default/index.html.erb\n</code></pre> <p>\u5728\u6a21\u62df\u6d4b\u8bd5\u8282\u70b9\u4e0a\u6709\u4e09\u4e2a\u7f51\u7edc\u754c\u9762<code>lo</code>,<code>eth0</code>,<code>eth1</code> <code>ERB</code>\u4e2d\u7684\u811a\u672c\u5c06\u6e32\u67d3\u4ee5\u4e0b\u8f93\u51fa\uff1a </p> <ul> <li>lo</li> <li>eth0</li> <li>eth1</li> </ul> <p>\u63d0\u793a\uff1a\u5728ERB\u6a21\u677f\u4e2d\u8981\u4ed4\u7ec6\u5206\u8fa8<code>\uff1c% %\uff1e</code>\u548c<code>\uff1c\uff05=\uff05\uff1e</code>\u3002</p> <p><code>ERB</code>\u6a21\u677f\u4e2d\u4e0d\u5305\u542b\u7b49\u53f7\u7684<code>\uff1c% %\uff1e</code>\u6807\u7b7e\u4f5c\u4e3a\u811a\u672c\u6267\u884c\uff1b\u8bed\u53e5\u6267\u884c\uff0c\u4f46\u4e0d\u4f5c\u4e3a\u5b57\u7b26\u4e32\u6e32\u67d3\u5230\u8f93\u51fa\u6587\u4ef6\u4e2d\u3002\u7136\u540e\uff0c\u6211\u4eec\u4f7f\u7528\u5e26\u6709\u7b49\u53f7\u7684ERB\u6807\u7b7e<code>\uff1c%= %\uff1e</code>\u5728\u811a\u672c\u7684\u6761\u4ef6\u7b26\u5408\u65f6\u8f93\u51fa\u5176\u7ed3\u679c\u3002 </p> <p><code>apache-test/templates/default/index.hmtl.erb</code></p> <pre><code>&lt;html&gt;\n&lt;body&gt;\n&lt;pre&gt;&lt;code&gt;\nThis site was set up by &lt;%= node['hostname'] %&gt;\nMy network addresses are:\n&lt;% node['network']['interfaces'].keys.each do |iface_name| %&gt;\n  * &lt;%= iface_name %&gt;:\n      &lt;%= node['network']['interfaces'][iface_name]['addresses'].keys[1] %&gt;\n&lt;% end %&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <pre><code>kitchen converge\n</code></pre> <p></p>"},{"location":"chap1/chef_tutorial14_test/#2serverspec","title":"2\u3001\u4f7f\u7528<code>Serverspec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5","text":""},{"location":"chap1/chef_tutorial14_test/#2-1-serverspec","title":"2-1 \u64b0\u5199\u4f60\u7684\u7b2c\u4e00\u4e2a<code>Serverspec</code>\u6d4b\u8bd5","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Test kitchen</code>\u4f1a\u5728<code>test/integration</code>\u5b50\u76ee\u5f55\u4e2d\u5bfb\u627e\u76f8\u5173\u7684\u6587\u4ef6.</p> <p><code>Serverspec</code>\u5728<code>test/integration</code>\u76ee\u5f55\u4e0b\u7684\u4e00 \u4e9b\u5b50\u76ee\u5f55\u4e2d\u5b88\u627e\u5b83\u7684\u6d4b\u8bd5\u6587\u4ef6\u3002</p> <p>\u9996\u5148\uff0c\u5728<code>test/integration</code>\u76ee\u5f55\u4e0b\u9700\u8981\u9488\u5bf9\u6bcf\u4e2a\u6d4b\u8bd5\u5957\u4ef6\u7684\u540d\u5b57(<code>suite name</code>)\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684\u6d4b\u8bd5\u76ee\u5f55\uff1a</p> <pre><code>&lt;cookbook_root&gt;\n\u2514\u2500\u2500 test\n    \u2514\u2500\u2500 integration\n        \u2514\u2500\u2500 &lt;suite_name&gt;\n</code></pre> <p>\u5957\u4ef6\uff08<code>suite</code>) \u7684\u540d\u5b57\u53ef\u4ee5\u5728<code>kitchen.yml</code>\u6587\u4ef6\u4e2d\u7684<code>suites:</code>\u90e8\u5206\u627e\u5230\u3002  <code>default</code>\u662f\u9ed8\u8ba4\u751f\u6210\u7684\u5957\u4ef6\u540d\u5b57\u3002 </p> <p>Linux/Mac OS X:</p> <pre><code>$ mkdir -p test/integration/default\n</code></pre> <p>Windows:</p> <pre><code>&gt; mkdir test\\integration\\default\n</code></pre> <p>\u6839\u636e\u7ea6\u5b9a\uff0c<code>Serverspec</code>\u9884\u671f\u5305\u542b\u6d4b\u8bd5\u4ee3\u7801\u7684\u6587\u4ef6\u4ee5<code>spec.rb</code>\u7ed3\u5c3e\u3002\u5982\u793a\u4f8b16-4\u6240\u793a\uff0c\u8ba9\u6211\u4eec \u5728<code>default/serverspec/default_spec.rb</code>\u5b50\u76ee\u5f55\u4e2d\u521b\u5efa<code>default_spec.rb</code>\u6587\u4ef6\u3002 </p> <pre><code>set :backend, :exec\n\ndescribe 'web site' do\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\nend\n</code></pre> <pre><code>require 'serverspec' 1\n\nset :backend, :exec 2\n\ndescribe 'web site' do 3\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\nend\n</code></pre> <ol> <li><code>require</code>\u8bed\u53e5\u7528\u6765\u52a0\u8f7d<code>serverspec</code>\u7684<code>gem</code>\u5e93\uff0c\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u5f15\u7528<code>Serverspec</code>\u7684\u7c7b\u548c\u65b9\u6cd5\uff0c\u6bd4\u5982set\u65b9\u6cd5\u3002 </li> <li><code>set</code>\u8bed\u53e5\u8ba9\u6211\u4eec\u914d\u7f6e<code>serverspec</code>\u5982\u4f55\u8fd0\u884c\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u5c06<code>:backend</code>\u5c5e\u6027\u8bbe\u5b9a\u4e3a<code>:exec</code>\u6765\u544a\u8bc9<code>serverspec</code>\u6d4b\u8bd5\u4ee3\u7801\u5c06\u4f1a\u5728\u540c\u4e00\u53f0\u673a\u5668\u8fd0\u884c\u3002 </li> <li>\u6d4b\u8bd5\u7528<code>RSpec DSL</code>\uff08\u9886\u57df\u4e13\u7528\u8bed\u8a00\uff09\u5199\uff0c\u4f7f\u7528<code>describe</code>\u548c<code>it</code>\u8bed\u53e5\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528<code>RSpec DSL</code>\u5199\u68c0\u67e5\u7f51\u7ad9\u662f\u5426\u4f7f\u7528<code>TCP</code>\u534f\u8bae\u76d1\u542c<code>80</code>\u7aef\u53e3\uff08HTTP\u7f51\u7ad9\u9ed8\u8ba4\u7aef\u53e3\uff09\u7684\u6d4b\u8bd5\u3002 </li> </ol> <p>\u6211\u4eec\u5c06\u7a0d\u540e\u5728<code>\u201crspec-syntax</code>\u201d\u4e2d\u8fdb\u4e00\u6b65\u89e3\u91ca<code>RSpec DSL</code>\u4ee5\u53ca\u6d4b\u8bd5\u8bed\u6cd5\u7ed3\u6784\u3002\u73b0\u5728\uff0c\u53ea\u9700\u8981\u660e\u767d\u8fd9\u6bb5\u4ee3\u7801\u662f\u7528\u6765\u6d4b\u8bd5\u67d0\u4e2a\u670d\u52a1\u76d1\u542c\u4e86<code>80</code>\u7aef\u53e3\u5c31\u597d\u3002 \u8981\u8fd0\u884c\u8fd9\u6bb5\u4fa7\u8bd5\u4ee3\u7801\uff0c\u9996\u5148\u9700\u8981\u786e\u4fdd\u6240\u6709\u7684<code>gem</code>\u6587\u4ef6\u5728\u6d4b\u8bd5\u8282\u70b9\u4e00\u90fd\u5df2\u7ecf\u5b89\u88c5\u597d\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>kitchen setup</code>\u547d\u4ee4\u3002\u73b0\u5728\u8fd0\u884c<code>kitchen setup:</code> </p> <pre><code>$ kitchen setup\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Setting up &lt;default-centos65&gt;...\n       Finished setting up &lt;default-centos65&gt; (0m0.00s).\n-----&gt; Kitchen is finished. (0m0.73s)\n</code></pre> <p>\u4e00\u65e6\u6d4b\u8bd5\u8282\u70b9\u62e5\u6709\u6240\u6709\u7684\u6d4b\u8bd5\u5e93\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>kitchen verify</code>\u547d\u4ee4\u6765\u8fd0\u884c\u4fa7\u8bd5\u3002\u8bf8 \u73b0\u5728\u5c31\u8bd5\u8bd5\u3002\u5982\u679c\u4ee3\u7801\u6ca1\u6709\u8bed\u6cd5\u9519\u8bef\uff0c\u8f93\u51fa\u5e94\u8be5\u663e\u793a\u7f51\u7ad9\u6b63\u5e38\u8fd0\u884c\u4e95\u54cd\u5e9480\u7aef\u53e3\uff1a </p> <pre><code>$ kitchen verify\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Installing Busser (busser)\n       Fetching thor-0.19.0.gem\n       Fetching busser-0.7.1.gem\n       Successfully installed thor-0.19.0\n       Successfully installed busser-0.7.1\n       2 gems installed\n-----&gt; Installing Busser plugin: busser-serverspec\n       Plugin serverspec installed (version 0.5.10)\n-----&gt; Running postinstall for serverspec plugin\n       Suite path directory /tmp/verifier/suites does not exist, skipping.\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n-----&gt; Installing Serverspec..\n       Fetching rspec-expectations-3.9.0.gem\n       Fetching rspec-3.9.0.gem\n       Fetching multi_json-1.14.1.gem\n       Fetching net-scp-2.0.0.gem\n       Fetching rspec-mocks-3.9.0.gem\n       Fetching rspec-its-1.3.0.gem\n       Fetching net-ssh-5.2.0.gem\n       Fetching diff-lcs-1.3.gem\n       Fetching serverspec-2.41.5.gem\n       Fetching net-telnet-0.1.1.gem\n       Fetching specinfra-2.82.4.gem\n       Fetching sfl-2.3.gem\n-----&gt; serverspec installed (version 2.41.5)\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80\n\n       Finished in 0.05453 seconds (files took 0.27863 seconds to load)\n       1 example, 0 failures\n\n       Finished verifying &lt;default-centos65&gt; (0m14.66s).\n-----&gt; Kitchen is finished. (0m15.13s)\n</code></pre> <p>\u524d\u9762\u5c55\u793a\u4e86\u4f60\u53ef\u4ee5\u4f7f\u7528<code>RSpc DSL</code>\u6d4b\u8bd5\u4ee3\u7801\u6765\u4ee3\u66ff\u624b\u52a8\u9a8c\u8bc1\u786e\u4fdd\u83dc\u8c31\u6b63\u786e\u8fd0\u4f5c</p> <pre><code>$ kitchen login\nLast login: Mon Dec  9 10:01:56 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ sudo service httpd stop\nStopping httpd:                                            [  OK  ]\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <pre><code>$ kitchen verify\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Busser installation detected (busser)\n-----&gt; Busser plugin detected: busser-serverspec\n       Removing /tmp/verifier/suites/serverspec\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80 (FAILED - 1)\n\n       Failures:\n\n         1) web site responds on port 80\n            Failure/Error: expect(port 80).to be_listening 'tcp'\n              expected Port \"80\" to be listening\n              /bin/sh -c netstat\\ -tunl\\ \\|\\ grep\\ --\\ :80\\\\\\ \n\n            # /tmp/verifier/suites/serverspec/default_spec.rb:7:in `block (2 levels) in &lt;top (required)&gt;'\n\n       Finished in 0.0632 seconds (files took 0.27264 seconds to load)\n       1 example, 1 failure\n\n       Failed examples:\n\n       rspec /tmp/verifier/suites/serverspec/default_spec.rb:6 # web site responds on port 80\n\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec failed\n       !!!!!! Ruby Script [/tmp/verifier/gems/gems/busser-serverspec-0.5.10/lib/busser/runner_plugin/../serverspec/runner.rb /tmp/verifier/suites/serverspec] exit code was 1\n&gt;&gt;&gt;&gt;&gt;&gt; ------Exception-------\n&gt;&gt;&gt;&gt;&gt;&gt; Class: Kitchen::ActionFailed\n&gt;&gt;&gt;&gt;&gt;&gt; Message: 1 actions failed.\n&gt;&gt;&gt;&gt;&gt;&gt;     Verify failed on instance &lt;default-centos65&gt;.  Please see .kitchen/logs/default-centos65.log for more details\n&gt;&gt;&gt;&gt;&gt;&gt; ----------------------\n&gt;&gt;&gt;&gt;&gt;&gt; Please see .kitchen/logs/kitchen.log for more details\n&gt;&gt;&gt;&gt;&gt;&gt; Also try running `kitchen diagnose --all` for configuration\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230<code>Chef</code>\u53d1\u73b0<code>httpd</code>\u670d\u52a1\u6ca1\u6709\u8fd0\u884c\u540e\u5c06\u5176\u5f00\u542f </p> <pre><code>$ kitchen converge\n</code></pre> <pre><code>$ kitchen verify\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Setting up &lt;default-centos65&gt;...\n       Finished setting up &lt;default-centos65&gt; (0m0.00s).\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Busser installation detected (busser)\n-----&gt; Busser plugin detected: busser-serverspec\n       Removing /tmp/verifier/suites/serverspec\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80\n\n       Finished in 0.03277 seconds (files took 0.2189 seconds to load)\n       1 example, 0 failures\n\n       Finished verifying &lt;default-centos65&gt; (0m1.07s).\n-----&gt; Kitchen is finished. (0m1.60s)\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#3rspec-dsl","title":"3\u3001RSpec DSL\u8bed\u6cd5","text":"<p>\u5728\u7ee7\u7eed\u5b66\u4e60\u5982\u4f55\u4f7f\u7528<code>Serverspec</code>\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u5148\u6765\u770b\u770b<code>RSpec DSL</code>\u8bed\u6cd5\u7684\u57fa\u7840\uff0c\u597d\u8ba9\u4f60\u4e86\u89e3<code>Serverspec</code>\u6d4b\u8bd5\u7684\u8bed\u6cd5\u57fa\u7840\u3002 </p> <p><code>RSpec DSL</code>\u4f7f\u7528<code>describe</code>\u4ee3\u7801\u5757\u5305\u542b\u4e00\u7ec4\u6d4b\u8bd5\u3002\u6bcf\u4e2a<code>describe</code>\u4ee3\u7801\u5757\u7531\u4ee5\u4e0b\u683c\u5f0f\u5b9a\u4e49\uff1a </p> <pre><code>describe '&lt;entity&gt;' do\n  &lt;tests here&gt;\nend\n</code></pre> <p><code>describe</code>\u4ee3\u7801\u5757\u7684\u7528\u9014\u662f\u5c06\u6d4b\u8bd5\u6839\u636e\u610f\u56fe\u5206\u7ec4\u5e76\u63cf\u8ff0\u88ab\u6d4b\u8bd5\u7684\u5b9e\u4f53\u3002\u6bcf\u4e2a\u5206\u7ec4\u7684\u63cf\u8ff0\u4f5c\u4e3a\u5b57\u7b26\u4e32\u4f20\u9012\u7ed9<code>describe</code>\u3002\u8fd9\u4e2a\u5b57\u7b26\u4e32\u63cf\u8ff0\u662f\u7ed9\u8fd0\u884c\u6d4b\u8bd5\u7684\u4eba\u4f5c\u4e3a\u6587\u6863\u5728\u6d4b\u8bd5\u8f93\u51fa\u4e2d\u67e5\u770b\u3002\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b<code>describe</code>\u4ee3\u7801\u5757\u6765\u6ce8\u660e\u6b63\u5728\u6d4b\u8bd5\u6211\u4eec\u7684\u7f51\u7ad9\uff1a </p> <pre><code>describe 'web site' do\n  &lt;tests here&gt;\nend\n</code></pre> <p>\u8bf4\u660e\uff1aRSpec DSL\u5728\u5e55\u540e\u4e3a\u8fd9\u4e9b\u4ee3\u7801\u5757\u521b\u5efaRuby\u7c7b\u4e3a\u6d4b\u8bd5\u5206\u7ec4\u3002 </p> <p>\u5b9e\u9645\u7684\u6d4b\u8bd5\u4ee3\u7801\u5728<code>describe</code>\u4ee3\u7801\u5757\u91cc\u9762\u7684<code>it</code>\u4ee3\u7801\u5757\u4e2d\u5b9a\u4e49\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a </p> <pre><code>describe '&lt;entity&gt;' do\n  it '&lt;description&gt;'\n    &lt;examples here&gt;\n  end\nend\n</code></pre> <p><code>it</code>\u4ee3\u7801\u5757\u4e5f\u63a5\u53d7\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570\u6765\u4ef6\u4e3a\u8be5\u5177\u4f53\u7684\u6d4b\u8bd5\u7684\u6587\u6863</p> <p>\u63d0\u4f9b\u5b57\u7b26\u4e32<code>responds on port 80</code>\u5373\u6765\u8bf4\u660e\u6211\u4eec\u7684\u6d4b\u8bd5\u68c0\u67e5\u7f51\u7ad9\u662f\u5426\u5728<code>80</code>\u7aef\u53e3\u4e0b\u8fd0\u884c</p> <pre><code>describe 'web site' do\n  it 'responds on port 80' do\n    ...\n  end\nend\n</code></pre> <p>\u5728<code>RSpec 3.0</code>\uff08\u5f53\u524d\u7684Chf\u5f00\u53d1\u5305\u53ca\u5ba2\u6237\u7aef\u5305\u542b\u7684\u7248\u672c\uff09\u4e2d, \u6d4b\u8bd5\u5e94\u8be5\u4ee5<code>expect</code>\u683c\u5f0f\u5199 </p> <pre><code>describe '&lt;entity&gt;' do\n  it '&lt;description&gt;'\n    expect(resource).to matcher matcher_parameter\n  end\nend\n</code></pre> <p>\u8d44\u6e90(<code>resource</code>)\uff0c\u4e5f\u79f0\u4e3b\u9898(<code>subject</code>\uff09\u6216\u547d\u4ee4\uff08<code>command</code>)\uff0c\u662f<code>expect</code>\u4ee3\u7801\u5757\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\uff0c\u5b83\u4ee3\u8868\u88ab\u6d4b\u8bd5\u7684\u5b9e\u4f53\u3002\u8bf8\u5982<code>Serverspec</code>\u548c<code>ChefSpec</code>\u7684\u6d4b\u8bd5\u6846\u67b6\u63d0\u4f9b\u7279\u5b9a\u7684\u8d44\u6e90\u6765 \u6267\u884c\u5e7f\u6cdb\u7684\u9a8c\u8bc1\u3002</p> <p>\u5339\u914d\u5668\uff08<code>matcher</code>\uff09\u7528\u6765\u5b9a\u4e49\u5bf9\u4e8e\u8d44\u6e90\u7684\u7b49\u540c\u6216\u76f8\u53cd\u7684\u671f\u5f85\u503c\u3002\u5b83\u7684\u683c\u5f0f\u4ee5<code>expect(\u8d44\u6e90\uff09.to</code> \u6765\u8868\u793a\u671f\u5f85\u8be5\u8d44\u6e90\u7b49\u540c\u4e8e\u5339\u914d\u5668\u7ed3\u679c\uff0c\u4ee5\u53ca\u4ee5<code>expect\uff08\u8d44\u6e90).not_to</code>\u8868\u793a\u671f\u5f85\u8be5\u8d44\u6e90\u7684\u7ed3\u679c\u76f8\u53cd\u4e8e\u5339\u914d\u5668\u7ed3\u679c\u3002</p> <p>\u5728\u6211\u4eec\u4f7f\u7528\u7684\u6d4b\u8bd5\u6846\u67b6\u4e2d\u4e5f\u63d0\u4f9b\u6709\u7279\u5b9a\u7528\u9014\u7684\u5339\u914d\u5668\u3002 \u6211\u4eec\u4f7f\u7528<code>port</code>\u8d44\u6e90\uff08\u4f20\u9012<code>80</code>\u4f5c\u4e3a\u53c2\u6570\uff09\u548c<code>be_listening</code>\u5339\u914d\u5668\uff08\u4f20\u9012<code>tcp</code> \u4f5c\u4e3a\u53c2\u6570\uff09\u6765\u68c0\u67e5\u7f51\u7ad9\u662f\u5426\u5728<code>80</code>\u7aef\u53e3\u901a\u8fc7<code>TCP</code>\u534f\u8bae\u8fd0\u884c\uff1a </p> <pre><code>describe 'web site' do\n  it 'responsponds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\nend\n</code></pre> <p>\u5982\u4f55\u77e5\u9053\u7c7b\u4f3c<code>port</code>\u7684\u8d44\u6e90\u548c<code>be_listening</code>\u5339\u914d\u5668\u7684\u5b58\u5728\u5462?\u6211\u4eec\u53c2\u8003\u4e86<code>Serverspec</code>\u6d4b\u8bd5 \u6846\u67b6\u7684<code>Serverspec</code>\u6587\u6863\uff08<code>http://serverspec.org</code>)\uff0c\u5176\u4e2d\u5217\u4e3e\u4e86\u5b83\u63d0\u4f9b\u7684\u8d44\u6e90\u548c\u5339\u914d\u5668\u7c7b\u3002 \u5728\u7f51\u9875\u9876\u7aef\u70b9\u51fb<code>Resource Types</code>\u94fe\u63a5\uff0c\u4f60\u4f1a\u770b\u5230\u6307\u5411<code>Serverspec</code>\u8d44\u6e90\u7684\u94fe\u63a5</p> <p></p> <p></p> <p>\u56fe\u5c55\u793a\u5982\u4f55\u5c06\u65e7\u6587\u6863\u63d0\u4f9b\u7684<code>sould</code>\u683c\u5f0f\u4ee3\u7801\u8f6c\u6362\u4e3a<code>expect</code>\u683c\u5f0f\u3002</p> <p></p> <p>\u5728<code>sould</code>\u683c\u5f0f\u4e2d\uff0c \u8d44\u6e90\u5728<code>it</code>\u8bed\u53e5\u5916\u90e8\u7684<code>describe</code>\u8bed\u53e5\u4e2d\u5b9a\u4e49\u3002</p> <p>\u5728<code>expect</code>\u683c\u5f0f\u4e2d\uff0c\u5b83\u4ee5\u53c2\u6570\u4f20\u9012\u7ed9<code>expect</code></p> <p><code>should</code>\u683c\u5f0f\u4e2d,<code>should</code>\u6216<code>should not</code>\u7528\u6765\u8868\u8fbe\u9884\u671f\u7ed3\u679c\u5e94\u7b49\u540c\u6216\u76f8\u53cd</p> <p>\u5728<code>expect</code>\u683c\u5f0f\u4e2d\uff0c\u9884\u671f\u7ed3\u679c\u4ee5<code>.to</code>\u6216<code>.not_to</code>\u65b9\u6cd5\u8868\u8fbe\u3002\u6700\u540e\uff0c\u5728<code>should</code>\u683c\u5f0f\u4e2d\uff0c\u5339\u914d\u5668\u7684\u53c2\u6570\u4f20\u9012\u8fdb<code>.with()</code>\u65b9\u6cd5, \u800c\u5728<code>expect</code>\u683c\u5f0f\u4e2d\uff0c\u5b83\u53ea\u662f\u5339\u914d\u4e00\u4e2a\u53c2\u6570\u3002</p>"},{"location":"chap1/chef_tutorial14_test/#4serverspec","title":"4\u3001Serverspec\u8be6\u89e3","text":"<p>\u4f9b\u591a\u4e2a\u4fa7\u8bd5\u6587\u4ef6\u5171\u4eab\u7684\u4ee3\u7801\u53ef\u4ee5\u79fb\u5230<code>spec_helper.rb</code>\u6587\u4ef6\u4e2d, \u5728\u672c\u4f8b\u4e2d\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u4f46\u73b0\u5728\u8bf7\u5047\u8bbe\u6211\u4eec\u6709\u591a\u4e2a\u6d4b\u8bd5\u6587\u4ef6\u3002 \u6ce8\u610f\u8fd9\u4e2a\u6587\u4ef6\u5305\u542b<code>default_spec.rb</code>\u6587\u4ef6\u7684\u524d\u3002</p> <p>\u6ce8\u610f\u8fd9\u4e2a\u6587\u4ef6\u5305\u542b<code>default_spec.rb</code>\u6587\u4ef6\u524d\u4e24\u884c\uff0c\u5982\u679c\u6211\u4eec\u6709\u591a\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u8fd9\u4e24\u884c\u9700\u8981\u7531\u6240\u6709\u6d4b\u8bd5\u6267\u884c\u8fdb\u884c\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u5176\u79fb\u5230\u6240\u6709\u4fa7\u8bd5\u5171\u4eab\u7684<code>spec_helper.rb</code>\u6587\u4ef6\u4e2d\u4ee5\u514d\u9700\u8981\u91cd\u590d\u591a\u4e2a\u6d4b\u8bd5\u6587\u4ef6\u4e2d\u5b9a\u4e49</p> <p>`apache-test/test/integration/default/serverspec/spec_helper.rb</p> <pre><code>require 'serverspec'\n\nset :backend, :exec\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709\u4e86<code>spec_helper.rb</code>\u6587\u4ef6\uff0c\u4fee\u6539<code>default_spec.rb</code>\u6765\u4f7f\u7528<code>spec_helper</code>\uff0c \u6539\u53d8<code>require</code>\u8bed\u53e5\u5e76\u5220\u9664<code>set</code>\u8bed\u53e5\uff0c </p> <p><code>/test/integration/default/serverspec/default_spec.rb</code></p> <pre><code>require 'spec_helper'\n\ndescribe 'web site' do\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\nend\n</code></pre> <p>\u867d\u7136\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u91cc\u4f7f\u7528<code>spec_helper.rb</code>\u6709\u70b9\u591a\u6b64\u4e00\u4e3e\uff0c\u4f46\u5e0c\u671b\u4f60\u80fd\u7406\u89e3\u8fd9\u4e2a\u6587\u4ef6\u7684\u610f\u56fe\u4e00\u5728\u6709\u591a\u4e2a\u6d4b\u8bd5\u6587\u4ef6\u7684\u65f6\u5019\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5c06\u5171\u4eab\u4ee3\u7801\u5b58\u653e\u5230\u540c\u4e00\u4e2a\u6587\u4ef6\u4e2d\u4ee5\u514d\u5728\u6240\u6709\u6d4b\u8bd5\u6587\u4ef6\u4e2d\u91cd\u590d\u3002 </p> <p>\u5728\u6d4b\u8bd5\u4ee3\u7801\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5728\u6bcf\u4e2a<code>describe</code>\u4ee3\u7801\u5757\u4e2d\u5305\u542b\u591a\u4e2a\u6d4b\u8bd5\uff0c\u4e8b\u5b9e\u4e0a\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u6bcf\u4e2a<code>describe</code>\u4e5f\u901a\u5e38\u6709\u5f88\u591a\u6d4b\u8bd5\u8be5\u4e3b\u9898\u7684\u4e0d\u540c\u6848\u4f8b\u3002\u8ba9\u6211\u4eec\u5728<code>defauit_spec.rb</code>\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6d4b\u8bd5\u3002</p> <p>\u867d\u7136\u5199\u6d4b\u8bd5\u9a8c\u8bc1\u4e86\u7f51\u7ad9\u5728<code>80</code>\u7aef\u53e3\u8fd0\u884c\uff0c\u4f46\u6211\u4eec\u5e76\u6ca1\u6709\u9a8c\u8bc1\u7f51\u7ad9\u7684\u5185\u5bb9\u662f\u6b63\u786e\u7684\u3002\u8ba9\u6211\u4eec\u5199\u4e00\u4e2a\u6d4b\u8bd5\u6765\u9a8c\u8bc1\u5185\u5bb9\u3002</p> <p>curl</p> <p></p> <p>\u5982\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6d4b\u8bd5\u5230<code>default_spec.rb</code>\u6587\u4ef6\u3002\u901a\u8fc7\u8fd0\u884c<code>curl localhost</code>\u547d\u4ee4\uff0c\u4f60\u53ef\u4ee5\u68c0\u67e5\u7f51\u7ad9\u7684HTML\u8f93\u51fa\u6765\u9a8c\u8bc1\u5b83\u7684\u6b63\u786e\u6027\u3002 </p> <p>\u901a\u8fc7\u5728<code>command</code>\u8d44\u6e90\u4e0a\u4f7f\u7528<code>stdout</code>\u5c5e\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b<code>curl</code>\u547d\u4ee4\u8fd4\u56de\u7684\u7ed3\u679c\u3002\u6839\u636e\u7ea6\u5b9a\uff0c \u7a0b\u5e8f\u5c06\u5b83\u4eec\u7684\u8f93\u51fa\u751f\u6210\u5230\u4e24\u4e2a\u4e0d\u540c\u7684\u6807\u51c6\u6587\u4ef6\u53e5\u67c4\uff1a<code>stdout</code>\uff08\u6b63\u5e38\u7a0b\u5e8f\u8f93\u51fa\uff09\u548c<code>stderr</code>\uff08\u9519\u8bef\u8f93\u51fa\uff09\u3002\u8fd9\u6837\uff0c\u5176\u4ed6\u7a0b\u5e8f\u53ef\u4ee5\u6253\u5f00\u8fd9\u4e9b\u53e5\u67c4\u6765\u81ea\u52a8\u67e5\u770b\u5185\u5bb9\u3002</p> <p>\u6211\u4eec\u7684\u4f8b\u5b50\u5e76\u4e0d\u5728\u610f<code>stderr</code>\u4e2d\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u6211\u4eec\u7684\u4fa7\u8bd5\u4ee3\u7801\u6765\u8bb2\uff0c\u5982\u679c\u53d1\u751f\u9519\u8bef\uff0c\u5f97\u5230\u4e00\u4e2a<code>Ruby</code>\u5f02\u5e38\u5c31\u5df2\u7ecf\u8db3\u591f\u3002\u5728\u9519\u8bef\u60c5\u51b5\u4e0b\uff0c<code>Serverspec</code>\u81ea\u52a8\u751f\u6210\u8fd9\u6837\u7684\u9519\u8bef\u5f02\u5e38\u3002\u5728\u6211\u4eec\u7684\u6d4b\u8bd5\u4ee3\u7801\u4e2d\uff0c\u53ea\u5728\u610f<code>stdout</code>\u4e2d\u7684\u5185\u5bb9\u3002 </p> <p>\u8fd0\u884c<code>curl localhost:80</code>\u547d\u4ee4\u7684\u7ed3\u679c\u4ee5\u5b57\u7b26\u4e32\u8fd4\u56de\u3002</p> <p>\u6211\u4eec\u901a\u8fc7\u79f0\u4e3a\u6b63\u5219\u8868\u8fbe\u5f0f\u7684<code>Ruby</code>\u529f\u80fd\uff0c\u8ba9<code>RSpec</code>\u5339\u914d\u5668<code>match</code>\u6765\u5728<code>curl</code>\u7684\u6267\u884c\u7ed3\u679c\u4e2d\u641c\u7d22\u7279\u5b9a\u5185\u5bb9\u3002\u5728 Ruby\u4e2d\uff0c\u5305\u542b\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5b57\u7b26\u4e32\u88ab\u6b63\u659c\u6760\u5b57\u7b26\uff08<code>//</code>\uff09\u800c\u4e0d\u662f\u5355\u5f15\u53f7\uff08<code>''</code>\uff09\u6216\u53cc\u5f15\u53f7\uff08<code>\"\"</code>\uff09\u5f15\u7528\u3002 </p> <p>\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u5b57\u7b26\u4e32\u683c\u5f0f\uff0c\u7528\u6765\u6307\u5b9a\u641c\u7d22\u5b57\u7b26\u4e32\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5728\u8f93\u51fa\u4e2d\u641c\u7d22\u5b57\u7b26\u4e32\u5185\u5bb9<code>eth1</code>\u3002\u5728\u8bbe\u5b9a\u7f51\u7ad9\u5185\u5bb9\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c06\u7f51\u7edc\u754c\u9762\u7684\u5b57\u7b26\u4e32\u5305\u542b\u5728\u9875\u9762\u5185\u5bb9\u4e2d\uff0c\u5982\u679c\u9875\u9762\u5185\u5bb9\u4e0d\u5305\u542b\u5b57\u7b26\u4e32<code>eth1</code>\uff0c\u5219\u8bf4\u660e\u6b63\u786e\u7684\u5185\u5bb9\u672a\u88ab\u6e32\u67d3\u3002 \u540c\u65f6\uff0c\u68c0\u67e5<code>eth1</code>\u5b57\u7b26\u4e32\u540c\u65f6\u4fdd\u8bc1\u6211\u4eec\u7684\u6d4b\u8bd5\u8282\u70b9\u865a\u62df\u673a\u542f\u7528\u4e86<code>eth1</code>\u9002\u914d\u5668\u3002 </p> <p><code>apache-test/test/integration/default/serverspec/default_spec.rb</code></p> <pre><code>require 'spec_helper'\n\ndescribe 'web site' do\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\n\n  it 'returns eth1 in the HTML body' do\n    expect(command('curl localhost:80').stdout).to match /eth1/\n  end\nend\n</code></pre> <p>\u9996\u5148\uff0c\u4f7f\u7528<code>kitchen login</code>\u547d\u4ee4\u767b\u5f55\u5230\u6d4b\u8bd5\u8282\u70b9\uff0c\u5e76\u8fd0\u884c\u548c\u6211\u4eec\u6d4b\u8bd5\u4e2d\u540c\u6837\u7684<code>curl localhost:80</code>\u547d\u4ee4\u3002\u4ee5\u4e0b\u4f8b\u5b50\u5c55\u793a\u4e86\u8f93\u51fa\u7ed3\u679c\u3002\u590d\u5236\u8f93\u51fa\u7684\u7ed3\u679c\u5e76\u8fd0\u884c<code>exit</code>\u547d\u4ee4\u8fd4\u56de\u5f00\u53d1\u673a\u5668\uff1a </p> <pre><code>$ kitchen login\nLast login: Tue Dec 10 05:36:34 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ curl localhost:80\n&lt;html&gt;\n&lt;body&gt;\n&lt;pre&gt;&lt;code&gt;\nThis site was set up by default-centos65\nMy network addresses are:\n  * lo:\n      ::1\n  * eth0:\n      172.16.72.158\n  * eth1:\n      192.168.33.38\n&lt;/code&gt;&lt;/pre&gt;\n&lt;/body&gt;\n&lt;/html&gt;[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>https://rubular.com/</p> <p></p> <p></p> <pre><code>$ kitchen verify\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Busser installation detected (busser)\n-----&gt; Busser plugin detected: busser-serverspec\n       Removing /tmp/verifier/suites/serverspec\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80\n         returns eth1 in the HTML body\n\n       Finished in 0.04039 seconds (files took 0.21886 seconds to load)\n       2 examples, 0 failures\n\n       Finished verifying &lt;default-centos65&gt; (0m1.05s).\n-----&gt; Kitchen is finished. (0m1.69s)\n</code></pre> <p><code>package</code>\u8d44\u6e90\u9700\u8981<code>Serverspec</code>\u6765\u68c0\u6d4b\u64cd\u4f5c\u7cfb\u7edf\u4fe1\u606f\u3002\u5c55\u793a\u4e86<code>Serverspec</code>\u7f51\u7ad9\u4e2d\u5bf9 <code>service</code>\u8d44\u6e90\u7684\u6587\u6863\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u68c0\u6d4b\u67d0\u4e2a\u7a0b\u5e8f\u5305\u662f\u5426\u5df2\u7ecf\u5b89\u88c5\u3002\u5728\u5e55\u540e\uff0c\u5b83\u5176\u5b9e\u9996\u5148\u9700\u8981\u68c0\u6d4b\u662f\u4ec0\u8fd0\u884c\u4ec0\u4e48\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7136\u540e\u4f7f\u7528\u76f8\u5e94\u7684\u547d\u4ee4\uff0c\u6bd4\u5982\u5728<code>RedHat</code>\u4e2d\u7684<code>rpm -q</code>\u6216 <code>Ubuntu/Debian</code>\u4e2d\u7684<code>dpkg -query</code>\u67e5\u770b\u7a0b\u5e8f\u662f\u5426\u5df2\u7ecf\u5b89\u88c5\u3002 </p> <p></p> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Serverspec</code>\u8bd5\u56fe\u81ea\u52a8\u68c0\u6d4b\u64cd\u4f5c\u7cfb\u7edf\uff0c\u8fd9\u5728\u5927\u591a\u6570<code>Linux</code>\u548c<code>Unix</code>\u7cfb\u7edf\u4e2d\u6ca1\u6709 \u95ee\u9898\u3002\u7136\u800c\u5728\u67d0\u4e9b\u7cfb\u7edf\u4e2d\uff0c\u4f60\u9700\u8981\u901a\u8fc7<code>set</code>\u65b9\u6cd5\u91cd\u5199\u9ed8\u8ba4\u7684\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u7f6e\u3002 </p> <p>\u5982\u679c\u6d4b\u8bd5\u4ee3\u7801\u9700\u8981\u5728<code>Windows</code>\u4e0b\u8fd0\u884c\uff0c\u5c31\u9700\u8981\u5728<code>spec.rb</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u7801\uff0c\u56e0\u4e3a <code>Serverspec</code>\u5728\u6211\u4eec\u5199\u4f5c\u672c\u4e66\u65f6\u65e0\u6cd5\u81ea\u52a8\u68c0\u6d4b<code>Windows</code>\u64cd\u4f5c\u7cfb\u7edf\u3002\u66f4\u591a\u76f8\u5173\u4fe1\u606f\u53ef\u4ee5\u5728 <code>Serverspec</code>\u6587\u6863\u4e2d\u627e\u5230\u3002 </p> <p><code>/default/serverspec/default_spec.rb</code></p> <pre><code>require 'spec_helper'\n\ndescribe 'web site' do\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\n\n  it 'returns eth1 in the HTML body' do\n    expect(command('curl localhost:80').stdout).to match /eth1/\n  end\n\n  it 'has the apache web server installed' do\n    expect(package 'httpd').to be_installed\n  end\nend\n</code></pre> <pre><code>$ kitchen verify\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Busser installation detected (busser)\n-----&gt; Busser plugin detected: busser-serverspec\n       Removing /tmp/verifier/suites/serverspec\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80\n         returns eth1 in the HTML body\n         has the apache web server installed\n\n       Finished in 0.10077 seconds (files took 0.25413 seconds to load)\n       3 examples, 0 failures\n\n       Finished verifying &lt;default-centos65&gt; (0m1.23s).\n-----&gt; Kitchen is finished. (0m1.87s)\n</code></pre> <p>\u5982\u679c\u9700\u8981\u544a\u8bc9<code>Serverspec</code>\u6211\u4eec\u5177\u4f53\u8fd0\u884c\u7684\u662f\u54ea\u4e2a\u64cd\u4f5c\u7cfb\u7edf\uff08<code>CentOS 6</code>)\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0 \u4ee5\u4e0b\u4ee3\u7801\u4f7f\u7528<code>set</code>\u5173\u952e\u5b57\uff0c</p> <p><code>set :os, :family =&gt; 'redhat', :release =&gt; 6</code></p> <pre><code>require 'spec_helper'\n\nset :os, :family =&gt; 'redhat', :release =&gt; 6\n\ndescribe 'web site' do\n  it 'responds on port 80' do\n    expect(port 80).to be_listening 'tcp'\n  end\n\n  it 'returns eth1 in the HTML body' do\n    expect(command('curl localhost:80').stdout).to match /eth1/\n  end\n\n  it 'has the apache web server installed' do\n    expect(package 'httpd').to be_installed\n  end\nend\n</code></pre> <p><code>kitchen test</code>\u547d\u4ee4\u53ef\u4ee5\u6309\u987a\u5e8f\u6267\u884c\u4ee5\u4e0b\u5168\u90e8\u547d\u4ee4\uff1a </p> <ol> <li>kitchen destroy (if necessary)</li> <li>kitchen create</li> <li>kitchen converge</li> <li>kitchen setup</li> <li>kitchen verify</li> <li>kitchen destroy</li> </ol> <p>\u4f60\u6b63\u5728\u64b0\u5199\u6d4b\u8bd5\u4ee3\u7801\u7684\u65f6\u5019\u5f80\u5f80\u5e76\u4e0d\u60f3\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u56e0\u4e3a\u5f80\u5f80\u8fd8\u9700\u8981\u9891\u7e41\u767b\u5f55\u5230\u6d4b \u8bd5\u8282\u70b9\u4e0a\u8c03\u8bd5\u4ee5\u53ca\u5bfb\u627e\u6d4b\u8bd5\u4e2d\u7684\u95ee\u9898\u3002\u4f46\u7b49\u4e8e\u5199\u5b8c\u6240\u6709\u6d4b\u8bd5\u540e\uff0c\u5728<code>Jenkins</code>\u7b49\u7c7b\u4f3c\u81ea\u52a8\u5316\u7cfb\u7edf\u4e2d\u8bbe\u5b9a\u8fd0\u884c\u8fd9\u4e9b\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c<code>kitchen test</code>\u662f\u4e00\u4e2a\u65b9\u4fbf\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u7528\u6765\u6e05\u9664\u73b0\u6709\u73af\u5883\u3001\u521b\u5efa\u865a\u62df\u673a\u3001\u8fd0\u884c\u6d4b\u8bd5\u5e76\u5728\u8fd0\u884c\u540e\u518d\u6b21\u6e05\u7406\u73af\u5883\u3002</p> <p>\u540c\u65f6\uff0c\u5728\u64b0\u5199\u6d4b\u8bd5\u540e\u5e76\u5c06\u4ee3\u7801\u4e95\u5165\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u4e4b\u524d\uff0c\u5728\u5168\u65b0\u7684\u73af\u5883\u8fd0\u884c\u4e00\u6b21<code>kitchen test</code>\u8fd9\u4e5f\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u4e3b\u610f\u3002</p> <p>\u73b0\u5728\u8fd0\u884c    kitchen test    \u547d\u4ee4\u3002\u7ed3\u675f\u540e\u5b83\u4f1a\u81ea\u52a8\u5220\u9664\u6211\u4eec\u7684\u6d4b\u8bd5\u73af\u5883\uff0c\u56e0\u4e3a\u5b83\u81ea\u52a8\u8fd0\u884c\u4ee5\u4e0a\u4e94\u4e2a\u547d\u4ee4\uff1a  </p> <pre><code>$ kitchen test\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Cleaning up any prior instances of &lt;default-centos65&gt;\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m22.79s).\n-----&gt; Testing &lt;default-centos65&gt;\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Fixed port collision for 22 =&gt; 2222. Now on port 2201.\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2201\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2201\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m44.58s).\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[apache-test::default]\"]\n       Installing cookbooks for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap12/apache-test/Policyfile.rb using `chef install`\n       Installing cookbooks from lock\n       Installing apache-test 0.1.0\n       Updating policy lock using `chef update`\n       Attributes already up to date\n       Building policy apache-test\n       Expanded run list: recipe[apache-test::default]\n       Caching Cookbooks...\n       Installing apache-test &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap12/apache-test/Policyfile.lock.json\n       Policy revision id: ade7da2f2a1dcabbfcf963ab2cf6bd1157b44c9782565bcc6194ab8faf6d018c\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191210-14778-1x4b0g2...\n       Exported policy 'apache-test' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191210-14778-1x4b0g2\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191210-14778-1x4b0g2\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       el 6 x86_64\n       Getting information for chef stable  for el...\n       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64\n         to file /tmp/install.sh.3296/metadata.txt\n       trying wget...\n       trying curl...\n       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2\n       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473\n       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n       version  15.5.17\n       downloaded metadata file looks valid...\n       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n         to file /tmp/install.sh.3296/chef-15.5.17-1.el6.x86_64.rpm\n       trying wget...\n       trying curl...\n       Comparing checksum with sha256sum...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3296/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       Using policy 'apache-test' at revision 'ade7da2f2a1dcabbfcf963ab2cf6bd1157b44c9782565bcc6194ab8faf6d018c'\n       resolving cookbooks for run list: [\"apache-test::default@0.1.0 (daed588)\"]\n       Synchronizing Cookbooks:\n         - apache-test (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: apache-test::default\n         * yum_package[httpd] action install\n           - install version 0:2.2.15-69.el6.centos.x86_64 of package httpd\n         * service[httpd] action enable\n           - enable service service[httpd]\n         * service[httpd] action start\n           - start service service[httpd]\n         * template[/var/www/html/index.html] action create\n           - create new file /var/www/html/index.html\n           - update content in file /var/www/html/index.html from none to e9c94f\n           --- /var/www/html/index.html 2019-12-10 06:36:06.112501991 +0000\n           +++ /var/www/html/.chef-index20191210-3421-xm9pxz.html       2019-12-10 06:36:06.112501991 +0000\n           @@ -1 +1,15 @@\n           +&lt;html&gt;\n           +&lt;body&gt;\n           +&lt;pre&gt;&lt;code&gt;\n           +This site was set up by default-centos65\n           +My network addresses are:\n           +  * lo:\n           +      ::1\n           +  * eth0:\n           +      172.16.72.159\n           +  * eth1:\n           +      192.168.33.38\n           +&lt;/code&gt;&lt;/pre&gt;\n           +&lt;/body&gt;\n           +&lt;/html&gt;\n           - change mode from '' to '0644'\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 4/4 resources updated in 55 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (1m33.79s).\n-----&gt; Setting up &lt;default-centos65&gt;...\n       Finished setting up &lt;default-centos65&gt; (0m0.00s).\n-----&gt; Verifying &lt;default-centos65&gt;...\n       Preparing files for transfer\n-----&gt; Installing Busser (busser)\n       Fetching thor-0.19.0.gem\n       Fetching busser-0.7.1.gem\n       Successfully installed thor-0.19.0\n       Successfully installed busser-0.7.1\n       2 gems installed\n-----&gt; Installing Busser plugin: busser-serverspec\n       Plugin serverspec installed (version 0.5.10)\n-----&gt; Running postinstall for serverspec plugin\n       Suite path directory /tmp/verifier/suites does not exist, skipping.\n       Transferring files to &lt;default-centos65&gt;\n-----&gt; Running serverspec test suite\n-----&gt; Installing Serverspec..\n       Fetching rspec-expectations-3.9.0.gem\n       Fetching rspec-3.9.0.gem\n       Fetching multi_json-1.14.1.gem\n       Fetching diff-lcs-1.3.gem\n       Fetching rspec-mocks-3.9.0.gem\n       Fetching rspec-its-1.3.0.gem\n       Fetching net-ssh-5.2.0.gem\n       Fetching net-scp-2.0.0.gem\n       Fetching serverspec-2.41.5.gem\n       Fetching net-telnet-0.1.1.gem\n       Fetching specinfra-2.82.4.gem\n       Fetching sfl-2.3.gem\n-----&gt; serverspec installed (version 2.41.5)\n       /opt/chef/embedded/bin/ruby -I/tmp/verifier/suites/serverspec -I/tmp/verifier/gems/gems/rspec-support-3.9.0/lib:/tmp/verifier/gems/gems/rspec-core-3.9.0/lib /opt/chef/embedded/bin/rspec --pattern /tmp/verifier/suites/serverspec/\\*\\*/\\*_spec.rb --color --format documentation --default-path /tmp/verifier/suites/serverspec\n\n       web site\n         responds on port 80\n         returns eth1 in the HTML body\n         has the apache web server installed\n\n       Finished in 0.03509 seconds (files took 0.23573 seconds to load)\n       3 examples, 0 failures\n\n       Finished verifying &lt;default-centos65&gt; (0m15.53s).\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m21.31s).\n       Finished testing &lt;default-centos65&gt; (3m18.00s).\n-----&gt; Kitchen is finished. (3m18.69s)\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#5foodcritic","title":"5\u3001\u4f7f\u7528<code>Foodcritic</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5","text":"<p><code>Severspec</code>\u662f\u4e00\u4e2a\u7528\u4e8e\u6267\u884c\u83dc\u8c31\u7684\u70b9\u5bf9\u70b9\u6d4b\u8bd5\u7684\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\u3002\u7136\u800c\uff0c\u6267\u884c\u5168\u90e8\u6d4b\u8bd5\u53ef\u80fd\u9700\u8981\u8f83\u957f\u65f6\u95f4\uff0c\u800c\u6709\u4e9b\u9519\u8bef\u53ef\u4ee5\u5728\u6267\u884c\u8fd9\u7c7b\u6d4b\u8bd5\u4e4b\u524d\u66f4\u5feb\u53d1\u73b0\u3002\u6709\u4e00\u4e2a\u79f0\u4e3a<code>Foodcritic</code>\u7684\u5de5\u5177\u53ef\u4ee5\u5f88\u5feb\u63d0\u4f9b\u6709\u9650\u7684\u53cd\u9988\u3002 </p> <p><code>Foodcritic</code>\u88ab\u8bbe\u8ba1\u4e3a\u5728\u5199Chef\u4ee3\u7801\u65f6\u4f7f\u7528\uff0c\u5b83\u751a\u81f3\u53ef\u4ee5\u96c6\u6210\u5230\u7f16\u8f91\u5668\u4e2d\u3002\u5728\u5199<code>Chef</code>\u4ee3\u7801\u7684\u65f6\u5019\uff0c <code>Foodcritic</code>\u53ef\u4ee5\u7ed9\u4f60\u63d0\u4f9b\u5feb\u901f\u7684\u5173\u4e8e\u4ee3\u7801\u98ce\u683c\u7684\u53cd\u9988\uff0c\u8ba9\u4f60\u901a\u8fc7\u5b9a\u4e49\u89c4\u5219\uff08<code>rules</code>) \u6765\u6307\u5b9a\u7406\u60f3\u7684\u4ee3\u7801\u98ce\u683c\u3002  </p> <p>foodcritic.io</p> <p><code>Foodcritic</code>\u547d\u4ee4\u9700\u8981\u5728\u5f00\u53d1\u673a\u5668\u4e0a\u6267\u884c\uff0c\u800c\u4e0d\u662f\u6d4b\u8bd5\u8282\u70b9\uff0c\u56e0\u6b64\u975e\u5e38\u5feb\u3002\u53ef\u4ee5\u73b0\u5728\u5c31\u8bd5\u8bd5\u3002\u786e\u4fdd\u3002<code>apache-test</code>\u83dc\u8c31\u662f\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\uff0c\u7136\u540e\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002 </p> <p></p> <p>Chef Development Kit:</p> <pre><code>$ foodcritic .\n</code></pre> <p>Chef Client:</p> <pre><code>$ foodcritic .\nFC008: Generated cookbook metadata needs updating: ./metadata.rb:2\nFC008: Generated cookbook metadata needs updating: ./metadata.rb:3\n</code></pre> <pre><code>$ foodcritic .\nChecking 3 files\nx.x\nFC008: Generated cookbook metadata needs updating: ./metadata.rb:2\nFC008: Generated cookbook metadata needs updating: ./metadata.rb:3\nFC064: Ensure issues_url is set in metadata: ./metadata.rb:1\nFC065: Ensure source_url is set in metadata: ./metadata.rb:1\nFC067: Ensure at least one platform supported in metadata: ./metadata.rb:1\nFC078: Ensure cookbook shared under an OSI-approved open source license: ./metadata.rb:1\nFC093: Generated README text needs updating: ./README.md:1\n</code></pre> <pre><code>$ foodcritic .\nChecking 3 files\nx..\nFC064: Ensure issues_url is set in metadata: ./metadata.rb:1\nFC065: Ensure source_url is set in metadata: ./metadata.rb:1\nFC067: Ensure at least one platform supported in metadata: ./metadata.rb:1\nFC078: Ensure cookbook shared under an OSI-approved open source license: ./metadata.rb:1\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#6chefspec","title":"6\u3001\u4f7f\u7528<code>ChefSpec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5","text":"<p>\u53e6\u4e00\u4e2a\u53ef\u4ee5\u5e2e\u52a9\u5728\u5f00\u53d1\u5468\u671f\u65e9\u671f\u8fdb\u884c\u6d4b\u8bd5\u7684\u5de5\u5177\u662f<code>ChefSpec</code>, \u4f60\u751a\u81f3\u53ef\u4ee5\u5728\u5199\u4ee3\u7801\u524d\u5c31\u5148\u5b8c\u6210\u6d4b\u8bd5\u3002</p> <p><code>ChefSpec</code>\u53ef\u4ee5\u7528\u6765\u751f\u6210\u53ef\u8fd0\u884c\u7684\u6587\u6863\uff08<code>runnable documentation</code>). \u5b83\u8981\u7528\u9014\u662f\u5e2e\u52a9\u4f60\u66f4\u597d\u5730\u7ec4\u7ec7\u4ee3\u7801\u4ee5\u53ca\u5b8c\u5584\u6587\u6863\u3002 </p> <p>\u540c\u65f6\uff0c<code>ChefSpec</code>\u6d4b\u8bd5\u6709\u65f6\u4e5f\u80fd\u5728\u4f60\u66f4\u6539\u4ee3\u7801\u7684\u65f6\u5019\u5e2e\u52a9\u53d1\u73b0\u95ee\u9898\u3002\u800c\u4e14\uff0c\u4ee5\u6d4b\u8bd5\u9a71\u52a8\u7684<code>Chef</code>\u4ee3\u7801\u5f80\u5f80\u5177\u5907\u66f4\u9ad8\u7684\u8d28\u91cf\u3002 </p> <p>\u548c<code>Serverspec</code>\u7c7b\u4f3c\uff0c<code>ChefSpec</code>\u57fa\u4e8eRSpec. <code>ChefSpec</code>\u4f7f\u7528<code>RSpec</code>\u7684<code>describe</code>\u683c\u5f0f\u6765\u521b\u5efa\u53ef\u8fd0\u884c\u7684\u6587\u6863\u3002<code>ChefSpec</code>\u6587\u6863\u6240\u7528\u7684\u683c\u5f0f\u548c<code>Serverspec</code>\u7684\u7a0d\u6709\u4e0d\u540c\uff0c\u5982\u4e0b\u6240\u793a\uff1a </p> <pre><code>describe '&lt;recipe_name&gt;' do\n  &lt;perform in-memory Chef run&gt;\n  &lt;examples here&gt;\nend\n</code></pre> <p>\u4f8b\u5982\uff0c\u4f60\u4f1a\u4f7f\u7528\u4ee5\u4e0b<code>describe</code>\u4ee3\u7801\u5757\u6765\u5305\u542b\u9488\u5bf9<code>apache-test::default</code>\u83dc\u8c31\u7684\u6d4b\u8bd5\uff1a </p> <pre><code>describe 'apache-test::default' do\n  ...\nend\n</code></pre> <p>\u8981\u6267\u884c\u4e00\u6b21\u9a7b\u5185\u5b58\u7684<code>Chef</code>\u8fd0\u884c\uff0c\u9700\u8981\u4f7f\u7528<code>chef-spec gem</code>\u63d0\u4f9b\u7684\u7c7b\u6838\u65b9\u6cd5\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u8bed\u53e5 \u5230<code>describe</code>\u683c\u5f0f\u4e2d\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u8981\u6d4b\u8bd5<code>apache-test::default</code>\u83dc\u8c31\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4ee3 \u7801\uff1a </p> <pre><code>require 'chefspec'\n\ndescribe 'apache::default' do\n  chef_run = ChefSpec::Runner.new.converge('apache-test::default')\n  &lt;descriptions here&gt;\nend\n</code></pre> <p><code>ChefSpec</code>\u4f7f\u7528\u7c7b\u4f3c<code>Serverspec</code>\u7684<code>expect</code>\u683c\u5f0f\u3002<code>ChefSpec</code>\u62e5\u6709\u5176\u81ea\u5df1\u7684\u8d44\u6e90\u547d\u4ee4\u53ca\u5339\u914d\u5668\u3002\u4ee5\u4e0b\u8fd9\u4e2a\u4f8b\u5b50\u53ef\u4ee5\u5c55\u793a<code>ChefSpec</code>\u68c0\u67e5\u6211\u4eec\u7684<code>Chef</code>\u4ee3\u7801\uff0c\u770b\u662f\u5426\u5df2\u7ecf\u5b89\u88c5<code>httpd</code>\u7a0b\u5e8f \u5305\uff1a </p> <pre><code>require 'chefspec'\n\ndescribe 'apache::default' do\n  chef_run = ChefSpec::Runner.new.converge('apache-test::default')\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <p>\u8bb0\u4f4f\uff0c\u8fd9\u4e9b\u6d4b\u8bd5\u4ee3\u7801\u53ea\u662f\u7528\u6765\u4f5c\u4e3a\u53ef\u8fd0\u884c\u7684\u6587\u6863\u4f7f\u7528\u7684\u3002\u8fd9\u91cc\u7684<code>expect</code>\u8bed\u53e5\u5e76\u4e0d\u4f1a\u5728\u9a7b\u5185\u5b58\u7684<code>Chef</code>\u8fd0\u884c\u65f6\u6267\u884c<code>httpd</code>\u7a0b\u5e8f\u5305\u5b89\u88c5\u8fc7\u7a0b\u3002<code>ChefSpec</code>\u53ea\u662f\u901a\u8fc7\u9a7b\u5185\u5b58\u7684<code>Chef</code>\u8fd0\u884c\u6765\u9a8c\u8bc1\u83dc\u8c31\u8bed\u6cd5\u7ed3\u6784\uff1b</p> <p>\u5728\u672c\u4f8b\u4e2d\uff0c\u786e\u4fdd<code>Chef</code>\u4ee3\u7801\u6307\u793a<code>Chef</code>\u5b89\u88c5\u8fd9\u4e2a\u7a0b\u5e8f\u5305\u3002\u7b80\u800c\u8a00\u4e4b\uff0c\u6b64\u7c7b\u6d4b\u8bd5\u4e3b\u8981\u7528\u6765\u4f5c\u4e3a\u53ef\u8fd0\u884c\u7684\u4ee3\u7801\u6587\u6863\u6d4b\u8bd5\u4f60\u7684<code>Chef</code>\u4ee3\u7801\u5305\u542b\u9884\u671f\u7684\u5185\u5bb9\uff1b\u800c<code>Serverspec</code>\u6d4b\u8bd5\u5219\u7528\u6765\u771f\u6b63\u5728\u548c\u751f\u4ea7\u73af\u5883\u7c7b\u4f3c\u7684\u865a\u62df\u673a\u4e2d\u8fd0\u884c<code>Chef</code>\u5e76\u6d4b\u8bd5\u8fd0\u884c\u7ed3\u679c\u662f\u5426\u4e0e\u9884\u671f\u76f8\u7b26\u3002 </p> <p>\u5728<code>expect</code>\u683c\u5f0f\u4e2d\u4f7f\u7528\u7684<code>ChefSpec</code>\u7684\u8d44\u6e90\u547d\u4ee4\u901a\u5e38\u662f\u9a7b\u5185\u5b58<code>Chef</code>\u8fd0\u884c\u7684\u7ed3\u679c\u3002</p> <p><code>ChefSpec</code>\u7684\u5339\u914d\u5668\u7684\u8d44\u6e90\u53ef\u4ee5\u5728\u5176https://docs.chef.io/chefspec.html\u627e\u5230\uff0c </p> <p></p>"},{"location":"chap1/chef_tutorial14_test/#chefspec","title":"**\u64b0\u5199\u4f60\u7684\u7b2c\u4e00\u4e2a<code>ChefSpec</code>\u6d4b\u8bd5 **","text":"<p>\u8ba9\u6211\u4eec\u6765\u5199\u4e00\u4e9bChefSpec\u4ee3\u7801\u3002\u6211\u4eec\u5c06\u4f7f\u7528<code>install package</code>\u5339\u914d\u5668\uff0c <code>ChefSpec</code>\u6d4b\u8bd5\u7684\u9ed8\u8ba4\u4f4d\u7f6e\u662f\u83dc\u8c31\u76ee\u5f55\u4e0b\u7684<code>spec</code>\u76ee\u5f55\u3002\u786e\u4fdd<code>apache-test</code>\u83dc\u8c31\u76ee\u5f55\u662f\u5f53\u524d\u7684 \u5de5\u4f5c\u76ee\u5f55\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a<code>spec</code>\u76ee\u5f55\uff1a </p> <p>\u521b\u5efa<code>default_spec.rb</code>\u6587\u4ef6\u3002\u5305\u542b<code>ChefSpec</code>\u4ee3\u7801\u7684\u6587\u4ef6\u6839\u636e\u7ea6\u5b9a\u5e94\u4ee5<code>\uff0a_spec.rb</code>\u7ed3\u5c3e\u3002 </p> <p><code>spec/default_spec.rb</code></p> <pre><code>require 'chefspec'\n\ndescribe 'apache-test::default' do\n  chef_run = ChefSpec::Runner.new.converge('apache-test::default')\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <pre><code>$ rspec --color\n.\n\nFinished in 0.00042 seconds (files took 1.12 seconds to load)\n1 example, 0 failures\n</code></pre> <p>\u5f53rspec\u8fd0\u884c\u65f6\uff0c<code>ChefSpec</code>\u68c0\u67e5<code>Chef</code>\u4ee3\u7801\u5e76\u786e\u4fdd\u5b83\u5305\u542b<code>package</code>\u8d44\u6e90\u6765\u5b89\u88c5<code>httpd</code>\u7a0b\u5e8f\u5305\u3002 \u5982\u679c<code>ChefSpec</code>\u786e\u8ba4\u4ee3\u7801\u4e2d\u5305\u542b\u8fd9\u4e9b\u5185\u5bb9\uff0c\u6d4b\u8bd5\u5219\u901a\u8fc7\uff0c\u4f60\u53ef\u4ee5\u5728\u521a\u521a\u7684rspec\u547d\u4ee4\u7ed3\u679c \u4e2d\u770b\u5230\u6d4b\u8bd5\u6210\u529f\u901a\u8fc7\u3002 </p>"},{"location":"chap1/chef_tutorial14_test/#7let","title":"7\u3001\u4f7f\u7528Let\u8fdb\u884c\u60f0\u6027\u6c42\u503c","text":"<p>\u6211\u4eec\u9700\u8981\u518d\u4ecb\u7ecd\u4e00\u4e2a\u5c5e\u4e8e<code>Rspec</code>\u6838\u5fc3\u7684\u8bed\u6cd5\uff1a\u4f7f\u7528<code>let</code>\u65b9\u6cd5\u8fdb\u884c\u60f0\u6027\u6c42\u503c\u3002\u56fe\u5c55\u793a\u4e86 <code>ChefSpec</code>\u5982\u4f55\u4f7f\u7528let\u65b9\u6cd5\u6765\u7f13\u5b58<code>Che-fSpec::Runner</code>\u5bf9\u8c61\u7684\u7ed3\u679c\u3002 </p> <p></p> <p>\u8c03\u7528<code>ChefSpec::Runner</code>\u662f\u4e00\u4e2a\u76f8\u5bf9\u6bd4\u8f83\u5360\u7528\u8d44\u6e90\u7684\u884c\u4e3a\u3002<code>let(\uff09</code>\u65b9\u6cd5\u5c06<code>ChefSpec::Runner</code> \u7684\u8ba1\u7b97\u5ef6\u8fdf\u5230\u5b83\u7b2c\u4e00\u6b21\u88ab\u4f7f\u7528\u65f6\u624d\u53d1\u751f\u800c\u4e0d\u662f\u5f53\u5176\u88ab\u5f15\u7528\u65f6\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u8fd9\u79cd\u673a\u5236\u79f0\u4e3a \u201c\u60f0\u6027\u6c42\u503c\u201d\u3002</p> <p>\u4f7f\u7528let(\uff09\u65b9\u6cd5\u5141\u8bb8<code>RSpec\u5c06ChefSpec::Runner</code>\u7684\u7ed3\u679c\u7f13\u5b58\uff0c\u5e76\u5728\u540c\u4e00\u4e2a\u6d4b\u8bd5\u4e2d\u591a\u6b21\u7528\u5230\u65f6\u76f4\u63a5\u4f7f\u7528\u5176\u503c\u3002 \u518d\u8005\uff0c<code>let(\uff09</code>\u8bed\u53e5\u5141\u8bb8\u4f60\u53ea\u6307\u5b9a\u6b63\u5728\u6d4b\u8bd5\u7684\u914d\u65b9\u5355\u4e00\u6b21\uff0c\u5bf9\u6bd4\u4ee5\u4e0b\u7684\u4e0d\u4f7f\u7528<code>let</code>\u4ee5\u53ca\u4f7f\u7528<code>let</code>\u4e00\u7684\u4f8b\u5b50\uff0c\u6ce8\u610f\u5728\u4f7f\u7528<code>le</code>t\u65f6\uff0c<code>ChefSpec::Runner</code>\u4f7f\u7528\u4e00\u4e2a<code>described_recipe</code>\u5b8f\u6765\u8ba1\u7b97\u914d\u65b9\u5355\u540d\u5b57\u800c\u65e0\u987b\u91cd\u590d\u6307\u5b9a\u3002\u8fd9\u662f\u4e2a\u5f88\u5c0f\u7684\u4f18\u5316\uff0c\u4f46\u633a\u6709\u7528\u7684\u3002 </p> <p>Without let:</p> <pre><code>require 'chefspec'\n\ndescribe 'apache::default' do\n  chef_run = ChefSpec::Runner.new.converge('apache-test::default')\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <p>With let:</p> <pre><code>require 'chefspec'\n\ndescribe 'apache::default' do\n  let (:chef_run) { ChefSpec::Runner.new.converge(described_recipe) }\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <p><code>apache-test/spec/default_spec.rb</code></p> <pre><code>require 'chefspec'\n\ndescribe 'apache-test::default' do\n  let (:chef_run) { ChefSpec::Runner.new.converge(described_recipe) }\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <pre><code>$ rspec --color\n.\n\nFinished in 0.00042 seconds (files took 1.12 seconds to load)\n1 example, 0 failures\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#8","title":"8\u3001\u751f\u6210\u4e00\u4efd\u6d4b\u8bd5\u8986\u76d6\u62a5\u544a","text":"<p>\u53e6\u5916\u4e00\u4e2a\u6709\u7528\u7684<code>ChefSpec</code>\u7684\u5e2e\u52a9\u65b9\u6cd5\u662f<code>ChefSpec::Coverage.report!</code>\u3002</p> <p>\u5b83\u4f1a\u751f\u6210\u4e00\u4efd\u5217 \u8868\u544a\u8bc9\u4f60\u54ea\u4e9b\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u7684\u8d44\u6e90\u88ab\u6d4b\u8bd5\u8986\u76d6\uff0c\u54ea\u4e9b\u6ca1\u6709\u3002\u4f60\u53ef\u4ee5\u7528\u8fd9\u4efd\u62a5\u544a\u6765\u5f15\u5bfc\u6d4b \u8bd5\u3002 </p> <p>\u7f16\u8f91<code>default-spec.rb</code>\uff0c<code>at_exit</code>\u65b9\u6cd5\u662f<code>Ruby</code>\u6838\u5fc3\u7684\u4e00\u90e8\u5206\uff0c\u5141\u8bb8\u4f60\u5728\u7a0b\u5e8f\u9000\u51fa\u65f6\u8fd0\u884c\u4e00\u6bb5\u6307\u5b9a\u7684\u4ee3\u7801\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u5e0c\u671b\u8fd0\u884c<code>ChefSpec::Coverage.report\uff01</code>\u65b9\u6cd5\u3002</p> <p>\u65b9\u6cd5\u540d\u5b57\u4e2d\u7684\u611f\u53f9\u53f7\uff08<code>!</code>\uff09\u662f\u4e00\u4e2aRuby\u7684\u7ea6\u5b9a\uff0c\u544a\u8bc9\u5f00\u53d1\u8005\u8fd9\u4e2a\u65b9\u6cd5\u662f\u5371\u9669\u7684\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u5371\u9669\u610f\u5473\u7740<code>ChefSpec::Coverage.report\uff01</code>\u5fc5\u987b\u5728\u6240\u6709\u6d4b\u8bd5\u8fd0\u884c\u5b8c\u6210\u540e\u518d\u8fd0\u884c\uff0c\u5e76\u4e14\u6bcf\u6b21\u7a0b\u5e8f\u8fd0\u884c\u65f6\u53ea\u80fd\u8fd0\u884c\u4e00\u6b21\u3002\u6211\u4eec\u4f7f\u7528<code>at_exit</code>\u6765\u786e\u4fdd<code>report\uff01</code>\u53ea\u5728\u6240\u6709\u6d4b\u8bd5\u8fd0\u884c\u7ed3\u675f\u540e\u8fd0\u884c\u4e00\u6b21\u3002 </p> <p><code>apache-test/spec/default_spec.rb</code></p> <pre><code>require 'chefspec'\n\nat_exit { ChefSpec::Coverage.report! }\n\ndescribe 'apache-test::default' do\n  let (:chef_run) { ChefSpec::Runner.new.converge(described_recipe) }\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <pre><code>$ rspec --color\n.\n\nFinished in 0.00337 seconds (files took 1.11 seconds to load)\n1 example, 0 failures\n\nChefSpec Coverage report generated...\n\n  Total Resources:   3\n  Touched Resources: 1\n  Touch Coverage:    33.33%\n\nUntouched Resources:\n\n  service[httpd]                     /recipes/default.rb:12\n  template[/var/www/html/index.html]   /recipes/default.rb:16\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#9spec_helperrb","title":"9\u3001\u5728<code>spec_helper.rb</code>\u4e2d\u5171\u4eab\u6d4b\u8bd5\u4ee3\u7801","text":"<p>\u548c<code>Serverspec</code>\u7c7b\u4f3c\uff0c<code>ChefSpec</code>\u4e5f\u652f\u6301\u5c06\u901a\u7528\u7684\u4ee3\u7801\u5171\u4eab\u5728<code>spec_helper.rb</code>\u6587\u4ef6\u4e2d\u3002  \u548c\u524d\u9762<code>ServerSpec</code>\u4e2d\u7684\u4f8b\u5b50\u4e00\u6837\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u5047\u8bbe\u6709\u591a\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u7136\u540e\u79fb\u52a8\u4e00\u4e9b\u5171\u4eab\u7684\u4ee3\u7801\u5230<code>spec_helper.rb</code>\u3002 </p> <p>\u7528\u6240\u793a\u7684\u5185\u5bb9\u521b\u5efa<code>spec/spec_helper.rb</code>\u6587\u4ef6\u3002\u6211\u4eec\u5c06<code>require</code>\u548c<code>at_exit</code>\u79fb\u5230\u8fd9\u4e2a\u5171\u4eab\u6587\u4ef6\u4e2d\u3002 </p> <p><code>spec/spec_helper.rb</code></p> <pre><code>require 'chefspec'\n\nat_exit { ChefSpec::Coverage.report! }\n</code></pre> <p><code>apache-test/spec/default_spec.rb</code></p> <pre><code>require 'spec_helper'\n\ndescribe 'apache-test::default' do\n  let (:chef_run) { ChefSpec::Runner.new.converge(described_recipe) }\n\n  it 'installs apache2' do\n    expect(chef_run).to install_package('httpd')\n  end\nend\n</code></pre> <pre><code>$ rspec --color\n.\n\nFinished in 0.00337 seconds (files took 1.11 seconds to load)\n1 example, 0 failures\n\nChefSpec Coverage report generated...\n\n  Total Resources:   3\n  Touched Resources: 1\n  Touch Coverage:    33.33%\n\nUntouched Resources:\n\n  service[httpd]                     /recipes/default.rb:12\n  template[/var/www/html/index.html]   /recipes/default.rb:16\n</code></pre>"},{"location":"chap1/chef_tutorial14_test/#testing-your-automation-code-vagrant-version","title":"Testing Your Automation Code (Vagrant Version)","text":"<p>https://www.slideshare.net/misheska/testing-your-automation-code-vagrant-version-v02</p>"},{"location":"chap1/chef_tutorial14_test/#10","title":"10\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u91cd\u6e29Apache\u83dc\u8c31 </li> <li>\u4f7f\u7528<code>Serverspec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li><code>RSpec DSL</code>\u8bed\u6cd5 </li> <li>\u4f7f\u7528<code>Foodcritic</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5 </li> <li>\u4f7f\u7528<code>ChefSpec</code>\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u4f7f\u7528<code>Let</code>\u8fdb\u884c\u60f0\u6027\u6c42\u503c </li> <li>\u5728<code>spec_helper.rb</code>\u4e2d\u5171\u4eab\u6d4b\u8bd5\u4ee3\u7801</li> </ul> <pre><code># chef client\n$ sudo gem install foodcritic --no-ri --no-rdoc\n$ sudo gem install chefspec --no-ri --no-rdoc\n\n$ chef generate template index.html\n$ kitchen verify\n$ kitchen test\n\n$ foodcritic .\n$ rspec --color\n</code></pre>"},{"location":"chap1/chef_tutorial15_term/","title":"\u7b2c\u5341\u4e94\u8282 \u8bcd\u6c47\u8868","text":"<ul> <li>\u53c2\u6570\u4f20\u9012\u7ed9<code>Ruby</code>\u6216<code>Chef</code>\u65b9\u6cd5\u7684\u5bf9\u8c61\uff08\u6bd4\u5982\u4e00\u4e2a\u5b57\u7b26\u4e32\u6216\u6570\u7ec4\uff09\u3002 </li> <li>Chef <code>Chef</code>\u4ea7\u54c1\u7684\u901a\u79f0\uff0c\u5305\u62ec<code>Chef</code>\u670d\u52a1\u5668(Erchef)\u3001<code>Chef</code>\u5ba2\u6237\u7aef\u3001<code>Chef Solo</code>\u3001\u6258\u7ba1<code>Chef</code>\u548c\u4f01\u4e1a<code>Chef</code>.</li> <li><code>Chef</code>\u5ba2\u6237\u7aef: \u5728\u88ab<code>Chef</code>\u7ba1\u7406\u7684\u673a\u5668\u4e0a\u8fd0\u884c\u7684\u8d1f\u8d23\u6267\u884c\u64cd\u4f5c\u7684\u672c\u5730\u670d\u52a1\u3002 </li> <li><code>Chef</code>\u58f3: \u4ee5\u524d\u79f0\u4f5c<code>shef</code>, <code>Chef</code>\u58f3\uff08<code>chef-shell</code>\uff09\u662f\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u6267\u884c<code>Chef</code>\u4ee3\u7801\u7684\u4ea4\u4e92<code>REPL</code>\u7a0b\u5e8f\uff08\u7c7b\u4f3c<code>Ruby</code>\u7684<code>irb</code>\u6216<code>Python</code>\u7684<code>python</code>)\u3002 </li> <li><code>Chef</code>\u670d\u52a1\u5668 \u5bf9\u4f60\u7684\u57fa\u7840\u67b6\u6784\u914d\u7f6e\u7684\u4e2d\u592e\u5b58\u50a8\u3002 </li> <li><code>Chef Solo</code> \u5f00\u6e90\u7684\u3001\u4e0d\u9700\u8981<code>Chef</code>\u670d\u52a1\u5668\u7684<code>Chef</code>\u7248\u672c\u3002\u5b83\u4e0d\u5305\u542b\u4e00\u4e9b\u9ad8\u7ea7\u7528\u6237\u9700\u8981\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u641c\u7d22\u548c\u4e2d\u592e\u5b58\u50a8\u6570\u636e\u3002 </li> <li>\u5ba2\u6237\u7aef\u53c2\u89c1<code>Chef</code>\u5ba2\u6237\u7aef\u3002 </li> <li>\u6536\u655b\u6027\uff08<code>Convergence</code>) \u66f4\u5f3a\u7684\u5e42\u7b49\u6027\uff0c\u4fdd\u8bc1\u5982\u679c\u4e0d\u9700\u8981\u6267\u884c\u4efb\u4f55\u52a8\u4f5c\uff0c\u547d\u4ee4\u5c06\u4e0d\u4f1a\u8fd0\u884c\u3002 </li> <li>\u83dc\u8c31\uff08Cookbook\uff09 \u914d\u7f6e\u548c\u7b56\u7565\u4fe1\u606f\u7684\u5355\u4f4d\uff1b\u5bf9\u4e8e\u914d\u65b9\u5355\uff08<code>recipes</code>)\u3001\u5c5e\u6027(<code>attributes</code>)\u3001\u5143\u6570\u636e\uff08<code>metadata</code>)\u3001\u6a21\u7248\uff08<code>templates</code>)\u3001\u6587\u4ef6\uff08<code>files</code>\uff09\u7b49\u7684\u96c6\u5408\u3002 </li> <li>\u9886\u57df\u4e13\u7528\u8bed\u8a00\u4e3a\u4e86\u67d0\u4e2a\u9886\u57df\u6216\u76ee\u6807\u800c\u8bbe\u8ba1\u7684\u8bed\u8a00\u6216\u8bed\u6cd5\u3002 </li> <li>DSL\u53c2\u89c1\u201c\u9886\u57df\u4e13\u7528\u8bed\u8a00\u201d\u3002 </li> <li>\u6570\u636e\u5305\uff08<code>Data Bag</code>) \u7528\u6765\u5b58\u50a8\u7c7b\u4f3c\u7528\u6237\u6216API\u5bc6\u94a5\u7b49\u5168\u5c40\u4fe1\u606f\u7684<code>JSON</code>\u952e\u503c\u5bf9\u513f\u6587\u4ef6 </li> <li>\u5d4c\u5165<code>Ruby</code> \u5141\u8bb8\u4f60\u8fd0\u884c<code>Ruby</code>\u5e76\u8f93\u51fa\u5176\u7ed3\u679c\u7684<code>Ruby</code>\u6a21\u7248\u8bed\u8a00\uff1b\u5bf9\u914d\u7f6e\u6a21\u7248\u5f88\u6709\u7528\u3002 </li> <li>\u52a0\u5bc6\u6570\u636e\u5305\uff08<code>Encrypted Data Bag</code>\uff09\u4ee5<code>AES-256-CBC</code>\u52a0\u5bc6\u7684\u7248\u672c\u7684\u6570\u636e\u5305\uff08\u00b7Data Bag\u00b7)\uff0c\u4f60\u9700\u8981\u4e00\u4e2a\u5bc6\u94a5\u6765\u8bfb\u6216\u5199\u5b83\u7684\u5185\u5bb9\u3002 </li> <li>\u4f01\u4e1a<code>Chef</code>\u5728\u7ec4\u7ec7\u7684\u9632\u706b\u5899\u5185\u90e8\u7f72\u7684\u7531<code>Chef</code>\u8f6f\u4ef6\u516c\u53f8\u652f\u6301\u7684<code>Chef</code>\u670d\u52a1\u5668\uff1b\u4ee5\u524d\u79f0\u4f5c\u79c1\u6709<code>Chef</code>\u3002 </li> <li>\u73af\u5883 , \u5bf9\u4e8e\u8282\u70b9\u7684\u903b\u8f91\u5206\u7c7b\uff0c\u53ef\u4e3a\u6a2a\u5411\u5206\u7c7b\uff08\u6d4b\u8bd5\u548c\u751f\u4ea7\u73af\u5883\u7b49\u7b49\uff09\u6216\u7eb5\u5411\u5206\u7c7b\uff08\u4e1c\u6d77\u5cb8\u548c\u897f\u6d77\u5cb8\u7b49\uff09\u3002 </li> <li>ERB \u53c2\u89c1\u201c\u5d4c\u5165Ruby\"\u3002 </li> <li>\u6587\u4ef6 \u4e3a\u4e86\u5206\u5e03\u5230\u8282\u70b9\u7684\u9759\u6001\u6587\u4ef6\u6216\u7a0b\u5e8f\u3002 </li> <li>\u6258\u7ba1<code>Chef</code> \u53c2\u89c1\u201c\u6258\u7ba1\u4f01\u4e1aChef\"\u3002 </li> <li>\u6258\u7ba1\u4f01\u4e1a<code>Chef</code>: \u57fa\u4e8e\u4e91\u670d\u52a1\u7684<code>Chef</code>\u7248\u672c\uff1b\u4ee5\u524d\u79f0\u4f5c\u6258\u7ba1<code>Chef</code>\u3002 </li> <li>\u5e42\u7b49\u6027\u8868\u8fbe\u53ef\u4ee5\u6267\u884c\u65e0\u9650\u6b21\u67d0\u4e2a\u7279\u5b9a\u64cd\u4f5c\u4f46\u4e0d\u4f1a\u5f71\u54cd\u7ed3\u679c\u7684\u6570\u5b66\u5c5e\u6027\u3002 </li> <li>\u4ea4\u4e92<code>Ruby</code> \u5728\u547d\u4ee4\u884c\u7528\u6765\u6267\u884c<code>Ruby</code>\u8bed\u53e5\u7684REPL\u7a0b\u5e8f\u3002 </li> <li>\u4ea4\u4e92<code>Ruby</code>\u58f3\u53c2\u89c1<code>\u201c\u4ea4\u4e92Ruby\"</code>\u3002 </li> <li>IRB \u53c2\u89c1\u201c\u4ea4\u4e92Ruby\"\u3002</li> <li><code>Knife Chef</code>\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u53ef\u7528\u6765\u67e5\u770b\u548c\u7ba1\u7406\u4f60\u7684\u57fa\u7840\u67b6\u6784\uff1bknife\u652f\u6301\u63d2\u4ef6\uff0c\u53ef\u8f7b\u677e\u6269\u5c55\u3002 </li> <li>\u5143\u6570\u636e \u83dc\u8c31\u7684\u989d\u5916\u4fe1\u606f\u6bd4\u5982\u540d\u5b57\u3001\u7248\u672c\u3001\u63cf\u8ff0\u3001\u7a0b\u5e8f\u4f9d\u8d56\u548c\u63a8\u8350\u7b49\u3002 </li> <li>\u591a\u79df\u6237\u53c2\u89c1\u201c\u7ec4\u7ec7\u201d\u3002 </li> <li>\u8282\u70b9\uff08Node\uff09 <code>Chef</code>\u6258\u7ba1\u7684\u4efb\u4f55\u673a\u5668\u6216\u8bbe\u5907\u3002 </li> <li>\u5f00\u6e90<code>Chef</code>\u670d\u52a1\u5668 \u514d\u8d39\u548c\u5f00\u6e90\u7248\u672c\u7684Chef\u670d\u52a1\u5668\uff0c\u5305\u542b\u6258\u7ba1<code>Chef</code>\u8fd1\u4e4e\u4e00\u6837\u7684\u529f\u80fd\uff0c\u4f46 \u9700\u8981\u81ea\u884c\u5b89\u88c5\u3001\u914d\u7f6e\u548c\u7ba1\u7406\u3002 </li> <li>\u7ec4\u7ec7 \u6258\u7ba1<code>Chef</code>\u548c\u4f01\u4e1a<code>Chef</code>\u4e2d\u5bf9\u8282\u70b9\u7684\u9876\u7ea7\u5206\u7ec4\uff0c\u8fd9\u6837\u7684\u5206\u7ec4\u652f\u6301\u901a\u5e38\u88ab\u79f0\u4f5c\u201c\u591a\u79df \u6237\u201d\u3002 </li> <li>\u79c1\u6709<code>Chef</code>\u53c2\u89c1\u201c\u4f01\u4e1aChef\"\u3002 </li> <li>\u63d0\u4f9b\u8005\uff08<code>Provider</code>\uff09 \u5bf9\u67d0\u4e2a\u8d44\u6e90\uff08\u6bd4\u5982<code>apt</code>\u6216<code>useradd</code>\uff09\u7684\u9488\u5bf9\u67d0\u4e2a\u5e73\u53f0\u7684\u5b9e\u73b0\uff1b\u4f60\u7528\u8d44\u6e90\u6307\u5b9a\u4e86\u8981\u8fbe\u5230\u4ec0\u4e48\u76ee\u6807\uff0c\u63d0\u4f9b\u8005\u6765\u5b9a\u4e49\u201c\u5982\u4f55\u505a\u201d\u3002 </li> <li>\u914d\u65b9\u5355\uff08<code>Recipe</code>) \u7528<code>Chef</code>\u7684<code>Ruby</code>\u9886\u57df\u4e13\u7528\u8bed\u8a00\u64b0\u5199\u7684\u7528\u6765\u544a\u8bc9<code>Chef</code>\u5ba2\u6237\u7aef\u5728\u8282\u70b9\u505a\u4ec0\u4e48\u7684\u6587\u4ef6\u3002 </li> <li>\u8d44\u6e90\uff08<code>Resource</code>\uff09 \u5bf9<code>Chef</code>\u7ba1\u7406\u7684\u9879\u76ee\uff08\u6bd4\u5982\u5b89\u88c5\u5305\u6216\u7528\u6237\uff09\u7684\u8de8\u5e73\u53f0\u62bd\u8c61\u7684\u603b\u3001 \u79f0\uff1b\u4f60\u4f7f\u7528\u8d44\u6e90\u6765\u5728\u914d\u65b9\u5355\u4e2d\u5b9a\u4e49\u201c\u505a\u4ec0\u4e48\u201d\u3002 </li> <li>\u89d2\u8272\uff08<code>Role</code>)\u5bf9\u914d\u65b9\u5355\u6216\u5176\u4ed6\u89d2\u8272\u7684\u903b\u8f91\u5206\u7ec4\u3002 <code>Ruby Chef</code>\u5ba2\u6237\u7aef\u57fa\u4e8e\u7684\u9762\u5411\u5bf9\u8c61\u7684\u7f16\u7a0b\u8bed\u8a00\u3002 </li> <li>\u8fd0\u884c\u6e05\u5355(Run List\uff09 \u9700\u8981\u5e94\u7528\u5230<code>Chef</code>\u8282\u70b9\u7684\u6709\u987a\u5e8f\u7684\u914d\u65b9\u5355\u6216\u89d2\u8272\u5217\u8868\uff1b\u6307\u5b9a\u7684\u914d\u65b9\u5355\u6216\u89d2\u8272\u6839\u636e\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u6307\u5b9a\u7684\u987a\u5e8f\u88ab\u5e94\u7528\u3002 </li> <li>\u6a21\u677f(Template)\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u7f16\u8bd1\u7684\u5d4c\u5165<code>Ruby</code>\u6a21\u677f\u3002 </li> </ul>"},{"location":"chap1/chef_tutorial16_int/","title":"L16 Chef Tutorial Interview","text":""},{"location":"chap1/chef_tutorial16_int/#1-chef","title":"1 Chef \u4ecb\u7ecd\u548c\u5b89\u88c5","text":""},{"location":"chap1/chef_tutorial16_int/#chef-server","title":"Chef Server","text":"<p>Actions:</p> <ul> <li>Reporting</li> <li>Push </li> </ul> <p>Server Core:</p> <ul> <li>On-premises</li> <li>Hosted</li> </ul> <p>Web Interface:</p> <ul> <li>Management Console</li> <li>LDAP/AD Integration</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#chef-deployment-kit","title":"Chef Deployment Kit","text":"<p>Chef Client:</p> <ul> <li>Cookbooks, DataBags, Environments</li> <li>Knife</li> <li>Solo</li> <li>Zero</li> </ul> <p>Test Driven Infrastructure:</p> <ul> <li>Test Kitchen</li> <li>Berkshelf</li> <li>ChefSpec</li> <li>Serverspec</li> </ul> <pre><code>$ chef verify\n$ chef-client --version\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#2-chef","title":"2 Chef \u8bed\u6cd5","text":"<ul> <li>bash / <code>Chef_gem</code> / Cron / <code>deploy_revision</code> / directory / execute / file </li> <li><code>gem_package</code> / group / link / mount / package / <code>remote_file</code> </li> <li> <p>service / template / User</p> </li> <li> <p><code>Chef_gem</code>: \u5728Chef\u5185\u5b89\u88c5\u4e00\u4e2aRuby\u7a0b\u5e8f(gem)\uff0c\u5728Chef\u5185\u90e8\u4f7f\u7528\u3002 \u5982\u679c\u4f60\u7684Chef\u4ee3\u7801\u9700\u8981\u989d\u5916\u4e00\u4e2a\u7684gem\u6765\u6267\u884c\u4e00\u4e2a\u51fd\u6570, \u53ef\u4ee5\u7528\u8fd9\u4e2a\u8d44\u6e90\u6765\u5728Chef\u5185\u90e8\u5b89\u88c5\u8fd9\u4e2a\u989d\u5916\u7684gem</p> </li> <li><code>deploy_revision</code>: \u63a7\u5236\u548c\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u90e8\u7f72, \u5728\u4ee3\u7801\u7248\u672c\u63a7\u5236\u5de5\u5177\u4e2d\u7684\u4ee3\u7801\uff08\u5982Rails\u5e94\u7528\u7a0b\u5e8f)</li> <li><code>gem_package</code>: \u5728Chef\u5916\u5b89\u88c5\u4e00\u4e2aRuby\u7a0b\u5e8f\uff08gem),\u6bd4\u5982\u5728\u76ee\u6807\u673a\u5668\u7684\u7cfb\u7edf\u4e2d\u5b89\u88c5\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6216\u5de5\u5177:</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#3-chef-chef-apply","title":"3 \u5982\u4f55\u5199 Chef \u914d\u65b9 &amp; chef-apply","text":"<ul> <li>\u914d\u65b9\u5355(recipe): \u4e00\u7cfb\u5217\u7528Ruby\u9886\u57df\u4e13\u7528\u8bed\u8a00\uff08DSL\uff09\u6765\u5199\u7684\u63cf\u8ff0\u7406\u60f3\u914d\u7f6e\u7684\u6307\u4ee4\u3002</li> <li>\u6e90(resource)\uff1a \u8d44\u6e90\u662fChef\u4ee3\u7801\u7684\u7ec4\u6210\u90e8\u5206\u3002\u901a\u8fc7\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u4e0d\u540c\u7684\u8d44\u6e90\u6765\u544a\u8bc9Chef\u4f60\u7684\u7406\u60f3\u914d\u7f6e\u3002</li> <li>\u5c5e\u6027\uff08attribute)</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#4-test-kitchen","title":"4 \u7528Test Kitchen\u7ba1\u7406\u6c99\u76d2\u6d4b\u8bd5\u73af\u5883","text":"<ul> <li>kitchen init\uff1a \u5411\u4e00\u4e2a\u9879\u76ee\u4e2d\u6dfb\u52a0Test Kitchen\u652f\u6301</li> <li>kitchen list: \u663e\u793aTest Kitchen\u5b9e\u4f8b\u7684\u4fe1\u606f</li> <li>kitchen create\uff1a \u542f\u52a8\u4e2aTest Kitchen\u5b9e\u4f8b</li> <li><code>Gemfile.lock</code>:  \u5f53bundle install\u8fd0\u884c\u65f6Bundler\u6240\u9700\u7684gem\u548c\u5b83\u6240\u4f9d\u8d56\u7684gem\u7684\u5217\u8868 \u53ef\u4ee5\u7528\u6765\u5728\u53e6\u4e00\u4e2a\u5f00\u53d1\u8005\u7684\u7535\u8111\u4e0a\u91cd\u73b0\u4e00\u6837\u7684\u73af\u5883\u3002</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#kitchenyml","title":"<code>kitchen.yml</code>\u6587\u4ef6\u5305\u542b\u56db\u4e2a\u4e3b\u8981\u7684\u90e8\u5206\u3002","text":"<ul> <li><code>driver</code>: \u6307\u5b9a\u8981\u4f7f\u7528\u7684\u9a71\u52a8\u4ee5\u53ca\u7ba1\u7406Test Kitchen\u73af\u5883\u7684\u914d\u7684\u53c2\u6570\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>kitchen driver discover</code>\u547d\u4ee4\u6765\u5f97\u5230\u4e00\u4e2a\u53ef\u7528\u7684\u9a71\u52a8\u5217\u8868</li> <li><code>provision:</code> \u6307\u5b9a\u4f7f\u7528\u54ea\u4e2a\u914d\u754c\u7ba1\u7406\u5de5\u5176\u6765\u521b\u5efa\u6307\u5b9a\u9a71\u52a8\u7684\u73af\u63a9,\u4ee5\u4e0a\u7684\u4f8b\u5b50\u4e2d\u6211\u4eec\u4f7f\u7528<code>chef_solo</code>,\u5f53\u4f60\u8fd0\u884c<code>kitchen setup</code>\u65f6\u5b83\u5c06\u5728\u5b9e\u4f8b\u4e0a\u5b89\u88c5Chef\u5ba2\u6237\u7aef\uff08\u5982\u679c\u76ee\u524d\u5c1a\u672a\u5b89\u88c5\u7684\u8bdd\uff09\u3002</li> <li><code>platforms</code>: \u4f60\u5e0c\u671bTest kitchen\u521b\u5efa\u7684\u5b9e\u4f8b\u64cd\u4f5c\u7cfb\u7edf\u5217\u8868</li> <li><code>suites</code>: \u5728\u4f7f\u7528Chef\u4f5c\u4e3a\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u65f6\uff08Test Kitchen\u4e0d\u4ec5\u4ec5\u652f\u6301Chef)\uff0c\u6307\u5b9a\u6bcf\u4e2a\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u7684\u914d\u7f6e\u3002\u8fd9\u5305\u62ec\u6307\u5b9a\u5728\u6bcf\u4e2a\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u7684Chef\u914d\u65b9\u5355\u7684\u5217\u8868\u6765\u3002<ul> <li><code>run_list:</code>+ attributes</li> </ul> </li> </ul>"},{"location":"chap1/chef_tutorial16_int/#5-chef","title":"5 \u7528 Chef \u6237\u7aef\u7ba1\u7406\u8282\u70b9","text":""},{"location":"chap1/chef_tutorial16_int/#_1","title":"\u4ec0\u4e48\u662f\u8282\u70b9","text":"<ul> <li>\u53ea\u8981\u8fd9\u4e2a\u8282\u70b9\u5b89\u88c5\u4e86Chef\u5ba2\u6237\u7aef\uff0c\u5c31\u53ef\u4ee5\u53d7Chef\u7ba1\u7406\u5e76\u8fd0\u884cChef\u914d\u65b9\u5355\u3002</li> </ul> <p><code>node/kitchen.yml</code></p> <p><code>driver  provisioner  platforms  suites</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n</code></pre> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n\n$ kitchen create default-centos65\n\n# \u786e\u5b9a\u4f60\u4f7f\u7528\u4f60\u7684\u5bbf\u4e3b\u673a\u5668,\u5728\u6c99\u76d2\u4e2d\u5b89\u88c5chef-client\n$ kitchen setup default-centos65\n</code></pre> <p>Chef Solo\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u4f46\u4e0d\u628a\u5b83\u914d\u7f6e\u4e3a\u4f7f\u7528Chef\u670d\u52a1\u5668</p> <p>\u901a\u8fc7\u4f7f\u7528<code>chef-client</code>\u7a0b\u5e8f\u6765\u6267\u884c\u914d\u65b9\u5355\u4e2d\u6307\u5b9a\u7684\u52a8\u4f5c\u901a\u5e38\u88ab\u79f0\u4f5c\u4e00\u6b21Chef\u8fd0\u884c</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u4eba<code>chef-client --local-mode hello.rb --log_level info</code>\u5c06\u6267\u884c\u4f60\u7684\u7b2c\u4e00\u6b21Chef\u8fd0\u884c\u3002</p> <ul> <li><code>--local-mode</code>\u9009\u9879\u9632\u6b62<code>chef-client</code>\u5728\u5bfb\u627e\u4e0d\u5b58\u5728\u7684Chef\u670d\u52a1\u5668\u65f6\u8d85\u65f6\u3002</li> <li>\u6211\u4eec\u540c\u65f6\u9700\u8981<code>--log_level info</code>\u9009\u9879\uff0c\u56e0\u4e3a\u9ed8\u8ba4\u60c5\u51b5\u4e0b<code>chef-client</code>\u53ea\u6253\u5370\u9519\u8bef\uff0c\u800c\u975e\u4fe1\u606f\u6d88\u606f\uff0c</li> <li>\u8fd9\u4e2a\u9009\u9879\u5c06\u544a\u8bc9<code>chef-client</code>\u6253\u5370\u6765\u81ea<code>Chef::Log.info</code>\u547d\u4ee4\u7684\u6240\u6709\u5b57\u7b26\u4e32\u3002</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#chef","title":"Chef\u5ba2\u6237\u7aef\u7684\u4e09\u79cd\u6a21\u5f0f","text":"<ul> <li>\u672c\u5730\u6a21\u5f0f</li> </ul> <p>\u5f53<code>chef-client</code>\u4ee5\u672c\u5730\u6a21\u5f0f\u8fd0\u884c\u65f6\uff0c\u5b83\u5728\u5185\u5b58\u4e2d\u6a21\u62df\u4e00\u4e2a\u5b8c\u6574\u7684Chef\u670d\u52a1\u5668\u3002\u4efb\u4f55\u672c\u5e94\u4fdd\u5b58\u5230\u670d\u52a1\u5668\u7684\u6570\u636e\u4f1a\u88ab\u5199\u5165\u4e00\u4e2a\u672c\u5730\u6587\u4ef6\u5939\u3002 \u5c06\u670d\u52a1\u5668\u6570\u636e\u5199\u5728\u672c\u5730\u7684\u8fc7\u7a0b\u53eb\u505a\u56de\u5199(writeback)\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48<code>chef-client</code>\u521b\u5efa\u4e86<code>nodes/</code>\u76ee\u5f55\u3002 </p> <p>\u672c\u5730\u6a21\u5f0f\u662f\u8bbe\u8ba1\u6765\u652f\u6301\u901a\u8fc7\u4f7f\u7528\u5b8c\u5168\u5728\u5185\u5b58\u7684<code>Chef Zero</code>\u670d\u52a1\u5668\u6765\u8fdb\u884c\u5feb\u901f\u7684<code>Chef</code>\u914d\u65b9\u5355\u5f00\u53d1</p> <ul> <li>\u5ba2\u6237\u7aef\u6a21\u5f0f</li> </ul> <p>\u5f53<code>chef-client</code>\u4ee5\u5ba2\u6237\u7aef\u6a21\u5f0f\u8fd0\u884c\u65f6\uff0c\u5b83\u5047\u8bbe\u4f60\u5728\u7f51\u7edc\u4e2d\u5df2\u7ecf\u8ba9Chef\u670d\u52a1\u5668\u6b63\u5728\u8fd0\u884c\u3002</p> <p>\u5728\u5ba2\u6237\u7aef\u6a21\u5f0f\u4e2d\uff0c<code>chef-client</code>\u662f\u4e00\u4e2a\u5728\u88abChef\u7ba1\u7406\u7684\u673a\u5668\u672c\u5730\u8fd0\u884c\u7684\u4ee3\u7406\u4eba\u7a0b\u5e8f\uff08\u6216\u670d\u52a1\u3001\u540e\u53f0\u7a0b\u5e8f). </p> <p>Chef\u670d\u52a1\u5668\u96c6\u4e2d\u5b58\u50a8\u9700\u8981\u7ba1\u7406\u7684\u57fa\u7840\u67b6\u6784\u7684\u4fe1\u606f\u3002\u5982\u679c\u9700\u8981\u540c\u65f6\u7ba1\u7406\u591a\u4f59\u4e00\u53f0\u673a\u5668\uff0c\u63a8\u8350\u4f7f\u7528Chef\u670d\u52a1\u5668</p> <ul> <li>Solo\u6a21\u5f0f</li> </ul> <p>\u5728\u7248\u672c11.8\u4e2dchef-client\u652f\u6301\u672c\u5730\u6a21\u5f0f\u4e4b\u524d\uff0c\u552f\u4e00\u4e0d\u9700\u8981Chef\u670d\u52a1\u5668\u8fd0\u884cChef\u4ee3\u7801\u7684\u65b9\u6cd5\u662f\u4f7f\u7528<code>chef-solo</code>.</p> <p>chef-solo\u63d0\u4f9b\u4e00\u4e2a\u989d\u5916\u7684\u5ba2\u6237\u7aef\u6a21\u5f0f\u53eb\u505aSolo\u6a21\u5f0f\u3002Solo\u6a21\u5f0f\u63d0\u4f9b\u4e86\u8ba9Chef\u591f\u672c\u5730\u8fd0\u884c\u7684Chef\u529f\u80fd\u7684\u6709\u9650\u7684\u5b50\u96c6\u3002<code>chef-solo</code>\u4e0d\u652f\u6301\u56de\u5199, \u5728\u5927\u591a\u6570\u65f6\u5019\uff0c\u672c\u5730\u6a21\u5f0f\u90fd\u8fdc\u8fdc\u6bd4Solo\u6a21\u5f0f\u66f4\u65b9\u4fbf\u4f7f\u7528\u3002</p>"},{"location":"chap1/chef_tutorial16_int/#ohai","title":"\u547d\u4ee4\u884c\u5de5\u5177Ohai","text":"<ul> <li>\u5f53Chef\u5ba2\u6237\u7aef\u8fd0\u884c\u65f6, \u5b83\u4f7f\u7528\u4e00\u4e2a\u989d\u5916\u7684\u547d\u4ee4\u884c\u5de5\u5177ohai\u6765\u6536\u96c6\u7cfb\u7edf\u4fe1\u606f\u3002ohai\u5c06\u6536\u96c6\u5230\u7684\u8282\u70b9\u4fe1\u5305\u50a8\u5b58\u5728Chef\u7684\u81ea\u52a8\u5c5e\u6027\u4e2d</li> <li>ohai\u6536\u96c6\u8bb8\u591a\u5173\u4e8e\u7535\u8111\u5f53\u524d\u72b6\u6001\u7684\u4fe1\u606f\uff1a\u7f51\u7edc\u914d\u7f6e, Cpu\u72b6\u6001\u3001\u64cd\u4f5c\u7cfb\u7edf\u7c7b\u578b\u548c\u7248\u672c\u3001\u5185\u5b58\u4f7f\u7528\u91cf\u7b49\u3002</li> </ul> <p>\u5c5e\u6027\u662fChef\u7ba1\u7406\u7684\u4e00\u4e2a\u53d8\u91cf\u3002\u5728\u4f60\u7684\u4ee3\u7801\u4e2d\uff0c\u5728\u4e2d\u62ec\u53f7\u4e2d\u7528\u5f15\u53f7\u5305\u56f4\u7684\u5b57\u7b26\u4e32\u6307\u5b9a\u5c5e\u80dc\u7684\u540d\u79f0\uff0cChef\u4f1a\u8fd4\u56de\u5c5e\u6027\u7684\u503c\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c</p> <ul> <li>\u6211\u4eec\u8981\u77e5\u9053IP\u5730\u5740\uff0c\u5728\u4e4b\u524d\u7684<code>ohai</code>\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u77e5\u9053\u5176IP\u5730\u5740\u5c5e\u80dc\u7684\u540d\u79f0\u662f<code>ipaddress,</code>\u56e0\u6b64\u53ef\u4ee5\u7528\u6b64\u540d\u79f0\u5728<code>Chef</code>\u4ee3\u7801\u4e2d\u8bbf\u95ee\u8282\u70b9\u7684\u5c5e\u80dc</li> <li>node\u662f\u53e6\u5916\u4e00\u4e2aChef\u4ee3\u7801\u4e2d\u53ef\u4ee5\u4f7f\u7528\u7684\u5c5e\u6027\u3002\u5b83\u5305\u542b\u5728\u8282\u70b9\u4e0a\u8fd0\u884cohai\u8f93\u51fa\u7684\u6240\u6709\u4fe1\u606f\u548c\u6211\u4eec\u4f7f\u7528\u7684<code>ENV</code>\u5c5e\u6027\u7c7b\u4f3c\uff0cnode\u5c5e\u6027\u662f\u4e00\u4e2a\u952e\u503c\u5bf9\u513f\u96c6\u5408</li> <li>\u952e\u503c\u5bf9\u513f\u96c6\u5408\u652f\u6301\u5d4c\u5957\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5728ohai\u8f93\u51fa\u4e2d\u4f1a\u6709\u591a\u5c42\u7f29\u8fdb\u3002\u56e0\u6b64\uff0c\u5982\u679c\u8981\u8bbf\u95ee\u8282\u70b9\u4f7f\u7528\u7528\u7684\u865a\u62df\u8f6f\u4ef6\u4fe1\u6025\uff08\"\u865a\u62df\u7cfb\u7edf\u201d)\uff0c\u4f7f\u7528\u4ee5\u4e0b\u7684\u5d4c\u5957\u952e\u503c\u5bf9\u513f\uff0c<code>system</code>\u662f <code>virtualization</code>\u96c6\u5408\u4e2d\u7684\u4e00\u4e2a\u952e</li> </ul> <pre><code>node['ipaddress']\n\nnode['virtualization']['system']\n\nnode[:virtualization][:system]\nnode['virtualization']['system']\nnode.virtualization.system\n</code></pre> <p>\u8bbf\u95ee\u8282\u70b9\u4fe1\u606f</p> <p>\u5c5e\u80dc\u662fChef\u7ef4\u62a4\u7684\u4e00\u4e2a\u53d8\u91cf</p> <pre><code>$ vi info.rb\n\nlog \"IP Address: #{node['ipaddress']}\"\nlog \"MAC Address: #{node['macaddress']}\"\nlog \"OS Platform: #{node['platform']} #{node['platform_version']}\"\nlog \"Running on a #{node['virtualization']['system']} #{node['virtualization']['role']}\"\nlog \"Hostname: #{node['hostname']}\"\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#6","title":"6 \u64b0\u5199\u548c\u4f7f\u7528\u83dc\u8c31","text":"<p>\u6709\u4e86Chef\u5f00\u53d1\u5305\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528<code>chef generate</code>\u547d\u4ee4\u6765\u7ba1\u7406\u83dc\u8bed\u7684\u76ee\u5f55\u7ed3\u6784</p> <p>chef generate\u547d\u4ee4\u62e5\u6709\u4e00\u4e9bknife\u6ca1\u6709\u7684\u529f\u80fd\u3002</p> <ul> <li>chef generate\u5141\u8bb8\u4f60\u81ea\u5b9a\u4e49\u751f\u6210\u7684\u914d\u65b9\u5355\u548c\u83dc\u8c31\u6a21\u677f\u3002</li> <li>\u540c\u65f6<code>chef generate</code>\u5141\u8bb8\u4f60\u9010\u6b65\u521b\u5efa\u76ee\u5f55\u7ed3\u6784, \u6bcf\u6b21\u53ea\u6dfb\u52a0\u4f60\u6240\u5fc5\u8981\u7684\u7ec4\u4ef6\u3002</li> <li>knife\u5219\u53ea\u80fd\u4e00\u6b21\u6027\u751f\u6210\u5305\u542b\u6240\u6709\u7ec4\u4ef6\u7684\u76ee\u5f55\u7ed3\u6784</li> </ul> <pre><code>chef generate cookbook motd\n# /motd/kitchen.yml\n\n# \u4f7f\u7528chef generate file motd\u547d\u4ee4\u5728\u83dc\u8c31\u4e2d\u751f\u6210motd\u6587\u4ef6\u6240\u9700\u7684\u76ee\u5f55\u7ed3\u6784\u3002\u6211\u4eec\u53ea\u9700\u8981\u6587\u4ef6\u540d\uff0c\u800c\u4e0d\u662f\u8def\u5f84\n$ chef generate file motd\n\n$ tree files\nfiles\n\u2514\u2500\u2500 motd\n</code></pre> <p>\u7f16\u8f91<code>recipes/default.rb</code>\u6587\u4ef6\uff0c\u4f7fChef\u5728\u8282\u70b9\u4e0a\u66f4\u65b0<code>/etc/motd</code></p> <pre><code>cookbook_file \"/etc/motd\" do\n  source \"motd\"\n  mode \"0644\"\nend\n</code></pre> <p><code>cookbook file</code>\u662f\u4e00\u4e2aChef\u8d44\u6e90\u3002<code>cookbook file</code>\u8d44\u6e90\u7528\u6765\u5c06\u83dc\u8c31\u4e2d<code>files/</code>\u5b50\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u4f20\u8f93\u5230Chef\u7ba1\u7406\u7684\u8282\u70b9\u4e2d</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\uff0c\u8fd0\u884c<code>knife cookbook create</code>\u547d\u4ee4\u53ef\u4ee5\u521b\u5efa\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\u3002knife\u5c06\u521b\u5efamotd\u83dc\u8c31\u7684\u4e3b\u76ee\u5f55\uff1a</p> <pre><code>$ cd motd\n\n$ knife cookbook create motd --cookbook-path .\n\n$ kitchen init --create-gemfile\n</code></pre> <p>\u7b2c\u4e00\u6b21\u8fd0\u884cChef</p> <pre><code>$ kitchen converge default-centos65\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#chef_1","title":"\u5256\u6790Chef\u8fd0\u884c","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d<code>chef-client</code>\u901a\u5e38\u4ef6\u4e3a\u670d\u52a1\u5728\u80cc\u540e\u6301\u7eed\u5b9a\u671f\u8fd0\u884c\uff0c \u6bd4\u598215\u5206\u949f\u6267\u884c\u4e00\u6b21chef\u968f\u884c\uff0e\u5b83\u67e5\u770b\u670d\u52a1\u5668\u4e0a\u6709\u6ca1\u6709\u4efb\u4f55\u83dc\u8c31\u7684\u6539\u53d8\u6216\u65b0\u7684\u8fd0\u884c\u6e05\u5355\u3002</p> <ul> <li>\u5f00\u59cb\u8fd0\u884cChef\u5ba2\u6237\u7aef<ul> <li>chef-client \u8fdb\u7a0b\u5728\u8fdc\u7a0b\u8282\u70b9\u542f\u52a8\u3002 \u8fdb\u7a0b\u53ef\u80fd\u7531\u4e00\u4e2a\u670d\u52a1\uff0c cron\u4efb\u52a1\u6216\u67d0\u7528\u6237\u624b\u52a8\u542f \u52a8\u3002<code>chef-client</code>\u8fdb\u7a0b\u8d1f\u8d23\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u8fd0\u884c\u5305\u542bChef\u4ee3\u7801\u7684\u914d\u65b9\u5355\u7684\u83dc\u8c31</li> </ul> </li> <li>\u521b\u5efa\u8282\u70b9<ul> <li><code>chef-client</code> \u8fdb\u7a0b\u5728\u5185\u5b58\u4e2d\u6784\u5efanode\uff08\u8282\u70b9\uff09\u5bf9\u8c61\u3002\u5b83\u8fd0\u884cohai\u5e76\u6536\u96c6\u6240\u6709\u5173\u4e8e\u8fd9\u4e2a \u8282\u70b9\u7684\u81ea\u52a8\u5c5e\u6027\uff08\u6bd4\u5982\u4e3b\u673a\u540d\u3001FQDN\u5e73\u53f0\u3001\u7528\u6237\u7b49\uff09\u3002</li> </ul> </li> <li>\u540c\u6b65<ul> <li>\u8fd0\u884c\u6e05\u5355\u88ab\u53d1\u9001\u5230\u8282\u70b9\uff0c \u8fd0\u884c\u6e05\u5355\u5305\u542b\u8981\u5728\u76ee\u6807\u8282\u70b9\u6267\u884c\u7684\u914d\u65b9\u5355\u7684\u6e05\u5355</li> </ul> </li> <li>\u52a0\u8f7d<ul> <li>\u83dc\u8c31\u548cRuby\u7ec4\u4ef6\u5728\u6b64\u6b65\u9aa4\u88ab\u52a0\u8f7d\u3002<ul> <li>\u5e93(Libries)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>Libries/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0c \u8fd9\u6837\u8bed\u8a00\u6269\u5c55\u6216\u66f4\u6539\u5c06\u4f1a\u5728\u4f59\u4e0b\u7684Chef\u8fd0\u884c\u6b65\u9aa4\u4e2d\u53ef\u7528</li> <li>\u5c5e\u6027\uff08Attributes)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>attributes/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u4e95\u4e0eohai\u5c5e\u6027\u7ed3\u5408</li> <li>\u5b9a\u4e49(Definitions)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>definitions/</code>\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u3002\u8fd9\u4e9b\u6587\u4ef6\u5b9a\u4e49\u5728\u914d\u65b9\u5355\u4e2d\u7528\u5230\u7684\u7c7b\u4f3c\u8d44\u6e90\u7684\u53ef\u91cd\u7528\u4ee3\u7801, \u56e0\u6b64\u5fc5\u987b\u5728\u52a0\u8f7d\u914d\u65b9\u5355\u524d\u52a0\u8f7d.</li> <li>\u8d44\u6e90(Resource) \u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d(<code>resources/</code>)\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u3002\u8d44\u6e90\u5fc5\u987b\u5728\u914d\u65b9\u5355\u4e4b\u524d\u52a0\u8f7d\u56e0\u4e3a\u914d\u65b9\u5355\u4f1a\u4f7f\u7528\u8d44\u6e90\u4ee3\u7801</li> <li>\u63d0\u4f9b\u8005(Providers)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d(<code>providers/</code>)\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0c\u4ee5\u4fbf\u8d44\u6e90\u5f15\u7528\u5408\u9002\u7684\u63d0\u4f9b\u8005\u3002</li> <li>\u914d\u65b9\u5355\uff08Recipes)\u52a0\u8f7d\u6267\u884c\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>recipes/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0e\u5728\u8fd9\u4e2a\u9636\u6bb5\uff0c \u914d\u65b9\u5355\u4e95\u672a\u88ab\u6267\u884c\u6765\u5c06\u8282\u70b9\u8f6c\u6362\u4e3a\u7406\u60f3\u914d\u7f6e\uff0c \u914d\u65b9\u5355\u4e2dRuby\u4ee3\u7801\u7f16\u8bd1\u4e95\u8f6c\u5316\u6210\u6700\u540e\u5c06\u5728\u8282\u70b9\u4e0a\u6267\u884c\u7684\u914d\u65b9\u5355\uff0c \u6bcf\u4e2a\u8d44\u6e90\u4e5f\u5728\u6b64\u65f6\u88ab\u52a0\u4eba\u5230\u8d44\u6e90\u96c6\u5408\u4e2d. </li> </ul> </li> </ul> </li> <li>\u6536\u655b<ul> <li>\u6536\u655b\u9636\u6bb5\u5219\u662f\u6bcf\u6b21Chef\u8fd0\u884c\u4e2d\u6700\u91cd\u8981\u7684\u9636\u6bb5\u3002\u5728\u8fd9\u4e2a\u65f6\u5019Chef\u914d\u65b9\u5355\u5728\u76ee\u6807\u8282\u70b9\u6267\u884c\u5e76\u6539\u53d8\u8282\u70b9\u5230\u7406\u60f3\u72b6\u6001\uff0c\u6bd4\u5982\u5b89\u88c5\u5c1a\u672a\u5b89\u88c5\u7684\u7a0b\u5e8f\u5305\u3001\u590d\u5236\u6e32\u67d3\u597d\u7684\u6a21\u677f\u6216\u6587\u4ef6\u5230\u76ee\u6807\u4f4d\u7f6e\u7b49\u7b49\u3002</li> </ul> </li> <li>\u62a5\u544a<ul> <li>\u5982\u679cChef\u5ba2\u6237\u7aef\u8fd0\u884c\u6210\u529f\uff0c\u8282\u70b9\u4f1a\u4fdd\u5b58\u4efb\u4f55\u65b0\u7684\u5c5e\u6027\u503c\uff1b\u5982\u679c\u5931\u8d25\uff0c\u5ba2\u6237\u7aef\u4f1a\u629b\u51fa\u5f02\u5e38\u800c\u8282\u70b9\u5bf9\u8c61\u4e5f\u4e0d\u4f1a\u88ab\u66f4\u65b0\uff0c\u901a\u77e5\u673a\u5236\u548c\u5f02\u5e38\u5904\u7406\u5668\u5c06\u8fd0\u884c\u6765\u901a\u77e5\u5de5\u4f5c\u4eba</li> <li><code>recipe['\uff1c\u83dc\u8c31\u540d\u5b57\uff1e::\uff1c\u914d\u65b9\u5355\u540d\u5b57\uff1e']\uff0c</code></li> </ul> </li> </ul> <p>Kitchen converge</p> <p><code>chef client</code> -&gt; <code>Build Node</code> -&gt; Synchronize -&gt; Load (Libraries/Attributes/Definitions/Resources/Providers/Recipes) -&gt; Converge(\u6536\u655b\uff09 -&gt; Report(Seve Node/Exception) -&gt; Handlers</p>"},{"location":"chap1/chef_tutorial16_int/#_2","title":"\u83dc\u8c31\u67b6\u6784","text":"<pre><code>chef generate cookbook\n\nknife cookbook create\n</code></pre> <pre><code>cookbook\n\u251c\u2500\u2500 .kitchen.yml\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 attributes\n\u2502    \u2514\u2500\u2500 default/\n\u251c\u2500\u2500 chefignore\n\u251c\u2500\u2500 files/\n\u2502    \u2514\u2500\u2500 default/\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 recipes/\n\u2502    \u2514\u2500\u2500 default.rb\n\u2514\u2500\u2500 templates/\n    \u2514\u2500\u2500 default/\n</code></pre> <ul> <li>chefignore</li> </ul> <p>\u6b64\u6587\u4ef6\u5305\u542b\u4e00\u4e2a\u88abChef\u5ffd\u7565\u7684\u6587\u4ef6\u5217\u8868\u3002\u5f53\u4f7f\u7528Chef\u670d\u52a1\u5668\u5e76\u5c06\u672c\u5730\u83dc\u8c31\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u5217\u8868\u4e2d\u7684\u6587\u4ef6\u5c06\u88ab\u5ffd\u7565\u3002</p> <ul> <li>files</li> </ul> <p><code>files</code>\u6587\u4ef6\u5939\u662f\u6b64\u83dc\u8c31\u4e2d\u96c6\u4e2d\u5b58\u50a8\u5c06\u8981\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u7684\u6587\u4ef6\u7684\u5730\u65b9\u3002</p> <p>\u8981\u5206\u53d1\u5230\u6240\u6709\u8282\u70b9\u7684\u6587\u4ef6\u90fd\u4f1a\u653e\u5728files/default/\u5b50\u76ee\u5f55\u5185\u3002</p> <ul> <li>metadata.rb</li> </ul> <p><code>metadata.rb</code>\u6587\u4ef6\u5305\u542b\u8be5\u83dc\u8c31\u7684\u6240\u6709\u5143\u6570\u636e\u3002 \u6bcf\u4e2a\u83dc\u8c31\u5fc5\u987b\u6709\u4e00\u4e2a\u5143\u6570\u636e\u6587\u4ef6 <code>metadata.rb</code> \u6765\u5305\u542b\u83dc\u8c31\u7684\u540d\u5b57\u3001\u7248\u672c\u3001\u4f9d\u8d56\u4ee5\u53ca\u5176\u4ed6\u4fe1\u606f\u3002</p> <ul> <li>recipes</li> </ul> <p><code>recipe</code>\u76ee\u5f55\u5305\u542b<code>Chef</code>\u914d\u65b9\u5355\u3002\u914d\u65b9\u5355\u6587\u4ef6\u5305\u542bChef\u4ee3\u7801\u3002\u6b64\u76ee\u5f55\u4e2d\u5305\u542b\u591a\u4e2a<code>.rb</code>\u914d\u65b9\u5355\u6587\u4ef6\u3002</p> <ul> <li>templates</li> </ul> <p>templates\u76ee\u5f55\u5b58\u50a8Chef\u7684\u6a21\u677f\u3002<code>templates</code>\u76ee\u5f55\u548c<code>files</code>\u76ee\u5f55\u7c7b\u4f3c\u76ee\u7684\u90fd\u662f\u5c06\u6587\u4ef6\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u4e0a\u3002</p> <p>\u7136\u800c\uff0ctemplates\u4e2d\u7684\u6587\u4ef6\u662f\u5d4c\u5165\u5f0fRuby\u6a21\u677f\u6587\u4ef6(ERB)\uff0c\u6b64\u7c7b\u6587\u4ef6\u662f\u53ef\u5305\u542bRuby\u4ee3\u7801\u7684\u7eaf\u6587\u672c\u6587\u4ef6\uff0c\u5728\u590d\u5236\u5230\u76ee\u6807\u8282\u70b9\u4e4b\u524d\uff0c\u6587\u4ef6\u4e2d\u7684Ruby\u4ee3\u7801\u88ab\u6267\u884c\u5e76\u6e32\u67d3\u6210\u76f8\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u3002</p>"},{"location":"chap1/chef_tutorial16_int/#_3","title":"\u6210\u83dc\u8c31\u7ed3\u6784","text":"<pre><code># \u6210\u83dc\u8c31\u7ed3\u6784\n$ chef generate cookbook apache\n$ cd apache\n\n# Chef\u5ba2\u6237\u7aef\n$ knife cookbook create apache --cookbook-path .\n$ cd apache\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p><code>/apache/recipes/default.rb</code></p> <pre><code>package \"httpd\" do\n    action :install\nend\n\nservice \"httpd\" do\n    action [ :enable, :start ]\nend\n\ntemplate \"/var/www/html/index.html\" do\n    source 'index.html.erb'\n    mode '0644'\nend\n</code></pre> <pre><code>chef generate template index.html\n\n# /apache/templates/default/index.hmtl.erb\nThis site was set up by Jacob on &lt;%= node['hostname'] %&gt;\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#7","title":"7 \u5c5e\u6027","text":""},{"location":"chap1/chef_tutorial16_int/#chef_2","title":"Chef \u5c5e\u6027","text":"<p>\u5c5e\u6027\u4ee3\u8868\u7684\u662f\u4f60\u7684\u8282\u70b9\u7684\u76f8\u5173\u4fe1\u606f\u3002\u9664\u4e86ohai\u81ea\u6536\u96c6\u7684\u8282\u70b9\u76f8\u5173\u4fe1\u606f\u4e4b\u5916\uff0c \u4f60\u8fd8\u53ef\u4ee5\u5728chef\u914d\u65b9\u5355\u6216\u989d\u5916\u7684\u5c5e\u6027\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u5c5e\u6027</p> <pre><code>&lt;cookbook&gt;\n\u2514\u2500\u2500 attributes\n    \u2514\u2500\u2500 default.rb\n</code></pre> <pre><code>default[\"apache\"][\"dir\"] = \"/etc/apache2\"\n\nnode.default[\"apache\"][\"dir\"] = \"/etc/apache2\"\n</code></pre> <ul> <li> <p><code>Highest Proity</code>  &lt;-----    <code>Lowest Proiority</code></p> </li> <li> <p><code>Automatic(ohai) &gt; attributes defined in a recipe &gt; attributes defined in an attribute file</code></p> </li> </ul> <p>The higher Proity will be override by default</p>"},{"location":"chap1/chef_tutorial16_int/#setting-attributes","title":"Setting Attributes","text":"<pre><code>$ chef generate template motd\n\n$ chef generate attribute default\n</code></pre> <p><code>/attributes/default.rb</code></p> <pre><code>include_recipe 'motd-attributes::message'\n\ndefault['motd-attributes']['company'] = 'Chef'\n\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\nnode.default['ipaddress'] = '1.1.1.1'\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode '0644'\nend\n</code></pre> <p><code>templates/default/motd.erb</code></p> <pre><code>Welcome to &lt;%= node['motd-attributes']['company'] %&gt;\n&lt;%= node['motd-attributes']['message'] %&gt;\nThe hostname of this node is &lt;%= node['hostname'] %&gt;\nThe IP address of this node is &lt;%= node['ipaddress'] %&gt;\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_4","title":"\u5c5e\u6027\u4f18\u5148\u7ea7\u57fa\u7840","text":"<ul> <li>\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684<code>mode['motd_attributes']['company'\uff3d</code>\u7684\u503cMy Company\u6bd4\u5c5e\u6027\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u7684\u503cChef\u62e5\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\uff0c\u56e0\u6b64\u6a21\u677f\u4f7f\u7528\u4e86\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684\u503c\u3002</li> <li>\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684<code>node['ipaddeess'\uff3d</code>\u503c\u6bd4ohai\u81ea\u52a8\u8bbe\u5b9a\u768410.0.2.15\u503c\u6709\u66f4\u4f4e\u4f18\u5148\u7ea7\uff0c\u56e0\u6b64\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684\u503c\u88ab\u5ffd\u7565\uff0c\u6a21\u677f\u4f7f\u7528\u4e86\u9ad8\u4f18\u5148\u7ea7\u7684\u503c\u3002</li> <li>\u8fd9\u4e9b\u4f18\u5148\u7ea7\u4f53\u73b0\u4e86\u53d8\u91cf\u7684\u4f7f\u7528\u65b9\u6cd5\u5728\u5c5e\u80dc\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u7684\u503c\u88ab\u8bbe\u8ba1\u4e3a\u53ef\u4ee5\u88ab\u914d\u65b9\u5355\u8986\u76d6</li> <li>\u800c\u7531ohai\u751f\u6210\u7684\u81ea\u52a8\u5c5e\u80dc\u5219\u4e0d\u4f1a\u88ab\u4efb\u4f55\u5c5e\u6027\u8986\u76d6\uff0c\u56e0\u4e3a\u5b83\u4eec\u4ee3\u8868\u91cd\u8981\u7684\u4e0d\u5e94\u88ab\u7be1\u6539\u7684\u7cfb\u7edf\u4fe1\u606f\uff0c\u6bd4\u5982IP\u5730\u5740\u3002</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#include_recipe","title":"<code>Include_Recipe</code>","text":"<pre><code>include_recipe 'motd-attributes::message'\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_5","title":"\u5c5e\u6027\u4f18\u5148\u7ea7","text":"<ul> <li>\u81ea\u52a8(Autormatic):  \u81ea\u52a8\u5c5e\u6027\u4e3aohai\u6240\u751f\u6210\u7684\u5c5e\u6027\u3002</li> <li>\u9ed8\u8ba4(Default): \u901a\u5e38\u7531\u83dc\u8c31\u53ca\u5c5e\u6027\u6587\u4ef6\u8bbe\u5b9a\u7684\u5c5e\u6027\u3002</li> <li>\u91cd\u5199(Override):  \u6700\u5f3a\u7684\u5c5e\u6027\u8bbe\u5b9a\u65b9\u6cd5\uff0c\u52a1\u5fc5\u8bf7\u8c28\u614e\u4f7f\u7528\u3002</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#_6","title":"\u5c5e\u6027\u6392\u9519","text":"<p>\u5982\u679c\u9700\u8981\u4e3a\u5c5e\u6027\u62cd\u9519\uff0c\u6bd4\u5982\u627e\u5230\u4ed6\u4eec\u54ea\u91cc\u8bbe\u5b9a\uff0cnode\u5bf9\u8c61\u63d0\u4f9b\u7684<code>node.debug_value()</code>\u65b9\u6cd5\u80fd\u7ed9\u4e0e\u5f88\u591a\u5e2e\u52a9\u3002</p> <p>\u6bd4\u5982\u5982\u679c\u4f60\u4e0d\u77e5\u9053ohai\u8bbe\u5b9a\u4e86\u81ea\u52a8\u5c5e\u6027<code>node['ipaddress']</code>\u5f97\u77e5\u5b83\u662f\u7531\u3002\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>node.debug_value()</code>\u5f97\u77e5\u7531ohai\u8bbe\u5b9a\u7684</p> <pre><code>require 'pp'\nnode.default['ipaddress'] = '1.1.1.1'\npp node.debug_value('ipaddress')\n\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ninclude_recipe 'motd-attributes::message'\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode \"0644\"\nend\n</code></pre> <ul> <li>\u4ece\u8fd9\u91cc\uff0c \u53ef\u4ee5\u770b\u51fa<code>node[ipaddress]</code>\u5c5e\u6027\u5728automatic\u4f18\u5148\u7ea7\u88ab\u8bbe\u5b9a\u4e3a<code>\"172.16.72.142\"</code>,\u5728default\u4f18\u5148\u7ea7\u88ab\u8bbe\u5b9a\u4e3a<code>\"1.1.1.1\"</code><ul> <li>Chef\u7684\u786e\u5904\u7406\u4e86\"1.1.1.1\"\u8fd9\u4e2a\u503c\uff0c\u4f46\u6700\u7ec8\u7ed3\u679c\u88ab\u9ad8\u4f18\u5148\u7ea7\u7684\u81ea\u52a8\u5c5e\u6027\u8986\u76d6\u3002</li> <li>\u8981\u4e3a\u540c\u4e2a\u4f18\u5148\u7ea7\u522b\u88ab\u591a\u6b21\u8bbe\u5b9a\u7684\u5c5e\u6027\u6392\u9519\u6bd4\u5728\u4e0d\u540c\u4f18\u5148\u7ea7\u522b\u8bbe\u5b9a\u7684\u65f6\u5019\u590d\u6742\u4e00\u4e9b</li> <li>\u4f46\u4ecd\u7136\u975e\u5e38\u53ef\u884c\u3002\u4f60\u53ea\u9700\u8981\u5728<code>include_recipe</code>\u524d\u540e\u5206\u522b\u6253\u5370<code>node.debug_value(\uff09</code>\u7684\u503c\u3002</li> </ul> </li> </ul>"},{"location":"chap1/chef_tutorial16_int/#8-chef","title":"8 Chef \u670d\u52a1\u5668\u540c\u65f6\u7ba1\u7406\u591a\u4e2a\u8282\u70b9","text":""},{"location":"chap1/chef_tutorial16_int/#chef_3","title":"\u914d\u7f6e\u4f01\u4e1aChef\u670d\u52a1\u5668","text":"<ul> <li>\u65b0\u7684\u83dc\u8c31chef-server\u548cchef-manage</li> </ul> <pre><code>$ chef generate recipe adduser\n$ knife client list\n$ knife ssl fetch\n$ knife bootstrap node-centos65.vagrantup.com --sudo --connection-user vagrant --connection-password vagrant --node-ssl-verify-mode none --no-host-key-verify\n\n\n$ chef-solo -h\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#chef-solochef","title":"\u7528Chef Solo\u914d\u7f6eChef\u670d\u52a1\u5668","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528Chef Solo\uff08\u800c\u65e0\u9700Test Kitchen\uff09\u6765\u81ea\u52a8\u5316\u90e8\u7f72Chef\u670d\u52a1\u5668\u3002</p> <p>\u5728\u672a\u6765\uff0c\u5927\u591a\u6570Chef Solo\u7684\u529f\u80fd\u4f1a\u88ab\u8fc1\u79fb\u5230Chef Local\u6216Chef Zero,\u7136\u800cChef Solo\u4ecd\u7136\u5bf9\u81ea\u52a8\u5316\u914d\u7f6e\u548c\u90e8\u7f72Chef\u670d\u52a1\u5668\u672c\u8eab\u975e\u5e38\u6709\u7528\uff0c\u56e0\u4e3aChef Local\u6216Chef Zero\u4f1a\u4ee4\u4e00\u4e9b\u914d\u7f6e\u811a\u672c\u65e0\u6cd5\u8fa8\u8bc6\u53d1\u9001\u8bf7\u6c42\u9053\u54ea\u4e2aChef\u670d\u52a1\u5668 (Chef Local/Zero\u8fd8\u662f\u6b63\u5728\u914d\u7f6e\u7684Chef\u670d\u52a1\u5668\uff09\uff0c\u56e0\u4e3aChef Zero\u81ea\u5df1\u4e5f\u4f1a\u542f\u52a8\u4e00\u4e2a\u9a7b\u5185\u5b58\u7684Chef\u670d\u52a1\u5668\u3002</p>"},{"location":"chap1/chef_tutorial16_int/#9-chef-client","title":"9 \u793e\u533a\u4ee5\u53caChef-Client\u83dc\u8c31","text":""},{"location":"chap1/chef_tutorial16_int/#chef_4","title":"Chef\u670d\u52a1\u5668\u5982\u4f55\u9a8c\u8bc1\u8282\u70b9\u7684\u8bf7\u6c42","text":"<p>Chef\u53ca\u52a1\u5668\u9a8c\u8bc1validation.pem\u7684\u7b7e\u540d\uff08\u5c31\u50cf\u5b83\u9a8c\u8bc1client.pem\u7684\u7b7e\u540d\u4e00\u6837\uff09\u3002\u5728knife\u521d\u6b21\u51c6\u5907\uff08bootstrap\uff09\u8282\u70b9\u65f6\uff0cvalidation.pem\u521b\u5efa\u5728\u8282\u70b9\u4e0a\u7684<code>/etc/chef/validation.pem</code>\u4f4d\u7f6e\uff0e</p>"},{"location":"chap1/chef_tutorial16_int/#knife-cookbook-site","title":"Knife Cookbook Site \u63d2\u4ef6","text":"<pre><code>$ knife cookbook site search chef-client\n\n$ knife cookbook site show chef-client\n\n$ knife cookbook site download chef-client 11.4.0\n$ tar xvf chef-client*.tar.gz -C chef-repo/cookbooks\n\n$ knife cookbook upload chef-client \u2014cookbook-path cookbooks\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#knifessl","title":"\u914d\u7f6eKnife\u4f7f\u7528\u751f\u4ea7\u73af\u5883SSL\u8bbe\u7f6e","text":"<pre><code>$ knife ssl fetch\n$ knife ssl check \n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#chef-clientssl","title":"\u914d\u7f6eChef-client\u4f7f\u7528\u751f\u4ea7\u73af\u5883\u7684SSL\u8bbe\u7f6e","text":"<p>chef-client\u83dc\u8c31\u5305\u542b\u7528\u6765\u81ea\u52a8\u751f\u6210<code>/etc/chef/client.rb</code>\u914d\u7f6e\u6587\u4ef6\u7684<code>chef-client::config</code>\u914d\u65b9\u5355\u3002</p> <p>\u767b\u5f55\u5230\u8282\u70b9\u4e95\u67e5\u770b<code>/etc/chef/client.rb</code>\u6587\u4ef6\u3002 <code>/client.rb</code>\u6587\u4ef6\u5728\u4f60\u8fd0\u884c<code>knife bootsrap</code>\u65f6\u5728\u8282\u70b9\u4e0a\u88ab\u521b\u5efa\u7528\u6765\u914d\u7f6echef-client\u8bbe\u7f6e\u3002\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5e76\u786e\u4fdd\u5b8c\u6210\u65f6\u9000\u56de\u5230\u5f00\u53d1\u673a\u5668</p> <pre><code>$ cat /etc/chef/client.rb\n</code></pre> <pre><code>node.default['chef_client']['config']['ssl_verify_mode'] = ':verify_peer'\n</code></pre> <pre><code>{\n  \"chef_client\": {\n    \"config\": {\n      \"ssl_verify_mode\": \":verify_peer\"\n    }\n  }\n}\n</code></pre> <pre><code>$ knife node show --attribute \"chef_client.config.ssl_verify_mode\" \\\n&gt; node-centos65.vagrantup.com\n\n\n$ knife node show --attribute \"chef_client.config.ssl_ca_file\" \\\n&gt; node-centos65.vagrantup.com\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#10-chef-zero","title":"10 Chef zero","text":"<p>\u66f4\u5c11\u7684\u5185\u5b58\u542f\u52a8\u4e00\u4e2aChef\u670d\u52a1\u5668\u4f5c\u4e3a\u6d4b\u8bd5\u7528\u9014\u5c82\u4e0d\u662f\u5f88\u597d\u3002\u4e3a\u6b64Chef\u5f00\u53d1\u5305\u5305\u542b\u4e2a\u7cbe\u7b80\u7248\u672c\u7684Chef\u670d\u52a1\u5668\u79f0\u4f5c<code>chef-zero</code>.</p> <p><code>chef_zero</code>\u53ef\u4ee5\u4f7f\u7528\u5740\u5c1120MB\u5185\u5b58\u6765\u8fd0\u884c\u56e0\u4e3a\u5b83\u5f88\u5c0f\u6240\u4ee5\u542f\u52a8\u5f88\u5feb\u56e0\u6b64\u5f88\u9002\u5408\u7528\u4f5c\u6d4b\u8bd5\u3002</p> <p>\u7531\u4e8e\u8981\u8ba9Chef\u670d\u52a1\u5668\u7528\u6781\u5c11\u7684\u5185\u5b58\u5373\u53ef\u8fd0\u884c\uff0c<code>chef-zero</code>\u4e5f\u4f5c\u51fa\u4e86\u4e00\u4e9b\u727a\u7272\u5b83\u6ca1\u6709\u7f51\u9875\u7528\u6237\u754c\u9762\u4e5f\u5c0f\u4f1a\u6c38\u4e45\u5b58\u50a8\u4efb\u4f55\u6570\u636e\u4e00\u65e6Chef Zero\u505c\u6b62\u8fd0\u884c,\u6240\u6709\u6570\u636e\u90fd\u5c06\u4e22\u5931\u4f46\u5bf9\u4e8e\u6d4b\u8bd5\u73af\u5883\u4f60\u4e95\u4e0d\u9700\u8981\u7f51\u9875\u7528\u6237\u754c\u9762\u6216\u6c38\u4e45\u6570\u636e\u4fdd\u5b58</p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n  always_update_cookbooks: true\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[zero::default]\n    attributes:\n</code></pre> <pre><code>$ chef-client --local-mode --log_level --chef-zero-port 8889 --json-attributes dna.json\n$ chef-client --local-mode  --chef-zero-port 8889\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_7","title":"\u641c\u7d22","text":"<pre><code>$ chef-zero --port 9501\n\n$  knife upload nodes\n\n$ knife search &lt;index&gt; &lt;search_query&gt;\n$ knife search node \"*:*\"\n\n$ knife search &lt;index&gt; &lt;search_query&gt;\n$ knife search node \"*:*\"\n$ knife search node \"ipaddress:192.168.33.32\"\n$ knife search node \"ipaddress:192.*\"\n$ knife search node \"platfo*:centos\"\n$ knife search node \"platform_version:14.0?\"\n$ knife node show  snowman --long\n$ knife search node \"name:susu OR name:atwood\"\n$ knife search node \"ipaddress:192* AND platform:ubuntu\"\n$ knife search node \"*:*\" -a ipaddress\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#11-databag","title":"11 \u6570\u6982\u5305Databag","text":"<p>Chef\u670d\u52a1\u5668\u652f\u6301\u5b58\u50a8\u5168\u5c40\u7684\u3001\u53ef\u4ee5\u5728\u4e0d\u540c\u70b9\u4e0a\u8282\u70b9\u4e0a\u4f7f\u7528\u7684\u6570\u636e\u5b58\u50a8\u3002\u8fd9\u4e2a\u529f\u80fd\u79f0\u4f5c\u6570\u636e\u5305\uff08data bag)\u3002</p> <p>\u5728Chef\u7684\u6982\u5ff5\u4e2d\uff0c\u6570\u636e\u5305\u662f\u5305\u542b\u4ee3\u8868\u4f60\u7684\u57fa\u7840\u67b6\u6784\u800c\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e00\u4e2a\u8282\u70b9\u7684\u4fe1\u606f\u7684\u5bb9\u5668\u3002\u6570\u636e\u5305\u5305\u542b\u9700\u8981\u5728\u591a\u4e2a\u8282\u70b9\u5171\u4eab\u7684\u4fe1\u606f</p> <ul> <li>\u901a\u7528\u7684\u5bc6\u7801</li> <li>\u8f6f\u4ef6\u5b89\u88c5\u7684\u8bb8\u53ef\u8bc1\u94a5\u5319</li> <li>\u901a\u7528\u7684\u7528\u6237\u6216\u7ec4\u7684\u5217\u8868</li> </ul> <p>\u9664\u4e86\u6570\u636e\u5305\u5916,Chef\u8282\u70b9\u4e4b\u95f4\u65e0\u6cd5\u5171\u4eab\u6570\u636e\u3002</p> <p> </p>"},{"location":"chap1/chef_tutorial16_int/#knife","title":"\u4f7f\u7528Knife\u5728\u547d\u4ee4\u884c\u8fdb\u884c\u6570\u636e\u5305\u7684\u57fa\u672c\u64cd\u4f5c","text":"<pre><code>$ chef-zero --port 9501\n$ mkdir -p data_bags/users\n</code></pre> <p><code>chef-playground/data_bags/users/alice.json</code></p> <pre><code>{\n  \"id\": \"alice\",\n  \"comment\": \"Alice Jones\",\n  \"uid\": 2000,\n  \"gid\": 0,\n  \"home\": \"/home/alice\",\n  \"shell\": \"/bin/bash\"\n}\n</code></pre> <p>\u5728Chef\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u540d\u4e3ausers\u7684\u6570\u636e\u5305\uff0c\u8fd0\u884c<code>knife data create</code>\u547d\u4ee4</p> <pre><code>$ knife data_bag create users\nCreated data_bag[users]\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u5305\u9879\u76ee\uff0c\u8fd0\u884c<code>knife data_bag from file</code>\u547d\u4ee4\u3002</p> <pre><code>$ knife data_bag from file users alice.json\nUpdated data_bag_item[users::alice]\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_8","title":"\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u6570\u636e\u5305\u9879\u76ee\u7684\u6570\u636e\u521b\u5efa\u672c\u5730\u7528\u6237","text":"<pre><code>$ chef generate cookbook users\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u5728<code>provisioner:</code>\u4e2d\u6dfb\u52a0<code>data_bags_path</code>\u6765\u6307\u5b9a\u6570\u636e\u5305\u7684\u4f4d\u7f6e\u3002</p> <pre><code>provisioner:\n  name: chef_zero\n  data_bags_path: ../../data_bags\n</code></pre> <p><code>data_bags_path</code>:\u6307\u5411\u7684\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u5c06\u4f5c\u4e3a\u6570\u636e\u5305\u4e0a\u4f20\u5230<code>chef-zero</code>\u670d\u52a1\u5668\u3002\u5728\u751f \u4ea7\u73af\u5883\u4e2d\u6570\u636e\u5305\u7684\u6570\u636e\u901a\u5e38\u4e0d\u4f1a\u5305\u542b\u5728\u83dc\u8c31\u6587\u4ef6\u7ed3\u6784\u4e2d\u3002</p> <p><code>always_update_cookbooks: true</code></p> <pre><code>provisioner:\n  name: chef_zero\n  data_bags_path: ../../data_bags\n  always_update_cookbooks: true\n</code></pre> <p><code>cookbooks/users/recipes/default.rb</code></p> <pre><code>search(\"users\", \"*:*\").each do |user_data|\n    user user_data[\"id\"] do\n      comment user_data[\"comment\"]\n      uid user_data[\"uid\"]\n      gid user_data[\"gid\"]\n      home user_data[\"home\"]\n      shell user_data[\"shell\"]\n    end\nend\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528<code>each do</code>\u7ed3\u6784\u3002\u5728\u8fd9\u91cc\uff0c\u904d\u5386\u6570\u636e\u5305\u7684\u6bcf\u4e2a\u9879\u76ee\u5e76\u5c06\u6bcf\u4e2a\u9879\u76ee\u7684\u5185\u5bb9\u5b58\u5728<code>user_data</code>\u53d8\u91cf\u4e2d\u3002<code>user_data</code>\u662f\u4e00\u4e2a\u5b57\u5178\uff08\u54c8\u5e0c\uff09\u5305\u542b\u6570\u636e\u5305\u9879\u76ee\u7684\u952e\u503c\u5bf9\u513f</p> <p>update</p> <pre><code>$ knife data_bag from file users eve.json\nUpdated data_bag_item[users::eve]\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_9","title":"\u52a0\u5bc6\u6570\u636e\u5305","text":"<p>\u6570\u636e\u5305\u9879\u76ee\u53ef\u4ee5\u88ab\u5171\u4eab\u5bc6\u94a5\u52a0\u5bc6\u4f7f\u5176\u53ef\u4ee5\u5728Chef\u670d\u52a1\u5668\u4e2d\u5b58\u50a8\u9ad8\u5ea6\u5b89\u5168\u7684\u4fe1\u5305\u3002\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528\u52a0\u5bc6\u6570\u636e\u5305\u5b58\u50a8</p> <ul> <li>SSL\u8bc1\u4e66</li> <li>SSH\u5bc6\u94a5</li> <li>\u5bc6\u7801</li> <li>\u8bb8\u53ef\u8bc1\u53f7\u7801</li> </ul> <pre><code>$ knife data bag create api_keys\nCreated data_bag[api_keys]\n\n# \u5f53\u6570\u636e\u5305\u9879\u76ee\u9700\u8981\u52a0\u5bc6\u65f6,\u4f7f\u7528 --secret-file \u53c2\u6570\u6765\u4f20\u9012\u5bc6\u94a5\n$ knife data bag from file api_keys payment.json \\\n--secret-file encrypted_data_bag_secret data_bag_item[api_keys::payment]\n\n$ knife data bag show api_keys payment\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#chef-valut","title":"Chef-valut","text":"<pre><code>$ sudo gem install chef-vault --no-ri --no-rdoc\n</code></pre> <ul> <li> <p><code>--admin</code>\u9009\u9879\u5141\u8bb8\u5176\u521b\u5efa\u7684\u5ba2\u6237\u7aef\u9488\u5bf9\u5b83\u76f8\u5bf9\u7684\u8282\u70b9\u4ee5\u5916\u7684\u5176\u4ed6\u8282\u70b9\u4f7f\u7528<code>knife client show</code>\u548c<code>knife node commands</code>\u80cc\u540e\u7684<code>API</code>\u3002</p> <ul> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>knife client create</code>\u5c06\u5ba2\u6237\u7aef\u4fe1\u606f\u663e\u793a\u5728\u4e00\u4e2a\u7f16\u8f91\u5668\u5185\uff0c\u5141\u8bb8\u4f60\u5728\u3002</li> </ul> </li> <li> <p><code>client.pem</code>\u5bc6\u94a5\u751f\u6210\u4e4b\u524d\u5bf9\u5ba2\u6237\u7aef\u4f5c\u51fa\u4fee\u6539\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u9ed8\u8ba4\u503c\u5c31\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\uff0c\u56e0\u6b64\u6211\u4eec\u4f20\u9012<code>--disable-editing</code>\u53c2\u6570\u6765\u76f4\u63a5\u4f7f\u7528\u9ed8\u8ba4\u503c</p> <ul> <li><code>--file</code>\u53c2\u6570\u5c06\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002<code>client.pem</code>\u5199\u51fa\u5230\u4e00\u4e2a\u6307\u5b9a\u7684\u6587\u4ef6\u3002</li> </ul> </li> </ul> <pre><code>$  knife client create devhost  --disable-editing --file .chef/devhost.pem\nCreated client[devhost]\n</code></pre> <p><code>chef-vault</code>\u4f1a\u5b89\u88c5\u4e00\u4e2aknife\u547d\u4ee4\u7684\u63d2\u4ef6\u6765\u7ba1\u7406\u52a0\u5bc6\u6570\u636e\u5305\u3002</p> <p>\u8fd9\u4e2a\u63d2\u4ef6\u5c06<code>chef-valut</code>\u7684\u547d\u4ee4\u6574\u5408\u5230<code>knife vault</code>\u547d\u4ee4\u4e2d\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a\u52a0\u5bc6\u6570\u636e\u5305\u9879\u76ee\u5e76\u7528<code>chef-vdult</code> \u7ba1\u7406\u5bc6\u94a5\uff1a</p> <pre><code>$ knife vault create passwords mysql_root --json data_bags/passwords/mysql_root.json --search \"*:*\"  --mode client\n</code></pre> <pre><code>$ knife data bag show passwords mysql_root\n\n$ knife vault show passwords mysql_root --mode client=\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#12","title":"12 \u89d2\u8272","text":"<p><code>chef-playground/roles/webserver.json</code>\u6587\u4ef6</p> <pre><code>{\n  \"name\": \"webserver\",\n  \"description\": \"Web Server\",\n  \"json_class\": \"Chef::Role\",\n  \"chef_type\": \"role\",\n  \"run_list\": [\n    \"recipe[motd]\",\n    \"recipe[users]\",\n    \"recipe[apache]\"\n  ]\n}\n</code></pre> <p>\u7136\u540e\u8fd0\u884c<code>knife role from file</code>\u547d\u4ee4\u5c06<code>webserver.json</code>\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\uff0c\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u521b\u5efa\u8fd9\u4e2a\u89d2\u8272\u3002</p> <p>\u548c\u6570\u636e\u5305\u4e00\u6837<code>knife role from file</code>\u547d\u4ee4\u5047\u8bbe<code>webserver.json</code>\u4f4d\u4e8e\u540d\u4e3a<code>roles</code>\u7684\u5b50\u76ee\u5f55\u4e2d\uff0c\u800c\u4e0d\u662f\u5728\u5f53\u524d\u76ee\u5f55</p> <pre><code>$ knife role from file webserver.json\nUpdated Role webserver\n\n$ knife role show webserver\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7<code>knife node set</code>\u547d\u4ee4\u5728\u670d\u52a1\u5668\u4e0a\u8bbe\u5b9a\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u3002</p> <pre><code>$ knife node run_list set snowman \"role[webserver]\"\nsnowman:\n  run_list: role[webserver]\n</code></pre> <p>\u5728Chef\u8fd0\u884c\u65f6\uff0c\u8fd0\u884c\u6e05\u5355\u4e2d\u7684\u7f51\u9875\u670d\u52a1\u5668(webserver)\u89d2\u8272\u5c06\u5c55\u5f00\u81f3\u8be5\u89d2\u8272\u7684\u8fd0\u884c\u6e05\u5355</p> <ul> <li><code>recipe[motd]</code></li> <li><code>recipe[users]</code></li> <li><code>recipe[apache]</code></li> </ul>"},{"location":"chap1/chef_tutorial16_int/#_10","title":"\u5c5e\u6027\u548c\u89d2\u8272","text":"<p>\u89d2\u8272\u540c\u65f6\u53ef\u4ee5\u5305\u542b\u5c5e\u6027\u3002</p> <p>\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a<code>.json</code>\u6587\u4ef6\u6765\u8868\u793a\u4e00\u4e2a\u57fa\u672c\u89d2\u8272\u3002\u8fd9\u4e2a\u89d2\u8272\u5305\u542b\u6211\u4eec\u5728\u524d\u9762\u63a8\u8350\u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684<code>chef-client::delete_validation</code>\u548c<code>chef-client::default</code>\u914d\u65b9\u5355\u3002</p> <p><code>roles/base.json</code></p> <pre><code>{\n    \"name\": \"base\",\n    \"description\": \"Common recipes for all nodes\",\n    \"json_class\": \"Chef::Role\",\n    \"chef_type\": \"role\",\n    \"run_list\": [\n      \"recipe[chef-client::delete_validation]\",\n      \"recipe[chef-client]\"\n    ],\n    \"default_attributes\": {\n      \"chef_client\": {\n        \"init_style\": \"runit\"\n      }\n    }\n  }\n</code></pre> <pre><code>$ knife role from file base.json\nUpdated Role base\n</code></pre> <ul> <li> <p><code>Highest Proity</code>  &lt;-----    <code>Lowest Proiority</code></p> </li> <li> <p><code>Automatic(ohai) &gt;  Defined in a Role &gt; attributes defined in a recipe &gt; attributes defined in an attribute file</code></p> </li> <li> <p>\u89d2\u8272\u7684\u5c5e\u6027\u53ef\u4ee5\u91cd\u5199\u914d\u65b9\u5355\u6216\u5c5e\u6027\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5c5e\u6027</p> </li> <li>\u4f46\u4f18\u5148\u7ea7\u6bd4ohai\u5b9a\u4e49\u7684\u81ea\u52a8\u5c5e\u6027\u8981\u4f4e</li> <li>\u89d2\u8272\u4e2d\u7684\u5c5e\u6027\u8bbe\u8ba1\u4e3a\u5168\u5c40\u8bbe\u5b9a</li> <li>\u5e76\u6bd4\u5728\u83dc\u5355\u4e2d\u8bbe\u5b9a\u7684\u5c5e\u6027\u62e5\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\u3002</li> </ul>"},{"location":"chap1/chef_tutorial16_int/#_11","title":"\u89d2\u8272\u548c\u641c\u7d22","text":"<pre><code>$ knife search role \"run_list:recipe\\[apache\\]\"\n\n$ knife search node \"recipe:&lt;recipe_name&gt;\"\n</code></pre> <p>\u56e0\u4e3asnowman\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u5e76\u6ca1\u6709\u76f4\u63a5\u5f15\u7528<code>recipe[apache::config] snowman</code>\u8282\u5305\u542b<code>\"role[webserner]\"</code>\u89d2\u8272\u5c55\u5f00\u540e\u624d\u5305\u542b<code>\"recipe[apache]\"</code>\u914d\u65b9\u5355\u3002</p> <pre><code>$ knife search node \"recipe:apache\"\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_12","title":"\u89d2\u8272\u83dc\u8c31","text":"<pre><code>include_recipe \"motd\"\ninclude_recipe \"user\"\n</code></pre> <pre><code>knife search node role:webserver\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#13","title":"13 \u73af\u5883","text":"<p><code>chef-playground/environments/dev.json</code></p> <pre><code>{\n  \"name\": \"dev\",\n  \"description\": \"For developers!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.2.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\"\n}\n</code></pre> <p>\u8fd0\u884c<code>knife environment from file</code>\u5e76\u4f20\u9012\u521a\u521b\u5efa\u7684<code>dev.json</code>\u6587\u4ef6\u3002</p> <pre><code>$ knife environment from file dev.json\nUpdated Environment dev\n\n$ knife environment show dev\nchef_type:           environment\ncookbook_versions:\n  apache: = 0.2.0\ndefault_attributes:\ndescription:         For developers!\njson_class:          Chef::Environment\nname:                dev\noverride_attributes:\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#_13","title":"\u5c5e\u6027\u548c\u73af\u5883","text":"<p><code>chef-playground/roles/production.json</code></p> <pre><code>{\n  \"name\": \"production\",\n  \"description\": \"For prods!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.1.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\",\n  \"override_attributes\": {\n    \"motd\": {\n      \"message\": \"A production-worthy message of the day\"\n    }\n  }\n}\n</code></pre> <pre><code>$  knife environment from file production.json\nUpdated Environment production\n\n$ knife environment show production\nchef_type:           environment\ncookbook_versions:\n  apache: = 0.1.0\n ...\n</code></pre> <ul> <li> <p><code>Highest Proity</code>  &lt;-----    <code>Lowest Proiority</code></p> </li> <li> <p><code>Automatic(ohai) &gt;  Defined in a Role &gt; Defined in the Environment  &gt; attributes defined in a recipe &gt; attributes defined in an attribute file</code></p> </li> </ul> <p>\u56e0\u6b64\u5728\u4f7f\u7528\u73af\u586b\u5c5e\u6027\u65f6\u5f80\u5f80\u4f7f\u7528<code>override attributes</code>\u800c\u4e0d\u662f<code>default attributes</code></p> <pre><code>override_attributes:\n  motd:\n    message: A production-worthy message of the day\n</code></pre> <p><code>chef-zero/environments</code>\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u73af\u5883\u5b9a\u4e49\u3002\u8fd9\u4f1a\u4ee3\u8868\u4e00\u4e2aproduction\uff08\u751f\u4ea7\uff09\u73af\u5883\uff0e\u5728\u6b64\u73af\u5883\u4e2d\u6211\u4eec\u4e5f\u5c06\u4ee5\u91cd\u5199\u7ea7\u522b\u5b9a\u4e49<code>node['motd']['message']</code>\u5c5e\u6027</p> <p><code>chef-zero/environments/production.json</code></p> <pre><code>{\n  \"name\": \"production\",\n  \"description\": \"For prods!\",\n  \"cookbook_versions\": {\n    \"apache\": \"= 0.1.0\"\n  },\n  \"json_class\": \"Chef::Environment\",\n  \"chef_type\": \"environment\",\n  \"override_attributes\": {\n    \"motd\": {\n      \"message\": \"A production-worthy message of the day\"\n    }\n  }\n}\n</code></pre> <pre><code>provisioner:\n  name: chef_zero\n  nodes_path: ../../nodes\n  environments_path: ../../environments\n  always_update_cookbooks: true\n</code></pre> <p>\u540c\u65f6\uff0c\u6211\u4eec\u501f\u6b64\u4ecb\u7ecd<code>suites:</code>\u8bbe\u5b9a\u7684\u65b0\u8bed\u53e5\u3002</p> <p>\u901a\u8fc7<code>client_rb</code>\u548cenvironment\u8bed\u53e5\u4e3a\u6211\u4eec\u7684\u6c99\u76d2\u8282\u70b9\u5728\u5b83\u7684<code>/etc/chef/client.rb</code>\u4e2d\u8bbe\u5b9a\u73af\u5883</p> <pre><code>suites:\n  - name: prod\n    provisioner:\n      client_rb:\n        environment: production\n  ...\n</code></pre> <p>\u5728\u6b64\u865a\u62df\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u7528Test Kitchen\u5c06\u60f3\u8981\u7684\u73af\u5883\u5199\u5230\u6d4b\u8bd5\u8282\u70b9\u7684<code>/etc/chef/client.rb</code>\u6587\u4ef6\u4e2d</p> <p>\u7136\u800c\u5728\u771f\u5b9e\u73af\u5883\u4e2d\uff0c\u5e94\u8be5\u7528<code>chef-client::config</code>\u914d\u65b9\u5355\u6765\u8bbe\u5b9a\u76ee\u6807\u8282\u70b9\u7684<code>/etc/chef/client.rb</code>\u6587\u4ef6\u4e2d\u7684environment\u8bbe\u5b9a\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u4ee5\u4e0b\u5c5e\u6027\u6765\u63a7\u5236\u8bbe\u5b9a\u7684<code>ssl_verify_node</code>\u4e00\u6837\uff1a</p> <pre><code>node.default['chef_client']['config']['environment'] = 'production'\n</code></pre>"},{"location":"chap1/chef_tutorial16_int/#14","title":"14 \u6d4b\u8bd5","text":"<ul> <li>\u4f7f\u7528Serverspec\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u4f7f\u7528Foodcritic\u8fdb\u884c\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u4f7f\u7528Let\u8fdb\u884c\u60f0\u6027\u6c42\u503c</li> <li>\u751f\u6210\u4e00\u4efd\u6d4b\u8bd5\u8986\u76d6\u62a5\u544a <code>ChefSpec::Coverage.report</code></li> <li>\u5728<code>spec_helper.rb</code>\u4e2d\u5171\u4eab\u6d4b\u8bd5\u4ee3\u7801</li> </ul>"},{"location":"chap1/chef_tutorial2/","title":"\u7b2c\u4e8c\u8282 Ruby\u548cChef\u8bed\u6cd5","text":""},{"location":"chap1/chef_tutorial2/#1ruby","title":"1\u3001Ruby\u8bed\u6cd5\u548c\u6848\u4f8b","text":"<p>\u63d0\u793a\u8bed\u6cd5\u68c0\u594b </p> <p>Ruby\u63d0\u4f9b\u5185\u5efa\u7684\u673a\u5236\u6765\u9a8c\u8bc1\u6587\u4ef6\u662f\u5426\u5305\u542b\u6709\u6548\u7684<code>Ruby</code>\u8bed\u6cd5. \u53ef\u4ee5\u901a\u8fc7\u4f20\u9012<code>-c</code>\u53c2\u6570\u548c\u6587\u4ef6\u8def\u5f84\u5230<code>Ruby</code>\u89e3\u91ca\u5668\u6765\u68c0\u67e5<code>Ruby</code>\u6587\u4ef6 </p> <pre><code>$ ruby -c /path/to/ruby/file \n</code></pre> <p>\u5982\u679c\u8bed\u6cd5\u662f\u6b63\u786e\u7684\u6b64\u547d\u4ee4\u4f1a\u8fd4\u56de<code>Syntax OK</code>, \u5426\u5219\u5b83\u4f1a\u8fd4\u56de\u4e00\u4e2a\u5806\u6808\u8f68\u8ff9\u6765\u5e2e\u4f60\u627e\u5230\u54ea\u884c\u4ee3\u7801\u51fa\u9519\u4e86\u3002 </p>"},{"location":"chap1/chef_tutorial2/#1-1","title":"1-1 \u6ce8\u91ca","text":"<p>\u5728<code>Ruby</code>\u4e2d, \u4e95\u53f7(#)\u4ee3\u8868\u6ce8\u91ca\u53e3\u6ce8\u91ca\u662f\u4ee3\u7801\u4e2d\u7684\u6587\u6863<code>\\\uff03</code>\u7b26\u53f7\u4e4b\u540e\u7684\u4ee3\u7801\u5c06\u88ab\u89e3\u91ca\u5668\u5ffd\u7565, \u53ea\u4f9b\u4eba\u9605\u8bfb:</p> <pre><code>variable = 2 # This is comment\n # This multiple lines comment\n # \"#\" This is start of line\n</code></pre> <pre><code># Why buy bacon.strips\nif bacon.strips &lt; 5\n    buy_bacon\nend\n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-2","title":"1-2 \u53d8\u91cf","text":"<p>\u4ece\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\u6211\u4eec\u5426\u5230\uff0c<code>Ruby</code>\u4e2d\u7684\u53d8\u91cf\u5c06\u7b26\u53f7\u53f3\u8fb9\u7684\u503c\u8d4b\u4e88\u5de6\u8fb9\u7684\u53d8\u6563\u540d </p> <pre><code>variable=2 #\u8fd9\u5c06\u6570\u503c2\u8d4b\u7ed9\u53d8\u91cf\u540d\u4e3avariable\u7684\u53d8\u91cf\n</code></pre> <p>\u56e0\u4e3a<code>Ruby</code>\u4e0d\u662f\u9759\u6001\u7c7b\u578b\u8bed\u8a00, \u6240\u4ee5\u4e0d\u9700\u8981\u5728\u7ed9\u53d8\u91cf\u8d4b\u503c\u65f6\u58f0\u660e\u53d8\u91cf\u7c7b\u578b\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u503c\u961f\u7ed9\u53d8\u91cf\uff1a</p> <p>\u4e00\u4e2a\u6570\u5b57\u4e00\u4e2a\u5b87\u7b26\u4e32<code>hello</code>\u548c\u4e00\u4e2a\u5bf9\u8c61\u3002 \u8d4b\u503c\u4e4b\u524d\u4f60\u4e0d\u9700\u8981\u544a\u8bc9Ruby\u4e00\u4e2a\u53d8\u91cf\u8981\u50a8\u5b58\u4ec0\u4e48\u7c7b\u578b\u7684\u5185\u5bb9\uff1a </p> <pre><code>a = 1\nb = 'hello'\nc = Object.new \n</code></pre> <p>\u5728Ruby\u4e2d\u53d8\u91cf\u53ef\u4ee5\u5728\u5b83\u58f0\u660e\u7684\u6700\u8fdc\u8303\u56f4\u5185\u8bbf\u95ee\u3002 </p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u66f4\u597d\u5730\u5c55\u793a\u53d8\u91cf\u8303\u5185\u7684\u8bbf\u95ee\uff0c\u9996\u5148\u6211\u4eec\u58f0\u660e\u4e00\u4e2a\u540d\u5b57\u4e3a<code>bacon_type</code>\uff08\u57f9\u6839\u7c7b\u578b\uff09\u7684\u9876\u7ea7\u53d8\u91cf\uff0c \u5e76\u8d4b\u503c<code>crispy</code>\u3002</p> <p>\u7136\u540e\u8fd9\u57f9\u6839\u70e4\u4e24\u6b21, \u4e00\u4e2a\u989d\u5916\u7684\u53d8\u91cf<code>temperature</code>\u88ab\u8d4b\u503c<code>300</code>,\u6700\u540e\u811a\u672c\u5c1d\u8bd5\u8bbf\u95ee<code>temperature</code>\u53d8\u91cf\u4f46\u5b83\u5df2\u7ecf\u5728\u53ef\u8bbf\u95ee\u8303\u56f4\u4e4b\u5916 </p> <pre><code>bacon_type = 'crispy'\n\n2.times do\n    puts bacon_type\n    temperature = 300\nend\n\nputs temperature\n</code></pre> <ul> <li>\u5728\u9876\u7ea7\u8303\u56f4<code>bacon_type</code>\u53d8\u91cf\uff0c \u56e0\u6b64\u5b83\u5728\u6b64\u60c5\u5883\u4e0b\u7684\u4efb\u4f55\u5730\u65b9\u53ef\u4ee5\u88ab\u8bbf\u95ee </li> <li>\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u66f4\u52a0\u7279\u5b9a\u7684\u8303\u56f4\u5185\uff08\u6bd4\u5982\u4e00\u4e2a\u5faa\u73af\uff09\u8bbf\u95ee<code>bacon_type</code>\u53d8\u91cf\u3002 </li> <li>\u5728\u4e00\u4e2a\u8303\u56f4\u5185\u58f0\u660e\u7684\u53d8\u6700\u53ea\u80fd\u5728\u8fd9\u4e2a\u8303\u56f4\u5185\u88ab\u8bbf\u95ee </li> <li>\u5728\u53d8\u91cf\u58f0\u660e\u7684\u8303\u56f4\u5916\u5c1d\u8bd5\u8bbf\u95ee\u8fd9\u4e2a\u53d8\u6700\u4f1a\u5f97\u5230\u4e00\u4e2a\u5f02\u5e38<code>undefined local variable or method 'temperature'</code></li> </ul>"},{"location":"chap1/chef_tutorial2/#1-3","title":"1-3 \u6570\u5b66\u8fd0\u7b97","text":"<pre><code>if hours % 3\n    puts \"It's bacon time\"\nend\n</code></pre> <pre><code>Math.hypot(43, 57)\n</code></pre> <p>Arithmetic Operators</p>"},{"location":"chap1/chef_tutorial2/#1-4","title":"1-4 \u5b57\u7b26\u4e32","text":"<p>\u5728<code>Ruby</code>\u521b\u5efa\u5b57\u7b26\u4e32\u6709\u4e24\u79cd\u666e\u904d\u7684\u65b9\u6cd5, \u7528\u5355\u5f15\u53f7\u6216\u8005\u53cc\u5f15\u53f7\uff0c </p> <ul> <li>\u5355\u5f15\u53f7\u7684\u597d\u5904\u662f\u5360\u66f4\u5c11\u7684\u4f4d\u7f6e\u5e76\u4e0d\u4f1a\u5e94\u7528\u5185\u63d2\u7684\u53d8\u91cf</li> <li>\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u7684\u4f18\u52bf\u662f\u652f\u6301\u7ed9\u4f5c\u4e3a\u5b57\u7b26\u4e32\u4e00\u90e8\u5206\u7684\u53d8\u91cf\u8d4b\u503c\uff1b\u8fd9\u6837\u7684\u8d4b\u503c\u8fc7\u7a0b\u79f0\u4f5c\u5b57\u7b26\u4e32\u5185\u63d2\u3002</li> </ul> <p>\u5728\u53cc\u5f15\u53f7\u5185\u7684\u5b57\u7b26\u4e32\u4e2d\uff0c\u6211\u4eec\u7528\u4e95\u53f7\u548c\u5927\u62ec\u53f7\u6765\u8868\u793a\u9700\u8981\u5185\u63d2\u7684\u53d8\u91cf\uff0cRuby\u5219\u4f1a\u7528\u8fd9\u4e2a\u53d8\u91cf\u7684\u503c\u66ff\u6362\u8fd9\u4e2a\u53d8\u91cf\u4f5c\u4e3a\u5b57\u7b26\u4e32\u7684\u4e00\u90e8\u5206\u3002\u5728\u4ee5\u4e0b\u4f8b\u5b50\u4e2d\uff0c<code>#\\{x</code>\uff5d\u5728\u5b57\u7b26\u4e32\u4e2d\u4ee3\u8868\u53d8\u91cf<code>x</code>\u7684\u503c\u3002 </p> <p>\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u548c\u5355\u5f15\u53f7\u5b57\u7b26\u4e32\u90fd\u7528\u53cd\u659c\u6760\uff08\\\uff09\u5b57\u7b26\u6765\u8f6c\u4e49\u7279\u6b8a\u5b57\u7b26\u3002</p> <pre><code>\"double quoted string\" #=&gt; 'single quoted string' \n'double quoted string\" #=&gt; \"single quoted string\" \n\nx=\"hello\" \n\n\"#{x} world\" #=&gt;  \"hello world\" \n'#{x} world' #=&gt;  '#{x} world'\n</code></pre> <ul> <li>\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u5185\u63d2\u53d8\u91cf\uff0c\u8f93\u51fa\u7ed3\u679c\u4e2d\u53d8\u91cf\u503c\u66ff\u6362\u4e86\u53d8\u91cf\u540d\u3002</li> <li>\u5355\u5f15\u53f7\u5b57\u7b26\u4e32\u4e0d\u652f\u6301\u5185\u63d2\u53d8\u91cf\uff0c\u8f93\u51fa\u7ed3\u679c\u5c31\u662f\u5f15\u53f7\u5185\u5185\u5bb9. *</li> </ul> <pre><code>\"quotes in \\\"quotes\\\"\" #=&gt; \"quotes in \\\"quotes\\\"\" \n'quotes in \\'quotes\\'' #=&gt; \"quotes in \\\"quotes\\\"\" \n</code></pre> <p>\u6709\u65f6\u5019\u9700\u8981\u8f6c\u4e49\u7279\u6b8a\u5b57\u7b26\u3002</p> <p>\u4f60\u9700\u8981\u8f6c\u4e49\u540d\u5b57\u4e2d\u7684\u5355\u5f15\u53f7\uff1a </p> <pre><code>player=\u2019Jim O\\'Rourke' \n</code></pre> <p>\u6216\u8005\u4e5f\u53ef\u4ee5\u7528\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u6765\u907f\u514d\u4f7f\u7528\u8f6c\u4e49\u5b57\u7b26\uff1a </p> <pre><code>player=\"Jim O'Rourke\" \n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-5-heredoc","title":"1-5 Heredoc\u8868\u793a\u6cd5","text":"<p>\u5728<code>Chef</code>\u4e2d\uff0c\u4f60\u6709\u65f6\u4f1a\u89c1\u5230\u5b57\u7b26\u4e32\u7684<code>\u201cheredoc\u201d</code>\u8868\u793a\u6cd5\u3002<code>heredoc</code>\u5728\u8868\u793a\u591a\u884c\u5b57\u7b26\u4e32\u65f6\u5c24 \u4e3a\u6709\u7528\u3002</p> <p><code>heredoc</code>\u8868\u793a\u6cd5\u7531\u4e24\u4e2a<code>\u201c\u5c0f\u4e8e\u53f7\u201d</code>(&lt;&lt;)\u52a8\u5f00\u59cb\uff0c\u7136\u540e\u8ddf\u7740\u4e00\u4e9b\u7528\u6765\u63cf\u8ff0\u6587\u672c\u7684\u6807 \u8bc6\u3002\u8fd9\u4e9b\u6807\u8bc6\u53ef\u4ee5\u5305\u542b\u4efb\u4f55\u5b57\u7b26\u4e32\uff0c\u4f46\u4e0d\u5e94\u8be5\u662f\u4e00\u4e2a\u5728\u8981\u8868\u793a\u7684\u6587\u672c\u672c\u8eab\u4e2d\u5305\u542b\u7684\u5b57\u7b26\u4e32\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528<code>METHOD_DESCRPTION</code>\u4f5c\u4e3a\u63cf\u8ff0\u6587\u672c\u7684\u6807\u8bc6\uff1a </p> <pre><code>&lt;&lt;METHOD_DESCRIPTION \nThis is a multiline string. \n\nAll the whitespace is preserved,and I can even apply# {interpolation}inside this block. \nMETHOD DESCRIPTION \n</code></pre> <p>\u4f8b\u5b50\u4e2d\u663e\u793a\u4e86\u5728\u7528<code>heredoc</code>\u8868\u793a\u7684\u5b57\u7b26\u4e32\u4e2d\u53ef\u4ee5\u5305\u542b\u591a\u884c\u6587\u672c\u6216\u7a7a\u767d\u7b26\uff0c\u751a\u81f3\u53ef\u4ee5\u5e94\u7528\u5185 </p>"},{"location":"chap1/chef_tutorial2/#1-6-true-and-false","title":"1-6 True and False \u8868\u793a\u6cd5","text":"<p><code>! -&gt; not</code></p> <pre><code>!true =&gt; false\nnot true =&gt; false\nnot flase =&gt; true\n!!true =&gt; true\nnot nil =&gt; true\n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-7","title":"**1-7 \u6570\u7ec4 **","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528<code>Ruby</code>\u6570\u7ec4\u6765\u521b\u5efa\u5217\u8868\u3002\u5982\u4ee5\u4e0b\u4f8b\u5b50\u6240\u793a\uff0c<code>Ruby</code>\u7684\u6570\u7ec4\u4f7f\u7528\u4e2d\u62ec\u53f7\u6765\u8868\u793a\uff0e\u6570\u7ec4\u7684\u7d22\u5f15\u4ece\u96f6\u5f00\u59cb\uff0c\u5f53\u4f60\u5f80\u6570\u7ec4\u4e2d\u6dfb\u52a0\u65b0\u9879\u76ee\u65f6\uff0c<code>Ruby</code>\u7684\u89e3\u91ca\u5668\u4f1a\u81ea\u52a8\u5206\u914d\u6240\u9700\u7684\u5185\u5b58\uff0c\u56e0\u6b64\u4f60\u4e0d\u9700\u8981\u8003\u8651\u52a8\u6001\u8c03\u6574\u6570\u7ec4\u5927\u5c0f\uff1a</p> <pre><code>types = ['crispy,'raw','crunchy','grilled'] \ntypes.length   #4\ntypes.size     #4\ntypes.push 'smoked'  #  ['crispy,'raw','crunchy','grilled','smoked']\ntypes &lt;&lt; 'deep fried' # ['crispy,'raw','crunchy','grilled','smoked','deep fried']\n\ntypes[0]   #crispy\ntypes.first #crispy\ntypes.last  #deep fried\ntypes[0..1] #['crispy,'raw']\n</code></pre> <pre><code>emp[0]  #Morgan\nemp[1]  #Citi\n</code></pre> <pre><code>emp &lt;&lt; 'Bob'\nemp.last #Bob\n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-8","title":"1-8 \u6563\u5217\uff08\u54c8\u5e0c\uff09","text":"<p><code>Ruby</code>\u652f\u6301\u6563\u5217\u7684\u5185\u5bb9\u662f\u952e\u503c\u5bf9 \uff08\u54c8\u5e0c\uff09\uff08\u6709\u65f6\u5019\u5728\u5176\u4ed6\u8bed\u8a00\u4e2d\u53eb\u5b57\u5178\u6216\u6620\u50cf\uff09\u3002\u6563\u5217\u548c\u6570\u7ec4\u7c7b\u4f3c\uff0c\u4f46\u5b83 \uff08\u4e00\u4e2a\u952e\u5bf9\u5e94\u4e00\u4e2a\u503c\uff09\uff0c\u800c\u4e0d\u662f\u5355\u4e2a\u9879\u76ee\u3002\u6563\u5217\u53ef\u4ee5\u901a\u8fc7\u5927\u62ec\u53f7\u6765\u521b\u5efa <code>(+_{})</code>: </p> <pre><code>prices = { oscar: 4.55, boars: 5.23, wright: 4.65, beelers: 6.99}\nprices[:oscar]   #4.55\nprices[:boars]   #5.23\n\nprices[:oscar]=1.00\nprices.values  #[4.55, 5.23, 4.65, 6.99]\n</code></pre> <p>\u5b57\u7b26\u4e32\uff0c\u7b26\u53f7\u548c<code>Mash</code></p> <p><code>key: value</code>   &lt;=&gt;   <code>:key =&gt; value&lt;1&gt;</code></p> <ul> <li><code>=&gt;</code> \u6563\u5217\u706b\u7bad\uff08hash rocket)</li> </ul> <pre><code>hash = { 'key' =&gt; value }\nhash['key'] #value\n</code></pre> <ul> <li>\u5b57\u7b26\u4e32\u4f5c\u4e3a\u952e</li> </ul> <pre><code>mash = HashieMash.new((key: value)) \n\nmash[:key]   # value\nmash['key']  # value\nmash.key     # value\n</code></pre> <pre><code>players = {\n   'M, A' =&gt; {\n     'AVG' =&gt; 0.311,\n        'OBP' =&gt; 0.385,\n        'SLG' =&gt; 0.507,\n   },\n   'A, P' =&gt; {\n    'AVG' =&gt; 0.235,\n        'OBP' =&gt; 0.297,\n        'SLG' =&gt; 0.477,\n   }\n}\n</code></pre> <pre><code>players['M, A'] # {'AVG' =&gt; 0.311, 'OBP' =&gt; 0.385, 'SLG' =&gt; 0.507}\n</code></pre> <pre><code>players['M, A']['AVG']  # 0.311\n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-9","title":"1-9 \u6761\u4ef6\u548c\u63a7\u5236\u6d41","text":"<ul> <li><code>if</code> <code>if not</code>&lt;=&gt;<code>unless</code></li> </ul> <pre><code>if some condition \n    puts \"happened\" \nelse \n    puts \"didn't happen\" \nend \n\n# unless \nsome condition \n    puts \"didn't happen\" \nelse \n    puts \"happened\" \nend \n</code></pre> <pre><code>if false \n    puts \"this can't possibly happen\" \nelsif nil  # nil is false\n    puts \"this won't happen either\" \nelsif true \n    puts \"this will definitely happen\" \nelse \n    puts \"this won't happen, because the method is short-circuited end \n</code></pre> <ul> <li><code>case</code></li> </ul> <pre><code>case some_condition \nwhen \"literal string\" \n    # ...\nwhen /regular expression/ \n    # when list, of, items \n    # ...\nelse  \n    # ...\nend \n</code></pre> <pre><code>case player.age \nwhen 0..12 \n    'Minor League' \nwhen 13..18 \n    'Developing' \nwhen 19..30 \n    'Prime' \nwhen 31..40 \n    'Decline' \nelse \n    'Retirement' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#1-10","title":"1-10 \u65b9\u6cd5\u3001\u7c7b\u548c\u6a21\u5757","text":"<p>\u867d\u7136\u5728\u5b66\u4e60\u548c<code>Chef</code>\u66f4\u9ad8\u7ea7\u7684\u4ea4\u4e92\u4e4b\u524d\uff0c\u4e0d\u9700\u8981\u7528\u5230\u8fd9\u4e9b\uff0c\u4f46<code>Ruby</code>\u652f\u6301\u65b9\u6cd5\u3001\u7c7b\u3001\u6a21\u5757\u548c\u9762\u5411\u5bf9\u8c61\u7684\u7ed3\u6784\u3002\u5728Ruby\u4e2d\uff0c</p> <p>\u6211\u4eec\u7528<code>def</code>\u5173\u952e\u5b57\u6765\u5b9a\u4e49\u65b9\u6cd5\uff0c\u7528<code>class</code>\u5173\u952e\u5b57\u6765\u5b9a\u4e49\u7c7b\uff0c \u7528<code>module</code>\u5173\u952e\u5b57\u6765\u5b9a\u4e49\u6a21\u5757\uff1a </p> <pre><code>class Bacon\n def cook(temperature)\n    #...\n end\nend\n\nmodule Edible\n    #...\nend\n</code></pre> <ul> <li>\u7528<code>class</code>\u5173\u952e\u5b57\u521b\u5efa\u7c7b\u3002 </li> <li>\u7528<code>def</code>\u5173\u952e\u5b57\u521b\u5efa\u65b9\u6cd5\uff0c\u5e76\u4e14\u53ef\u4ee5\u63a5\u53d7\u53c2\u6570\u3002 </li> <li><code>module</code>\u5173\u952e\u5b57\u521b\u5efa\u6a21\u5757\u3002 </li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u65b9\u6cd5\u7684\u540d\u5b57\u5c06\u5176\u8c03\u7528\u3002\u8c03\u7528\u65f6\uff0c<code>Ruby</code>\u5e76\u4e0d\u8981\u6c42\u5bf9\u53c2\u6570\u4f7f\u7528\u62ec\u53f7\uff0c\u4f46\u6211\u4eec\u5f3a\u70c8\u63a8\u8350\u517b\u6210\u4f7f\u7528\u62ec\u53f7\u7684\u4e60\u60ef\u6765\u589e\u52a0\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\uff1a </p> <ul> <li><code>my_method(5)</code> </li> <li> <p><code>my_method 5</code> </p> </li> <li> <p>\u6267\u884c\u540d\u5b57\u4e3a<code>my_method</code>\u7684\u65b9\u6cd5\uff0c\u5e76\u4f7f\u7528\u53c2\u6570<code>5</code></p> </li> <li>\u540c\u6837\u6267\u884c<code>my_method</code>\u65b9\u6cd5\u53ca\u4f7f\u7528\u53c2\u6570<code>5</code>\uff0c\u4f46\u4e0d\u4f7f\u7528\u62ec\u53f7\u3002 </li> </ul> <p>\u5728Ruby\u4e2d\uff0c\u65b9\u6cd5\u662f\u53ef\u4ee5\u8fde\u7eed\u6267\u884c\u7684\u3002 \u5982\u679c\u4e00\u4e2a\u65b9\u6cd5\u7684\u8fd4\u56de\u7ed3\u679c\u53ef\u4ee5\u6267\u884c\u53e6\u4e00\u4e2a\u65b9\u6cd5\uff0c\u53ef  \u4ee5\u5c06\u5b83\u4eec\u5199\u5728\u4e00\u884c\u6267\u884c<code>downcase</code>\u65b9\u6cd5 \u4e0b\u9762\u7684\u4f8b\u5b50\u7528\u4e00\u884c\u4ee3\u7801\u5bf9  <code>\"String\"</code>\uff0c\u5b57\u7b26\u4e32\u6267\u884c<code>upcase</code>\u65b9\u6cd5\uff0c\u5bf9\u5176\u7ed3\u679c\u7136\u540e\u5bf9\u5171\u7ed3\u679c\u6267\u884c<code>reverse</code>\u65b9\u6cd5\uff1a </p> <p><code>\"String\".upcase.downcase.reverse #=&gt; \"gnirts\"</code> </p>"},{"location":"chap1/chef_tutorial2/#2chef","title":"2\u3001Chef\u8bed\u6cd5\u548c\u6848\u4f8b","text":"<p><code>Chef</code>\u4f7f\u7528\u7684\u9886\u57df\u4e13\u7528\u8bed\u8a00\uff08<code>DSL</code>\uff09\u662f<code>Ruby</code>\u7684\u4e00\u4e2a\u5b50\u96c6\u3002\u5728<code>Chef</code>\u4ee3\u7801\u91cc\uff0c\u4f60\u4e0d\u4ec5\u53ef\u4ee5\u4f7f\u7528 \u5b83\u7684\u9886\u57df\u4e13\u7528\u8bed\u8a00\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>Ruby</code>\u7f16\u7a0b\u8bed\u8a00\u7684\u5168\u90e8\u529f\u80fd\u3002\u8fd9\u5141\u8bb8\u4e86\u5f00\u53d1\u8005\u5728<code>Chef</code>\u4ee3\u7801\u4e2d\u4f7f\u7528\u6761\u4ef6\u3001\u6267\u884c\u6570\u5b66\u8fd0\u7b97\u4ee5\u53ca\u548c\u5176\u4ed6\u670d\u52a1\u6c9f\u901a\uff0c\u7b49\u7b49\u3002\u5728\u6df1\u5165\u8ba8\u8bba<code>Chef</code>\u7684\u9886\u57df\u4e13\u7528\u8bed\u8a00\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u770b\u770b\u57fa\u672c\u8bed\u6cd5\u3002 </p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a<code>Chef</code>\u9886\u57df\u4e13\u7528\u8bed\u8a00\u7684\u4f8b\u5b50\uff0c\u5c55\u793a\u5982\u4f55\u901a\u8fc7\u4f7f\u7528<code>Chef</code>\u7684\u201c\u7528\u6237\u201d\u8d44\u6e90\u6765\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u8d26\u6237\u3002\u5728<code>Chef</code>\u4e2d\uff0c\u201c\u8d44\u6e90\u201d\u662f\u7528\u6765\u5b9a\u4e49\u4f60\u7684\u57fa\u7840\u67b6\u6784\u7279\u5b9a\u90e8\u5206\u7684\u7ec4\u4ef6\u3002</p> <p>\u6bd4\u5982\u8bf4\uff0c\u4ee5\u4e0b\u7684\u4f8b\u5b50\u7ba1\u7406\u4e00\u4e2a\u540d\u4e3a<code>alice</code>\u3001\u7528\u6237<code>ID</code>\u4e3a<code>503</code>\u7684\u7528\u6237\u8d26\u53f7\uff1a </p> <pre><code>user 'alice' do\n    uid '50\nend\n</code></pre> <p>\u4ee5\u4e0b\u7684\u4f8b\u5b50\u66f4\u62bd\u8c61\u5730\u5c55\u793a\u8c03\u7528<code>Chef</code>\u9886\u57df\u4e13\u7528\u8bed\u8a00\u65b9\u6cd5\u7684\u7efc\u5408\u8bed\u6cd5\uff0c\u4ee5\u4e0a\u7684\u4f8b\u5b50\u57fa\u4e8e\u8fd9\u4e2a\u6cd5\uff1a </p> <pre><code>resource 'NAME' do \n    parameter1 value1 \n    parameter2 value2 \nend \n</code></pre> <p>\u7b2c\u4e00\u4e2a\u90e8\u5206\u6307\u5b9a\u8981\u4f7f\u7528\u7684\u8d44\u6e90\uff08\u6bd4\u5982\u8bf4<code>template</code>\u3001 <code>package</code>\u6216<code>service</code>)\uff0c\u7136\u540e\u8ddf\u7740\u8be5\u8d44 \u6e90\u7684\u540d\u5b57\u5c5e\u6027\uff08<code>name_attribute</code>)\u3002</p> <p>\u8fd9\u540d\u5b57\u7684\u610f\u4e49\u548c\u7528\u9014\u5728\u4e0d\u540c\u7684\u8d44\u6e90\u4e2d\u6709\u6240\u4e0d\u540c\u3002\u6bd4\u5982\uff0c\u5728<code>package</code>\u8d44\u6e90\u4e2d\uff0c\u540d\u5b57\uff08<code>name_attribute</code>)\u4ee3\u8868\u4f60\u8981\u5b89\u88c5\uff08\u6216\u7ba1\u7406\uff09\u7684\u7a0b\u5e8f\u5305\u7684\u540d\u5b57\uff1b</p> <p>\u5728<code>template</code>\u8d44\u6e90\u4e2d\uff0c\u540d\u5b57\u4ee3\u8868\u4f7f\u7528\u8be5\u6a21\u677f\u6700\u7ec8\u6e32\u67d3\u7684\u6587\u4ef6\u5728\u76ee\u6807\u673a\u5668\u4e0a\u7684\u8def\u5f84\u3002\u5728\u5b9a\u4e49\u8d44\u6e90\u7684\u540d\u5b57\u5c5e\u6027\u4e4b\u540e\uff0c\u6211\u4eec\u4f7f\u7528<code>Ruby</code>\u7684\u5173\u952e\u5b57<code>do</code>\u3002\u5728<code>Ruby</code>\u4e2d\uff0c\u4f7f\u7528<code>do</code>\u5173\u952e\u5b57\u6c38\u8fdc\u9700\u8981\u914d\u5408\u4e00\u4e2a<code>end</code>\u5173\u952e\u5b57\u6765\u7ed3\u5c3e\u3002\u5728<code>do</code>\u548c<code>end</code>\u4e2d\u95f4\u7684\u4ee3\u7801\u79f0\u4f5c\u4e00\u4e2a\u4ee3\u7801\u5757\u3002</p> <p>\u5728\u6b64\u4ee3\u7801\u5757\u4e2d\uff0c \u6211\u4eec\u53ef\u4ee5\u58f0\u660e\u8d44\u6e90\u7684\u53c2\u6570\u548c\u4ed6\u4eec\u7684\u503c\u3002\u8fd9\u4e9b\u53c2\u6570\u548c\u503c\u5728\u4e0d\u540c\u7684\u8d44\u6e90\u4e2d\u4e5f\u662f\u4e0d\u540c\u7684\uff0c</p> <ul> <li>\u6bd4\u5982 <code>package</code>\u8d44\u6e90\u6709<code>version</code>\u53c2\u6570\u53ef\u4ee5\u5b9a\u4e49\u8981\u5b89\u88c5\u7684\u7a0b\u5e8f\u5305\u7248\u672c\uff0c</li> <li><code>template</code>\u8d44\u6e90\u652f\u6301<code>source</code>\u53c2\u6570\u6765\u5b9a\u4e49\u6e90\u6a21\u677f\u7684\u4f4d\u7f6e\u4ee5\u4e0a<code>Chef</code>\u9886\u57df\u4e13\u7528\u8bed\u8a00\u4ee3\u7801\u4e5f\u53ef\u4ee5\u7528<code>Ruby</code>\u9762\u5411\u5bf9\u8c61\u7684\u65b9\u6cd5\u6765\u7406\u89e3\uff0c\u50cf\u4e0b\u9762\u7684\u4f8b\u5b50\u4e00\u6837\u4ee5\u4e0a\u7684<code>Chef</code>\u7684\u9886\u57df\u4e13\u7528\u8bed\u8a00\u5176\u5b9e\u4e3a\u4f60\u521b\u5efa\u4e86\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u8bbe\u5b9a\u6b63\u786e\u7684\u5c5e\u80dc\u548c\u53c2\u6570\uff0c\u7136\u540e\u5728<code>Chef</code>\u8fd0\u884c\u90a3\u6bb5\u4ee3\u7801\u65f6\u6267\u884c\u8be5\u8d44\u6e90\uff0c\u5b83\u7b49\u540c\u4e8e\uff1a </li> </ul> <pre><code>resource = Reosuce.new('NAME')\nresource.parameter1 = value1\nresource.parameter2 = value2\nresource.run\n</code></pre> <p>\u4ee5\u4e0b\u6848\u4f8b\u5c55\u793a\u5982\u4f55\u4f7f\u7528<code>template</code>, <code>package</code>\u548c<code>service</code>\u8d44\u6e90\uff0c\u8fd9\u4e9b\u8d44\u6e90\u53ea\u662f<code>Chef</code>\u6fd2\u57df\u4e13\u7528\u8bed\u8a00\u652f\u6301\u7684\u8bb8\u591a\u8d44\u6e90\u4e2d\u7684\u4e09\u4e2a\uff1a </p> <pre><code>template '/etc/resolv.conf' do \n    source 'my_resolv.conf.erb' \n    owner 'root' \n    group 'root' \n    mode '0644' \nend\n\npackage 'ntp' do \n    action :upgrade \nend \n\nservice 'apache2' do \n    restart_command ./etc/init.d/apachez restart' \nend \n</code></pre> <p>\u5982\u679c\u5728\u8d44\u6e90\u7684\u4ee3\u7801\u5757\u4e2d\u6307\u5b9a\u4e86\u65e0\u6548\u7684\u53c2\u6570\uff08\u4e0d\u5b58\u5728\u6216\u62fc\u5199\u9519\u8bef\uff09<code>Chef</code>\u4f1a\u629b\u51fa\u5f02\u5e38</p> <pre><code>NoMethodError \n...... undefined method 'not a real parameter' for ChefResourre \n</code></pre> <p><code>Chef</code>\u4f7f\u7528\u591a\u9636\u6bb5\u6267\u884c\u6a21\u5f0f\uff0c\u8fd9\u5141\u8bb8\u4f60\u5728<code>Chef</code>\u60f3\u9488\u5bf9\u4e00\u4e2a\u6570\u7ec4\u4e2d\u6240\u6709\u7684\u5bf9\u8c61\u6267\u884c\u4e00\u4e2a\u8d44\u6e90</p> <p><code>file</code>\u8d44\u6e90\u662f\u7528\u6765\u7ba1\u7406\u6587\u4ef6\u7684\uff0c<code>content</code>\u53c2\u6570\u7528\u6765\u6307\u5b9a\u5199\u5230\u6587\u4ef6\u7684\u5185\u5bb9</p> <pre><code>['bacon', 'eggs', 'sausage'].each do |type| \n    file \"/tmp/#{type}\" do \n        content \"#{type} is delicious!\" \n    end \nend \n</code></pre> <p>Chef \u52a8\u6001\u5206\u89e3\u5faa\u73af</p> <pre><code>file 'itmp/bacon' do \n    content 'bacon is delicious!' \nend \n\nfile 'Amp/eggs' do \n    content 'eggs is delicious!' \nend \n\nfile '/tmp/sausage' do \n    content 'sausage is delicious!' \nend \n</code></pre> <p>\u5f53<code>Chef</code>\u52a8\u6001\u8ba1\u7b97\u67d0\u4e2a\u503c\u65f6\uff0c \u6570\u503c\u90fd\u662f\u5728\u7b2c\u4e00\u9636\u6bb5\u88ab\u8ba1\u7b97\u548c\u5b58\u50a8</p> <pre><code>free_memory = node['memory']['total'] \n\nfile '/tmp/free' do \n    contents \"#{free_memory} bytes free on #{Time.now}\" \nend \n</code></pre> <p>\u6267\u884c\u7b2c\u4e8c\u9636\u6bb5\u65f6</p> <pre><code>file '/tmp/free' do \n    contents \"12904899202 bytes free on 2013-07-24 17:47:01 -0400\" \nend \n</code></pre> <p><code>file</code>, <code>service</code>,<code>template</code>,<code>package</code>\u90fd\u662f<code>Chef</code>\u7684\u6838\u5fc3\u5305\uff0c \u53ef\u4ee5\u5728\uff08https://docs.chef.io/resource_reference.html\uff09\u67e5\u770b</p>"},{"location":"chap1/chef_tutorial2/#3chef","title":"3\u3001\u5e38\u7528\u7684<code>Chef</code>\u8bed\u6cd5","text":""},{"location":"chap1/chef_tutorial2/#3-1-bash","title":"3-1 bash","text":"<ul> <li>\u4f7f\u7528<code>bash</code>\u6267\u884c\u591a\u884c<code>shell(bash)</code>\u811a\u672c</li> </ul> <pre><code>bash 'echo \"hello\"'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-2-chef_gem","title":"3-2 <code>Chef_gem</code>","text":"<p>\u5728<code>Chef</code>\u5185\u5b89\u88c5\u4e00\u4e2a<code>Ruby</code>\u7a0b\u5e8f(gem)\uff0c\u5728Chef\u5185\u90e8\u4f7f\u7528\u3002 \u5982\u679c\u4f60\u7684<code>Chef</code>\u4ee3\u7801\u9700\u8981\u989d\u5916\u4e00\u4e2a \u7684<code>gem</code>\u6765\u6267\u884c\u4e00\u4e2a\u51fd\u6570, \u53ef\u4ee5\u7528\u8fd9\u4e2a\u8d44\u6e90\u6765\u5728<code>Chef</code>\u5185\u90e8\u5b89\u88c5\u8fd9\u4e2a\u989d\u5916\u7684<code>gem</code></p> <pre><code># \u5b89\u88c5'HTTParty gem', \u8fd9\u6837\u5728Chef\u4ee3\u7801\u4e2d\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u53d1\u9001'RESTful'\u8bf7\u6c42\nchef_gem 'httprty' \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-3-cron","title":"3-3 Cron","text":"<p>\u6bcf\u5468\u91cd\u542f\u7535\u8111</p> <pre><code>cron 'weekly_restart' do \n    weekday '1' \n    minute '0' \n    hour '0' \n    command 'sudo reboot' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-4-deploy_revision","title":"3-4 <code>deploy_revision</code>","text":"<p>\u63a7\u5236\u548c\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u90e8\u7f72, \u5728\u4ee3\u7801\u7248\u672c\u63a7\u5236\u5de5\u5177\u4e2d\u7684\u4ee3\u7801\uff08\u5982<code>Rails</code>\u5e94\u7528\u7a0b\u5e8f) </p> <pre><code># \u4ece\u7248\u672c\u63a7\u5236\u5de5\u5177\u4e2d\u590d\u5236\u548c\u540c\u6b65\u4ee3\u7801\ndeploy_revision 'opt/my_app' do \n    repo 'git://github.com/username/apo.git' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-5-directory","title":"3-5 directory","text":"<p>\u7ba1\u7406\u76ee\u5f55\u6216\u76ee\u5f55\u6811\u5904\u7406\u6743\u9650\u548c\u6240\u6709\u8005 </p> <pre><code># \u7528\u9012\u5f52\u6765\u786e\u4fdd '/opt/my/deep/directory'\u5f55\u6811\u4e2d\u7684\u6bcf\u5c42\u76ee\u5f55\u90fd\u5b58\u5728 \n\ndirectory 'opt/my/deep/directory' do\n    owner 'root' \n    group 'root' \n    mode '0644' \n    recursive true \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-6-execute","title":"3-6 execute","text":"<p>\u6267\u884c\u4efb\u4f55\u5355\u884c\u7684\u547d\u4ee4</p> <pre><code># \u5c06\u5185\u5bb9\u5199\u5230\u6587\u4ef6\nexecute 'write status' do \n    command 'echo \"delicious\" &gt; /tmp/bacon' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-7-file","title":"3-7 file","text":"<p>\u7ba1\u7406\u5df2\u7ecf\u5b58\u5728\uff08\u4f46\u4e0d\u53d7<code>Chef</code>\u7ba1\u7406\uff09\u7684\u6587\u4ef6</p> <pre><code># \u5220\u9664/tmp/bacon\u6587\u4ef6\nfile \u2018/tmp/bacon' do \n    action :delete \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-8-gem_package","title":"3-8 gem_package","text":"<p>\u5728<code>Chef</code>\u5916\u5b89\u88c5\u4e00\u4e2a<code>Ruby</code>\u7a0b\u5e8f\uff08<code>gem</code>),\u6bd4\u5982\u5728\u76ee\u6807\u673a\u5668\u7684\u7cfb\u7edf\u4e2d\u5b89\u88c5\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6216\u5de5\u5177:</p> <pre><code># \u5b89\u88c5bundler\u6765\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u4f9d\u8d56\ngem_package 'bundler'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-9-group","title":"3-9 group","text":"<p>\u521b\u5efa\u6216\u7ba1\u7406\u4e00\u4e2a\u5305\u542b\u672c\u5730\u7528\u6237\u8d26\u6237\u7684\u672c\u5730\u7ec4</p> <pre><code># \u521b\u5efabacon\u7ec4\n    group 'bacon'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-10-link","title":"3-10 link","text":"<p>\u521b\u5efa\u548c\u7ba1\u7406\u7b26\u53f7\u548c\u786c\u94fe\u63a5</p> <pre><code># Link /tmp/bacon to /tmp/delicious \nlink '/tmp/bacon' do \n    to '/tmp/delicious' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-11-mount","title":"3-11 mount","text":"<p>\u6302\u8f7d\u548c\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf</p> <pre><code># \u6302\u8f7d/dev/sda8\nmount '/dev/sda8'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-12-package","title":"3-12 package","text":"<p>\u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305 </p> <pre><code>\uff03\u5b89\u88c5`apache2`\u7a0b\u5e8f\u5305\uff08\u5728`Debian`\u7cfb\u7edf\u91cc\uff09 \npackage 'apache2'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-13-remote_file","title":"3-13 remote_file","text":"<p>\u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6</p> <pre><code># \u4e0b\u8f7d\u8fdc\u7a0b\u6587\u4ef6\u5230'/tmp/bacon'\nremote_file 'tmp/bacon' do \n    source 'http://bacon.org/bits.tar.gz' \nend\n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-14-service","title":"3-14 service","text":"<p>\u505c\u6b62\u6216\u91cd\u542f\u4e00\u4e2a\u670d\u52a1 </p> <pre><code># \u91cd\u542fapache2\u670d\u52a1 \nservice 'apache2' do \n    action :restart \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-15-template","title":"3-15 template","text":"<p>\u7ba1\u7406\u4ee5\u7eaf\u6587\u672c\u4e3a\u5185\u5bb9\u7684\u5d4c\u4eba\u5f0f <code>Ruby (ERB\uff09</code>\u6a21\u677f </p> <pre><code># \u7528'bits.erb'\u6a21\u677f\u6e32\u67d3/tmp/bacon\u6587\u4ef6\ntemplate '/tmp/bacon' do \n    source 'bits.erb' \nend \n</code></pre>"},{"location":"chap1/chef_tutorial2/#3-16-user","title":"3-16 User","text":"<p>\u521b\u5efa\u7ba1\u7406\u672c\u5730\u7528\u6237\u8d26\u53f7</p> <pre><code># \u521b\u5efaBacon \u7528\u6237\n\nuser 'bacon'\n</code></pre>"},{"location":"chap1/chef_tutorial2/#4","title":"4\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li><code>Ruby</code>\u8bed\u6cd5\u548c\u6848\u4f8b </li> <li><code>Chef</code>\u8bed\u6cd5\u548c\u6848\u4f8b</li> <li>\u5e38\u7528\u7684<code>Chef</code>\u8bed\u6cd5</li> </ul>"},{"location":"chap1/chef_tutorial3/","title":"\u7b2c\u4e09\u8282 \u5982\u4f55\u5199 Chef \u914d\u65b9 &amp; chef-apply","text":"<ul> <li><code>chef-apply</code> </li> <li>\u9a8c\u8bc1\u7b2c\u4e00\u4e2a<code>Chef</code>\u914d\u65b9\u5355</li> <li>\u7528\u914d\u65b9\u6307\u5b9a\u7406\u60f3\u914d\u7f6e</li> </ul> <pre><code>$ tree learningchef/\nlearningchef/\n\u2514\u2500\u2500 chap04\n\n1 directory, 0 files\n</code></pre> <pre><code>file 'hello.txt' do \n    content 'Welcome to Chef' \nend \n</code></pre> <ul> <li>\u521b\u5efa<code>hello.txt</code>\u6587\u4ef6\u3002 </li> <li>\u628a<code>Welcome to Chef</code>\u6587\u672c\u5199\u5230<code>hello.txt</code>\u6587\u4ef6\u4e2d\u3002 </li> <li>\u4f7f\u7528<code>chef-apply</code>\u547d\u4ee4\u53ef\u4ee5\u8ba9<code>Chef</code>\u6267\u884c\u521a\u624d\u521b\u5efa\u7684<code>hello.rb</code>\u6587\u4ef6\u4e2d\u7684\u6307\u5b9a\u7684\u52a8\u4f5c\uff1a </li> </ul>"},{"location":"chap1/chef_tutorial3/#1chef-apply","title":"1\u3001<code>chef-apply</code>","text":"<p><code>chef-apply</code>\u5de5\u5177\u662f\u5728<code>Chef Solo</code>\u57fa\u7840\u4e0a\u5efa\u7acb\u7684\u4e00\u4e2a\u5c0f\u5de5\u5177\u3002<code>Chef Solo</code>\u53ef\u4ee5\u8ba9\u4f60\u5728\u6ca1\u6709<code>Chef</code>\u670d\u52a1\u5668\u7684\u6211\u4eec\u4f1a\u63d0\u60c5\u51b5\u4e0b\u5728\u672c\u5730\u8fd0\u884c<code>Chef</code>\u4ee3\u7801\u3002</p> <pre><code>$ chef-apply hello.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[hello.txt] action create\n    - create new file hello.txt\n    - update content in file hello.txt from none to 40a30c\n    --- hello.txt       2019-11-21 10:17:25.810706235 +0800\n    +++ ./.chef-hello20191121-23912-z55r6x.txt  2019-11-21 10:17:25.810459223 +0800\n    @@ -1 +1,2 @@\n    +Welcome to Chef\n</code></pre>"},{"location":"chap1/chef_tutorial3/#1-2-chef","title":"1-2 \u9a8c\u8bc1\u7b2c\u4e00\u4e2a<code>Chef</code>\u914d\u65b9\u5355","text":"<pre><code>$ more hello.txt \nWelcome to Chef\n</code></pre> <p><code>Welcome to Chef</code> \u5b57\u7b26\u4e32\u88ab\u4f20\u9012\u5230<code>file</code>\u8d44\u6e90\u7684<code>content</code>\u5c5e\u6027\u3002<code>file</code>\u8d44\u6e90\u5219\u5c06<code>Content</code>\u5c5e\u6027\u7684\u5b57\u7b26\u4e32\u5199\u5165<code>hello. txt</code>\u6587\u4ef6\u3002 </p>"},{"location":"chap1/chef_tutorial3/#2","title":"2\u3001\u7528\u914d\u65b9\u6307\u5b9a\u7406\u60f3\u914d\u7f6e","text":"<p>\u5728\u7ed9\u67d0\u4e2a\u6587\u4ef6\u6307\u5b9a\u6587\u4ef6\u540d\u65f6\uff0c\u5e94\u8be5\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84</p> <pre><code>file \"#{ENV['HOME']}/Devops_sap/Chef_Doc/learningchef/chap04/stone.txt\" do\n    content \"Written in stone\"\nend\n</code></pre> <ul> <li><code>\"#{ENV['HOME']}\"</code></li> </ul> <p><code>\"#{ENV['HOME']}\"</code> \u662f\u4e00\u4e2a\u6307\u5411\u73b0\u5728\u7528\u6237\u7684\u8ddf\u76ee\u5f55\u7684\u53d8\u91cf\u3002</p> <p>\u5b57\u7b26\u4e32\u5b9a\u4e49\u4e2d\u7684\u53d8\u91cf\u4f7f\u7528<code>\uff03{\uff1c\u53d8 \u91cf\uff1e\uff5d</code> \u6765\u8868\u793a\uff08#\u53f7\u8ddf\u7740\u5927\u62ec\u53f7\uff0c\u5927\u62ec\u53f7\u4e2d\u5305\u542b\u53d8\u91cf\u540d\uff09\u3002</p> <p>\u5305\u542b\u53d8\u91cf\u7684\u5b57\u7b26\u4e32\u5fc5\u987b\u4f7f\u7528\u53cc\u5f15\u53f7\u6765\u5b9a\u4e49\uff0c\u5426\u5219\uff0cChef\u4e0d\u4f1a\u6267\u884c\u548c\u66ff\u6362\u5b57\u7b26\u4e32\u4e2d\u7684\u53d8\u91cf\uff0c\u800c\u4f1a\u8ba4\u4e3a\u90a3\u662f\u5b57\u7b26\u4e32\u672c\u8eab </p> <pre><code>$ chef-apply stone.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[/Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt from none to ba4fda\n    --- /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt        2019-11-21 13:33:32.834565261 +0800\n    +++ /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/.chef-stone20191121-25291-1jglr40.txt    2019-11-21 13:33:32.834330945 +0800\n    @@ -1 +1,2 @@\n    +Written in stone\n</code></pre> <pre><code>$ more $HOME/Devops_sap/Chef_Doc/learningchef/chap04/stone.txt\nWritten in stone\n</code></pre> <pre><code>$ chef-apply stone.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[/Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt] action create (up to date)\n</code></pre> <ul> <li>\u5982\u679c<code>stone.txt</code>\u4e0d\u5b58\u5728\uff0c<code>chef-apply</code>\u521b\u5efa\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u76f8\u5e94\u7684\u5185\u5bb9 </li> <li>\u5982\u679c<code>stone.txt</code>\u5df2\u7ecf\u5b58\u5728\u5e76\u4e14\u5185\u5bb9\u6b63\u786e\uff0c<code>chef-apply</code>\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5 </li> </ul> <p>\u4fee\u6539<code>stone.txt</code></p> <pre><code>Written in stone, modify this file\n</code></pre> <pre><code>$ chef-apply stone.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[/Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt] action create\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt from 7139d7 to ba4fda\n    --- /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt        2019-11-21 13:40:25.388303782 +0800\n    +++ /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/.chef-stone20191121-25655-18xmqfk.txt    2019-11-21 13:40:44.011358154 +0800\n    @@ -1,2 +1,2 @@\n    -Written in stone, modify this file\n    +Written in stone\n</code></pre> <p>\u8fd9\u5c55\u793a\u4e86<code>Chef</code>\u5982\u4f55\u907f\u514d\u610f\u5916\u7684\u914d\u7f6e\u53d8\u52a8\u3002<code>Chef</code>\u4e0d\u4ec5\u68c0\u67e5\u6587\u4ef6\u662f\u5426\u5b58\u5728\uff0c\u5e76\u4e14\u8fd8\u68c0\u67e5\u5176\u5185\u5bb9\u3002\u5f53<code>Chef</code>\u7ba1\u7406\u7684\u6587\u4ef6\u5728<code>Chef</code>\u5916\u90e8\u88ab\u610f\u5916\u66f4\u6539\u65f6\uff0c<code>Chef</code>\u4f1a\u786e\u4fdd\u5f53\u5176\u8fd0\u884c\u65f6\u5c06\u5176\u6062\u590d\u81f3\u914d\u65b9\u5355\u4e2d\u6307\u5b9a\u7684\u7248\u672c\uff08\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8bb8\u591a\u4eba\u914d\u7f6e<code>Chef</code>\u4f5c\u4e3a\u540e\u53f0\u7a0b\u5e8f\u5faa\u73af\u8fd0\u884c\uff0c\u4f7f\u7cfb\u7edf\u4e00\u76f4\u4fdd\u6301\u914d\u65b9\u5355\u4e2d\u6307\u5b9a\u7684\u914d\u7f6e\uff09\u3002 </p>"},{"location":"chap1/chef_tutorial3/#3","title":"3\u3001\u7528\u914d\u65b9\u6307\u5b9a\u7406\u60f3\u914d\u7f6e","text":"<p>\u5378\u8f7d\u65f6\uff0c\u987b\u660e\u786e\u6307\u5b9a\u4e0d\u8981\u505a\u4ec0\u4e48\u4f60\u53ef\u80fd\u4f1a\u7591\u60d1\uff0c\u5728\u914d\u65b9\u5355\u4e2d\u5220\u9664\u5185\u5bb9\u65f6\uff0c\u662f\u5426\u53ef\u80fd\u8ba9<code>Chef</code>\u81ea\u52a8\u5378\u8f7d\u6240\u6709\u5176\u5b89\u88c5\u7684\u4e1c\u897f\u3002 \u5176\u5b9e\u5e76\u4e0d\u7136\u3002\u4f46\u662f\u4f60\u53ef\u4ee5\u901a\u8fc7\u660e\u786e\u544a\u8bc9<code>Chef</code>\u4e0d\u8981\u505a\u4ec0\u4e48\u6765\u505a\u7b49\u540c\u4e8e\u5378\u8f7d\u7684\u4e8b\u60c5\u3002 </p> <p>\u8fd9\u542c\u8d77\u6765\u597d\u50cf\u662f<code>Chef</code>\u5728\u5378\u8f7d\u65b9\u9762\u7684\u4e0d\u8db3\uff0c\u5176\u5b9e\u5e76\u4e0d\u7136\u3002\u8bb0\u4f4f\uff0c<code>Chef</code>\u5c1d\u8bd5\u4f5c\u4e3a\u4e00\u4e2a\u806a\u660e\u7684\u5de5\u5177\u3002\u4f60\u4e0d\u9700\u8981\u544a\u8bc9Chef\u5982\u4f55\u505a\u4ec0\u4e48\uff0c\u53ea\u9700\u8981\u5728\u914d\u65b9\u5355\u4e2d\u544a\u8bc9<code>Chef</code>\u4f60\u7684\u7406\u60f3\u914d\u7f6e\uff0c\u7136\u540e\u8ba9<code>Chef</code>\u51b3\u5b9a\u505a\u4ec0\u4e48\u3002</p> <p>\u4f60\u7684\u914d\u65b9\u5355\u901a\u8fc7\u5b9a\u4e49\u7406\u60f3\u914d\u7f6e\u662f\u4ec0\u4e48\u6837\u7684\u6765\u544a\u8bc9<code>Chef</code>\u4ec0\u4e48\u65f6\u5019\u8be5\u505c\u6b62\u601d\u8003\u673a\u5668\u7684\u914d\u7f6e\u3002 </p> <p><code>Chef</code>\u53ea\u80fd\u786e\u4fdd\u5c06\u5176\u7ba1\u7406\u7684\u673a\u5668\u8fbe\u5230\u4f60\u73b0\u5728\u7248\u672c\u7684\u914d\u65b9\u5355\u4e2d\u660e\u786e\u6307\u5b9a\u7684\u7406\u60f3\u914d\u7f6e\uff0c\u5982\u679c\u628a\u67d0\u4e9b\u4e1c\u897f\u4ece\u914d\u65b9\u5355\u4e2d\u53bb\u9664\uff0c<code>Chef</code>\u6ca1\u6709\u529e\u6cd5\u660e\u786e\u77e5\u9053\u4f60\u60f3\u4ece\u7ba1\u7406\u7684\u673a\u5668\u4e2d\u5220\u9664\u8fd9\u4e9b\u8fd8\u662f\u4e0d\u505a\u5173\u4e8e\u8fd9\u4e9b\u7684\u4efb\u4f55\u4e8b\u60c5\uff08\u56e0\u4e3a\u65b0\u7684\u914d\u65b9\u5355\u5df1\u7ecf\u4e0d\u5b58\u5728\u8fd9\u4e9b\u914d\u7f6e\uff09\u3002</p> <p>\u5982\u679c\u9009\u62e9\u81ea\u52a8\u5378\u8f7d\u8fd9\u4e9b\u5185\u5bb9\uff0c\u8fd9\u4e9b\u975e\u660e\u786e\u6027\u6697\u793a\u7684\u5378\u8f7d\u52a8\u4f5c\u548c\u5c06\u7cfb\u7edf\u4f9d\u7167\u660e\u786e\u7684\u7406\u60f3\u914d\u7f6e\u6765\u914d\u7f6e\u914d\u65b9\u5355\u6765\u914d\u7f6e\u6210\u597d\u7684\u7cfb\u7edf\u5728\u7406\u8bba\u4e0a\u662f\u76f8\u6096\u7684\u3002</p> <p>\u6bcf\u4e2a\u7cfb\u7edf\u7ba1\u7406\u5458\u591a\u591a\u5c11\u5c11\u90fd\u7ecf\u5386\u8fc7\u5728\u7531\u4e8e\u4e00\u4e9b\u673a\u5668\u4e0a \u4e0d\u77e5\u9053\u4e3a\u4f55\u53d1\u751f\u7684\u6539\u53d8\u9020\u6210\u7684\u95ee\u9898\u7684\u6392\u9519\u65f6\u65e0\u6cd5\u627e\u5230\u539f\u56e0\u800c\u653e\u5f03\uff0c\u5c06\u673a\u5668\u6240\u6709\u5185\u5bb9\u64e6\u6389\u5e76\u4ece\u5934\u5f00\u59cb\u3002 </p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u60f3\u8ba9<code>Chef</code>\u5378\u8f7d\u4ec0\u4e48\uff0c \u5fc5\u987b\u5728\u914d\u65b9\u5355\u4e2d\u660e\u786e\u6307\u5b9a\u4e0d\u8981\u5b89\u88c5\u8fd9\u4e9b\u4e1c\u897f\u3002\u6240\u6709\u7684\u8d44\u6e90\u90fd\u652f\u6301\u8fd9\u6837\u7684\u5b9a\u4e49\u3002 \u5982\u679c\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c \u4f60\u53ef\u4ee5\u544a\u8bc9<code>Chef</code>\u7cfb\u7edf\u4e0d\u9700\u8981\u8fd9\u4e2a\u6587\u4ef6\uff0c \u7136\u540e<code>Chef</code>\u53ef\u4ee5\u786e\u4fdd\u7cfb\u7edf\u4e2d\u6ca1\u6709\u8fd9\u4e2a\u6587\u4ef6\u3002 </p> <ul> <li>\u5982\u679c\u6587\u4ef6\u5b58\u5728<code>chef-apply</code>\u5219\u4f1a\u5c06\u5176\u5220\u9664\u3002 </li> <li>\u5982\u679c\u6587\u4ef6\u4e0d\u5b58\u5728<code>chef-appply</code>\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\u3002 </li> </ul> <p>cleanup.rb</p> <pre><code>file \"#{ENV['HOME']}/Devops_sap/Chef_Doc/learningchef/chap04/stone.txt\" do\n    action :delete\nend\n</code></pre> <pre><code>$ chef-apply cleanup.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[/Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt] action delete\n    - delete file /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/stone.txt\n</code></pre>"},{"location":"chap1/chef_tutorial3/#4","title":"4\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u914d\u65b9\u5355(<code>recipe</code>) </li> </ul> <p>\u4e00\u7cfb\u5217\u7528Ruby\u9886\u57df\u4e13\u7528\u8bed\u8a00\uff08DSL\uff09\u6765\u5199\u7684\u63cf\u8ff0\u7406\u60f3\u914d\u7f6e\u7684\u6307\u4ee4\u3002 </p> <ul> <li>\u8d44\u6e90(<code>resource</code>) </li> </ul> <p>\u5bf9\u4e8e<code>Chef</code>\u6240\u7ba1\u7406\u7684\u4e1c\u897f\uff08\u6bd4\u5982\u6587\u4ef6\uff09\u7684\u4e00\u4e2a\u8de8\u5e73\u53f0\u7684\u62bd\u8c61\u8868\u8fbe\u3002\u8d44\u6e90\u662f<code>Chef</code>\u4ee3\u7801\u7684\u7ec4\u6210\u90e8\u5206\u3002\u901a\u8fc7\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528\u4e0d\u540c\u7684\u8d44\u6e90\u6765\u544a\u8bc9<code>Chef</code>\u4f60\u7684\u7406\u60f3\u914d\u7f6e\u3002 </p> <ul> <li>\u5c5e\u6027\uff08<code>attribute</code>) </li> </ul> <p>\u4f20\u9012\u7ed9\u8d44\u6e90\u7684\u53c2\u6570\u3002 </p> <pre><code>file 'hello.txt' do \n    content 'Welcome to Chef' \nend \n</code></pre> <pre><code>$ chef-apply hello.rb \nRecipe: (chef-apply cookbook)::(chef-apply recipe)\n  * file[hello.txt] action create\n    - create new file hello.txt\n    - update content in file hello.txt from none to 40a30c\n    --- hello.txt       2019-11-21 10:17:25.810706235 +0800\n    +++ ./.chef-hello20191121-23912-z55r6x.txt  2019-11-21 10:17:25.810459223 +0800\n    @@ -1 +1,2 @@\n</code></pre>"},{"location":"chap1/chef_tutorial4/","title":"\u7b2c\u56db\u8282 \u7528<code>Test Kitchen</code>\u7ba1\u7406\u6c99\u76d2\u6d4b\u8bd5\u73af\u5883","text":"<ul> <li>\u5bbf\u4e3b\u548c\u865a\u62df\u673a</li> <li>\u542f\u52a8\u81ea\u5df1\u7684\u865a\u62df\u673a</li> <li>YAML Overview</li> <li>\u7528<code>kitchen.yml</code>\u914d\u7f6e<code>Test Kitchen</code></li> </ul>"},{"location":"chap1/chef_tutorial4/#vagrant-api","title":"vagrant \u4e3a\u865a\u62df\u8f6f\u4ef6\u63d0\u4f9b<code>API</code>","text":""},{"location":"chap1/chef_tutorial4/#1","title":"1\u3001\u5bbf\u4e3b\u548c\u865a\u62df\u673a","text":"<pre><code>$ mkidr kitchen\n$ cd kitchen\n</code></pre> <ul> <li>\u5728\u4f60\u521b\u5efa\u7684<code>kitchen</code>\u6587\u4ef6\u5939\u4e2d\u8fd0\u884c<code>kitchen init --create-gemfile</code>\u547d\u4ee4\u3002</li> <li><code>kitchen init</code>\u547d\u4ee4\u4f1a\u521b\u5efa\u8ba9\u4e00\u4e2a\u9879\u76ee\u652f\u6301<code>Test Kitchen</code>\u6240\u9700\u7684\u914d\u7f6e\u6587\u4ef6\u3002</li> </ul> <p>\u6211\u4eec\u9700\u8981\u4f7f\u7528<code>-create-gemfile</code>\u9009\u9879\uff0c\u5426\u5219<code>Test Kitchen</code>\u4f1a\u76f4\u63a5\u5c1d\u8bd5\u4f5c\u4e3a\u666e\u901a\u7528\u6237\u800c\u975e\u7ba1\u7406\u5458\u8fd0\u884c<code>gem install</code>\u3002\u5728\u67d0\u4e9b\u5e73\u53f0\u4e0a\u8fd9\u4f1a\u5931\u8d25\uff0c\u56e0\u4e3a<code>Chef</code>\u5f00\u53d1\u5305\u5e76\u4e0d\u603b\u662f\u5bf9\u5176<code>gem</code>\u76ee\u5f55\u8d4b\u4e88\u4e00\u822c\u7528\u6237\u5199\u5165\u7684\u6743\u9650\uff1a </p> <pre><code>$ kitchen init --create-gemfile\n      create  kitchen.yml\n      create  chefignore\n      create  test/integration/default\n      create  Gemfile\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n</code></pre> <p>\u4ee5\u4e0a\u547d\u4ee4\u884c\u8f93\u51fa\u4e2d\u663e\u793a\u7684<code>bundle install</code>\u547d\u4ee4\u6307\u7684\u662f\u4f7f\u7528\u540d\u79f0\u4e3a<code>Bundle</code>\u7684\u5de5\u5177\u3002</p> <p><code>Bundler</code>\u662f\u4e00\u4e2a\u7528\u6765\u4e0b\u8f7d\u548c\u7ba1\u7406<code>Ruby</code>\u7a0b\u5e8f\u7684\u5de5\u5177\u3002</p> <p><code>Test Kitchen</code>\u9700\u8981\u4f60\u8fd0\u884c<code>bundle install</code>\u6765\u4e0b\u8f7d\u548c\u5b89\u88c5<code>kitchen-vagrant</code>\u9a71\u52a8\u4ee5\u53ca\u4e00\u4e9b\u652f\u6301\u5b83\u7684<code>Ruby</code>\u7a0b\u5e8f\uff08<code>gem</code>)\u3002 </p> <pre><code>$ bundle install\nFetching gem metadata from https://rubygems.org/.........\nFetching gem metadata from https://rubygems.org/.\nResolving dependencies...\nUsing bcrypt_pbkdf 1.0.1\nUsing builder 3.2.3\nUsing bundler 2.0.2\nUsing ed25519 1.2.4\nUsing equatable 0.6.1\nUsing erubi 1.9.0\nFetching ffi 1.11.2\nInstalling ffi 1.11.2 with native extensions\nUsing gssapi 1.3.0\nUsing gyoku 1.3.1\nUsing httpclient 2.8.3\nUsing tty-color 0.5.0\nUsing pastel 0.7.3\nUsing tomlrb 1.2.8\nUsing strings-ansi 0.2.0\nUsing unicode-display_width 1.6.0\nUsing unicode_utils 1.4.0\nUsing strings 0.1.7\nUsing tty-cursor 0.7.0\nUsing tty-box 0.5.0\nUsing necromancer 0.5.0\nUsing tty-screen 0.7.0\nUsing wisper 2.0.1\nUsing tty-reader 0.6.0\nUsing tty-prompt 0.19.0\nUsing license-acceptance 1.0.13\nUsing little-plugger 1.1.4\nUsing multi_json 1.14.1\nUsing logging 2.2.2\nUsing mixlib-shellout 3.0.7\nUsing mixlib-versioning 1.2.7\nUsing thor 0.20.3\nUsing mixlib-install 3.11.21\nUsing net-ssh 5.2.0\nUsing net-scp 2.0.0\nUsing net-ssh-gateway 2.0.0\nUsing nori 2.6.0\nUsing rubyntlm 0.6.2\nUsing rubyzip 2.0.0\nUsing winrm 2.3.3\nUsing winrm-fs 1.3.4\nUsing winrm-elevated 1.1.2\nUsing test-kitchen 2.3.4\nBundle complete! 1 Gemfile dependency, 42 gems now installed.\nUse `bundle info [gemname]` to see where a bundled gem is installed.\n</code></pre> <p>Error solutions for gem install <code>ffi</code></p> <pre><code>brew install coreutils\n</code></pre> <pre><code>$ tree .\n.\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 chefignore\n\u251c\u2500\u2500 kitchen.yml\n\u2514\u2500\u2500 test\n    \u2514\u2500\u2500 integration\n        \u2514\u2500\u2500 default\n\n3 directories, 4 files\n</code></pre> <ul> <li><code>kitchen.yml</code> </li> </ul> <p>\u7528\u6765\u914d\u7f6e<code>Test Kitchen</code>\u7684\u865a\u62df\u73af\u5883 </p> <ul> <li><code>Gemfile</code> </li> </ul> <p><code>Bundler</code>\u4f7f\u7528\u6b64\u6587\u4ef6\u6765\u914d\u7f6e<code>Ruby</code>\u7a0b\u5e8f\uff08<code>gem</code>\uff09\u5b58\u50a8\u5e93\u4ee5\u53ca\u9700\u8981\u4e0b\u8f7d\u3001\u5b89\u88c5\u7684<code>gem</code>\u5217\u8868\u3002<code>Bundler</code>\u81ea\u52a8\u51b3\u5b9a\u6bcf\u4e2a<code>gem</code>\u7684\u4f9d\u8d56\u7684\u5176\u4ed6<code>gem</code>,\u6240\u4ee5\u4f60\u53ea\u9700\u8981\u6307\u5b9a\u9700\u8981\u5b89\u88c5\u7684\u9876\u7ea7<code>gem</code>\u5217\u8868 </p> <ul> <li><code>Gemfile.lock</code> </li> </ul> <p>\u8bb0\u5f55<code>Bundler</code>\u4e0b\u8f7d\u7684\u5f53\u524d\u9879\u76ee\u7684\u6240\u6709<code>gem</code>\u7684\u7248\u672c\uff0c\u548c\u6240\u6709\u8fd9\u4e9b<code>gem</code>\u4f9d\u8d56\u7684<code>gem</code>\u7684\u7248\u672c\u3002 \u5176\u4ed6<code>Chef</code>\u5f00\u53d1\u8005\u53ef\u4ee5\u7528\u8fd9\u4e2a\u6587\u4ef6\u901a\u8fc7<code>bundle install</code>\u91cd\u73b0\u4f60\u7684<code>gem</code>\u73af\u5883\u3002</p> <ul> <li><code>.kitchen/</code> </li> </ul> <p><code>Test Kitchen</code>\u7528\u6765\u50a8\u5b58\u5176\u5de5\u4f5c\u6587\u4ef6\u7684\u9690\u85cf\u6587\u4ef6\u5939\u3002 </p> <ul> <li><code>.kitchen/logs/kitchen.log</code> </li> </ul> <p>\u5305\u542b\u4e0a\u6b21\u8fd0\u884c<code>Test Kitchen</code>\u7684\u8f93\u51fa\u7684\u65e5\u5fd7\u7684\u6587\u672c\u6587\u4ef6 </p> <ul> <li><code>test/</code> </li> </ul> <p>\u5305\u542b\u6d4b\u8bd5( \u6700\u521d\u53ea\u5305\u542b\u4e00\u4e2a\u6846\u67b6\u548c\u5b50\u76ee\u5f55<code>test/integeration/default/</code>. \u4f60\u53ef\u4ee5\u81ea\u5df1\u6dfb\u52a0 \u5177\u4f53\u7684\u4fa7\u8bd5\u4ee3\u7801\uff09\u7684\u76ee\u5f55\u7ed3\u6784 </p>"},{"location":"chap1/chef_tutorial4/#2","title":"2\u3001\u542f\u52a8\u81ea\u5df1\u7684\u865a\u62df\u673a","text":""},{"location":"chap1/chef_tutorial4/#2-1-kitchenyml","title":"2-1 \u4fee\u6539<code>kitchen.yml</code>","text":"<pre><code>---\ndriver:\n  name: vagrant\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n</code></pre> <p>\u5bf9\u914d\u7f6e\u6587\u4ef6\u8fbe\u6837\u7684\u6539\u53d8\u7684\u610f\u56fe\u662f\u8ba9<code>Test Kitchen</code>\u4ece<code>VagrantCloud</code>\u4e0b\u8f7d<code>CentOS 6.5</code>\u6620 \u50cf\u3002</p> <ul> <li> <p><code>box</code>:\u90e8\u5206\u5fc5\u987b\u7b26\u5408\u5728<code>https://app.vagrantup.com/learningchef/boxes/centos65</code>\u5217\u51fa\u7684 <code>VagrantCloud</code>\u4e2d\u673a\u5668\u7684\u540d\u79f0\u3002</p> </li> <li> <p>\u673a\u5668\u7684\u540d\u79f0\u662f<code>learningchef/ oentos65</code>\u3002</p> </li> <li>\u5728<code>platforms</code>\u4e0b\u7684<code>name</code>\uff1a\u90e8\u5206\u6211\u4eec\u7b80\u79f0\u5b83\u4e3a<code>centos65</code>\u56e0\u4e3a\u6211\u4eec\u4f1a\u5728<code>Test Kitchen</code>\u7684\u547d\u4ee4\u4e2d\u8f93\u4eba\u8fd9\u4e2a\u540d\u79f0 \u6240\u4ee5\u6211\u4eec\u7ed9\u5b83\u8fd9\u4e2a\u77ed\u4e00\u4e9b\u7684\u540d\u5b57\u3002</li> </ul> <p>\u5728<code>Test Kitchen</code>\u7684\u4e16\u754c\u91cc\u4e00\u4e2a\u5b9e\u4f8b\u662f\u6307\u4e00\u4e2a\u53ef\u4ee5\u521b\u5efa\u5305\u542b\u64cd\u4f5c\u7cfb\u7edf\u7684\u865a\u62df\u673a\u4ee5\u53ca\u53ef\u4ee5\u90e8\u7f72\u81ea\u52a8\u5316\u4ee3\u7801\u7684\u73af\u5883\u3002\u8fd0\u884c<code>kitchen list</code>\u547d\u4ee4\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u53ef\u7528\u7684\u5b9e\u4f8b\u5217\u8868 </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre>"},{"location":"chap1/chef_tutorial4/#2-2-vmware_desktopvmfusion","title":"2-2 \u56e0\u4e3a\u6211\u4eec\u7528\u7684\u662f<code>vmware_desktop</code>\u548c<code>vmfusion</code>\u4f5c\u4e3a\u865a\u62df\u673a","text":"<p>\u4fee\u6539<code>kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n</code></pre> <pre><code>$ kitchen create default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Box 'learningchef/centos65' could not be found. Attempting to find and install...\n           default: Box Provider: vmware_desktop, vmware_fusion, vmware_workstation\n           default: Box Version: &gt;= 0\n       ==&gt; default: Loading metadata for box 'learningchef/centos65'\n           default: URL: https://vagrantcloud.com/learningchef/centos65\n       ==&gt; default: Adding box 'learningchef/centos65' (v1.0.7) for provider: vmware_desktop\n           default: Downloading: https://vagrantcloud.com/learningchef/boxes/centos65/versions/1.0.7/providers/vmware_des\nktop.box\n    default: Download redirected to host: cdn.learningchef.com\n==&gt; default: Successfully added box 'learningchef/centos65' (v1.0.7) for 'vmware_desktop'!\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2222\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2222\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (5m39.65s).\n-----&gt; Kitchen is finished. (5m40.09s)\n</code></pre> <p></p>"},{"location":"chap1/chef_tutorial4/#2-3-list","title":"2-3 List","text":"<pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action  Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        Created      &lt;None&gt;\n</code></pre> <pre><code>$ vagrant global-status\nid       name    provider       state       directory  \nac9f37f  default vmware_desktop running     /Users/.../Devops_sap/Chef_Doc/learningchef/chap04/kitchen/.kitchen/kitchen-vagrant/default-centos65 \n</code></pre>"},{"location":"chap1/chef_tutorial4/#2-4-login","title":"2-4 Login","text":"<pre><code>$ kitchen login default-centos65\nLast login: Fri Nov 22 06:02:56 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ \n\n\n\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre>"},{"location":"chap1/chef_tutorial4/#destroy","title":"Destroy","text":"<pre><code>$ kitchen destroy default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m18.49s).\n-----&gt; Kitchen is finished. (0m18.93s)\n</code></pre>"},{"location":"chap1/chef_tutorial4/#3yaml-overview","title":"3\u3001YAML Overview","text":"<p>The <code>.kitchen.yml</code> configuration file used to configure Test Kitchen is in the YAML file format. </p> <p>YAML is a recursive acronym that stands for <code>YAML Ain\u2019t Markup Language</code>. A sequence of three hyphens (<code>---)</code> denote the beginning of a YAML document, so you\u2019ll see this at the beginning of every <code>.kitchen.yml</code>file. </p> <p>Comments are indicated by the hash symbol (<code>#</code>), just like in Ruby. Space and indentation matter in a <code>YAML</code> file. Tab characters should never be used in a YAML file, only spaces.</p> <p>YAML files work with two fundamental kinds of a data:</p> <ul> <li>Key-value pair</li> <li>List</li> </ul> <pre><code>name: vagrant\n</code></pre> <p>The space after the colon is required. The value for <code>name</code> is <code>vagrant</code>. The value <code>vagrant</code> can be looked up by the <code>name</code> key.</p> <p>Key-value pairs can be nested, so that the value for a key is another key-value pair. </p> <p>When a key-value pair is nested, the value portion for the parent is written on separate lines, indented by at least one space. For example:</p> <pre><code>driver:\n  name: vagrant\n  aws_access_key_id: 12345\n</code></pre> <p>Having more spaces is perfectly fine, as long as the values belonging to the same nested key-value pair are all aligned vertically, with the same number of spaces:</p> <pre><code>driver:\n             name: vagrant\n             aws_access_key_id: 12345\n</code></pre> <p>You can also include as many spaces as you like before the colon, like so:</p> <pre><code>driver:\n  name              : vagrant\n  aws_access_key_id : 12345\n</code></pre> <p>If there were no spaces before each line, the nested values would not be interpreted correctly, however:</p> <pre><code>driver:\nname: vagrant\naws_access_key_id: 12345\n</code></pre> <p>There is an alternate format for nested key-value pairs. They can also be in the form of <code>{&lt;key&gt;: &lt;value&gt;, &lt;key&gt;: &lt;value&gt;, \u2026}</code>, also known as JavaScript Object Notation format, or JSON. For example:</p> <pre><code>mysql: {server_root_password: \"rootpass\", server_debian_password: \"debpass\"}\n</code></pre> <p>It is interpreted the same as:</p> <pre><code>mysql:\n  server_root_password: \"rootpass\"\n  server_debian_password: \"debpass\"\n</code></pre> <p>\u5217\u8868\u662f\u53ef\u4ee5\u7528<code>YAML</code>\u6587\u4ef6\u50a8\u5b58\u7684\u53e6\u4e00\u79cd\u6570\u636e\u7c7b\u578b\u3002</p> <p>\u5217\u8868\u5305\u542b\u6709\u5e8f\u6570\u636e\u3002\u6bcf\u4e00\u4e2a\u503c\u4e0d\u4f1a\u50cf\u952e\u503c\u5bf9\u513f\u4e00\u6837\u4e0e\u4e00\u4e2a\u952e\u5173\u8054\u3002\u5217\u8868\u7684\u6bcf\u4e00\u4e2a\u9879\u76ee\u90fd\u5e94\u4f7f\u7528\u65b0\u7684\u4e00\u884c\uff0c\u548c\u5d4c\u5957\u7684\u952e\u503c\u5bf9\u513f\u7c7b\u4f3c\u6bcf\u4e00\u4e2a\u9879\u76ee\u7531\u4e00\u4e2a\u6a2a\u6760\u5f00\u59cb\uff0c\u7136\u540e\u63a5\u7740\u4e00\u4e2a\u7a7a\u683c\u3002\u4ee5\u4e0b\u7684\u4f8b\u5b50\u5c55\u793a\u7528\u4e00\u4e2a\u5217\u8868 \u5728<code>kitchen.yml</code>\u4e2d\u6307\u5b9a\u591a\u4e2a\u652f\u6301\u7684\u5e73\u53f0\uff0c\u5217\u8868\u4e2d\u6bcf\u4e2a\u9879\u76ee\u662f\u4e00\u4e2a\u4ee5<code>name</code>\u4e3a\u952e\u7684\u952e\u503c\u5bf9\u513f</p> <pre><code>platforms:\n- name: ubuntu-10.04\n- name: ubuntu-12.04\n- name: ubuntu-12.10\n- name: ubuntu-13.04\n- name: centos-5.9\n- name: centos-6.4\n- name: debian-7.1.0\n</code></pre> <p>\u4e0a\u9762\u7684\u4f8b\u5b50\u540c\u65f6\u5c55\u793a\u4e86\u5982\u4f55\u5c06\u952e\u503c\u5bf9\u513f\u653e\u5728\u4e00\u4e2a\u5217\u8868\u4e2d\u3002\uff08\u4f60\u4e5f\u53ef\u4ee5\u628a\u4e00\u4e2a\u5217\u8868\u653e\u5728\u952e \u503c\u5bf9\u513f\u7684\u503c\u4e2d\u3002\uff09\u548c\u5728\u952e\u503c\u5bf9\u513f\u4e2d\u4e00\u6837\uff0c\u5217\u8868\u4e2d\u7684\u6bcf\u4e2a\u9879\u76ee\u4e4b\u524d\u53ef\u4ee5\u6709\u4efb\u610f\u591a\u7684\u7a7a\u683c\uff0c \u4f46\u6bcf\u4e2a\u9879\u76ee\u524d\u9762\u5fc5\u987b\u6709\u4e00\u6837\u591a\u7684\u7a7a\u683c\u6570\u3002\u4ee5\u4e0b\u4f8b\u5b50\u7b49\u540c\u4e8e\u4e0a\u9762\u7684\u4f8b\u5b50 </p> <pre><code>platforms:\n    - name: ubuntu-10.04\n    - name: ubuntu-12.04\n    - name: ubuntu-12.10\n    - name: ubuntu-13.04\n    - name: centos-5.9\n    - name: centos-6.4\n    - name: debian-7.1.0\n</code></pre> <p>YAML\u6587\u4ef6\u4e2d\u7684\u503c\u540c\u65f6\u53ef\u4ee5\u62e5\u6709\u7c7b\u578b\u3002<code>kitchen.yml</code>\u6587\u4ef6\u5927\u591a\u6570\u53ea\u9700\u8981\u7528\u5230\u6574\u6570\u3001\u5b57\u7b26\u4e32\u6216\u6570\u7ec4\u3002\u4ee5\u6570\u5b57\u5f00\u59cb\u7684\u503c\u4f1a\u5761\u89e3\u91ca\u4e3a\u6574\u6570\u3002\u4ee5\u5b57\u4ee5\u5f00\u59cb\u4e86\u4ee5\u5355\u5f15\u53f7<code>('')</code>\u4ee5\u53ca\u53cc\u5f15\u53f7<code>(\"\")</code>\u5305\u62ec\u7684\u503c\u88ab\u89e3\u91ca\u4e3a\u5b87\u7b26\u4e32(<code>[]</code>)\u3002</p> <pre><code>network:\n- [\"forwarded_port\", {guest: 80, host: 8080}]\n- [\"private_network\", {ip: \"192.168.33.33\"}]\n</code></pre>"},{"location":"chap1/chef_tutorial4/#4kitchenymltest-kitchen","title":"4\u3001\u7528<code>kitchen.yml</code>\u914d\u7f6e<code>Test Kitchen</code>","text":"<p>\u7406\u89e3<code>YAML</code>\u57fa\u7840\u4e4b\u540e\u8ba9\u6211\u4eec\u56de\u5230<code>Test Kitchen</code>\u521b\u5efa\u7684<code>Kitchen.yml</code>\u6587\u4ef6 </p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n</code></pre>"},{"location":"chap1/chef_tutorial4/#kitchenymi","title":"<code>kitchen.ymi</code>\u6587\u4ef6\u5305\u542b\u56db\u4e2a\u4e3b\u8981\u7684\u90e8\u5206\u3002","text":"<ul> <li> <p><code>driver</code>: \u6307\u5b9a\u8981\u4f7f\u7528\u7684\u9a71\u52a8\u52a8\u4ee5\u53ca\u7ba1\u7406<code>Test Kitchen</code>\u73af\u5883\u7684\u914d\u7684\u53c2\u6570\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>kitchen driver discover</code>\u547d\u4ee4\u6765\u5f97\u5230\u4e00\u4e2a\u53ef\u7528\u7684\u9a71\u52a8\u5217\u8868</p> </li> <li> <p><code>provision</code>: \u6307\u5b9a\u4f7f\u7528\u54ea\u4e2a\u914d\u754c\u7ba1\u7406\u5de5\u5176\u6765\u521b\u5efa\u6307\u5b9a\u9a71\u52a8\u7684\u73af\u63a9,\u4ee5\u4e0a\u7684\u4f8b\u5b50\u4e2d\u6211\u4eec\u4f7f\u7528<code>chef_solo</code>,\u5f53\u4f60\u8fd0\u884c<code>kitchen setup</code>\u65f6\u5b83\u5c06\u5728\u5b9e\u4f8b\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\uff08\u5982\u679c\u76ee\u524d\u5c1a\u672a\u5b89 \u88c5\u7684\u8bdd\uff09\u3002 </p> </li> <li> <p><code>platforms</code>: \u4f60\u5e0c\u671b<code>Test kitchen</code>\u521b\u5efa\u7684\u5b9e\u4f8b\u64cd\u4f5c\u7cfb\u7edf\u5217\u8868</p> </li> <li> <p><code>suites</code>: \u5728\u4f7f\u7528<code>Chef</code>\u4f5c\u4e3a\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u65f6\uff08<code>Test Kitchen\u4e0d</code>\u4ec5\u4ec5\u652f\u6301<code>Chef</code>)\uff0c\u6307\u5b9a\u6bcf\u4e2a\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u7684\u914d\u7f6e\u3002\u8fd9\u5305\u62ec\u6307\u5b9a\u5728\u6bcf\u4e2a\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u7684<code>Chef</code>\u914d\u65b9\u5355\u7684\u5217\u8868\u6765\u3002 </p> </li> </ul> <pre><code>---\nplatforms:\n  - name: ubuntu-12.04\n  - name: centos-6.4\n</code></pre> <p>Test Kitchen expands the values to the following internally:</p> <pre><code>platforms:\n- name: ubuntu-12.04\n  driver:\n    box: opscode-ubuntu-12.04\n    box_url: https://opscode-vm-bento.s3.amazonaws.com/vagrant/\\\n             opscode_ubuntu-12.04_provisionerless.box\n- name: centos-6.4\n  driver:\n    box: opscode-centos-6.4\n    box_url: https://opscode-vm-bento.s3.amazonaws.com/vagrant/\\\n             opscode_centos-6.4_provisionerless.box\n</code></pre>"},{"location":"chap1/chef_tutorial4/#5","title":"5\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li><code>kitchen init</code> </li> </ul> <p>\u5411\u4e00\u4e2a\u9879\u76ee\u4e2d\u6dfb\u52a0<code>Test Kitchen</code>\u652f\u6301 </p> <ul> <li><code>kitchen list</code> </li> </ul> <p>\u663e\u793a<code>Test Kitchen</code>\u5b9e\u4f8b\u7684\u4fe1\u6025 </p> <ul> <li><code>kitchen create</code> </li> </ul> <p>\u542f\u52a8\u4e2a<code>Test Kitchen</code>\u5b9e\u4f8b\uff08\u5982\u679c\u975e\u5df2\u7ecf\u8fd0\u884c\uff09 </p> <ul> <li><code>kitchen login</code> </li> </ul> <p>\u767b\u5f55\u8fdb\u4eba\u4e00\u4e2a<code>Test Kitchen</code>\u5b9e\u4f8b </p> <ul> <li><code>kitchen destroy</code> </li> </ul> <p>\u5173\u95ed\u4e00\u4e2a\u5b9e\u4f8b\u5e76\u5220\u9664\u5176\u865a\u62df\u673a </p> <p>\u6211\u4eec\u4ecb\u7ecd\u4e86\u63a7\u5236<code>Test Kitchen</code>\u884c\u4e3a\u7684\u4ee5\u4e0b\u914d\u7f6e\u6587\u4ef6\uff1a </p> <ul> <li> <p><code>kitchen.yml</code> \u914d\u7f6e<code>Test Kitchen</code>\u73af\u5883\u8bbe\u7f6e </p> </li> <li> <p><code>Gemfile</code></p> </li> </ul> <p><code>Bundler</code>\u53ef\u4ee5\u901a\u8fc7<code>bundle install</code>\u5b89\u88c5\u7684\u6240\u9700\u7684<code>gem</code> (<code>Ruby</code>\u7a0b\u5e8f\uff09\u4ee5\u53ca\u5b58\u50a8\u5e93\u4f4d\u7f6e </p> <ul> <li><code>Gemfile.lock</code></li> </ul> <p>\u5f53<code>bundle install</code>\u8fd0\u884c\u65f6<code>Bundler</code>\u6240\u9700\u7684<code>gem</code>\u548c\u5b83\u6240\u4f9d\u8d56\u7684<code>gem</code>\u7684\u5217\u8868  \u53ef\u4ee5\u7528\u6765\u5728\u53e6\u4e00\u4e2a\u5f00\u53d1\u8005\u7684\u7535\u8111\u4e0a\u91cd\u73b0\u4e00\u6837\u7684\u73af\u5883\u3002 </p>"},{"location":"chap1/chef_tutorial5/","title":"\u7b2c\u4e94\u8282 \u7528 Chef \u6237\u7aef\u7ba1\u7406\u8282\u70b9","text":""},{"location":"chap1/chef_tutorial5/#1","title":"1\u3001\u4ec0\u4e48\u662f\u8282\u70b9","text":"<p>\u5728\u8bb2\u8ff0\u5982\u4f55\u4f7f\u7528<code>Test Kitchen</code>\u5728\u865a\u62df\u673a\u4e2d\u5b89\u88c5Chef\u5ba2\u6237\u7aef\u4e4b\u524d\u5148\u6765\u4ecb\u7ecd\u4e00\u4e0b\u6211\u4eec\u7528\u6765\u63cf\u8ff0\u4e0d\u540c\u4e3e\u578b\u7684\u7535\u8111\u7684<code>Chef</code>\u672f\u8bed\u3002 </p> <p>\u7528\u6765\u5199<code>Chef</code>\u4ee3\u7801\u7684\u7535\u8111\u6211\u4eec\u79f0\u4f5c<code>Chef</code>\u5f00\u53d1\u8005\u5de5\u4f5c\u7ad9\u6216<code>Chef</code>\u7ba1\u7406\u5458\u5de5\u4f5c\u7ad9\uff08\u6216\u7b80\u79f0\u5f00\u53d1\u673a\u5668\u548c\u5de5\u4f5c\u673a\u5668\uff09\u3002\u8fd9\u662f\u4f60\u4f7f\u7528\u7684\u5bbf\u4e3b\u673a\u5668\u3002\u5728\u7b2c2\u7ae0\u4e2d\u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u5b89\u88c5\u4e86<code>Chef</code>\u5f00\u53d1\u5305\uff08\u6216Chef\u5ba2\u6237\u7aef\u548c\u989d\u5916\u5de5\u5177\uff09\uff0c\u56e0\u6b64\u4f60\u6709\u8db3\u591f\u591a\u7684\u5de5\u5176\u6765\u4f7f\u7528\u4e00\u4e2a\u6587\u672c\u7f16\u8f91\u5668\u6216\u96c6\u6210\u5f00\u53d1\u73af\u5883\u6765\u5199<code>Chef</code>\u914d\u65b9\u5355\u4ee5\u53ca\u4f7f\u7528\u4e00\u4e2a\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u6765\u7ba1\u7406<code>Chef</code>\u4ee3\u7801\u7684\u6539\u53d8\u3002</p> <p>\u53d7<code>Chef</code>\u7ba1\u7406\u7684\u673a\u5668\u79f0\u4f5c\u8282\u70b9\u3002\u5f53\u4e00\u4e2a\u673a\u5668\u6267\u884c<code>Chef</code>\u914d\u65b9\u5355\u4e95\u56e0\u6b64\u4fdd\u8bc1\u673a\u5668\u662f\u5728\u7406\u60f3\u7684\u914d \u7f6e\u4e0b\u65f6\uff0c\u6211\u4eec\u8bf4\u8fd9\u662f\u4e00\u53f0\u53d7<code>Chef</code>\u7ba1\u7406\u7684\u673a\u5668\uff0c\u50cf\u5728\u7b2c4\u7ae0\u4e2d\u5c55\u793a\u7684\u4e00\u6837\u4e2a\u8282\u70b9\u53ef\u4ee5\u662f\u4e00\u4e2a\u7269\u7406\u673a\u5668\u3001\u865a\u62df\u673a\u3001\u4e91\u5b9e\u4f8b\u6216\u5bb9\u5668\u5b9e\u4f8b<code>Chef</code>\u5e76\u4e0d\u5728\u5e73\u8fd9\u4e9b\u3002</p> <p>\u53ea\u8981\u8fd9\u4e2a\u8282\u70b9\u5b89\u88c5\u4e86<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u5c31\u53ef\u4ee5\u53d7<code>Chef</code>\u7ba1\u7406\u5e76\u8fd0\u884c<code>Chef</code>\u914d\u65b9\u5355\u3002 </p> <p>\u7531\u5e72<code>Chef</code>\u5f00\u53d1\u5305\u662f<code>Chef</code>\u5ba2\u6237\u7aef\u7684\u4e00\u4e2a\u8d85\u96c6\u4f60\u53ef\u4ee5\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5f00\u53d1\u5305\u3002</p> <p>\u8ba9\u4f60\u7684\u5bbf\u4e3b\u673a\u5668\u540c\u65f6\u6210\u4e3a\u4e00\u4e2a<code>Chef</code>\u5f00\u53d1\u5de5\u4f5c\u7ad9\u548c\u4e00\u4e2a\u53d7<code>Chef</code>\u7ba1\u7406\u7684\u8282\u70b9\u3002\u7136\u800c<code>Chef</code>\u5f00\u53d1\u5305\u5360\u7528\u51e0\u4e4e\u53cc\u500d\u4e8e<code>Chef</code>\u5ba2\u6237\u7aef\u7684\u7a7a\u95f4\uff0c\u6240\u6709\u5176\u5305\u542b\u7684\u989d\u5916\u7684\u5de5\u5177\u90fd\u662f\u4e3a\u4e86\u5e2e\u52a9\u64b0\u5199<code>Chef</code>\u4ee3\u7801\uff0c\u800c\u4e0d\u662f\u8fd0\u884c<code>Chef</code>\u4ee3\u7801\u3002</p>"},{"location":"chap1/chef_tutorial5/#2","title":"2\u3001\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u521b\u5efa\u6c99\u76d2\u73af\u5883","text":"<pre><code>$ cd chap05/node\n$ kitchen init --create-gemfile\n      create  kitchen.yml\n      create  chefignore\n      create  test/integration/default\n      create  Gemfile\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n</code></pre> <p>\u5728\u8fd0\u884c<code>kitchen init</code>\u4e4b\u540e\u8fd0\u884c<code>bundle install</code>,\u662f\u4e00\u4e2a\u503c\u5f97\u517b\u6210\u7684\u597d\u4e60\u60ef\u3002 </p> <pre><code>$ bundle install\n</code></pre> <p>\u7f16\u8f91<code>node/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n</code></pre> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre> <pre><code>$ kitchen create default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2222\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2222\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m39.92s).\n-----&gt; Kitchen is finished. (0m40.34s)\n</code></pre>"},{"location":"chap1/chef_tutorial5/#3test-kitchenchef","title":"3\u3001\u7528<code>Test Kitchen</code>\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef","text":"<p>\u4f7f\u7528<code>kitchen login</code>\u5230\u8282\u70b9\uff08\u6c99\u76d2\u73af\u9b42\uff09\u4e95\u8bbf\u95ee\u5176\u547d\u4ee4\u884c\u3002\u7136\u540e\u901a\u8fc7\u8fd0\u884c<code>chef client --version</code> \u770b\u770b<code>Chef</code>\u5ba2\u6237\u7aef\u662f\u5426\u5df1\u7ecf\u5b89\u88c5:</p> <pre><code>$ kitchen login default-centos65\nLast login: Sat Nov 23 10:50:26 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ chef-client --version\n-bash: chef-client: command not found\n</code></pre> <p>\u5b89\u88c5<code>chef-clinet</code>\u53ef\u4ee5\uff0c\u5355\u4e0d\u9700\u8981\uff0c\u56e0\u4e3a\u6709\u66f4\u7b80\u5355\u7684\u65b9\u5f0f </p> <pre><code>curl -Lk https://www.getchef.com/chef/install.sh | sudo bash\n</code></pre> <pre><code>[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>\u786e\u5b9a\u4f60\u4f7f\u7528\u4f60\u7684\u5bbf\u4e3b\u673a\u5668,\u5728\u6c99\u76d2\u4e2d\u5b89\u88c5<code>chef-client</code></p> <pre><code>$ kitchen setup default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n       Preparing dna.json\n       Policyfile, Berksfile, cookbooks/, or metadata.rb not found so Chef Infra Client will run, but do nothing. Is this intended?\n       Removing non-cookbook files before transfer\n       Preparing solo.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       ...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3205/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       resolving cookbooks for run list: []\n       Synchronizing Cookbooks:\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       [2019-11-23T11:03:01+00:00] WARN: Node default-centos65 has an empty run list.\n       Converging 0 resources\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 0/0 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (1m19.05s).\n-----&gt; Setting up &lt;default-centos65&gt;...\n       Finished setting up &lt;default-centos65&gt; (0m0.00s).\n-----&gt; Kitchen is finished. (1m19.50s)\n</code></pre> <p>\u68c0\u67e5<code>kitchen setup</code>\u547d\u4ee4\u7684\u8f93\u51fa\uff0c\u5b83\u4e3a\u4f60\u5b89\u88c5\u4e86<code>chef-client</code> (Che\u5580\u6237\u7aef\uff09\u6211\u4eec\u4f7f\u7528 <code>kitchen setup</code>\u547d\u4ee4\u6765\u8fd0\u884c\u4e00\u4e2a\u542f\u52a8\u5668(<code>provisioner</code>)\u3002</p> <p>\u542f\u52a8\u5668\u662f\u4e00\u4e2a\u8868\u793a\u4efb\u4f55\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u7684\u7efc\u5408\u672f\u8bed\uff0c\u56e0\u4e3a<code>Test Kitchen</code>\u4e5f\u53ef\u4ee5\u548c<code>Chef</code>\u4ee5\u5916\u7684\u5176\u4ed6\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u4e00\u8d77\u4f7f\u7528\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Test Kitchen</code>\u4f7f\u7528<code>ChefSolo</code>\u542f\u52a8\u5668\u3002</p> <p><code>Chef Solo</code>\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\u4f46\u4e0d\u628a\u5b83\u914d\u7f6e\u4e3a\u4f7f\u7528<code>Chef</code>\u670d\u52a1\u5668\u3002\u5982\u679c<code>chef-client</code>\u4e0d\u5b58\u5728\uff0c<code>kitchen setup</code>\u4f1a\u81ea\u52a8\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef</p>"},{"location":"chap1/chef_tutorial5/#3-1-ssl-warning","title":"3-1 SSL WARNING","text":"<p>During the Chef run, you might have noticed the following SSL warning:</p> <pre><code>* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *\nSSL validation of HTTPS requests is disabled. HTTPS connections are still\nencrypted, but chef is not able to detect forged replies or man in the middle\nattacks.\n\nTo fix this issue add an entry like this to your configuration file:\n\n   ```\n     # Verify all HTTPS connections (recommended)\n     ssl_verify_mode :verify_peer\n\n     # OR, Verify only connections to chef-server\n     verify_api_cert true\n   ```\n\n   To check your SSL configuration, or troubleshoot errors, you can use the\n   `knife ssl check` command like so:\n\n   ```\n     knife ssl check -c /tmp/kitchen/solo.rb\n   ```\n\n* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *\n</code></pre> <p>\u5728\u5f00\u53d1<code>Chef</code>\u4ee3\u7801\u7684\u65f6\u5019\u4e0d\u9a8c\u8bc1<code>Chef</code>\u670d\u52a1\u7684<code>HTTPS</code>\u8bd7\u6c42\u662f\u5b8c\u5168\u6ca1\u95ee\u9898\u7684\u3002\u4e8b\u5b9e\u4e0a\u73b0\u5728\u8fde\u4e00\u4e2a<code>Chef</code>\u670d\u52a1\u5668\u90fd\u6ca1\u6709\u56e0\u6b64\u5982\u679c\u5f00\u542f\u9a8c\u8bc1\uff0c\u4f1a\u5f97\u5230\u9519\u8bef </p> <p>\u4e3a\u4e86\u652f\u6301\u5f00\u53d1\u7684\u4fbf\u6377\u6027, <code>Chef</code>\u9ed8\u8ba4\u4e0d\u9a8c\u8bc1<code>HTTPS</code>\u8fde\u63a5\u7684\u8bc1\u4e66\u3002</p> <p><code>chef-client</code>\u901a\u8fc7\u4ee5\u4e0a\u8b66\u544a\u6307\u51fa\u8bc1\u4e66\u6ca1\u6709\u901a\u8fc7\u9a8c\u8bc1\u3002\u5f53\u5f00\u53d1<code>Chef</code>\u4ee3\u7801\u7684\u65f6\u5019\u5f80\u5f80\u4e0d\u9700\u8981\u4f7f\u7528<code>Chef</code>\u52a1\u5668, \u5373\u4f7f\u4f7f\u7528<code>Chef</code>\u670d\u52a1\u5668\u901a\u5e38\u4e5f\u662f\u7c7b\u4f3c<code>Chef Zero</code>\u7684\u5168\u5185\u5b58\u7248\u672c\uff0c \u901a\u5e38\u5e76\u4e0d\u9700\u8981\u8981\u914d\u7f6e\u4e00\u4e2a\u6709\u6548\u7684<code>SSL</code>\u914d\u7f6e</p> <p>\u7136\u800c\u5728\u751f\u4ea7\u73af\u5883\u5e94\u8be5\u5728<code>/etc/chef/client.rb</code>\u914d\u7f6e\u6587\u4ef6\u4e2d\u5f00\u542f\u8bc1\u4e66\u9a8c\u8bc1\u3002</p> <p>\u5982\u679c\u73b0\u5728\u8fd0\u884c<code>kitchen list</code>\u4f1a\u53d1\u73b0<code>Last Action</code>\u4ece<code>Created</code>\uff08\u5df2\u521b\u5efa\uff09\u53d8\u6210<code>Set Up</code>\uff08\u5df2\u914d\u7f6e\uff09:</p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action  Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        Set Up       &lt;None&gt;\n</code></pre> <pre><code>$ kitchen login default-centos65\nLast login: Sat Nov 23 11:02:58 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n\n[vagrant@default-centos65 ~]$ chef-client --version\nChef Infra Client: 15.5.17\n</code></pre>"},{"location":"chap1/chef_tutorial5/#4chef","title":"4\u3001\u7b2c\u4e00\u6b21\u8fd0\u884c<code>Chef</code>\u5ba2\u6237\u7aef","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>log</code>\u8d44\u6e90\u6765\u5728\u914d\u65b9\u5355\u4e2d\u6253\u5370\u5b57\u7b26\u4e32\u3002\u6bd4\u5982\uff0c\u5728\u914d\u65b9\u5355\u4e2d\u4f7f\u7528<code>log</code> \"Hello\"\u4f1a\u6253\u5370\u5b57\u7b26\u4e32<code>Hello</code>\u3002</p> <p>\u8ba9\u6211\u4eec\u6765\u8bd5\u8bd5\u8fd9\u4e2a\u3002\u5047\u8bbe\u4f60\u4ecd\u7136\u767b\u5f55\u5728\u8282\u70b9\u7684\u73af\u5883\u4e2d\uff0c \u8bf7\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u5728\u8282\u70b9\u4e0a\u521b\u5efa\u4e00\u4e2a<code>hello.rb</code>\u6587\u4ef6\uff1a </p> <pre><code>[vagrant@default-centos65 ~]$ cd node\n[vagrant@default-centos65 ~]$ echo 'log \"Hello, this is an important message.\"' &gt; hello.rb\n[vagrant@default-centos65 ~]$ ls node\nhello.rb\n[vagrant@default-centos65 ~]$ more node/hello.rb \nlog \"Hello, this is an important message.\"\n</code></pre> <p>\u901a\u8fc7\u4f7f\u7528<code>chef-client</code>\u7a0b\u5e8f\u6765\u6267\u884c\u914d\u65b9\u5355\u4e2d\u6307\u5b9a\u7684\u52a8\u4f5c\u901a\u5e38\u88ab\u79f0\u4f5c\u4e00\u6b21<code>Chef</code>\u8fd0\u884c</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u4eba<code>chef-client --local-mode hello.rb --log_level info</code>\u5c06\u6267\u884c\u4f60\u7684\u7b2c\u4e00\u6b21<code>Chef</code>\u8fd0\u884c\u3002</p> <ul> <li><code>--local-mode</code>\u9009\u9879\u9632\u6b62<code>chef-client</code>\u5728\u5bfb\u627e\u4e0d\u5b58\u5728\u7684<code>Chef</code>\u670d\u52a1\u5668\u65f6\u8d85\u65f6\u3002</li> <li>\u6211\u4eec\u540c\u65f6\u9700\u8981<code>--log_level info</code>\u9009\u9879\uff0c\u56e0\u4e3a\u9ed8\u8ba4\u60c5\u51b5\u4e0b<code>chef-client</code>\u53ea\u6253\u5370\u9519\u8bef\uff0c\u800c\u975e\u4fe1\u606f\u6d88\u606f\uff0c </li> <li>\u8fd9\u4e2a\u9009\u9879\u5c06\u544a\u8bc9<code>chef-client</code>\u6253\u5370\u6765\u81ea<code>Chef::Log.info</code>\u547d\u4ee4\u7684\u6240\u6709\u5b57\u7b26\u4e32\u3002 </li> </ul> <pre><code>[vagrant@default-centos65 node]$ chef-client --local-mode hello.rb\n[2019-11-24T07:50:04+00:00] WARN: No config file found or specified on command line. Using command line options instead.\n[2019-11-24T07:50:04+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /home/vagrant/node.\nStarting Chef Infra Client, version 15.5.17\nresolving cookbooks for run list: []\nSynchronizing Cookbooks:\nInstalling Cookbook Gems:\nCompiling Cookbooks...\n[2019-11-24T07:50:06+00:00] WARN: Node default-centos65.vagrantup.com has an empty run list.\nConverging 1 resources\nRecipe: @recipe_files::/home/vagrant/node/hello.rb\n  * log[Hello, this is an important message.] action write\n\n\nRunning handlers:\nRunning handlers complete\nChef Infra Client finished, 1/1 resources updated in 01 seconds\n</code></pre> <p>\u5728<code>chef-client</code>\u8fd0\u884c\u65f6\uff0c\u4ee5\u4e0b\u8f93\u51fa\u8868\u793a<code>\u201cHello, this is an important message.\"</code>\u5b57\u7b26\u4e32\u5728<code>chef</code>\u8fd0\u884c\u65f6\u88ab\u5199\u5165\u4e86\u65e5\u5fd7 </p> <pre><code>log[Hello, this is an important message.] action write\n</code></pre> <p>\u8981\u60f3\u67e5\u770b\u5b9e\u9645\u7684\u65e5\u5fd7\u6d88\u606f\u5185\u5bb9\u9700\u8981\u66f4\u6539<code>chef-client</code>\u7684\u65e5\u5fd7\u7ea7\u522b</p> <p>\u6bcf\u4e00\u4e2a\u5199\u5728\u65e5\u5fd7\u7684\u6d88\u606f\u5df2\u90fd\u6709\u4e2a\u7ea7\u522b\uff0c \u8fd9\u4e9b\u7ea7\u522b\u6839\u636e\u4f18\u5148\u7ea7\u4ece\u4f4e\u5230\u9ad8\u4f9d\u6b21\u4e3a<code>debug</code>\u3001<code>Info</code>\\ <code>warn</code>\u3001<code>error</code>\u548c<code>fatal</code>\u3002 </p> <p><code>log</code>\u8d44\u6e90\u9ed8\u8ba4\u4f7f\u7528<code>Info</code>\u7ea7\u522b, \u5bf9\u4e8e\u4f60\u7684\"Hello\"\uff0c \u6d88\u606f\u6765\u8bb2\u662f\u5408\u9002\u7684\u3002\u7136\u800c<code>chef client</code> \u9ed8\u8ba4\u53ea\u6253\u5370<code>Warn</code>\u6216\u66f4\u9ad8\u7ea7\u522b\u7684\u6d88\u606f\uff0c \u9664\u975e\u6539<code>chef-client</code>\u7684\u65e5\u5fd7\u7ea7\u522b </p> <p>\u8981\u6539\u53d8\u65e5\u5fd7\u7ea7\u522b\uff0c\u4f7f\u7528<code>--log-level</code>\u9009\u9879\u3002<code>--log_level</code>\u9009\u9879\u9700\u8981\u4e2a\u53c2\u6570(<code>--log_level</code> &lt;\u7ea7\u522b\uff1e)\uff0c\u7528\u6765\u544a\u8bc9<code>chef-client</code>\u6700\u4f4e\u7684\u5199\u5411\u65e5\u5fd7\u7684\u7ea7\u522b\u3002</p> <p>\u5982\u679c\u5728<code>chef-client</code>\u547d\u4ee4\u540e\u9762\u52a0\u4e0a<code>--log-level info</code> \u5219\u4f1a\u663e\u793a\u4f60\u521a\u521a\u6dfb\u52a0\u7684\u65e5\u5fd7\u6d88\u606f\u3002</p> <pre><code>$ chef-client --local-mode hello.rb --log_level info\n\n[2019-11-24T08:11:52+00:00] WARN: No config file found or specified on command line. Using command line options instead.\n[2019-11-24T08:11:52+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /home/vagrant/node.\n[2019-11-24T08:11:52+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/vagrant/node\n[vagrant@default-centos65 node]$ chef-client --local-mode hello.rb --log_level info\n[2019-11-24T08:12:20+00:00] WARN: No config file found or specified on command line. Using command line options instead.\n[2019-11-24T08:12:20+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /home/vagrant/node.\n[2019-11-24T08:12:20+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/vagrant/node\n  One version per cookbook\n\nStarting Chef Infra Client, version 15.5.17\n[2019-11-24T08:12:20+00:00] INFO: *** Chef Infra Client 15.5.17 ***\n[2019-11-24T08:12:20+00:00] INFO: Platform: x86_64-linux\n[2019-11-24T08:12:20+00:00] INFO: Chef-client pid: 3680\n[2019-11-24T08:12:21+00:00] INFO: Run List is []\n[2019-11-24T08:12:21+00:00] INFO: Run List expands to []\n[2019-11-24T08:12:21+00:00] INFO: Starting Chef Infra Client Run for default-centos65.vagrantup.com\n[2019-11-24T08:12:21+00:00] INFO: Running start handlers\n[2019-11-24T08:12:21+00:00] INFO: Start handlers complete.\nresolving cookbooks for run list: []\n[2019-11-24T08:12:21+00:00] INFO: Loading cookbooks []\nSynchronizing Cookbooks:\nInstalling Cookbook Gems:\nCompiling Cookbooks...\n[2019-11-24T08:12:21+00:00] WARN: Node default-centos65.vagrantup.com has an empty run list.\nConverging 1 resources\nRecipe: @recipe_files::/home/vagrant/node/hello.rb\n  * log[Hello, this is an important message.] action write[2019-11-24T08:12:21+00:00] INFO: Processing log[Hello, this is an important message.]\n action write (@recipe_files::/home/vagrant/node/hello.rb line 1)\n[2019-11-24T08:12:21+00:00] INFO: Hello, this is an important message.\n\n\n[2019-11-24T08:12:21+00:00] INFO: Chef Infra Client Run complete in 0.037831751 seconds\n\nRunning handlers:\n[2019-11-24T08:12:21+00:00] INFO: Running report handlers\nRunning handlers complete\n[2019-11-24T08:12:21+00:00] INFO: Report handlers complete\nChef Infra Client finished, 1/1 resources updated in 01 seconds\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b<code>chef-client</code>\u5c06\u65e5\u5fd7\u6253\u5370\u81f3\u5c4f\u5e55\u3002\u73b0\u5728\u4f60\u6539\u53d8\u4e86\u65e5\u5fd7\u7ea7\u522b\u53ef\u4ee5\u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u770b\u5230\u6dfb\u52a0\u7684\u6d88\u6025\uff08\u4ee5\u53ca\u4e00\u4e9b\u5176\u4ed6\u540c\u65f6\u5728<code>info</code>\u7ea7\u522b\u7684\u6d88\u606f\uff09\u3002</p>"},{"location":"chap1/chef_tutorial5/#note","title":"NOTE","text":"<p>If you would prefer to write the <code>chef-client</code> log to a file, use the <code>--logfile &lt;LOGLOCATION&gt;</code> option (or the short form <code>-l</code>). </p>"},{"location":"chap1/chef_tutorial5/#5chef","title":"5\u3001Chef\u5ba2\u6237\u7aef\u7684\u4e09\u79cd\u6a21\u5f0f","text":"<p><code>Chef</code>\u5ba2\u6237\u7aef\u53ef\u4ee5\u5728\u4ee5\u4e0b\u4e09\u79cd\u6a21\u5f0f\u7684\u4efb\u4f55\u4e00\u79cd\u4e0b\u8fd0\u884c </p> <ul> <li>\u672c\u5730\u6a21\u5f0f </li> <li>\u5ba2\u6237\u7aef\u6a21\u5f0f </li> <li><code>Solo</code>\u6a21\u5f0f </li> </ul>"},{"location":"chap1/chef_tutorial5/#5-1","title":"5-1 \u672c\u5730\u6a21\u5f0f","text":"<p>\u5f53<code>chef-client</code>\u4ee5\u672c\u5730\u6a21\u5f0f\u8fd0\u884c\u65f6\uff0c\u5b83\u5728\u5185\u5b58\u4e2d\u6a21\u62df\u4e00\u4e2a\u5b8c\u6574\u7684<code>Chef</code>\u670d\u52a1\u5668\u3002\u4efb\u4f55\u672c\u5e94\u4fdd\u5b58\u5230\u670d\u52a1\u5668\u7684\u6570\u636e\u4f1a\u88ab\u5199\u5165\u4e00\u4e2a\u672c\u5730\u6587\u4ef6\u5939\u3002 \u5c06\u670d\u52a1\u5668\u6570\u636e\u5199\u5728\u672c\u5730\u7684\u8fc7\u7a0b\u53eb\u505a\u56de\u5199(<code>writeback</code>)\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48<code>chef-client</code>\u521b\u5efa\u4e86<code>nodes/</code>\u76ee\u5f55\u3002 \u672c\u5730\u6a21\u5f0f\u662f\u8bbe\u8ba1\u6765\u652f\u6301\u901a\u8fc7\u4f7f\u7528\u5b8c\u5168\u5728\u5185\u5b58\u7684<code>Chef Zero</code>\u670d\u52a1\u5668\u6765\u8fdb\u884c\u5feb\u901f\u7684<code>Chef</code>\u914d\u65b9\u5355\u5f00\u53d1 </p> <pre><code>$ ls -la\ntotal 16\ndrwxrwxr-x  3 vagrant vagrant 4096 Nov 24 07:50 .\ndrwx------. 5 vagrant vagrant 4096 Nov 24 07:50 ..\n-rw-rw-r--  1 vagrant vagrant   43 Nov 24 07:37 hello.rb\ndrwx------  2 vagrant vagrant 4096 Nov 24 07:50 nodes\n</code></pre>"},{"location":"chap1/chef_tutorial5/#5-2","title":"5-2 \u5ba2\u6237\u7aef\u6a21\u5f0f","text":"<p>\u5f53<code>chef-client</code>\u4ee5\u5ba2\u6237\u7aef\u6a21\u5f0f\u8fd0\u884c\u65f6\uff0c\u5b83\u5047\u8bbe\u4f60\u5728\u7f51\u7edc\u4e2d\u5df2\u7ecf\u8ba9<code>Chef</code>\u670d\u52a1\u5668\u6b63\u5728\u8fd0\u884c\u3002\u4eba\u4eec\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5c31\u662f\u8fd9\u6837\u4f7f\u7528<code>chef</code>\u7684. \u5728\u5ba2\u6237\u7aef\u6a21\u5f0f\u4e2d\uff0c<code>chef-client</code>\u662f\u4e00\u4e2a\u5728\u88ab<code>Chef</code>\u7ba1\u7406\u7684\u673a\u5668\u672c\u5730\u8fd0\u884c\u7684\u4ee3\u7406\u4eba\u7a0b\u5e8f\uff08\u6216\u670d\u52a1\u3001\u540e\u53f0\u7a0b\u5e8f). <code>Chef</code>\u670d\u52a1\u5668\u96c6\u4e2d\u5b58\u50a8\u9700\u8981\u7ba1\u7406\u7684\u57fa\u7840\u67b6\u6784\u7684\u4fe1\u606f\u3002\u5982\u679c\u9700\u8981\u540c\u65f6\u7ba1\u7406\u591a\u4f59\u4e00\u53f0\u673a\u5668\uff0c\u63a8\u8350\u4f7f\u7528<code>Chef</code>\u670d\u52a1\u5668 </p>"},{"location":"chap1/chef_tutorial5/#5-3-solo","title":"5-3 <code>Solo</code>\u6a21\u5f0f","text":"<p>\u5728\u7248\u672c<code>11.8</code>\u4e2d<code>chef-client</code>\u652f\u6301\u672c\u5730\u6a21\u5f0f\u4e4b\u524d\uff0c\u552f\u4e00\u4e0d\u9700\u8981<code>Chef</code>\u670d\u52a1\u5668\u8fd0\u884c<code>Chef</code>\u4ee3\u7801\u7684\u65b9\u6cd5\u662f\u4f7f\u7528<code>chef-solo</code>.</p> <p><code>chef-solo</code>\u63d0\u4f9b\u4e00\u4e2a\u989d\u5916\u7684\u5ba2\u6237\u7aef\u6a21\u5f0f\u53eb\u505a<code>Solo</code>\u6a21\u5f0f\u3002<code>Solo</code>\u6a21\u5f0f\u63d0\u4f9b\u4e86\u8ba9<code>Chef</code>\u591f\u672c\u5730\u8fd0\u884c\u7684<code>Chef</code>\u529f\u80fd\u7684\u6709\u9650\u7684\u5b50\u96c6\u3002<code>chef-solo</code>\u4e0d\u652f\u6301\u56de\u5199, \u5728\u5927\u591a\u6570\u65f6\u5019\uff0c\u672c\u5730\u6a21\u5f0f\u90fd\u8fdc\u8fdc\u6bd4<code>Solo</code>\u6a21\u5f0f\u66f4\u65b9\u4fbf\u4f7f\u7528\u3002</p> <p>\u5728\u672a\u6765\uff0c<code>Chef</code>\u8f6f\u4ef6\u516c\u53f8\u8ba1\u5212\u5f53\u672c\u5730\u6a21\u5f0f\u62e5\u6709\u7684\u529f\u80fd\u4ee5\u53ca\u5927\u591a\u6570\u5ba2\u6237\u90fd\u4f7f\u7528\u7248\u672c<code>11.8</code>\u6216\u66f4\u9ad8\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u63d0\u4f9b\u5bf9<code>Solo</code>\u6a21\u5f0f\u7684\u652f\u6301\u3002<code>Solo</code>\u6a21\u5f0f\u5728\u4ecd\u7136\u4f7f\u7528\u8001\u7248\u672c<code>Chef</code>\u7684\u7ec4\u7ec7\u4e2d\u66f4\u53d7\u6b22\u8fce\u3002 </p>"},{"location":"chap1/chef_tutorial5/#6ohai","title":"6\u3001\u547d\u4ee4\u884c\u5de5\u5177<code>Ohai</code>","text":"<p>\u5f53<code>Chef</code>\u5ba2\u6237\u7aef\u8fd0\u884c\u65f6, \u5b83\u4f7f\u7528\u4e00\u4e2a\u989d\u5916\u7684\u547d\u4ee4\u884c\u5de5\u5177<code>ohai</code>\u6765\u6536\u96c6\u7cfb\u7edf\u4fe1\u606f\u3002<code>ohai</code>\u5c06\u6536\u96c6  \u5230\u7684\u8282\u70b9\u4fe1\u5305\u50a8\u5b58\u5728<code>Chef</code>\u7684\u81ea\u52a8\u5c5e\u6027\u4e2d </p> <p>\u53ef\u4ee5\u8bd5\u8bd5\u624b\u52a8\u8fd0\u884c<code>ohai</code>, \u8f93\u51fa\u7684\u4fe1\u606f\u5c31\u662f\u5b83\u50a8\u5b58\u5728<code>Chef</code>\u8282\u70b9\u7684\u4fe1\u606f\u3002\u5728\u6211\u4eec\u7684\u7cfb\u7edf\u4e0a\uff0c<code>ohai</code> \u8f93\u51fa\u4e86<code>1058</code>\u884c\u7ed3\u679c\uff0c \u6240\u4ee5\u4f60\u6700\u597d\u914d\u5408\u4f7f\u7528<code>more</code>\u6b64\u547d\u4ee4\u6765\u4e00\u5c4f\u4e00\u5c4f\u67e5\u770b\u7ed3\u679c\u3002\u4e0d\u5fc5\u770b\u5b8c\u6574\u4e2a\u7ed3\u679c\uff0c \u4efb\u4f55\u65f6\u5019\u90fd\u53ef\u4ee5\u901a\u8fc7<code>q</code>\u952e\u9000\u51fa  </p> <pre><code>$ ohai | more\n{\n  \"kernel\": {\n    \"name\": \"Linux\",\n    \"release\": \"2.6.32-431.el6.x86_64\",\n    \"version\": \"#1 SMP Fri Nov 22 03:15:09 UTC 2013\",\n    \"machine\": \"x86_64\",\n    \"processor\": \"x86_64\",\n    \"os\": \"GNU/Linux\",\n    \"modules\": {\n      \"vmhgfs\": {\n        \"size\": \"49607\",\n        \"refcount\": \"1\",\n        \"version\": \"1.4.1.1\"\n      },\n      \"vsock\": {\n        \"size\": \"46422\",\n        \"refcount\": \"2\",\n        \"version\": \"9.6.1.0\"\n      },\n      \"ipv6\": {\n        \"size\": \"317340\",\n        \"refcount\": \"24\"\n      },\n      \"ppdev\": {\n        \"size\": \"8537\",\n        \"refcount\": \"0\"\n      },\n      \"vmware_balloon\": {\n        \"size\": \"7199\",\n        \"refcount\": \"0\",\n        \"version\": \"1.2.1.1-k\"\n      },\n      \"parport_pc\": {\n        \"size\": \"22690\",\n/address\n...skipping\n        \"addresses\": {\n          \"127.0.0.1\": {\n            \"family\": \"inet\",\n            \"prefixlen\": \"8\",\n            \"netmask\": \"255.0.0.0\",\n            \"scope\": \"Node\"\n          },\n          \"::1\": {\n            \"family\": \"inet6\",\n            \"prefixlen\": \"128\",\n            \"scope\": \"Node\",\n            \"tags\": [\n\n            ]\n          }\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c<code>ohai</code>\u6536\u96c6\u8bb8\u591a\u5173\u4e8e\u7535\u8111\u5f53\u524d\u72b6\u6001\u7684\u4fe1\u606f\uff1a\u7f51\u7edc\u914d\u7f6e, Cpu\u72b6\u6001\u3001\u64cd\u4f5c\u7cfb\u7edf\u7c7b\u578b\u548c\u7248\u672c\u3001\u5185\u5b58\u4f7f\u7528\u91cf\u7b49\u3002</p> <p>\u4e3e\u4f8b\u800c\u8a00\uff0c\u8ba9\u6211\u4eec\u770b\u770bohaj\u4ea7\u751f\u7684\u4fe1\u606f\u7684\u4e00\u90e8\u5206\u3002\u5c31\u50cf\u4e0b\u9762\u5c55\u793a\u7684\uff0cchai\u6536\u96c6\u8282\u70b9\u7684<code>IP</code>\u5730\u5740\u3001<code>MAC</code>\u5730\u5740\u3001\u64cd\u4f5c\u7cfb\u7edf\u4fe1\u6025\u3001\u4e3b\u673a\u540d\uff0c\u5b83\u751a\u81f3\u77e5\u9053\u6211\u4eec\u5728\u4e00\u4e2a\u865a\u62df\u73af\u5883\u4e2d\u8fd0\u884c\uff1a </p> <pre><code>{\n...\n  \"ipaddress\": \"10.0.2.15\",\n  \"macaddress\": \"08:00:27:1C:AD:B6\",\n...\n  \"os\": \"linux\",\n  \"os_version\": \"2.6.32-431.el6.x86_64\",\n  \"platform\": \"centos\",\n  \"platform_version\": \"6.5\",\n  \"platform_family\": \"rhel\",\n...\n  \"virtualization\": {\n    \"system\": \"vbox\",\n    \"role\": \"guest\"\n  }\n...\n  \"hostname\": \"default-centos65\"\n...\n}\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0b\u5c5e\u6027\uff0c\u53ef\u4ee5\u5728\u4ee3\u7801\u91cc\u5f15\u7528\u8282\u70b9\u7684<code>IP</code>\u5730\u5740\u3002\u5c5e\u5c5e\u6027\u662f<code>Chef</code>\u7ba1\u7406\u7684\u4e00\u4e2a\u53d8\u91cf\u3002\u5728\u4f60\u7684\u4ee3\u7801\u4e2d\uff0c\u5728\u4e2d\u62ec\u53f7\u4e2d\u7528\u5f15\u53f7\u5305\u56f4\u7684\u5b57\u7b26\u4e32\u6307\u5b9a\u5c5e\u80dc\u7684\u540d\u79f0\uff0cChef\u4f1a\u8fd4\u56de\u5c5e\u6027\u7684\u503c\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u8981\u77e5\u9053<code>IP</code>\u5730\u5740\uff0c\u5728\u4e4b\u524d\u7684<code>ohaI</code>\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u77e5\u9053\u5176<code>IP</code>\u5730\u5740\u5c5e\u80dc\u7684\u540d\u79f0\u662f<code>ipaddress</code>,\u56e0\u6b64\u53ef\u4ee5\u7528\u6b64\u540d\u79f0\u5728<code>Chef</code>\u4ee3\u7801\u4e2d\u8bbf\u95ee\u8282\u70b9\u7684\u5c5e\u80dc\uff1a </p> <pre><code>node['ipaddress']\n</code></pre> <p>\u6211\u4eec\u5728\u524d\u9762\"\u914d\u65b9\u5355\u6307\u5b9a\u7406\u60f3\u914d\u7f6e\u201d\u5c0f\u8282\u7684<code>Chef</code>\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86\u5c5e\u6027\u53d8\u91cf\uff0c node\u662f\u53e6\u5916\uff0d\u4e2a<code>Chef</code>\u4ee3\u7801\u4e2d\u53ef\u4ee5\u4f7f\u7528\u7684\u5c5e\u6027\u3002\u5b83\u5305\u542b\u5728\u8282\u70b9\u4e0a\u8fd0\u884c<code>ohai</code>\u8f93\u51fa\u7684\u6240\u6709\u4fe1\u606f\u548c\u6211\u4eec\u4f7f\u7528\u7684<code>ENV</code>\u5c5e\u6027\u7c7b\u4f3c\uff0c<code>node</code>\u5c5e\u6027\u662f\u4e00\u4e2a\u952e\u503c\u5bf9\u513f\u96c6\u5408</p> <p>\u952e\u503c\u5bf9\u513f\u96c6\u5408\u652f\u6301\u5d4c\u5957\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5728<code>ohai</code>\u8f93\u51fa\u4e2d\u4f1a\u6709\u591a\u5c42\u7f29\u8fdb\u3002\u56e0\u6b64\uff0c\u5982\u679c\u8981\u8bbf\u95ee\u8282\u70b9\u4f7f\u7528\u7528\u7684\u865a\u62df\u8f6f\u4ef6\u4fe1\u6025\uff08\"\u865a\u62df\u7cfb\u7edf\u201d)\uff0c\u4f7f\u7528\u4ee5\u4e0b\u7684\u5d4c\u5957\u952e\u503c\u5bf9\u513f\uff0c<code>system</code>\u662f <code>virtualization</code>\u96c6\u5408\u4e2d\u7684\u4e00\u4e2a\u952e</p> <pre><code>node['virtualization']['system']\n</code></pre> <p>\u8bf4\u660e\uff1a\u4ee5\u5b57\u7b26\u4e32\u6765\u8bbf\u95ee\u5c5e\u6027\u7684\u503c\uff0c\u4f8b\u5982<code>node[\"virtualization\"][\"system\"]</code>\uff0c\u662f\u6700\u5e38\u7528\u7684\u8bbf\u95ee\u65b9\u6cd5\u3002\u7136\u800c\uff0c\u56e0\u4e3a\u5c5e\u6027\u662f<code>Mash</code>\u5bf9\u8c61\uff0c\u6240\u4ee5\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5f62\u5f0f\u6765\u8bbf\u95ee\u5c5e\u6027\u7684\u503c </p> <pre><code>node[:virtualization][:system]\nnode['virtualization']['system']\nnode.virtualization.system\n</code></pre>"},{"location":"chap1/chef_tutorial5/#7","title":"7\u3001\u8bbf\u95ee\u8282\u70b9\u4fe1\u606f","text":"<p>\u4e0a\u4e00\u8282\u6211\u4eec\u8bb2\u8ff0\u4e86<code>chef-client</code>\u4f7f\u7528<code>ohai</code>\u6765\u6536\u96c6\u8282\u70b9\u7684\u8bb8\u591a\u4fe1\u606f\u3002</p> <p>\u6536\u96c6\u8fd9\u4e9b\u4fe1\u606f\u662f\u5fc5\u8981\u7684\u56e0\u4e3a\u8fd9\u6837<code>Chef</code>\u624d\u53ef\u4ee5\u667a\u80fd\u5730\u5224\u65ad\u5982\u4f55\u5c06\u8282\u70b9\u8f6c\u6362\u81f3\u914d\u65b9\u5355\u4e2d\u6307\u5b9a\u7684\u7406\u60f3\u7684\u914d\u7f6e\u3002<code>Chef</code>\u5c06\u8fd9\u4e9b\u4fe1\u606f\u4f5c\u4e3a\u8282\u70b9\u5c5e\u80dc\u6765\u8ba9\u4f60\u53ef\u4ee5\u5728\u4ee3\u7801\u4e2d\u8bbf\u95ee\u3002</p> <p>\u5c5e\u80dc\u662f<code>Chef</code>\u7ef4\u62a4\u7684\u4e00\u4e2a\u53d8\u91cf </p> <pre><code>$ vi info.rb\n\nlog \"IP Address: #{node['ipaddress']}\"\nlog \"MAC Address: #{node['macaddress']}\"\nlog \"OS Platform: #{node['platform']} #{node['platform_version']}\"\nlog \"Running on a #{node['virtualization']['system']} #{node['virtualization']['role']}\"\nlog \"Hostname: #{node['hostname']}\"\n</code></pre> <p>\u4f60\u5e94\u8be5\u5bf9\u4f7f\u7528\u6599<code>#{&lt;\u53d8\u91cf\uff1e\uff5d</code>\u6765\u6253\u5370\u5728\u53d8\u91cf\u4e2d\u7684\u4fe1\u606f\u7684\u8bed\u6cd5\u5e76\u4e0d\u964c\u751f\uff0c\u8fd9\u8ddf\u6211\u4eec\u5728\u7b2c4\u7ae0\u4e2d\u7528\u6765\u8bbf\u95ee<code>\uff03{ENV['HOME']}</code>\u65f6\u5f88\u7c7b\u4f3c\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c<code>node</code>\u662f\u6211\u4eec\u7684\u53d8\u91cf\u3002 </p> <pre><code>[vagrant@default-centos65 node]$  chef-client --local-mode info.rb --log_level info\n[2019-11-24T09:41:03+00:00] WARN: No config file found or specified on command line. Using command line options instead.\n[2019-11-24T09:41:03+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /home/vagrant/node.\n[2019-11-24T09:41:03+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/vagrant/node\n  One version per cookbook\n\nStarting Chef Infra Client, version 15.5.17\n[2019-11-24T09:41:03+00:00] INFO: *** Chef Infra Client 15.5.17 ***\n[2019-11-24T09:41:03+00:00] INFO: Platform: x86_64-linux\n[2019-11-24T09:41:03+00:00] INFO: Chef-client pid: 3930\n[2019-11-24T09:41:04+00:00] INFO: Run List is []\n[2019-11-24T09:41:04+00:00] INFO: Run List expands to []\n[2019-11-24T09:41:04+00:00] INFO: Starting Chef Infra Client Run for default-centos65.vagrantup.com\n[2019-11-24T09:41:04+00:00] INFO: Running start handlers\n[2019-11-24T09:41:04+00:00] INFO: Start handlers complete.\nresolving cookbooks for run list: []\n[2019-11-24T09:41:04+00:00] INFO: Loading cookbooks []\nSynchronizing Cookbooks:\nInstalling Cookbook Gems:\nCompiling Cookbooks...\n[2019-11-24T09:41:04+00:00] WARN: Node default-centos65.vagrantup.com has an empty run list.\nConverging 5 resources\nRecipe: @recipe_files::/home/vagrant/node/info.rb\n  * log[IP Address: 172.16.72.138] action write[2019-11-24T09:41:04+00:00] INFO: Processing log[IP Address: 172.16.72.138] action write (@recipe_files::/home/vagrant/node/info.rb line 1)\n[2019-11-24T09:41:04+00:00] INFO: IP Address: 172.16.72.138\n\n\n  * log[MAC Address: 00:0C:29:71:DE:FB] action write[2019-11-24T09:41:04+00:00] INFO: Processing log[MAC Address: 00:0C:29:71:DE:FB] action write (@recipe_files::/home/vagrant/node/info.rb line 2)\n[2019-11-24T09:41:04+00:00] INFO: MAC Address: 00:0C:29:71:DE:FB\n\n\n  * log[OS Platform: centos 6.5] action write[2019-11-24T09:41:04+00:00] INFO: Processing log[OS Platform: centos 6.5] action write (@recipe_files::/home/vagrant/node/info.rb line 3)\n[2019-11-24T09:41:04+00:00] INFO: OS Platform: centos 6.5\n\n\n  * log[Running on a  ] action write[2019-11-24T09:41:04+00:00] INFO: Processing log[Running on a  ] action write (@recipe_files::/home/vagrant/node/info.rb line 4)\n[2019-11-24T09:41:04+00:00] INFO: Running on a  \n\n\n  * log[Hostname: default-centos65] action write[2019-11-24T09:41:04+00:00] INFO: Processing log[Hostname: default-centos65] action write (@recipe_files::/home/vagrant/node/info.rb line 5)\n[2019-11-24T09:41:04+00:00] INFO: Hostname: default-centos65\n\n\n[2019-11-24T09:41:04+00:00] INFO: Chef Infra Client Run complete in 0.040802177 seconds\n\nRunning handlers:\n[2019-11-24T09:41:04+00:00] INFO: Running report handlers\nRunning handlers complete\n[2019-11-24T09:41:04+00:00] INFO: Report handlers complete\nChef Infra Client finished, 5/5 resources updated in 01 seconds\n</code></pre> <pre><code>$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <pre><code>$ kitchen destroy default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m19.61s).\n-----&gt; Kitchen is finished. (0m20.10s)\n</code></pre>"},{"location":"chap1/chef_tutorial5/#8","title":"8\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>\u4ec0\u4e48\u662f\u8282\u70b9</li> <li>\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u521b\u5efa\u6c99\u76d2\u73af\u5883 </li> <li>\u7528<code>Test Kitchen</code>\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef </li> <li>\u7b2c\u4e00\u6b21\u8fd0\u884c<code>Chef</code>\u5ba2\u6237\u7aef </li> <li><code>Chef</code>\u5ba2\u6237\u7aef\u7684\u4e09\u79cd\u6a21\u5f0f</li> <li>\u547d\u4ee4\u884c\u5de5\u5177<code>Ohai</code> </li> <li>\u8bbf\u95ee\u8282\u70b9\u4fe1\u606f </li> </ul> <pre><code>$ chef-client --local-mode hello.rb\n$ chef-client --local-mode hello.rb --log_level info\n$ ohai | more\n$ chef-client --local-mode info.rb --log_level info\n</code></pre>"},{"location":"chap1/chef_tutorial6/","title":"\u7b2c\u516d\u8282 \u64b0\u5199\u548c\u4f7f\u7528\u83dc\u8c31","text":"<ul> <li>\u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f</li> <li>\u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f\uff08\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\uff09</li> <li><code>Cookbook_file</code>\u8d44\u6e90\u7b80\u4ecb </li> <li>\u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f\uff08<code>Chef</code>\u5ba2\u6237\u7aef)</li> <li>\u7b2c\u4e00\u6b21\u8fd0\u884c<code>Chef</code></li> <li>\u5256\u6790<code>Chef</code>\u8fd0\u884c </li> <li>\u83dc\u8c31\u67b6\u6784</li> <li>The Four Resources You Need to Know</li> <li>Apache\u83dc\u8c31\uff1a\u624b\u628a\u624b\u6559\u4f60\u521b\u5efa\u83dc\u8c31<ul> <li>\u751f\u6210\u83dc\u8c31\u7ed3\u6784</li> <li>\u7f16\u8f91<code>README.md</code>\u6587\u4ef6 </li> <li>\u66f4\u65b0<code>metadata.rb</code></li> <li><code>Package</code>\u8d44\u6e90\u7b80\u4ecb</li> <li><code>Service</code>\u8d44\u6e90\u7b80\u4ecb</li> <li><code>Template</code>\u8d44\u6e90\u7b80\u4ecb </li> <li>\u9a8c\u8bc1\u8fbe\u5230\u6210\u529f\u6807\u51c6 </li> </ul> </li> <li>\u5c0f\u7ed3 </li> </ul> <p>\u201c\u83dc\u8c31\u201d(<code>Cookbook</code>)\u662f\u4f7f\u7528<code>chef</code>\u8fdb\u884c\u57fa\u7840\u67b6\u6784\u7ba1\u7406\u7684\u57fa\u7840\u7ec4\u4ef6\uff1b</p> <p>\u53ef\u4ee5\u5c06\u5176\u60f3\u8c61\u4e3a\u4e9b\u914d\u65b9\u5355\u7684\u96c6\u5408\u3002\u6bcf\u4e2a\u83dc\u8c31\u8868\u793a\u914d\u7f6e\u4e2a\u5355\u4f4d\u7684\u57fa\u7840\u67b6\u6784\uff08\u6bd4\u5982\u7f51\u670d\u52a1\u5668\uff0c\u6570\u636e\u5e93\u6216\u5e94\u7528\u7a0b\u5e8f\uff09\u6240\u9700\u7684\u6307\u4ee4\u96c6\u5408\u3002</p> <p>\u914d\u65b9\u5355\u5219\u662f\u6574\u4e2a\u4e2a\u8fc7\u7a0b\u4e2d\u5305\u542b\u4ee3\u7801\u7684\u5c0f\u90e8\u5206\uff0c\u83dc\u8c31\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u914d\u65b9\u5355\uff0c \u4e5f\u5305\u542b\u5176\u4ed6\u7528\u6765\u652f\u6301\u914d\u65b9\u5355\u8fd0\u884c\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982\u5b58\u6863\u56fe\u50cf\u6216\u7a0b\u5e8f\u5e93\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u83dc\u8c31\u4e2d\u5b58\u6709\u914d\u7f6e\u4fe1\u606f\u9488\u5bf9\u5e73\u53f0\u7684\u5b9e\u73b0\u4ee5\u53ca\u9700\u8981\u7528<code>Chef</code>\u9700\u8981\u7ba1\u7406\u7840\u67b6\u6784\u7684\u8d44\u6e90\u7684\u58f0\u660e </p>"},{"location":"chap1/chef_tutorial6/#1","title":"1\u3001\u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f","text":"<p>\u4f5c\u4e3a\u4f60\u7684\u7b2c\u4e00\u4e2a\u83dc\u8c31\u8ba9\u627e\u4eec\u8bd5\u8bd5\u5185\u6211\u4eec\u7684<code>CentOS 6</code>\u865a\u62df\u8282\u70b9\u4e0a\u81ea\u52a8\u5316\u6bcf\u65e5\u6d88\u606f  (<code>motd</code>)\u914d\u7f6e\uff0c\u8ba9\u6211\u4eec\u7528<code>Chef</code>\u914d\u7f6e\u5b83\u5728\u767b\u5f55\u65f6\u5019\u663e\u793a\u4e00\u6761\u6d88\u606f\u8bf4\u660e\u8fbe\u662f\u8651\u62df\u673a\u8282\u70b9 </p> <p>\u53d6\u51b3\u4e8e\u4f60\u4f7f\u7528\u7684\u662f<code>chef</code>\u5f00\u53d1\u5305\u8fd8\u662f<code>chef</code>\u5ba2\u6237\u7aef, \u7528\u6765\u751f\u6210\u521d\u59cb\u7684\u83dc\u8bed\u76ee\u5f55\u7ed3\u6784\u7684\u547d\u4ee4\u6709\u6240\u4e0d\u540c</p>"},{"location":"chap1/chef_tutorial6/#1-1-chef-generate-vs-knife","title":"1-1 Chef generate V.S. knife","text":"<p>\u73b0\u5728\uff0c\u6709\u4e86<code>Chef</code>\u5f00\u53d1\u5305\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528<code>chef generate</code>\u547d\u4ee4\u6765\u7ba1\u7406\u83dc\u8bed\u7684\u76ee\u5f55\u7ed3\u6784\u3002<code>knife</code>\u5de5\u5177\u4e0d\u4f1a\u6d88\u5931\u5b83\u5c06\u7ee7\u7eed\u6210\u4e3a\u5728\u751f\u4ea7\u73af\u5883\u4e0b\u548c<code>Chef</code>\u670d\u52a1\u5668\u4ea4\u6d41\u7684\u4e3b\u8981\u547d\u884c\u5de5\u5177\u3002</p> <p>\u7136\u800c\uff0c<code>chef generate</code>\u547d\u4ee4\u62e5\u6709\u4e00\u4e9b<code>knife</code>\u6ca1\u6709\u7684\u529f\u80fd\u3002</p> <ul> <li><code>chef generate</code>\u5141\u8bb8\u4f60\u81ea\u5b9a\u4e49\u751f\u6210\u7684\u914d\u65b9\u5355\u548c\u83dc\u8c31\u6a21\u677f\u3002</li> <li>\u540c\u65f6<code>chef generate</code>\u5141\u8bb8\u4f60\u9010\u6b65\u521b\u5efa\u76ee\u5f55\u7ed3\u6784, \u6bcf\u6b21\u53ea\u6dfb\u52a0\u4f60\u6240\u96f3\u8981\u7684\u7ec4\u4ef6\u3002</li> <li><code>knife</code>\u5219\u53ea\u80fd\u4e00\u6b21\u6027\u751f\u6210\u5305\u542b\u6240\u6709\u7ec4\u4ef6\u7684\u76ee\u5f55\u7ed3\u6784 </li> </ul> <p>\u53ef\u80fd\u5305\u542b\u8bb8\u591a\u4f60\u4e0d\u9700\u8981\u7684\u6587\u4ef6\uff0c\u8fd9\u5e76\u4e0d\u4f1a\u5f71\u54cd\u4ec0\u4e48\uff0c\u4f46\u8bb8\u591a\u4eba\u559c\u6b22 <code>chef generate</code>\u7684\u9010\u6b65\u751f\u6210\u529f\u80fd</p>"},{"location":"chap1/chef_tutorial6/#1-2-chef","title":"1-2 \u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f\uff08\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\uff09","text":"<p>\u4f60\u5c06\u4f7f\u7528\u4e00\u4e2a\u53eb<code>chef</code>\u7684\u5de5\u5177\u6765\u751f\u6210<code>motd</code>(\u6bcf\u65e5\u6d88\u606f)\u83dc\u8c31\u7684\u521d\u59cb\u76ee\u5f55\u7ed3\u6784\u3002</p> <p><code>chef</code>\u662f\u4e00\u4e2a\u548c<code>Chef</code>\u5f00\u53d1\u5305\u4e00\u540c\u53d1\u5e03\u7684\u65b0\u5de5\u5177\u3002\u5728\u547d\u4ee4\u884c\u8fd0\u884c<code>chef generate cookbook motd</code>\u547d\u4ee4\u53ef\u4ee5\u521b\u5efa\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\u3002<code>chef generate</code>\u5c06\u521b\u5efa\u79f0\u4e3a<code>motd</code>\u7684\u83dc\u8c31\u4e3b\u76ee\u5f55\uff1a</p> <pre><code>cd chap07\n\n$ chef generate cookbook motd\n+---------------------------------------------+\n            Chef License Acceptance\n\nBefore you can continue, 1 product license\nmust be accepted. View the license at\nhttps://www.chef.io/end-user-license-agreement/\n\nLicense that need accepting:\n  * Chef Development Kit\n\nDo you accept the 1 product license (yes/no)?\n\n&gt; yes\n\nPersisting 1 product license...\n\u2714 1 product license persisted.\n\n+---------------------------------------------+\nGenerating cookbook motd\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd motd` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <pre><code>cd motd\n\nchap07/motd/kitchen.yml\n\n---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[motd::default]\n    attributes:\n</code></pre> <p>\u8fd0\u884c<code>kitches list</code>\u4ee5\u786e\u4fdd\u4f60\u7684<code>kitchen.yml</code>\u6587\u4ef6\u6ca1\u6709\u8bed\u6cd5\u9519\u8bef\u3002\u5982\u679c\u547d\u4ee4\u8fd4\u56de\u9519\u8bef\u800c\u975e\u4ee5 \u4e0b\u8f93\u51fa\u7ed3\u679c\uff0c\u5c31\u8bf4\u660e\u6587\u4ef6\u4e2d\u5f88\u53ef\u80fd\u6709\u9519\u522b\u5b57\u4e4b\u7c7b\u7684\u9519\u8bef\uff08\u662f\u4f7f\u7528\u5236\u8868\u952e\u4ee3\u66ff\u7a7a\u683c\u8fd8\u662f\u6ca1\u6709\u7f29\u8fdb\u6b63\u786e\u7684\u7a7a\u683c\u6570\uff1f) </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre> <p>\u5728<code>CentOS</code>\u4e2d\uff0c\u8981\u66f4\u65b0\u6bcf\u65e5\u6d88\u606f\u6211\u4eec\u9700\u8981\u5728\u8282\u70b9\u4e0a\u521b\u5efa\u4e00\u4e2a\u53eb<code>etc/motd</code>\u7684\u6587\u4ef6\u3002</p> <p><code>etc/motd</code>\u6587\u4ef6\u5c06\u5305\u542b\u6bcf\u6d88\u606f\u7684\u6587\u672c\u3002\u6211\u4eec\u4f1a\u5728\u83dc\u8c31\u4e2d\u521b\u5efa<code>motd</code>\u6587\u4ef6\u7684\u526f\u672c, \u8fd9\u662f<code>Chef</code>\u7ba1\u7406\u6587\u4ef6\u7684\u65b9\u6cd5\u3002\u7136\u540e\u6211\u4eec\u5728\u914d\u65b9\u5355\u4e2d\u6dfb\u52a0\u4ee3\u7801\u6765\u4f7f\u83dc\u8c31\u4e2d\u7684\u6587\u4ef6\u88ab\u590d\u5236\u5230\u76f8\u5e94\u8282\u70b9\u7684\u6b63\u786e\u4f4d\u7f6e (<code>/etc</code>\u76ee\u5f55\uff09\u4e2d </p> <p>\u4f7f\u7528<code>chef generate file motd</code>\u547d\u4ee4\u5728\u83dc\u8c31\u4e2d\u751f\u6210<code>motd</code>\u6587\u4ef6\u6240\u9700\u7684\u76ee\u5f55\u7ed3\u6784\u3002\u6211\u4eec\u53ea\u9700\u8981\u6587\u4ef6\u540d\uff0c\u800c\u4e0d\u662f\u8def\u5f84</p> <pre><code>$ chef generate file motd\nRecipe: code_generator::cookbook_file\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/files] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/files\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/files/motd] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/files/motd\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/files/motd from none to e3b0c4\n    (diff output suppressed by config)\n</code></pre> <pre><code>$ tree files\nfiles\n\u2514\u2500\u2500 motd\n\n0 directories, 1 file\n</code></pre> <p><code>files/motd</code></p> <pre><code>  _________________________________________________\n  &lt; YOU ARE ON A SIMULATED CHEF NODE ENVIRONMENT! &gt;\n   -----------------------------------------------\n          \\   ^__^\n           \\  (oo)\\_______\n              (__))\\/\\    \\\n                  ||----w |\n                  ||     ||\n\n</code></pre>"},{"location":"chap1/chef_tutorial6/#1-3-cookbook_file","title":"1-3 <code>Cookbook_file</code>\u8d44\u6e90\u7b80\u4ecb","text":"<p>\u6211\u4eec\u8981\u7528<code>Chef</code>\u6765\u5e2e\u52a9\u6211\u4eec\u81ea\u52a8\u5316<code>Linux</code>\u7684\u6bcf\u65e5\u6d88\u606f(<code>motd</code>)\u3002\u5728<code>Linux</code>\u4e0a\uff0c\u5f53\u7528\u6237\u767b\u5f55\u5230 \u7cfb\u7edf\u65f6\u6bcf\u65e5\u6d88\u606f\u5c06\u5728\u547d\u4ee4\u884c\u4e2d\u663e\u793a\u3002\u6bcf\u65e5\u6d88\u606f\u662f<code>Linux</code>\u7cfb\u7edf\u7ba1\u7406\u5458\u548c\u7528\u6237\u6c9f\u901a\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539<code>/etc/motd</code>\u6765\u66f4\u65b0\u6d88\u606f\u3002\u5f53\u7528\u6237\u6210\u529f\u767b\u5f55<code>/etc/motd</code>\u6587\u4ef6\u7684\u5185\u5bb9\u5c06\u4f5c\u4e3a\u5f53\u5929\u7684\u6d88\u606f\u3001\u663e\u793a\u51fa\u6765\u3002</p> <p><code>chef cookbook generate</code>\u547d\u4ee4\u521b\u5efa\u4e86<code>recipes/default.rb</code>\u6587\u4ef6\u3002\u6839\u636e\u7ea6\u5b9a\uff0c\u8fd9\u662f\u4f60\u7684<code>Chef</code>\u4ee3\u7801\u7684\u9ed8\u8ba4\u4f4d\u7f6e\u3002</p> <p>\u6240\u6709\u5305\u542b<code>Chef</code>\u4ee3\u7801\u7684\u914d\u65b9\u5355\u7684<code>.rb</code>\u6587\u4ef6\u90fd\u5e94\u4f4d\u4e8e\u83dc\u8c31\u7684<code>recipes/</code>\u5b50\u76ee\u5f55\u4e2d\u3002 </p> <p>\u73b0\u5728\uff0c<code>recipes/default.rb</code>\u53ea\u5305\u542b\u4e00\u4e9b\u6ce8\u91ca\uff0c\u9664\u6b64\u4ee5\u5916\u57fa\u672c\u662f\u7a7a\u7684\uff1a </p> <pre><code>#\n# Cookbook:: motd\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n#\n#\n#\n</code></pre> <p>\u7f16\u8f91<code>recipes/default.rb</code>\u6587\u4ef6\uff0c\u4f7f<code>Chef</code>\u5728\u8282\u70b9\u4e0a\u66f4\u65b0<code>/etc/motd</code></p> <pre><code>#\n# Cookbook:: motd\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n#\n#\n#\n\ncookbook_file \"/etc/motd\" do\n  source \"motd\"\n  mode \"0644\"\nend\n</code></pre> <p><code>cookbook file</code>\u662f\u4e00\u4e2a<code>Chef</code>\u8d44\u6e90\u3002<code>cookbook file</code>\u8d44\u6e90\u7528\u6765\u5c06\u83dc\u8c31\u4e2d<code>files/</code>\u5b50\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u4f20\u8f93\u5230<code>Chef</code>\u7ba1\u7406\u7684\u8282\u70b9\u4e2d</p> <p><code>source</code>\u5b9a\u4e49\u6b64\u83dc\u8c31\u4e2d<code>files\uff0f</code>\u5b50\u76ee\u5f55\u4e2d\u6e90\u6587\u4ef6\u7684\u540d\u5b57</p>"},{"location":"chap1/chef_tutorial6/#1-4-chef","title":"1-4 \u7b2c\u4e00\u4e2a\u83dc\u8c31\uff1a\u6bcf\u65e5\u6d88\u606f\uff08<code>Chef</code>\u5ba2\u6237\u7aef\uff09","text":"<p>\u4f60\u5c06\u4f7f\u7528<code>knife</code>\u5de5\u5177\u6765\u751f\u6210<code>motd</code>\uff08\u6bcf\u65e5\u6d88\u606f\uff09\u83dc\u8c31\u7684\u521d\u59cb\u76ee\u5f55\u7ed3\u6784\u3002</p> <p><code>knife</code>\u662f<code>Chef</code>\u7684\u4e00\u4e2a\u57fa\u672c\u5de5\u5177\uff0c\u968f<code>Chef</code>\u5ba2\u6237\u7aef\u5b89\u88c5\u3002</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\uff0c\u8fd0\u884c<code>knife cookbook create</code>\u547d\u4ee4\u53ef\u4ee5\u521b\u5efa\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\u3002<code>knife</code>\u5c06\u521b\u5efa<code>motd</code>\u83dc\u8c31\u7684\u4e3b\u76ee\u5f55\uff1a </p> <pre><code>$ cd motd\n$ knife cookbook create motd --cookbook-path .\nWARNING: No knife configuration file found\n** Creating cookbook motd\n** Creating README for cookbook: motd\n** Creating CHANGELOG for cookbook: motd\n** Creating metadata for cookbook: motd\n</code></pre> <pre><code>$ cd motd\n$ kitchen init --create-gemfile\n      create  .kitchen.yml\n      create  test/integration/default\n      create  Gemfile\n      append  Gemfile\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n</code></pre> <p>\u8fd0\u884c<code>bundle install</code>\u5b89\u88c5<code>Test Kitchen</code>\u6240\u4f9d\u8d56\u7684<code>Ruby</code>\u7a0b\u5e8f\uff1a </p> <pre><code>$ bundle install\nFetching gem metadata from https://rubygems.org/..........\nResolving dependencies...\nUsing mixlib-shellout (1.4.0)\nUsing net-ssh (2.9.1)\nUsing net-scp (1.2.1)\nUsing safe_yaml (1.0.3)\nUsing thor (0.19.1)\nUsing test-kitchen (1.2.1)\nInstalling kitchen-vagrant (0.15.0)\nUsing bundler (1.5.3)\nYour bundle is complete!\nUse `bundle show [gemname]` to see where a bundled gem is installed.\n</code></pre> <pre><code>cd motd\n\nchap07/motd/kitchen.yml\n\n---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[motd::default]\n    attributes:\n</code></pre> <p>\u8fd0\u884c<code>kitches list</code>\u4ee5\u786e\u4fdd\u4f60\u7684<code>kitchen.yml</code>\u6587\u4ef6\u6ca1\u6709\u8bed\u6cd5\u9519\u8bef\u3002\u5982\u679c\u547d\u4ee4\u8fd4\u56de\u9519\u8bef\u800c\u975e\u4ee5 \u4e0b\u8f93\u51fa\u7ed3\u679c\uff0c\u5c31\u8bf4\u660e\u6587\u4ef6\u4e2d\u5f88\u53ef\u80fd\u6709\u9519\u522b\u5b57\u4e4b\u7c7b\u7684\u9519\u8bef\uff08\u662f\u4f7f\u7528\u5236\u8868\u952e\u4ee3\u66ff\u7a7a\u683c\u8fd8\u662f\u6ca1\u6709\u7f29\u8fdb\u6b63\u786e\u7684\u7a7a\u683c\u6570\uff1f) </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre> <p><code>knife/motd/files/default/motd</code></p> <pre><code> _________________________________________________\n  &lt; YOU ARE ON A SIMULATED CHEF NODE ENVIRONMENT! &gt;\n   -----------------------------------------------\n          \\   ^__^\n           \\  (oo)\\_______\n              (__))\\/\\    \\\n                  ||----w |\n                  ||     ||\n</code></pre>"},{"location":"chap1/chef_tutorial6/#1-5-cookbook_file","title":"1-5 <code>Cookbook_file</code>\u8d44\u6e90\u7b80\u4ecb","text":"<p>\u6211\u4eec\u8981\u7528<code>Chef</code>\u6765\u5e2e\u52a9\u81ea\u52a8\u5316<code>Linux</code>\u7684\u6bcf\u65e5\u6d88\u606f(<code>motd</code>)\u3002\u5728<code>Linux</code>\u4e0a\uff0c\u5f53\u7528\u6237\u767b\u5f55\u5230\u7cfb\u7edf \u65f6\u6bcf\u65e5\u6d88\u606f\u5c06\u5728\u547d\u4ee4\u884c\u4e2d\u663e\u793a\u3002</p> <p>\u6bcf\u65e5\u6d88\u606f\u662f<code>Linux</code>\u7cfb\u7edf\u7ba1\u7406\u5458\u548c\u7528\u6237\u6c9f\u901a\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539<code>/etc/mothd</code>\u6765\u66f4\u65b0\u6d88\u606f\u3002</p> <p>\u5f53\u7528\u6237\u6210\u529f\u767b\u5f55\u65f6\uff0c<code>/etc/motd</code>\u6587\u4ef6\u7684\u5185\u5bb9\u4f1a\u4f5c\u4e3a\u5f53\u5929\u7684\u6d88\u606f\u663e\u793a\u51fa\u6765 <code>knife cookbook create</code>\u547d\u4ee4\u521b\u5efa\u4e86<code>recipe/default.rb</code>\u6587\u4ef6\u3002</p> <p>\u6839\u636e\u7ea6\u5b9a\uff0c\u8fd9\u662f\u4f60\u7684<code>Chef</code>\u4ee3\u7801\u7684\u9ed8\u8ba4\u4f4d\u7f6e\u3002\u6240\u6709\u5305\u542b<code>Chef</code>\u4ee3\u7801\u7684\u914d\u65b9\u5355\u7684<code>rb</code>\u6587\u4ef6\u90fd\u5e94\u4f4d\u4e8e\u83dc\u8c31\u7684<code>recipe/</code>\u5b50\u76ee\u5f55\u4e2d.</p> <p>\u73b0\u5728<code>recipe/default.rb</code>\u53ea\u5305\u542b\u4e00\u4e9b\u6ce8\u91ca, \u9664\u6b64\u4ee5\u5916\u57fa\u672c\u662f\u7a7a\u7684</p> <pre><code>#\n# Cookbook:: motd\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n#\n</code></pre> <p><code>cookbook file</code>\u662f\u4e00\u4e2a<code>Chef</code>\u8d44\u6e90\u3002<code>cookbook file</code>\u8d44\u6e90\u7528\u6765\u5c06\u83dc\u8c31\u4e2d<code>files/</code>\u5b50\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u4f20\u8f93\u5230<code>Chef</code>\u7ba1\u7406\u7684\u8282\u70b9\u4e2d</p> <p><code>source</code>\u5b9a\u4e49\u6b64\u83dc\u8c31\u4e2d<code>files\uff0f</code>\u5b50\u76ee\u5f55\u4e2d\u6e90\u6587\u4ef6\u7684\u540d\u5b57</p> <p>\u65e0\u8bba\u4f7f\u7528<code>chef generate cookbook</code>\u8fd8\u662f<code>knife cookook create</code>\u521b\u5efa\u83dc\u8c31\uff0c \u6b64\u540e\u7684\u6b65\u9aa4\u90fd\u662f\u76f8\u540c\u7684 </p>"},{"location":"chap1/chef_tutorial6/#2chef","title":"**2\u3001\u7b2c\u4e00\u6b21\u8fd0\u884c<code>Chef</code> **","text":"<p><code>Chef</code>\u7528\u6570\u5b66\u672f\u8bed\"\u6536\u655b\"(converge)\u6765\u8868\u793a\u901a\u8fc7\u8fd0\u884c<code>chef_client</code>\u628a\u83dc\u8c31\u90e8\u7f72\u5230\u8282\u70b9\u5e76\u901a\u8fc7\u6267\u884c\u4e00\u4e2a\u8fd0\u884c\u6e05\u5355\u6765\u5c06\u8282\u70b9\u8f6c\u5316\u6210\u7406\u60f3\u7684\u72b6\u6001\u7684\u8fc7\u7a0b.</p> <p>\u8fd9\u7ecf\u5e38\u79f0\u4e3a\"\u6536\u655b\u201c\u4e00\u4e2a\u8282\u70b9\u3002\u7528<code>\u201cTest Kitchen\u201d</code>\u5728\u8282\u70b9\u4e0a\u7528<code>kitchen converge</code>\u547d\u4ee4\u6267\u884c\u4e00\u6b21\u8fd0\u884c\uff0e </p>"},{"location":"chap1/chef_tutorial6/#2-1","title":"2-1 \u6536\u655b\u7b80\u4ecb","text":"<p><code>Chef</code>\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\u5982\u4f55\u5c06\u4e00\u4e2a\u8282\u70b9\u8f6c\u6362\u6210\u7406\u60f3\u72b6\u6001\u9700\u8981\u505a\u7684\u4e8b\u60c5\u3002</p> <p>\u6bd4\u5982\uff0c \u5982\u679c\u4e00\u6b21<code>Chef</code>\u8fd0\u884c\u67d0\u79cd\u539f\u56e0\uff0c\u4e2d\u9014\u88ab\u53d6\u6d88\uff0c \u4e0b\u6b21\u5b83\u4f1a\u81ea\u529d\u4ece\u6ca1\u5b8c\u6210\u7684\u5730\u4e07\u5f00\u59cb\u7ee7\u7eed\u8fd0\u884c\uff0c \u8fd9\u79cd\u5bb9\u9519\u65b9\u6cd5\u7684\u5173\u5065\u662f<code>Chef</code>\u7528\u6765\u914d\u7f6e\u8282\u70b9\u6240\u4f7f\u7528\u7684\u8ba1\u5212\u5b8c\u5168\u4ee5\u6570\u636e\u9a71\u52a8\uff0c \u53d6\u51b3\u4e8e<code>ohai</code>\u8fd0\u884c\u540e\u8fd4\u56de\u7684\u7ed3\u679c\u3002</p> <p>\u53e6\u4e00\u4e2a\u57fa\u4e8e\u6536\u6548\u7684\u5de5\u5177\u7684\u4f8b\u5b50\u662f<code>make</code>\u547d\u4ee4\u3002\u5b83\u4ee5\u7c7b\u4f3c\u7684\u65b9\u5f0f\u8fd0\u884c\u3002<code>make</code>\u5de5\u5177\u68c0\u67e5\u7528\u4e8e\u751f\u6210\u5e94\u7528\u7a0b\u5e8f\u7684\u7ec4\u4ef6\u7684\u72b6\u6001\u7136\u540e\u53ea\u751f\u6210\u672a\u5b8c\u6210\u7684\u90e8\u5206\u3002\u53ef\u4ee5\u65e0\u6570\u6b21\u8fd0\u884c<code>make</code>\u4f46\u5b83\u53ea\u505a\u5b83\u9700\u8981\u505a\u7684\u5c1a\u672a\u5b8c\u6210\u7684\u90e8\u5206</p> <pre><code>$ cd motd\n$ kitchen converge default-centos65\n\n kitchen converge default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n&gt;&gt;&gt;&gt;&gt;&gt; ------Exception-------\n&gt;&gt;&gt;&gt;&gt;&gt; Class: Kitchen::ActionFailed\n&gt;&gt;&gt;&gt;&gt;&gt; Message: 1 actions failed.\n&gt;&gt;&gt;&gt;&gt;&gt;     Failed to complete #converge action: [policyfile detected, but provisioner Kitchen::Provisioner::ChefSolo doesn't support Policyfiles. Either use a different provisioner, or delete/rename /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/Policyfile.rb.] on default-centos65\n&gt;&gt;&gt;&gt;&gt;&gt; ----------------------\n&gt;&gt;&gt;&gt;&gt;&gt; Please see .kitchen/logs/kitchen.log for more details\n&gt;&gt;&gt;&gt;&gt;&gt; Also try running `kitchen diagnose --all` for configuration\n</code></pre> <p>\u4fee\u6539<code>kitchen.yml</code></p> <pre><code>...\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n...\n</code></pre> <pre><code>$ kitchen converge default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[motd::default]\"]\n       Policy lock file doesn't exist, running `chef install` for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/Policyf\nile.rb...\n       Building policy motd\n       Expanded run list: recipe[motd::default]\n       Caching Cookbooks...\n       Installing motd &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/motd/Policyfile.lock.json\n       Policy revision id: 1be1d358a9f055ff7c7ad9c39551cd0731acf63e2ef470dd6eec4324ae19a384\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191125-92576-\n5amqh5...\n       Exported policy 'motd' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191125-92576-5amqh5\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191125-92576-5amqh5\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       el 6 x86_64\n       Getting information for chef stable  for el...\n       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64\n         to file /tmp/install.sh.3173/metadata.txt\n       trying wget...\n       trying curl...\n       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2\n       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473\n       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n       version  15.5.17\n       downloaded metadata file looks valid...\n       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n         to file /tmp/install.sh.3173/chef-15.5.17-1.el6.x86_64.rpm\n       trying wget...\n       trying curl...\n       Comparing checksum with sha256sum...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3173/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       Using policy 'motd' at revision '1be1d358a9f055ff7c7ad9c39551cd0731acf63e2ef470dd6eec4324ae19a384'\n       resolving cookbooks for run list: [\"motd::default@0.1.0 (eca9650)\"]\n       Synchronizing Cookbooks:\n         - motd (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 1 resources\n       Recipe: motd::default\n         * cookbook_file[/etc/motd] action create\n           - update content in file /etc/motd from a7620c to 07a3b1\n           --- /etc/motd        2014-12-04 21:39:40.303256605 +0000\n           +++ /etc/.chef-motd20191125-3298-14tijbq     2019-11-25 09:40:39.350798262 +0000\n           @@ -1,2 +1,9 @@\n           -Welcome to your Packer-built virtual machine.\n           +  _________________________________________________\n           +  &lt; YOU ARE ON A SIMULATED CHEF NODE ENVIRONMENT! &gt;\n           +   -----------------------------------------------\n           +          \\   ^__^\n           +           \\  (oo)\\_______\n           +              (__))\\/\\    \\\n           +                  ||----w |\n           +                  ||     ||\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/1 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m30.44s).\n-----&gt; Kitchen is finished. (0m30.81s)\n</code></pre> <p>\u8bf4\u660e\uff1a\u5982\u679c\u9700\u8981\uff0c<code>kitchen converge</code>\u4f1a\u81ea\u52a8\u8fd0\u884c<code>kitchen create</code>\u548c<code>kitchen setup</code>\u3002\u5728\u4ee5\u4e0a\u8f93\u51fa\u4e2d\uff0c\u6ce8\u610f\u521b\u5efa\u4e86\u865a\u62df\u673a\uff0c\u7136\u540e<code>chef-client</code>\u5728\u8282\u70b9\u4e0a\u88ab\u5b89\u88c5\u3002\u8fd9\u8868\u793a<code>Test Kitchen</code>\u8fd0\u884c\u4e86\u8fd9\u4e24\u4e2a\u6b65\u9aa4 </p>"},{"location":"chap1/chef_tutorial6/#2-2","title":"**2-2 \u9a8c\u8bc1\u7ed3\u679c **","text":"<p>\u4f7f\u7528<code>kitchen login</code>\u6765\u9a8c\u8bc1\u65b0\u6bcf\u65e5\u6d88\u606f\u88ab\u5b89\u88c5\u5230\u8282\u70b9\u4e0a </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action  Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        Converged    &lt;None&gt;\n</code></pre> <pre><code>$ kitchen login default-centos65\nLast login: Mon Nov 25 09:40:36 2019 from 172.16.72.2\n  _________________________________________________\n  &lt; YOU ARE ON A SIMULATED CHEF NODE ENVIRONMENT! &gt;\n   -----------------------------------------------\n          \\   ^__^\n           \\  (oo)\\_______\n              (__))\\/\\    \\\n                  ||----w |\n                  ||     ||\n[vagrant@default-centos65 ~]$ \n</code></pre> <pre><code>[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <pre><code>$ kitchen destroy default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m18.75s).\n-----&gt; Kitchen is finished. (0m19.17s)\n</code></pre>"},{"location":"chap1/chef_tutorial6/#3chef","title":"3\u3001\u5256\u6790Chef\u8fd0\u884c","text":"<p><code>kitchen converge</code>\u4ece\u5bbf\u4e3b\u673a\u5668\u547d\u4ee4\u6d4b\u8bd5\u8282\u70b9\u6267\u884c\u4e00\u6b21<code>chef</code>\u8fd0\u884c\u770b\u8d77\u5f88\u65b9\u4fbf! \u4f60\u53ef\u4ee5\u4f7f\u7528<code>kitche login</code>\u767b\u5f55\u5230\u4fa7\u8bd5\u8282\u70b9\u7136\u540e\u770b\u770b\u5404\u79cd\u547d\u4ee4\uff0c \u4f46<code>kitchen converge</code> \u88ab\u8bbe\u8ba1\u4e3a\u5728\u5f00\u53d1\u83dc\u8c31\u65f6\u5feb\u901f\u7ed9\u51fa\u7684\u53cd\u9988</p> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d<code>chef-client</code>\u901a\u5e38\u4ef6\u4e3a\u670d\u52a1\u5728\u80cc\u540e\u6301\u7eed\u5b9a\u671f\u8fd0\u884c\uff0c \u6bd4\u598215\u5206\u949f\u6267\u884c\u4e00\u6b21<code>chef</code>\u968f\u884c\uff0e\u5b83\u67e5\u770b\u670d\u52a1\u5668\u4e0a\u6709\u6ca1\u6709\u4efb\u4f55\u83dc\u8c31\u7684\u6539\u53d8\u6216\u65b0\u7684\u8fd0\u884c\u6e05\u5355\u3002</p> <p>1. \u5f00\u59cb\u8fd0\u884c<code>Chef</code>\u5ba2\u6237\u7aef </p> <p><code>chef-client</code> \u8fdb\u7a0b\u5728\u8fdc\u7a0b\u8282\u70b9\u542f\u52a8\u3002 \u8fdb\u7a0b\u53ef\u80fd\u7531\u4e00\u4e2a\u670d\u52a1\uff0c <code>cron</code>\u4efb\u52a1\u6216\u67d0\u7528\u6237\u624b\u52a8\u542f \u52a8\u3002<code>chef-client</code>\u8fdb\u7a0b\u8d1f\u8d23\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u8fd0\u884c\u5305\u542b<code>Chef</code>\u4ee3\u7801\u7684\u914d\u65b9\u5355\u7684\u83dc\u8c31 </p> <p>2. \u521b\u5efa\u8282\u70b9</p> <p><code>chef-client</code> \u8fdb\u7a0b\u5728\u5185\u5b58\u4e2d\u6784\u5efa<code>node</code>\uff08\u8282\u70b9\uff09\u5bf9\u8c61\u3002\u5b83\u8fd0\u884c<code>ohai</code>\u5e76\u6536\u96c6\u6240\u6709\u5173\u4e8e\u8fd9\u4e2a \u8282\u70b9\u7684\u81ea\u52a8\u5c5e\u6027\uff08\u6bd4\u5982\u4e3b\u673a\u540d\u3001FQDN\u5e73\u53f0\u3001\u7528\u6237\u7b49\uff09\u3002 </p> <p>3.\u540c\u6b65</p> <p>\u8fd0\u884c\u6e05\u5355\u88ab\u53d1\u9001\u5230\u8282\u70b9\uff0c \u8fd0\u884c\u6e05\u5355\u5305\u542b\u8981\u5728\u76ee\u6807\u8282\u70b9\u6267\u884c\u7684\u914d\u65b9\u5355\u7684\u6e05\u5355\uff0c \u8fd0\u884c\u6e05\u5355\u662f\u4e00\u4e2a\u6709\u5e8f\u7684\u3001\u5b8c\u5168\u5c55\u5f00\u4e14\u8981\u5728\u76ee\u6807\u8282\u70b9\u8fd0\u884c\u7684\u914d\u65b9\u5355\u6e05\u5355. \u8fd0\u884c\u6e05\u5355\u6240\u9700\u7684\u83dc\u8c31\u7684<code>URL</code>\u4e5f\u540c\u6837\u88ab\u4e0b\u8f7d\u5230\u8282\u70b9\u4e0a\u3002 \u76ee\u6807\u8282\u70b9\u5c06\u8fd9\u4e9b\u6240\u9700\u7684\u83dc\u8c31\u4e0b\u8f7d\u4e95\u7f13\u5b58\u5230\u4e00\u4e2a\u672c\u5730\u6587\u4ef6\u5b58\u50a8\u4e2d\u3002 </p> <p>4.\u52a0\u8f7d</p> <p>\u83dc\u8c31\u548c<code>Ruby</code>\u7ec4\u4ef6\u5728\u6b64\u6b65\u9aa4\u88ab\u52a0\u8f7d\u3002\u83dc\u8c31\u7ea7\u522b\u7684\u5c5e\u6027\u5728\u6b64\u4e0e\u7b2c2\u6b65\u4e2d<code>ohai</code>\u751f\u6210\u7684\u81ea\u52a8\u5c5e\u6027\u76f8\u7ed3\u5408\u83dc\u8c31\u7684\u4e0d\u540c\u7ec4\u4ef6\u6309\u4ee5\u4e0b\u987a\u5e8f\u52a0\u8f7d </p> <ul> <li>\u5e93(<code>Libries</code>)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>Libries/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0c \u8fd9\u6837\u8bed\u8a00\u6269\u5c55\u6216\u66f4\u6539\u5c06\u4f1a\u5728\u4f59\u4e0b\u7684<code>Chef</code>\u8fd0\u884c\u6b65\u9aa4\u4e2d\u53ef\u7528 </li> <li>\u5c5e\u6027\uff08<code>Attributes</code>)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>attributes/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u4e95\u4e0e<code>ohai</code>\u5c5e\u6027\u7ed3\u5408</li> <li>\u5b9a\u4e49(<code>Definitions</code>)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>definitions/</code>\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u3002\u8fd9\u4e9b\u6587\u4ef6\u5b9a\u4e49\u5728\u914d\u65b9\u5355\u4e2d\u7528\u5230\u7684\u7c7b\u4f3c\u8d44\u6e90\u7684\u53ef\u91cd\u7528\u4ee3\u7801, \u56e0\u6b64\u5fc5\u987b\u5728\u52a0\u8f7d\u914d\u65b9\u5355\u524d\u52a0\u8f7d.</li> <li>\u8d44\u6e90(<code>Resource</code>) \u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d(<code>resources/</code>)\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u3002\u8d44\u6e90\u5fc5\u987b\u5728\u914d\u65b9\u5355\u4e4b\u524d\u52a0\u8f7d\u56e0\u4e3a\u914d\u65b9\u5355\u4f1a\u4f7f\u7528\u8d44\u6e90\u4ee3\u7801</li> <li>\u63d0\u4f9b\u8005(<code>Providers</code>)\u52a0\u8f7d\u6bcf\u4e2a\u83dc\u8c31\u4e2d(<code>providers/</code>)\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0c\u4ee5\u4fbf\u8d44\u6e90\u5f15\u7528\u5408\u9002\u7684\u63d0\u4f9b\u8005\u3002 </li> <li>\u914d\u65b9\u5355\uff08<code>Recipes</code>)\u52a0\u8f7d\u6267\u884c\u6bcf\u4e2a\u83dc\u8c31\u4e2d<code>recipes/</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0e\u5728\u8fd9\u4e2a\u9636\u6bb5\uff0c \u914d\u65b9\u5355\u4e95\u672a\u88ab\u6267\u884c\u6765\u5c06\u8282\u70b9\u8f6c\u6362\u4e3a\u7406\u60f3\u914d\u7f6e\uff0c \u914d\u65b9\u5355\u4e2d<code>Ruby</code>\u4ee3\u7801\u7f16\u8bd1\u4e95\u8f6c\u5316\u6210\u6700\u540e\u5c06\u5728\u8282\u70b9\u4e0a\u6267\u884c\u7684\u914d\u65b9\u5355\uff0c \u6bcf\u4e2a\u8d44\u6e90\u4e5f\u5728\u6b64\u65f6\u88ab\u52a0\u4eba\u5230\u8d44\u6e90\u96c6\u5408\u4e2d.</li> </ul> <p>5\uff0e\u6536\u655b</p> <p>\u6536\u655b\u9636\u6bb5\u5219\u662f\u6bcf\u6b21<code>Chef</code>\u8fd0\u884c\u4e2d\u6700\u91cd\u8981\u7684\u9636\u6bb5\u3002\u5728\u8fd9\u4e2a\u65f6\u5019<code>Chef</code>\u914d\u65b9\u5355\u5728\u76ee\u6807\u8282\u70b9\u6267\u884c\u5e76\u6539\u53d8\u8282\u70b9\u5230\u7406\u60f3\u72b6\u6001\uff0c\u6bd4\u5982\u5b89\u88c5\u5c1a\u672a\u5b89\u88c5\u7684\u7a0b\u5e8f\u5305\u3001\u590d\u5236\u6e32\u67d3\u597d\u7684\u6a21\u677f\u6216\u6587\u4ef6\u5230\u76ee\u6807\u4f4d\u7f6e\u7b49\u7b49\u3002 </p> <p>6\uff0e\u62a5\u544a</p> <p>\u5982\u679c<code>Chef</code>\u5ba2\u6237\u7aef\u8fd0\u884c\u6210\u529f\uff0c\u8282\u70b9\u4f1a\u4fdd\u5b58\u4efb\u4f55\u65b0\u7684\u5c5e\u6027\u503c\uff1b\u5982\u679c\u5931\u8d25\uff0c\u5ba2\u6237\u7aef\u4f1a\u629b\u51fa\u5f02\u5e38\u800c\u8282\u70b9\u5bf9\u8c61\u4e5f\u4e0d\u4f1a\u88ab\u66f4\u65b0\uff0c\u901a\u77e5\u673a\u5236\u548c\u5f02\u5e38\u5904\u7406\u5668\u5c06\u8fd0\u884c\u6765\u901a\u77e5\u5de5\u4f5c\u4eba\u5458\uff0c\u6bd4\u5982\u53d1\u9001<code>email</code>\u3001\u53d1\u5e03\u6d88\u606f\u5230<code>IRC</code>\u6216\u901a\u77e5\u5982<code>PagerDuty</code>\u4e4b\u7c7b\u7684\u503c\u73ed\u7cfb\u7edf\u3002 </p> <p>\u6211\u4eec\u901a\u8fc7\u8fd0\u884c\u6e05\u5355\u6765\u6307\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u9700\u8981\u8fd0\u884c\u7684\u914d\u65b9\u5355\u3002\u914d\u65b9\u5355\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u4ee5\u4ee5\u4e0b\u683c\u5f0f\u6307\u5b9a\uff1a</p> <p><code>recipe['\uff1c\u83dc\u8c31\u540d\u5b57\uff1e::\uff1c\u914d\u65b9\u5355\u540d\u5b57\uff1e']</code>\uff0c</p> <p>\u6bd4\u5982<code>recipe['motd::default']</code>\u3002</p> <p>\u5f53<code>Chef</code>\u4ee3\u7801\u5728\u4e00\u4e2a\u83dc\u8c31\u4e2d\u7684\u9ed8\u8ba4\u914d\u65b9\u5355\u6587\u4ef6<code>recipes/default.rb</code>\u65f6\uff0c\u914d\u65b9\u5355\u7684\u540d\u5b57\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u53ef\u4ee5\u7701\u7565\uff0c<code>Chef</code>\u4f1a\u9ed8\u8ba4\u5728\u83dc\u8c31\u4e2d\u5bfb\u627e<code>default</code>\u914d\u65b9\u5355\u3002\u56e0\u6b64\u6307\u5b9a<code>recipe['motd']</code>\u7b49\u540c\u4e8e<code>recipe['motd::default']</code>\u3002\u6ce8\u610f\uff0c\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u6307\u5b9a\u914d\u65b9\u5355\u65f6\u4e0d\u9700\u8981\u6307\u5b9a<code>.rb</code>\u6269\u5c55\u540d\u3002 </p> <p>\u5728\u4f7f\u7528<code>Test Kitchen</code>\u6d4b\u8bd5\u8fd0\u884c<code>Chef</code>\u65f6\uff0c\u8fd0\u884c\u6e05\u5355\u5728<code>kitchen.yml</code>\u6307\u5b9a\uff0c\u7136\u540e\u901a\u8fc7<code>-o</code>\u53c2\u6570\u5728\u547d\u4ee4\u884c\u4f20\u9012\u7ed9<code>chef-client</code>\u3002</p> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8fd0\u884c\u6e05\u5355\u4f5c\u4e3a\u8282\u70b9\u7684\u5c5e\u6027\u4fdd\u5b58\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u3002 </p> <p>\u6211\u4eec\u521a\u521a\u63cf\u8ff0\u4e86\u5f53\u4f60\u8fd0\u884c<code>kitchen converge</code>\uff08\u6216chef-client\uff09\u65f6<code>Chef</code>\u4e00\u6b21\u8fd0\u884c\u8fc7\u7a0b\u4e2d \u90fd\u505a\u4e86\u4ec0\u4e48\u3002</p> <p></p>"},{"location":"chap1/chef_tutorial6/#4","title":"4\u3001\u83dc\u8c31\u67b6\u6784","text":"<p><code>Chef</code>\u547d\u4ee4\u53ef\u4ee5\u751f\u6210\u521d\u59cb\u76ee\u5f55\u548c\u6587\u4ef6</p> <pre><code>chef generate cookbook\n</code></pre> <pre><code>knife cookbook create\n</code></pre> <p>\u57fa\u672c\u7684\u83dc\u5355\u76ee\u5f55\u5305\u542b\u4ee5\u4e0b\u6587\u4ef6</p> <pre><code>cookbook\n\u251c\u2500\u2500 .kitchen.yml\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 attributes\n\u2502    \u2514\u2500\u2500 default/\n\u251c\u2500\u2500 chefignore\n\u251c\u2500\u2500 files/\n\u2502    \u2514\u2500\u2500 default/\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 recipes/\n\u2502    \u2514\u2500\u2500 default.rb\n\u2514\u2500\u2500 templates/\n    \u2514\u2500\u2500 default/\n</code></pre>"},{"location":"chap1/chef_tutorial6/#4-1-kitchenyml","title":"4-1 <code>\\.kitchen.yml</code>","text":"<p><code>kitchen.yml</code>\u6587\u4ef6\u662f<code>Test Kitchen</code>\u7684<code>YAML</code>\u683c\u5f0f\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u4f60\u53ef\u4ee5\u7528<code>Test Kitchen</code>\u6765\u521b\u5efa\u6c99\u76d2\u6d4b\u8bd5\u73af\u5883\uff0c\u4ee5\u4fbf\u5728\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u9a8c\u8bc1\u4f60\u7684\u83dc\u8c31\u3002 </p>"},{"location":"chap1/chef_tutorial6/#4-2-readmemd","title":"4-2 <code>README.md</code>","text":"<p>\u6bcf\u4e2a\u83dc\u8c31\u90fd\u5e94\u8be5\u9644\u6709\u6587\u6863\u3002<code>README.md</code>\u662f\u4fdd\u5b58\u8fd9\u4e9b\u6587\u6863\u7684<code>markdown</code>\u683c\u5f0f\u7684\u7eaf\u6587\u672c\u6587\u4ef6\u3002<code>Markdown</code>\u662f\u4e00\u4e2a\u7b80\u6613\u7684\u4e3a\u6587\u672c\u6587\u4ef6\u6dfb\u52a0\u683c\u5f0f\u7684\u65b9\u6cd5\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u9009\u62e9\u5c06\u6587\u6863\u8f6c\u6362\u4e3a<code>HTML</code>\u3002\u5bf9\u4e8e\u5b58\u50a8<code>README</code>, <code>Markdown</code>\u662f\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u6587\u4ef6\u683c\u5f0f\uff0c\u5b83\u7684\u53ef\u8bfb\u6027\u975e\u5e38\u5f3a\uff0c\u4f60\u4e0d\u9700\u8981\u5404\u79cd<code>HTML</code>\u6807\u8bb0\u548c\u683c\u5f0f\u6307\u4ee4\u3002\u5f88\u591a\u5e38\u7528\u7684\u7248\u672c\u63a7\u5236\u5de5\u5177\u90fd\u4f1a\u4ee5<code>HTML</code>\u6e32\u67d3<code>README.md</code>\uff0c\u5305\u62ec<code>GitHub</code>\u3001<code>GitLab</code>\u3001<code>Stash</code>\u3001<code>Bitbuckets</code></p>"},{"location":"chap1/chef_tutorial6/#4-3-attributes","title":"4-3 <code>attributes</code>","text":"<p>\u4f60\u53ef\u4ee5\u5728\u83dc\u8c31\u4e2d\u63d0\u4f9b\u81ea\u5b9a\u4e49\u7684\u5c5e\u6bd4\u6765\u8865\u5145\u6216\u641c\u76d6<code>ohai</code>\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u6240\u751f\u6210\u7684\u81ea\u52a8\u5c5e\u6027\u3002\u5c5e\u6027\u7ecf\u5e38\u7528\u6765\u5b9a\u4e49\u5e94\u7528\u7a0b\u5e8f\u5206\u5e03\u8def\u5f84\u3001\u57fa\u4e8e\u7279\u5b9a\u5e73\u53f0\u7684\u503c\u6216\u5728\u67d0\u4e2a\u8282\u70b9\u9700\u8981\u5b89\u88c5\u7684\u8f6f\u4ef6\u7684\u7248\u672c\u7b49\u3002<code>attributes\uff0f</code>\u76ee\u5f55\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u5b9a\u4e49\u5c5e\u80dc\u7684<code>rb</code>\u6587\u4ef6\u3002\u5982\u679c\u5305\u542b\u4e86\u591a\u4e2a\u6587\u4ef6\uff0c\u5b83\u4eec\u4f1a\u6309\u7167\u5b57\u6bcd\u8868\u987a\u5e8f\u6267\u884c\u3002\u5982\u679c\u53ea\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a\u5c5e\u6027\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d<code>default.rb</code>\u6216\u4efb\u4f55\u610f\u4e49\u4e0a\u7b26\u5408\u5176\u7528\u9014\u7684\u6587\u4ef6\u540d </p>"},{"location":"chap1/chef_tutorial6/#4-4-chefignore","title":"4-4 <code>chefignore</code>","text":"<p>\u6b64\u6587\u4ef6\u5305\u542b\u4e00\u4e2a\u88ab<code>Chef</code>\u5ffd\u7565\u7684\u6587\u4ef6\u5217\u8868\u3002\u5f53\u4f7f\u7528<code>Chef</code>\u670d\u52a1\u5668\u5e76\u5c06\u672c\u5730\u83dc\u8c31\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u5217\u8868\u4e2d\u7684\u6587\u4ef6\u5c06\u88ab\u5ffd\u7565\u3002</p> <p>\u9ed8\u8ba4\u968b\u51b5\u4e0b\uff0c\u83dc\u8c31\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u90fd\u4f1a\u4e0a\u4f20\u3002\u7136\u800c\uff0c\u7c7b\u4f3c\u7f16\u8f91\u5668\u6216\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u7684\u4e34\u65f6\u6587\u4ef6\u5219\u6ca1\u5fc5\u8981\u4e0a\u4f20\u5230<code>Chef</code>\u670d\u52a1\u5668\uff0c\u56e0\u6b64\u5c06\u5b83\u4eec\u5217\u5728<code>chefignore</code>\u6587\u4ef6\u4e2d\u5219\u53ef\u907f\u514d\u4e0a\u4f20\u3002 </p>"},{"location":"chap1/chef_tutorial6/#4-5-files","title":"4-5 <code>files</code>","text":"<p><code>files</code>\u6587\u4ef6\u5939\u662f\u6b64\u83dc\u8c31\u4e2d\u96c6\u4e2d\u5b58\u50a8\u5c06\u8981\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u7684\u6587\u4ef6\u7684\u5730\u65b9\u3002\u6587\u4ef6\u53ef\u4ee5\u4e3a\u7eaf\u6587\u672c\u3001\u56fe\u50cf\u3001zip\u6587\u4ef6\u7b49\u3002\u8fd9\u4e9b\u6587\u4ef6\u53ef\u4ee5\u901a\u8fc7<code>cookbook_file</code>\u8d44\u6e90\u88ab\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u3002<code>files\uff0f</code>\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u7ed3\u6784\u63a7\u5236\u662f\u5426\u5c06\u7279\u5b9a\u6587\u4ef6\u5206\u53d1\u5230\u7279\u5b9a\u8282\u70b9\u3002 </p> <p>\u8981\u5206\u53d1\u5230\u6240\u6709\u8282\u70b9\u7684\u6587\u4ef6\u90fd\u4f1a\u653e\u5728<code>files/default/</code>\u5b50\u76ee\u5f55\u5185\u3002 </p>"},{"location":"chap1/chef_tutorial6/#4-6-metadatarb","title":"4-6 <code>metadata.rb</code>","text":"<p><code>metadata.rb</code>\u6587\u4ef6\u5305\u542b\u8be5\u83dc\u8c31\u7684\u6240\u6709\u5143\u6570\u636e\u3002\u6bcf\u4e2a\u83dc\u8c31\u5fc5\u987b\u6709\u4e00\u4e2a\u5143\u6570\u636e\u6587\u4ef6 <code>metadata.rb</code> \u6765\u5305\u542b\u83dc\u8c31\u7684\u540d\u5b57\u3001\u7248\u672c\u3001\u4f9d\u8d56\u4ee5\u53ca\u5176\u4ed6\u4fe1\u606f\u3002</p>"},{"location":"chap1/chef_tutorial6/#4-7-recipes","title":"4-7 <code>recipes</code>","text":"<p><code>recipe</code>\u76ee\u5f55\u5305\u542b<code>Chef</code>\u914d\u65b9\u5355\u3002\u914d\u65b9\u5355\u6587\u4ef6\u5305\u542bChef\u4ee3\u7801\u3002\u6b64\u76ee\u5f55\u4e2d\u5305\u542b\u591a\u4e2a<code>.rb</code>\u914d\u65b9\u5355\u6587\u4ef6\u3002</p> <p>\u6839\u636e\u7ea6\u5b9a\uff0c\u9ed8\u8ba4\u7684\u914d\u65b9\u5355\u6587\u4ef6\u79f0\u4e3a<code>default.rb</code>\u3002\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u8be5\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u6307\u5b9a\u7684\u914d\u65b9\u5355\u3002\u8fd0\u884c\u6e05\u5355\u5b58\u50a8\u5728<code>Chef</code>\u52a1\u5668\u4e2d\uff0c<code>kitchen.yml</code>\u6587\u4ef6\u4e2d\uff08\u6d4b\u8bd5\u73af\u5883\uff09\u6216\u53ef\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9<code>\uff0bchef-clfent\uff0b</code>\u547d\u4ee4\u3002</p>"},{"location":"chap1/chef_tutorial6/#4-8-templates","title":"4-8 <code>templates</code>","text":"<p><code>templates</code>\u76ee\u5f55\u5b58\u50a8<code>Chef</code>\u7684\u6a21\u677f\u3002<code>templates</code>\u76ee\u5f55\u548c<code>files</code>\u76ee\u5f55\u7c7b\u4f3c\u76ee\u7684\u90fd\u662f\u5c06\u6587\u4ef6\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u4e0a\u3002</p> <p>\u7136\u800c\uff0c<code>templates</code>\u4e2d\u7684\u6587\u4ef6\u662f\u5d4c\u5165\u5f0f<code>Ruby</code>\u6a21\u677f\u6587\u4ef6<code>(ERB)</code>\uff0c\u6b64\u7c7b\u6587\u4ef6\u662f\u53ef\u5305\u542b<code>Ruby</code>\u4ee3\u7801\u7684\u7eaf\u6587\u672c\u6587\u4ef6\uff0c\u5728\u590d\u5236\u5230\u76ee\u6807\u8282\u70b9\u4e4b\u524d\uff0c\u6587\u4ef6\u4e2d\u7684<code>Ruby</code>\u4ee3\u7801\u88ab\u6267\u884c\u5e76\u6e32\u67d3\u6210\u76f8\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u3002</p> <p>\u5f53\u4f60\u9700\u8981\u88ab\u5206\u53d1\u5230\u76ee\u6807\u8282\u70b9\u7684\u6587\u4ef6\u4e2d\u5305\u542b\u5728\u4e0d\u540c\u60c5\u51b5\u4e0b\u9700\u8981\u6e32\u67d3\u6210\u4e0d\u540c\u5185\u5bb9\u7684\u60c5\u51b5\u4e0b\uff0c\u4f60\u5219\u53ef\u4ee5\u7528\u6a21\u677f\u6765\u5b8c\u6210\u8fd9\u4efb\u52a1\u3002<code>templates</code>\u76ee\u5f55\u548c<code>files</code>\u76ee\u5f55\u4f7f\u7528\u4e00\u6837\u7684\u5b50\u76ee\u5f55\u547d\u540d\u65b9\u6cd5\u6765\u63a7\u5236\u590d\u5236\u54ea\u4e9b\u6587\u4ef6\u5230\u54ea\u4e9b\u7279\u5b9a\u7684\u8282\u70b9\u3002 </p> <p>\u5bf9\u4e8e\u9ad8\u7ea7\u7528\u6237\uff0c<code>Chef</code>\u83dc\u8c31\u5305\u542b\u4e00\u4e9b\u5176\u4ed6\u7ec4\u4ef6\u53ef\u4ee5\u4f7f\u7528\uff0c\u5b83\u4eec\u662f<code>Berksfiie</code>\u3001<code>definitions</code>\u3001 <code>libraries</code>\u3001 <code>providers</code> \u548c<code>resource</code>\u3002</p>"},{"location":"chap1/chef_tutorial6/#5the-four-resources-you-need-to-know","title":"5\u3001The Four Resources You Need to Know","text":""},{"location":"chap1/chef_tutorial6/#5-1-package","title":"5-1 package","text":"<p>\u4f7f\u7528\u6b63\u786e\u7684\u5b89\u88c5\u5305\u7ba1\u7406\u5668(yum\u3001 apt\u3001 pacman\u7b49\u7b49\uff09\u6765\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\u3002 </p>"},{"location":"chap1/chef_tutorial6/#5-2-service","title":"5-2 service","text":"<p>\u7ba1\u7406\u7528<code>package</code>\u5b89\u88c5\u7684\u670d\u52a1\u3002 </p>"},{"location":"chap1/chef_tutorial6/#5-3-cookbook_file","title":"5-3 <code>Cookbook_file</code>","text":"<p>\u4ece\u83dc\u8c31\u4e2d\u590d\u5236\u6587\u4ef6\u5230\u8282\u70b9\u7684\u5236\u5b9a\u7684\u76ee\u5f55\u3002\u6211\u4eec\u5728\u672c\u7ae0\u524d\u9762\u6bcf\u65e5\u6d88\u606f\u4f8b\u5b50\u4e2d\u5c55\u793a\u4e86\u4f7f\u7528cookbook <code>file</code>\u8d44\u6e90\u6765\u7ba1\u7406\u8282\u70b9\u4e0a\u7684<code>\uff0fetc/motd</code>\u6587\u4ef6\u3002 </p>"},{"location":"chap1/chef_tutorial6/#5-4-template","title":"5-4 template","text":"<p>\u7c7b\u4f3c<code>cookbook_file</code>\u7684\u8d44\u6e90\uff0c\u5141\u8bb8\u4f60\u590d\u5236\u6587\u4ef6\u5230\u76ee\u6807\u8282\u70b9\uff0c\u800c\u7531\u4e8e\u6587\u4ef6\u4e3a\u5d4c\u5165\u5f0f<code>Ruby</code>\u6a21\u677f\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u7528\u53d8\u91cf\u6765\u63a7\u5236\u590d\u5236\u5230\u8282\u70b9\u7684\u6587\u4ef6\u5185\u5bb9\u3002 </p>"},{"location":"chap1/chef_tutorial6/#6apache","title":"6\u3001Apache\u83dc\u8c31\uff1a\u624b\u628a\u624b\u6559\u4f60\u521b\u5efa\u83dc\u8c31","text":"<ul> <li>\u751f\u6210\u83dc\u8c31\u7ed3\u6784</li> <li>\u7f16\u8f91<code>README.md</code>\u6587\u4ef6 </li> <li>\u66f4\u65b0<code>metadata.rb</code></li> <li><code>Package</code>\u8d44\u6e90\u7b80\u4ecb</li> <li><code>Service</code>\u8d44\u6e90\u7b80\u4ecb</li> <li><code>Template</code>\u8d44\u6e90\u7b80\u4ecb </li> <li>\u9a8c\u8bc1\u8fbe\u5230\u6210\u529f\u6807\u51c6 </li> </ul>"},{"location":"chap1/chef_tutorial6/#6-1","title":"6-1 \u751f\u6210\u83dc\u8c31\u7ed3\u6784","text":"<p>Chef\u5f00\u53d1\u5305</p> <pre><code>$ chef generate cookbook apache\n$ cd apache\n</code></pre> <p>Chef\u5ba2\u6237\u7aef</p> <pre><code>$ knife cookbook create apache --cookbook-path .\n$ cd apache\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <pre><code>$ chef generate cookbook apache\nGenerating cookbook apache\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd apache` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <p><code>apache/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[apache::default]\n    attributes:\n</code></pre> <p>\u8fd0\u884c\u6e05\u5355<code>recipe[apache::default\uff3d</code>\u8868\u793a<code>apache</code>\u83dc\u8c31\u4e2d\u3002<code>recipe/default.rb</code>\u6587\u4ef6\u4e2d\u7684<code>Chef</code>\u4ee3\u7801\u5c06\u5728\u6211\u4eec\u8fd0\u884c<code>kitchen cenverge</code>\u65f6\u5728\u6d4b\u8bd5\u8282\u70b9\u4e0a\u7531<code>chef-client</code>\u547d\u4ee4\u8fd0\u884c\uff0e </p> <pre><code> kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n</code></pre>"},{"location":"chap1/chef_tutorial6/#6-2-readmemd","title":"6-2 \u7f16\u8f91<code>README.md</code>\u6587\u4ef6","text":"<p>\u57fa\u4e8e\u4f60\u5728\u524d\u9762\u6240\u5b9a\u4e49\u7684\u524d\u63d0\u6761\uff0c \u4f60\u5e94\u8be5\u4f7f\u7528<code>README.md</code>\u6587\u4ef6\u6765\u9a71\u52a8\u6574\u4e2a\u83dc\u8c31\u7684\u5f00\u53d1\u3002</p> <p><code>apache/README.md</code></p> <pre><code># apache cookbook\n\nThis cookbook installs and configures a simple web site using the Apache HTTPD server.\n\nRequirements\n============\nSupports only CentOS or other RHEL variants that use the +httpd+ package.\n\nUsage\n=====\nAdd `apache` to your node's `run_list`.\n\nTesting\n=======\nA `.kitchen.yml` file is provided.  Run +kitchen converge+ to verify this cookbook.\n</code></pre>"},{"location":"chap1/chef_tutorial6/#6-3-metadatarb","title":"6-3 \u66f4\u65b0<code>metadata.rb</code>","text":"<p>\u8fd9\u662f<code>Chef</code>\u751f\u6210\u7684<code>metadata.rb</code></p> <pre><code>name             'apache'\nmaintainer       ''\nmaintainer_email ''\nlicense          ''\ndescription      'Installs/Configures apache'\nlong_description 'Installs/Configures apache'\nversion          '0.1.0'\n</code></pre> <p>\u6ce8\u610f<code>name</code>\u4e2d\u7684<code>apache</code>\u5b57\u7b26\u4e32\u3002<code>Chef</code>\u4f7f\u7528\u8fd9\u4e2a\u540d\u5b57\u6765\u5339\u914d\u8fd0\u884c\u8bf7\u5355\u4e2d\u7684\u83dc\u8c31\u7684\u540d\u5b57\u800c\u4e0d\u662f\u901a\u8fc7\u83dc\u8c31\u6587\u4ef6\u5939\u7684\u540d\u5b57\u3002</p> <p>\u4f46\u4e3a\u4e86\u4fbf\u4e8e\u65e5\u540e\u7ba1\u7406\u5efa\u8bae\u4f60\u5c06\u83dc\u8c31\u7684\u6587\u4ef6\u5939\u547d\u540d\u4e3a\u548c\u8fd9\u91cc\u6307\u5b9a\u7684<code>name</code>\u4e00\u6837\u7684\u540d\u5b57\u867d\u7136\u4f60\u5e76\u4e0d\u4e00\u5b9a\u9700\u8981\u8fd9\u6837\u505a </p> <p><code>apache/metadata.rb</code></p> <pre><code>name             'apache'\nmaintainer       'Jacob Xi'\nmaintainer_email 'jacobxi@jax.com'\nlicense          'MIT'\ndescription      'Installs/Configures apache'\nlong_description 'Installs/Configures apache'\nversion          '0.1.0'\nchef_version     '&gt;= 14.0'\n</code></pre>"},{"location":"chap1/chef_tutorial6/#6-4-package","title":"6-4 <code>Package</code>\u8d44\u6e90\u7b80\u4ecb","text":"<p>\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u4e3a\u6211\u4eec\u7684\u83dc\u8c31\u64b0\u5199\u4efb\u4f55\u914d\u65b9\u5355\uff0c\u5728\u5199\u4ee3\u7801\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u8fd0\u884c\u7b2c\u4e00\u6b21<code>kitchen converge</code>\u786e\u4fdd\u76ee\u524d\u6211\u4eec\u7f16\u8f91\u8fc7\u7684\u6587\u4ef6\u4e2d\u6ca1\u6709\u8bed\u6cd5\u6216\u683c\u5f0f\u9519\u8bef\u3002</p> <p>\u6211\u4eec\u5efa\u8bae\u5728\u64b0\u5199\u83dc\u8c31\u66ff\u65f6\u7ecf\u5e38\u8fd0\u884c<code>kitchen converge</code>\u6765\u9a8c\u8bc1\u8fdb\u5ea6\u3002</p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n\n kitchen converge default-centos65\n\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2222\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2222\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m46.41s).\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[apache::default]\"]\n       Policy lock file doesn't exist, running `chef install` for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/Policyfile.rb...\n       Building policy apache\n       Expanded run list: recipe[apache::default]\n       Caching Cookbooks...\n       Installing apache &gt;= 0.0.0 from path\n\n       Lockfile written to /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/Policyfile.lock.json\n       Policy revision id: ae351b7b70676a3b57cf2a87805c9c226677d50b224659443baa28550f06a258\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-13563-w35sjf...\n       Exported policy 'apache' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-13563-w35sjf\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-13563-w35sjf\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Installing Chef install only if missing package\n       Downloading https://omnitruck.chef.io/install.sh to file /tmp/install.sh\n       Trying wget...\n       Trying curl...\n       Download complete.\n       el 6 x86_64\n       Getting information for chef stable  for el...\n       downloading https://omnitruck.chef.io/stable/chef/metadata?v=&amp;p=el&amp;pv=6&amp;m=x86_64\n         to file /tmp/install.sh.3168/metadata.txt\n       trying wget...\n       trying curl...\n       sha1     c332e5aef6cf70d1df1e1786926c474eedae1dc2\n       sha256   ddb6e94a65568e6247aa335ef7d2dd69c300c9d2e2df098997b08cf9f6f0c473\n       url      https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n       version  15.5.17\n       downloaded metadata file looks valid...\n       downloading https://packages.chef.io/files/stable/chef/15.5.17/el/6/chef-15.5.17-1.el6.x86_64.rpm\n         to file /tmp/install.sh.3168/chef-15.5.17-1.el6.x86_64.rpm\n       trying wget...\n       trying curl...\n       Comparing checksum with sha256sum...\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       You are installing a package without a version pin.  If you are installing\n       on production servers via an automated process this is DANGEROUS and you will\n       be upgraded without warning on new releases, even to new major releases.\n       Letting the version float is only appropriate in desktop, test, development or\n       CI/CD environments.\n\n       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING\n\n       Installing chef \n       installing with rpm...\n       warning: /tmp/install.sh.3168/chef-15.5.17-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY\n       Preparing...                ########################################### [100%]\n          1:chef                   ########################################### [100%]\n       Thank you for installing Chef Infra Client! For help getting started visit https://learn.chef.io\n       Transferring files to &lt;default-centos65&gt;\n       +---------------------------------------------+\n       \u2714 2 product licenses accepted.\n       +---------------------------------------------+\n       Starting Chef Infra Client, version 15.5.17\n       Creating a new client identity for default-centos65 using the validator key.\n       Using policy 'apache' at revision 'ae351b7b70676a3b57cf2a87805c9c226677d50b224659443baa28550f06a258'\n       resolving cookbooks for run list: [\"apache::default@0.1.0 (2230740)\"]\n       Synchronizing Cookbooks:\n         - apache (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 0 resources\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 0/0 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m31.15s).\n-----&gt; Kitchen is finished. (1m18.05s)\n</code></pre> <p>Now, let\u2019s get to some coding</p> <p><code>/apache/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: apache\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage \"httpd\" do\n    action :install\nend\n</code></pre> <pre><code>$ kitchen converge default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[apache::default]\"]\n       Installing cookbooks for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/Policyfile.rb using `chef install`\n       Installing cookbooks from lock\n       Installing apache 0.1.0\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-1391\n3-nepxu...\n       Exported policy 'apache' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-13913-nepxu\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-13913-nepxu\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Chef installation detected (install only if missing)\n       Transferring files to &lt;default-centos65&gt;\n       Starting Chef Infra Client, version 15.5.17\n       Using policy 'apache' at revision '2a6f5101557a960f0f6da6a165f747dded595bdeb7cb278fff428aff4d9ee4fa'\n       resolving cookbooks for run list: [\"apache::default@0.1.0 (da7e087)\"]\n       Synchronizing Cookbooks:\n         - apache (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 1 resources\n       Recipe: apache::default\n         * yum_package[httpd] action install\n           - install version 0:2.2.15-69.el6.centos.x86_64 of package httpd\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/1 resources updated in 28 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m33.62s).\n-----&gt; Kitchen is finished. (0m34.07s)\n</code></pre> <pre><code>$ kitchen login default-centos65\nLast login: Wed Nov 27 03:00:22 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ rpm -q httpd\nhttpd-2.2.15-69.el6.centos.x86_64\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>\u50cf\u6211\u4eec\u770b\u5230\u7684\uff0c<code>httpd</code>\u670d\u52a1\u88ab\u6210\u529f\u5b89\u88c5\uff01<code>rpm -q</code>\u547d\u4ee4\u67e5\u8be2<code>rpm</code>\u7a0b\u5e8f\u5305\u7ba1\u7406\u5668\u6570\u636e\u5e93\u6765\u770b\u7cfb \u7edf\u4e2d\u662f\u5426\u5b58\u5728\u67d0\u4e2a\u7a0b\u5e8f\u5305\u3002 </p> <p>\u5982\u679c\u4f60\u9605\u8bfb<code>Chef</code>\u5b98\u65b9<code>package</code>\u8d44\u6e90\u6587\u6863Chef documentation on the package resource, \u5c31\u77e5\u9053<code>package</code>\u57fa\u4e8e<code>ohai</code>\u8fd4\u56de\u7684<code>platform</code>\u548c<code>platform_family</code>\u7ed3\u679c\u8c03\u7528\u4e0d\u540c\u7684\u63d0\u4f9b\u8005(<code>providers</code>)\uff0c\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u56e0\u4e3a<code>platform</code>\u662f<code>rhel</code>\uff0c\u6240\u4ee5<code>Chef</code>\u4f7f\u7528\u7684\u662f<code>yum-package</code>\u63d0\u4f9b\u8005\u3002</p> <p>\u5982\u679c\u4f60\u9605\u8bfb<code>yum_package</code>\u8d44\u6e90\u548c\u63d0\u4f9b\u8005\u7684\u5b98\u65b9\u6587\u6863documentation on the yum_package provider\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u56db\u4e2a\u53ef\u4ee5\u6267\u884c\u7684\u52a8\u4f5c\uff1a<code>:install</code>. <code>:upgrade</code>. <code>:remove</code>\u548c<code>:purge</code>\u3002</p> <p>\u56e0\u4e3a<code>:install</code>\u662f\u9ed8\u8ba4\u503c\uff0c\u6240\u4ee5\u5728\u6211\u4eec\u7684\u914d\u65b9\u5355\u4e2d\u65e0\u9700\u660e\u786e\u6307\u51fa\uff0c\u66f4\u6539\u914d\u65b9\u5355\uff0c\u5220\u9664\u591a\u4f59\u7684\u4ee3\u7801\u3002 </p> <pre><code>#\n# Cookbook:: apache\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage \"httpd\"\n</code></pre>"},{"location":"chap1/chef_tutorial6/#6-5-service","title":"**6-5 <code>Service</code>\u8d44\u6e90\u7b80\u4ecb **","text":"<p>\u63a5\u4e0b\u6765\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528<code>service</code>\u8d44\u6e90\u6765\u542f\u52a8<code>httpd</code>\u670d\u52a1\u5e76\u4f7f\u5176\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u81ea\u52a8\u542f\u52a8\u3002 </p> <p><code>service</code>\u8d44\u6e90\u53ef\u4ee5\u7528<code>:start</code>\u52a8\u4f5c\u6765\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\uff0c\u5e76\u53ef\u7528<code>:enable</code>\u52a8\u4f5c\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u542f\u52a8\u670d\u52a1\u3002</p> <p>\u4f60\u53ef\u4ee5\u7528\u6570\u7ec4\u5c06\u591a\u4e2a\u52a8\u4f5c\u4f20\u9012\u7ed9<code>service</code>\u8d44\u6e90\u3002\u6211\u4eec\u8ba8\u8bba\u8fc7\u6570\u7ec4\u7684\u6982\u5ff5\uff0c\u5373\u4ee5\u9017\u53f7\u95f4\u9694\uff0c\u7528\u4e2d\u62ec\u53f7<code>(\"[]\")</code>\u5b9a\u4e49\u7684\u7684\u5217\u8868 </p> <pre><code>#\n# Cookbook:: apache\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage \"httpd\" do\n    action :install\nend\n\nservice \"httpd\" do\n    action [ :enable, :start ]\nend\n</code></pre> <pre><code>$ kitchen converge default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[apache::default]\"]\n       Installing cookbooks for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/Policyfile.rb using `chef install`\n       Installing cookbooks from lock\n       Installing apache 0.1.0\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-14392-nrtm03...\n       Exported policy 'apache' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-14392-nrtm03\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-14392-nrtm03\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Chef installation detected (install only if missing)\n       Transferring files to &lt;default-centos65&gt;\n       Starting Chef Infra Client, version 15.5.17\n       Using policy 'apache' at revision '51fca2941ea10db0a90f494d632149f09cdbd4828bb269bf0d0612cfe4036553'\n       resolving cookbooks for run list: [\"apache::default@0.1.0 (0444f5c)\"]\n       Synchronizing Cookbooks:\n         - apache (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 2 resources\n       Recipe: apache::default\n         * yum_package[httpd] action install (up to date)\n         * service[httpd] action enable\n           - enable service service[httpd]\n         * service[httpd] action start\n           - start service service[httpd]\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 2/3 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m7.13s).\n-----&gt; Kitchen is finished. (0m7.61s\n</code></pre> <pre><code>$ kitchen login default-centos65\nLast login: Wed Nov 27 03:13:59 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ chkconfig --list httpd | grep 3:o\nhttpd           0:off   1:off   2:on    3:on    4:on    5:on    6:off\n\n[vagrant@default-centos65 ~]$ service httpd status\nhttpd dead but subsys locked\n\n[vagrant@default-centos65 ~]$ sudo service httpd status\nhttpd (pid  3760) is running...\n</code></pre> <p>In our grep statement, we verified that the service is set to be onfor runlevel 3.</p>"},{"location":"chap1/chef_tutorial6/#6-6-template","title":"6-6 <code>Template</code>\u8d44\u6e90\u7b80\u4ecb","text":"<p>\u6211\u4eec\u7ec8\u901a\u8fc7\u751f\u6210\u7f51\u7ad9\u9700\u8981\u7684\u5185\u5bb9\u7684\u6587\u4ef6\u6765\u5c55\u793a\u5982\u4f55\u4f7f\u7528<code>template</code>\u8d44\u6e90\u3002 </p> <p><code>template</code>\u8d44\u6e90\u548c<code>cookbook_file</code>\u90fd\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u521b\u5efa\u6587\u4ef6\u3002</p> <p>\u7136\u800c\uff0c\u5b83\u62e5\u6709\u989d\u5916\u7684\u529f\u80fd\u53ef\u4ee5\u5728\u6e90\u6587\u4ef6\u91cc\u5305\u542b\u53d8\u91cf\u6216\u5176\u4ed6<code>Ruby</code>\u903b\u8f91\u63a7\u5236\u5199\u51fa\u76ee\u6807\u8282\u70b9\u7684\u6587\u4ef6\u7684\u5185\u5bb9\u3002\u5b83\u7684\u683c\u5f0f\u662f\u5d4c\u5165\u5f0f<code>ruby</code>(ERB).</p> <pre><code>#\n# Cookbook:: apache\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage \"httpd\" do\n    action :install\nend\n\nservice \"httpd\" do\n    action [ :enable, :start ]\nend\n\ntemplate \"/var/www/html/index.html\" do\n    source 'index.html.erb'\n    mode '0644'\nend\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b, <code>httpd</code> \u670d\u52a1\u5668\u5728<code>/var/www/html</code>\u76ee\u5f55\u4e0b\u5bfb\u627e\u7f51\u9875\u6587\u4ef6\u3002\u9ed8\u8ba4\u7f51\u7ad9\u7684\u6587\u4ef6\u4e00\u822c \u4e3a<code>/var/www/html/index.html</code>\u3002\u6587\u4ef6\u9700\u8981\u4e3a\u5168\u5c40\u53ef\u8bfb\u6743\u9650\u3002\u548c<code>file</code>\u8d44\u6e90\u76f8\u6bd4\u8fd9\u91cc\u591a\u51fa\u6765 \u7684\u662f<code>source</code>\u5c5e\u6027\u3002</p> <p><code>source</code>\u5c5e\u6027\u6307\u5b9a\u5305\u542b<code>ERB</code>\u8bed\u53e5\u7684\u6a21\u677f\u7684\u6e90\u6587\u4ef6\u3002</p> <p>\u5728\u83dc\u8c31\u4e2d\uff0c \u6a21\u677f\u5728<code>template</code>\u5b50\u76ee\u5f55\u4e2d, \u548c<code>files</code>\u76ee\u5f55\u62e5\u6709\u540c\u6837\u7684\u5b50\u76ee\u5f55\u7ed3\u6784\u7684\u7ea6\u5b9a\u3002\u56e0\u6b64\u5982\u679c\u8981\u5c06\u6a21\u677f\u6e32\u67d3\u5230\u6240\u6709\u5e94\u7528\u8be5\u83dc\u8c31\u7684\u8282\u70b9\u4e0a\u786e\u4fdd\u8fd9\u4e9b\u6a21\u677f\u4f4d\u4e8e<code>templates/default</code>\u5b50\u76ee\u5f55\u5185\u3002</p>"},{"location":"chap1/chef_tutorial6/#6-7-default","title":"6-7 <code>default</code>\u5b50\u76ee\u5f55\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684","text":"<p><code>files/default</code>\u548c<code>template/default</code>\u4e2d\u7684<code>default</code>\u5b50\u76ee\u5f55\u5b8c\u7adf\u662f\u5e72\u4ec0\u4e48\u7528\u7684\uff0c</p> <p><code>Chef</code>\u5141\u8bb8\u4f60\u5728\u83dc\u8c31\u4e2d\u6839\u636e\u76ee\u6807\u8282\u70b9\u7684\u5e73\u53f0\u6307\u5b9a\u4e0d\u540c\u7684\u6587\u4ef6\u3002<code>Chef</code>\u8981\u4f60\u5728<code>files</code>\u6216<code>templates</code> \u76ee\u5f55\u4e0b\u521b\u5efa\u5b50\u76ee\u5f55\u6765\u9009\u884c\u8fc7\u6ee4\u3002\u53ef</p> <p>\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u5b50\u76ee\u5f55\u547d\u540d\u683c\u5f0f\u8fc7\u6ee4\uff1a </p> <ul> <li>\u8282\u70b9\u7684\u4e3b\u673a\u540d\uff08\u6bd4\u5982<code>foo.bar.com</code>) </li> <li>\u8282\u70b9\u7684\u5e73\u53f0\u7248\u6728\uff08\u6bd4\u5982<code>redhat-6.5.1</code>) </li> <li>\u8282\u70b9\u7684\u5e73\u53f0\u90e8\u5206\u7248\u672c\uff08\u6bd4\u5982<code>redhat-6.5</code>\u548c<code>redhat-6</code>) </li> <li>\u8282\u70b9\u7684\u5e73\u53f0\uff08\u6bd4\u5982<code>redhat</code>) </li> <li>default </li> </ul> <p>\u5728\u5927\u591a\u6570\u65f6\u5019\u90fd\u53ea\u7528<code>default</code>\u4f5c\u4e3a\u5b50\u76ee\u5f55\u540d\u8868\u793a\u5176\u4e2d\u7684\u53c8\u4ef6\u6216\u6a21\u677f\u5c06\u88ab\u590d\u5236\u5230\u6240\u6709\u5e94\u7528\u6b64\u83dc\u8c31\u7684\u8282\u70b9\u3002 </p> <p>\u8ba9\u6211\u4eec\u4e3a<code>index.html</code>\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a<code>ERB</code>\u6a21\u677f\u3002</p> <p>\u6839\u636e\u7ea6\u5b9a<code>ERB</code>\u6a21\u677f\u9700\u8981\u6709<code>.erb</code>\u6269\u5c55\u540d\u3002\u5f53\u4f60\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\u65f6\u901a\u8fc7\u8fd0\u884c\uff1a</p> <pre><code>chef generate template index.html\n</code></pre> <p>\u5b83\u4f1a\u81ea\u52a8\u5e2e\u4f60\u521b\u5efa\u6a21\u677f\u6587\u4ef6<code>template/default/index.html.erb</code>\u5e76\u4f7f\u7528\u6b63\u786e\u7684\u6269\u5c55\u540d\u3001\u5982\u679c\u4f7f\u7528<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u5219\u5fc5\u987b\u624b\u52a8\u521b\u5efa\u8fd9\u4e2a\u6587\u4ef6\u3002 </p> <ul> <li><code>Chef</code>\u5f00\u53d1\u5305</li> </ul> <pre><code>chef generate tempalte index.html\n</code></pre> <ul> <li><code>Chef</code>\u5ba2\u6237\u7aef</li> </ul> <pre><code>touch templates/default/index.html.erb\n</code></pre> <pre><code>\n[chap07/apache]$ chef generate template index.html\nRecipe: code_generator::template\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/templates] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/templates\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/templates/index.html.erb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/templates/index.html.erb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/templates/index.html.erb from none to e3b0c4\n    (diff output suppressed by config)\n</code></pre> <p><code>/apache/templates/default/index.hmtl.erb</code></p> <pre><code>This site was set up by Jacob on &lt;%= node['hostname'] %&gt;\n</code></pre> <p>\u5728ERB\u6587\u4ef6\u91cc\uff0c\u5f53Chef\u770b\u5230\u5305\u542b\u5728<code>\uff1c\uff05=</code>\u548c<code>\uff05\uff1e</code>\u4e2d\u95f4\u7684\u8bed\u53e5\u65f6\uff0c<code>Chef</code>\u4f1a\u53bb\u6267\u884c\u5176\u4e2d\u7684\u53d8\u91cf\u5e76\u5c06\u5b83\u7684\u503c\u6e32\u67d3\u5728\u6587\u4ef6\u5185\u5bb9\u4e2d\u66ff\u4ee3\u8fd9\u4e2a\u53d8\u91cf\uff0c</p> <ul> <li>\u6bd4\u5982\u4ee5\u4e0b\u7684<code>index.html.erb</code>\u6587\u4ef6\u4e2d\u7684<code>\uff1c%= node['hostname'] \uff05\uff1e</code>\u53d8\u91cf\u3002</li> <li><code>Chef</code>\u8bfb\u53d6<code>node['hostname']</code>\u53d8\u91cf\u7684\u503c\uff0c\u5e76\u4ee5\u5176\u66ff\u6362<code>\uff1c\uff05= node['hostname'] %\uff1e</code>\u7684\u5185\u5bb9\u3002</li> </ul> <pre><code>$ kitchen converge default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[apache::default]\"]\n       Installing cookbooks for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap07/apache/Policyfile.rb using `chef install`\n       Installing cookbooks from lock\n       Installing apache 0.1.0\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-1580\n6-1t9jy6n...\n       Exported policy 'apache' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-15806-1t9jy6n\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191127-15806-1t9jy6n\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Chef installation detected (install only if missing)\n       Transferring files to &lt;default-centos65&gt;\n       Starting Chef Infra Client, version 15.5.17\n       Using policy 'apache' at revision '13bba8f1762da2368761cab02339f8d3234f7cfcb49f7d77c4a7736cf8e72c71'\n       resolving cookbooks for run list: [\"apache::default@0.1.0 (488d5f6)\"]\n       Synchronizing Cookbooks:\n         - apache (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: apache::default\n         * yum_package[httpd] action install (up to date)\n         * service[httpd] action enable (up to date)\n         * service[httpd] action start (up to date)\n         * template[/var/www/html/index.html] action create\n           - create new file /var/www/html/index.html\n           - update content in file /var/www/html/index.html from none to bb8b36\n           --- /var/www/html/index.html 2019-11-27 06:12:38.679041804 +0000\n           +++ /var/www/html/.chef-index20191127-4063-1u05qd.html       2019-11-27 06:12:38.678041799 +0000\n           @@ -1 +1,2 @@\n           +This site was set up by Jacob on default-centos65\n           - change mode from '' to '0644'\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/4 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m7.04s).\n-----&gt; Kitchen is finished. (0m7.52s)\n</code></pre> <pre><code>$ kitchen login default-centos65\nLast login: Wed Nov 27 06:12:35 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n\n[vagrant@default-centos65 ~]$ more /var/www/html/index.html\nThis site was set up by Jacob on default-centos65\n\n[vagrant@default-centos65 ~]$ curl localhost\nThis site was set up by Jacob on default-centos65\n\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre>"},{"location":"chap1/chef_tutorial6/#6-8","title":"6-8 \u9a8c\u8bc1\u8fbe\u5230\u6210\u529f\u6807\u51c6","text":"<p>\u8981\u4f7f\u5bbf\u4f4f\u673a\u5668\u80fd\u591f\u8bbf\u95ee\u5728\u6d4b\u8bd5\u8282\u70b9\u4e0a\u6258\u7ba1\u7684\u7f51\u7ad9\uff0c \u9700\u8981\u7ed9\u4fa7\u8bd5\u8282\u70b9\u5206\u914d\u4e00\u4e2a\u9759\u6001\u7684<code>IP</code>\u5730\u5740\u3002\u53ef\u4ee5\u901a\u8fc7\u7f16\u8f91<code>kitchen.yml</code>\u6765\u8bbe\u5b9a\u6d4b\u8bd5\u8282\u70b9\u7684<code>IP</code>\u5730\u5740\u3002</p> <pre><code>driver:\n  network:\n  - [\"private_network\", {ip: \"192.168.33.7\"}]\n</code></pre> <p>The static IP address should be chosen from the TCP/IP reserved private address space that does not conflict with other machines on the same network. The IP address <code>192.168.33.7</code> should work for nearly everyone, as most routers don\u2019t use this subnet by default, so modify your <code>kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n      network:\n      - [\"private_network\", {ip: \"192.168.33.7\"}]\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[apache::default]\n    attributes:\n</code></pre> <p>\u4e0d\u5e78\u7684\u662f\uff0c<code>Test Kitchen</code>\u53ea\u5728\u6267\u884c<code>\uff0bkitchen create\uff0b</code>\u521b\u5efa\u6c99\u76d2\u73af\u5883\u65f6\u5e94\u7528\uff0e<code>kitchen.yml</code>\u4e2d\u7684\u7f51\u7edc\u8bbe\u5b9a\u3002</p> <p>\u800c\u6211\u4eec\u5df2\u7ecf\u521b\u5efa\u4e86\u6c99\u76d2\u73af\u5883\u3002\u6211\u4eec\u9700\u8981\u8fd0\u884c<code>+kitchen destroy+</code>\u5220\u9664\u73b0\u6709\u7684\u6c99\u76d2\u73af\u5883\uff0c\u7136\u540e\u518d\u8fd0\u884c<code>\uff0bkitchen converge+</code>\uff0c\u6240\u4ee5\u5b83\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6c99\u76d2\u73af\u5883\u3002\u5426\u5219<code>Test Kitchen</code>\u4f1a\u5ffd\u7565\u6211\u4eec\u521a\u521a\u52a0\u5230<code>kitchen.yml</code>\u7f51\u7edc\u8bbe\u5b9a\uff1a </p> <pre><code>$ kitchen destroy default-centos65\n\n$ kitchen create default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Creating &lt;default-centos65&gt;...\n       Bringing machine 'default' up with 'vmware_desktop' provider...\n       ==&gt; default: Cloning VMware VM: 'learningchef/centos65'. This can take some time...\n       ==&gt; default: Checking if box 'learningchef/centos65' version '1.0.7' is up to date...\n       ==&gt; default: Verifying vmnet devices are healthy...\n       ==&gt; default: Preparing network adapters...\n       WARNING: The VMX file for this box contains a setting that is automatically overwritten by Vagrant\n       WARNING: when started. Vagrant will stop overwriting this setting in an upcoming release which may\n       WARNING: prevent proper networking setup. Below is the detected VMX setting:\n       WARNING: \n       WARNING:   ethernet0.pcislotnumber = \"33\"\n       WARNING: \n       WARNING: If networking fails to properly configure, it may require this VMX setting. It can be manually\n       WARNING: applied via the Vagrantfile:\n       WARNING: \n       WARNING:   Vagrant.configure(2) do |config|\n       WARNING:     config.vm.provider :vmware_desktop do |vmware|\n       WARNING:       vmware.vmx[\"ethernet0.pcislotnumber\"] = \"33\"\n       WARNING:     end\n       WARNING:   end\n       WARNING: \n       WARNING: For more information: https://www.vagrantup.com/docs/vmware/boxes.html#vmx-whitelisting\n       ==&gt; default: Starting the VMware VM...\n       ==&gt; default: Waiting for the VM to receive an address...\n       ==&gt; default: Forwarding ports...\n           default: -- 22 =&gt; 2222\n       ==&gt; default: Waiting for machine to boot. This may take a few minutes...\n           default: SSH address: 127.0.0.1:2222\n           default: SSH username: vagrant\n           default: SSH auth method: private key\n           default: \n           default: Vagrant insecure key detected. Vagrant will automatically replace\n           default: this with a newly generated keypair for better security.\n           default: \n           default: Inserting generated public key within guest...\n           default: Removing insecure key from the guest if it's present...\n           default: Key inserted! Disconnecting and reconnecting using new SSH key...\n       ==&gt; default: Machine booted and ready!\n       ==&gt; default: Setting hostname...\n       ==&gt; default: Configuring network adapters within the VM...\n       ==&gt; default: Machine not provisioned because `--no-provision` is specified.\n       [SSH] Established\n       Vagrant instance &lt;default-centos65&gt; created.\n       Finished creating &lt;default-centos65&gt; (0m47.40s).\n</code></pre> <pre><code>$ kitchen converge default-centos65\n</code></pre> <p></p> <pre><code>$ kitchen destroy default-centos65\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m20.38s).\n</code></pre>"},{"location":"chap1/chef_tutorial6/#7","title":"7\u3001\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u4ecb\u7ecd\u4e86\u83dc\u8c31\uff08cookbook\uff09\u7684\u6982\u5ff5\u3002\u8981\u81ea\u52a8\u5316\u914d\u7f6e\u8282\u70b9\uff0cChef\u4e0d\u4ec5\u9700\u8981\u5305\u542b\u4ee3\u7801\u7684\u914d\u65b9\u5355\u6587\u4ef6\uff0c\u8fd8\u9700\u8981\u5176\u4ed6\u76f8\u5173\u7684\u4fe1\u606f\u3002\u83dc\u8c31\u5305\u542b\u8fd9\u4e9b\u4fe1\u606f\uff0c\u5e76\u5c06\u914d\u65b9\u5355\u548c\u8fd9\u4e9b\u4fe1\u606f\u6253\u5305 \u4e3a\u914d\u7f6e\u57fa\u7840\u67b6\u6784\u7684\u4e00\u4e2a\u5355\u4f4d\u3002 </p> <p>\u6211\u4eec\u5728\u672c\u7ae0\u8986\u76d6\u4e86\u83dc\u8c31\u7684\u4ee5\u4e0b\u5143\u7d20\uff1a<code>metadata.rb</code>\u5143\u6587\u4ef6\u3001 <code>files</code>\u76ee\u5f55\u4ee5\u53ca<code>template</code>\u76ee\u5f55\u3002</p> <p>\u6211\u4eec\u4e5f\u5c55\u793a\u4e86\u5728<code>recipe</code>\u76ee\u5f55\u4e0b\u7684\u914d\u65b9\u5355\u6587\u4ef6\u3002 </p> <p>\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728\u914d\u65b9\u5355\u4ee3\u7801\u4e2d\u7ecf\u5e38\u4f7f\u7528\u7684\u56db\u4e2a\u57fa\u672c\u8d44\u6e90\uff1a </p> <ul> <li><code>package</code> \u4f7f\u7528\u7cfb\u7edf\u7a0b\u5e8f\u5305\u7ba1\u7406\u5668\u6765\u5b89\u88c5\u7a0b\u5e8f\u5305 </li> <li><code>service</code> \u7ba1\u7406\u7531<code>package</code>\u8d44\u6e90\u5b89\u88c5\u7684\u6240\u6709\u540e\u53f0\u8fdb\u7a0b\uff0f\u670d\u52a1\u7684\u751f\u547d\u5468\u671f </li> <li><code>cookbook_file</code> \u4ece\u83dc\u8c31<code>files</code>\u76ee\u5f55\u590d\u5236\u6587\u4ef6\u5230\u76ee\u6807\u8282\u70b9\u7684\u6307\u5b9a\u4f4d\u7f6e </li> <li><code>template</code> \u548c<code>cookbook_flle</code>\u7c7b\u4f3c\uff0c\u4ece\u83dc\u8c31\u7684<code>templates</code>\u590d\u5236\u6587\u4ef6\u5230\u76ee\u6807\u8282\u70b9\u7684\u6307\u5b9a\u4f4d\u7f6e\uff0c\u4f46\u6e90\u6587\u4ef6\u4e3a\u5d4c\u4eba\u5f0f<code>Ruby</code> (<code>ERB</code>)\u6a21\u677f\uff0c\u53ef\u5305\u542b\u53d8\u91cf\u53ca<code>Ruby</code>\u903b\u8f91\u6765\u51b3\u5b9a\u5728\u4e0d\u540c\u60c5\u51b5\u4e0b\u4e0d\u540c\u7684\u5185\u5bb9  </li> </ul> <p>\u6700\u540e\uff0c\u4ecb\u7ecd\u6211\u4eec\u63a8\u8350\u7684\u521b\u5efa\u83dc\u8c31\u7684\u8fc7\u7a0b\u3002 </p> <ul> <li>\u660e\u786e\u76ee\u6807\u53ca\u524d\u63d0\u6761\u4ef6\u3002 </li> <li>\u751f\u6210\u83dc\u8c31\u6587\u4ef6\u7ed3\u6784\u3002 </li> <li>\u5728<code>README.md</code>\u64b0\u5199\u6587\u6863\u5e76\u7528\u5b83\u6765\u9a71\u52a8\u5f00\u53d1\u3002 </li> <li>\u5728<code>metadata.rb</code>\u6587\u4ef6\u4e2d\u5b9a\u4e49\u5143\u6570\u636e</li> <li>\u7528<code>kitchn converge</code>\u548c<code>kitchen login</code>\u6765\u9a8c\u8bc1\u83dc\u8c31\u5982\u671f\u6267\u884c\u4e86\u4f60\u8981\u5b83\u505a\u7684\u4e8b\u3002 </li> <li>\u9a8c\u8bc1\u5df1\u8fbe\u5230\u9884\u5148\u5b9a\u597d\u7684\u6210\u529f\u6807\u51c6\u3002 </li> </ul> <pre><code>$ chef generate cookbook motd    # chef-dk\n\n# chef-client\n$ knife cookbook create motd --cookbook-path .\n$ cd motg\n$ kitchen init --create-gemfile\n$ bundle install\n\n\n$ kitchen converge default-centos65\n</code></pre>"},{"location":"chap1/chef_tutorial7_attributes/","title":"\u7b2c\u4e03\u8282 \u5c5e\u6027","text":"<ul> <li><code>Motd-Attributes</code>\u83dc\u8c31 </li> <li>Setting Attributes</li> <li>\u5c5e\u6027\u4f18\u5148\u7ea7\u57fa\u7840 </li> <li><code>Include_Recipe</code></li> <li>\u5c5e\u6027\u4f18\u5148\u7ea7</li> <li>\u5c5e\u6027\u6392\u9519 </li> </ul>"},{"location":"chap1/chef_tutorial7_attributes/#1chef","title":"1\u3001Chef \u5c5e\u6027","text":"<p>\u5c5e\u6027\u4ee3\u8868\u7684\u662f\u4f60\u7684\u8282\u70b9\u7684\u76f8\u5173\u4fe1\u606f\u3002\u9664\u4e86<code>ohai</code>\u81ea\u6536\u96c6\u7684\u8282\u70b9\u76f8\u5173\u4fe1\u606f\u4e4b\u5916\uff0c \u4f60\u8fd8\u53ef\u4ee5\u5728<code>chef</code>\u914d\u65b9\u5355\u6216\u989d\u5916\u7684\u5c5e\u6027\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u5c5e\u6027</p> <p>\u5c5e\u6027\u6587\u4ef6\u5728\u83dc\u8c31\u7684<code>attributes</code>\u6b64\u76ee\u5f55\u4e2d\u3002\u548c\u914d\u65b9\u5355\u7c7b\u4f3c, \u83ab\u8ba4\u5c5e\u6027\u6587\u4ef6\u53eb<code>default.rb</code></p> <pre><code>&lt;cookbook&gt;\n\u2514\u2500\u2500 attributes\n    \u2514\u2500\u2500 default.rb\n</code></pre> <p>\u4f7f\u7528\u83dc\u8c31\u4e2d\u7684\u5c5e\u6027\u6587\u4ef6\u6765\u8bbe\u5b9a\u7684\u5c5e\u6027\u7684\u683c\u5f0f\u3002 </p> <p></p> <p>\u5c5e\u6027\u4e5f\u53ef\u4ee5\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\uff0c\u5c55\u793a\u5728\u914d\u65b9\u5355\u4e2d\u6240\u8bbe\u5b9a\u7684\u5c5e\u6027\u7684\u683c\u5f0f\u53e3\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u5c5e\u6027\u65f6\u5fc5\u987b\u4f7f\u7528<code>node\uff0e</code>\u524d\u7f00 </p> <p></p> <p>Because attributes can be defined in multiple places, all attribute values are composed together during a Chef run according to the priority levels as shown in Figure</p> <p>Attributes defined by <code>ohai</code> have the highest priority, followed by attributes defined in a recipe, then attributes defined in an attribute file. </p> <p>In other words, recipe attributes have a higher priority than those defined in attribute file, and will override them by default. Attributes defined by <code>ohai</code> trump everything else.</p> <p></p> <p><code>ohai</code> &gt; attributes defined in a recipe &gt; attributes defined in an attribute file</p>"},{"location":"chap1/chef_tutorial7_attributes/#2motd-attributes","title":"2\u3001<code>Motd-Attributes</code>\u83dc\u8c31","text":"<p>\u6211\u4eec\u7528\u4e00\u4e2a\u53eb\u30fb<code>Motd-Attributes</code>\u7684\u83dc\u8c31\u6765\u8bd5\u9a8c\u83dc\u8c31\u4e2d\u7684\u5c5e\u6027\uff0c\u8fd9\u91cc\u6765\u5199\u4e00\u4e2a\u7531\u5c5e\u80dc\u9a71\u52a8\u7684\u7248\u672c \u3002</p> <p>\u9996\u5148\uff0c\u4f7f\u7528<code>chef generate cookbook</code>\u6216<code>knife cookbook create</code>\uff08\u53d6\u51b3\u4e8e\u5f00\u53d1\u673a\u5668\u4f7f\u7528Chef\u5f00\u53d1\u5305\u8fd8\u662f\u5ba2\u6237\u7aef\uff09\u6765\u751f\u6210<code>motd-attributes</code>\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\u3002 </p> <p>Chef\u5f00\u53d1\u5305</p> <pre><code>$ chef generate cookbook motd-attributes\n chef generate cookbook motd-attributes\nHyphens are discouraged in cookbook names as they may cause problems with custom resources. See https://docs.chef.io/ctl_chef.html#chef-generate-cookbook for more information.\nGenerating cookbook motd-attributes\n- Ensuring correct cookbook content\n- Committing cookbook files to git\n\nYour cookbook is ready. Type `cd motd-attributes` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list of local testing commands.\n\nWhy not start by writing an InSpec test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n\n\n\n$ cd motd-attributes\n</code></pre> <p>Chef\u5ba2\u6237\u7aef</p> <pre><code>$ knife cookbook create motd-attributes --cookbook-path .\n$ cd motd-attributes\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p><code>/motd-attributes/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_zero\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[motd-attributes::default]\n    attributes:\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u914d\u65b9\u5355\u4f7f\u7528<code>template</code>\u8d44\u6e90\u6765\u751f\u6210\u8282\u70b9\u4e0a\u7684<code>/etc/motd</code>\u6587\u4ef6\u3002\u4f46\u8fd9\u4e00\u6b21\uff0c\u4f7f\u7528\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u5c5e\u80dc\u3002</p> <p><code>motd-attributes/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: motd-attributes\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\ntemplate '/etc/motd' do\n    source 'motd.erb'\n    mode '0644'\nend\n</code></pre> <p>Generate a template file to generate <code>/etc/motd</code>.</p> <p>Chef\u5f00\u53d1\u5305</p> <pre><code>$ chef generate template motd\nRecipe: code_generator::template\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/templates] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/templates\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/templates/motd.erb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/templates/motd.erb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/templates/motd.erb from none to e3b0c4\n    (diff output suppressed by config)\n\n</code></pre> <p>Chef Client - Linux/Mac OS X:</p> <pre><code>$ touch templates/default/motd.erb\n</code></pre> <p><code>templates/default/motd.erb</code></p> <pre><code>The hostname of this node is &lt;%= node['hostname'] %&gt;\nThe IP address of this node is &lt;%= node['ipaddress'] %&gt;\n</code></pre> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n\n\n$ kitchen converge\n\n$ kitchen login\nLast login: Thu Nov 28 03:12:17 2019 from 172.16.72.2\nThe hostname of this node is default-centos65\nThe IP address of this node is 172.16.72.142\n\n$ exit\n</code></pre>"},{"location":"chap1/chef_tutorial7_attributes/#3setting-attributes","title":"3\u3001Setting Attributes","text":"<p>Chef Development Kit:</p> <pre><code>$ chef generate attribute default\n\n\nRecipe: code_generator::attribute\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/attributes] action create\n    - create new directory /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/attributes\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/attributes/default.rb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/attributes/default.rb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/attributes/default.rb from none to e3b0c4\n    (diff output suppressed by config)\n</code></pre> <p>Chef Client - Linux/Mac OS X:</p> <pre><code>$ touch attributes/default.rb\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\u751f\u6210\u65b0\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u5b83\u4e0d\u4f1a\u521b\u5efa<code>attribute</code>\u76ee\u5f55\uff0c\u56e0\u4e3a\u4f60\u4e0d\u4e00\u5b9a\u4f1a\u7528\u5230\u5b83\u3002\u7136\u800c\uff0c\u5728\u9700\u8981\u5728\u83dc\u8c31\u4e2d\u4f7f\u7528\u5c5e\u6027\u6587\u4ef6\u65f6\uff0c\u4f60\u9700\u8981\u8fd0\u884c<code>chef generate</code>\u547d\u4ee4\u6765\u521b\u5efa\u5176\u76ee\u5f55\u7ed3\u6784\u3002</p> <p>\u800c\u5982\u679c\u4f7f\u7528<code>Chef</code>\u5ba2\u6237\u7aef\u521b\u5efa\u65b0\u83dc\u8c31\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u5b83\u6c38\u8fdc\u4f1a\u521b\u5efa\u6240\u6709\u7684\u76ee\u5f55\uff08\u5305\u62ecattribute\u3001\u76ee\u5f55\uff0c\u65e0\u8bba\u4f60\u662f\u5426\u9700\u8981\uff09\uff0c\u4f46\u4f60\u9700\u8981\u81ea\u5df1\u624b\u52a8\u521b\u5efa<code>default.rb</code>\u5c5e\u6027\u6587\u4ef6\u3002 </p> <p><code>/attributes/default.rb</code></p> <pre><code>default['motd-attributes']['company'] = 'Chef'\n</code></pre> <p>\u6839\u636e\u7ea6\u5b9a\uff0c\u5728\u83dc\u8c31\u7684\u5c5e\u6027\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u5c5e\u6027\u65f6\uff0c\u5c5e\u6027\u7684\u952e\u548c\u503c\u5e94\u8be5\u5b58\u5728\u4ee5\u83dc\u8c31\u540d\u5b57\u547d\u540d\u7684\u9876\u7ea7\u547d\u540d\u7a7a\u95f4\u4e0b\u3002</p> <p>\u6bd4\u5982<code>default['motd-attributes']['company'</code>\uff3d\u7684\u503c\u662f\u5b57\u7b26\u4e32<code>Chef</code>,\u952e<code>company</code>\u5b58\u5728\u9876\u7ea7\u547d\u540d\u7a7a\u95f4<code>motd-attributes</code>\u4e0b\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u83dc\u8c31\u7684\u540d\u5b57\u5728<code>metadata.rb</code>\u4e2d\u5b9a\u4e49\u4e3a<code>mot-attributes</code>\u3002\u8fd9\u4e2a\u5c5e\u6027\u4f7f\u7528default\u4f18\u5148\u7ea7\u3002</p> <p><code>/recipes/default.rb</code></p> <pre><code>node.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode '0644'\nend\n</code></pre> <p>\u7f16\u8f91<code>mold.erb</code>\u6a21\u677f\u3002\u53ef\u4ee5\u5728<code>node</code>\u5bf9\u8c61\u4e0b\u8bbf\u95ee\u901a\u8fc7\u4efb\u4f55\u9014\u5f84\u8bbe\u5b9a\u7684\u5c5e\u80dc\u5c5e\u6027\u6587\u4ef6\u83dc\u8c31\u6216<code>ohai</code> </p> <p><code>templates/default/motd.erb</code></p> <pre><code>Welcome to &lt;%= node['motd-attributes']['company'] %&gt;\n&lt;%= node['motd-attributes']['message'] %&gt;\nThe hostname of this node is &lt;%= node['hostname'] %&gt;\nThe IP address of this node is &lt;%= node['ipaddress'] %&gt;\n</code></pre> <pre><code>$ kitchen converge\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Converging &lt;default-centos65&gt;...\n       Preparing files for transfer\n$$$$$$ You must set your run_list in your Policyfile instead of kitchen config. The run_list in your config will be ignored.\n$$$$$$ Ignored run_list: [\"recipe[motd-attributes::default]\"]\n       Installing cookbooks for Policyfile /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/Policyfile.rb using `chef in\nstall`\n       Installing cookbooks from lock\n       Installing motd-attributes 0.1.0\n       Preparing dna.json\n       Exporting cookbook dependencies from Policyfile /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191129-2695\n5-1g48hf7...\n       Exported policy 'motd-attributes' to /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191129-26955-1g48hf7\n\n       To converge this system with the exported policy, run:\n         cd /var/folders/r7/nml_dsbn44gcd2jlqh7s2w940000gn/T/default-centos65-sandbox-20191129-26955-1g48hf7\n         chef-client -z\n       Removing non-cookbook files before transfer\n       Preparing validation.pem\n       Preparing client.rb\n-----&gt; Chef installation detected (install only if missing)\n       Transferring files to &lt;default-centos65&gt;\n       Starting Chef Infra Client, version 15.5.17\n       Using policy 'motd-attributes' at revision '3e7401637721e60a1aa8475f5dd46efd6ad452ec2cb08118d94bbf112815ab5e'\n       resolving cookbooks for run list: [\"motd-attributes::default@0.1.0 (4b1d2ce)\"]\n       Synchronizing Cookbooks:\n         - motd-attributes (0.1.0)\n       Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 1 resources\n       Recipe: motd-attributes::default\n         * template[/etc/motd] action create\n           - update content in file /etc/motd from 0397e6 to b17ece\n           --- /etc/motd        2019-11-28 03:12:20.412305997 +0000\n           +++ /etc/.chef-motd20191129-3585-p6oosp      2019-11-29 02:24:14.925471024 +0000\n           @@ -1,3 +1,8 @@\n           +# The hostname of this node is default-centos65\n           +# The IP address of this node is 172.16.72.142\n           +\n           +Welcome to Chef\n           +It's a wonderful day today!\n            The hostname of this node is default-centos65\n            The IP address of this node is 172.16.72.142\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/1 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m8.64s).\n-----&gt; Kitchen is finished. (0m9.31s\n</code></pre> <pre><code>$ kitchen login\nLast login: Fri Nov 29 02:24:10 2019 from 172.16.72.2\n# The hostname of this node is default-centos65\n# The IP address of this node is 172.16.72.142\n\nWelcome to Chef\nIt's a wonderful day today!\nThe hostname of this node is default-centos65\nThe IP address of this node is 172.16.72.142\n\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre>"},{"location":"chap1/chef_tutorial7_attributes/#4","title":"4\u3001\u5c5e\u6027\u4f18\u5148\u7ea7\u57fa\u7840","text":"<p>\u73b0\u5728\uff0c \u8ba9\u6211\u4eec\u6765\u8bd5\u9a8c\u4e00\u4e0b\u4e0d\u540c\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u3002 \u91cd\u65b0\u8bbe\u5b9a\u5df2\u7ecf\u5728\u5176\u4ed6\u5730\u65b9\u8bbe\u5b9a\u8fc7\u7684\u5c5e\u6027\u503c \u7f16\u8f91<code>recipe/default.rb</code>, \u91cd\u8bbe\u4e00\u4e2a\u5728\u5c5e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u7531<code>ohai</code>\u8bbe\u5b9a\u7684\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u5c5e\u6027\u7684\u503c\uff0c\u540c\u65f6\u91cd\u8bbe\u4e00\u4e2a\u5728\u5c5e\u6027\u6587\u4ef6\u4e2d\u5df2\u7ecf\u8bbe\u5b9a\u7684\u66f4\u4f4e\u4f18\u5148\u7ea7\u7684\u5c5e\u6027\u7684\u503c</p> <p><code>motd-attributes/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: motd-attributes\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\nnode.default['ipaddress'] = '1.1.1.1'\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode \"0644\"\nend\n</code></pre> <pre><code>$ kitchen converge\n\n$ kitchen login\n\nLast login: Fri Nov 29 03:09:32 2019 from 172.16.72.2\nWelcome to My Company\nIt's a wonderful day today!\nThe hostname of this node is default-centos65\nThe IP address of this node is 172.16.72.142\n</code></pre> <p>Perform a Chef run and check to see the resulting values:</p> <ul> <li>\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684<code>mode['motd_attributes']['company'\uff3d</code>\u7684\u503c<code>My Company</code>\u6bd4\u5c5e\u6027\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u7684\u503c<code>Chef</code>\u62e5\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\uff0c\u56e0\u6b64\u6a21\u677f\u4f7f\u7528\u4e86\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684\u503c\u3002 </li> <li> <p>\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684<code>node['ipaddeess'\uff3d</code>\u503c\u6bd4<code>ohai</code>\u81ea\u52a8\u8bbe\u5b9a\u7684<code>10.0.2.15</code>\u503c\u6709\u66f4\u4f4e\u4f18\u5148 \u7ea7\uff0c\u56e0\u6b64\u5728\u914d\u65b9\u5355\u4e2d\u8bbe\u5b9a\u7684\u503c\u88ab\u5ffd\u7565\uff0c\u6a21\u677f\u4f7f\u7528\u4e86\u9ad8\u4f18\u5148\u7ea7\u7684\u503c\u3002 </p> </li> <li> <p>\u8fd9\u4e9b\u4f18\u5148\u7ea7\u4f53\u73b0\u4e86\u53d8\u91cf\u7684\u4f7f\u7528\u65b9\u6cd5\u5728\u5c5e\u80dc\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u7684\u503c\u88ab\u8bbe\u8ba1\u4e3a\u53ef\u4ee5\u88ab\u914d\u65b9\u5355\u8986\u76d6</p> </li> <li>\u800c\u7531<code>ohai</code>\u751f\u6210\u7684\u81ea\u52a8\u5c5e\u80dc\u5219\u4e0d\u4f1a\u88ab\u4efb\u4f55\u5c5e\u6027\u8986\u76d6\uff0c\u56e0\u4e3a\u5b83\u4eec\u4ee3\u8868\u91cd\u8981\u7684\u4e0d\u5e94\u88ab\u7be1\u6539\u7684\u7cfb\u7edf\u4fe1\u606f\uff0c\u6bd4\u5982<code>IP</code>\u5730\u5740\u3002 </li> </ul>"},{"location":"chap1/chef_tutorial7_attributes/#5include_recipe","title":"5\u3001<code>Include_Recipe</code>","text":"<p>\u4f60\u53ef\u80fd\u4f1a\u60f3<code>Chef</code>\u8fd9\u6837\u7684\u5c5e\u6027\u4f18\u5148\u7ea7\u673a\u5236\u6709\u6ca1\u6709\u5fc5\u8981\u8fd9\u662f\u56e0\u4e3a\u548c\u5f88\u591a\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u4e00\u6837\uff0c<code>Chef</code>\u914d\u65b9\u5355\u53ef\u4ee5\u901a\u8fc7<code>include_recipe</code>\u8bed\u53e5\u5f15\u7528\u5176\u4ed6<code>Chef</code>\u914d\u65b9\u5355\u3002</p> <p>\u5f53<code>Chef</code>\u8fd0\u884c\u5e76\u5904\u7406<code>Chef</code>\u4ee3\u7801\u65f6\uff0c\u5b83\u53ef\u80fd\u5305\u542b\u5bf9\u8bb8\u591a\u4e0d\u540c\u7684\u914d\u65b9\u5355\uff08\u751a\u81f3\u5728\u5176\u4ed6\u83dc\u8c31\u4e2d\u7684\u914d\u65b9\u5355\uff09\u7684\u5f15\u7528.</p> <p>\u7531\u4e8e\u4f60\u53ef\u4ee5\u4f7f\u7528<code>include_recipe</code>\uff0c\u6240\u4ee5<code>Chef</code>\u4ee3\u7801\u53ef\u80fd\u4f1a\u5305\u542b\u4e92\u76f8\u51b2\u7a81\u7684\u5c5e\u6027\u5b9a\u4e49\uff0c\u8fd9\u6837\u4fbf\u9700\u8981\u4e00\u4e2a\u51c6\u5219\u6765\u51b3\u5b9a\u76f8\u51b2\u7a81\u7684\u5c5e\u6027\u5728\u5b9a\u4e49\u65f6\uff0c\u54ea\u4e2a\u4f1a\u80dc\u51fa\u3002 </p> <p></p> <p>\u8bf4\u660e\uff1a\u5f88\u591a<code>Chef</code>\u7528\u6237\u9075\u5faa\u4e00\u4e2a\u51c6\u5219\uff0c\u5c06\u914d\u65b9\u5355\u4ee3\u7801\u7684\u957f\u5ea6\u9650\u5236\u5728\u4e00\u4e2a\u5c4f\u5e55\u80fd\u663e\u793a\u51fa\u6765\u7684\u8303\u56f4\u5185 &gt; (20\u591a\u884c\uff09\u4ee5\u4f7f\u4ee3\u7801\u53ef\u8bfb\u3002\u66f4\u957f\u7684\u4ee3\u7801\u901a\u5e38\u53ef\u4ee5\u8003\u8651\u6839\u636e\u4ee3\u7801\u5757\u7684\u7528\u9014\u5206\u5272\u6210\u591a\u4e2a\u4e0d\u540c\u7684\u914d\u65b9\u5355&gt; \u6587\u4ef6\uff0c\u7136\u540e\u4f7f\u7528<code>include_ recip</code>\u6765\u5305\u542b\u8fd9\u4e9b\u914d\u65b9\u5355 </p> <p>\u5728\u4f7f\u7528<code>include_recipe</code>\u8bed\u53e5\u65f6\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528\u548c\u5728\u8fd0\u884c\u6e05\u8349\u4e2d\u4e00\u6837\u7684\u683c\u5f0f\uff1a<code>\"\uff1c\u83dc\u8c31&gt;::&lt;\u914d\u65b9\u5355\uff1e\"</code>\u3002\u6bd4\u5982\"<code>motd-attributes::message</code>\"</p> <p>Chef\u5f00\u53d1\u5305</p> <pre><code>chef generate recipe message\n</code></pre> <p>Chef Client - Linux/Mac OS X:</p> <pre><code>touch recipes/message.rb\n</code></pre> <pre><code>$ chef generate recipe message\nRecipe: code_generator::recipe\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/spec/unit/recipes] action create (up to date)\n  * cookbook_file[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/spec/spec_helper.rb] action create_if_missing (up to date)\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/spec/unit/recipes/message_spec.rb] action create_if_missing\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/spec/unit/recipes/message_spec.rb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/spec/unit/recipes/message_spec.rb from none to 6d73b3\n    (diff output suppressed by config)\n  * directory[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/test/integration/default] action create (up to date)\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/test/integration/default/message_test.rb] action create_if_missing\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/test/integration/default/message_test.rb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/test/integration/default/message_test.rb from none to 456a77\n    (diff output suppressed by config)\n  * template[/Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/recipes/message.rb] action create\n    - create new file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/recipes/message.rb\n    - update content in file /Users/.../Devops_sap/Chef_Doc/learningchef/chap08/motd-attributes/recipes/message.rb from none to f414d1\n    (diff output suppressed by config)\n</code></pre> <p><code>recipes/message.rb</code></p> <pre><code>#\n# Cookbook:: motd-attributes\n# Recipe:: message\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\n\nnode.default['motd-attributes']['company'] = 'the best company in the universe(This info from message.rb)'\n</code></pre> <p>\u63d0\u793a:</p> <p>\u6ce8\u610f\uff0c\u6211\u4eec<code>kitchen.yml</code>\u6587\u4ef6\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u4ecd\u7136\u53ea\u4f7f\u7528\u4e86<code>default</code>\u914d\u65b9\u5355\u3002\u56e0\u4e3a\u6211\u4eec\u4e0d\u60f3\u8ba9\u4eba\u4eec\u76f4\u63a5\u4f7f\u7528<code>message</code>\u914d\u65b9\u5355\u3002 </p> <p>\u53ea\u662f\u4f7f\u7528<code>message</code>\u914d\u65b9\u5355\u6765\u7ec4\u7ec7\u4ee3\u7801\uff0c\u4f7f\u5176\u53ef\u8bfb\uff0c\u5bb9\u6613\u7ba1\u7406\u3002\u56e0\u6b64, \u6211\u4eec\u9700\u8981\u5728<code>default</code>\u914d\u65b9\u5355\u4e2d\u4f7f\u7528<code>include_recipe</code>\u6765\u5f15\u7528\u9700\u8981\u5f15\u7528\u7684\u914d\u65b9\u5355\uff0c \u800c\u603b\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u53ea\u6709<code>default</code>\u914d\u65b9\u5355 </p> <pre><code>...\n  run_list:\n    - recipe[motd-attributes::default]\n...\n</code></pre> <p>\u6709\u4e9b<code>Chef</code>\u7528\u6237\u5c06\u201c\u79c1\u6709\u201d\u7684\u914d\u65b9\u5355\u6587\u4ef6\u4ee5\u4e0b\u5212\u7ebf\u5f00\u5934\uff08\"-\u201c\uff09\u4f5c\u4e3a\u4e00\u4e2a\u7ea6\u5b9a\u6765\u533a\u5206\u516c\u5f00\u548c\u79c1\u6709\u7684\u914d\u65b9\u5355\u6587\u4ef6 \u3002\u4ed6\u4eec\u540c\u65f6\u5c06\u8fd9\u4e2a\u914d\u65b9\u5355\u6587\u4ef6\u547d\u540d\u4e3a<code>\u201dmessage.rb\u201c</code>\uff0c\u4f7f\u5176\u79c1\u6709\u6027\u5728\u83dc\u8c31\u7684\u6587\u4ef6\u7ed3\u6784\u4e2d\u663e\u5f97\u66f4\u660e\u663e\u3002 </p> <p>end:</p> <pre><code>node.default['ipaddress'] = '1.1.1.1'\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ninclude_recipe 'motd-attributes::message'\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode '0644'\nend\n</code></pre> <p>You need to add an include_recipe statement to your <code>default.rb</code>.</p> <p><code>recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: motd-attributes\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\nnode.default['ipaddress'] = '1.1.1.1'\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ninclude_recipe 'motd-attributes::message'\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode \"0644\"\nend\n</code></pre> <p><code>include_recipe</code>\u8bed\u53e5\u53ef\u4ee5\u653e\u5728\u914d\u65b9\u5355\u6587\u4ef6\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5f53<code>Chef</code>\u5904\u7406\u8fd9\u4e9b\u4ee3\u7801\u65f6<code>include_recipe</code>\u5c06\u88ab\u66ff\u6362\u4e3a\u5b83\u6240\u5f15\u7528\u7528\u7684\u914d\u65b9\u5355\u4ee3\u7801</p> <p></p>"},{"location":"chap1/chef_tutorial7_attributes/#_2","title":"\u540c\u4e2a\u4f18\u5148\u7ea7\u540c\u4e2a\u5c5e\u6027\u88ab\u591a\u6b21\u8bbe\u5b9a\u65f6\uff0c\u6700\u540e\u8bbe\u5b9a\u7684\u503c\u80dc\u51fa","text":"<p>\u5728\u672c\u4f8b\u4e2d\uff0c\u5728<code>include_recipe</code>\u5f15\u7528\u5c55\u5f00\u540e\uff0c<code>node.defau1t[\"motd-attributes\"][\"company\"]</code>\u5c5e\u6027\u88ab\u8bbe\u5b9a\u4e86\u4e24\u6b21\uff1b</p> <p>\u5728<code>template</code>\u8d44\u6e90\u5e94\u7528\u4e4b\u524d\u6700\u540e\u88ab\u8bbe\u5b9a\u7684\u4e00\u4e2a\u80dc\u51fa\uff0c\u5373<code>\u201cthe best company in the universe(This info from message.rb)\"</code>: </p> <pre><code>$ kitchen converge\n\n$ kitchen login\nLast login: Fri Nov 29 06:27:57 2019 from 172.16.72.2\nWelcome to the best company in the universe(This info from message.rb)\nIt's a wonderful day today!\nThe hostname of this node is default-centos65\nThe IP address of this node is 172.16.72.142\n</code></pre>"},{"location":"chap1/chef_tutorial7_attributes/#6","title":"6\u3001\u5c5e\u6027\u4f18\u5148\u7ea7","text":"<p>\u4e09\u4e2a\u6700\u5e38\u7528\u7684\u5c5e\u6027\u4f18\u5148\u7ea7\u522b\uff1a </p> <p>\u81ea\u52a8(<code>Autormatic</code>)</p> <p>\u81ea\u52a8\u5c5e\u6027\u4e3a<code>ohai</code>\u6240\u751f\u6210\u7684\u5c5e\u6027\u3002 </p> <p>\u9ed8\u8ba4(<code>Default</code>) </p> <p>\u901a\u5e38\u7531\u83dc\u8c31\u53ca\u5c5e\u6027\u6587\u4ef6\u8bbe\u5b9a\u7684\u5c5e\u6027\u3002 </p> <p>\u91cd\u5199(<code>Override</code>)</p> <p>\u6700\u5f3a\u7684\u5c5e\u6027\u8bbe\u5b9a\u65b9\u6cd5\uff0c\u52a1\u5fc5\u8bf7\u8c28\u614e\u4f7f\u7528\u3002  </p> <p></p> <p>\u5728\u83dc\u8c31\u4e2d\u8bbe\u5b9a\u4e00\u4e2a\u5c5e\u6027\u65f6\uff0c\u901a\u5e38\u5e94\u8be5\u8bbe\u4e3a\u9ed8\u8ba4\u5c5e\u6027\u3002\u8fd9\u4e2a\u89c4\u5219\u6709\u4e00\u4e2a\u4f8b\u5916\uff0c\u5373\u5f53\u4f7f\u7528\u73af\u5883\u65f6\u4f7f\u7528<code>override</code>\u4f18\u5148\u7ea7\u3002</p> <p>\u9664\u4e86\u4f7f\u7528\u201c\u73af\u5883\u201d\u7684\u7279\u4f8b\u4e4b\u5916\uff0c\u5c5e\u6027\u4f18\u5148\u7ea7\u591a\u81ea\u5b9a\u4e49<code>Chef</code>\u7684\u65f6\u5019\u3002\u5728<code>Chef</code>\u4e2d\u5b9e\u73b0\u4e00\u4e2a\u65b0\u7684\u529f\u80fd\uff08\u6bd4\u5982\u81ea\u5b9a\u4e49\u8d44\u6e90\uff09\u65f6\uff0c<code>Chef</code>\u5f3a\u5927\u7684\u5c5e\u6027\u4f18\u5148\u7ea7\u5f15\u64ce\u80fd\u5e2e\u52a9\u4f60\u9075\u5faa\u672c\u7ae0\u8bb2\u8ff0\u7684\u57fa\u672c\u5c5e\u6027\u4f18\u5148\u7ea7\u529f\u80fd\u4e3a\u5176\u8bed\u8a00\u6dfb\u52a0\u65b0\u7684\u529f\u80fd\u3002</p>"},{"location":"chap1/chef_tutorial7_attributes/#7","title":"7\u3001\u5c5e\u6027\u6392\u9519","text":"<p>\u5982\u679c\u9700\u8981\u4e3a\u5c5e\u6027\u62cd\u9519\uff0c\u6bd4\u5982\u627e\u5230\u4ed6\u4eec\u54ea\u91cc\u8bbe\u5b9a\uff0c<code>node</code>\u5bf9\u8c61\u63d0\u4f9b\u7684<code>node.debug_value()</code>\u65b9\u6cd5\u80fd\u7ed9\u4e0e\u5f88\u591a\u5e2e\u52a9\u3002</p> <p>\u6bd4\u5982\u5982\u679c\u4f60\u4e0d\u77e5\u9053<code>ohai</code>\u8bbe\u5b9a\u4e86\u81ea\u52a8\u5c5e\u6027<code>node['ipaddress']</code>\u5f97\u77e5\u5b83\u662f\u7531\u3002\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>node.debug_value()</code>\u5f97\u77e5\u7531<code>ohai</code>\u8bbe\u5b9a\u7684</p> <p>\u4fee\u6539<code>recipes/default.rb</code>\u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528<code>Ruby</code>\u7684pp\u7a0b\u5e8f\uff0c<code>pp</code>\u7a0b\u5e8f\u53ef\u4ee5\u5c06\u5bf9\u8c61<code>Ruby</code>\u4ee5\u53ef\u8bfb\u6027\u5f3a\u683c\u5f0f\u6253\u5370\u51fa\u6765\u3002<code>node.debug_value()</code>\u8fd4\u56de\u5bf9\u8c61\u7684\u5185\u5bb9\uff0c pp\u8f93\u51fa\u6709\u8f83\u5f3a\u7684\u53ef\u8bfb\u6027 </p> <pre><code>#\n# Cookbook:: motd-attributes\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\n\nrequire 'pp'\nnode.default['ipaddress'] = '1.1.1.1'\npp node.debug_value('ipaddress')\n\nnode.default['motd-attributes']['company'] = 'My Company'\nnode.default['motd-attributes']['message'] = \"It's a wonderful day today!\"\n\ninclude_recipe 'motd-attributes::message'\n\ntemplate '/etc/motd' do\n  source 'motd.erb'\n  mode \"0644\"\nend\n</code></pre> <pre><code>$ kitchen converge\n...\n Installing Cookbook Gems:\n       Compiling Cookbooks...\n       [[\"default\", \"1.1.1.1\"],\n        [\"env_default\", :not_present],\n        [\"role_default\", :not_present],\n        [\"force_default\", :not_present],\n        [\"normal\", :not_present],\n        [\"override\", :not_present],\n        [\"role_override\", :not_present],\n        [\"env_override\", :not_present],\n        [\"force_override\", :not_present],\n        [\"automatic\", \"172.16.72.142\"]]\n       Converging 1 resources\n       Recipe: motd-attributes::default\n         * template[/etc/motd] action create (up to date)\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 0/1 resources updated in 01 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m6.47s).\n</code></pre> <p>\u4ece\u8fd9\u91cc\uff0c \u53ef\u4ee5\u770b\u51fa<code>node[ipaddress]</code>]\u5c5e\u6027\u5728<code>automatic</code>\u4f18\u5148\u7ea7\u88ab\u8bbe\u5b9a\u4e3a<code>\"172.16.72.142\"</code>,\u5728<code>default</code>\u4f18\u5148\u7ea7\u88ab\u8bbe\u5b9a\u4e3a\"<code>1.1.1.1</code>\"</p> <p><code>Chef</code>\u7684\u786e\u5904\u7406\u4e86\"<code>1.1.1.1</code>\"\u8fd9\u4e2a\u503c\uff0c\u4f46\u6700\u7ec8\u7ed3\u679c\u88ab\u9ad8\u4f18\u5148\u7ea7\u7684\u81ea\u52a8\u5c5e\u6027\u8986\u76d6\u3002</p> <p>\u8981\u4e3a\u540c\u4e2a\u4f18\u5148\u7ea7\u522b\u88ab\u591a\u6b21\u8bbe\u5b9a\u7684\u5c5e\u6027\u6392\u9519\u6bd4\u5728\u4e0d\u540c\u4f18\u5148\u7ea7\u522b\u8bbe\u5b9a\u7684\u65f6\u5019\u590d\u6742\u4e00\u4e9b</p> <p>\u4f46\u4ecd\u7136\u975e\u5e38\u53ef\u884c\u3002\u4f60\u53ea\u9700\u8981\u5728<code>include_recipe</code>\u524d\u540e\u5206\u522b\u6253\u5370<code>node.debug_value(\uff09</code>\u7684\u503c\u3002 </p> <p>\u6bd4\u5982\uff0c\u5047\u8bbe\u6211\u4eec\u4e0d\u77e5\u9053<code>motd-attributes::message</code>\u914d\u65b9\u5355\u8bbe\u5b9a\u4e86<code>motd-attributes::message</code>\u5c5e\u6027\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u5728<code>recipes/default.rb</code>\u4e00\u4e2d\u591a\u6b21\u6253\u5370<code>node.debug_value()</code> \u7684\u503c\uff0c\u5728<code>include_recipe</code>\u524d\u540e\u5206\u522b\u6253\u5370<code>node.debug_value('motd-attributes','company')</code></p> <pre><code>...\n  Compiling Cookbooks...\n       [[\"default\", \"1.1.1.1\"],\n        [\"env_default\", :not_present],\n        [\"role_default\", :not_present],\n        [\"force_default\", :not_present],\n        [\"normal\", :not_present],\n        [\"override\", :not_present],\n        [\"role_override\", :not_present],\n        [\"env_override\", :not_present],\n        [\"force_override\", :not_present],\n        [\"automatic\", \"172.16.72.142\"]]\n       [[\"default\", \"My Company\"],\n        [\"env_default\", :not_present],\n        [\"role_default\", :not_present],\n        [\"force_default\", :not_present],\n        [\"normal\", :not_present],\n        [\"override\", :not_present],\n        [\"role_override\", :not_present],\n        [\"env_override\", :not_present],\n        [\"force_override\", :not_present],\n        [\"automatic\", :not_present]]\n       [[\"default\", \"the best company in the universe(This info from message.rb)\"],\n        [\"env_default\", :not_present],\n        [\"role_default\", :not_present],\n        [\"force_default\", :not_present],\n        [\"normal\", :not_present],\n        [\"override\", :not_present],\n        [\"role_override\", :not_present],\n        [\"env_override\", :not_present],\n        [\"force_override\", :not_present],\n        [\"automatic\", :not_present]]\n       Converging 1 resources\n       Recipe: motd-attributes::default\n         * template[/etc/motd] action create (up to date)\n...\n</code></pre> <p>From this output, you could sort out that something in<code>motd-attributes::message</code> recipe set the attribute <code>node['motd-attributes']['company']</code> to <code>\"the best company in the universe\" using the default precedence</code>, overriding what was set earlier.</p> <pre><code>$ kitchen destroy\n-----&gt; Starting Kitchen (v2.3.3)\n-----&gt; Destroying &lt;default-centos65&gt;...\n       ==&gt; vagrant: A new version of Vagrant is available: 2.2.6 (installed version: 2.2.5)!\n       ==&gt; vagrant: To upgrade visit: https://www.vagrantup.com/downloads.html\n\n       ==&gt; default: Stopping the VMware VM...\n       ==&gt; default: Deleting the VM...\n       Vagrant instance &lt;default-centos65&gt; destroyed.\n       Finished destroying &lt;default-centos65&gt; (0m23.58s).\n-----&gt; Kitchen is finished. (0m24.15s)\n</code></pre>"},{"location":"chap1/chef_tutorial7_attributes/#8","title":"8\u3001\u5c0f\u7ed3","text":"<p>\u5c5e\u6027\u53ef\u4ee5\u5728\u591a\u5904\u8bbe\u5b9a</p> <ul> <li><code>ohai</code>\u81ea\u52a8\u8bbe\u5b9a </li> <li>\u5c5e\u6027\u6587\u4ef6 </li> <li>\u914d\u65b9\u5355 </li> <li>\u5176\u4ed6\u83dc\u8c31 </li> </ul> <p>\u7531\u4e8e\u5c5e\u6027\u53ef\u4ee5\u5728\u591a\u5904\u8bbe\u5b9a\uff0c\u6240\u4ee5<code>Chef</code>\u5b9a\u4e49\u4e86\u4f18\u5148\u7ea7\u65b9\u6848\u6765\u63a7\u5236\u591a\u5904\u8bbe\u5b9a\u5c5e\u6027\u5982\u4f55\u8c03\u7528\u8bbe\u5b9a\u5c5e\u6027\u65f6\uff0c<code>automatic</code>,<code>default</code>\u548c<code>override</code>\u6765\u63a7\u5236\u5c5e\u6027\u7684\u4f18\u5148\u7ea7\u3002 \u603b\u7684\u6765\u8bf4\uff0c\u4f1a\u7528\u5230<code>default</code>\u4f18\u5148\u7ea7\uff0c\u9664\u975e\u6709\u7279\u522b\u9700\u6c42\u6216\u9700\u8981\u81ea\u5b9a\u4e49Chef.</p> <ul> <li>Chef\u5f00\u53d1\u5305</li> </ul> <pre><code>$ chef generate cookbook motd-attributes\n</code></pre> <ul> <li>Chef\u5ba2\u6237\u7aef</li> </ul> <pre><code>$ knife cookbook create motd-attributes --cookbook-path .\n$ cd motd-attributes\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <pre><code>$ kitchen list\n\n$ kitchen converge\n\n$ kitchen login\n</code></pre> <pre><code>$ chef generate attribute default #chef-dk\n$ touch attributes/default.rb  #chef-client\n\n$ chef generate recipe message  #chef-dk\n$ touch recipes/message.rb  #chef-client\n</code></pre> <p>Chef\u5f00\u53d1\u5305</p> <pre><code>chef generate recipe message\n</code></pre>"},{"location":"chap1/chef_tutorial8/","title":"\u7b2c\u516b\u8282 Chef \u670d\u52a1\u5668\u540c\u65f6\u7ba1\u7406\u591a\u4e2a\u8282\u70b9","text":"<ul> <li>\u4f7f\u7528\u83dc\u8c31\u6765\u81ea\u52a8\u5316\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668 </li> <li>\u5e42\u7b49\u6027\u7b80\u4ecb(<code>Idempotence</code>)</li> <li>\u914d\u7f6e\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668 </li> <li>\u51c6\u5907\u4e00\u4e2a\u65b0\u8282\u70b9(<code>chef-client</code>)</li> <li>\u7528<code>Knife</code>\u542f\u52a8\u5e76\u51c6\u5907\u8282\u70b9</li> <li>\u7528<code>Chef Solo</code>\u914d\u7f6e<code>Chef</code>\u670d\u52a1\u5668 </li> </ul> <p><code>Chef</code>\u670d\u52a1\u5668\u662f\u4f60\u57fa\u7840\u67b6\u6784\u914d\u7f6e\u6570\u636e\u7684\u4e2d\u592e\u5b58\u50a8\u3002\u5b83\u5b58\u50a8\u5e76\u7d22\u5f15\u83dc\u8c31\u3001\u73af\u5883\u3001\u6a21\u677f\u3001\u5143\u6570 \u636e\u3001\u6587\u4ef6\u548c\u5206\u5e03\u7b56\u7565\u3002<code>Chef</code>\u670d\u52a1\u5668\u5305\u542b\u6240\u6709\u5176\u7ba1\u7406\u7684\u673a\u5668\u7684\u4fe1\u606f\u3001\u3002 </p> <p><code>Chef</code>\u670d\u52a1\u5668\u540c\u65f6\u5305\u542b\u4e00\u4e2a\u9875\u9762\u670d\u52a1\u5668\uff0c \u83dc\u8c31\u5b58\u50a8\uff0c \u7f51\u9875\u754c\u9762\uff0c \u6d88\u606f\u961f\u5217\u4ee5\u53ca\u540e\u7aef\u6570\u636e\u5e93</p> <p></p> <p>\u7f51\u7edc\u80ed\u52a1\u5668 </p> <p><code>nginx</code>\u7f51\u7edc\u670d\u52a1\u5668\u662f\u4e2a\u7b80\u5355\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\uff0e<code>Chef</code>\u670d\u52a1\u5668\u7528\u5b83\u4f5c\u4e3a\u524d\u7aef\u7684\u754c\u9762\uff0c\u5b83\u540c\u65f6\u4e3a<code>chef</code>\u670d\u52a1\u5668\u63d0\u4f9b\u8d1f\u8f7d\u5e73\u8861\u3002\u6240\u6709\u5230<code>Chef</code>\u670d\u52a1\u5668\u7684<code>API</code>\u8bf7\u6c42\u90fd\u901a\u8fc7<code>nginx</code>\u670d\u52a1\u5668\u6765\u8def\u7531\u3002 </p> <p>WebUI</p> <p><code>WebUI</code>\u662f\u9762\u5411\u7528\u6237\u7684\u7f51\u9875\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u4e00\u4e2a\u4ece\u7f51\u9875\u4e0a\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u4ea4\u4e92\u7684\u754c\u9762\u3002\u5b83\u662f\u4e2a<code>Ruby on Rails</code>\u5e94\u7528\u7a0b\u5e8f</p> <p><code>Chef</code>\u52a1\u5668(<code>Erchef</code>) </p> <p><code>Erehef</code>\u662f<code>Chef</code>\u670d\u52a1\u5668\u8d1f\u8d23\u5904\u7406<code>API</code>\u8bf7\u6c42\u7684\u7ec4\u4ef6\u3002 <code>Chef</code>\u670d\u52a1\u5668\u7528\u6237<code>Erlang</code>\u7f16\u7a0b\u8bed\u8a00\u5199\uff0c\u652f\u6301\u9ad8\u4e95\u53d1\u548c\u9ad8\u53ef\u9760\u6027\u3002<code>Erehef</code>\u662f<code>Chef</code>\u670d\u52a1\u5668\u7684\u6838\u5fc3<code>API</code></p> <p><code>Bookshelf</code></p> <p><code>Bookshelf</code>\u662f\u6240\u6709<code>Chef</code>\u83dc\u8c31\u548c\u83dc\u8c31\u5185\u5bb9(\u6bd4\u5982\u6587\u4ef6\u3001\u6a21\u677f\uff0c \u5b9a\u4e49\u5143\u6570\u636e\u548c\u914d\u65b9\u5355\uff09\u7684\u4e2d\u592e\u5b58\u50a8\u3002<code>Bookshelf</code>\u662f\u4e00\u4e2a\u5e73\u5766\u7684\u6587\u4eec\u6570\u636e\u5e93, \u4e95\u7279\u610f\u5b58\u50a8\u4e8e<code>Chef</code>\u670d\u52a1\u5668\u7684\u7d22\u5f15\u4e4b\u5916 </p> <p>\u641c\u7d22\u7d22\u5f15 </p> <p>\u641c\u7d22\u7d22\u5f15\u662f\u4e2a<code>Apache Solr</code>\u670d\u52a1\u5668\uff0c \u5b83\u8d1f\u8d23\u5185\u90e8\u548c\u5916\u90e8\u8bb8\u591a<code>API</code>\u8bf7\u6c42\u7684\u7d22\u5f15\u548c\u641c\u7d22\u3002\u641c\u7d22\u7d22\u5f15\u670d\u52a1\u548c\u5916\u754c\u4ea4\u4e92\u7684\u7ec4\u4ef6\u53eb<code>chef-solr</code> \u5b83\u63d0\u4f9b<code>Restful</code>\u7684<code>API</code> </p> <p>\u6d88\u606f\u961f\u5217 </p> <p>\u6b64\u961f\u5217\u7cfb\u7edf\u5904\u7406\u6240\u6709\u88ab\u53d1\u9001\u5230\u641c\u7d22\u7d22\u5f15\u7684\u6d88\u606f\u3002\u8fd9\u4e9b\u961f\u5217\u7531\u5f00\u6e90\u7684<code>RabbitMQ</code>\u961f\u5217\u7cfb\u7edf\u7ba1\u7406\u3002<code>chef-expander</code>\u4ece\u6d88\u606f\u5bf9\u5217\u4e2d\u83b7\u53d6\u6d88\u606f\uff0c \u7136\u540e\u53d1\u9001\u81f3\u641c\u7d22\u7d22\u5f15\u3002 </p> <p>\u6570\u636e\u5e93</p> <p><code>Chef</code>\u4f7f\u7528<code>PostgreSQL</code>\u6765\u5b58\u50a8\u6570\u636e\u3002\u5728<code>Chef 11</code>\u4e4b\u524d, \u4e3b\u8981\u6570\u636e\u5e93\u4e3a<code>CouchDB</code>\u4f46\u540e\u6765 \u7531\u4e8e<code>CouchDB</code>\u7684\u4f38\u7f29\u6027\u95ee\u9898<code>PostgreSQL</code>\u4ee3\u66ff</p> <p>How to Install Enterprise Chef Server Manually</p>"},{"location":"chap1/chef_tutorial8/#1chef-server","title":"1\u3001\u624b\u52a8\u5b89\u88c5<code>chef-Server</code>","text":"<p>Go to http://www.getchef.com/contact/on-premises and provide your contact information to receive download details and installation instructions for Enterprise Chef Server.</p> <p></p>"},{"location":"chap1/chef_tutorial8/#2-chef","title":"2\u3001\u4f7f\u7528\u83dc\u8c31\u6765\u81ea\u52a8\u5316\u5b89\u88c5\u4f01\u4e1a Chef \u670d\u52a1\u5668","text":"<p>\u5047\u8bbe\u4f60\u6709\u8db3\u591f\u7684\u7cfb\u7edf\u8d44\u6e90\u5728\u672c\u5730\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668\u4ee5\u53ca\u914d\u7f6e\u4e00\u4e2a\u6d4b\u8bd5\u8bd5\u8282\u70b9\uff0c\u521b\u5efa\u4e00\u4e2a<code>enterprise-chef</code>(chef-workstation)\u83dc\u8c31\u6765\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668\u3002</p> <p>\u4e3a\u4e86\u548c\u6258\u7ba1\u4f01\u4e1aChef\u4fdd\u6301\u4e00\u81f4\uff0c\u521b\u5efa<code>chef-repo/cookbooks</code>\u76ee\u5f55\u5e76\u5728\u76ee\u5f55\u4e2d\u521b\u5efa<code>enterprise</code>\u83dc\u8c31\u3002\u9876\u7ea7\u7684<code>chef-repo</code>\u76ee\u5f55\u53ef\u4ee5\u5b58\u653e\u7ba1\u7406\u4f01\u4e1a<code>Chef</code>\u6240\u9700\u8981\u7684\u9664\u83dc\u8c31\u4ee5\u5916\u7684\u5176\u4ed6\u6587\u4ef6\u3002\u56e0\u4e3a\u4f60\u4f1a\u4f7f\u7528\u82e5\u5e72\u4e2a\u83dc\u8c31\uff0c\u6240\u4ee5\u8fd9\u91cc\u5efa\u8bae\u5c06<code>enterprise</code>\u83dc\u8c31\u5b58\u653e\u5728<code>chef-repo/cookbooks</code>\u5b50\u76ee\u5f55\u5185\u3002 \u521b\u5efa<code>chef-repo/cookbooks</code>\u76ee\u5f55\u5e76\u5c06\u5b83\u4f5c\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u3002 </p> <p>Linux/Mac OS X:</p> <pre><code>$ mkdir -p chef-repo/cookbooks\n$ cd chef-repo/cookbooks\n</code></pre> <p>\u7136\u540e\u901a\u8fc7<code>chef generate cookbook</code>\u6216<code>knife cookbook</code> \u83dc\u8c31\uff08\u53d6\u51b3\u4e8e\u4f60\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\u8fd8\u662fChef\u5ba2\u6237\u7aef\uff09\u3002 </p> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook enterprise-chef\n$ cd enterprise-chef\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create enterprise-chef --cookbook-path .\n$ cd enterprise-chef\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p><code>enterprise-chef/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n      network:\n      - [\"private_network\", {ip: \"192.168.33.34\"}]\n      customize:\n        memory: 1536\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[enterprise-chef::default]\n    attributes:\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate attribute default\n</code></pre> <p>Chef Client:</p> <pre><code>$ touch attributes/default.rb\n</code></pre> <p><code>attributes/default.rb</code></p> <p>old:</p> <pre><code>default['enterprise-chef']['url'] = \\\n'https://s3.amazonaws.com/opscode-private-chef/el/6/x86_64/'\\\n'private-chef-11.1.8-1.el6.x86_64.rpm'\n</code></pre> <p>new chef-server-core:</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-server/13.1.13/el/6/chef-server-core-13.1.13-1.el6.x86_64.rpm'\n</code></pre> <p>new chef Management Console:</p> <p>https://downloads.chef.io/manage</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm'\n</code></pre> <p>finall version</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm\n</code></pre> <p><code>/enterprise-chef/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage_url = node['enterprise-chef']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\nremote_file package_local_path do\n  source package_url\nend\n\npackage package_local_path\n\n# reconfigure the installation\n# execute 'private-chef-ctl reconfigure'\nexecute 'chef-server-ctl reconfigure --chef-license=accept'\n# \"--chef-license=accept\"\n# STDOUT: Chef Infra Server cannot execute without accepting the license\n</code></pre> <p>\u5982\u679c\u4e0d\u60f3\u5728\u83dc\u8c31\u4e2d\u603b\u662f\u4f7f\u7528<code>node['enterprise-chef']['url'\uff3d</code>\u8fd9\u6837\u957f\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u5c06\u5176 \u5b58\u50a8\u5728\u4e00\u4e2a\u77ed\u7684\u672c\u5730\u53d8\u91cf\u4e2d\uff0c\u6bd4\u5982\uff1a</p> <pre><code>package_url = node['enterprise-chef']['url']\n</code></pre> <p>\u8bb0\u4f4f\uff0c\u5728<code>Chef</code>\u914d\u65b9\u5355\u4e2d\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528Ruby\u7f16\u7a0b\u8bed\u8a00\u63d0\u4f9b\u7684\u4efb\u4f55\u529f\u80fd\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u4f7f\u7528<code>::File.basename(\uff09</code> \u65b9\u6cd5\u6765\u4ece\u4e0b\u8f7d<code>URL</code>\u4e2d\u63d0\u53d6\u5b89\u88c5\u5305\u7684\u540d\u5b57\u3002 </p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5b89\u88c5\u5305\u7684\u540d\u5b57\u662fURL\u4e2d\u6700\u540e\u4e00\u4e2a\u659c\u6760\u540e\u7684\u7ec4\u4ef6\uff1a<code>'private-chef-11.1.8-1.el6.x86_64.rpm</code> \u5982\u679c\u60f3\u8fdb\u4e00\u6b65\u4e86\u89e3<code>Ruby</code>\u7684<code>::File</code>\u7c7b\uff0c\u53ef\u4ee5\u8bbf\u95ee<code>Ruby</code>\u6838\u5fc3<code>API</code>\u6587\u6863</p> <pre><code>package_name = ::File.basename(package_url)\n</code></pre> <p>\u4e0d\u5e78\u7684\u662f\uff0c\u6211\u4eec\u719f\u6089\u7684<code>package</code>\u8d44\u6e90\u5e76\u4e0d\u63a5\u53d7\u901a\u8fc7\u6307\u5b9a\u8fdc\u7a0b<code>URL</code>\u6765\u5b89\u88c5\u7a0b\u5e8f\u5305\uff0c\u6240\u4ee5\u8fd9\u91cc\u8981\u4ecb\u7ecd\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90:<code>remote_file</code>\u8d44\u6e90\u3002</p> <p><code>remote_file</code>\u8d44\u6e90\u63d0\u4f9b\u4ece\u8fdc\u7a0b\u4e0b\u8f7d\u6587\u4ef6\u7684\u529f\u80fd\u6211\u4eec\u5728\u6b64\u8981\u901a\u8fc7<code>remote_file</code>\u8d44\u6e90\u4ece\u8fdc\u7a0b<code>URL</code> \u4e0b\u8f7d\u5b89\u88c5\u5305\uff0c\u5e76\u7528<code>package</code>\u8d44\u6e90\u5b89\u88c5\u672c\u5730\u7684\u5b89\u88c5\u5305\u3002</p> <p>\u6211\u4eec\u9700\u8981\u5148\u5c06\u5b89\u88c5\u5305\u4e0b\u8f7d\u5230\u4e00\u4e2a\u4e34\u65f6\u4f4d\u7f6e\u3002\u4e0e\u5176\u4f7f\u7528\u56fa\u5b9a\u7684\u4e34\u65f6\u4e0b\u8f7d\u4f4d\u7f6e (\u5982<code>\"/tmp\"</code>)\uff0c\u4e0d\u5982\u7528<code>Chef</code>\u63d0\u4f9b\u7684\u4e00\u4e2a\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684\u53d8\u91cf\uff1a<code>Chef::Config[:file_cache_path]</code>\u3002\u901a\u8fc7\u8fd9\u4e2a\u53d8\u91cf\uff0c<code>Chef</code>\u7edd\u5bf9\u5b9a\u6700\u4f73\u7684\u4e34\u65f6\u5b58\u50a8\u4f4d\u7f6e\u3002\u5c06\u6240\u8981\u7684\u4e34\u65f6\u5b58\u50a8\u4f4d\u7f6e\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9<code>remote_file</code>\uff0c\u5e76\u5c06\u8fdc\u7a0b<code>URL</code>\u4f5c\u4e3a<code>source</code>\u5c5e\u6027\u4f20\u9012 </p> <p>\u5728\u6267\u884c<code>chef-server-ctl reconfigure</code>\u524d\uff0c\u6211\u4eec\u9700\u8981\u4ecb\u7ecd\u53e6\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90\uff1a<code>execute</code>\u8d44 \u6e90\u3002\u6709\u65f6\uff0c\u65e0\u6cd5\u627e\u5230\u4e00\u4e2a\u73b0\u6709\u7684\u8d44\u6e90\u6ee1\u8db3\u81ea\u5df1\u9700\u6c42\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528<code>execute</code>\u8d44\u6e90\u6765\u6267\u884c\u4efb\u610f\u547d\u4ee4\u3002\u4f60\u53ea\u9700\u8981\u5c06\u60f3\u6267\u884c\u7684\u547d\u4ee4\u5b57\u7b26\u4e32\u4f20\u9012\u81f3<code>execute</code>\u8d44\u6e90\u3002 </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n\n$ kitchen converge default-centos65\n\n$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action  Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        Converged    &lt;None&gt;\n\n$  kitchen login default-centos65\nLast login: Sun Dec  1 09:07:26 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n\n$ rpm -q chef-server-core\nchef-server-core-13.1.13-1.el6.x86_64\n\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre>"},{"location":"chap1/chef_tutorial8/#3idempotence","title":"3\u3001\u5e42\u7b49\u6027\u7b80\u4ecb(Idempotence)","text":"<p>\u867d\u7136\u6211\u4eec\u5199\u7684\u914d\u65b9\u5355\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u7248\u672c\u4e00\u53ef\u4ee5\u8fbe\u6210\u6211\u4eec\u7684\u76ee\u7684\uff0c\u4f46\u5b83\u5e76\u4e0d\u5e42\u7b49\u3002</p> <p>\u5e42\u7b49\u7684<code>Chef</code>\u4ee3\u7801\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u91cd\u590d\u8fd0\u884c\u65e0\u6570\u6b21\u800c\u7ed3\u679c\u5b8c\u5168\u4e00\u6837\uff0c\u5e76\u4e0d\u4f1a\u56e0\u4e3a\u8fd0\u884c\u591a\u6b21\u800c\u4ea7\u751f\u4e0d\u540c\u7684\u6548\u679c\u3002\u51e0\u4e4e\u6240\u6709\u9ed8\u4e00\u8ba4\u7684<code>Chef</code>\u8d44\u6e90\u90fd\u4fdd\u8bc1\u5e42\u7b49\u6027\uff0c\u552f\u4e00\u7684\u4f8b\u5916\u662f<code>execute</code>\u8d44\u6e90\u3002 </p> <p><code>execute</code>\u8d44\u6e90\u4e00\u822c\u5e76\u4e0d\u5e42\u7b49\uff0c\u56e0\u4e3a\u5927\u591a\u6570\u547d\u4ee4\u884c\u5de5\u5177\u5047\u8bbe\u64cd\u4f5c\u5b83\u7684\u4eba\u4e86\u89e3\u7cfb\u7edf\u7684\u73b0\u72b6\u3002 \u6bd4\u5982\uff0c\u5047\u8bbe<code>/learningchef/files1.txt</code>\u6587\u4ef6\u5b58\u5728\uff0c\u4ee5\u4e0b<code>mv</code>\u547d\u4ee4\u5728\u7b2c\u4e00\u6b21\u8fd0\u884c\u65f6\u6709\u6548\uff0c\u4f46\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u65f6\u4f1a\u5931\u8d25\uff1a </p> <pre><code>$ mv /learningchef/file1.txt /file1.txt\n</code></pre> <p>\u6d4b\u8bd5<code>Chef</code>\u914d\u65b9\u5355\u662f\u5426\u5e42\u7b49\u7684\u4e00\u4e2a\u597d\u65b9\u6cd5\u662f\u8fd0\u884c<code>kitchen converge</code>\u4e24\u6b21\u3002\u4e00\u6b21\u8fd0\u884c\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u52a8\u4f5c\u65f6\uff0c\u8fd0\u884c\u7684\u7ed3\u679c\u5e94\u8be5\u663e\u793a<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0\u3002 </p> <p>Does our recipe pass the idempotency test? Sadly, no. Here\u2019s a sampling of the output from an initial kitchen converge:</p> <pre><code>$ kitchen converge default-centos65\n...\n Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[chef-server-ctl reconfigure --chef-license=accept] action run\n           - execute chef-server-ctl reconfigure --chef-license=accept\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/3 resources updated in 04 minutes 51 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (5m4.35s).\n</code></pre> <p>\u4ee5\u4e0b\u662f\u7b2c\u4e8c\u6b21\u8fd0\u884c\u7684\u8f93\u51fa<code>Chef</code>\u8ba4\u4e3a\u5b83\u4ecd\u7136\u9700\u8981\u540f\u65b0\u8d44\u6e90<code>3</code>\u4e2a\u8d44\u6e90\u4e2d\u7684<code>2</code>\u4e2a\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u65f6\u88ab\u66f4\u65b0\u3002\u5982\u679c\u914d\u65b9\u5e42\u7b49\uff0c\u6211\u4eec\u5e94\u8be5\u770b\u5230<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0<code>Chef</code>\u5e94\u8be5\u68c0\u67e5\u7cfb\u7edf\u72b6\u6001\u786e\u5b9a\u6ca1\u6709\u9700\u8981\u66f4\u65b0\u7684\u8d44\u6e90\uff1b </p> <pre><code>$ kitchen converge\n...\n Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[chef-server-ctl reconfigure --chef-license=accept] action run\n           - execute chef-server-ctl reconfigure --chef-license=accept\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/3 resources updated in 53 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (1m7.63s).\n-----&gt; Kitchen is finished. (1m8.27s)\n\n</code></pre> <p>\u50cf\u524d\u9762\u63d0\u53ca\u7684\u4e00\u6837, \u5927\u591a\u6570\u9ed8\u8ba4<code>Chef</code>\u8d44\u6e90\u662f\u5177\u5907\u5e42\u7b49\u6027\u3002\u6ce8\u610f<code>remote_file</code>\u3002\u8d44\u6e90\u662f\u5e42\u7b49\u7684\u3002\u4ece\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\u5b83\u6c47\u62a5\u4e86\uff08up to date)\u3002 <code>package</code>\u8d44\u6e90\u901a\u5e38\u4e5f\u662f\u5e42\u7b49\u7684.</p> <p>\u5728\u672c\u4f8b\u4e2d\uff0e\u6211\u4eec\u6545\u610f\u521b\u9020\u4e86\u4e00\u4e9b\u6e05\u5883\u4f7f\u5176\u5728<code>RedHat</code>\u7cfb\u5217\u7cfb\u7edf\u4e2d\u51fa\u73b0\u4e00\u4e9b\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u540e\u9762\u5c06\u5c55\u793a\u5982\u4f55\u89e3\u51b3\u3002 </p> <p>\u5728\u7b2c\u4e8c\u6b21\u901a\u8fc7<code>kitchen converge</code>\u6267\u884c<code>Chef</code>\u8fd0\u884c\uff0c\u6211\u4eec\u53d1\u73b0\u4e00\u4e9b<code>package</code>\u548c<code>execute</code>\u8d44\u6e90\u7684\u5e42\u7b49\u6027\u95ee\u9898\u3002 </p> <ol> <li>\u91cd\u65b0\u5b89\u88c5<code>rpm</code>\u5b89\u88c5\u5305\uff0c\u53ef\u6709\u53ef\u65e0\u3002 </li> <li>\u518d\u6b21\u6267\u884c<code>chef-server\u4e00ctl reconfigure</code>\u547d\u4ee4\u3002 </li> </ol> <p>\u8ba9\u6211\u4eec\u89e3\u51b3\u8fd9\u4e9b\u4ee3\u7801\u4e2d\u7684\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u6700\u540e\u7248\u672c\u7684\u5b8c\u5168\u5e42\u7b49\u7684<code>Chef</code>\u4ee3\u7801</p>"},{"location":"chap1/chef_tutorial8/#chefrpm","title":"\u7b2c\u4e00\u4e2a\u91cd\u590d\u5b89\u88c5\u7684\u95ee\u9898\u662f<code>Chef</code>\u5f00\u53d1\u8005\u4f7f\u7528\u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4e0b\u8f7d\u5230\u672c\u5730\u7684<code>rpm</code>\u5b89\u88c5\u5305\u65f6\u5e38\u89c1\u7684\u95ee\u9898\u3002","text":"<p>\u4e0e\u5176\u53ea\u662f\u5c06\u4e00\u4e2a\u8fdc\u7a0b\u4e0b\u8f7d\u7684<code>rpm</code>\u4f20\u9012\u7ed9<code>package</code>\u8d44\u6e90\uff0c\u8fd8\u4e0d\u5982\u901a\u8fc7<code>provider</code>\u5c5e\u6027\u544a\u8bc9 <code>package</code>\u8d44\u6e90\u4f7f\u7528<code>Chef::Provider::Package::Rpm</code>\u63d0\u4f9b\u8005\u3002\u540c\u65f6\u9700\u8981\u5236\u5b9a\u5b89\u88c5\u5305\u540d\u5b57\u5b57\u7b26\u4e32\u548c\u901a\u8fc7<code>source</code>\u5c5e\u6027\u6307\u5b9a\u672c\u5730\u7684\u5b89\u88c5\u5305\u5730\u5740\uff1a </p> <pre><code>package package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\nend\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528<code>rpm_package</code>\u5bf9<code>package</code>\u8d44\u6e90\u6307\u5b9a <code>Chef::Provider::Package::Rpm</code>\u63d0\u4f9b\u8005\u63d0\u4f9b\u8005\u3002</p> <p>\u4ee5\u4e0b\u4ee3\u7801\u7b49\u540c\u4e8e\u4ee5\u4e0a</p> <pre><code>rpm_package package_name do\n  source package_local_path\nend\n</code></pre>"},{"location":"chap1/chef_tutorial8/#executechefexecute","title":"\u89e3\u51b3\u7b2c\u4e8c\u4e2a<code>execute</code>\u8d44\u6e90\u8be5\u590d\u6267\u884c\u547d\u4ee4\u7684\u95ee\u9898\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\u3002\u53ef\u4ee5\u4f7f\u7528<code>Chef</code>\u5185\u5efa\u7684\u8d44\u6e90\u5b8c\u6210\u4efb\u52a1\u65f6\u5c31\u4e0d\u8981\u4f7f\u7528<code>execute</code>\u8d44\u6e90\uff0c\u56e0\u4e3a\u4f60\u9700\u8981\u8d1f\u8d23\u63a7\u5236\u5e42\u7b49\u6027\u3002","text":"<p>\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u4e2a\u65b9\u6cd5\u662f\u4f7f\u7528<code>not_if</code>\u6765\u4fdd\u62a4<code>execute</code>\u8d44\u6e90\u3002\u8fd9\u6837\u5728<code>not_if</code>\u4e2d\u6307\u5b9a\u7684\u6d4b\u8bd5\u4f1a\u5148\u6267\u884c\uff0c\u5982\u679c\u6d4b\u8bd5\u6210\u529f\uff0c\u8bc1\u660e\u7cfb\u7edf\u5df2\u7ecf\u5728\u7406\u60f3\u72b6\u6001\u4e0b\uff0c\u5219\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e8b\u60c5\u3002</p> <p>\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u6d4b\u8bd5<code>chef-server</code>\u5b89\u88c5\u5305\u662f\u5426\u5df2\u7ecf\u5b89\u88c5\u3002\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u5728<code>execute</code>\u8d44\u6e90\u4e2d\u6dfb\u52a0<code>not_if</code>\u8bed\u53e5\u3002<code>not_if</code>\u4f1a\u6d4b\u8bd5\u5176\u4e2d\u7684\u547d\u4ee4\u7684\u9000\u51fa\u4ee3\u7801\u662f\u54260, \u5982\u679c\u662f<code>execute</code>\u8d44\u6e90\u5c31\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5 </p> <pre><code>execute \"chef-server-ctl reconfigure\" do\n  not_if \"rpm -q chef-server\"\nend\n</code></pre> <p>\u867d\u7136\u53ef\u4ee5\u8fd9\u6837\u89e3\u51b3\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u4f46\u5e76\u4e0d\u662f\u7279\u522b\u7406\u60f3\u3002\u4f60\u9700\u8981\u627e\u5230\u5408\u9002\u7684\u65b9\u6cd5\u6765\u5224\u5b9a<code>Chef</code>\u670d\u52a1\u5668\u662f\u5426\u5df2\u7ecf\u6210\u529f\u5b89\u88c5\uff0c\u800c\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684\u65b9\u6cd5\u5e76\u4e0d\u662f\u90a3\u4e48\u53ef\u9760\u3002\u53e6\u5916\u4e00\u79cd\u89e3\u51b3\u8fd9\u6709\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u53ea\u6709\u5728\u524d\u9762\u6240\u505a\u7684<code>package</code>\u8d44\u6e90\u5b89\u88c5\u6267\u884c\u7684\u65f6\u5019\u624d\u4f7f\u7528<code>execute</code>\u8d44\u6e90\u6267\u884c\u82e5\u4ee4\u5426\u5219\u4e0d\u6267\u884c<code>execute</code>\u8d44\u6e90\u3002\u53ef\u4ee5\u901a\u8fc7<code>notifies</code>\u8bed\u53e5\u6765\u901a\u77e5\u6267\u884c\u5176\u4ed6\u8d44\u6e90\u3002 </p> <p>\u8981\u60f3\u4f7f\u7528<code>notifies</code>\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u4e3a\u6b64\uff0c<code>execute</code>\u8d44\u6e90\u8bed\u53e5\u505a\u4e00\u4e9b\u6539\u53d8\u3002</p> <p>\u9996\u5148\uff0c\u9700\u8981\u4f7f\u5176\u5728\u72ec\u7acb\u5904\u7406\u65f6\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0<code>action :nothing</code>\u5c5e\u80dc\u3002</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u8fd0\u884c\u547d\u4ee4\u79fb\u5230<code>command</code>\u5c5e\u6027\u4e2d\uff0c\u4ece\u800c\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u901a\u8fc7\u66f4\u77ed\u7684\u540d\u5b57\u6765\u901a\u77e5\u6b64\u8d44\u6e90\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u88ab\u4f20\u4eba<code>execute</code>\u8d44\u6e90\u7684<code>name</code>\u5c5e\u6027\u88ab\u4f5c\u4e3a<code>command</code>\u5c5e\u80dc\u4f7f\u7528\u3002</p> <p>\u5f53\u6211\u4eec\u60f3\u7528\u4e00\u884c\u4ee3\u7801\u6765\u8fd0\u884c\u4e00\u4e2a\u547d\u4ee4\u65f6\uff0c\u8fd9\u6837\u505a\u5f88\u597d\uff0c\u4f46\u60f3\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u901a\u77e5\u8fd9\u4e2a\u8d44\u6e90\u65f6\u5219\u4e0d\u662f\u6700\u7406\u60f3\u7684\u65b9\u6cd5\uff0c\u56e0\u4e3a\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u6307\u5b9a\u6574\u4e2a\u547d\u4ee4\u3002\u73b0\u5728\u6211\u5bf9<code>execute</code>\u8d44\u6e90\u505a\u51fa\u4ee5\u4e0b\u6539\u53d8\uff1a </p> <pre><code># reconfigure the installation\nexecute 'reconfigure-chef-server' do\n  command 'chef-server-ctl reconfigure'\n  action :nothing\nend\n</code></pre> <p>\u7136\u540e\u5728<code>package</code>\u8d44\u6e90\u4e2d\u6dfb\u52a0<code>notifies</code>\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <ul> <li><code>notifies</code>\u5c5e\u6027\u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\u52a8\u4f5c\u3001\u8981\u901a\u77e5\u7684\u8d44\u6e90\u7684\u540d\u5b57\u548c\u6267\u884c\u52a8\u4f5c\u7684\u65f6\u95f4\u3002</li> </ul> <p>\u5982\u4ee5\u4e0b\u4ee3\u7801\u6240\uff0c\u6211\u4eec\u60f3\u901a\u77e5<code>execute[reconfigure-chef-server]</code>\u8d44\u6e90\u6267\u884c<code>:run</code>\u52a8\u4f5c\uff0c\u5e76\u7acb\u5373\u6267\u884c\u3002</p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage_url = node['enterprise-chef']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-server]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-server' do\n  command 'private-chef-ctl reconfigure'\n  action :nothing\nend\n</code></pre> <p>\u4f7f\u7528\u8fd9\u4e2a\u7248\u672c\u7684\u4ee3\u7801\u518d\u6b21\u8fd0\u884c<code>kitchen converge</code>.\u4e95\u5728\u8f93\u51fa\u4e2d\u6ce8\u610f\u5b83\u6c47\u62a5\u7684\u662f<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0\uff1a</p> <pre><code>$ kitchen converge\n Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[reconfigure-chef-server] action nothing (skipped due to action :nothing)\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 0/3 resources updated in 04 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m18.04s).\n</code></pre> <p>\u8fd9\u662f\u6211\u4eec\u671f\u5f85\u7684\u7ed3\u679c\uff0c<code>Chef</code>\u6ca1\u6709\u6267\u884c\u4efb\u4f55\u8d44\u6e90\u5bf9\u7cfb\u7edf\u4f5c\u51fa\u4efb\u4f55\u6539\u53d8\uff1a </p> <p>\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\uff0c\u5728\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\uff0c\u59cb\u7ec8\u8981\u68c0\u67e5\u914d\u65b9\u5355\u662f\u5426\u5e42\u7b49\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u5982\u679c\u6211\u4eec\u5c06\u7b2c\u4e00\u4e2a\u7248\u672c\u7684\u914d\u65b9\u5355\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff0c\u4e00\u822c\u6765\u8bb2\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u8282\u70b9\u4e0a<code>Chef-client</code>\u4f1a\u5b9a\u671f\u8fd0\u884c\uff08\u6bd4\u5982\u6bcf15\u5206\u949f\uff09\uff0c\u6240\u6709\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u62e5\u6709\u6b64\u914d\u65b9\u5355\u7684\u8282\u70b9\u5c06\u6bcf15\u5206\u949f\u91cd\u65b0\u5b89\u88c5\u4e00\u6b21<code>Chef</code>\u670d\u52a1\u5668\uff01 </p>"},{"location":"chap1/chef_tutorial8/#4chef","title":"4\u3001\u914d\u7f6e\u4f01\u4e1aChef\u670d\u52a1\u5668","text":"<p>\u5982\u679c\u6210\u529f\u5b89\u88c5<code>Chef</code>\u670d\u52a1\u5668\uff0c\u5c31\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528\u4f60\u5728<code>kitehen.yml</code>\u4e2d\u8bbe\u5b9a\u7684<code>private network ip</code>\u5730\u5740\u8bbf\u95ee\u670d\u52a1\u5668\u7ba1\u7406\u7f51\u9875\u3002</p> <p></p> <p>Chef Manage</p>"},{"location":"chap1/chef_tutorial8/#4-1-chef-serverchef-manage","title":"4-1 \u65b0\u7684\u83dc\u8c31chef-server\u548cchef-manage","text":"<p><code>/enterprise-chef/attributes/default.rb</code></p> <pre><code>default['chefserver']['url'] = 'https://packages.chef.io/files/stable/chef-server/13.1.13/el/6/chef-server-core-13.1.13-1.el6.x86_64.rpm'\ndefault['chefmanage']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm'\n</code></pre> <p><code>/enterprise-chef/recipes/manage.rb</code></p> <pre><code>## Install chef manage\n\npackage_url = node['chefmanage']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-manage]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-manage' do\n  command 'chef-server-ctl install chef-manage'\n  command 'chef-manage-ctl reconfigure --accept-license'\n  # action :nothing\n  action :run\nend\n</code></pre> <p><code>/enterprise-chef/recipes/default.rb</code></p> <pre><code>## Install chef server and then install  chef manage\n\npackage_url = node['chefserver']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-server]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-server' do\n  # command 'chef-server-ctl install chef-manage'\n  command 'chef-server-ctl reconfigure --chef-license=accept'\n  # command 'chef-manage-ctl reconfigure'\n  # action :run\n  action :nothing\nend\n\ninclude_recipe 'enterprise-chef::manage'\n\ninclude_recipe 'enterprise-chef::adduser'\ninclude_recipe 'enterprise-chef::addorganization'\n</code></pre> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u4f7f\u7528\u4e86<code>192.168.33.34</code>\u4f5c\u4e3a\u5730\u5740, \u8bbf\u95ee\u8fd9\u4e2a\u5730\u5740\uff0c\u5728\u5ffd\u7565\u5173\u4e8e<code>SSL</code>\u8bc1\u4e66\u7684\u8b66\u544a\u4e4b\u540e\uff0c\u70b9\u51fb<code>Sign up</code>\uff08\u6ce8\u518c\uff09\u94fe\u63a5\uff0c\u5982\u56fe\u63d0\u793a\u4f60\u6ce8\u518c\u4e00\u4e2a\u7528\u6237\u8d26\u6237\u3002\u586b\u4eba\u76f8\u5173\u4fe1\u606f\uff0c\u7136\u540e\u5355\u51fb<code>Submit</code>\uff08\u63d0\u4ea4\uff09\u6309\u94ae\u3002</p> <p></p> <p></p> <p>\u6211\u4eec\u5728\u7528\u6237\u8d26\u6237\u4e2d\u4f7f\u7528\u7684\u503c\uff0c\u5f53\u7136\uff0c\u4f60\u4f7f\u7528\u7684\u503c\u4f1a\u5b8c\u5168\u4e0d\u4e00\u6837 \u70b9\u51fb<code>Submit</code>\u6309\u94ae\u4f01\u4e1a<code>Chef</code>\u7684\u7f51\u9875<code>UI</code>\u4f1a\u544a\u8bc9\u4f60\u4e0b\u4e00\u6b65\u5c06\u521b\u5efa\u4e00\u4e2a\u7ec4\u7ec7\u3002\u5355\u51fb<code>Create\uff08\u521b\u5efa\uff09</code>\u94fe\u63a5\u521b\u5efa\u4e00\u4e2a\u7ec4\u7ec7.</p> <p>\u5982\u56fe\u6240\u793a \u7ec4\u7ec7\u4ee3\u8868\u516c\u53f8\u6216\u7ec4\u7ec7\u3002<code>Chef</code>\u4f7f\u7528\u4f60\u6307\u5b9a\u7684\u7ec4\u7ec7\u540d\u79f0\u4f5c\u4e3a\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u7ec4\u7ec7\u8eab\u4efd\u7684ID.\u56fe\u5c55\u793a\u7684\u662f\u6211\u4eec\u7684\u8bbe\u5b9a\u4e2d\u586b\u5199\u7684\u7ec4\u7ec7\u4fe1\u606f\u3002</p> <p></p> <p></p> <pre><code>chef generate recipe adduser\n</code></pre> <p><code>/enterprise-chef/recipes/adduser.rb</code></p> <pre><code>execute 'Add-chef-server-newuser' do\n    # command 'chef-server-ctl user-delete admin'\n    command 'chef-server-ctl user-create admin John Smith john_smith@example.com password --filename=/tmp/admin.pem'\n    action :run\n    # action: nothing\nend\n</code></pre> <ul> <li>username: admin</li> <li>password: password</li> </ul> <p><code>/enterprise-chef/recipes/addorganization.rb</code></p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: adduser\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\nexecute 'Add-chef-server-organization' do\n    # command 'chef-server-ctl org-delete ja'\n    command 'chef-server-ctl org-create  ja \"Ja-Chef, Inc\" --association_user admin --filename=/tmp/ja-validator.pem'\n    # action :run\n    action :run\nend\n\n# Create organization\n# ja Ja-Chef, Inc\n# --association_user admin\n\n* username: ja\n* password: Ja-Chef\n</code></pre> <p></p> <p>\u5355\u51fb<code>Create Organization</code>\uff08\u521b\u5efa\u7ec4\u7ec7\uff09\u6309\u94ae\u540e\uff0c\u63d0\u793a\u4f60\u4fdd\u5b58\u4e24\u4e2a\u6587\u4ef6\uff1a\u4e00\u4e2a\u9a8c\u8bc1\u5bc6\u94a5\u548c\u4e00 \u4e2a<code>knife</code>\u914d\u7f6e\u6587\u4ef6\uff0c</p> <p>\u521b\u5efa\u7ec4\u7ec7</p> <p></p> <p>\u9009\u62e9\u7ec4\u7ec7</p> <p></p> <p>\u4e0b\u8f7d\u79d8\u94a5(chef-repo)</p> <p></p> <p><code>kitchen login</code> to download <code>/tmp/ja-validator.pem</code></p> <pre><code>$ kitchen login\nLast login: Mon Dec  2 05:53:46 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ cd /tmp/\n[vagrant@default-centos65 tmp]$ ls -la\ntotal 72\ndrwxrwxrwt.  8 root          root           4096 Dec  2 05:47 .\ndr-xr-xr-x. 22 root          root           4096 Dec  1 10:24 ..\ndrwxrwxrwt   2 root          root           4096 Dec  1 10:24 .ICE-unix\nsrwxrwxrwx   1 opscode-pgsql opscode-pgsql     0 Dec  2 05:31 .s.PGSQL.5432\n-rw-------   1 opscode-pgsql opscode-pgsql    63 Dec  2 05:31 .s.PGSQL.5432.lock\n-rw-r--r--   1 root          root           1678 Dec  2 05:47 admin.pem\ndrwxr-xr-x   3 opscode       opscode        4096 Dec  1 11:29 bundler\ndrwxr-xr-x   2 opscode       opscode        4096 Dec  1 11:31 hsperfdata_opscode\n-rw-r--r--   1 root          root          23248 Dec  1 10:25 install.sh\n-rw-r--r--   1 root          root           1678 Dec  2 05:47 ja-validator.pem\ndrwxrwxr-x   7 vagrant       vagrant        4096 Dec  1 10:30 kitchen\n-rw-r--r--   1 root          root            368 Dec  1 10:25 stderr\ndrwx------   2 root          root           4096 Dec  1 10:25 vmware-root\ndrwx------   2 root          root           4096 Dec  1 10:25 vmware-root_1102-273056232\n</code></pre> <p>\u8fd9\u4e09\u4e2a\u6587\u4ef6\u90fd\u4e0b\u8f7d\u597d\u540e, \u56de\u5230<code>chef-repo</code>\u76ee\u5f55\u5c06\u5176\u4f5c\u4e3a\u5f53\u524d\u76ee\u5f55\uff0c \u7136\u540e\u521b\u5efa\u4e00\u4e2a<code>cehf-repo/.chef</code>\u5b50\u76ee\u5f55\u3002 \u5b8c\u6210\u540e, \u4f60\u7684<code>chef-repo</code>\u76ee\u5f55\u7684\u7ed3\u6784\u5982\u4e0b\u6240\u793a</p> <pre><code>$ tree -a chef-repo/\nchef-repo/\n\u251c\u2500\u2500 .chef\n\u2502   \u251c\u2500\u2500 admin.pem\n\u2502   \u251c\u2500\u2500 ja-validator.pem\n\u2502   \u2514\u2500\u2500 knife.rb\n\u251c\u2500\u2500 .gitignore\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 cookbooks\n\u2502   \u251c\u2500\u2500 chefignore\n\u2502   \u2514\u2500\u2500 starter\n\u2502       \u251c\u2500\u2500 attributes\n\u2502       \u2502   \u2514\u2500\u2500 default.rb\n\u2502       \u251c\u2500\u2500 files\n\u2502       \u2502   \u2514\u2500\u2500 default\n\u2502       \u2502       \u2514\u2500\u2500 sample.txt\n\u2502       \u251c\u2500\u2500 metadata.rb\n\u2502       \u251c\u2500\u2500 recipes\n\u2502       \u2502   \u2514\u2500\u2500 default.rb\n\u2502       \u2514\u2500\u2500 templates\n\u2502           \u2514\u2500\u2500 default\n\u2502               \u2514\u2500\u2500 sample.erb\n\u2514\u2500\u2500 roles\n    \u2514\u2500\u2500 starter.rb\n\n10 directories, 12 files\n\n</code></pre> <ul> <li><code>&lt;usernamee&gt;.pem</code>\u6587\u4ef6\u662f\u7528\u6765\u5411<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u4f60\u7528\u6237\u8eab\u4efd\u7684\u5bc6\u94a5\u3002\u8981\u628a\u5b83\u89c6\u4f5c\u5bc6\u7801\u4e95\u4e14 \u4e0d\u8981\u4fee\u6539\u6587\u4ef6\u5185\u5bb9\u3002 </li> <li><code>&lt;organization&gt;.pem</code>\u6587\u4ef6\u662f\u7528\u6765\u5411<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u7ec4\u7ec7\u8eab\u4efd\u7684\u5bc6\u94a5\u3002\u4e5f\u8981\u628a\u521b\u89c1\u4e3a\u5bc6\u7801\uff0c\u4f46\u8981\u5171\u4eab\u7ed9\u7ec4\u7ec7\u5185\u6240\u6709\u7684<code>Chef</code>\u5f00\u53d1\u8005\u3002\u4efb\u4f55\u9700\u8981\u8bbf\u95ee<code>Chef</code>\u7684\u7ec4\u7ec7\u5185\u90b9\u4eba\u5458\u90fd\u9700\u8981\u8fd9\u4e2a\u6587\u4ef6\u3002\u4e0d\u8981\u66f4\u6539\u6587\u4ef6\u5185\u5bb9\u3002 </li> </ul>"},{"location":"chap1/chef_tutorial8/#4-2-rsa","title":"4-2 <code>RSA</code>\u94a5\u5319\u5bf9\u513f","text":"<p><code>Chef</code>\u7684<code>pem</code>\u6587\u4ef6\u5305\u542b\u6ce8\u518c\u8fc7\u7a0b\u4e2d\u751f\u6210\u7684<code>RSA</code>\u79c1\u94a5\u3002<code>Chef</code>\u4e3a\u4f60\u7684\u7ec4\u7ec7\u751f\u6210\u4e00\u4e2a<code>RSA</code>\u94a5\u5319\u5bf9\u513f\u516c\u94a5\u5b58\u50a8\u5728\u4f01\u4e1a<code>Chef</code>\u5728\u670d\u52a1\u5668\u4e0a\u5e76\u5728\u7a0b\u5e8f\u5411<code>Chef</code>\u670d\u52a1\u5668\u53d1\u9001\u8bd7\u6c42\u65f6\u7528\u6765\u9a8c\u8bc1\u7ec4\u7ec7\u7684\u8eab\u4efd </p> <p>\u4e0d\u50cf<code>.pem</code>\u6587\u4ef6\uff0c<code>knife</code>\u6587\u4ef6\u53ef\u4ee5\u66f4\u6539\u6216\u81ea\u5b9a\u4e49\u3002<code>knife.rb</code>\u6587\u4ef6\u662f\u4e00\u4e2a<code>Ruby</code>\u6587\u4ef6\uff0c\u6267\u884c\u547d\u4ee4\u65f6\u8bfb\u53d6\u8fd9\u4e2a\u6587\u4ef6 </p> <pre><code>$ knife client list\nERROR: SSL Validation failure connecting to host: default-centos65.vagrantup.com - SSL_connect returned=1 errno=0 state=error: certificate verify failed (self signed certificate)\nERROR: Could not establish a secure connection to the server.\nUse `knife ssl check` to troubleshoot your SSL configuration.\nIf your server uses a self-signed certificate, you can use\n`knife ssl fetch` to make knife trust the server's certificates.\n\nOriginal Exception: OpenSSL::SSL::SSLError: SSL Error connecting to https://default-centos\n</code></pre> <pre><code>current_dir = File.dirname(__FILE__)\nlog_level                :info\nlog_location             STDOUT\nnode_name                \"admin\"\nclient_key               \"#{current_dir}/admin.pem\"\nchef_server_url          \"https://default-centos65.vagrantup.com/organizations/ja\"\ncookbook_path            [\"#{current_dir}/../cookbooks\"]\nssl_verify_mode          :verify_none \n</code></pre> <p>\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684<code>chef_server_url</code>\u4f7f\u7528\u4e86\u5047\u7684<code>DNS</code>\u4e3b\u673a\u540d<code>default-centos65.vagrantup.com</code>\u56e0\u4e3a\u8fd9\u662f<code>vagrant</code>\u8bbe\u5b9a\u7684\u4e3b\u673a\u540d\u3002\u5982\u679c\u4f60\u8bd5\u56fe\u8bbf\u95ee<code>\"https://default-centos65.vagrantup.com/organizations/ja\"</code>,\u4f1a\u53d1\u73b0\u5b83\u662f\u65e0\u6548\u7684</p> <p><code>Chef</code>\u670d\u52a1\u5668\u9700\u8981\u673a\u5668\u62e5\u6709\u80fd\u591f\u6b63\u786e\u89e3\u6790\u7684\u5b8c\u6574\u57df\u540d\uff08FQDN)\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5e94\u8be5\u5728\u5b89\u88c5<code>chef</code>\u670d\u52a1\u5668\u4e4b\u524d\u5728\u57df\u540d(<code>DNS</code>)\u670d\u52a1\u5668\u4e2d\u8bbe\u5b9a<code>Chef</code>\u7684\u4e3b\u673a\u540d\u3002\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u4e3a\u65b9\u4fbf\u8d77\u89c1\u8ba9\u6211\u4eec\u628a<code>default-centos65.vagrantup.com</code>\u52a0\u5230\u673a\u5668\u7684\u672c\u5730<code>host</code>\u6570\u636e\u5e93 </p> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5411<code>host</code>\u6570\u636e\u6dfb\u52a0\u5185\u5bb9\u3002</p> <p>Linux/Mac OS X:</p> <pre><code>$ sudo sh -c \"echo '192.168.33.34 default-centos65.vagrantup.com' &gt;&gt; /etc/hosts\" \n</code></pre> <p>\u73b0\u5728, \u5982\u679c\u4f60\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee<code>https://default-centos65.vagrantup.com</code>, \u4e3b\u673a\u4f1a\u8ba4\u4e3a\u5b83\u662f\u4e00\u4e2a\u6709\u6548\u7684\u5730\u5740 </p> <p>\u53ef\u4ee5\u5728<code>knife.rb</code>\u4e2d\u6dfb\u52a0\u5176\u4ed6\u8bbe\u7f6e\uff0c\u6bd4\u5982<code>EC2</code>\u7684\u7528\u6237\u4fe1\u606f\u3001\u4ee3\u7406\u4fe1\u606f\u3001\u52a0\u5bc6\u6570\u636e\u5305\u8bbe\u5b9a\u7b49\u4f60\u548c\u4f60\u7ec4\u7ec7\u5185\u5176\u4ed6\u6210\u5458\u7684<code>knife.rb</code>\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u5f88\u591a\u5185\u5bb9\u662f\u9488\u5bf9\u7528\u6237\u548c\u6240\u7528\u7684\u5f00\u53d1\u673a\u5668\u7684\u3002\u9664\u975e\u5c06\u5bc6\u7801\u6216\u8bbf\u95ee\u5bc6\u94a5\u5b58\u50a8\u5728<code>knife.rb</code>\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5426\u5219\u4e0d\u9700\u5c06\u5176\u89c6\u4e3a\u5bc6\u7801\uff0e </p>"},{"location":"chap1/chef_tutorial8/#5","title":"5\u3001\u6d4b\u8bd5\u8fde\u63a5","text":"<p>\u5728<code>Chef</code>\u76ee\u5f55\u4e0b\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002\u6253\u5f00\u547d\u4ee4\u884c\u7a0b\u5e8f\u5e76\u5c06<code>chef-repo</code>\u505a\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 </p> <pre><code>$ cd ~/chef-repo\n</code></pre> <p>\u73b0\u5728\uff0c \u4f60\u53ef\u4ee5\u4f7f\u7528<code>knife</code> (<code>Chef</code>\u670d\u52a1\u5668\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff09\u6765\u6d4b\u8bd5\u4f60\u548c<code>Chef</code>\u670d\u52a1\u5668\u7684\u8fde\u63a5\u548c \u8eab\u4efd\u9a8c\u8bc1\u3002</p> <p>\u5728\u5199\u4f5c\u672c\u4e66\u65f6\uff0c<code>Chef</code>\u5c1a\u672a\u63d0\u4f9b\u4e00\u4e2a\u4e13\u95e8\u7528\u6765\u201d\u6d4b\u8bd5\u8fde\u63a5\u201c\u7684\u547d\u4ee4\u3002\u7136\u800c\uff0c\u901a\u8fc7\u8be2\u95ee<code>Chef</code>\u670d\u52a1\u5668\u6765\u5217\u4e3e\u5ba2\u6237\u7aef\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1\u4ee5\u4e0b\u51e0\u70b9 </p> <ul> <li>\u7f51\u7edc\u53ef\u4ee5\u8fde\u63a5\u5230\u670d\u52a1\u5668\u3002 </li> <li>\u9a8c\u8bc1\u6587\u4ef6\u90fd\u5728\u6b63\u786e\u7684\u4f4d\u7f6e\u3002 </li> <li><code>Chef</code>\u8bfb\u5356\u53d6\u9a8c\u8bc1\u6587\u4ef6\u3002 </li> <li>\u5f00\u53d1\u5de5\u4f5c\u7ad9\u53ef\u4ee5\u6536\u5230\u6765\u81ea<code>Chef</code>\u670d\u52a1\u5668\u7684\u53cd\u9988\u3002 </li> </ul> <p>\u5728\u547d\u4ee4\u884c\u7a0b\u5e8f\u4e2d\u8fd0\u884c<code>knife client list</code>\u547d\u4ee4\uff0c\u4f60\u4f1a\u89c1\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a </p> <pre><code>$ knife client list\nja-validator\n</code></pre> <p>\u5982\u679c\u4f60\u9047\u5230\u9519\u8bef\uff0c\u53ef\u4ee5\u68c0\u67e5\u4ee5\u4e0b\u9879\u76ee\u3002</p> <ol> <li>\u786e\u8ba4\u4f60\u53ef\u4ee5\u4ece\u7f51\u9875\u6d4f\u89c8\u5668\u8bbf\u95ee\u547d\u4ee4  </li> <li>\u786e\u8ba4\u4f60\u5728<code>chef-repo</code>\u76ee\u5f55\u5185\u8fd0\u884c\u547d\u4ee4\u3002 </li> <li>\u786e\u8ba4<code>.chef</code>\u76ee\u5f55\u5305\u542b\u4e24\u4e2a<code>.pem</code>\u6587\u4ef6\u4ee5\u53ca\u4e00\u4e2a<code>knife.rb</code>\u6587\u4ef6\u3002 </li> <li>\u786e\u8ba4\u4f60\u7684\u8eab\u4efd\u9a8c\u8bc1\u6587\u4ef6\u62e5\u6709\u6b63\u786e\u7684\u6587\u4ef6\u6743\u9650\uff08\u53ea\u6709\u7528\u6237\u53ef\u8bfb\uff09\u3002 </li> </ol> <p>\u5982\u679c\u786e\u8ba4\u4ee5\u4e0a\u90fd\u8bbe\u5b9a\u6b63\u786e\u4f46\u4ecd\u7136\u65e0\u6cd5\u8fde\u63a5\u5230<code>Chef</code>\u670d\u52a1\u5668\uff0c</p> <p>\u9a8c\u8bc1\u5f00\u53d1\u673a\u5668\u53ef\u4ee5\u8fde\u63a5\u5230<code>Chef</code>\u670d\u52a1\u5668\u4e4b\u540e\uff0c\u8ba9\u6211\u4eec\u521b\u5efa\u53e6\u4e00\u4e2a\u83dc\u8c31\uff0c\u4f7f\u6d4b\u8bd5\u8282\u70b9\u53ef\u6ce8\u518c\u5e76\u4ea4\u7531Chef\u670d\u52a1\u5668\u7ba1\u7406\u3002 </p>"},{"location":"chap1/chef_tutorial8/#6chef-client","title":"6\u3001\u51c6\u5907\u4e00\u4e2a\u65b0\u8282\u70b9(chef-client)","text":"<p><code>Chef</code>\u7528\"Bootstraping\" \u8fd9\u4e2a\u672f\u8bed\u6765\u6307\u4ee3\u5c06\u4e00\u4e2a\u8fdc\u7a0b\u7cfb\u7edf\u8c01\u52a1\u597d\u7531<code>chef</code>\u6765\u7ba1\u7406\u7684\u8fc7\u7a0b\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\u4e95\u5c06\u5176\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u6ce8\u518c\u3002\u5728\u6b64\uff0c \u6211\u4eec<code>bootstrap</code>\u7ffb\u8bd1\u4e3a\u201c\u51c6\u5907\u201d\uff0c \u4f46\u7531\u4e8e\u5728\u771f\u5b9e\u73af\u63a9\u548c\u6b64\u51c6\u5907\u8fc7\u7a0b\u901a\u5e38\u662f\u8282\u70b9\u542f\u52a8\u540e\u7684\u7b2c\u4e00\u9879\u4efb\u52a1\uff0c \u6240\u4ee5<code>bootstrap</code>\u8282\u70b9, \u4e5f\u7ecf\u5e38\u53ef\u4ee5\u7406\u89e3\u4e3a\u542f\u52a8\u65b0\u7684\u8282\u70b9 </p>"},{"location":"chap1/chef_tutorial8/#6-1","title":"6-1 \u5728\u6c99\u76d2\u73af\u5883\u4e2d\u521b\u5efa\u8282\u70b9","text":"<p>\u8ddf\u6211\u4eec, \u7c7b\u4f3c\u8ba9\u6211\u4eec\u4f7f\u7528<code>Test Kitchen</code>\u6765\u5b9a\u4e49\u4e00\u4e2a\u9879\u76ee\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u521b\u60f3\u4e00\u4e2a\u8282\u70b9</p> <p>\u5728\u4e0e\u5148\u524d\u521b\u5efa\u7684<code>chef server</code>\u76ee\u5f55\u5e73\u884c\u7684\u4f4d\u754c\u521b\u5efa\u4e2a<code>node</code>\u76ee\u5f55,\u8fd9\u5176\u5b9e\u90e8\u7f72\u83dc\u8c31\uff0c \u53ea\u662f\u4e00\u4e2a \u662f<code>Test Kitchen</code>\u9879\u76ee\uff0c \u4f46\u5c06\u5176\u4f4d\u4e8e<code>chef-Server</code>\u7684\u5e73\u884c\u4f4d\u7f6e\u6709\u52a9\u4e8e\u6211\u4eec\u6765\u56de\u5207\u6362\uff0e </p> <p>\u521b\u5efa<code>~/chef-repo/cookbooks/node</code>\u76ee\u5f55, \u5e76\u5c06\u5176\u4f5c\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 </p> <pre><code>$ cd ~/chef-repo/cookbooks\n$ mkdir node\n$ cd node\n</code></pre> <pre><code>$ knife client list\nja-validator\n</code></pre>"},{"location":"chap1/chef_tutorial8/#7chef","title":"7\u3001Chef\u670d\u52a1\u5668\u540c\u65f6\u7ba1\u7406\u591a\u4e2a\u8282\u70b9","text":"<p><code>Chef</code>\u670d\u52a1\u5668\u662f\u4f60\u57fa\u7840\u67b6\u6784\u914d\u7f6e\u6570\u636e\u7684\u4e2d\u592e\u5b58\u50a8\u3002\u5b83\u5b58\u50a8\u5e76\u7d22\u5f15\u83dc\u8c31\u3001\u73af\u5883\u3001\u6a21\u677f\u3001\u5143\u6570 \u636e\u3001\u6587\u4ef6\u548c\u5206\u5e03\u7b56\u7565\u3002<code>Chef</code>\u670d\u52a1\u5668\u5305\u542b\u6240\u6709\u5176\u7ba1\u7406\u7684\u673a\u5668\u7684\u4fe1\u606f\u3001\u3002 </p> <p><code>Chef</code>\u670d\u52a1\u5668\u540c\u65f6\u5305\u542b\u4e00\u4e2a\u9875\u9762\u670d\u52a1\u5668\uff0c \u83dc\u8c31\u5b58\u50a8\uff0c \u7f51\u9875\u754c\u9762\uff0c \u6d88\u606f\u961f\u5217\u4ee5\u53ca\u540e\u7aef\u6570\u636e\u5e93</p> <p></p> <p>\u7f51\u7edc\u80ed\u52a1\u5668 </p> <p><code>nginx</code>\u7f51\u7edc\u670d\u52a1\u5668\u662f\u4e2a\u7b80\u5355\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\uff0e<code>Chef</code>\u670d\u52a1\u5668\u7528\u5b83\u4f5c\u4e3a\u524d\u7aef\u7684\u754c\u9762\uff0c\u5b83\u540c\u65f6\u4e3a<code>chef</code>\u670d\u52a1\u5668\u63d0\u4f9b\u8d1f\u8f7d\u5e73\u8861\u3002\u6240\u6709\u5230<code>Chef</code>\u670d\u52a1\u5668\u7684<code>API</code>\u8bf7\u6c42\u90fd\u901a\u8fc7<code>nginx</code>\u670d\u52a1\u5668\u6765\u8def\u7531\u3002 </p> <p>WebUI</p> <p><code>WebUI</code>\u662f\u9762\u5411\u7528\u6237\u7684\u7f51\u9875\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u4e00\u4e2a\u4ece\u7f51\u9875\u4e0a\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u4ea4\u4e92\u7684\u754c\u9762\u3002\u5b83\u662f\u4e2a<code>Ruby on Rails</code>\u5e94\u7528\u7a0b\u5e8f</p> <p><code>Chef</code>\u52a1\u5668(<code>Erchef</code>) </p> <p><code>Erehef</code>\u662f<code>Chef</code>\u670d\u52a1\u5668\u8d1f\u8d23\u5904\u7406<code>API</code>\u8bf7\u6c42\u7684\u7ec4\u4ef6\u3002 <code>Chef</code>\u670d\u52a1\u5668\u7528\u6237<code>Erlang</code>\u7f16\u7a0b\u8bed\u8a00\u5199\uff0c\u652f\u6301\u9ad8\u4e95\u53d1\u548c\u9ad8\u53ef\u9760\u6027\u3002<code>Erehef</code>\u662f<code>Chef</code>\u670d\u52a1\u5668\u7684\u6838\u5fc3<code>API</code></p> <p><code>Bookshelf</code></p> <p><code>Bookshelf</code>\u662f\u6240\u6709<code>Chef</code>\u83dc\u8c31\u548c\u83dc\u8c31\u5185\u5bb9(\u6bd4\u5982\u6587\u4ef6\u3001\u6a21\u677f\uff0c \u5b9a\u4e49\u5143\u6570\u636e\u548c\u914d\u65b9\u5355\uff09\u7684\u4e2d\u592e\u5b58\u50a8\u3002<code>Bookshelf</code>\u662f\u4e00\u4e2a\u5e73\u5766\u7684\u6587\u4eec\u6570\u636e\u5e93, \u4e95\u7279\u610f\u5b58\u50a8\u4e8e<code>Chef</code>\u670d\u52a1\u5668\u7684\u7d22\u5f15\u4e4b\u5916 </p> <p>\u641c\u7d22\u7d22\u5f15 </p> <p>\u641c\u7d22\u7d22\u5f15\u662f\u4e2a<code>Apache Solr</code>\u670d\u52a1\u5668\uff0c \u5b83\u8d1f\u8d23\u5185\u90e8\u548c\u5916\u90e8\u8bb8\u591a<code>API</code>\u8bf7\u6c42\u7684\u7d22\u5f15\u548c\u641c\u7d22\u3002\u641c\u7d22\u7d22\u5f15\u670d\u52a1\u548c\u5916\u754c\u4ea4\u4e92\u7684\u7ec4\u4ef6\u53eb<code>chef-solr</code> \u5b83\u63d0\u4f9b<code>Restful</code>\u7684<code>API</code> </p> <p>\u6d88\u606f\u961f\u5217 </p> <p>\u6b64\u961f\u5217\u7cfb\u7edf\u5904\u7406\u6240\u6709\u88ab\u53d1\u9001\u5230\u641c\u7d22\u7d22\u5f15\u7684\u6d88\u606f\u3002\u8fd9\u4e9b\u961f\u5217\u7531\u5f00\u6e90\u7684<code>RabbitMQ</code>\u961f\u5217\u7cfb\u7edf\u7ba1\u7406\u3002<code>chef-expander</code>\u4ece\u6d88\u606f\u5bf9\u5217\u4e2d\u83b7\u53d6\u6d88\u606f\uff0c \u7136\u540e\u53d1\u9001\u81f3\u641c\u7d22\u7d22\u5f15\u3002 </p> <p>\u6570\u636e\u5e93</p> <p><code>Chef</code>\u4f7f\u7528<code>PostgreSQL</code>\u6765\u5b58\u50a8\u6570\u636e\u3002\u5728<code>Chef 11</code>\u4e4b\u524d, \u4e3b\u8981\u6570\u636e\u5e93\u4e3a<code>CouchDB</code>\u4f46\u540e\u6765 \u7531\u4e8e<code>CouchDB</code>\u7684\u4f38\u7f29\u6027\u95ee\u9898<code>PostgreSQL</code>\u4ee3\u66ff</p> <p>How to Install Enterprise Chef Server Manually</p>"},{"location":"chap1/chef_tutorial8/#8chef-workstationchef-workstation","title":"8\u3001\u624b\u52a8\u5b89\u88c5<code>chef-workstation</code>(chef-workstation)","text":"<p>Go to https://downloads.chef.io/chef-workstation/#mac_os_x and provide your contact information to receive download details and installation instructions for Enterprise Chef Server.</p> <p></p>"},{"location":"chap1/chef_tutorial8/#9chef","title":"9\u3001\u4f7f\u7528\u83dc\u8c31\u6765\u81ea\u52a8\u5316\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668","text":"<p>\u5047\u8bbe\u4f60\u6709\u8db3\u591f\u7684\u7cfb\u7edf\u8d44\u6e90\u5728\u672c\u5730\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668\u4ee5\u53ca\u914d\u7f6e\u4e00\u4e2a\u6d4b\u8bd5\u8bd5\u8282\u70b9\uff0c\u521b\u5efa\u4e00\u4e2a<code>enterprise-chef</code>(chef-workstation)\u83dc\u8c31\u6765\u5b89\u88c5\u4f01\u4e1a<code>Chef</code>\u670d\u52a1\u5668\u3002</p> <p>\u4e3a\u4e86\u548c\u6258\u7ba1\u4f01\u4e1aChef\u4fdd\u6301\u4e00\u81f4\uff0c\u521b\u5efa<code>chef-repo/cookbooks</code>\u76ee\u5f55\u5e76\u5728\u76ee\u5f55\u4e2d\u521b\u5efa<code>enterprise</code>\u83dc\u8c31\u3002\u9876\u7ea7\u7684<code>chef-repo</code>\u76ee\u5f55\u53ef\u4ee5\u5b58\u653e\u7ba1\u7406\u4f01\u4e1a<code>Chef</code>\u6240\u9700\u8981\u7684\u9664\u83dc\u8c31\u4ee5\u5916\u7684\u5176\u4ed6\u6587\u4ef6\u3002\u56e0\u4e3a\u4f60\u4f1a\u4f7f\u7528\u82e5\u5e72\u4e2a\u83dc\u8c31\uff0c\u6240\u4ee5\u8fd9\u91cc\u5efa\u8bae\u5c06<code>enterprise</code>\u83dc\u8c31\u5b58\u653e\u5728<code>chef-repo/cookbooks</code>\u5b50\u76ee\u5f55\u5185\u3002 \u521b\u5efa<code>chef-repo/cookbooks</code>\u76ee\u5f55\u5e76\u5c06\u5b83\u4f5c\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u3002 </p> <p>Linux/Mac OS X:</p> <pre><code>$ mkdir -p chef-repo/cookbooks\n$ cd chef-repo/cookbooks\n</code></pre> <p>\u7136\u540e\u901a\u8fc7<code>chef generate cookbook</code>\u6216<code>knife cookbook</code> \u83dc\u8c31\uff08\u53d6\u51b3\u4e8e\u4f60\u4f7f\u7528<code>Chef</code>\u5f00\u53d1\u5305\u8fd8\u662fChef\u5ba2\u6237\u7aef\uff09\u3002 </p> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook enterprise-chef\n$ cd enterprise-chef\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create enterprise-chef --cookbook-path .\n$ cd enterprise-chef\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p><code>enterprise-chef/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: chef_solo\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n      network:\n      - [\"private_network\", {ip: \"192.168.33.34\"}]\n      customize:\n        memory: 1536\n\nsuites:\n  - name: default\n    run_list:\n      - recipe[enterprise-chef::default]\n    attributes:\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate attribute default\n</code></pre> <p>Chef Client:</p> <pre><code>$ touch attributes/default.rb\n</code></pre> <p><code>attributes/default.rb</code></p> <p>old:</p> <pre><code>default['enterprise-chef']['url'] = \\\n'https://s3.amazonaws.com/opscode-private-chef/el/6/x86_64/'\\\n'private-chef-11.1.8-1.el6.x86_64.rpm'\n</code></pre> <p>new chef-server-core:</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-server/13.1.13/el/6/chef-server-core-13.1.13-1.el6.x86_64.rpm'\n</code></pre> <p>new chef Management Console:</p> <p>https://downloads.chef.io/manage</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm'\n</code></pre> <p>finall version</p> <pre><code>default['enterprise-chef']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm\n</code></pre> <p><code>/enterprise-chef/recipes/default.rb</code></p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage_url = node['enterprise-chef']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\nremote_file package_local_path do\n  source package_url\nend\n\npackage package_local_path\n\n# reconfigure the installation\n# execute 'private-chef-ctl reconfigure'\nexecute 'chef-server-ctl reconfigure --chef-license=accept'\n# \"--chef-license=accept\"\n# STDOUT: Chef Infra Server cannot execute without accepting the license\n</code></pre> <p>\u5982\u679c\u4e0d\u60f3\u5728\u83dc\u8c31\u4e2d\u603b\u662f\u4f7f\u7528<code>node['enterprise-chef']['url'\uff3d</code>\u8fd9\u6837\u957f\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u5c06\u5176 \u5b58\u50a8\u5728\u4e00\u4e2a\u77ed\u7684\u672c\u5730\u53d8\u91cf\u4e2d\uff0c\u6bd4\u5982\uff1a</p> <pre><code>package_url = node['enterprise-chef']['url']\n</code></pre> <p>\u8bb0\u4f4f\uff0c\u5728<code>Chef</code>\u914d\u65b9\u5355\u4e2d\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528Ruby\u7f16\u7a0b\u8bed\u8a00\u63d0\u4f9b\u7684\u4efb\u4f55\u529f\u80fd\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u4f7f\u7528<code>::File.basename(\uff09</code> \u65b9\u6cd5\u6765\u4ece\u4e0b\u8f7d<code>URL</code>\u4e2d\u63d0\u53d6\u5b89\u88c5\u5305\u7684\u540d\u5b57\u3002 </p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5b89\u88c5\u5305\u7684\u540d\u5b57\u662fURL\u4e2d\u6700\u540e\u4e00\u4e2a\u659c\u6760\u540e\u7684\u7ec4\u4ef6\uff1a<code>'private-chef-11.1.8-1.el6.x86_64.rpm</code> \u5982\u679c\u60f3\u8fdb\u4e00\u6b65\u4e86\u89e3<code>Ruby</code>\u7684<code>::File</code>\u7c7b\uff0c\u53ef\u4ee5\u8bbf\u95ee<code>Ruby</code>\u6838\u5fc3<code>API</code>\u6587\u6863</p> <pre><code>package_name = ::File.basename(package_url)\n</code></pre> <p>\u4e0d\u5e78\u7684\u662f\uff0c\u6211\u4eec\u719f\u6089\u7684<code>package</code>\u8d44\u6e90\u5e76\u4e0d\u63a5\u53d7\u901a\u8fc7\u6307\u5b9a\u8fdc\u7a0b<code>URL</code>\u6765\u5b89\u88c5\u7a0b\u5e8f\u5305\uff0c\u6240\u4ee5\u8fd9\u91cc\u8981\u4ecb\u7ecd\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90:<code>remote_file</code>\u8d44\u6e90\u3002</p> <p><code>remote_file</code>\u8d44\u6e90\u63d0\u4f9b\u4ece\u8fdc\u7a0b\u4e0b\u8f7d\u6587\u4ef6\u7684\u529f\u80fd\u6211\u4eec\u5728\u6b64\u8981\u901a\u8fc7<code>remote_file</code>\u8d44\u6e90\u4ece\u8fdc\u7a0b<code>URL</code> \u4e0b\u8f7d\u5b89\u88c5\u5305\uff0c\u5e76\u7528<code>package</code>\u8d44\u6e90\u5b89\u88c5\u672c\u5730\u7684\u5b89\u88c5\u5305\u3002</p> <p>\u6211\u4eec\u9700\u8981\u5148\u5c06\u5b89\u88c5\u5305\u4e0b\u8f7d\u5230\u4e00\u4e2a\u4e34\u65f6\u4f4d\u7f6e\u3002\u4e0e\u5176\u4f7f\u7528\u56fa\u5b9a\u7684\u4e34\u65f6\u4e0b\u8f7d\u4f4d\u7f6e (\u5982<code>\"/tmp\"</code>)\uff0c\u4e0d\u5982\u7528<code>Chef</code>\u63d0\u4f9b\u7684\u4e00\u4e2a\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684\u53d8\u91cf\uff1a<code>Chef::Config[:file_cache_path]</code>\u3002\u901a\u8fc7\u8fd9\u4e2a\u53d8\u91cf\uff0c<code>Chef</code>\u7edd\u5bf9\u5b9a\u6700\u4f73\u7684\u4e34\u65f6\u5b58\u50a8\u4f4d\u7f6e\u3002\u5c06\u6240\u8981\u7684\u4e34\u65f6\u5b58\u50a8\u4f4d\u7f6e\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9<code>remote_file</code>\uff0c\u5e76\u5c06\u8fdc\u7a0b<code>URL</code>\u4f5c\u4e3a<code>source</code>\u5c5e\u6027\u4f20\u9012 </p> <p>\u5728\u6267\u884c<code>chef-server-ctl reconfigure</code>\u524d\uff0c\u6211\u4eec\u9700\u8981\u4ecb\u7ecd\u53e6\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90\uff1a<code>execute</code>\u8d44 \u6e90\u3002\u6709\u65f6\uff0c\u65e0\u6cd5\u627e\u5230\u4e00\u4e2a\u73b0\u6709\u7684\u8d44\u6e90\u6ee1\u8db3\u81ea\u5df1\u9700\u6c42\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528<code>execute</code>\u8d44\u6e90\u6765\u6267\u884c\u4efb\u610f\u547d\u4ee4\u3002\u4f60\u53ea\u9700\u8981\u5c06\u60f3\u6267\u884c\u7684\u547d\u4ee4\u5b57\u7b26\u4e32\u4f20\u9012\u81f3<code>execute</code>\u8d44\u6e90\u3002 </p> <pre><code>$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action    Last Error\ndefault-centos65  Vagrant  ChefSolo     Busser    Ssh        &lt;Not Created&gt;  &lt;None&gt;\n\n$ kitchen converge default-centos65\n\n$ kitchen list\nInstance          Driver   Provisioner  Verifier  Transport  Last Action  Last Error\ndefault-centos65  Vagrant  ChefZero     Busser    Ssh        Converged    &lt;None&gt;\n\n$  kitchen login default-centos65\nLast login: Sun Dec  1 09:07:26 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n\n$ rpm -q chef-server-core\nchef-server-core-13.1.13-1.el6.x86_64\n\n[vagrant@default-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre>"},{"location":"chap1/chef_tutorial8/#10idempotence","title":"10\u3001\u5e42\u7b49\u6027\u7b80\u4ecb(Idempotence)","text":"<p>\u867d\u7136\u6211\u4eec\u5199\u7684\u914d\u65b9\u5355\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u7248\u672c\u4e00\u53ef\u4ee5\u8fbe\u6210\u6211\u4eec\u7684\u76ee\u7684\uff0c\u4f46\u5b83\u5e76\u4e0d\u5e42\u7b49\u3002</p> <p>\u5e42\u7b49\u7684<code>Chef</code>\u4ee3\u7801\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u91cd\u590d\u8fd0\u884c\u65e0\u6570\u6b21\u800c\u7ed3\u679c\u5b8c\u5168\u4e00\u6837\uff0c\u5e76\u4e0d\u4f1a\u56e0\u4e3a\u8fd0\u884c\u591a\u6b21\u800c\u4ea7\u751f\u4e0d\u540c\u7684\u6548\u679c\u3002\u51e0\u4e4e\u6240\u6709\u9ed8\u4e00\u8ba4\u7684<code>Chef</code>\u8d44\u6e90\u90fd\u4fdd\u8bc1\u5e42\u7b49\u6027\uff0c\u552f\u4e00\u7684\u4f8b\u5916\u662f<code>execute</code>\u8d44\u6e90\u3002 </p> <p><code>execute</code>\u8d44\u6e90\u4e00\u822c\u5e76\u4e0d\u5e42\u7b49\uff0c\u56e0\u4e3a\u5927\u591a\u6570\u547d\u4ee4\u884c\u5de5\u5177\u5047\u8bbe\u64cd\u4f5c\u5b83\u7684\u4eba\u4e86\u89e3\u7cfb\u7edf\u7684\u73b0\u72b6\u3002 \u6bd4\u5982\uff0c\u5047\u8bbe<code>/learningchef/files1.txt</code>\u6587\u4ef6\u5b58\u5728\uff0c\u4ee5\u4e0b<code>mv</code>\u547d\u4ee4\u5728\u7b2c\u4e00\u6b21\u8fd0\u884c\u65f6\u6709\u6548\uff0c\u4f46\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u65f6\u4f1a\u5931\u8d25\uff1a </p> <pre><code>$ mv /learningchef/file1.txt /file1.txt\n</code></pre> <p>\u6d4b\u8bd5<code>Chef</code>\u914d\u65b9\u5355\u662f\u5426\u5e42\u7b49\u7684\u4e00\u4e2a\u597d\u65b9\u6cd5\u662f\u8fd0\u884c<code>kitchen converge</code>\u4e24\u6b21\u3002\u4e00\u6b21\u8fd0\u884c\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u52a8\u4f5c\u65f6\uff0c\u8fd0\u884c\u7684\u7ed3\u679c\u5e94\u8be5\u663e\u793a<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0\u3002 </p> <p>Does our recipe pass the idempotency test? Sadly, no. Here\u2019s a sampling of the output from an initial kitchen converge:</p> <pre><code>$ kitchen converge default-centos65\n...\n Installing Cookbook Gems:\n       Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[chef-server-ctl reconfigure --chef-license=accept] action run\n           - execute chef-server-ctl reconfigure --chef-license=accept\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/3 resources updated in 04 minutes 51 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (5m4.35s).\n</code></pre> <p>\u4ee5\u4e0b\u662f\u7b2c\u4e8c\u6b21\u8fd0\u884c\u7684\u8f93\u51fa<code>Chef</code>\u8ba4\u4e3a\u5b83\u4ecd\u7136\u9700\u8981\u540f\u65b0\u8d44\u6e90<code>3</code>\u4e2a\u8d44\u6e90\u4e2d\u7684<code>2</code>\u4e2a\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u65f6\u88ab\u66f4\u65b0\u3002\u5982\u679c\u914d\u65b9\u5e42\u7b49\uff0c\u6211\u4eec\u5e94\u8be5\u770b\u5230<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0<code>Chef</code>\u5e94\u8be5\u68c0\u67e5\u7cfb\u7edf\u72b6\u6001\u786e\u5b9a\u6ca1\u6709\u9700\u8981\u66f4\u65b0\u7684\u8d44\u6e90\uff1b </p> <pre><code>$ kitchen converge\n...\n Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[chef-server-ctl reconfigure --chef-license=accept] action run\n           - execute chef-server-ctl reconfigure --chef-license=accept\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 1/3 resources updated in 53 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (1m7.63s).\n-----&gt; Kitchen is finished. (1m8.27s)\n\n</code></pre> <p>\u50cf\u524d\u9762\u63d0\u53ca\u7684\u4e00\u6837, \u5927\u591a\u6570\u9ed8\u8ba4<code>Chef</code>\u8d44\u6e90\u662f\u5177\u5907\u5e42\u7b49\u6027\u3002\u6ce8\u610f<code>remote_file</code>\u3002\u8d44\u6e90\u662f\u5e42\u7b49\u7684\u3002\u4ece\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\u5b83\u6c47\u62a5\u4e86\uff08up to date)\u3002 <code>package</code>\u8d44\u6e90\u901a\u5e38\u4e5f\u662f\u5e42\u7b49\u7684.</p> <p>\u5728\u672c\u4f8b\u4e2d\uff0e\u6211\u4eec\u6545\u610f\u521b\u9020\u4e86\u4e00\u4e9b\u6e05\u5883\u4f7f\u5176\u5728<code>RedHat</code>\u7cfb\u5217\u7cfb\u7edf\u4e2d\u51fa\u73b0\u4e00\u4e9b\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u540e\u9762\u5c06\u5c55\u793a\u5982\u4f55\u89e3\u51b3\u3002 </p> <p>\u5728\u7b2c\u4e8c\u6b21\u901a\u8fc7<code>kitchen converge</code>\u6267\u884c<code>Chef</code>\u8fd0\u884c\uff0c\u6211\u4eec\u53d1\u73b0\u4e00\u4e9b<code>package</code>\u548c<code>execute</code>\u8d44\u6e90\u7684\u5e42\u7b49\u6027\u95ee\u9898\u3002 </p> <ol> <li>\u91cd\u65b0\u5b89\u88c5<code>rpm</code>\u5b89\u88c5\u5305\uff0c\u53ef\u6709\u53ef\u65e0\u3002 </li> <li>\u518d\u6b21\u6267\u884c<code>chef-server\u4e00ctl reconfigure</code>\u547d\u4ee4\u3002 </li> </ol> <p>\u8ba9\u6211\u4eec\u89e3\u51b3\u8fd9\u4e9b\u4ee3\u7801\u4e2d\u7684\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u6700\u540e\u7248\u672c\u7684\u5b8c\u5168\u5e42\u7b49\u7684<code>Chef</code>\u4ee3\u7801</p>"},{"location":"chap1/chef_tutorial8/#chefrpm_1","title":"\u7b2c\u4e00\u4e2a\u91cd\u590d\u5b89\u88c5\u7684\u95ee\u9898\u662f<code>Chef</code>\u5f00\u53d1\u8005\u4f7f\u7528\u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4e0b\u8f7d\u5230\u672c\u5730\u7684<code>rpm</code>\u5b89\u88c5\u5305\u65f6\u5e38\u89c1\u7684\u95ee\u9898\u3002","text":"<p>\u4e0e\u5176\u53ea\u662f\u5c06\u4e00\u4e2a\u8fdc\u7a0b\u4e0b\u8f7d\u7684<code>rpm</code>\u4f20\u9012\u7ed9<code>package</code>\u8d44\u6e90\uff0c\u8fd8\u4e0d\u5982\u901a\u8fc7<code>provider</code>\u5c5e\u6027\u544a\u8bc9 <code>package</code>\u8d44\u6e90\u4f7f\u7528<code>Chef::Provider::Package::Rpm</code>\u63d0\u4f9b\u8005\u3002\u540c\u65f6\u9700\u8981\u5236\u5b9a\u5b89\u88c5\u5305\u540d\u5b57\u5b57\u7b26\u4e32\u548c\u901a\u8fc7<code>source</code>\u5c5e\u6027\u6307\u5b9a\u672c\u5730\u7684\u5b89\u88c5\u5305\u5730\u5740\uff1a </p> <pre><code>package package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\nend\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528<code>rpm_package</code>\u5bf9<code>package</code>\u8d44\u6e90\u6307\u5b9a <code>Chef::Provider::Package::Rpm</code>\u63d0\u4f9b\u8005\u63d0\u4f9b\u8005\u3002</p> <p>\u4ee5\u4e0b\u4ee3\u7801\u7b49\u540c\u4e8e\u4ee5\u4e0a</p> <pre><code>rpm_package package_name do\n  source package_local_path\nend\n</code></pre>"},{"location":"chap1/chef_tutorial8/#executechefexecute_1","title":"\u89e3\u51b3\u7b2c\u4e8c\u4e2a<code>execute</code>\u8d44\u6e90\u8be5\u590d\u6267\u884c\u547d\u4ee4\u7684\u95ee\u9898\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\u3002\u53ef\u4ee5\u4f7f\u7528<code>Chef</code>\u5185\u5efa\u7684\u8d44\u6e90\u5b8c\u6210\u4efb\u52a1\u65f6\u5c31\u4e0d\u8981\u4f7f\u7528<code>execute</code>\u8d44\u6e90\uff0c\u56e0\u4e3a\u4f60\u9700\u8981\u8d1f\u8d23\u63a7\u5236\u5e42\u7b49\u6027\u3002","text":"<p>\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u4e2a\u65b9\u6cd5\u662f\u4f7f\u7528<code>not_if</code>\u6765\u4fdd\u62a4<code>execute</code>\u8d44\u6e90\u3002\u8fd9\u6837\u5728<code>not_if</code>\u4e2d\u6307\u5b9a\u7684\u6d4b\u8bd5\u4f1a\u5148\u6267\u884c\uff0c\u5982\u679c\u6d4b\u8bd5\u6210\u529f\uff0c\u8bc1\u660e\u7cfb\u7edf\u5df2\u7ecf\u5728\u7406\u60f3\u72b6\u6001\u4e0b\uff0c\u5219\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e8b\u60c5\u3002</p> <p>\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u6d4b\u8bd5<code>chef-server</code>\u5b89\u88c5\u5305\u662f\u5426\u5df2\u7ecf\u5b89\u88c5\u3002\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u5728<code>execute</code>\u8d44\u6e90\u4e2d\u6dfb\u52a0<code>not_if</code>\u8bed\u53e5\u3002<code>not_if</code>\u4f1a\u6d4b\u8bd5\u5176\u4e2d\u7684\u547d\u4ee4\u7684\u9000\u51fa\u4ee3\u7801\u662f\u54260, \u5982\u679c\u662f<code>execute</code>\u8d44\u6e90\u5c31\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5 </p> <pre><code>execute \"chef-server-ctl reconfigure\" do\n  not_if \"rpm -q chef-server\"\nend\n</code></pre> <p>\u867d\u7136\u53ef\u4ee5\u8fd9\u6837\u89e3\u51b3\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u4f46\u5e76\u4e0d\u662f\u7279\u522b\u7406\u60f3\u3002\u4f60\u9700\u8981\u627e\u5230\u5408\u9002\u7684\u65b9\u6cd5\u6765\u5224\u5b9a<code>Chef</code>\u670d\u52a1\u5668\u662f\u5426\u5df2\u7ecf\u6210\u529f\u5b89\u88c5\uff0c\u800c\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684\u65b9\u6cd5\u5e76\u4e0d\u662f\u90a3\u4e48\u53ef\u9760\u3002\u53e6\u5916\u4e00\u79cd\u89e3\u51b3\u8fd9\u6709\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u53ea\u6709\u5728\u524d\u9762\u6240\u505a\u7684<code>package</code>\u8d44\u6e90\u5b89\u88c5\u6267\u884c\u7684\u65f6\u5019\u624d\u4f7f\u7528<code>execute</code>\u8d44\u6e90\u6267\u884c\u82e5\u4ee4\u5426\u5219\u4e0d\u6267\u884c<code>execute</code>\u8d44\u6e90\u3002\u53ef\u4ee5\u901a\u8fc7<code>notifies</code>\u8bed\u53e5\u6765\u901a\u77e5\u6267\u884c\u5176\u4ed6\u8d44\u6e90\u3002 </p> <p>\u8981\u60f3\u4f7f\u7528<code>notifies</code>\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u4e3a\u6b64\uff0c<code>execute</code>\u8d44\u6e90\u8bed\u53e5\u505a\u4e00\u4e9b\u6539\u53d8\u3002</p> <p>\u9996\u5148\uff0c\u9700\u8981\u4f7f\u5176\u5728\u72ec\u7acb\u5904\u7406\u65f6\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0<code>action :nothing</code>\u5c5e\u80dc\u3002</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u8fd0\u884c\u547d\u4ee4\u79fb\u5230<code>command</code>\u5c5e\u6027\u4e2d\uff0c\u4ece\u800c\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u901a\u8fc7\u66f4\u77ed\u7684\u540d\u5b57\u6765\u901a\u77e5\u6b64\u8d44\u6e90\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u88ab\u4f20\u4eba<code>execute</code>\u8d44\u6e90\u7684<code>name</code>\u5c5e\u6027\u88ab\u4f5c\u4e3a<code>command</code>\u5c5e\u80dc\u4f7f\u7528\u3002</p> <p>\u5f53\u6211\u4eec\u60f3\u7528\u4e00\u884c\u4ee3\u7801\u6765\u8fd0\u884c\u4e00\u4e2a\u547d\u4ee4\u65f6\uff0c\u8fd9\u6837\u505a\u5f88\u597d\uff0c\u4f46\u60f3\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u901a\u77e5\u8fd9\u4e2a\u8d44\u6e90\u65f6\u5219\u4e0d\u662f\u6700\u7406\u60f3\u7684\u65b9\u6cd5\uff0c\u56e0\u4e3a\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8d44\u6e90\u4e2d\u6307\u5b9a\u6574\u4e2a\u547d\u4ee4\u3002\u73b0\u5728\u6211\u5bf9<code>execute</code>\u8d44\u6e90\u505a\u51fa\u4ee5\u4e0b\u6539\u53d8\uff1a </p> <pre><code># reconfigure the installation\nexecute 'reconfigure-chef-server' do\n  command 'chef-server-ctl reconfigure'\n  action :nothing\nend\n</code></pre> <p>\u7136\u540e\u5728<code>package</code>\u8d44\u6e90\u4e2d\u6dfb\u52a0<code>notifies</code>\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <ul> <li><code>notifies</code>\u5c5e\u6027\u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\u52a8\u4f5c\u3001\u8981\u901a\u77e5\u7684\u8d44\u6e90\u7684\u540d\u5b57\u548c\u6267\u884c\u52a8\u4f5c\u7684\u65f6\u95f4\u3002</li> </ul> <p>\u5982\u4ee5\u4e0b\u4ee3\u7801\u6240\uff0c\u6211\u4eec\u60f3\u901a\u77e5<code>execute[reconfigure-chef-server]</code>\u8d44\u6e90\u6267\u884c<code>:run</code>\u52a8\u4f5c\uff0c\u5e76\u7acb\u5373\u6267\u884c\u3002</p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: default\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\npackage_url = node['enterprise-chef']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-server]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-server' do\n  command 'private-chef-ctl reconfigure'\n  action :nothing\nend\n</code></pre> <p>\u4f7f\u7528\u8fd9\u4e2a\u7248\u672c\u7684\u4ee3\u7801\u518d\u6b21\u8fd0\u884c<code>kitchen converge</code>.\u4e95\u5728\u8f93\u51fa\u4e2d\u6ce8\u610f\u5b83\u6c47\u62a5\u7684\u662f<code>0</code>\u4e2a\u8d44\u6e90\u88ab\u66f4\u65b0\uff1a</p> <pre><code>$ kitchen converge\n Compiling Cookbooks...\n       Converging 3 resources\n       Recipe: enterprise-chef::default\n         * remote_file[/tmp/kitchen/cache/chef-server-core-13.1.13-1.el6.x86_64.rpm] action create (up to date)\n         * yum_package[chef-server-core-13.1.13-1.el6.x86_64.rpm] action install (up to date)\n         * execute[reconfigure-chef-server] action nothing (skipped due to action :nothing)\n\n       Running handlers:\n       Running handlers complete\n       Chef Infra Client finished, 0/3 resources updated in 04 seconds\n       Downloading files from &lt;default-centos65&gt;\n       Finished converging &lt;default-centos65&gt; (0m18.04s).\n</code></pre> <p>\u8fd9\u662f\u6211\u4eec\u671f\u5f85\u7684\u7ed3\u679c\uff0c<code>Chef</code>\u6ca1\u6709\u6267\u884c\u4efb\u4f55\u8d44\u6e90\u5bf9\u7cfb\u7edf\u4f5c\u51fa\u4efb\u4f55\u6539\u53d8\uff1a </p> <p>\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\uff0c\u5728\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\uff0c\u59cb\u7ec8\u8981\u68c0\u67e5\u914d\u65b9\u5355\u662f\u5426\u5e42\u7b49\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u5982\u679c\u6211\u4eec\u5c06\u7b2c\u4e00\u4e2a\u7248\u672c\u7684\u914d\u65b9\u5355\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff0c\u4e00\u822c\u6765\u8bb2\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u8282\u70b9\u4e0a<code>Chef-client</code>\u4f1a\u5b9a\u671f\u8fd0\u884c\uff08\u6bd4\u5982\u6bcf15\u5206\u949f\uff09\uff0c\u6240\u6709\u5728\u8fd0\u884c\u6e05\u5355\u4e2d\u62e5\u6709\u6b64\u914d\u65b9\u5355\u7684\u8282\u70b9\u5c06\u6bcf15\u5206\u949f\u91cd\u65b0\u5b89\u88c5\u4e00\u6b21<code>Chef</code>\u670d\u52a1\u5668\uff01 </p>"},{"location":"chap1/chef_tutorial8/#11chef","title":"11\u3001\u914d\u7f6e\u4f01\u4e1aChef\u670d\u52a1\u5668","text":"<p>\u5982\u679c\u6210\u529f\u5b89\u88c5<code>Chef</code>\u670d\u52a1\u5668\uff0c\u5c31\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528\u4f60\u5728<code>kitehen.yml</code>\u4e2d\u8bbe\u5b9a\u7684<code>private network ip</code>\u5730\u5740\u8bbf\u95ee\u670d\u52a1\u5668\u7ba1\u7406\u7f51\u9875\u3002</p> <p></p> <p>Chef Manage</p>"},{"location":"chap1/chef_tutorial8/#11-1-chef-serverchef-manage","title":"11-1 \u65b0\u7684\u83dc\u8c31<code>chef-server</code>\u548c<code>chef-manage</code>","text":"<p><code>/enterprise-chef/attributes/default.rb</code></p> <pre><code>default['chefserver']['url'] = 'https://packages.chef.io/files/stable/chef-server/13.1.13/el/6/chef-server-core-13.1.13-1.el6.x86_64.rpm'\ndefault['chefmanage']['url'] = 'https://packages.chef.io/files/stable/chef-manage/2.5.16/el/6/chef-manage-2.5.16-1.el6.x86_64.rpm'\n</code></pre> <p><code>/enterprise-chef/recipes/manage.rb</code></p> <pre><code>## Install chef manage\n\npackage_url = node['chefmanage']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-manage]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-manage' do\n  command 'chef-server-ctl install chef-manage'\n  command 'chef-manage-ctl reconfigure --accept-license'\n  # action :nothing\n  action :run\nend\n</code></pre> <p><code>/enterprise-chef/recipes/default.rb</code></p> <pre><code>## Install chef server and then install  chef manage\n\npackage_url = node['chefserver']['url']\npackage_name = ::File.basename(package_url)\npackage_local_path = \"#{Chef::Config[:file_cache_path]}/#{package_name}\"\n\n# omnibus_package is remote (i.e., a URL) let's download it\n# \u4ece\u4e00\u4e2a\u8fdc\u7a0b\u4f4d\u7f6e\uff08\u6bd4\u5982\u7f51\u7ad9\uff09\u4f20\u8f93\u4e00\u4e2a\u6587\u4ef6 remote_file\nremote_file package_local_path do\n  source package_url\nend\n\n# \u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7a0b\u5e8f\u5b89\u88c5\u7ba1\u7406\u5668\u5b89\u88c5\u4e00\u4e2a\u7a0b\u5e8f\u5305\npackage package_name do\n  source package_local_path\n  provider Chef::Provider::Package::Rpm\n  notifies :run, 'execute[reconfigure-chef-server]', :immediately\n# notifies :before, :delayed, :immediate, :immediately\nend\n\n# reconfigure the installation\n# execute actions: \":nothing\" and \":run\"\nexecute 'reconfigure-chef-server' do\n  # command 'chef-server-ctl install chef-manage'\n  command 'chef-server-ctl reconfigure --chef-license=accept'\n  # command 'chef-manage-ctl reconfigure'\n  # action :run\n  action :nothing\nend\n\ninclude_recipe 'enterprise-chef::manage'\n\ninclude_recipe 'enterprise-chef::adduser'\ninclude_recipe 'enterprise-chef::addorganization'\n</code></pre> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u4f7f\u7528\u4e86<code>192.168.33.34</code>\u4f5c\u4e3a\u5730\u5740, \u8bbf\u95ee\u8fd9\u4e2a\u5730\u5740\uff0c\u5728\u5ffd\u7565\u5173\u4e8e<code>SSL</code>\u8bc1\u4e66\u7684\u8b66\u544a\u4e4b\u540e\uff0c\u70b9\u51fb<code>Sign up</code>\uff08\u6ce8\u518c\uff09\u94fe\u63a5\uff0c\u5982\u56fe\u63d0\u793a\u4f60\u6ce8\u518c\u4e00\u4e2a\u7528\u6237\u8d26\u6237\u3002\u586b\u4eba\u76f8\u5173\u4fe1\u606f\uff0c\u7136\u540e\u5355\u51fb<code>Submit</code>\uff08\u63d0\u4ea4\uff09\u6309\u94ae\u3002</p> <p></p> <p></p> <p>\u6211\u4eec\u5728\u7528\u6237\u8d26\u6237\u4e2d\u4f7f\u7528\u7684\u503c\uff0c\u5f53\u7136\uff0c\u4f60\u4f7f\u7528\u7684\u503c\u4f1a\u5b8c\u5168\u4e0d\u4e00\u6837 \u70b9\u51fb<code>Submit</code>\u6309\u94ae\u4f01\u4e1a<code>Chef</code>\u7684\u7f51\u9875<code>UI</code>\u4f1a\u544a\u8bc9\u4f60\u4e0b\u4e00\u6b65\u5c06\u521b\u5efa\u4e00\u4e2a\u7ec4\u7ec7\u3002\u5355\u51fb<code>Create\uff08\u521b\u5efa\uff09</code>\u94fe\u63a5\u521b\u5efa\u4e00\u4e2a\u7ec4\u7ec7.</p> <p>\u5982\u56fe\u6240\u793a \u7ec4\u7ec7\u4ee3\u8868\u516c\u53f8\u6216\u7ec4\u7ec7\u3002<code>Chef</code>\u4f7f\u7528\u4f60\u6307\u5b9a\u7684\u7ec4\u7ec7\u540d\u79f0\u4f5c\u4e3a\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u7ec4\u7ec7\u8eab\u4efd\u7684ID.\u56fe\u5c55\u793a\u7684\u662f\u6211\u4eec\u7684\u8bbe\u5b9a\u4e2d\u586b\u5199\u7684\u7ec4\u7ec7\u4fe1\u606f\u3002</p> <p></p> <p></p> <pre><code>chef generate recipe adduser\n</code></pre> <p><code>/enterprise-chef/recipes/adduser.rb</code></p> <pre><code>execute 'Add-chef-server-newuser' do\n    # command 'chef-server-ctl user-delete admin'\n    command 'sudo chef-server-ctl user-create admin John Smith john_smith@example.com password --filename=/etc/chef/admin.pem'\n    action :run\n    # action: nothing\nend\n</code></pre> <ul> <li>username: admin</li> <li>password: password</li> </ul> <p><code>/enterprise-chef/recipes/addorganization.rb</code></p> <pre><code>#\n# Cookbook:: enterprise-chef\n# Recipe:: adduser\n#\n# Copyright:: 2019, The Authors, All Rights Reserved.\n\nexecute 'Add-chef-server-organization' do\n    # command 'chef-server-ctl org-delete ja'\n    command 'sudo chef-server-ctl org-create  ja \"Ja-Chef, Inc\" --association_user admin --filename=/etc/chef/ja-validator.pem'\n    # action :run\n    action :run\nend\n\n# Create organization\n# ja Ja-Chef, Inc\n# --association_user admin\n\n* username: ja\n* password: Ja-Chef\n</code></pre> <p></p> <p>\u5355\u51fb<code>Create Organization</code>\uff08\u521b\u5efa\u7ec4\u7ec7\uff09\u6309\u94ae\u540e\uff0c\u63d0\u793a\u4f60\u4fdd\u5b58\u4e24\u4e2a\u6587\u4ef6\uff1a\u4e00\u4e2a\u9a8c\u8bc1\u5bc6\u94a5\u548c\u4e00 \u4e2a<code>knife</code>\u914d\u7f6e\u6587\u4ef6\uff0c</p> <p>\u521b\u5efa\u7ec4\u7ec7</p> <p></p> <p>\u9009\u62e9\u7ec4\u7ec7</p> <p></p> <p>\u4e0b\u8f7d\u79d8\u94a5(chef-repo)</p> <p></p> <p><code>kitchen login</code> to download <code>/tmp/ja-validator.pem</code></p> <pre><code>$ kitchen login\nLast login: Mon Dec  2 05:53:46 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ cd /tmp/\n[vagrant@default-centos65 tmp]$ ls -la\ntotal 72\ndrwxrwxrwt.  8 root          root           4096 Dec  2 05:47 .\ndr-xr-xr-x. 22 root          root           4096 Dec  1 10:24 ..\ndrwxrwxrwt   2 root          root           4096 Dec  1 10:24 .ICE-unix\nsrwxrwxrwx   1 opscode-pgsql opscode-pgsql     0 Dec  2 05:31 .s.PGSQL.5432\n-rw-------   1 opscode-pgsql opscode-pgsql    63 Dec  2 05:31 .s.PGSQL.5432.lock\n-rw-r--r--   1 root          root           1678 Dec  2 05:47 admin.pem\ndrwxr-xr-x   3 opscode       opscode        4096 Dec  1 11:29 bundler\ndrwxr-xr-x   2 opscode       opscode        4096 Dec  1 11:31 hsperfdata_opscode\n-rw-r--r--   1 root          root          23248 Dec  1 10:25 install.sh\n-rw-r--r--   1 root          root           1678 Dec  2 05:47 ja-validator.pem\ndrwxrwxr-x   7 vagrant       vagrant        4096 Dec  1 10:30 kitchen\n-rw-r--r--   1 root          root            368 Dec  1 10:25 stderr\ndrwx------   2 root          root           4096 Dec  1 10:25 vmware-root\ndrwx------   2 root          root           4096 Dec  1 10:25 vmware-root_1102-273056232\n</code></pre> <p>\u8fd9\u4e09\u4e2a\u6587\u4ef6\u90fd\u4e0b\u8f7d\u597d\u540e, \u56de\u5230<code>chef-repo</code>\u76ee\u5f55\u5c06\u5176\u4f5c\u4e3a\u5f53\u524d\u76ee\u5f55\uff0c \u7136\u540e\u521b\u5efa\u4e00\u4e2a<code>cehf-repo/.chef</code>\u5b50\u76ee\u5f55\u3002 \u5b8c\u6210\u540e, \u4f60\u7684<code>chef-repo</code>\u76ee\u5f55\u7684\u7ed3\u6784\u5982\u4e0b\u6240\u793a</p> <pre><code>$ tree -a chef-repo/\nchef-repo/\n\u251c\u2500\u2500 .chef\n\u2502   \u251c\u2500\u2500 admin.pem\n\u2502   \u251c\u2500\u2500 ja-validator.pem\n\u2502   \u2514\u2500\u2500 knife.rb\n\u251c\u2500\u2500 .gitignore\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 cookbooks\n\u2502   \u251c\u2500\u2500 chefignore\n\u2502   \u2514\u2500\u2500 starter\n\u2502       \u251c\u2500\u2500 attributes\n\u2502       \u2502   \u2514\u2500\u2500 default.rb\n\u2502       \u251c\u2500\u2500 files\n\u2502       \u2502   \u2514\u2500\u2500 default\n\u2502       \u2502       \u2514\u2500\u2500 sample.txt\n\u2502       \u251c\u2500\u2500 metadata.rb\n\u2502       \u251c\u2500\u2500 recipes\n\u2502       \u2502   \u2514\u2500\u2500 default.rb\n\u2502       \u2514\u2500\u2500 templates\n\u2502           \u2514\u2500\u2500 default\n\u2502               \u2514\u2500\u2500 sample.erb\n\u2514\u2500\u2500 roles\n    \u2514\u2500\u2500 starter.rb\n\n10 directories, 12 files\n\n</code></pre> <ul> <li><code>&lt;usernamee&gt;.pem</code>\u6587\u4ef6\u662f\u7528\u6765\u5411<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u4f60\u7528\u6237\u8eab\u4efd\u7684\u5bc6\u94a5\u3002\u8981\u628a\u5b83\u89c6\u4f5c\u5bc6\u7801\u4e95\u4e14 \u4e0d\u8981\u4fee\u6539\u6587\u4ef6\u5185\u5bb9\u3002 </li> <li><code>&lt;organization&gt;.pem</code>\u6587\u4ef6\u662f\u7528\u6765\u5411<code>Chef</code>\u670d\u52a1\u5668\u9a8c\u8bc1\u7ec4\u7ec7\u8eab\u4efd\u7684\u5bc6\u94a5\u3002\u4e5f\u8981\u628a\u521b\u89c1\u4e3a\u5bc6\u7801\uff0c\u4f46\u8981\u5171\u4eab\u7ed9\u7ec4\u7ec7\u5185\u6240\u6709\u7684<code>Chef</code>\u5f00\u53d1\u8005\u3002\u4efb\u4f55\u9700\u8981\u8bbf\u95ee<code>Chef</code>\u7684\u7ec4\u7ec7\u5185\u90b9\u4eba\u5458\u90fd\u9700\u8981\u8fd9\u4e2a\u6587\u4ef6\u3002\u4e0d\u8981\u66f4\u6539\u6587\u4ef6\u5185\u5bb9\u3002 </li> </ul>"},{"location":"chap1/chef_tutorial8/#11-2-rsa","title":"11-2 <code>RSA</code>\u94a5\u5319\u5bf9\u513f","text":"<p><code>Chef</code>\u7684<code>pem</code>\u6587\u4ef6\u5305\u542b\u6ce8\u518c\u8fc7\u7a0b\u4e2d\u751f\u6210\u7684<code>RSA</code>\u79c1\u94a5\u3002<code>Chef</code>\u4e3a\u4f60\u7684\u7ec4\u7ec7\u751f\u6210\u4e00\u4e2a<code>RSA</code>\u94a5\u5319\u5bf9\u513f\u516c\u94a5\u5b58\u50a8\u5728\u4f01\u4e1a<code>Chef</code>\u5728\u670d\u52a1\u5668\u4e0a\u5e76\u5728\u7a0b\u5e8f\u5411<code>Chef</code>\u670d\u52a1\u5668\u53d1\u9001\u8bd7\u6c42\u65f6\u7528\u6765\u9a8c\u8bc1\u7ec4\u7ec7\u7684\u8eab\u4efd </p> <p>\u4e0d\u50cf<code>.pem</code>\u6587\u4ef6\uff0c<code>knife</code>\u6587\u4ef6\u53ef\u4ee5\u66f4\u6539\u6216\u81ea\u5b9a\u4e49\u3002<code>knife.rb</code>\u6587\u4ef6\u662f\u4e00\u4e2a<code>Ruby</code>\u6587\u4ef6\uff0c\u6267\u884c\u547d\u4ee4\u65f6\u8bfb\u53d6\u8fd9\u4e2a\u6587\u4ef6 </p> <pre><code>$ knife client list\nERROR: SSL Validation failure connecting to host: default-centos65.vagrantup.com - SSL_connect returned=1 errno=0 state=error: certificate verify failed (self signed certificate)\nERROR: Could not establish a secure connection to the server.\nUse `knife ssl check` to troubleshoot your SSL configuration.\nIf your server uses a self-signed certificate, you can use\n`knife ssl fetch` to make knife trust the server's certificates.\n\nOriginal Exception: OpenSSL::SSL::SSLError: SSL Error connecting to https://default-centos\n</code></pre> <pre><code>current_dir = File.dirname(__FILE__)\nlog_level                :info\nlog_location             STDOUT\nnode_name                \"admin\"\nclient_key               \"#{current_dir}/admin.pem\"\nchef_server_url          \"https://default-centos65.vagrantup.com/organizations/ja\"\ncookbook_path            [\"#{current_dir}/../cookbooks\"]\nssl_verify_mode          :verify_none \n</code></pre> <p>\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684<code>chef_server_url</code>\u4f7f\u7528\u4e86\u5047\u7684<code>DNS</code>\u4e3b\u673a\u540d<code>default-centos65.vagrantup.com</code>\u56e0\u4e3a\u8fd9\u662f<code>vagrant</code>\u8bbe\u5b9a\u7684\u4e3b\u673a\u540d\u3002\u5982\u679c\u4f60\u8bd5\u56fe\u8bbf\u95ee<code>\"https://default-centos65.vagrantup.com/organizations/ja\"</code>,\u4f1a\u53d1\u73b0\u5b83\u662f\u65e0\u6548\u7684</p> <p><code>Chef</code>\u670d\u52a1\u5668\u9700\u8981\u673a\u5668\u62e5\u6709\u80fd\u591f\u6b63\u786e\u89e3\u6790\u7684\u5b8c\u6574\u57df\u540d\uff08FQDN)\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5e94\u8be5\u5728\u5b89\u88c5<code>chef</code>\u670d\u52a1\u5668\u4e4b\u524d\u5728\u57df\u540d(<code>DNS</code>)\u670d\u52a1\u5668\u4e2d\u8bbe\u5b9a<code>Chef</code>\u7684\u4e3b\u673a\u540d\u3002\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u4e3a\u65b9\u4fbf\u8d77\u89c1\u8ba9\u6211\u4eec\u628a<code>default-centos65.vagrantup.com</code>\u52a0\u5230\u673a\u5668\u7684\u672c\u5730<code>host</code>\u6570\u636e\u5e93 </p> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5411<code>host</code>\u6570\u636e\u6dfb\u52a0\u5185\u5bb9\u3002</p> <p>Linux/Mac OS X:</p> <pre><code>$ sudo sh -c \"echo '192.168.33.34 default-centos65.vagrantup.com' &gt;&gt; /etc/hosts\" \n</code></pre> <p>\u73b0\u5728, \u5982\u679c\u4f60\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee<code>https://default-centos65.vagrantup.com</code>, \u4e3b\u673a\u4f1a\u8ba4\u4e3a\u5b83\u662f\u4e00\u4e2a\u6709\u6548\u7684\u5730\u5740 </p> <p>\u53ef\u4ee5\u5728<code>knife.rb</code>\u4e2d\u6dfb\u52a0\u5176\u4ed6\u8bbe\u7f6e\uff0c\u6bd4\u5982<code>EC2</code>\u7684\u7528\u6237\u4fe1\u606f\u3001\u4ee3\u7406\u4fe1\u606f\u3001\u52a0\u5bc6\u6570\u636e\u5305\u8bbe\u5b9a\u7b49\u4f60\u548c\u4f60\u7ec4\u7ec7\u5185\u5176\u4ed6\u6210\u5458\u7684<code>knife.rb</code>\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u5f88\u591a\u5185\u5bb9\u662f\u9488\u5bf9\u7528\u6237\u548c\u6240\u7528\u7684\u5f00\u53d1\u673a\u5668\u7684\u3002\u9664\u975e\u5c06\u5bc6\u7801\u6216\u8bbf\u95ee\u5bc6\u94a5\u5b58\u50a8\u5728<code>knife.rb</code>\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5426\u5219\u4e0d\u9700\u5c06\u5176\u89c6\u4e3a\u5bc6\u7801\uff0e </p>"},{"location":"chap1/chef_tutorial8/#11-3","title":"11-3 \u6d4b\u8bd5\u8fde\u63a5","text":"<p>\u5728<code>Chef</code>\u76ee\u5f55\u4e0b\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002\u6253\u5f00\u547d\u4ee4\u884c\u7a0b\u5e8f\u5e76\u5c06<code>chef-repo</code>\u505a\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 </p> <pre><code>$ cd ~/chef-repo\n</code></pre> <p>\u73b0\u5728\uff0c \u4f60\u53ef\u4ee5\u4f7f\u7528<code>knife</code> (<code>Chef</code>\u670d\u52a1\u5668\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff09\u6765\u6d4b\u8bd5\u4f60\u548c<code>Chef</code>\u670d\u52a1\u5668\u7684\u8fde\u63a5\u548c \u8eab\u4efd\u9a8c\u8bc1\u3002</p> <p>\u5728\u5199\u4f5c\u672c\u4e66\u65f6\uff0c<code>Chef</code>\u5c1a\u672a\u63d0\u4f9b\u4e00\u4e2a\u4e13\u95e8\u7528\u6765\u201d\u6d4b\u8bd5\u8fde\u63a5\u201c\u7684\u547d\u4ee4\u3002\u7136\u800c\uff0c\u901a\u8fc7\u8be2\u95ee<code>Chef</code>\u670d\u52a1\u5668\u6765\u5217\u4e3e\u5ba2\u6237\u7aef\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1\u4ee5\u4e0b\u51e0\u70b9 </p> <ul> <li>\u7f51\u7edc\u53ef\u4ee5\u8fde\u63a5\u5230\u670d\u52a1\u5668\u3002 </li> <li>\u9a8c\u8bc1\u6587\u4ef6\u90fd\u5728\u6b63\u786e\u7684\u4f4d\u7f6e\u3002 </li> <li><code>Chef</code>\u8bfb\u5356\u53d6\u9a8c\u8bc1\u6587\u4ef6\u3002 </li> <li>\u5f00\u53d1\u5de5\u4f5c\u7ad9\u53ef\u4ee5\u6536\u5230\u6765\u81ea<code>Chef</code>\u670d\u52a1\u5668\u7684\u53cd\u9988\u3002 </li> </ul> <p>\u5728\u547d\u4ee4\u884c\u7a0b\u5e8f\u4e2d\u8fd0\u884c<code>knife client list</code>\u547d\u4ee4\uff0c\u4f60\u4f1a\u89c1\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a </p> <pre><code>$ knife client list\nja-validator\n</code></pre> <p>\u5982\u679c\u4f60\u9047\u5230\u9519\u8bef\uff0c\u53ef\u4ee5\u68c0\u67e5\u4ee5\u4e0b\u9879\u76ee\u3002</p> <ol> <li>\u786e\u8ba4\u4f60\u53ef\u4ee5\u4ece\u7f51\u9875\u6d4f\u89c8\u5668\u8bbf\u95ee\u547d\u4ee4  </li> <li>\u786e\u8ba4\u4f60\u5728<code>chef-repo</code>\u76ee\u5f55\u5185\u8fd0\u884c\u547d\u4ee4\u3002 </li> <li>\u786e\u8ba4<code>.chef</code>\u76ee\u5f55\u5305\u542b\u4e24\u4e2a<code>.pem</code>\u6587\u4ef6\u4ee5\u53ca\u4e00\u4e2a<code>knife.rb</code>\u6587\u4ef6\u3002 </li> <li>\u786e\u8ba4\u4f60\u7684\u8eab\u4efd\u9a8c\u8bc1\u6587\u4ef6\u62e5\u6709\u6b63\u786e\u7684\u6587\u4ef6\u6743\u9650\uff08\u53ea\u6709\u7528\u6237\u53ef\u8bfb\uff09\u3002 </li> </ol> <p>\u5982\u679c\u786e\u8ba4\u4ee5\u4e0a\u90fd\u8bbe\u5b9a\u6b63\u786e\u4f46\u4ecd\u7136\u65e0\u6cd5\u8fde\u63a5\u5230<code>Chef</code>\u670d\u52a1\u5668\uff0c</p> <p>\u9a8c\u8bc1\u5f00\u53d1\u673a\u5668\u53ef\u4ee5\u8fde\u63a5\u5230<code>Chef</code>\u670d\u52a1\u5668\u4e4b\u540e\uff0c\u8ba9\u6211\u4eec\u521b\u5efa\u53e6\u4e00\u4e2a\u83dc\u8c31\uff0c\u4f7f\u6d4b\u8bd5\u8282\u70b9\u53ef\u6ce8\u518c\u5e76\u4ea4\u7531Chef\u670d\u52a1\u5668\u7ba1\u7406\u3002 </p>"},{"location":"chap1/chef_tutorial8/#12","title":"12\u3001\u51c6\u5907\u4e00\u4e2a\u65b0\u8282\u70b9","text":"<p><code>Chef</code>\u7528\"Bootstraping\" \u8fd9\u4e2a\u672f\u8bed\u6765\u6307\u4ee3\u5c06\u4e00\u4e2a\u8fdc\u7a0b\u7cfb\u7edf\u8c01\u52a1\u597d\u7531<code>chef</code>\u6765\u7ba1\u7406\u7684\u8fc7\u7a0b\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\u4e95\u5c06\u5176\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u6ce8\u518c\u3002\u5728\u6b64\uff0c \u6211\u4eec<code>bootstrap</code>\u7ffb\u8bd1\u4e3a\u201c\u51c6\u5907\u201d\uff0c \u4f46\u7531\u4e8e\u5728\u771f\u5b9e\u73af\u63a9\u548c\u6b64\u51c6\u5907\u8fc7\u7a0b\u901a\u5e38\u662f\u8282\u70b9\u542f\u52a8\u540e\u7684\u7b2c\u4e00\u9879\u4efb\u52a1\uff0c \u6240\u4ee5<code>bootstrap</code>\u8282\u70b9, \u4e5f\u7ecf\u5e38\u53ef\u4ee5\u7406\u89e3\u4e3a\u542f\u52a8\u65b0\u7684\u8282\u70b9 </p>"},{"location":"chap1/chef_tutorial8/#12-1","title":"12-1 \u5728\u6c99\u76d2\u73af\u5883\u4e2d\u521b\u5efa\u8282\u70b9","text":"<p>\u8ddf\u6211\u4eec, \u7c7b\u4f3c\u8ba9\u6211\u4eec\u4f7f\u7528<code>Test Kitchen</code>\u6765\u5b9a\u4e49\u4e00\u4e2a\u9879\u76ee\u5728\u6c99\u76d2\u73af\u5883\u4e2d\u521b\u60f3\u4e00\u4e2a\u8282\u70b9</p> <p>\u5728\u4e0e\u5148\u524d\u521b\u5efa\u7684<code>chef server</code>\u76ee\u5f55\u5e73\u884c\u7684\u4f4d\u754c\u521b\u5efa\u4e2a<code>node</code>\u76ee\u5f55,\u8fd9\u5176\u5b9e\u90e8\u7f72\u83dc\u8c31\uff0c \u53ea\u662f\u4e00\u4e2a \u662f<code>Test Kitchen</code>\u9879\u76ee\uff0c \u4f46\u5c06\u5176\u4f4d\u4e8e<code>chef-Server</code>\u7684\u5e73\u884c\u4f4d\u7f6e\u6709\u52a9\u4e8e\u6211\u4eec\u6765\u56de\u5207\u6362\uff0e </p> <p>\u521b\u5efa<code>~/chef-repo/cookbooks/node</code>\u76ee\u5f55, \u5e76\u5c06\u5176\u4f5c\u4e3a\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55 </p> <pre><code>$ cd ~/chef-repo/cookbooks\n$ mkdir node\n$ cd node\n</code></pre> <pre><code>$ knife client list\nja-validator\n</code></pre> <p>\u8fd9\u4e2a<code>node</code>\u76ee\u5f55\u662f\u4e00\u4e2a<code>Test Kitchen</code>\u9879\u76ee\u800c\u4e0d\u662f\u83dc\u8c31\u56e0\u6b64\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>kitchen.yml</code>\u7684<code>Test Kitchen</code>\u6587\u4ef6 </p> <pre><code>$ kitchen init --create-gemfile\n      create  kitchen.yml\n      create  chefignore\n      create  test/integration/default\n      create  Gemfile\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n\n\n$  bundle install\nFetching gem metadata from https://rubygems.org/.........\nFetching gem metadata from https://rubygems.org/.\nResolving dependencies...\nUsing bcrypt_pbkdf 1.0.1\nUsing builder 3.2.3\nUsing bundler 2.0.2\n..\n</code></pre> <p>\u7f16\u8f91<code>kitchen.yml</code>\u6587\u4ef6\u4ee5\u4f7f\u7528\u4e3a\u672c\u4e66\u51c6\u5907\u7684<code>CentOS 6.5</code>\u673a\u5668\u6a21\u677f\u3002 \u540c\u65f6\u50cf\u6211\u4eec\u5728\u7b2c7\u7ae0\u4e2d\u505a\u8fc7\u7684\u4e00\u6837\uff0c\u5206\u914d\u4e00\u4e2a\u79c1\u6709\u7f51\u7edc\u5730\u5740\u3002\u6211\u4eec\u7684\u4f8b\u5b50\u5c06\u4f7f\u7528<code>192.168.33.35</code>, \u786e\u4fdd\u4f7f\u7528\u7684\u5730\u5740\u548c\u4f60\u7684Chef\u670d\u52a1\u5668\u5730\u5740\u3014\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u4e3a<code>192.168.33.34</code>)\u4e0d\u76f8\u51b2\u7a81 </p> <p>\u6ce8\u610f\u5728<code>suites</code>\u4e0b\u6211\u4eec\u628a\u8fd9\u4e2a\u5b9e\u4f8b\u547d\u540d\u4e3a<code>node</code>\u56e0\u4e3a\u8fd9\u4e2a\u6c99\u76d2\u73af\u5883\u5c06\u8fd0\u884c\u6211\u4eec\u7684\u4fa7\u8bd5\u8282\u70b9\u3002\u6211\u4eec\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u6c99\u76d2\u73af\u5883\u8fd0\u884c\u7740<code>Chef</code>\u670d\u52a1\u5668\u3002\u6307\u5b9a\u5b8c\u5168\u4e0d\u540c\u7684\u540d\u5b57\u6709\u52a9\u5e72\u533a\u5206\u4e0d\u540c\u7684\u6c99\u76d2\u73af\u5883. </p> <p>\u540c\u65f6\u6211\u4eec\u4e3a<code>chef-repo</code>\u5f55\u914d\u7f6e\u4e86\u540c\u6b65\u6240\u793a\uff0c<code>Vagrant</code>\u53ef\u4ee5\u5c06<code>Chef</code>\u5f00\u53d1\u673a\u5668\u4e0a\u7684\u76ee\u5f55\u4e0e\u6c99\u76d2\u73af\u5883\u5dfe\u7684\u865a\u62df\u673a\u5dfe\u7684\u76ee\u5f55\u8fdb\u884c\u540c\u6b65\u3002</p> <p>\u4ee5\u4e0b<code>kitchen.yml</code>\u6587\u4ef6\u4e2d\u7684<code>synced_folders:</code>\u8bbe\u7f6e\u786e\u4fdd\u5bbf\u4e3b\u673a\u5668\u4e0a\u7684<code>\uff3fchef-repo\uff3f\u76ee</code>\u5f55\u4e0e\u865a\u62df\u673a\u4e2d\u7684<code>/chef-repo</code>\u76ee\u5f55\u540c\u6b65</p> <pre><code>...\n      synced_folders:\n      - [\"../../../chef-repo\", \"/chef-repo\"]\n...\n</code></pre> <p></p> <p>\u540c\u6b65\u7684<code>/chef-repo</code>\u76ee\u5f55\u5c06\u5728\u540e\u9762\u7b2c\u7528\u4e8e\u914d\u7f6e\u670d\u52a1\u5668\u7684SSL\u9a8c\u8bc1\u3002</p> <p><code>chef-repo/cookbooks/node/kitchen.yml</code></p> <pre><code>---\ndriver:\n  name: vagrant\n  provider: vmware_desktop\n\nprovisioner:\n  name: shell\n\nplatforms:\n  - name: centos65\n    driver:\n      box: learningchef/centos65\n      box_url: learningchef/centos65\n      network:\n      - [\"private_network\", {ip: \"192.168.33.35\"}]\n      synced_folders:\n      - [\"../../../chef-repo\", \"/chef-repo\"]\n\nsuites:\n  - name: node\n    attributes:\n</code></pre> <pre><code>$ kitchen create\n</code></pre>"},{"location":"chap1/chef_tutorial8/#13knife","title":"13\u3001\u7528Knife\u542f\u52a8\u5e76\u51c6\u5907\u8282\u70b9","text":"<p>\u6211\u4eec\u914d\u7f6e\u4e86\u4e00\u4e2a<code>Chef</code>\u670d \u5668\uff08\u6216\u4f7f\u7528\u4e86\u6258\u7ba1\u4f01\u4e1aChef)\uff0c\u914d\u7f6e\u4e86<code>knife.rb</code>\u4ee5\u53ca\u5408\u9002\u7684\u5bc6\u94a5\u6765\u4ece\u6211\u4eec\u7684\u5bbf\u4e3b\u673a\u5668\uff08\u5f00\u53d1\u673a\u5668\uff09\u548c<code>Chef</code>\u670d\u52a1\u5668\u901a\u4fe1\u3002\u6211\u4eec\u901a\u8fc7\u8fd0\u884c<code>knife client list</code>\u5e76\u5f97\u786e\u7684\u7ed3\u679c\u9a8c\u8bc1\u53cc\u65b9\u7684\u901a\u4fe1 </p> <p></p> <p>\u73b0\u5728\u8ba9\u6211\u4eec\u50cf\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e00\u6837\u4f7f\u7528<code>knife bootstrap</code>\u521b\u5efa\u4e00\u4e2a\u8282\u70b9\uff08\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c \u6211\u4eec\u4e0d\u4f1a\u7528\u5230<code>Test Kitchen</code>!\uff09</p> <p>\u5f53\u6211\u4eec\u5728\u5bbf\u4e3b\u673a\u5668\u4e0a\u8fd0\u884c<code>knife bootstrap</code>\u65f6\uff0c\u5b83\u5c06\u5728\u8282\u70b9\u4e0a\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\u5e76\u4e0eChef\u670d\u52a1\u5668\u6ce8\u518c\u3002 </p> <p>\u8282\u70b9\u5fc5\u987b\u5728\u672c\u5730\u7684\u57df\u540d\uff08<code>DNS</code>)\u670d\u52a1\u5668\u4e2d\u8bbe\u6709\u5b8c\u6574\u57df\u540d\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u8ba9\u6211\u4eec\u5c06\u5176\u6dfb\u52a0\u5230\u672c\u5730<code>host</code>\u6570\u636e\u5e93\u4e2d\uff0c\u5c31\u50cf\u6211\u4eec\u4e3a<code>Chef</code>\u670d\u52a1\u5668\u505a\u8fc7\u7684\u4e00\u6837\u3002 </p> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c06\u8282\u70b9\u7684\u5b8c\u6574\u57df\u540d\u6dfb\u52a0\u5230\u672c\u5730host\u6570\u636e\u5e93\u6587\u4ef6\u4e2d\u3002\u4f8b\u5b50\u4e2d\u6211\u4eec\u4f7f\u7528\u7684IP\u5730\u5740\u662f<code>192.168.33.35</code>\uff0c\u5982\u679c\u4f60\u4e3a\u4f60\u7684\u8282\u70b9\u6307\u5b9a\u4e86\u4e0d\u540c\u7684<code>IP</code>\u5730\u5740\uff0c\u8bf7\u66ff\u6362\u4f8b\u5b50\u4e2d\u7684<code>IP</code>\u5730\u5740\u3002 </p> <p>Linux/Mac OS X:</p> <pre><code>$ sudo sh -c \"echo '192.168.33.35 node-centos65.vagrantup.com' &gt;&gt; /etc/hosts\"\n</code></pre> <pre><code>$ kitchen login node-centos65\nLast login: Mon Dec  2 10:31:39 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@node-centos65 ~]$ sudo sh -c \"echo \\\n&gt; '192.168.33.34 default-centos65.vagrantup.com' &gt;&gt; /etc/hosts\"\n[vagrant@node-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>option one\uff1a with key</p> <pre><code>$ knife ssl fetch\nWARNING: Certificates from default-centos65.vagrantup.com will be fetched and placed in your trusted_cert\n         directory (/Users/.../chef-repo/.chef/trusted_certs).\n\n         Knife has no means to verify these are the correct certificates. You should\n         verify the authenticity of these certificates after downloading.\nAdding certificate for default-centos65_vagrantup_com in /Users/.../chef-repo/.chef/trusted_certs/default-centos65_vagrantup_com.crt\n\n\n[Jacob@...:~/chef-repo/cookbooks/node]$ knife bootstrap node-centos65.vagrantup.com --sudo --connection-user vagrant --connection-password vagrant \nConnecting to node-centos65.vagrantup.com\nThe authenticity of host 'node-centos65.vagrantup.com (192.168.33.35)' can't be established.\nfingerprint is SHA256:T+OIBihOOfMUp0PdKFROXsVGSQAHKkDCImI5Udx/x2I.\n\nAre you sure you want to continue connecting\n? (Y/N) y\nConnecting to node-centos65.vagrantup.com\nPerforming legacy client registration with the validation key at /Users/.../chef-repo/.chef/ja-validator.pem...\n                                                                                                            Delete your validation key in order to use your user credentials for client registration instead.\nBootstrapping node-centos65.vagrantup.com\n [node-centos65.vagrantup.com] -----&gt; Existing Chef Infra Client installation detected\n [node-centos65.vagrantup.com] Starting the first Chef Infra Client Client run...\n [node-centos65.vagrantup.com] Starting Chef Infra Client, version 15.5.17\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] resolving cookbooks for run list: []\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] Synchronizing Cookbooks:\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] Installing Cookbook Gems:\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] Compiling Cookbooks...\n [node-centos65.vagrantup.com] \n[2019-12-02T11:28:53+00:00] WARN: Node node-centos65.vagrantup.com has an empty run list.\n [node-centos65.vagrantup.com] Converging 0 resources\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] Running handlers:\n [node-centos65.vagrantup.com] \n [node-centos65.vagrantup.com] Running handlers complete\n\n [node-centos65.vagrantup.com] Chef Infra Client finished, 0/0 resources updated in 03 seconds\n [node-centos65.vagrantup.com]\n</code></pre>"},{"location":"chap1/chef_tutorial8/#option-two-without-key","title":"option two\uff1a without key","text":"<pre><code>$ knife bootstrap node-centos65.vagrantup.com --sudo --connection-user vagrant --connection-password vagrant --node-ssl-verify-mode none --no-host-key-verify\n</code></pre> <ul> <li><code>--[no-]host-key-verify</code> Use <code>--no-host-key-verify</code> to disable host key verification. Default setting: <code>--host-key-verify</code>.</li> <li><code>--node-ssl-verify-mode MODE</code></li> </ul> <p>\u4f60\u53f8\u4ee5\u4ece\u8f93\u51fa\u4e2d\u770b\u5230\u5b83\u6210\u529f\u5b89\u88c5\u4e86<code>Chef</code>\u5ba2\u6237\u7aef\uff0c\u5e76\u4e14\u6267\u884c\u4e86\u4e00\u6b21Chef\u8fd0\u884c\uff0e </p> <p>\u8981\u9a8c\u8bc1\u65b0\u7684\u8282\u70b9\u5df2\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u6ce8\u518c\u767b\u5f55\u5230<code>Chef</code>\u670d\u52a1\u5668\u7684\u7f51\u9875\u754c\u9762\u5e76\u5355\u51fb<code>Node</code>\u6807\u7b7e,\u73b0\u5728\u5e94\u8be5\u770b\u5230<code>Chef</code>\u670d\u52a1\u5668\u6709\u4e00\u4e2a\u6ce8\u518c\u7684\u8282\u70b9</p> <pre><code>$ knife ssl fetch\nWARNING: Certificates from default-centos65.vagrantup.com will be fetched and placed in your trusted_cert\n         directory (/Users/.../chef-repo/.chef/trusted_certs).\n\n         Knife has no means to verify these are the correct certificates. You should\n         verify the authenticity of these certificates after downloading.\nAdding certificate for default-centos65_vagrantup_com in /Users/.../chef-repo/.chef/trusted_certs/default-centos65_vagrantup_com.crt\n</code></pre> <p></p> <p></p>"},{"location":"chap1/chef_tutorial8/#vagrant-haltvagrantfile","title":"\u53ef\u4ee5\u7528<code>vagrant halt</code>\uff08Vagrantfile\u8def\u5f84\u5185\uff09\u53bb\u505c\u6389\u8fd9\u4e9b\u865a\u62df\u673a","text":""},{"location":"chap1/chef_tutorial8/#14chef-solochef","title":"14\u3001\u7528Chef Solo\u914d\u7f6eChef\u670d\u52a1\u5668","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528<code>Chef Solo</code>\uff08\u800c\u65e0\u9700<code>Test Kitchen</code>\uff09\u6765\u81ea\u52a8\u5316\u90e8\u7f72Chef\u670d\u52a1\u5668\u3002</p> <p>\u5728\u672a\u6765\uff0c\u5927\u591a\u6570<code>Chef Solo</code>\u7684\u529f\u80fd\u4f1a\u88ab\u8fc1\u79fb\u5230<code>Chef Local</code>\u6216<code>Chef Zero</code>,\u7136\u800c<code>Chef Solo</code>\u4ecd\u7136\u5bf9\u81ea\u52a8\u5316\u914d\u7f6e\u548c\u90e8\u7f72<code>Chef</code>\u670d\u52a1\u5668\u672c\u8eab\u975e\u5e38\u6709\u7528\uff0c\u56e0\u4e3a<code>Chef Local</code>\u6216<code>Chef Zero</code>\u4f1a\u4ee4\u4e00\u4e9b\u914d\u7f6e\u811a\u672c\u65e0\u6cd5\u8fa8\u8bc6\u53d1\u9001\u8bf7\u6c42\u9053\u54ea\u4e2a<code>Chef</code>\u670d\u52a1\u5668 (<code>Chef Local/Zero</code>\u8fd8\u662f\u6b63\u5728\u914d\u7f6e\u7684<code>Chef</code>\u670d\u52a1\u5668\uff09\uff0c\u56e0\u4e3a<code>Chef Zero</code>\u81ea\u5df1\u4e5f\u4f1a\u542f\u52a8\u4e00\u4e2a\u9a7b\u5185\u5b58\u7684Chef\u670d\u52a1\u5668\u3002 </p> <p>\u4ee5\u4e0b\u662f\u901a\u8fc7<code>Chef Solo</code>\u6765\u914d\u7f6e<code>Chef</code>\u670d\u52a1\u5668\u7684\u6b65\u9aa4\u6982\u89c8\u3002 </p> <ol> <li>\u5b89\u88c5<code>Chef</code>\u5ba2\u6237\u7aef\uff08\u5305\u542b<code>chef-solo</code>)\u3002 </li> <li>\u521b\u5efa<code>/var/chef/cache</code>\u548c<code>var/chef/cookbooks</code>\u76ee\u5f55\u3002</li> <li>\u524d\u8005\u662f<code>chef-solo</code>\u5b58\u50a8\u72b6\u6001\u4fe1\u606f\u7684\u9ed8\u8ba4\u8def\u5f84\uff0c\u540e\u8005\u662f\u5176\u5b58\u50a8\u83dc\u8c31\u7684\u9ed8\u8ba4\u8def\u5f84\u3002 </li> <li>\u590d\u5236\u6240\u9700\u83dc\u8c31\u5230\u8be5\u673a\u5668\u7684\u4ee5\u4e0a\u83dc\u8c31\u8def\u5f84\u3002 </li> <li>\u8fd0\u884c<code>chef-solo</code></li> </ol> <pre><code>$ chef-solo -h\nUsage: /opt/chefdk/bin/chef-solo (options)\n        --chef-license ACCEPTANCE    Accept the license for this product and any contained products ('accept', 'accept-no-persist', or 'accept-silent')\n    -S, --server CHEFSERVERURL       The Chef Infra Server URL.\n        --chef-zero-host HOST        Host to start Chef Infra Zero on.\n        --chef-zero-port PORT        Port (or port range) to start Chef Infra Zero on. Port ranges like 1000,1010 or 8889-9999 will try all given ports until one works.\n    -f, --[no-]fork                  Fork Chef Infra Client process.\n    -k, --client_key KEY_FILE        Set the client key file location.\n        --[no-]color                 Use colored output, defaults to enabled.\n    -c, --config CONFIG              The configuration file to use.\n        --config-option OPTION=VALUE Override a single configuration option.\n    -d, --daemonize                  Daemonize the process.\n        --delete-entire-chef-repo    DANGEROUS: does what it says, only useful with --recipe-url.\n        --disable-config             Refuse to load a config file and use defaults. This is for development and not a stable API.\n    -R, --enable-reporting           (chef-client only) reporting data \n...\n</code></pre> <pre><code># create required directories\n$ sudo mkdir -p /var/chef/cache /var/chef/cookbooks\n# copy your cookbook code to create a Chef Server - Chef Software\n# provides a cookbook for open source Chef Server\n$ sudo mkdir /var/chef/cookbooks/chef-server\n\n$ wget -qO- https://github.com/opscode-cookbooks/chef-server/archive/master.tar.gz | sudo tar xvzC /var/chef/cookbooks/chef-server --strip-components=1\nx .delivery/\nx .delivery/project.toml\nx .github/\nx .github/CODEOWNERS\nx .github/ISSUE_TEMPLATE.md\nx .github/PULL_REQUEST_TEMPLATE.md\nx .gitignore\nx .travis.yml\nx Berksfile\nx CHANGELOG.md\nx CONTRIBUTING.md\nx Gemfile\nx LICENSE\nx README.md\nx TESTING.md\nx attributes/\nx attributes/default.rb\nx chefignore\nx kitchen.dokken.yml\nx kitchen.yml\nx libraries/\nx libraries/helpers.rb\nx metadata.rb\nx recipes/\nx recipes/addons.rb\nx recipes/default.rb\nx spec/\nx spec/addons_spec.rb\nx spec/default_spec.rb\nx spec/spec_helper.rb\nx test/\nx test/fixtures/\nx test/fixtures/cookbooks/\nx test/fixtures/cookbooks/test/\nx test/fixtures/cookbooks/test/metadata.rb\nx test/fixtures/cookbooks/test/recipes/\nx test/fixtures/cookbooks/test/recipes/add-ons-no-fqdn.rb\nx test/fixtures/cookbooks/test/recipes/default.rb\nx test/fixtures/cookbooks/test/recipes/no-fqdn.rb\nx test/fixtures/cookbooks/test/recipes/post-install.rb\nx test/integration/\nx test/integration/add-ons-no-fqdn/\nx test/integration/add-ons-no-fqdn/default_spec.rb\nx test/integration/default/\nx test/integration/default/default_spec.rb\nx test/integration/no-fqdn/\nx test/integration/no-fqdn/default_spec.rb\n\n# Run chef-solo to bootstrap Chef Server\n$ cd /var/chef/cookbooks/\n$ $ tree chef-server/\nchef-server/\n\u251c\u2500\u2500 Berksfile\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 CONTRIBUTING.md\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 TESTING.md\n\u251c\u2500\u2500 attributes\n\u2502   \u2514\u2500\u2500 default.rb\n\u251c\u2500\u2500 chefignore\n\u251c\u2500\u2500 kitchen.dokken.yml\n\u251c\u2500\u2500 kitchen.yml\n\u251c\u2500\u2500 libraries\n\u2502   \u2514\u2500\u2500 helpers.rb\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 recipes\n\u2502   \u251c\u2500\u2500 addons.rb\n\u2502   \u2514\u2500\u2500 default.rb\n\u251c\u2500\u2500 spec\n\u2502   \u251c\u2500\u2500 addons_spec.rb\n\u2502   \u251c\u2500\u2500 default_spec.rb\n\u2502   \u2514\u2500\u2500 spec_helper.rb\n\u2514\u2500\u2500 test\n    \u251c\u2500\u2500 fixtures\n    \u2502   \u2514\u2500\u2500 cookbooks\n    \u2502       \u2514\u2500\u2500 test\n    \u2502           \u251c\u2500\u2500 metadata.rb\n    \u2502           \u2514\u2500\u2500 recipes\n    \u2502               \u251c\u2500\u2500 add-ons-no-fqdn.rb\n    \u2502               \u251c\u2500\u2500 default.rb\n    \u2502               \u251c\u2500\u2500 no-fqdn.rb\n    \u2502               \u2514\u2500\u2500 post-install.rb\n    \u2514\u2500\u2500 integration\n        \u251c\u2500\u2500 add-ons-no-fqdn\n        \u2502   \u2514\u2500\u2500 default_spec.rb\n        \u251c\u2500\u2500 default\n        \u2502   \u2514\u2500\u2500 default_spec.rb\n        \u2514\u2500\u2500 no-fqdn\n            \u2514\u2500\u2500 default_spec.rb\n\n13 directories, 26 files\n\n\n# Run chef-solo to bootstrap Chef Server\n$ sudo chef-solo -o 'recipe[chef-server::default]'\n</code></pre> <p>\u51e0\u4e4e\u6240\u6709\u7684Chef\u8d44\u6e90\u90fd\u4fdd\u8bc1\u5e42\u7b49\u6027\uff0c\u552f\u4e00\u7684\u4f8b\u5916\u662f<code>execute</code>\u8d44\u6e90\u3002\u6211\u4eec\u5c55\u793a\u4e86\u5982\u4f55\u901a\u6cdb\u8fde\u7eed\u6267\u884c\u4e24\u6b21<code>Chef</code>\u6765\u6d4b\u8bd5<code>Chef</code>\u4ee3\u7801\u7684\u5e42\u7b49\u6027\uff0c\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u65f6\uff0c\u5e42\u7b49\u7684Chef\u4ee3\u7801\u662f\u663e\u793a\u6ca1\u6709\u8d44\u6e90\u66f4\u65b0\u3002</p>"},{"location":"chap1/chef_tutorial8/#15","title":"15\u3001\u672c\u8282\u5c0f\u7ed3","text":"<pre><code>$ chef generate recipe adduser\n$ knife client list\n$ knife ssl fetch\n$ knife bootstrap node-centos65.vagrantup.com --sudo --connection-user vagrant --connection-password vagrant --node-ssl-verify-mode none --no-host-key-verify\n$ chef-solo -h\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate cookbook enterprise-chef\n$ cd enterprise-chef\n</code></pre> <p>Chef Client:</p> <pre><code>$ knife cookbook create enterprise-chef --cookbook-path .\n$ cd enterprise-chef\n$ kitchen init --create-gemfile\n$ bundle install\n</code></pre> <p>Chef Development Kit:</p> <pre><code>$ chef generate attribute default\n</code></pre> <p>Chef Client:</p> <pre><code>$ touch attributes/default.rb\n</code></pre> <pre><code>$ kitchen converge default-centos65\n\n$ kitchen list\n\n$ kitchen login default-centos65\n\n$ chef generate recipe adduser\n\n$ knife client list\n</code></pre>"},{"location":"chap1/chef_tutorial9/","title":"\u7b2c\u4e5d\u8282 \u793e\u533a\u4ee5\u53caChef-Client\u83dc\u8c31","text":"<ul> <li>\u4f7f\u7528\u793e\u533a\u83dc\u8c31 </li> <li><code>Chef-Client</code>\u83dc\u8c31 </li> <li><code>Knife Cookbook Site</code>\u63d2\u4ef6 </li> <li>\u4f7f\u7528<code>Knife Cookbook Site</code>\u641c\u7d22\u793e\u533a\u83dc\u8c31 </li> <li>\u901a\u8fc7<code>Knife Cookbook Site</code>\u7ba1\u7406<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u7684\u793e\u533a\u83dc\u8c31</li> <li><code>Chef-Client</code>\u914d\u65b9\u5355 </li> <li>\u914d\u7f6e<code>Knife</code>\u4f7f\u7528\u751f\u4ea7\u73af\u5883<code>SSL</code>\u8bbe\u7f6e </li> <li>\u914d\u7f6e<code>Chef-client</code>\u4f7f\u7528\u751f\u4ea7\u73af\u5883\u7684<code>SSL</code>\u8bbe\u7f6e </li> </ul>"},{"location":"chap1/chef_tutorial9/#1","title":"1\u3001\u4f7f\u7528\u793e\u533a\u83dc\u8c31","text":"<p><code>Chef</code>\u793e\u533a\u4e2d\u62e5\u6709\u76f8\u5f53\u591a\u514d\u8d39\u7684\u5171\u4eab<code>Chef</code>\u83dc\u8c31\uff0c\u53ef\u4ee5\u7528\u6765\u5b89\u88c5\u548c\u914d\u7f6e\u5f88\u591a\u5e7f\u6cdb\u5e94\u7528\u7684\u670d\u52a1\u548c\u5e94\u7528\u7a0b\u5e8f\u3002\u6bd4\u5982\u8bf4\uff0c\u793e\u533a\u4e2d\u6709\u8bbe\u5b9a<code>Apache</code>\u3001<code>Nginx</code>,<code>\u5fae\u8f6fIIS</code>\u7684\u7f51\u9875\u670d\u52a1\u83dc\u8c31\uff0c<code>MySQL</code> <code>PostgreSQL</code>,<code>\u5fae\u8f6fSQL Server</code>\u53ca<code>Oracle</code>\u7684\u6570\u636e\u5e93\u83dc\u8c31\uff1b\u652f\u6301\u90e8\u7f72<code>Java</code>,<code>Ruby</code>,<code>Python</code>,<code>node.js</code>\u7b49\u5e94\u7528\u90e8\u7f72\u7684\u83dc\u8c31\u7b49\u3002 </p>"},{"location":"chap1/chef_tutorial9/#chef-supermarket","title":"Chef Supermarket","text":"<p><code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u5141\u8bb8\u4f60\u901a\u8fc7\u540d\u5b57\u6216\u63cf\u8ff0\u641c\u7d22\u83dc\u8c31\u3002 </p> <p></p>"},{"location":"chap1/chef_tutorial9/#2chef-client","title":"2\u3001Chef-Client \u83dc\u8c31","text":"<p><code>chef-client</code>\u83dc\u8c31\u662f\u4e00\u4e2a\u5e94\u7528\u5e7f\u6cdb\u7684\u793e\u533a\u83dc\u8c31\u3002\u8bd5\u8bd5\u5728<code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4e2d\u641c\u7d22<code>chef-client</code> https://supermarket.chef.io/cookbooks/chef-client</p> <p></p> <p><code>chef-client</code> \u83dc\u8c31 \u5e7f\u6cdb\u5e94\u7528\u56e0\u4e3a\u5b83\u4f7f\u4ee5\u4e0b\u4e24\u4ef6\u4e8b\u60c5\u53d8\u5f97\u6613\u5982\u53cd\u5802\uff1a </p> <ul> <li>\u5c06<code>chef-client</code>\u914d\u7f6e\u6210\u4e2a\u670d\u52a1\u6216<code>cron</code>\u4efb\u52a1 </li> <li>\u5220\u9664<code>validation.pem</code>\u6587\u4ef6 </li> </ul> <p>\u56e0\u4e3a\u53ef\u4f38\u7f29\u6027\u662f<code>Chef</code>\u670d\u52a1\u5668\u7684\u8bbe\u8ba1\u76ee\u6807\u4e4b\u4e00\uff0c\u6240\u4ee5\u5f88\u591a\u5de5\u4f5c\u90fd\u7531\u5ba2\u6237\u7aef\u8282\u70b9\u5b8c\u6210\uff0c\u5728\u8282\u70b9\u4e0a\u8ba1\u5212\u548c\u8fd0\u884c<code>chef-client</code>\u7a0b\u5e8f\u3002<code>Chef</code>\u670d\u52a1\u5668\u672c\u8eab\u662f\u4e00\u4e2a\u50bb\u74dc\u5f0f\u7684\u5b58\u50a8\u670d\u52a1 </p> <p>\u6bd4\u5982\u5728\u524d\u9762\u505a\u8fc7\u7684\u3002 \u7528<code>knife</code>\u51c6\u5907\u4e00\u4e2a\u8282\u70b9\u5e76\u5728\u5176\u4e0a\u5b89\u88c5<code>chef-client</code>\u65f6\uff0c\u8fd9\u4e2a\u51c6\u5907\u8fc7\u7a0b\u4e0d\u4f1a\u914d\u7f6e<code>chef-client</code>\u5728\u8282\u70b9\u4e0a\u5b9a\u671f\u8fd0\u884c\u3002</p> <p>\u4f46\u4f60\u7edd\u5bf9\u5e0c\u671b<code>chef-client</code>\u5728\u8282\u70b9\u4e0a\u5b9a\u671f: \u8fd0\u884c\uff08\u6bd4\u5982\u6bcf15\u621630\u5206\u949f\uff09\u4ee5\u5f97\u5230\u76f8\u5e94\u7684\u6570\u636e\u6216\u83dc\u8c31\u7684\u66f4\u65b0\u3002<code>chef-client</code>\u83dc\u8c31\u4f7f\u914d\u7f6e<code>chef-client</code>\u5b9a\u671f\u4f5c\u4e3a\u670d\u52a1\u6216<code>cron</code>\u4efb\u52a1\u8fd0\u884c\u53d8\u5f97\u7b80\u5355</p> <p>\u540c\u65f6\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7b2c\u4e00\u6b21<code>Chef</code>\u8fd0\u884c\u540e\u5220\u9664<code>validation.pem</code>\u6587\u4ef6\u4e5f\u5f88\u91cd\u8981\u3002\u5728\u4f01\u4e1a<code>Chef</code> \u4e2d\uff0c\u8fd9\u4e2a\u6587\u4ef6\u9ed8\u8ba4\u4e3a<code>\uff1corganization-validator&gt;.pem</code>\u3002</p> <p>\u5728\u5f00\u6e90<code>Chef</code>\u670d\u52a1\u5668\u4e2d\uff0c\u8fd9\u4e2a\u6587\u4ef6\u8ba4\u4e3a<code>validation.pem</code>\u3002</p> <p>\u8981\u89e3\u91ca\u5220\u9664<code>validation.pem</code>\u6587\u4ef6\u4e3a\u4ec0\u4e48\u5f88\u91cd\u8981\uff0c\u6211\u4eec\u9700\u8981\u5148\u5feb\u901f\u4ecb\u4e00\u4e0bChef\u670d\u52a1\u5668\u5982\u4f55\u9a8c\u8bc1\u8282\u70b9\u7684\u8bf7\u6c42\u3002 </p> <ul> <li><code>Chef</code>\u670d\u52a1\u5668\u8981\u6c42<code>chef-client</code>\u53d1\u9001\u7684\u6bcf\u4e00\u4e2a\u8bf7\u6c42\u90fd\u9700\u8981\u901a\u8fc7\u4e00\u5bf9\u5ba2\u6237\u7aef\u94a5\u5319\u6765\u9a8c\u8bc1\u3002\u6bcf\u4e2a\u8282\u70b9\u62e5\u6709\u5b83\u81ea\u5df1\u7684\u94a5\u5319\u5bf9\u3002\u4f60\u5df2\u7ecf\u89c1\u8fc7\u7c7b\u4f3c\u7684\u94a5\u5319\u5bf9\uff0c\u56e0\u4e3a\u7528\u6237\u8d26\u6237\u4e5f\u9700\u8981\u6709\u5b83\u81ea\u5df1\u7684\u94a5\u5319\u5bf9\u3002</li> <li>\u4f60\u5728\u6ce8\u518c\u7528\u6237\u65f6\u4e0b\u8f7d<code>&lt;username.pem&gt;</code>\u6587\u4ef6\uff0c\u5e76\u914d\u7f6e<code>knife</code>\u6765\u4f7f\u7528\u8fd9\u4e2a\u94a5\u5319\u6765\u9a8c\u8bc1\u653e\u7ed9<code>Chef</code>\u670d\u52a1\u5668\u7684\u8bf7\u6c42\u3002</li> <li>\u4f60\u4e0b\u8f7d\u7684<code>&lt;username.pem&gt;</code>\u6587\u4ef6\u5c31\u662f\u7528\u6237\u7684\u94a5\u5319\u5bf9\u4e2d\u7684\u79c1\u94a5\uff0c\u800c\u516c\u94a5\u5b58\u50a8\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e0a\uff0c\u7528\u6765\u9a8c\u8bc1\u4f60\u662f\u6709\u6548\u7684<code>Chef</code>\u670d\u52a1\u5668\u7528\u6237\u3002 </li> <li>\u540c\u6837\uff0c\u8fd0\u884c<code>chef-client</code>\u7684\u6bcf\u4e2a\u8282\u70b9\u4e00\u6837\u62e5\u6709\u4e00\u4e2a\u79c1\u94a5\uff08<code>.pem</code>\u9644\u6587\u4ef6\uff09\u3002\u4f5c\u4e3a\u4f8b\u5b50\uff0c\u6211\u4eec\u6682\u4e14\u5c06<code>client.pem</code>\u3002\u56fe\u6982\u89c8\u670d\u52a1\u5668\u5982\u4f55\u901a\u8fc7\u8fd9\u4e2a\u79c1\u94a5\u9a8c\u8bc1\u6765\u81ea\u8282\u70b9\u7684\u8bf7\u6c42\u3002</li> <li>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u8282\u70b9<code>A</code>\u6709\u4e00\u4e2a\u79c1\u94a5\uff08\u4f4d\u4e8e\u8282\u70b9\u4e0a\u7684<code>client.pem</code>\u6587\u4ef6\uff09\u3002\u5f53<code>client.pem</code>\u521b\u5efa\u65f6\uff0c <code>Chef</code>\u670d\u52a1\u5668\u4e0a\u540c\u65f6\u751f\u6210\u5e76\u5b58\u50a8\u4e0e\u5176\u5bf9\u5e94\u7684\u516c\u94a5\u3002</li> <li>\u8282\u70b9<code>A</code>\u4f7f\u7528\u5b83\u7684\u79c1\u94a5\u4e3a\u6240\u6709\u53d1\u9001\u81f3<code>Chef</code>\u670d\u52a1\u5668\u7684\u8bf7\u6c42\u7b7e\u540d\u3002\u5f53<code>Chef</code>\u670d\u52a1\u5668\u6536\u5230\u8bf7\u6c42\uff0c\u5b83\u7528\u8282\u70b9<code>A</code>\u7684\u516c\u94a5\u9a8c\u8bc1\u8bf7\u6c42\u7684\u7b7e\u540d\u6765\u81ea\u8282\u70b9<code>A</code>, \u4ee5\u4fdd\u8bc1\u8fd9\u662f\u4e00\u4e2a\u6765\u81ea\u8282\u70b9<code>A</code>\u7684\u5408\u6cd5\u8bf7\u6c42\u3002 </li> <li>\u90a3\u4e48\u73b0\u5728\u51fa\u73b0\u4e00\u4e2a\u95ee\u9898\uff0c\u5f53\u4f60\u7b2c\u4e00\u6b21\u8fd0\u884c<code>chef-client</code>\u4e0a\uff0c\u8282\u70b9\u4e0a\u8fd8\u5e76\u6ca1\u6709\u79c1\u94a5\uff08\u4f8b\u5b50\u4e2d\u7684<code>clicnt.pem</code>\u6587\u4ef6\uff09\uff0c\u540c\u65f6\u76f8\u5e94\u7684\u516c\u94a5\u4e5f\u5c1a\u672a\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u751f\u6210\u3002</li> <li>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728\u53d1\u9001\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u65f6\u8282\u70b9\u4f7f\u7528\u4e00\u4e2a\u5728\u516c\u53f8\u8303\u56f4\u5185\u6709\u6548\u7684\u94a5\u5319\uff0c\u5e76\u8bf7\u6c42\u670d\u52a1\u5668\u5c06\u6b64\u8282\u70b9\u6ce8\u518c\u4e3a\u4e00\u4e2a\u5ba2\u6237. \u800c\u8fd9\u4e2a\u94a5\u5319\u5219\u662f<code>validation.pem</code>\u6587\u4ef6\u3002<code>validation.pem</code>\u6587\u4ef6\u662f\u5728\u6574\u4e2a\u7ec4\u7ec7\u5185\u6709\u6548\u7684\u79c1\u94a5\u7528\u6765\u4e3a\u8282\u70b9\u7b2c\u4e00\u6b21<code>chef-client</code>\u8fd0\u884c\u5411<code>Chef</code>\u670d\u52a1\u5668\u53d1\u9001\u7684\u6e05\u6c42\u7b7e\u540d\u3002 </li> </ul> <p></p> <ul> <li><code>Chef</code>\u53ca\u52a1\u5668\u9a8c\u8bc1<code>validation.pem</code>\u7684\u7b7e\u540d\uff08\u5c31\u50cf\u5b83\u9a8c\u8bc1<code>client.pem</code>\u7684\u7b7e\u540d\u4e00\u6837\uff09\u3002\u5728<code>knife</code>\u521d\u6b21\u51c6\u5907\uff08<code>bootstrap</code>\uff09\u8282\u70b9\u65f6\uff0c<code>validation.pem</code>\u521b\u5efa\u5728\u8282\u70b9\u4e0a\u7684<code>/etc/chef/validation.pem</code>\u4f4d\u7f6e\uff0e</li> <li>\u867d\u7136<code>/etc/chef/validation.pem</code>\u7684\u6743\u9650\u5c40\u9650\u4e8e<code>root</code>,\u6700\u597d\u57fa\u4e8e\u5b89\u5168\u539f\u56e0\u8003\u8651\uff0c\u7b49\u8282\u70b9\u62e5\u6709\u81ea\u5df1\u7684\u5ba2\u6237\u7aef\u94a5\u5319\u540e\u5c31\u5c06\u5176\u5220\u9664\u3002\u4efb\u4f55\u80fd\u8bbf\u95ee\u5230<code>Chef</code>\u670d\u52a1\u5668\u5e76\u5f97\u5230<code>/etc/chef/validation.pem</code>\u6587\u4ef6\u7684\u4eba\u90fd\u53ef\u4ee5\u5728<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u6ce8\u518c\u65b0\u7684\u8282\u70b9\u3002</li> <li>\u4e00\u65e6\u8282\u70b9\u62e5\u6709\u81ea\u5df1\u7684\u5ba2\u6237\u7aef\u94a5\u5319\uff0c\u4e0d\u518d\u9700\u8981<code>/etc/chef/validation.pem</code>\u53ea\u6709\u5728\u8282\u70b9<code>Chef</code>\u670d\u52a1\u5668\u53d1\u9001\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u7684\u65f6\u5019\u9700\u8981<code>/etc/chef/validation.pem</code>\u5b83\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u4f1a\u521b\u5efa\u4ee3\u8868\u8fd9\u4e2a\u8282\u70b9\u7684\u5ba2\u6237\u7aef\u94a5\u5319\u5bf9\u5e76\u5728\u672a\u6765\u4f7f\u7528\u5b83\u7684\u79c1\u94a5\u90e8\u5206\u4e0e<code>Chef</code>\u670d\u52a1\u5668\u8fdb\u884c\u4ea4\u6d41\u56e0\u6b64\u5728\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u6210\u529f\u8fc7\u540e\u5c31\u5e94\u8be5\u5c06<code>/etc/chef/validation.pem</code>\u4ece\u8282\u70b9\u4e0a\u5220\u9664 </li> </ul> <pre><code>$ kitchen login\nLast login: Mon Dec  2 11:13:07 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@default-centos65 ~]$ ls /etc/chef\naccepted_licenses  admin.pem  ja-validator.pem\n</code></pre>"},{"location":"chap1/chef_tutorial9/#3knife-cookbook-site","title":"3\u3001Knife Cookbook Site \u63d2\u4ef6","text":"<p>\u867d\u7136<code>Chef</code>\u7ea7\u5e02\u573a\u7684\u4e0b\u8f7d\u83dc\u8c31\u94fe\u63a5\u5f88\u5b9e\u7528, \u4f46\u4ecd\u7136\u9700\u8981\u5728\u4e0b\u8f7d\u540e\u624b\u52a8\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u624d\u80fd\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u3002\u867d\u7136\u8d85\u7ea7\u5e02\u573a\u7f51\u7ad9\u5bf9\u53d1\u73b0\u65b0\u7684\u83dc\u8c31\u5f88\u6709\u7528\u4f46\u6709\u65f6\u5019\u4f60\u4f1a\u53d1\u73b0\u81ea\u5df1\u60f3\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u6765\u505a\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u793e\u533a\u83dc\u8c31\u7684\u7ba1\u7406\uff0c\u56e0\u4e3a\u8fd9\u6837\u66f4\u6709\u6548\u7387\u3002\u6240\u6709\u8fd1\u671f\u7248\u672c\u7684<code>Chef</code>\u5ba2\u6237\u7aef\u4ee5\u53ca<code>Chef</code>\u7814\u53d1\u5305\u90fd\u5305\u542b<code>knife</code>\u5de5\u5177\u7684<code>cookbook site</code>\u63d2\u4ef6\uff0c\u7528\u6765\u548c<code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4ea4\u4e92 </p> <p>\u5982\u679c\u4f60\u60f3\u5c1d\u8bd5\u8fd0\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u786e\u4fdd\u4f60\u7684\u5de5\u4f5c\u76ee\u5f55\u662f<code>chef-repo</code>\u76ee\u5f55\uff0c\u5047\u8bbe<code>chef-repo</code>\u76ee\u5f55\u5728\u7528\u6237\u6839\u76ee\u5f55\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u4eba<code>chef-repo</code>. \u5982\u679c\u63d0\u4e0d\u5728\u6839\u76ee\u5f55(<code>$HOME</code>)\u4e0b\uff0c\u8bf7\u81ea\u884c\u6539\u53d8\u4ee5\u4e0b\u4f8b\u5b50\u4e2d\u7684\u8def\u5f84\u8fdb\u4eba<code>chef-repo</code> \u76ee\u5f55</p> <p>Linux/Mac OS X:</p> <pre><code>$ cd $HOME/chef-repo\n</code></pre>"},{"location":"chap1/chef_tutorial9/#4knife-cookbook-site","title":"4\u3001\u4f7f\u7528<code>Knife Cookbook Site</code>\u641c\u7d22\u793e\u533a\u83dc\u8c31","text":"<p>\u4f7f\u7528<code>knife cookbook site search</code>\u547d\u4ee4\u6765\u641c\u7d22<code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4e2d\u7684\u83dc\u8c31\u3002\u9700\u8981\u4f20\u9012\u641c\u7d22\u67e5\u8be2\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a\u53c2\u6570\u3002<code>knife cookbook site</code>\u5c06\u4f1a\u5728<code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4e2d\u9488\u5bf9\u83dc\u8c31\u7684\u4ee5\u4e0b\u5143\u6570\u636e\u8fdb\u884c\u641c\u7d22\uff1a </p> <ul> <li>name</li> <li>URL</li> <li>description</li> <li>maintainer</li> </ul> <p><code>knife cookbook Site</code>\u63d2\u4ef6\u5c06\u4f1a\u5bf9\u4f60\u6240\u63d0\u4f9b\u7684\u641c\u7d22\u67e5\u8be2\u6267\u884c\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u5339\u914d\u3002\u52a8\u624b\u8bd5\u8bd5\u641c\u7d22<code>chef-client</code></p> <pre><code>$ knife cookbook site search chef-client\nWARNING: No knife configuration file found. See https://docs.chef.io/config_rb_knife.html for details.\nWARN: knife cookbook site search has been deprecated in favor of knife supermarket search. In Chef Infra Client 16 (April 2020) this will result in an error!\n...\nchef:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef\n  cookbook_description: Installs and configures Chef for chef-client and chef-server\n  cookbook_maintainer:  chef\n  cookbook_name:        chef\nchef-client:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef-client\n  cookbook_description: Manages client.rb configuration and chef-client service\n  cookbook_maintainer:  chef\n  cookbook_name:        chef-client\nchef-client-cron:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef-client-cron\n  cookbook_description: Manages aspects of only chef-client\n  cookbook_maintainer:  bryanwb\n  cookbook_name:        chef-client-cron\nchef-client-hardening:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef-client-hardening\n  cookbook_description: Set correct owner/permissions for chef-client sensitive files\n  cookbook_maintainer:  sliim\n  cookbook_name:        chef-client-hardening\nchef-client-runit:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef-client-runit\n  cookbook_description: Sets up chef-client as a runit-supervised service\n  cookbook_maintainer:  jtimberman\n  cookbook_name:        chef-client-runit\nchef-client_syslog:\n  cookbook:             https://supermarket.chef.io/api/v1/cookbooks/chef-client_syslog\n  cookbook_description: chef-client log to syslog\n  cookbook_maintainer:  sawanoboly\n  cookbook_name:        chef-client_syslog\n ...\n</code></pre> <pre><code>$ knife cookbook site show chef-client\nWARNING: No knife configuration file found. See https://docs.chef.io/config_rb_knife.html for details.\nWARN: knife cookbook site show has been deprecated in favor of knife supermarket show. In Chef Infra Client 16 (April 2020) this will result i\nn an error!\naverage_rating:  \ncategory:        Other\ncreated_at:      2010-12-16T23:00:45.000Z\ndeprecated:      false\ndescription:     Manages client.rb configuration and chef-client service\nexternal_url:    https://github.com/chef-cookbooks/chef-client\nissues_url:      https://github.com/chef-cookbooks/chef-client/issues\nlatest_version:  https://supermarket.chef.io/api/v1/cookbooks/chef-client/versions/11.4.0\nmaintainer:      chef\nmetrics:\n  collaborators: 1\n  downloads:\n    total:    61397900\n    versions:\n      0.99.0: 1201561\n...\nname:            chef-client\nsource_url:      https://github.com/chef-cookbooks/chef-client\nup_for_adoption: \nupdated_at:      2019-11-14T00:16:26.975Z\nversions:\n  https://supermarket.chef.io/api/v1/cookbooks/chef-client/versions/11.4.0\n  https://supermarket.chef.io/api/v1/cookbooks/chef-client/versions/11.3.6\n  https://supermarket.chef.io/api/v1/cookbooks/chef-client/versions/11.3.5\n  https://supermarket.chef.io/api/v1/cookbooks/chef-client/versions/11.3.4\n...\n</code></pre>"},{"location":"chap1/chef_tutorial9/#5knife-cookbook-sitechef","title":"5\u3001\u901a\u8fc7<code>Knife Cookbook Site</code>\u7ba1\u7406<code>Chef</code>\u670d\u52a1\u5668\u4e2d\u7684\u793e\u533a\u83dc\u8c31","text":"<p>\u867d\u7136\u641c\u7d22\u663e\u793a\u8be6\u7ec6\u4fe1\u606f\u7b49\u529f\u80fd\u5f88\u5b9e\u7528\u4f46\u662f<code>knife cookbook site</code>\u63d2\u4ef6\u6700\u5e38\u7528\u7684\u529f\u80fd\u662f\u4ece <code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4e0b\u8f7d\u83dc\u8c31\u4ee5\u53ca\u4e0a\u4f20\u4e0b\u6211\u7684\u83dc\u8c31\u5230<code>Chef</code>\u670d\u52a1\u5668\u3002\u8981\u4ece<code>Chef</code>\u8d85\u7ea7\u5e02\u573a\u4e0b\u8f7d\u5e76\u4e0a \u4f20\u5230\u672c\u5730\u7684<code>Chef</code>\u670d\u52a1\u5668\u4f60\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4 </p> <ol> <li>\u7528<code>knife cookbook site download</code>\u547d\u4ee4\u4e0b\u8f7d\u83dc\u8c31 </li> <li>\u7528<code>tar</code>\u547d\u4ee4\u5c55\u5f00\u538b\u7f29\u5305</li> <li>\u7528<code>knife cookboob upload</code>\u547d\u4ee4\u4e0a\u4f20\u83b1\u8c31\u5230<code>Chef</code>\u670d\u52a1\u5668 4</li> <li>\u5bf9\u4efb\u4f55\u83dc\u8c31\u6240\u4f9d\u8d56\u7684\u5176\u4ed6\u83dc\u8c31\u91cd\u590d\u6b65\u9aa41-3 </li> </ol> <p>\u8ba9\u6211\u4eec\u4ee5<code>chef-client</code>\u83dc\u8c31\u4e3a\u4f8b\u5b8c\u6210\u8fd9\u4e2a\u8fc7\u7a0b</p> <pre><code>$ mkdir -r chef-repo/cookbooks\n$ knife cookbook site download chef-client 11.4.0\n$ tar xvf chef-client*.tar.gz -C chef-repo/cookbooks\n</code></pre> <pre><code>$ knife cookbook upload chef-client \u2014cookbook-path cookbooks\nWARNING: No knife configuration file found. See https://docs.chef.io/config_rb_knife.html for details.\nWARN: Failed to read the private key /etc/chef/client.pem: #&lt;Errno::ENOENT: No such file or directory @ rb_sysopen - /etc/chef/client.pem&gt;\nERROR: Your private key could not be loaded from /etc/chef/client.pem\nCheck your configuration file and ensure that your private key is readabl\n\u00b7\u00b7\u00b7\n</code></pre>"},{"location":"chap1/chef_tutorial9/#5-1-solution-copy-chef-to-the-directory","title":"5-1 solution: Copy <code>.chef</code> to the directory","text":"<pre><code>$ cd chef-repo\n$ ls -la\ntotal 0\ndrwxr-xr-x  4 ...  staff  128 Dec  3 14:09 .\ndrwxr-xr-x  4 ...  staff  128 Dec  3 13:48 ..\ndrwxr-xr-x  6 ...  staff  192 Dec  3 14:09 .chef\ndrwxr-xr-x  3 ...  staff   96 Dec  3 13:49 cookbooks\n</code></pre> <pre><code>$ knife cookbook upload chef-client \nUploading chef-client  [11.4.0]\nERROR: Cookbook chef-client depends on cookbooks which are not currently\nERROR: being uploaded and cannot be found on the server.\nERROR: The missing cookbook(s) are: 'cron' version '&gt;= 4.2.0', 'logrotate' version '&gt;= 1.9.0'\n</code></pre> <p>\u5982\u679c\u8fd8\u8bb0\u5f97\u6211\u4eec\u5728\u524d\u9762\u4ecb\u7ecd\u7684<code>include_recipe</code>\u8bed\u53e5\uff0c\u5c31\u77e5\u9053\u83dc\u8c31\u53ef\u4ee5\u5f15\u7528\u5176\u4ed6\u83dc\u8c31\u8fd9\u4e9b\u5f15\u7528\u79f0\u4e3a\u4f9d\u8d56\uff0c\u5e76\u5728\u83dc\u8c31\u7684<code>metadata.rb</code>\u6587\u4ef6\u4e2d\u4ee5<code>depends</code>\u8bed\u53e5\u6ce8\u660e\u3002\u5982\u679c\u770b<code>chef</code></p> <p>https://github.com/chef-cookbooks/chef-client/blob/master/metadata.rb</p> <pre><code>name              'chef-client'\nmaintainer        'Chef Software, Inc.'\nmaintainer_email  'cookbooks@chef.io'\nlicense           'Apache-2.0'\ndescription       'Manages client.rb configuration and chef-client service'\nversion           '11.4.0'\n\n%w( aix amazon centos fedora freebsd debian oracle mac_os_x redhat suse opensuseleap ubuntu windows zlinux ).each do |os|\n  supports os\nend\n\ndepends 'cron', '&gt;= 4.2.0'\ndepends 'logrotate', '&gt;= 1.9.0'\n\nsource_url 'https://github.com/chef-cookbooks/chef-client'\nissues_url 'https://github.com/chef-cookbooks/chef-client/issues'\nchef_version '&gt;= 13.0'\n</code></pre> <p>\u5728<code>metadata.rb</code>\u6587\u4ef6\u7684\u5e95\u90e8\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u51e0\u4e2a<code>depends</code>\u8bed\u53e5\uff0c\u6307\u660e<code>chef-client</code>\u83dc\u8c31\u4f9d\u8d56 <code>cron</code>\u548c<code>logrotate</code>\u83dc\u8c31\u8fd9\u7b26\u5408\u9519\u8bef\u6d88\u606f\u4e2d\u7684\u4e24\u4e2a\u83dc\u8c31\uff01</p> <p>\u6211\u4eec\u9700\u8981\u5bf9\u8fd9\u4e9b\u4f9d\u8d56\u7684\u83dc\u8c31\u91cd\u590d <code>knife cookbook site&gt;un-tar&gt;knife cookbook upload</code>\u7684\u8fc7\u7a0b\u3002 </p> <pre><code>$ knife cookbook site show cron\nWARNING: No knife configuration file found. See https://docs.chef.io/config_rb_knife.html for details.\nWARN: knife cookbook site show has been deprecated in favor of knife supermarket show. In Chef Infra Client 16 (April 2020) this will result in an error!\naverage_rating:  \ncategory:        Other\ncreated_at:      2010-08-19T16:03:13.000Z\ndeprecated:      false\ndescription:     Installs cron\nexternal_url:    https://github.com/chef-cookbooks/cron\nissues_url:      https://github.com/chef-cookbooks/cron/issues\nlatest_version:  https://supermarket.chef.io/api/v1/cookbooks/cron/versions/6.2.2\nmaintainer:      chef\nmetrics:\n..\n</code></pre> <pre><code>$ knife cookbook site show logrotate\nWARNING: No knife configuration file found. See https://docs.chef.io/config_rb_knife.html for details.\nWARN: knife cookbook site show has been deprecated in favor of knife supermarket show. In Chef Infra Client 16 (April 2020) this will result in an error!\naverage_rating:  \ncategory:        Other\ncreated_at:      2009-10-28T19:14:55.000Z\ndeprecated:      false\ndescription:     Installs logrotate package and provides a resource for managing logrotate configs\nexternal_url:    https://github.com/chef-cookbooks/logrotate\nissues_url:      https://github.com/chef-cookbooks/logrotate/issues\nlatest_version:  https://supermarket.chef.io/api/v1/cookbooks/logrotate/versions/2.2.2\n</code></pre> <pre><code>$ knife cookbook site download cron 6.2.2\n$ knife cookbook site download logrotate 2.2.2\n</code></pre> <pre><code>\n</code></pre> <p>\u6700\u540e\uff0c \u6ce8\u610f\u7528<code>knife cookbook upload</code>\u547d\u4ee4\u4e0a\u4f20\u6240\u6709\u83dc\u8c31 <code>cron</code>,<code>logrotate</code>\u548c<code>chef-client</code>,\u5728\u4e0a\u4f20<code>chef-client</code>\u4e4b\u524d\uff0c\u5e94\u5148\u4e0a\u4f20\u5b83\u6240\u4f9d\u8d56\u7684\u83dc\u8c31 </p> <pre><code>tar xvf cron*.tar.gz -C chef-repo/cookbooks/\ntar xvf logrotate*.tar.gz -C chef-repo/cookbooks/\n</code></pre> <pre><code>$ cd chef-repo\n$ knife cookbook upload cron\nUploading cron         [6.2.2]\nUploaded 1 cookbook.\n\n$ knife cookbook upload logrotate\nUploading logrotate      [2.2.2]\nUploaded 1 cookbook.\n\n$ knife cookbook upload chef-client\nUploading chef-client    [11.4.0]\nUploaded 1 cookbook.\n</code></pre>"},{"location":"chap1/chef_tutorial9/#6chef-client","title":"6\u3001Chef-Client\u914d\u65b9\u5355","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u628a\u5728\u524d\u9762\u63d0\u5230\u7684\u4e24\u4e2a\u914d\u65b9\u5355\u52a0\u5165\u6211\u4eec\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\uff0c \u8fd0\u884c\u7136\u540e\u8fdb\u884c\u4e00\u6b21<code>chef</code> \u8fd0\u884c</p> <ol> <li><code>chef-client::default</code>\u914d\u65b9\u5355\u914d\u7f6e<code>chef-client</code>\u4f5c\u4e3a\u670d\u52a1\u8fd0\u884c\u3002</li> <li><code>chef-client::delete_validation</code>\u5220\u9664<code>/etc/chef/validation.pem</code>\u6587\u4ef6\u3002 </li> </ol> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>knife node run_list add</code>\u547d\u4ee4\u5c06<code>chef-client::delete validation</code>\u914d\u65b9\u5355\u52a0\u5230\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\u3002\u5728<code>knife</code>\u547d\u4ee4\u4e2d\uff0c\u914d\u65b9\u5355\u4ee5\u4e0b\u683c\u5f0f\u8868\u793a <code>\"recipe[\uff1c\u83dc\u8c31\uff1e::\uff1c\u914d\u65b9\u5355\uff1e]\"</code>, \u4f8b\u5982<code>\"recipe[chef-client::delete_validation\"</code></p> <p>\u8fd0\u884c\u4ee5\u4e0b<code>knife node run_list add</code> \u547d\u4ee4\u6765\u6dfb\u52a0<code>\u201drecipe[chef-client::delete_validation\"</code>\u5230<code>node-centos65.vagrantup.com</code>\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\uff1a </p> <pre><code>$ knife node list\nnode-centos65.vagrantup.com\n</code></pre> <pre><code>$ knife node -h\n\n\n** NODE COMMANDS **\nknife node bulk delete REGEX (options)\nknife node create NODE (options)\nknife node delete [NODE [NODE]] (options)\nknife node edit NODE (options)\nknife node environment set NODE ENVIRONMENT\nknife node from file FILE (options)\nknife node list (options)\nknife node policy set NODE POLICY_GROUP POLICY_NAME (options)\nknife node run_list add [NODE] [ENTRY [ENTRY]] (options)\nknife node run_list remove [NODE] [ENTRY [ENTRY]] (options)\nknife node run_list set NODE ENTRIES (options)\nknife node show NODE (options)\nknife node status [&lt;node&gt; &lt;node&gt; ...]\n</code></pre> <pre><code>$ knife node run_list add node-centos65.vagrantup.com \\\n&gt; \"recipe[chef-client::delete_validation]\"\nnode-centos65.vagrantup.com:\n  run_list: recipe[chef-client::delete_validation]\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u5c06<code>chef-client::default</code>\u914d\u65b9\u5355\u4e5f\u6dfb\u52a0\u5230\u8fd0\u884c\u6e05\u5355\u4e2d\u3002\u6ce8\u610f\uff0c\u5728\u4f7f\u7528\u4e00\u4e2a\u83dc\u8c31\u4e2d\u7684<code>default</code>\u914d\u65b9\u5355\u65f6\uff0c\u53ef\u4ee5\u5c06\u5176\u7701\u7565\u800c\u53ea\u4f7f\u7528\u83dc\u8c31\u540d\u5b57\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ knife node run_list add node-centos65.vagrantup.com \"recipe[chef-client]\"\nnode-centos65.vagrantup.com:\n  run_list:\n    recipe[chef-client::delete_validation]\n    recipe[chef-client]\n</code></pre> <p>\u73b0\u5728<code>chef-client::delete_validation</code>\u548c<code>chef-client::default</code>\u914d\u65b9\u5355\u90fd\u5728\u8282\u70b9\u7684\u8fd0\u884c\u6e05\u5355\u4e2d\uff0c\u5c06\u6309\u4f60\u6307\u5b9a\u7684\u987a\u5e8f\u6267\u884c\u3002 </p> <pre><code>$ knife node run_list add &lt;node&gt; \\\n\"recipe[&lt;cookbook&gt;::&lt;recipe&gt;],recipe[&lt;cookbook&gt;::&lt;recipe&gt;]\"\n</code></pre> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u786e\u4fdd<code>chef-repo/cookbooks/node</code>\u76ee\u5f55\u662f\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c\u4f60\u7684<code>chef-repo</code>\u76ee\u5f55\u4e0d\u5728<code>\uff04HOME</code>\u4e0b\uff0c\u5c06\u4ee5\u4e0b\u8def\u5f84\u4e2d<code>\uff04HOME</code>\u76ee\u5f55\u66ff\u6362\u4e3a<code>chef-repo</code>\u76ee\u5f55\u6240\u5728\u7684\u6b63\u786e\u4f4d\u7f6e\u3002 </p> <p>Linux/Mac OS X:</p> <pre><code>$ cd $HOME/chef-repo/cookbooks/node\n</code></pre> <pre><code>$ kitchen login\nLast login: Mon Dec  2 11:19:08 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@node-centos65 ~]$ sudo chef-client\nStarting Chef Infra Client, version 15.5.17\nresolving cookbooks for run list: [\"chef-client::delete_validation\", \"chef-client\"]\nSynchronizing Cookbooks:\n  - chef-client (11.4.0)\n  - cron (6.2.2)\n  - logrotate (2.2.2)\n...\n   - change mode from '' to '0644'\n  * service[chef-client] action enable\n    - enable service service[chef-client]\n  * service[chef-client] action start\n    - start service service[chef-client]\n  * service[chef-client] action restart\n    - restart service service[chef-client]\n\nRunning handlers:\nRunning handlers complete\nChef Infra Client finished, 10/11 resources updated in 09 seconds\n</code></pre> <pre><code>[vagrant@node-centos65 ~]$ ls /etc/chef\naccepted_licenses  chef_guid  client.pem  client.rb  first-boot.json  trusted_certs\n\n\n[vagrant@node-centos65 ~]$ ps awux | grep chef-client\nroot      4992  0.0 11.2 295228 56336 ?        S    07:10   0:00 /opt/chef/embedded/bin/ruby --disable-gems /usr/bin/chef-client -d -c /etc/chef/client.rb -P /var/run/chef/client.pid -i 1800 -s 300\nvagrant   4997  0.0  0.1 103216   816 pts/0    S+   07:12   0:00 grep chef-client\n</code></pre> <p>\u5728\u8282\u70b9\u4e0a\u9a8c\u8bc1<code>validation.pem</code>\u6587\u4ef6\u5df2\u88ab\u5220\u9664\uff0c\u4ee5\u53ca<code>chef-client</code>\u88ab\u8bbe\u5b9a\u6210\u80cc\u666f(daemon)\u670d\u52a1\uff1a </p>"},{"location":"chap1/chef_tutorial9/#7knifessl","title":"7\u3001\u914d\u7f6eKnife\u4f7f\u7528\u751f\u4ea7\u73af\u5883SSL\u8bbe\u7f6e","text":"<p>\u6211\u4eec\u63d0\u53ca\u8fc7\u5f53\u4f60\u8fd0\u884c<code>chef-client</code>\u65f6\u770b\u5230\u7684SSL\u8b66\u544a\uff08\u56e0\u4e3a\u672a\u8ba4\u8bc1\u7684<code>HTTPS</code> \u8fde\u63a5\uff09\u3002\u5728\u7ed3\u675f\u672c\u7ae0\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u8bb2\u8bb2\u5728\u751f\u4ea7\u73af\u5883\u4e0b\u5e94\u8be5\u5982\u4f55\u914d\u7f6e<code>SSL</code> </p> <p>\u5728\u8282\u70b9\u4e0a\uff0c<code>SSL</code>\u9a8c\u8bc1\u5728<code>chef-client</code>\u7684<code>/etc/chef/c1ient.rb</code>\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u5b9a\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e<code>chef-client</code>\u83dc\u8c31\u7684\u5c5e\u6027\u6765\u542f\u7528\u3002<code>chef-client</code>\u83dc\u8c31\u4e2d\u7684\u5f88\u591a\u4e1c\u897f\u90fd\u53ef\u4ee5\u901a\u8fc7\u5c5e\u6027\u6765\u8bbe\u5b9a\u3002 </p>"},{"location":"chap1/chef_tutorial9/#7-1","title":"7-1 \u83dc\u8c31\u5e94\u6839\u636e\u5c5e\u6027\u6765\u6539\u53d8\u884c\u4e3a","text":"<p>\u4f18\u79c0\u7684\u83dc\u8bed\u901a\u5e38\u6839\u636e\u5c5e\u6027\u6765\u6539\u53d8\u884c\u4e3a\u7406\u60f3\u6e05\u51b5\u4e0b\u4e0d\u5e94\u8be5\u9700\u8981\u4fee\u6539 \u6ee1\u8db3\u540c\u4e00\u4e2a\u5e94\u7528\u8303\u56f4\u5185\u4e0d\u540c\u6e05\u51b5\u4e0b\u7684\u9700\u6c42 </p> <p>\u53ef\u4ee5\u5728\u83dc\u8c31\u7684<code>attributes</code>\u76ee\u5f55\u4e2d\u770b\u5230\u53ef\u4ee5\u4fee\u6539\u7684\u5c5e\u6027\u4f18\u79c0\u7684\u83dc\u8c31\u901a\u5e38\u7406\u7684\u9ed8\u8ba4\u503c\u5e76\u5728<code>README.md</code>\u6587\u4ef6\u4e2d\u5305\u542b\u8be6\u7ec6\u7684\u6587\u6863\u8bf4\u660e\u8fd9\u4e9b\u5c5e\u6027\u7684\u884c\u4e3a\u3002 </p> <p>SSL\u8bbe\u5b9a\u6709\u65f6\u53ef\u4ee5\u5f88\u590d\u6742\uff0c\u56e0\u6b64\u6211\u4eec\u63a8\u8350\u5728\u914d\u7f6e\u8282\u70b9\u4f7f\u7528SSL\u9a8c\u8bc1\u4e4b\u524d\u5148\u5728\u5f00\u53d1\u673a\u5668\u4e0a\u914d\u7f6eknife\u4f7f\u7528SSL\u9a8c\u8bc1\u3002\u6211\u4eec\u5c06\u5b89\u88c5Chef\u670d\u52a1\u5668\u65f6\u751f\u6210\u7684\u81ea\u6211\u7b7e\u540d\u8bc1\u4e66\u3002</p> <p>\u9700\u8981\u786e\u4fddChef\u670d\u52a1\u5668\u88ab\u914d\u7f6e\u4f7f\u7528\u4f60\u5e0c\u671b\u4f7f\u7528\u7684\u8bc1\u4e66\u6765\u9a8c\u8bc1<code>HTTPS</code>\u901a\u8baf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Chef</code>\u670d\u52a1\u5668\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u81ea\u6211\u7b7e\u540d\u7684\u8bc1\u4e66\u3002\u5982\u679c\u5e0c\u671b\u4f7f\u7528\u8fd9\u4e2a\u81ea\u6211\u7b7e\u540d\u7684\u8bc1\u4e66\u4e00\u5207\u5df2\u7ecf\u5c31\u7eea\u3002\u5728\u8fd9\u4e2a\u7ec3\u4e60\u4e2d\u6211\u4eec\u5c06\u4f7f\u7528\u8fd9\u4e2a\u81ea\u6211\u7b7e\u540d\u7684\u8bc1\u4e66 </p> <p>Refer to the Chef documentation for more information on how to configure ChefServer with a certificate authority-verified certificate.</p> <p>uncomment <code># ssl_verify_mode          :verify_none</code> in <code>knife.rb</code> </p> <p><code>knife ssl check</code>\u547d\u4ee4\u8bf4\u9700\u8981\u5c06\u8bc1\u4e66\u590d\u5236\u5230<code>trusted_certs_dir</code>\u76ee\u5f55\uff08\u5728\u4e0a\u8ff0\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\u76ee\u5f55\u6240\u5728\u4f4d\u7f6e\uff09\u3002\u8fd0\u884c<code>knife ssl fetch</code>\u547d\u4ee4\u81ea\u52a8\u4e0b\u8f7d\u8bc1\u4e66\u5e76\u5c06\u5176\u653e\u5728<code>trusted_certs_dir</code>\u76ee\u5f55 </p> <pre><code>$ knife ssl fetch\nWARNING: Certificates from default-centos65.vagrantup.com will be fetched and placed in your trusted_cert\n         directory (/Users/.../chef-repo/.chef/trusted_certs).\n\n         Knife has no means to verify these are the correct certificates. You should\n         verify the authenticity of these certificates after downloading.\nAdding certificate for default-centos65_vagrantup_com in /Users/.../chef-\n</code></pre> <pre><code>$ knife ssl check \nConnecting to host default-centos65.vagrantup.com:443\nSuccessfully verified certificates from `default-centos65.vagrantup.com'\n</code></pre>"},{"location":"chap1/chef_tutorial9/#8chef-clientssl","title":"8\u3001\u914d\u7f6e<code>Chef-client</code>\u4f7f\u7528\u751f\u4ea7\u73af\u5883\u7684<code>SSL</code>\u8bbe\u7f6e","text":"<p><code>chef-client</code>\u83dc\u8c31\u5305\u542b\u7528\u6765\u81ea\u52a8\u751f\u6210<code>/etc/chef/client.rb</code>\u914d\u7f6e\u6587\u4ef6\u7684<code>chef-client::config</code>\u914d\u65b9\u5355\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u751f\u6210\u5305\u542b\u6211\u4eec\u6240\u9700\u7684<code>SSL</code>\u8bbe\u7f6e\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u5c06\u5728\u8282\u70b9\u4e0a\u914d\u7f6e<code>SSL</code>\u7684\u5de5\u4f5c\u81ea\u52a8\u5316</p> <p>\u767b\u5f55\u5230\u8282\u70b9\u4e95\u67e5\u770b<code>/etc/chef/client.rb</code>\u6587\u4ef6\u3002 <code>/client.rb</code>\u6587\u4ef6\u5728\u4f60\u8fd0\u884c<code>knife bootsrap</code>\u65f6\u5728\u8282\u70b9\u4e0a\u88ab\u521b\u5efa\u7528\u6765\u914d\u7f6e<code>chef-client</code>\u8bbe\u7f6e\u3002\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5e76\u786e\u4fdd\u5b8c\u6210\u65f6\u9000\u56de\u5230\u5f00\u53d1\u673a\u5668 </p> <pre><code>[~/chef-repo/cookbooks/node]$ kitchen login\nLast login: Tue Dec  3 07:09:43 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@node-centos65 ~]$ lt virtual machine.\n[vagrant@node-centos65 ~]$ cat /etc/chef/client.rb\nchef_server_url  \"https://default-centos65.vagrantup.com/organizations/ja\"\nvalidation_client_name \"ja-validator\"\nchef_license \"accept\"\nlog_location   STDOUT\n# Using default node name (fqdn)\ntrusted_certs_dir \"/etc/chef/trusted_certs\"\n\n[vagrant@node-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>\u8981\u542f\u7528SSL\u9a8c\u8bc1,\u6211\u4eec\u9700\u8981\u5728<code>/etc/chef/client.rb</code>\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u8bbe\u7f6e\uff08\u9ed8\u8ba4\u4e3a\uff1a<code>verify_none</code>) </p> <pre><code>ssl_verify_mode          :verify_peer \n</code></pre> <p>\u8981\u8ba9<code>chef-client::config</code>\u914d\u65b9\u5355\u751f\u6210\u8fd9\u9879\u8bbe\u7f6e\u6211\u4eec\u9700\u8981\u8bbe\u5b9a\u4ee5\u4e0b\u5c5e\u6027 </p> <pre><code>node.default['chef_client']['config']['ssl_verify_mode'] = ':verify_peer'\n</code></pre>"},{"location":"chap1/chef_tutorial9/#8-1-edit-attributes","title":"8-1 Edit attributes","text":"<pre><code>{\n  \"chef_client\": {\n    \"config\": {\n      \"ssl_verify_mode\": \":verify_peer\"\n    }\n  }\n}\n</code></pre> <pre><code>$ knife node list\nnode-centos65.vagrantup.com\n\n$ knife node show --attribute \"chef_client.config.ssl_verify_mode\" \\\n&gt; node-centos65.vagrantup.com\nnode-centos65.vagrantup.com:\n  chef_client.config.ssl_verify_mode: :verify_peer\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u4f7f\u7528\u7684\u662f\u81ea\u6211\u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u518d\u8bbe\u7f6e\u4e00\u4e2a\u5c5e\u6027\u3002\u9700\u8981\u544a\u8bc9\u8282\u70b9\u4e0a\u7684<code>SSL</code>\u5e93\u6211\u4eec\u4fe1\u4efb\u81ea\u6211\u7b7e\u540d\u7684\u670d\u52a1\u5668\u8bc1\u4e66\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e0b\uff0c\u5e94\u8be5\u5199\u4e00\u4e2a\u914d\u65b9\u5355\u5c06\u8bc1\u4e66\u6dfb\u52a0\u5230\u8282\u70b9\u4e0a\u7684\u8bc1\u4e66\u5b58\u50a8\u4f4d\u7f6e\u4e2d\u3002 \u8bc1\u4e66\u7684\u5b58\u50a8\u76ee\u5f55<code>SSL_CERT_DIR</code> </p> <p>\u5982\u679c\u5728\u8282\u70b9\u4e0a\u4f7f\u7528<code>OpenSSL</code>\uff0c\u9700\u8981\u5c06\u8bc1\u4e66\u590d\u5236\u5230\u53ef\u4fe1\u7684\u5e76\u8fd0\u884c<code>c_rehash</code>\u6765\u6ce8\u518c\u81ea\u6211\u7b7e\u540d\u7684\u8bc1\u4e66\u3002 </p> <p>\u5728\u6211\u4eec\u7684\u6d4b\u8bd5\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7\u5728\u7b2c9\u7ae0\u4e2d\u8bbe\u5b9a\u7684\u672c\u673a\u4e0e\u8282\u70b9\u7684\u540c\u6b65\u76ee\u5f55\u5c06\u8bc1\u4e66\u6587\u4ef6\u540c \u6b65\u5230\u8282\u70b9\u4e0a\u3002\u6211\u4eec\u8bbe\u5b9a\u7684\u540c\u6b65\u76ee\u5f55\u4f7f\u5f00\u53d1\u673a\u5668\u4e0a\u7684<code>chef-repo/.chef/trusted_certs</code>\u76ee\u5f55\u5728\u8282\u70b9\u4e0a\u4e5f\u53ef\u8bbf\u95ee\u3002\u8fd9\u4e2a\u76ee\u5f55\u5728\u4f60\u5148\u524d\u8fd0\u884c<code>knife ssl fetch</code>\u65f6\u5728\u5f00\u53d1\u673a\u5668\u4e0a\u5df2\u7ecf\u8bbe\u5b9a\u597d\u3002 </p> <p>\u73b0\u5728\u56de\u5230<code>Chef</code>\u670d\u52a1\u5668\u7684\u7f51\u9875\u754c\u9762\uff08\u6216\u4f7f\u7528<code>knife node edit</code>\u547d\u4ee4\uff09\uff0c\u5e76\u5728\u6211\u4eec\u7684\u4fa7\u8bd5\u8282\u70b9 \u4e2d\u6dfb\u52a0<code>ssl_ca_file</code>\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a </p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>knife node show --attribute</code> \u547d\u4ee4\u68c0\u67e5<code>chef_client.config.ssl_verify_mode</code> \u548c <code>chef_client.config.ssl_ca_file</code>\u5c5e\u6027\u88ab\u6b63\u786e\u8bbe\u5b9a\uff0c</p> <pre><code>$ knife node show --attribute \"chef_client.config.ssl_verify_mode\" \\\n&gt; node-centos65.vagrantup.com\nnode-centos65.vagrantup.com:\n  chef_client.config.ssl_verify_mode: :verify_peer\n</code></pre> <pre><code>$ knife node show --attribute \"chef_client.config.ssl_ca_file\" \\\n&gt; node-centos65.vagrantup.com\nnode-centos65.vagrantup.com:\n  chef_client.config.ssl_ca_file: /chef-repo/.chef/trusted_certs/default-centos65_vagrantup_com.crt\n</code></pre> <pre><code>$ cd ~/chef-repo/cookbooks/node\n$ $ kitchen login\nLast login: Tue Dec  3 07:55:04 2019 from 172.16.72.2\nWelcome to your Packer-built virtual machine.\n[vagrant@node-centos65 ~]$ ls /chef-repo/.chef/trusted_certs\ndefault-centos65_vagrantup_com.crt\n[vagrant@node-centos65 ~]$ exit\nlogout\nConnection to 127.0.0.1 closed.\n</code></pre> <p>\u5728\u786e\u5b9a\u6240\u6709\u8bbe\u7f6e\u90fd\u6b63\u786e\u540e\uff0c\u5c06<code>chef-client::config</code>\u914d\u65b9\u4e00\u5355\u6dfb\u52a0\u5230\u8fd0\u884c\u6e05\u5355\u4e2d\uff1a </p> <pre><code>$ knife node run_list add node-centos65.vagrantup.com \\\n&gt; \"recipe[chef-client::config]\"\nnode-centos65.vagrantup.com:\n  run_list:\n    recipe[chef-client::delete_validation]\n    recipe[chef-client]\n    recipe[chef-client::config]\n</code></pre> <p>\u7136\u540e\u767b\u5f55\u5230\u8282\u70b9\u5e76\u6267\u884c\u4e00\u6b21<code>Chef</code>\u8fd0\u884c\u3002\u56e0\u4e3a\u4f60\u6dfb\u52a0\u4e86<code>chef-client::config</code> \u6e05\u5355<code>Chef</code>\u4f1a\u786e\u4fdd<code>/etc/chef/client.rb</code>\u5339\u914d\u4f60\u5728\u8282\u70b9\u4e0a\u6ca1\u5b9a\u7684\u5c5e\u6027\u3002\u4f60\u4f1a\u518d\u4e00\u6b21\u5f97\u5230SSL\u8b66\u544a, \u56e0\u4e3a<code>chef-client</code>\u5c1a\u5e94\u7528\u4f60\u7684<code>SSL</code>\u9a8c\u8bc1\u8bbe\u7f6e\uff1a </p> <pre><code>$ sudo chef-client\nStarting Chef Infra Client, version 15.5.17\nresolving cookbooks for run list: [\"chef-client::delete_validation\", \"chef-client\", \"chef-client::config\"]\nSynchronizing Cookbooks:\n  - chef-client (11.4.0)\n  - cron (6.2.2)\n  - logrotate (2.2.2)\nInstalling Cookbook Gems:\nCompiling Cookbooks...\nConverging 14 resources\nRecipe: chef-client::delete_validation\n  * file[/etc/chef/validation.pem] action delete (up to date)\nRecipe: chef-client::init_service\n  * directory[/var/run/chef] action create (up to date)\n  * directory[/var/cache/chef] action create (up to date)\n  * directory[/var/lib/chef] action create (up to date)\n  * directory[/var/log/chef] action create (up to date)\n  * directory[/etc/chef] action create (up to date)\n  * template[/etc/init.d/chef-client] action create (up to date)\n  * template[/etc/sysconfig/chef-client] action create (up to date)\n  * service[chef-client] action enable (up to date)\n  * service[chef-client] action start (up to date)\nRecipe: chef-client::config\n  * logrotate_app[chef-client] action enable\n    * directory[/etc/logrotate.d] action create (up to date)\n    * template[/etc/logrotate.d/chef-client] action create (up to date)\n     (up to date)\n  * file[/var/log/chef/client.log] action create (up to date)\n  * template[/etc/chef/client.rb] action create (up to date)\n  * directory[/etc/chef/client.d] action create (up to date)\n  * ruby_block[reload_client_config] action nothing (skipped due to action :nothing)\n\nRunning handlers:\nRunning handlers complete\nChef Infra Client finished, 0/17 resources updated in 03 seconds\n</code></pre>"},{"location":"chap1/chef_tutorial9/#9","title":"9\u3001\u672c\u8282\u5c0f\u7ed3","text":"<pre><code>$ knife cookbook site search chef-client\n$ knife cookbook site show chef-client\n$ knife cookbook site download chef-client 11.4.0\n$ knife cookbook upload chef-client \n\n\n$ knife node list\n$ knife node -h\n$ knife node run_list add node-centos65.vagrantup.com \"recipe[chef-client]\"\n$ knife node run_list add &lt;node&gt; \\\n\"recipe[&lt;cookbook&gt;::&lt;recipe&gt;],recipe[&lt;cookbook&gt;::&lt;recipe&gt;]\"\n\n$ knife ssl check\n$ knife ssl fetch\n\n$ knife node show --attribute \"chef_client.config.ssl_verify_mode\" \\\n&gt; node-centos65.vagrantup.com\n\n$ knife node show --attribute \"chef_client.config.ssl_verify_mode\" \\\n&gt; node-centos65.vagrantup.com\n\n$ knife node show --attribute \"chef_client.config.ssl_ca_file\" \\\n&gt; node-centos65.vagrantup.com\n</code></pre>"},{"location":"chap2/chef_adv1/","title":"\u7b2c\u4e09\u8282 How to Perform Chef Knife SSL Check and Fetch to Verify Certificate","text":"<p>Starting from Chef server version 12, SSL verification is enabled by default for all the communication that are initiated from any of the chef utilities (knife, chef-client).</p> <p>For this, Chef server will generate a self-signed SSL certificate during the installation process.</p> <p>From your Chef workstation when you execute knife command, you should download the SSL certificate before you can get started.</p> <p>If you don\u2019t do this, knife command will not connect to the Chef server.</p>"},{"location":"chap2/chef_adv1/#1why-chef-ssl-certificate","title":"1\u3001Why Chef SSL Certificate?","text":"<p>Starting from Chef server version 12, when you perform a simple command like <code>knife client list</code>, it will display the SSL validation failure error message, as the workstation don\u2019t have the server\u2019s SSL certificate for verification.</p> <pre><code># knife client list\nERROR: SSL Validation failure connecting to host: datadb - SSL_connect returned=1 errno=0 state=error: certificate verify failed\nERROR: Could not establish a secure connection to the server.\nUse `knife ssl check` to troubleshoot your SSL configuration.\nIf your Chef Server uses a self-signed certificate, you can use\n`knife ssl fetch` to make knife trust the server's certificates.\nOriginal Exception: OpenSSL::SSL::SSLError: SSL Error connecting to https://datadb/organizations/thegeekstuff/clients - SSL_connect returned=1 errno=0 state=error: certificate verify failed\n</code></pre> <p>Even the chef-client that runs on the individual nodes will need the SSL certificate.</p> <p>To avoid this SSL error, we should download the self-signed SSL certificate that is generated by the Chef server and store it in the trusted store on the chef client machines including the workstations and individual nodes.</p> <p>On the Chef workstation when the SSL certificate is installed properly, it will not display the SSL error message when executing knife command.</p> <pre><code>$ knife client list\ndevops-jxi-validator\nnode1\n</code></pre> <p>On a high-level, you have to do the following. All of these are explained in this tutorial along with possible error messages that you might get and how to resolve those:</p> <ul> <li>On your chef workstation, download the chef server\u2019s SSL certificate</li> <li>On all your individual nodes, make sure a valid chef server\u2019s certificate is installed as part of the bootstrap.</li> <li>Also, verify the check-sum of the downloaded chef server\u2019s SSL certificate.</li> </ul>"},{"location":"chap2/chef_adv1/#1-1-knife-ssl-check-error-1-invalid-chef-repo-directory","title":"1-1 Knife SSL Check \u2013 Error 1 (Invalid chef-repo Directory)","text":"<p>You can use the knife ssl check command to verify whether the Chef SSL certificate is installed properly on your local machine</p> <p>You should execute ssl check command inside the chef repository directory. If not, you\u2019ll get the \u201cNo knife configuration file found\u201d error message as shown below.</p> <p>At this stage, this has nothing to do with unable to verify SSL certificate. The following error message is because you are inside a wrong directory when executing the knife ssl check command.</p> <pre><code># knife ssl check\nWARNING: No knife configuration file found\nConnecting to host localhost:443\nERROR: The SSL cert is signed by a trusted authority but is not valid for the given hostname\nERROR: You are attempting to connect to:   'localhost'\nERROR: The server's certificate belongs to 'datadb'\n\nTO FIX THIS ERROR:\n\nThe solution for this issue depends on your networking configuration. If you\nare able to connect to this server using the hostname datadb\ninstead of localhost, then you can resolve this issue by updating chef_server_url\nin your configuration file.\n\nIf you are not able to connect to the server using the hostname datadb\nyou will have to update the certificate on the server to use the correct hostname.\n</code></pre> <p>So, to fix this particular error message, simply cd to chef-repo and execute the <code>knife ssl check</code> command as shown below.</p> <pre><code>cd ~/chef-repo\nknife ssl check\n</code></pre>"},{"location":"chap2/chef_adv1/#1-2-knife-ssl-check-error-2-no-ssl-certificate-found","title":"1-2 Knife SSL Check \u2013 Error 2 (No SSL Certificate Found)","text":"<p>In the following knife ssl check command example, the output indicates that on this Chef workstation, the Chef server\u2019s SSL certificate is not installed.</p> <pre><code># cd ~/chef-repo\n\n# knife ssl check\nConnecting to host datadb:443\nERROR: The SSL certificate of datadb could not be verified\nCertificate issuer data: /C=US/O=YouCorp/OU=Operations/CN=datadb\n\nConfiguration Info:\n\nOpenSSL Configuration:\n* Version: OpenSSL 1.0.1s  1 Mar 2016\n* Certificate file: /opt/chefdk/embedded/ssl/cert.pem\n* Certificate directory: /opt/chefdk/embedded/ssl/certs\nChef SSL Configuration:\n* ssl_ca_path: nil\n* ssl_ca_file: nil\n* trusted_certs_dir: \"/root/chef-repo/.chef/trusted_certs\"\n\nTO FIX THIS ERROR:\n\nIf the server you are connecting to uses a self-signed certificate, you must\nconfigure chef to trust that server's certificate.\n\nBy default, the certificate is stored in the following location on the host\nwhere your chef-server runs:\n\n  /var/opt/opscode/nginx/ca/SERVER_HOSTNAME.crt\n\nCopy that file to your trusted_certs_dir (currently: /root/chef-repo/.chef/trusted_certs)\nusing SSH/SCP or some other secure method, then re-run this command to confirm\nthat the server's certificate is now trusted.\n</code></pre> <p>When you execute the ssl check command, it will look for the certificate under .chef/trusted_certs directory. If it finds it there, it will verify to make sure it is a valid X.590 SSL certificate. If it can\u2019t find a valid certificate, it will throw the above error message.</p>"},{"location":"chap2/chef_adv1/#1-3-knife-ssl-fetch-error-3-network-error-connection-refused","title":"1-3 Knife SSL Fetch \u2013 Error 3 (Network Error \u2013 Connection Refused)","text":"<p><code>Knife ssl fetch</code> command will get the certificate from the Chef server and install it on the individual workstation or node where you are executing the fetch command.</p> <p>During knife ssl fetch, you might get the following Network error connection refused message as shown below.</p> <pre><code># knife ssl fetch\nWARNING: Certificates from datadb will be fetched and placed in your trusted_cert\ndirectory (/root/chef-repo/.chef/trusted_certs).\n\nKnife has no means to verify these are the correct certificates. You should\nverify the authenticity of these certificates after downloading.\n\nERROR: Network Error: Connection refused - connect(2) for \"datadb\" port 443\nCheck your knife configuration and network settings\n</code></pre> <p>The same network error connection refused error message for \u201cknife client list\u201d also. So, this error has to do with some unable to resolve/reach using proper name \u201cdatadb\u201d.</p> <p>When you get the above connection refused error message, the same thing will happen for other knife commands also as shown below.</p> <pre><code># knife client list\nERROR: Connection refused connecting to https://datadb/organizations/thegeekstuff/clients, retry 1/5\nERROR: Connection refused connecting to https://datadb/organizations/thegeekstuff/clients, retry 2/5\n\n</code></pre> <p>This means that your Chef workstation or individual node is unable to initiate network communication to the Chef server.</p> <p>To fix this error, you have to make sure your server is using a fully qualified domain name. In the following example, we don\u2019t see the FQDN setup properly.</p> <pre><code># hostname -f\ndatadb\n</code></pre> <p>Also, to fix this error message, in my example, my <code>/etc/hosts</code> file looked like the following. Basically you have to make sure both your hostname and FQDN properly setup.</p> <p>In the following example, the ip-address in the last line the ip-address of the datadb server.</p> <pre><code># cat /etc/hosts\n127.0.0.1 datadb.thegeekstuff.com datadb\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.100.2 datadb.thegeekstuff.com datadb\n</code></pre> <p>Now, when I execute the <code>hostname -f</code> command, I\u2019ll get the FQDN as shown below.</p> <pre><code># hostname -f\ndatadb.thegeekstuff.com\n</code></pre> <p>After the above changes to the /etc/hosts file, now you shouldn\u2019t get the Network Error connection refused message anymore from the knife command.</p>"},{"location":"chap2/chef_adv1/#1-4-knife-fetch-ssl-certificate-and-store-it","title":"1-4 Knife Fetch SSL certificate and Store it","text":"<p>Finally, use the <code>knife ssl fetch</code> command as shown below to retrieve the SSL certificate from the Chef server and store it to the <code>.chef/trusted_certs</code> directory on the workstation or the individual nodes by either the <code>knife</code> or <code>chef-client</code> command.</p> <p>The location of where the certificate will be stored when you execute the knife ssl fetch command will be determined by the <code>trusted_certs_dir</code> parameter in the <code>/etc/chef/client.rb</code> file</p> <p>on the work node</p> <pre><code># cd /etc/chef\n# less client.rb\n\nchef_server_url  \"https://ChefServer/organizations/devops-jxi\"\nvalidation_client_name \"devops-jxi-validator\"\nlog_location   STDOUT\nnode_name \"node1\"\nssl_verify_mode :verify_none\ntrusted_certs_dir \"/etc/chef/trusted_certs\"\n</code></pre> <pre><code># knife ssl fetch\nWARNING: Certificates from datadb will be fetched and placed in your trusted_cert\ndirectory (/root/chef-repo/.chef/trusted_certs).\n\nKnife has no means to verify these are the correct certificates. You should\nverify the authenticity of these certificates after downloading.\n\nAdding certificate for datadb in /root/chef-repo/.chef/trusted_certs/datadb.crt\n</code></pre> <p>As we see here, on the workstation, the certificate is now downloaded and stored. This certificate will be used by knife command to communicate to the Chef server on SSL.</p> <pre><code># ls -l .chef/trusted_certs/\n-rw-r--r--. 1 root root 1330 Jun 24 09:44 datadb.crt\n</code></pre> <p>As you see, this is a standard SSL certificate. This is a self-signed certificated generated by Chef server.</p> <pre><code># cat .chef/trusted_certs/datadb.crt \n-----BEGIN CERTIFICATE-----\nANBgkqhkiG9w0BAQsFADBFMQswCQYDVQQGEwJVUzEQ\nETMBEGA1UECwwKT3BlcmF0aW9uczEPMA0GA1UEAwwG\n..\n..\nIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN3l\nWO7bpxbQ1qqeuq9aLhNTIM1alwHfvlckmzSJsHRI+V\nTaWuk7xncRs4VCUw==\n-----END CERTIFICATE-----\n</code></pre>"},{"location":"chap2/chef_adv1/#2-final-knife-ssl-check-verification","title":"2 Final Knife SSL Check Verification","text":"<p>After installing the SSL certificate properly as shown above, now when you execute the knife ssl check, it will not report any error. The following verifies that the Chef Server\u2019s self-signed SSL certificate is properly installed on this machine and knife or chef-client command can use it without any issue.</p> <pre><code># knife ssl check\nConnecting to host datadb:443\nSuccessfully verified certificates from `datadb'\n</code></pre>"},{"location":"chap2/chef_adv1/#2-1-knife-ssl-check-for-a-different-chef-server-url","title":"2-1 Knife SSL Check for a different Chef Server URL","text":"<p>By default, when you execute knife ssl check (or knife ssl fetch), how does it know which Chef server to connect to?</p> <p>For this, it will use the <code>chef_server_url</code> from the <code>knife.rb</code> file as shown below.</p> <pre><code># cat .chef/knife.rb \ncurrent_dir = File.dirname(__FILE__)\nlog_level                :info\nlog_location             STDOUT\nnode_name                \"ramesh\"\nclient_key               \"#{current_dir}/ramesh.pem\"\nvalidation_client_name   \"thegeekstuff-validator\"\nvalidation_key           \"#{current_dir}/thegeekstuff-validator.pem\"\nchef_server_url          \"https://datadb/organizations/thegeekstuff\"\ncookbook_path            [\"#{current_dir}/../cookbooks\"]\n</code></pre> <p>But, using knife ssl check, you can verify the SSL certificate for a different Chef server by passing the chef server url as a parameter. </p> <p>In the following example, it will connect to <code>datadb-prod</code> Chef server to verify the SSL certificate.</p> <pre><code># knife ssl check https://datadb-prod/organizations/thegeekstuff\nConnecting to host datadb-prod:443\nSuccessfully verified certificates from `datadb-prod'\n</code></pre>"},{"location":"chap2/chef_adv1/#2-2-knife-ssl-check-on-individual-node-on-chef-client","title":"2-2 Knife SSL Check on Individual Node (On Chef Client)","text":"<p>If you want to verify whether your client machine where the chef-client command is execute has the properly valid Chef server\u2019s SSL certificate, then execute the <code>knife ssl check</code> command and pass the \u2013config parameter as shown below</p> <pre><code># knife ssl check --config /etc/chef/client.rb\nConnecting to host datadb:443\nSuccessfully verified certificates from `datadb'\n</code></pre> <p>In the above example, the knife ssl check command will use the chef_server_url parameter\u2019s value from the following <code>client.rb</code> file as the Chef Server to connect and verify the SSL certificate.</p> <pre><code># cat /etc/chef/client.rb \nlog_location     STDOUT\nchef_server_url  \"https://datadb/organizations/thegeekstuff\"\nvalidation_client_name \"thegeekstuff-validator\"\n# Using default node name (fqdn)\ntrusted_certs_dir \"/etc/chef/trusted_certs\"\n</code></pre>"},{"location":"chap2/chef_adv1/#2-3-knife-ssl-fetch-from-a-different-chef-server-url","title":"2-3 Knife SSL Fetch from a different Chef Server URL","text":"<p>You can also get the SSL certificate from a different chef server (than the default one from the <code>knife.rb</code>) by specifying the chef server\u2019s URL as a parameter to the knife ssl fetch command as shown below.</p> <pre><code># knife ssl fetch https://datadb-prod/organizations/thegeekstuff\nWARNING: Certificates from datadb-prod will be fetched and placed in your trusted_cert\ndirectory (/root/chef-repo/.chef/trusted_certs).\n\nKnife has no means to verify these are the correct certificates. You should\nverify the authenticity of these certificates after downloading.\n\nAdding certificate for datadb-prod in /root/chef-repo/.chef/trusted_certs/datadb-prod.crt\n</code></pre>"},{"location":"chap2/chef_adv1/#2-4-validate-the-downloaded-chef-server-certificate","title":"2-4 Validate the Downloaded Chef Server Certificate","text":"<p>When you have the chef server and the chef workstation running on different machine and when you are doing the knife ssl fetch, it is a good idea to verify the check sum to make sure you have downloaded the correct certificate.</p> <p>On the Chef Server, the SSL certificate is located under <code>/var/opt/opscode/nginx/ca</code> directory. Use the sha256sum command to get the check-sum as shown below.</p> <pre><code># sha256sum /var/opt/opscode/nginx/ca/datadb.crt\nbd32b7f8ddc2e4e405f990dd6  /var/opt/opscode/nginx/ca/datadb.crt\n</code></pre> <p>On your Chef workstation, where you did \u201cknife ssl fetch\u201d command to download the certificate, execute the following <code>sha256sum</code> command and make sure the following check-sum value matches the above value.</p> <pre><code># sha256sum .chef/trusted_certs/datadb.crt \nbd32b7f8ddc2e4e405f990dd6  .chef/trusted_certs/datadb.crt\n</code></pre> <p>Reference</p>"},{"location":"chap2/chef_adv2/","title":"\u7b2c\u56db\u8282 12 Chef Knife Cookbook Command Examples","text":"<p>When you are using Chef to manage all your servers and network equipments, you should first create cookbooks and appropriate recipes.</p> <p>On all your remote servers, you\u2019ll use chef-client to execute the recipes from the cookbook.</p> <p>In this tutorial, we\u2019ll explain how to use knife command to create and manage your Chef cookbooks.</p>"},{"location":"chap2/chef_adv2/#1-create-new-chef-cookbook","title":"1. Create New Chef Cookbook","text":"<p>To create a cookbook, use \u201c<code>knife cookbook create</code>\u201d command as shown below. The following will create a cookbook with name thegeekstuff.</p> <pre><code>$ knife cookbook create test\nFATAL: knife cookbook create has been removed. Please use `chef generate cookbook` from the ChefDK\n</code></pre> <pre><code>$ cd /home/vagrant/chef-repo/cookbooks\n$ chef generate cookbook Sushi\n\n$ chef generate cookbook Sushi\nGenerating cookbook Sushi\n- Ensuring correct cookbook file content\n- Ensuring delivery configuration\n- Ensuring correct delivery build cookbook content\n\nYour cookbook is ready. Type `cd Sushi` to enter it.\n\nThere are several commands you can run to get started locally developing and testing your cookbook.\nType `delivery local --help` to see a full list.\n\nWhy not start by writing a test? Tests for the default recipe are stored at:\n\ntest/integration/default/default_test.rb\n\nIf you'd prefer to dive right in, the default recipe can be found at:\n\nrecipes/default.rb\n</code></pre> <p>For the above command, knife command creates a separate directory called \u201cSushi\u201d under <code>~/chef-repo/cookbooks</code> as shown below.</p> <p>The following is the cookbook folder structure.</p> <pre><code>$ tree Sushi/\nSushi/\n\u251c\u2500\u2500 Berksfile\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 chefignore\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 recipes\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 default.rb\n\u251c\u2500\u2500 spec\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spec_helper.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 unit\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 recipes\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 default_spec.rb\n\u2514\u2500\u2500 test\n    \u2514\u2500\u2500 integration\n        \u2514\u2500\u2500 default\n            \u2514\u2500\u2500 default_test.rb\n\n7 directories, 10 files\n</code></pre>"},{"location":"chap2/chef_adv2/#2-create-new-cookbook-with-custom-options","title":"2. Create New Cookbook with Custom Options","text":"<p>The metadata.rb file under the cookbook directory will have the following default values.</p> <pre><code>$ cat /home/vagrant/chef-repo/cookbooks/Sushi/metadata.rb\nname 'Sushi'\nmaintainer 'The Authors'\nmaintainer_email 'you@example.com'\nlicense 'All Rights Reserved'\ndescription 'Installs/Configures Sushi'\nlong_description 'Installs/Configures Sushi'\nversion '0.1.0'\nchef_version '&gt;= 13.0'\n\n# The `issues_url` points to the location where issues for this cookbook are\n# tracked.  A `View Issues` link will be displayed on this cookbook's page when\n# uploaded to a Supermarket.\n#\n# issues_url 'https://github.com/&lt;insert_org_here&gt;/Sushi/issues'\n\n# The `source_url` points to the development repository for this cookbook.  A\n# `View Source` link will be displayed on this cookbook's page when uploaded to\n# a Supermarket.\n#\n# source_url 'https://github.com/&lt;insert_org_here&gt;/Sushi'\n</code></pre> <p>The above values will be used to generate header in any of the <code>.rb</code> files that you create under this cookbook.</p> <p>While creating a cookbook, the best practice is to pass the following options.</p> <pre><code>$ chef generate cookbook COOKBOOK_PATH/COOKBOOK_NAME (options)\n</code></pre>"},{"location":"chap2/chef_adv2/#2-1-options","title":"2-1 Options","text":"<p>This subcommand has the following options:</p> <pre><code>-g GENERATOR_COOKBOOK_PATH, --generator-cookbook GENERATOR_COOKBOOK_PATH\n</code></pre> <p>The path at which a cookbook named <code>code_generator</code> is located. This cookbook is used by the <code>chef generate</code> subcommands to generate cookbooks, cookbook files, templates, attribute files, and so on. Default value: <code>lib/chef-dk/skeletons</code>, under which is the default <code>code_generator</code> cookbook that is included as part of the Chef development kit.</p> <p><code>-b, --berks</code></p> <p>Create a Berksfile in the cookbook. Default value: enabled. This is disabled if the <code>--policy</code> option is given.</p> <p><code>-C COPYRIGHT, --copyright COPYRIGHT</code></p> <p>Generate a delivery config file and build cookbook inside the new cookbook. Default value: disabled. This option is disabled. It has no effect and exists only for compatibility with past releases</p> <p><code>-m EMAIL, --email EMAIL</code></p> <p>Specify the email address of the author. Default value: <code>you@example.com</code>.</p> <p><code>-a KEY=VALUE, --generator-arg KEY=VALUE</code></p> <p>Sets a property named KEY to the given VALUE on the generator context object in the generator cookbook. This allows custom generator cookbooks to accept optional user input on the command line.</p> <p><code>-I LICENSE, --license LICENSE</code></p> <p>Sets the license. Valid values are <code>all_rights</code>, <code>apache2</code>, <code>mit</code>, <code>gplv2</code>, or <code>gplv3</code>. Default value: all_rights.</p> <p><code>-P, --policy</code></p> <p>Create a Policyfile in the cookbook instead of a Berksfile. Default value: disabled.</p> <p><code>-h, --help</code></p> <p>Show help for the command.</p> <p><code>-v, --version</code></p> <p>The version of the chef-client.</p>"},{"location":"chap2/chef_adv2/#3-upload-cookbook-to-chef-server","title":"3. Upload Cookbook to Chef Server","text":"<p>The following \u201cknife cookbook upload\u201d command will upload the cookbook that we created above to the Chef server.</p> <p>As we see, since this is the first version of this cookbook, it is showing the version number as 0.1.0.</p> <pre><code>$ sudo knife cookbook upload Sushi\nUploading Sushi          [0.1.0]\nUploaded 1 cookbook.\n</code></pre> <p>When you have multiple cookbooks that has multiple versions, you can upload all of your cookbooks using option <code>-a</code>.</p> <p>In the following example, we have 3 cookbooks, and the latest version of all these cookbooks are getting uploaded.</p> <pre><code>$ sudo knife cookbook upload -a\nUploading ApacheWebserver [0.1.0]\nUploading Sushi          [0.1.0]\nUploading starter        [1.0.0]\nUploaded all cookbooks.\n</code></pre> <p>The following command will not only upload \u201cSushi\u201d cookbook, but it will also upload all the dependent cookbooks.</p> <pre><code>$ sudo knife cookbook upload Sushi -d\nUploading Sushi          [0.1.0]\nUploaded 1 cookbook.\n</code></pre>"},{"location":"chap2/chef_adv2/#4-lock-a-cookbook-from-future-edits","title":"4. Lock a Cookbook from Future Edits","text":"<p>When you don\u2019t want anybody else to be modifying a particular cookbook version, use the <code>\u2013freeze</code> option.</p> <p>In the following example, after this command, nobody can upload the 0.1.0 version of \u201cSushi\u201d cookbook anymore. You have to create a new version.</p> <pre><code>$ sudo knife cookbook upload Sushi --freeze\nUploading Sushi          [0.1.0]\nUploaded 1 cookbook.\n</code></pre> <p>If you are trying to upload the same version, you\u2019ll get the following error message.</p> <pre><code>$ sudo knife cookbook upload Sushi\nUploading Sushi          [0.1.0]\nERROR: Version 0.1.0 of cookbook Sushi is frozen. Use --force to override.\nWARNING: Not updating version constraints for Sushi in the environment as the cookbook is frozen.\nERROR: Failed to upload 1 cookbook.\n</code></pre> <p>For some reason, if you want to edit and upload a cookbook that is frozen, use the \u2013force option.</p> <pre><code>$ sudo knife cookbook upload Sushi --force\nUploading Sushi          [0.1.0]\nUploaded 1 cookbook.\n</code></pre> <p>When you are uploading lot of cookbooks that are big, you can use the <code>\u2013-concurrency</code> option. By default this is set to <code>10</code>. In the following example, we are setting the concurrency to 15 while uploading the cookbook.</p> <pre><code># knife cookbook upload -a --concurrency 15\n</code></pre>"},{"location":"chap2/chef_adv2/#5-get-a-list-of-all-cookbooks","title":"5. Get a List of ALL Cookbooks","text":"<p>The following \u201cknife cookbook list\u201d command will display all the cookbooks that are available on your Chef server. The 2nd column in the following output is the latest version of that cookbook</p> <pre><code>$ knife cookbook list\nApacheWebserver   0.1.0\nSushi             0.1.0\nstarter           1.0.0\n</code></pre> <p>To view how many versions are available for the cookbooks, use the <code>-a</code> option which will display ALL versions. You can also use <code>\u2013all</code> option.</p> <pre><code>$ knife cookbook list -a\nApacheWebserver   0.1.0\nSushi             0.1.0\nstarter           1.0.0\n</code></pre> <p>The <code>-w</code> option will display all the cookbook versions along with their corresponding URIs as shown below. You can also use <code>\u2013with-uri</code> option. You can combine <code>-a</code> option with <code>-w</code> as shown below.</p> <pre><code>$ knife cookbook list -aw\nApacheWebserver:\n  0.1.0: https://chefserver/organizations/devops-jxi/cookbooks/ApacheWebserver/0.1.0\nSushi:\n  0.1.0: https://chefserver/organizations/devops-jxi/cookbooks/Sushi/0.1.0\nstarter:\n  1.0.0: https://chefserver/organizations/devops-jxi/cookbooks/starter/1.0.0\n</code></pre>"},{"location":"chap2/chef_adv2/#6-delete-a-single-cookbook","title":"6. Delete a Single Cookbook","text":"<pre><code>$ knife cookbook delete Sushi\nDo you really want to delete Sushi version 0.1.0? (Y/N) y\nDeleted cookbook[Sushi version 0.1.0]\n</code></pre> <p>The <code>-p</code> option will delete the cookbook, and permanently purge the cookbook from the Chef server. Use this option with caution.</p> <pre><code># knife cookbook delete dev-db -p\nFiles that are common to multiple cookbooks are shared, so purging the files may disable other cookbooks. Are you sure you want to purge files instead of just deleting the cookbook? (Y/N) Y\nDo you really want to delete dev-db version 0.1.0? (Y/N) Y\nDeleted cookbook[dev-db version 0.1.0]\n</code></pre>"},{"location":"chap2/chef_adv2/#7-delete-one-or-all-versions-of-a-cookbook","title":"7. Delete One (or All) Versions of a Cookbook","text":"<p>When a cookbook has multiple versions, the delete command will display all the versions and prompt the user to choose either one of the version, or all versions as shown below.</p> <pre><code># knife cookbook delete thegeekstuff\nWhich version(s) do you want to delete?\n1. thegeekstuff 2.1.0\n2. thegeekstuff 2.0.0\n3. thegeekstuff 1.0.0\n4. thegeekstuff 0.1.0\n5. All versions\n</code></pre> <p>In the above example, I choose 1 to delete \u201c<code>thegeekstuff</code>\u201d cookbook with version <code>2.1.0</code></p> <pre><code>1\nDeleted cookbook[thegeekstuff][2.1.0]\n</code></pre> <p>You can also specify the version number to delete directly in the command lien as shown below.</p> <pre><code># knife cookbook delete 2.1.0 thegeekstuff\nDo you really want to delete 2.1.0 version thegeekstuff? (Y/N) N\nDeleted cookbook[thegeekstuff][2.1.0]\n</code></pre> <p>If you want to delete ALL the version of a specific cookbook, use option <code>-a</code> as shown below. You can also use <code>\u2013all</code> instead of <code>-a</code>.</p> <pre><code># knife cookbook delete thegeekstuff -a\nDo you really want to delete all versions of thegeekstuff? (Y/N) Y\nDeleted cookbook[thegeekstuff][2.1.0]\nDeleted cookbook[thegeekstuff][2.0.0]\nDeleted cookbook[thegeekstuff][1.0.0]\nDeleted cookbook[thegeekstuff][0.1.0]\n</code></pre>"},{"location":"chap2/chef_adv2/#8-delete-multiple-cookbooks-using-bulk-delete","title":"8. Delete Multiple Cookbooks using Bulk Delete","text":"<p>In the following example, we are using \u201cknife cookbook bulk delete\u201d command to delete multiple cookbooks at the same time. You can pass regular-expressions as parameter to this command.</p> <p>The following example will delete all the cookbooks that start with \u201cdev-\u201c.</p> <p>This this example, we have three cookbooks that matches the given regular expression. But, each of these cookbooks have multiple versions. So, this command will delete all the version of these three cookbooks.</p> <pre><code>$  knife cookbook bulk delete \"^dev-*\"\nAll versions of the following cookbooks will be deleted:\n\n\n\nDo you really want to delete these cookbooks? (Y/N) n\nYou said no, so I'm done here.\n</code></pre>"},{"location":"chap2/chef_adv2/#9-download-cookbook-from-chef-server","title":"9. Download Cookbook from Chef Server","text":"<p>When you have chef-client installed on multiple machine, and when you want to download a cookbook that someone has modified on your client, then use the \u201c<code>knife cookbook download</code>\u201d command as shown below.</p> <p>The following command will download the \u201c<code>ApacheWebserver</code>\u201d cookbook from the Chef server to your local machine.</p> <p>The cookbook will be downloaded to the current directory. The downloaded cookbook folder will also have the version number appended at the end.</p> <pre><code>$ sudo knife cookbook download ApacheWebserver\nDownloading ApacheWebserver cookbook version 0.1.0\nDownloading root_files\nDownloading test\nDownloading spec\nDownloading recipes\nCookbook downloaded to /home/vagrant/chef-repo/ApacheWebserver-0.1.0\n</code></pre> <p>When you are trying to download a cookbook that has multiple versions, it will prompt you to choose a specific version.</p> <p>In the following example, since \u201cApacheWebserver\u201d cookbook has multiple versions, it will display the following option, and you can choose one from the list.</p> <pre><code>$  sudo knife cookbook download ApacheWebserver\nWhich version do you want to download?\n1. ApacheWebserver 0.1.0\n2. ApacheWebserver 0.2.0\n</code></pre> <p>You can also pass the cookbook version number in the command-line as shown below, to directly download that particular version to your local machine.</p> <p>If you just want to download the latest version of a cookbook without having to specify a version number, use <code>-N</code> option (or <code>\u2013latest</code> option) as shown below.</p> <pre><code>$ sudo knife cookbook download ApacheWebserver -N\nDownloading ApacheWebserver cookbook version 0.2.0\nDownloading root_files\nDownloading test\nDownloading spec\nDownloading recipes\nCookbook downloaded to /home/vagrant/chef-repo/cookbooks/ApacheWebserver/ApacheWebserver-0.2.0\n</code></pre> <p>When a version of the cookbook that you are downloading has already been downloaded before, you\u2019ll get the following error message.</p> <pre><code>$ sudo knife cookbook download ApacheWebserver 0.2.0\nDownloading ApacheWebserver cookbook version 0.2.0\nFATAL: Directory /home/vagrant/chef-repo/cookbooks/ApacheWebserver/ApacheWebserver-0.2.0 exists, use --force to overwrite\n</code></pre> <p>In that case, use the <code>-f</code>option (or <code>\u2013force</code>) to download the cookbook and overwrite the local directory with the version that was downloaded from the Chef server.</p> <pre><code>knife cookbook download  ApacheWebserver  2.1.0 -f\n</code></pre> <p>Instead of downloading it under the current directory, you can also specify a download directory using <code>-d</code> option (or \u2013dir option).</p> <p>The following command will download \u201cApacheWebserver\u201d version 0.2.0 cookbook to <code>~/tmp/download</code> directory.</p> <pre><code>$ sudo knife cookbook download ApacheWebserver 0.2.0 -d ~/tmp/download/\nDownloading ApacheWebserver cookbook version 0.2.0\nDownloading root_files\nDownloading test\nDownloading spec\nDownloading recipes\nCookbook downloaded to /home/vagrant/tmp/download/ApacheWebserver-0.2.0\n\n$ ls -lt ~/tmp/download/\ntotal 0\ndrwxr-xr-x. 5 root root 171 Jan  4 07:17 ApacheWebserver-0.2.0\n</code></pre>"},{"location":"chap2/chef_adv2/#10-generate-cookbook-metadata","title":"10. Generate Cookbook Metadata","text":"<p>You can generate metadata file for your cookbook using \u201cknife cookbook metadata\u201d command as shown below. The following command will generate the <code>metadata.rb</code>for all the cookbooks.</p> <pre><code># knife cookbook metadata -a\nGenerating metadata for dev-cluster from /root/chef-repo/cookbooks/dev-cluster/metadata.rb\nGenerating metadata for dev-db from /root/chef-repo/cookbooks/dev-db/metadata.rb\nGenerating metadata for dev-web from /root/chef-repo/cookbooks/dev-web/metadata.rb\nGenerating metadata for thegeekstuff from /root/chef-repo/cookbooks/thegeekstuff/metadata.rb\n</code></pre> <p>If you want to generate metadata only for a specific cookbook, then specify the direct path of the metadata.rb file for that particular cookbook using the \u201cfrom file\u201d option as shown below.</p> <p>The following command will generate metadata for \u201cApacheWebserver\u201d cookbook using the given <code>metadata.rb</code> file.</p> <pre><code># knife cookbook metadata from file ~/chef-repo/cookbooks/thegeekstuff/metadata.rb \n\nGenerating metadata for thegeekstuff from /root/chef-repo/cookbooks/thegeekstuff/metadata.rb\n</code></pre>"},{"location":"chap2/chef_adv2/#11-view-cookbook-details","title":"11. View Cookbook Details","text":"<p>You can view the details of a cookbook using \u201c<code>knife cookbook show</code>\u201d command.</p> <p>When you don\u2019t specify a version number for a cookbook, the show command will display list of all the version numbers available for the given cookbook</p> <pre><code>$ knife cookbook show ApacheWebserver\nApacheWebserver   0.2.0  0.1.0\n</code></pre> <p>But when you specify a version number, this will display lot more information about the cookbook as shown below.</p> <pre><code>$ knife cookbook show ApacheWebserver 0.2.0\ncookbook_name: ApacheWebserver\nfrozen?:       false\nmetadata:\n  attributes:\n  chef_versions:\n    &gt;= 13.0\n  dependencies:\n  description:      Installs/Configures ApacheWebserver\n  gems:\n  issues_url:\n  license:          All Rights Reserved\n  long_description: Installs/Configures ApacheWebserver\n  maintainer:       The Authors\n  maintainer_email: you@example.com\n  name:             ApacheWebserver\n  ohai_versions:\n  platforms:\n  privacy:          false\n  providing:\n    ApacheWebserver:        &gt;= 0.0.0\n    ApacheWebserver::hello: &gt;= 0.0.0\n  recipes:\n    ApacheWebserver:\n    ApacheWebserver::hello:\n  source_url:\n  version:          0.2.0\nname:          ApacheWebserver-0.2.0\n...\n</code></pre> <p>The default output of the above command will display lot of information.</p> <p>You can also specify a section number to the show command as shown below, which will display only that particular section in the show command output.</p> <p>For example, the following will display only the \u201cattributes\u201d section from the <code>docker_custom.rb</code> file of \u201cthegeekstuff\u201d cookbook.</p> <pre><code>knife cookbook show thegeekstuff 1.2.0 attributes docker_custom.rb\n</code></pre> <p>The following show command will display only the \u201crecipies\u201d PART (section) from the given <code>.rb</code> file of the \u201c<code>thegeekstuff</code>\u201d cookbook.</p> <pre><code>knife cookbook show thegeekstuff 1.2.0 recipies deploy/testserver/tomcat_custom.rb\n</code></pre> <p>The following are the possible sections that you can pass as a parameter to the above show command.</p> <ul> <li>attributes</li> <li>definitions</li> <li>files</li> <li>libraries</li> <li>providers</li> <li>recipes</li> <li>resources</li> <li>templates</li> </ul> <p>Also, use <code>-F</code> option to specify a output format for the knife cookbook show command. The following will display the output of the show command in JSON format.</p> <p>To view information in JSON format, use the -F common option as part of the command like this:</p> <pre><code>$ knife cookbook show  ApacheWebserver  0.1.0 -F json\n{\n  \"cookbook_name\": \"ApacheWebserver\",\n  \"name\": \"ApacheWebserver-0.1.0\",\n  \"frozen?\": false,\n  \"metadata\": {\n    \"name\": \"ApacheWebserver\",\n    \"description\": \"Installs/Configures ApacheWebserver\",\n    \"long_description\": \"Installs/Configures ApacheWebserver\",\n    \"maintainer\": \"The Authors\",\n    \"maintainer_email\": \"you@example.com\",\n    \"license\": \"All Rights Reserved\",\n    \"platforms\": {\n\n    },\n    \"dependencies\": {\n\n    },\n...\n</code></pre> <p>The following are the available formats:</p> <ul> <li>json \u2013 for JSON format</li> <li>text \u2013 for plain text</li> <li>yaml \u2013 Standard YAML format</li> <li>pp \u2013 Post processing format</li> </ul>"},{"location":"chap2/chef_adv2/#12-validate-cookbook-syntax","title":"12. Validate Cookbook Syntax","text":"<p>The following \u201c<code>knife cookbook test</code>\u201d command will do a syntax check validation on the cookbook files.</p> <p>In the following example, we have an error in \u201cApacheWebserver\u201d cookbook. As you see in the last line, it says that the method \u201cauthor\u201d in the metadata.rb file is undefined and not recognized by Chef.</p> <pre><code>$ sudo knife cookbook test ApacheWebserver\nWARNING: DEPRECATED: Please use ChefSpec or Cookstyle to syntax-check cookbooks.\nchecking ApacheWebserver\nRunning syntax check on ApacheWebserver\nValidating ruby files\nValidating templates\n</code></pre> <p><code>$ cookstyle /path/to/cookbook</code></p> <pre><code>$ sudo cookstyle cookbooks/ApacheWebserver/\nInspecting 14 files\n.....CC.....CC\n\nOffenses:\n\ncookbooks/ApacheWebserver/recipes/default.rb:7:9: C: Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.\nservice \"httpd\" do\n        ^^^^^^^\ncookbooks/ApacheWebserver/recipes/default.rb:8:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        action [:enable, :start]\n^^^^^^^^\ncookbooks/ApacheWebserver/recipes/default.rb:12:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        content \"&lt;html&gt;&lt;body bgcolor='#D2D2D3'&gt;&lt;h1&gt;Hello World, This is my 1st cookbook recipe &lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\"\n^^^^^^^^\ncookbooks/ApacheWebserver/recipes/hello.rb:2:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        content \"&lt;html&gt;&lt;body&gt;Hello World, This is my first cookbook &lt;br/&gt; This is 2nd version &lt;/body&gt;&lt;/html&gt;\"\n^^^^^^^^\ncookbooks/ApacheWebserver/recipes/hello.rb:2:17: C: Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.\n        content \"&lt;html&gt;&lt;body&gt;Hello World, This is my first cookbook &lt;br/&gt; This is 2nd version &lt;/body&gt;&lt;/html&gt;\"\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\ncookbooks/ApacheWebserver/ApacheWebserver-0.2.0/recipes/default.rb:7:9: C: Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.\nservice \"httpd\" do\n        ^^^^^^^\ncookbooks/ApacheWebserver/ApacheWebserver-0.2.0/recipes/default.rb:8:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        action [:enable, :start]\n^^^^^^^^\ncookbooks/ApacheWebserver/ApacheWebserver-0.2.0/recipes/default.rb:12:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        content \"&lt;html&gt;&lt;body bgcolor='#D2D2D3'&gt;&lt;h1&gt;Hello World, This is my 1st cookbook recipe &lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\"\n^^^^^^^^\ncookbooks/ApacheWebserver/ApacheWebserver-0.2.0/recipes/hello.rb:2:1: C: Layout/IndentationWidth: Use 2 (not 8) spaces for indentation.\n        content \"&lt;html&gt;&lt;body&gt;Hello World, This is my first cookbook &lt;br/&gt; This is 2nd version &lt;/body&gt;&lt;/html&gt;\"\n^^^^^^^^\ncookbooks/ApacheWebserver/ApacheWebserver-0.2.0/recipes/hello.rb:2:17: C: Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.\n        content \"&lt;html&gt;&lt;body&gt;Hello World, This is my first cookbook &lt;br/&gt; This is 2nd version &lt;/body&gt;&lt;/html&gt;\"\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\n14 files inspected, 10 offenses detected\n</code></pre>"},{"location":"chap2/chef_adv3/","title":"\u7b2c\u516d\u8282 Chef Quick CheatSheet","text":""},{"location":"chap2/chef_adv3/#1common-terminology","title":"1\u3001Common Terminology","text":"<p>The following are some Chef terms that will be helpful to know before we start.</p> <p>Node: A managed machine. When the Chef client runs, it executes the configuration for a node.</p> <p>Client: An authorized user of the Chef API. In most cases, every machine you manage will be represented by: a) a client for logging into the API and b) a node configuration to apply. Administrators and the web interface are also clients.</p> <p>Cookbook: A collection of attributes, recipes, custom resources, and definitions to configure a certain application or service. For instance you will find shared cookbooks available on the web for NTP, Apache https, MySQL, nginx, and other common services.</p> <p>Recipe: A list of resources that should be applied to a node. Recipes are written in normal Ruby extended by the Chef resource domain-specific language. This gives you the power of anything you can do in Ruby (conditionals, using gems, etc.) while not having to be verbose in managing the resources that make up your configuration.</p>"},{"location":"chap2/chef_adv3/#1-1-knife","title":"1-1 Knife","text":"<p>Knife is the tool you will use as a system administrator to interact with the server most often, especially taking cookbooks and other custom configurations and loading them into the server for distribution to clients. You can also bootstrap new servers with the Chef client components, start new instances on the major cloud providers (AWS, Rackspace, SliceHost, and Terremark), and search for nodes or other data. Running knife --help will give you a list of supported commands.</p>"},{"location":"chap2/chef_adv3/#1-2-chef-client","title":"1-2 Chef Client","text":"<p>The Chef client runs on the servers you are managing. It gathers information about itself using Ohai, synchronizes the cookbooks it needs from the Chef server, compiles the collection of resources that make up the configuration, and then \u201cconverges\u201d the resources it has compiled with the state of the current machine</p>"},{"location":"chap2/chef_adv3/#1-3-serverapi","title":"1-3 Server/API","text":"<p>The Chef server sits at the center of the system. </p> <p>The Chef server exposes a RESTful API, which is used by the other components in the system. </p> <p>Your managed nodes, knife, and the web interface are all clients of the API. While you will probably not need to access the API directly, it is good to know that all of your data and more advanced automation are available using the API.</p>"},{"location":"chap2/chef_adv3/#2chef-development-kit-commands","title":"2\u3001Chef Development Kit commands","text":"<pre><code>$ chef ...\n\nUsage:\n    chef -h/--help\n    chef -v/--version\n    chef command [arguments...] [options...]\n\n\nAvailable Commands:\n    exec                    Runs the command in context of the embedded ruby\n    env                     Prints environment variables used by ChefDK\n    gem                     Runs the `gem` command in context of the embedded ruby\n    generate                Generate a new app, cookbook, or component\n    shell-init              Initialize your shell to use ChefDK as your primary ruby\n    install                 Install cookbooks from a Policyfile and generate a locked cookbook set\n    update                  Updates a Policyfile.lock.json with latest run_list and cookbooks\n    push                    Push a local policy lock to a policy group on the server\n    push-archive            Push a policy archive to a policy group on the server\n    show-policy             Show policyfile objects on your Chef Server\n    diff                    Generate an itemized diff of two Policyfile lock documents\n    provision               Provision VMs and clusters via cookbook\n    export                  Export a policy lock as a Chef Zero code repo\n    clean-policy-revisions  Delete unused policy revisions on the server\n    clean-policy-cookbooks  Delete unused policyfile cookbooks on the server\n    delete-policy-group     Delete a policy group on the server\n    delete-policy           Delete all revisions of a policy on the server\n    undelete                Undo a delete command\n</code></pre>"},{"location":"chap2/chef_adv3/#3chef-server-commands","title":"3\u3001Chef Server commands","text":"<pre><code>$ chef-system-ctl ...\n\nchef-server-ctl: command (subcommand)\nGeneral Commands:\n  backup\n    Backup the Chef Server\n  cleanse\n    Delete *all* Chef Server data, and start from scratch.\n  cleanup\n    Perform post-upgrade removal of now-obsolete data, configuration files, logs, etc.  Add the '--no-op' flag to see what *would* be removed.\n  gather-logs\n    Create a tarball of recent logs and system information for Chef Support\n  help\n    Print this help message.\n  install\n    Install addon package by name, with optional --path parameter indicating directory containing packages\n  reconfigure\n    Reconfigure the application.\n  reindex\n    Reindex all server data for a given organization\n  restore\n    Restore the Chef Server from backup\n  show-config\n    Show the configuration that would be generated by reconfigure.\n  test\n    Run the API test suite against localhost.\n  uninstall\n    Kill all processes and uninstall the process supervisor (data will be preserved).\n  upgrade\n    Upgrade your private chef installation.\nService Management Commands:\n  graceful-kill\n    Attempt a graceful stop, then SIGKILL the entire process group.\n  hup\n    Send the services a HUP.\n  int\n    Send the services an INT.\n  kill\n    Send the services a KILL.\n  once\n    Start the services if they are down. Do not restart them if they stop.\n  restart\n    Stop the services if they are running, then start them again.\n  service-list\n    List all the services (enabled services appear with a *.)\n  start\n    Start services if they are down, and restart them if they stop.\n  status\n    Show the status of all the services.\n  stop\n    Stop the services, and do not restart them.\n  tail\n    Watch the service logs of all enabled services.\n  term\n    Send the services a TERM.\n  usr1\n    Send the services a USR1.\n  usr2\n    Send the services a USR2.\nOrganization And User Management Commands:\n  org-create\n    Create an organization in the chef server.\n  org-delete\n    Delete an organization in the chef server.\n  org-list\n    List all organizations in the chef server.\n  org-show\n    Show an organization in the chef server.\n  org-user-add\n    Associate a user with an organization.\n  org-user-remove\n    Dissociate a user with an organization.\n  password\n    Set a user's password or System Recovery Password.\n  user-create\n    Create a user in the chef server.\n  user-delete\n    Delete a user in the chef server.\n  user-edit\n    Edit a user in the chef server.\n  user-list\n    List all users in the chef server.\n  user-show\n    Show a user in the chef server.\nHigh Availability Commands:\n  backup-recover\n    Set this server to HA backup state, ignoring VRRP\n  ha-status\n    Show the status of high availability services.\n  master-recover\n    Set this server to HA master state, ignoring VRRP.\nOpen Source Upgrade Commands:\n  chef12-upgrade-data-transform\n    Transfrom data from an open source Chef 11 server for upload to an Chef 12 server.\n  chef12-upgrade-download\n    Download data from a open source Chef 11 server.\n  chef12-upgrade-upload\n    Upload transformed open source Chef 11 data to a Chef 12 server.\nSecrets Management Commands:\n  oc-id-show-app\n    Show configuration for oc-id applications\n  remove-secret\n    Remove secret NAME of GROUP\n  require-credential-rotation\n    Disable the Chef Server and require credential rotation\n  rotate-all-credentials\n    Rotate all Chef Server service credentials\n  rotate-credentials\n    Rotate Chef Server credentials for a given service\n  rotate-shared-secrets\n    Rotate the Chef Server shared secrets and all service credentials\n  set-actions-password\n    Add or change the rabbitmq actions queue password\n  set-db-superuser-password\n    Add or change DB superuser password\n  set-secret\n    Set or change secret NAME of GROUP\n  show-secret\n    Show the value of the given secret in the secret store\n  show-service-credentials\n    Show the service credentials\nDebug Tools Commands:\n  filtered-dump\n    Generate a filtered dump of indexable Chef Objects for all organizations.  Top-level data is captured; only object name is captured from object json\nKey Rotation Commands:\n  add-client-key\n    Create a new client key\n  add-user-key\n    Create a new user key\n  delete-client-key\n    Delete a key\n  delete-user-key\n    Delete a key\n  list-client-keys\n    List keys for a client\n  list-user-keys\n    List keys for a user\nServer Admins Commands:\n  grant-server-admin-permissions\n    Grant a user the ability to create other users by added the user to the server-admins group.\n  list-server-admins\n    List users that have server-admins permissions.\n  remove-server-admin-permissions\n    Remove all special permission granted to a user from being a server-admin.\nDatabase Commands:\n  psql\n    Launches an interactive psql session with the service database you name. Add '--write' for write access and '--options &lt;OPTIONS&gt;' to specify psql options.\n</code></pre>"},{"location":"chap2/chef_adv3/#4chef-client-commands","title":"4\u3001Chef Client commands","text":"<pre><code>$ chef-client ...\n\nUsage: /opt/chefdk/bin/chef-client (options)\n        --audit-mode MODE            Enable audit-mode with `enabled`. Disable audit-mode with `disabled`. Skip converge and only perform audits with `audit-only`\n    -S, --server CHEFSERVERURL       The chef server URL\n        --chef-zero-host HOST        Host to start chef-zero on\n        --chef-zero-port PORT        Port (or port range) to start chef-zero on.  Port ranges like 1000,1010 or 8889-9999 will try all given ports until one works.\n    -f, --[no-]fork                  Fork client\n    -k, --client_key KEY_FILE        Set the client key file location\n        --[no-]color                 Use colored output, defaults to enabled\n    -c, --config CONFIG              The configuration file to use\n        --config-option OPTION=VALUE Override a single configuration option\n    -d, --daemonize [WAIT]           Daemonize the process. Accepts an optional integer which is the number of seconds to wait before the first daemonized run.\n        --delete-entire-chef-repo    DANGEROUS: does what it says, only useful with --recipe-url\n        --disable-config             Refuse to load a config file and use defaults. This is for development and not a stable API\n    -R, --enable-reporting           Enable reporting data collection for chef runs\n    -E, --environment ENVIRONMENT    Set the Chef Environment on the node\n        --[no-]fips                  Enable fips mode\n        --force-formatter            Use formatter output instead of logger output\n        --force-logger               Use logger output instead of formatter output\n    -F, --format FORMATTER           output format to use\n    -g, --group GROUP                Group to set privilege to\n    -i, --interval SECONDS           Run chef-client periodically, in seconds\n    -j JSON_ATTRIBS,                 Load attributes from a JSON file or URL\n        --json-attributes\n        --[no-]listen                Whether a local mode (-z) server binds to a port\n    -z, --local-mode                 Point chef-client at local repository\n        --lockfile LOCKFILE          Set the lockfile location. Prevents multiple client processes from converging at the same time\n    -l, --log_level LEVEL            Set the log level (auto, debug, info, warn, error, fatal)\n    -L, --logfile LOGLOCATION        Set the log file location, defaults to STDOUT - recommended for daemonizing\n        --minimal-ohai               Only run the bare minimum ohai plugins chef needs to function\n    -n NAMED_RUN_LIST,               Use a policyfile's named run list instead of the default run list\n        --named-run-list\n    -N, --node-name NODE_NAME        The node name for this client\n        --once                       Cancel any interval or splay options, run chef once and exit\n    -o RunlistItem,RunlistItem...,   Replace current run list with specified items for a single run\n        --override-runlist\n    -P, --pid PIDFILE                Set the PID file location, for the chef-client daemon process. Defaults to /tmp/chef-client.pid\n        --[no-]profile-ruby          Dump complete Ruby call graph stack of entire Chef run (expert only)\n        --recipe-url=RECIPE_URL      Pull down a remote archive of recipes and unpack it to the cookbook cache. Only used in local mode.\n        --run-lock-timeout SECONDS   Set maximum duration to wait for another client run to finish, default is indefinitely.\n    -r RunlistItem,RunlistItem...,   Permanently replace current run list with specified items\n        --runlist\n        --[no-]skip-cookbook-sync    Use cached cookbooks without overwriting local differences from the server\n    -s, --splay SECONDS              The splay time for running at intervals, in seconds\n    -u, --user USER                  User to set privilege to\n    -K, --validation_key KEY_FILE    Set the validation key file location, used for registering new clients\n    -v, --version                    Show chef version\n    -W, --why-run                    Enable whyrun mode\n    -h, --help                       Show this message\n</code></pre>"},{"location":"chap2/chef_adv3/#5chef-solo-commands","title":"5\u3001Chef Solo commands","text":"<pre><code>Usage: /opt/chefdk/bin/chef-solo (options)\n    -f, --[no-]fork                  Fork client\n        --[no-]color                 Use colored output, defaults to enabled\n    -c, --config CONFIG              The configuration file to use\n        --config-option OPTION=VALUE Override a single configuration option\n    -d, --daemonize                  Daemonize the process\n        --delete-entire-chef-repo    DANGEROUS: does what it says, only useful with --recipe-url\n    -E, --environment ENVIRONMENT    Set the Chef Environment on the node\n        --ez                         A memorial for Ezra Zygmuntowicz\n        --force-formatter            Use formatter output instead of logger output\n        --force-logger               Use logger output instead of formatter output\n    -F, --format FORMATTER           output format to use\n    -g, --group GROUP                Group to set privilege to\n    -i, --interval SECONDS           Run chef-client periodically, in seconds\n    -j JSON_ATTRIBS,                 Load attributes from a JSON file or URL\n        --json-attributes\n        --lockfile LOCKFILE          Set the lockfile location. Prevents multiple processes from converging at the same time\n    -l, --log_level LEVEL            Set the log level (debug, info, warn, error, fatal)\n    -L, --logfile LOGLOCATION        Set the log file location, defaults to STDOUT\n        --minimal-ohai               Only run the bare minimum ohai plugins chef needs to function\n    -N, --node-name NODE_NAME        The node name for this client\n    -o RunlistItem,RunlistItem...,   Replace current run list with specified items\n        --override-runlist\n        --[no-]profile-ruby          Dump complete Ruby call graph stack of entire Chef run (expert only)\n    -r, --recipe-url RECIPE_URL      Pull down a remote gzipped tarball of recipes and untar it to the cookbook cache.\n        --run-lock-timeout SECONDS   Set maximum duration to wait for another client run to finish, default is indefinitely.\n        --legacy-mode                Run chef-solo in legacy mode\n    -s, --splay SECONDS              The splay time for running at intervals, in seconds\n    -u, --user USER                  User to set privilege to\n    -v, --version                    Show chef version\n    -W, --why-run                    Enable whyrun mode\n    -h, --help                       Show this message\n</code></pre>"},{"location":"chap2/chef_adv3/#6knife-commands","title":"6\u3001Knife commands","text":"<p>knife cheatsheet</p> <pre><code>$ knife ...\n\nUsage: knife sub-command (options)\n    -s, --server-url URL             Chef Server URL\n        --chef-zero-host HOST        Host to start chef-zero on\n        --chef-zero-port PORT        Port (or port range) to start chef-zero on.  Port ranges like 1000,1010 or 8889-9999 will try all given ports until one works.\n    -k, --key KEY                    API Client Key\n        --[no-]color                 Use colored output, defaults to enabled\n    -c, --config CONFIG              The configuration file to use\n        --config-option OPTION=VALUE Override a single configuration option\n        --defaults                   Accept default values for all questions\n    -d, --disable-editing            Do not open EDITOR, just accept the data as is\n    -e, --editor EDITOR              Set the editor to use for interactive commands\n    -E, --environment ENVIRONMENT    Set the Chef environment (except for in searches, where this will be flagrantly ignored)\n        --[no-]fips                  Enable fips mode\n    -F, --format FORMAT              Which format to use for output\n        --[no-]listen                Whether a local mode (-z) server binds to a port\n    -z, --local-mode                 Point knife commands at local repository instead of server\n    -u, --user USER                  API Client Username\n        --print-after                Show the data after a destructive operation\n    -V, --verbose                    More verbose output. Use twice for max verbosity\n    -v, --version                    Show chef version\n    -y, --yes                        Say yes to all prompts for confirmation\n    -h, --help                       Show this message\n\nAvailable subcommands: (for details, knife SUB-COMMAND --help)\n\n** OPSCODE PRIVATE CHEF ORGANIZATION MANAGEMENT COMMANDS **\nknife opc org create ORG_SHORT_NAME ORG_FULL_NAME (options)\nknife opc org delete ORG_NAME\nknife opc org edit ORG\nknife opc org list\nknife opc org show ORGNAME\nknife opc org user add ORG_NAME USER_NAME\nknife opc org user remove ORG_NAME USER_NAME\nknife opc user create USERNAME FIRST_NAME [MIDDLE_NAME] LAST_NAME EMAIL PASSWORD\nknife opc user delete USERNAME [-d]\nknife opc user edit USERNAME\nknife opc user list\nknife opc user password USERNAME [PASSWORD | --enable-external-auth]\nknife opc user show USERNAME\n\n** BOOTSTRAP COMMANDS **\nknife bootstrap [SSH_USER@]FQDN (options)\nknife bootstrap windows ssh FQDN (options)\nknife bootstrap windows winrm FQDN (options)\n\n** CLIENT COMMANDS **\nknife client bulk delete REGEX (options)\nknife client create CLIENTNAME (options)\nknife client delete [CLIENT[,CLIENT]] (options)\nknife client edit CLIENT (options)\nknife client key create CLIENT (options)\nknife client key delete CLIENT KEYNAME (options)\nknife client key edit CLIENT KEYNAME (options)\nknife client key list CLIENT (options)\nknife client key show CLIENT KEYNAME (options)\nknife client list (options)\nknife client reregister CLIENT (options)\nknife client show CLIENT (options)\n\n** CONFIGURE COMMANDS **\nknife configure (options)\nknife configure client DIRECTORY\n\n** COOKBOOK COMMANDS **\nknife cookbook bulk delete REGEX (options)\nUsage: /opt/chefdk/bin/knife (options)\nknife cookbook delete COOKBOOK VERSION (options)\nknife cookbook download COOKBOOK [VERSION] (options)\nknife cookbook list (options)\nknife cookbook metadata COOKBOOK (options)\nknife cookbook metadata from FILE (options)\nknife cookbook show COOKBOOK [VERSION] [PART] [FILENAME] (options)\nknife cookbook test [COOKBOOKS...] (options)\nknife cookbook upload [COOKBOOKS...] (options)\n\n** COOKBOOK SITE COMMANDS **\nknife cookbook site download COOKBOOK [VERSION] (options)\nknife cookbook site install COOKBOOK [VERSION] (options)\nknife cookbook site list (options)\nknife cookbook site search QUERY (options)\nknife cookbook site share COOKBOOK [CATEGORY] (options)\nknife cookbook site show COOKBOOK [VERSION] (options)\nknife cookbook site unshare COOKBOOK\n\n** DATA BAG COMMANDS **\nknife data bag create BAG [ITEM] (options)\nknife data bag delete BAG [ITEM] (options)\nknife data bag edit BAG ITEM (options)\nknife data bag from file BAG FILE|FOLDER [FILE|FOLDER..] (options)\nknife data bag list (options)\nknife data bag show BAG [ITEM] (options)\n\n** EC2 COMMANDS **\nknife ec2 amis ubuntu DISTRO [TYPE] (options)\n\n** ENVIRONMENT COMMANDS **\nknife environment compare [ENVIRONMENT..] (options)\nknife environment create ENVIRONMENT (options)\nknife environment delete ENVIRONMENT (options)\nknife environment edit ENVIRONMENT (options)\nknife environment from file FILE [FILE..] (options)\nknife environment list (options)\nknife environment show ENVIRONMENT (options)\n\n** EXEC COMMANDS **\nknife exec [SCRIPT] (options)\n\n** HELP COMMANDS **\nknife help [list|TOPIC]\n\n** INDEX COMMANDS **\nknife index rebuild (options)\n\n** JOB COMMANDS **\nknife job list\nknife job output &lt;job id&gt; &lt;node&gt; [&lt;node&gt; ...]\nknife job start &lt;command&gt; [&lt;node&gt; &lt;node&gt; ...]\nknife job status &lt;job id&gt;\n\n** KNIFE COMMANDS **\nUsage: /opt/chefdk/bin/knife (options)\n\n** NODE COMMANDS **\nknife node bulk delete REGEX (options)\nknife node create NODE (options)\nknife node delete [NODE[,NODE]] (options)\nknife node edit NODE (options)\nknife node environment set NODE ENVIRONMENT\nknife node from file FILE (options)\nknife node list (options)\nknife node run_list add [NODE] [ENTRY[,ENTRY]] (options)\nknife node run_list remove [NODE] [ENTRY[,ENTRY]] (options)\nknife node run_list set NODE ENTRIES (options)\nknife node show NODE (options)\nknife node status [&lt;node&gt; &lt;node&gt; ...]\n\n** NULL COMMANDS **\nknife null\n\n** OSC COMMANDS **\nknife osc_user create USER (options)\nknife osc_user delete USER (options)\nknife osc_user edit USER (options)\nknife osc_user list (options)\nknife osc_user reregister USER (options)\nknife osc_user show USER (options)\n\n** PATH-BASED COMMANDS **\nknife delete [PATTERN1 ... PATTERNn]\nknife deps PATTERN1 [PATTERNn]\nknife diff PATTERNS\nknife download PATTERNS\nknife edit [PATTERN1 ... PATTERNn]\nknife list [-dfR1p] [PATTERN1 ... PATTERNn]\nknife show [PATTERN1 ... PATTERNn]\nknife upload PATTERNS\nknife xargs [COMMAND]\n\n** RAW COMMANDS **\nknife raw REQUEST_PATH\n\n** RECIPE COMMANDS **\nknife recipe list [PATTERN]\n\n** REHASH COMMANDS **\nknife rehash\n\n** ROLE COMMANDS **\nknife role bulk delete REGEX (options)\nknife role create ROLE (options)\nknife role delete ROLE (options)\nknife role edit ROLE (options)\nknife role env_run_list add [ROLE] [ENVIRONMENT] [ENTRY[,ENTRY]] (options)\nknife role env_run_list clear [ROLE] [ENVIRONMENT]\nknife role env_run_list remove [ROLE] [ENVIRONMENT] [ENTRIES]\nknife role env_run_list replace [ROLE] [ENVIRONMENT] [OLD_ENTRY] [NEW_ENTRY]\nknife role env_run_list set [ROLE] [ENVIRONMENT] [ENTRIES]\nknife role from file FILE [FILE..] (options)\nknife role list (options)\nknife role run_list add [ROLE] [ENTRY[,ENTRY]] (options)\nknife role run_list clear [ROLE]\nknife role run_list remove [ROLE] [ENTRY]\nknife role run_list replace [ROLE] [OLD_ENTRY] [NEW_ENTRY]\nknife role run_list set [ROLE] [ENTRIES]\nknife role show ROLE (options)\n\n** SEARCH COMMANDS **\nknife search INDEX QUERY (options)\n\n** SERVE COMMANDS **\nknife serve (options)\n\n** SPORK COMMANDS **\nknife spork bump COOKBOOK [major|minor|patch|manual]\nknife spork check COOKBOOK (options)\nknife spork data bag create BAG [ITEM] (options)\nknife spork data bag delete BAG [ITEM] (options)\nknife spork data bag edit BAG ITEM (options)\nknife spork data bag from file BAG FILE|FOLDER [FILE|FOLDER..] (options)\nknife spork delete [COOKBOOKS...] (options)\nknife spork environment check ENVIRONMENT (options)\nknife spork environment create ENVIRONMENT (options)\nknife spork environment delete ENVIRONMENT (options)\nknife spork environment edit ENVIRONMENT (options)\nknife spork environment from file FILENAME (options)\nknife spork info\nknife spork node create NODE (options)\nknife spork node delete NODE (options)\nknife spork node edit NODE (options)\nknife spork node from file FILE (options)\nknife spork node run_list add [NODE] [ENTRY[,ENTRY]] (options)\nknife spork node run_list add [NODE] [ENTRY[,ENTRY]] (options)\nknife spork node run_list set NODE ENTRIES (options)\nknife spork omni COOKBOOK (options)\nknife spork promote ENVIRONMENT COOKBOOK (options)\nknife spork role create ROLE (options)\nknife spork role delete ROLENAME (options)\nknife spork role edit ROLENAME (options)\nknife spork role from file FILENAME (options)\nknife spork upload [COOKBOOKS...] (options)\n\n** SSH COMMANDS **\nknife ssh QUERY COMMAND (options)\n\n** SSL COMMANDS **\nknife ssl check [URL] (options)\nknife ssl fetch [URL] (options)\n\n** STATUS COMMANDS **\nknife status QUERY (options)\n\n** SUPERMARKET COMMANDS **\nknife supermarket download COOKBOOK [VERSION] (options)\nknife supermarket install COOKBOOK [VERSION] (options)\nknife supermarket list (options)\nknife supermarket search QUERY (options)\nknife supermarket share COOKBOOK [CATEGORY] (options)\nknife supermarket show COOKBOOK [VERSION] (options)\nknife supermarket unshare COOKBOOK (options)\n\n** TAG COMMANDS **\nknife tag create NODE TAG ...\nknife tag delete NODE TAG ...\nknife tag list NODE\n\n** USER COMMANDS **\nknife user create USERNAME DISPLAY_NAME FIRST_NAME LAST_NAME EMAIL PASSWORD (options)\nknife user delete USER (options)\nknife user edit USER (options)\nknife user key create USER (options)\nknife user key delete USER KEYNAME (options)\nknife user key edit USER KEYNAME (options)\nknife user key list USER (options)\nknife user key show USER KEYNAME (options)\nknife user list (options)\nknife user reregister USER (options)\nknife user show USER (options)\n\n** VAULT COMMANDS **\nknife vault create VAULT ITEM VALUES (options)\nknife vault delete VAULT ITEM (options)\nknife vault download VAULT ITEM PATH (options)\nknife vault edit VAULT ITEM (options)\nknife vault isvault VAULT ITEM (options)\nknife vault itemtype VAULT ITEM (options)\nknife vault list (options)\nknife vault refresh VAULT ITEM\nknife vault remove VAULT ITEM VALUES (options)\nknife vault rotate all keys\nknife vault rotate keys VAULT ITEM (options)\nknife vault show VAULT [ITEM] [VALUES] (options)\nknife vault update VAULT ITEM VALUES (options)\n\n** WINDOWS COMMANDS **\nknife windows cert generate FILE_PATH (options)\nknife windows cert install CERT [CERT] (options)\nknife bootstrap windows winrm FQDN (options)\nknife bootstrap windows ssh FQDN (options)\nknife winrm QUERY COMMAND (options)\nknife wsman test QUERY (options)\nknife windows listener create (options)\n\n** WINRM COMMANDS **\nknife winrm QUERY COMMAND (options)\n\n** WSMAN COMMANDS **\nknife wsman test QUERY (options)\n</code></pre>"},{"location":"chap2/chef_adv3/#7kitchen-commands","title":"7\u3001Kitchen Commands","text":"<pre><code>$ kitchen ...\n\nCommands:\n  kitchen console                                 # Kitchen Console!\n  kitchen converge [INSTANCE|REGEXP|all]          # Change instance state to converge. Use a provisioner to configure one or more instances\n  kitchen create [INSTANCE|REGEXP|all]            # Change instance state to create. Start one or more instances\n  kitchen destroy [INSTANCE|REGEXP|all]           # Change instance state to destroy. Delete all information for one or more instances\n  kitchen diagnose [INSTANCE|REGEXP|all]          # Show computed diagnostic configuration\n  kitchen driver                                  # Driver subcommands\n  kitchen driver create [NAME]                    # Create a new Kitchen Driver gem project\n  kitchen driver discover                         # Discover Test Kitchen drivers published on RubyGems\n  kitchen driver help [COMMAND]                   # Describe subcommands or one specific subcommand\n  kitchen exec INSTANCE|REGEXP -c REMOTE_COMMAND  # Execute command on one or more instance\n  kitchen help [COMMAND]                          # Describe available commands or one specific command\n  kitchen init                                    # Adds some configuration to your cookbook so Kitchen can rock\n  kitchen list [INSTANCE|REGEXP|all]              # Lists one or more instances\n  kitchen login INSTANCE|REGEXP                   # Log in to one instance\n  kitchen package INSTANCE|REGEXP                 # package an instance\n  kitchen setup [INSTANCE|REGEXP|all]             # Change instance state to setup. Prepare to run automated tests. Install busser and related gems on one or more instances\n  kitchen test [INSTANCE|REGEXP|all]              # Test (destroy, create, converge, setup, verify and destroy) one or more instances\n  kitchen verify [INSTANCE|REGEXP|all]            # Change instance state to verify. Run automated tests on one or more instances\n  kitchen version                                 # Print Kitchen's version information\n</code></pre>"},{"location":"chap2/chef_adv3/#8inspec-commands","title":"8\u3001Inspec commands","text":"<pre><code>$ inspec ...\n\nCommands:\n  inspec archive PATH                # archive a profile to tar.gz (default) or zip\n  inspec artifact SUBCOMMAND ...     # Sign, verify and install artifacts\n  inspec check PATH                  # verify all tests at the specified PATH\n  inspec compliance SUBCOMMAND ...   # Chef Compliance commands\n  inspec detect                      # detect the target OS\n  inspec env                         # Output shell-appropriate completion configuration\n  inspec exec PATHS                  # run all test files at the specified PATH.\n  inspec habitat SUBCOMMAND ...      # Commands for InSpec + Habitat Integration\n  inspec help [COMMAND]              # Describe available commands or one specific command\n  inspec init TEMPLATE ...           # Scaffolds a new project\n  inspec json PATH                   # read all tests in PATH and generate a JSON summary\n  inspec shell                       # open an interactive debugging shell\n  inspec supermarket SUBCOMMAND ...  # Supermarket commands\n  inspec vendor PATH                 # Download all dependencies and generate a lockfile in a `vendor` directory\n  inspec version                     # prints the version of this tool\n\nOptions:\n  l, [--log-level=LOG_LEVEL]         # Set the log level: info (default), debug, warn, error\n      [--log-location=LOG_LOCATION]  # Location to send diagnostic log messages to. (default: STDOUT or STDERR)\n      [--diagnose], [--no-diagnose]  # Show diagnostics (versions, configurations)\n</code></pre>"},{"location":"chap2/chef_adv4/","title":"\u7b2c\u4e00\u8282 Chef Roles","text":"<p>A role is a way to define certain patterns and processes that exist across nodes in an organization as belonging to a single job function. </p> <ul> <li>Each role consists of zero (or more) attributes and a run-list. </li> <li>Each node can have zero (or more) roles assigned to it. </li> </ul>"},{"location":"chap2/chef_adv4/#1why-chef-roles","title":"1\u3001Why Chef roles","text":"<p>Every organizations has serves to to specific things, some server act as database servers, some server act as load balancer, some servers act as HTTP server. Servers act differently and how you define what you do.</p> <p>Chef server does you define the role for that server, the definition for a server role is definition that you use a role for your server </p> <p>Servers can have multiple roles depending on where they're at, for example you may have different environments where you know work as an HTTP server at a development environment but maybe an actual database server at a production or a test environment, so you define what your server does or what role of your server</p>"},{"location":"chap2/chef_adv4/#2role-attributes","title":"2\u3001Role Attributes","text":"<p>At the beginning of a <code>chef-client</code> run, all attributes except for normal attributes are reset. </p> <p>The chef-client rebuilds them using automatic attributes collected by Ohai at the beginning of the chef-client run and then using default and override attributes that are specified in cookbooks or by roles and environments. </p> <p>All attributes are then merged and applied to the node according to attribute precedence. At the conclusion of the chef-client run, the attributes that were applied to the node are saved to the Chef server as part of the node object.</p>"},{"location":"chap2/chef_adv4/#2-1-for-example","title":"2-1 For example","text":"<p>A role called webserver and defined by JSON file</p> <pre><code>{\n  \"name\": \"webserver\",\n  \"default_attributes\" : {\n     \"greeting\" : \"My greeting\"\n  }  \n},\n\"run_list\": [\n  \"receipe[apache]\"\n]\n}\n\n</code></pre> <p>Here we create a role which name is webserver, we set a default Apache attribute, and we set a run list in this specific role and run it, it does apply the apache cookbook to the chef client</p> <pre><code>$ knife role from file webserver.json\nUpdate Role Websrver\n</code></pre> <pre><code>$ knife node show nodename\n...\n</code></pre> <pre><code>$ knife node run list remove nodename 'recipe[apache]'\n\n</code></pre> <pre><code>$ knife node run list add nodename 'role[webserver']\n</code></pre>"},{"location":"chap2/chef_adv4/#3role-formats","title":"3\u3001Role Formats","text":"<p>Role data is stored in two formats: as a Ruby file that contains domain-specific language and as JSON data.</p>"},{"location":"chap2/chef_adv4/#3-1-ruby-dsl","title":"3-1 Ruby DSL","text":"<p>A Ruby DSL file for each role must exist in the <code>roles/</code> subdirectory of the chef-repo. (If the repository does not have this subdirectory, then create it using knife.) Each Ruby file should have the <code>.rb</code> suffix. </p> <p>The complete roles Ruby DSL has the following syntax:</p> <pre><code>name \"role_name\"\ndescription \"role_description\"\nrun_list \"recipe[name]\", \"recipe[name::attribute]\", \"recipe[name::attribute]\"\nenv_run_lists \"name\" =&gt; [\"recipe[name]\"], \"environment_name\" =&gt; [\"recipe[name::attribute]\"]\ndefault_attributes \"node\" =&gt; { \"attribute\" =&gt; [ \"value\", \"value\", \"etc.\" ] }\noverride_attributes \"node\" =&gt; { \"attribute\" =&gt; [ \"value\", \"value\", \"etc.\" ] }\n</code></pre> <ul> <li><code>run_list</code>: A list of recipes and/or roles to be applied and the order in which they are to be applied</li> <li><code>env_run_lists</code>   : Optional. A list of environments, each specifying a recipe or a role to be applied to that environment. </li> </ul> <pre><code>env_run_lists 'prod' =&gt; ['recipe[apache2]'],\n              'staging' =&gt; ['recipe[apache2::staging]'\n</code></pre> <ul> <li><code>default_attributes</code>: Optional. A set of attributes to be applied to all nodes, assuming the node does not already have a value for the attribute. This is useful for setting global defaults that can then be overridden for specific nodes</li> </ul> <pre><code>default_attributes 'apache2' =&gt; {\n  'listen_ports' =&gt; [ '80', '443' ]\n}\n</code></pre> <ul> <li><code>override_attributes</code>\uff1a Optional. A set of attributes to be applied to all nodes, even if the node already has a value for an attribute. This is useful for ensuring that certain attributes always have specific values. If more than one role attempts to set an override value for the same attribute, the last role applied wins</li> </ul> <pre><code>override_attributes(\n  :apache2 =&gt; {\n    :prefork =&gt; { :min_spareservers =&gt; '5' }\n  },\n  :tomcat =&gt; {\n    :worker_threads =&gt; '100'\n  }\n)\n</code></pre>"},{"location":"chap2/chef_adv4/#3-2-json","title":"3-2 JSON","text":"<p>The JSON format for roles maps directly to the domain-specific Ruby format: same settings, attributes, and values, and a similar structure and organization. For example</p> <pre><code>{\n  \"name\": \"webserver\",\n  \"chef_type\": \"role\",\n  \"json_class\": \"Chef::Role\",\n  \"default_attributes\": {\n    \"apache2\": {\n      \"listen_ports\": [\n        \"80\",\n        \"443\"\n      ]\n    }\n  },\n  \"description\": \"The base role for systems that serve HTTP traffic\",\n  \"run_list\": [\n    \"recipe[apache2]\",\n    \"recipe[apache2::mod_ssl]\",\n    \"role[monitor]\"\n  ],\n  \"env_run_lists\" : {\n    \"production\" : [],\n    \"preprod\" : [],\n    \"dev\": [\n      \"role[base]\",\n      \"recipe[apache]\",\n      \"recipe[apache::copy_dev_configs]\",\n    ],\n    \"test\": [\n      \"role[base]\",\n      \"recipe[apache]\"\n    ]\n  },\n  \"override_attributes\": {\n    \"apache2\": {\n      \"max_children\": \"50\"\n    }\n  }\n}\n</code></pre>"},{"location":"chap2/chef_adv4/#4manage-roles","title":"4\u3001Manage Roles","text":"<ul> <li>knife can be used to create, edit, view, list, tag, and delete roles.</li> <li>The Chef management console add-on can be used to create, edit, view, list, tag, and delete roles. In addition, role attributes can be modified and roles can be moved between environments.</li> </ul> <pre><code>knife search node \"role:role_name AND learn_client_id:learn_client_id\" -a run_list -c \u201c/root/chef/client-ip-knife.rb\n</code></pre>"},{"location":"chap2/chef_adv5/","title":"\u7b2c\u4e8c\u8282 Cookbook Versioning","text":"<p>A cookbook version represents a set of functionality that is different from the cookbook on which it is based. </p> <p>A version may exist for many reasons, such as ensuring the correct use of a third-party component, updating a bug fix, or adding an improvement.</p> <p>A cookbook version is defined using syntax and operators, may be associated with environments, cookbook metadata, and/or run-lists, and may be frozen (to prevent unwanted updates from being made).</p> <p>A cookbook version is maintained just like a cookbook, with regard to source control, uploading it to the Chef server, and how the chef-client applies that cookbook when configuring nodes.</p>"},{"location":"chap2/chef_adv5/#1syntax","title":"1\u3001Syntax","text":"<p>A cookbook version always takes the form <code>x.y.z</code>, where x, y, and z are decimal numbers that are used to represent <code>major (x)</code>, <code>minor (y)</code>, and <code>patch (z)</code> versions. A two-part version (x.y) is also allowed. Alphanumeric version numbers (1.2.a3) and version numbers with more than three parts (1.2.3.4) are not allowed.</p>"},{"location":"chap2/chef_adv5/#2constraints","title":"2\u3001Constraints","text":"<pre><code>operator cookbook_version_syntax\n</code></pre> Operator Description <code>=</code> equal to <code>&gt;</code> greater than <code>&lt;</code> less than <code>&gt;=</code> greater than or equal to; also known as \u201coptimistically greater than\u201d, or \u201coptimistic\u201d <code>&lt;=</code> less than or equal to <code>~&gt;</code> approximately greater than; also known as \u201cpessimistically greater than\u201d, or \u201cpessimistic\u201d <p>For example, a version constraint for \u201cequals version 1.0.7\u201d is expressed like this:</p> <pre><code>= 1.0.7\n</code></pre> <p>A version constraint for \u201cgreater than version 1.0.2\u201d is expressed like this:</p> <pre><code>&gt; 1.0.2\n</code></pre> <p>An optimistic version constraint is one that looks for versions greater than or equal to the specified version. For example:</p> <pre><code>&gt;= 2.6.5\n</code></pre> <p>will match cookbooks greater than or equal to 2.6.5, such as 2.6.5, 2.6.7 or 3.1.1.</p> <p>A pessimistic version constraint is one that will find the upper limit version number within the range specified by the minor version number or patch version number. For example, a pessimistic version constraint for minor version numbers:</p> <pre><code>~&gt; 2.6\n</code></pre> <p>will match cookbooks that are greater than or equal to version 2.6, but less than version 3.0.</p> <p>Or, a pessimistic version constraint for patch version numbers:</p> <pre><code>~&gt; 2.6.5\n</code></pre> <p>will match cookbooks that are greater than or equal to version 2.6.5, but less than version 2.7.0.</p> <p>Or, a pessimistic version constraint that matches cookbooks less than a version number:</p> <pre><code>&lt; 2.3.4\n</code></pre> <p>or will match cookbooks less than or equal to a specific version number:</p> <pre><code>&lt;= 2.6.5\n</code></pre>"},{"location":"chap2/chef_adv5/#3metadata","title":"3\u3001Metadata","text":"<p>Every cookbook requires a small amount of metadata. A file named <code>metadata.rb</code> is located at the top of every cookbook directory structure. The contents of the <code>metadata.rb</code> file provides information that helps Chef Client and Server correctly deploy cookbooks to each node.</p> <p>Versions and version constraints can be specified in a cookbook\u2019s <code>metadata.rb</code> file by using the following functions. Each function accepts a name and an optional version constraint; if a version constraint is not provided, <code>&gt;= 0.0.0</code> is used as the default.</p>"},{"location":"chap2/chef_adv5/#3-1-depends","title":"3-1 <code>depends</code>","text":"<p>Show that a cookbook has a dependency on another cookbook. </p> <p>Use a version constraint to define dependencies for cookbook versions: <code>&lt;</code> (less than), <code>&lt;=</code> (less than or equal to), <code>=</code> (equal to), <code>&gt;=</code> (greater than or equal to; </p> <p>also known as \u201coptimistically greater than\u201d, or \u201coptimistic\u201d), <code>~&gt;</code> (approximately greater than; also known as \u201cpessimistically greater than\u201d, or \u201cpessimistic\u201d), or <code>&gt;</code> (greater than). T</p> <p>his field requires that a cookbook with a matching name and version exists on the Chef server. When the match exists, the Chef server includes the dependency as part of the set of cookbooks that are sent to the node when the chef-client runs. </p> <p>It is very important that the <code>depends</code> field contain accurate data. </p> <p>If a dependency statement is inaccurate, the chef-client may not be able to complete the configuration of the system. For example:  </p> <pre><code>depends 'opscode-base'\n</code></pre>"},{"location":"chap2/chef_adv5/#or","title":"or:","text":"<pre><code>depends 'opscode-github', '&gt; 1.0.0'\n</code></pre>"},{"location":"chap2/chef_adv5/#or_1","title":"or:","text":"<pre><code>depends 'runit', '~&gt; 1.2.3'\n</code></pre>"},{"location":"chap2/chef_adv5/#provides","title":"<code>provides</code>","text":"<p>Add a recipe, definition, or resource that is provided by this cookbook, should the auto-populated list be insufficient.</p>"},{"location":"chap2/chef_adv5/#supports","title":"<code>supports</code>","text":"<p>Show that a cookbook has a supported platform. Use a version constraint to define dependencies for platform versions: <code>&lt;</code>(less than), <code>&lt;=</code> (less than or equal to), <code>=</code> (equal to), <code>&gt;=</code> (greater than or equal to), <code>~&gt;</code> (approximately greater than), or <code>&gt;</code> (greater than). To specify more than one platform, use more than one supports field, once for each platform.</p>"},{"location":"chap2/chef_adv5/#4environments","title":"4\u3001Environments","text":"<p>An environment can use version constraints to specify a list of allowed cookbook versions by specifying the cookbook\u2019s name, along with the version constraint. For example:</p> <pre><code>cookbook 'apache2', '~&gt; 1.2.3'\n</code></pre> <p>Or:</p> <pre><code>cookbook 'runit', '= 4.2.0'\n</code></pre>"},{"location":"chap2/chef_adv5/#5freeze-versions","title":"5\u3001Freeze Versions","text":"<p>A cookbook version can be frozen, which will prevent updates from being made to that version of a cookbook. (A user can always upload a new version of a cookbook.) </p> <p>Using cookbook versions that are frozen within environments is a reliable way to keep a production environment safe from accidental updates while testing changes that are made to a development infrastructure.</p> <p>For example, to freeze a cookbook version using knife, enter:</p> <pre><code>$ knife cookbook upload redis --freeze\n</code></pre> <p>To return:</p> <pre><code>Uploading redis...\nUpload completed\n</code></pre> <p>Once a cookbook version is <code>frozen</code>, only by using the <code>--force</code> option can an update be made. For example:</p> <pre><code>$ knife cookbook upload redis --force\n</code></pre> <p>Without the <code>--force</code> option specified, an error will be returned similar to:</p> <pre><code>Version 0.0.0 of cookbook redis is frozen. Use --force to override\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/","title":"\u7b2c\u4e94\u8282 knife search","text":"<p>Search indexes allow queries to be made for any type of data that is indexed by the Chef server, including data bags (and data bag items), environments, nodes, and roles. A defined query syntax is used to support search patterns like exact, wildcard, range, and fuzzy. </p>"},{"location":"chap2/chef_op1_kinfe_search/#1syntax","title":"1\u3001Syntax","text":"<p>This subcommand has the following syntax:</p> <pre><code>$ knife search INDEX SEARCH_QUERY\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-1-index","title":"1-1 INDEX","text":"<ul> <li>1.client, environment, node, role or the name of a data bag </li> <li>2.<code>SEARCH_QUERY</code> is the search query syntax for the query that will be executed.</li> <li>3.<code>INDEX</code> is implied if omitted, and will default to node. For example:</li> </ul> <pre><code>$ knife search '*:*' -i\n</code></pre> <p>is same search as </p> <pre><code>$ knife search node '*:*' -i\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-2-query-syntax","title":"1-2 Query Syntax","text":"<p>A search query is comprised of two parts: the key and the search pattern. A search query has the following syntax:</p> <pre><code>key:search_pattern\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-3-keys","title":"1-3 Keys","text":"<p>To search for the available fields for a particular object, use the show argument with any of the following knife subcommands: <code>knife client</code>, <code>knife data bag</code>, <code>knife environment</code>, <code>knife node</code>, or <code>knife role</code>. For example: <code>knife data bag show</code>.</p>"},{"location":"chap2/chef_op1_kinfe_search/#1-4-examples","title":"1-4 Examples","text":"<p>To use a question mark (<code>?</code>) to replace a single character in a wildcard search, enter the following:</p> <pre><code>$ knife search node 'platfor?:ubuntu'\n</code></pre> <p>To use an asterisk (<code>*</code>) to replace zero (or more) characters in a wildcard search, enter the following:</p> <pre><code>$ knife search node 'platfo*:ubuntu'\n</code></pre> <p>To find all IP address that are on the same network, enter the following:</p> <pre><code>$ knife search node 'ipaddress:192.168*'\n</code></pre> <p>To use a range search to find <code>IP addresses</code> within a <code>subnet</code>, enter the following:</p> <pre><code>$ knife search node 'ipaddress:[192.168.0.* TO 192.0.2.*]'\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-5-about-patterns","title":"1-5 About Patterns","text":"<p>Exact Matching</p> <pre><code>$ knife search admins 'id:charlie'\n</code></pre> <p>Wildcard Matching</p> <ul> <li>A question mark (<code>?</code>) can be used to replace exactly one character</li> <li>An asterisk (<code>*</code>) can be used to replace any number of characters (including zero)</li> </ul> <pre><code>$ knife search node 'foo:*'\n</code></pre> <pre><code>$ knife search node 'name:app*'\n</code></pre> <pre><code>$ knife search node 'name:app?.example.com'\n</code></pre> <pre><code>$ knife search node 'name:app1.example.???'\n</code></pre> <p>Range Matching</p> <p>A range matching search pattern is used to query for values that are within a range defined by upper and lower boundaries. A range matching search pattern can be inclusive or exclusive of the boundaries. Use square brackets (\u201c<code>[ ]</code>\u201d) to denote inclusive boundaries and curly braces (\u201c<code>{ }</code>\u201d) to denote exclusive boundaries and with the following syntax:</p> <pre><code>boundary TO boundary\n</code></pre> <p>where <code>TO</code> is required (and must be capitalized).</p> <p>To search using an inclusive range, enter the following:</p> <pre><code>$ knife search sample \"id:[bar TO foo]\"\n</code></pre> <p>To search using an exclusive range, enter the following:</p> <pre><code>$ knife search sample \"id:{bar TO foo}\"\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-6-about-operators","title":"1-6 About Operators","text":"Operator Description AND Use to find a match when both terms exist. OR Use to find a match if either term exists. NOT Use to exclude the term after <code>NOT</code> from the search results. <p>AND </p> <pre><code>$ knife search sample \"id:b* AND animal:dog\"\n</code></pre> <p>OR</p> <pre><code>$ knife search sample \"id:foo OR id:abc\"\n</code></pre>"},{"location":"chap2/chef_op1_kinfe_search/#1-7-options","title":"1-7 Options","text":"<p><code>-a ATTR, --attribute ATTR</code>: The attribute (or attributes) to show.</p> <p><code>-i, --id-only</code>: Show only matching object IDs.</p> <p>Search by platform ID</p> <pre><code>$ knife search node 'ec2:*' -i\n</code></pre> <p>Search by instance type</p> <pre><code>$ knife search node 'ec2:*' -a ec2.instance_type\n</code></pre> <p>Search by recipe</p> <pre><code>$ knife search node 'recipes:recipe_name'\n</code></pre> <p>or </p> <pre><code>$ knife search node '*:*' -a recipes | grep 'recipe_name'\n</code></pre>"},{"location":"chap3/chef_basic5/","title":"\u7b2c\u4e00\u8282 Creating My First Chef Cookbook","text":"<p>Cookbooks are one of the key components in Chef.</p> <p>They describe the desired state of your nodes, and allow Chef to push out the changes needed to achieve this state. Creating a cookbook can seem like an arduous task at first, given the sheer number of options provided and areas to configure, so in this guide we will walk through the creation of one of the first things people often learn to configure: </p> <p>A LAMP stack.</p>"},{"location":"chap3/chef_basic5/#1bootstap-a-new-machine-as-new-node","title":"1\u3001Bootstap a new machine as new node","text":"<p>https://docs.chef.io/install_bootstrap.html</p> <pre><code>$ knife bootstrap 123.45.6.789 -x username -P password --sudo\n</code></pre> <pre><code>$ knife bootstrap 192.168.33.14 -x vagrant -P vagrant --sudo\n\nERROR: You must pass a node name with -N when bootstrapping with user credentials\n</code></pre> <pre><code>$ knife bootstrap 192.168.33.14 -x vagrant -P vagrant --sudo --use-sudo-password --node-name node2\nCreating new client for node2\nCreating new node for node2\nConnecting to 192.168.33.14\n192.168.33.14 -----&gt; Existing Chef installation detected\n192.168.33.14 Starting the first Chef Client run...\n192.168.33.14 YAML safe loading is not available. Please upgrade psych to a version that supports safe loading (&gt;= 2.0).\n192.168.33.14 Starting Chef Client, version 11.8.2\n192.168.33.14\n192.168.33.14 ================================================================================\n192.168.33.14 Chef encountered an error attempting to load the node data for \"node2\"\n192.168.33.14 ================================================================================\n192.168.33.14\n192.168.33.14\n192.168.33.14 Networking Error:\n192.168.33.14 -----------------\n192.168.33.14 Error connecting to https://chefserver/organizations/devops-jxi/nodes/node2 - getaddrinfo: Name or service not known\n192.168.33.14\n192.168.33.14 Your chef_server_url may be misconfigured, or the network could be down.\n192.168.33.14\n192.168.33.14\n192.168.33.14\n192.168.33.14 Relevant Config Settings:\n192.168.33.14 -------------------------\n192.168.33.14 chef_server_url  \"https://chefserver/organizations/devops-jxi\"\n192.168.33.14\n192.168.33.14\n192.168.33.14\n192.168.33.14 [2018-08-17T08:48:43+00:00] FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out\n192.168.33.14 Chef Client failed. 0 resources updated\n192.168.33.14 [2018-08-17T08:48:43+00:00] ERROR: Error connecting to https://chefserver/organizations/devops-jxi/nodes/node2 - getaddrinfo: Name or service not known\n192.168.33.14 [2018-08-17T08:48:43+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)\n</code></pre> <p>On the new node machine <code>192.168.33.14</code></p> <pre><code>$ sudo vi /etc/hosts\n192.168.33.19 chefserver chefserver\n</code></pre> <p>Try it again</p> <pre><code>$ knife bootstrap 192.168.33.14 -x vagrant -P vagrant --sudo --use-sudo-password --node-name node2\n\nNode node2 exists, overwrite it? (Y/N) y\nClient node2 exists, overwrite it? (Y/N) y\nCreating new client for node2\nCreating new node for node2\nConnecting to 192.168.33.14\n192.168.33.14 -----&gt; Existing Chef installation detected\n192.168.33.14 Starting the first Chef Client run...\n192.168.33.14 YAML safe loading is not available. Please upgrade psych to a version that supports safe loading (&gt;= 2.0).\n192.168.33.14 Starting Chef Client, version 11.8.2\n192.168.33.14 resolving cookbooks for run list: []\n192.168.33.14 Synchronizing Cookbooks:\n192.168.33.14 Compiling Cookbooks...\n192.168.33.14 [2018-08-17T08:50:28+00:00] WARN: Node node2 has an empty run list.\n192.168.33.14 Converging 0 resources\n192.168.33.14 Chef Client finished, 0 resources updated\n</code></pre> <pre><code>$ knife client list\ndevops-jxi-validator\nnode1\nnode2\n</code></pre> <pre><code>$ knife client show node2\nadmin:     false\nchef_type: client\nname:      node2\nvalidator: false\n</code></pre>"},{"location":"chap3/chef_basic5/#2create-the-cookbook","title":"2\u3001Create the Cookbook","text":"<p>1.From your workstation, move to your <code>cookbooks</code> directory in <code>chef-repo</code>:</p> <pre><code>cd chef-repo/cookbooks\n</code></pre> <p>2.Create the cookbook. In this instance the cookbook is titled <code>lamp_stack</code>:</p> <pre><code>chef generate cookbook lamp_stack\n</code></pre> <p>3.List the files located in the newly-created cookbook to see that a number of directories and files have been created:</p> <pre><code>$ cd lamp_stack/\n$ ls\nBerksfile  CHANGELOG.md  chefignore  LICENSE  metadata.rb  README.md  recipes  spec  test\n</code></pre>"},{"location":"chap3/chef_basic5/#3defaultrb","title":"3\u3001default.rb","text":"<p>The <code>default.rb</code> file in <code>recipes</code> contains the \u201cdefault\u201d recipe resources.</p> <p>Because each section of the LAMP stack (Apache, MySQL, and PHP) will have its own recipe, the <code>default.rb</code> file is used to prepare your servers.</p> <p>From within your <code>lamp_stack</code> directory, navigate to the recipes folder:</p> <pre><code>cd recipes\n</code></pre> <p>Open <code>default.rb</code> and add the Ruby command below, which will run system updates:</p> <pre><code>execute \"update-upgrade\" do\n  command \"sudo apt-get update &amp;&amp; sudo apt-get upgrade -y\"\n  action :run\nend\n</code></pre> <p>https://docs.chef.io/resource_execute.html</p> <p>Recipes are comprised of a series of resources. In this case, the execute resource is used, which calls for a command to be executed once. The <code>apt-get update &amp;&amp; apt-get upgrade -y</code> commands are defined in the <code>command</code> section, and the <code>action</code> is set to <code>:run</code> the commands.</p> <p>This is one of the simpler Chef recipes to write, and a good way to start out. Any other startup procedures that you deem important can be added to the file by mimicking the above code pattern.</p> <p>3.To test the recipe, add the LAMP stack cookbook to the Chef server:</p> <pre><code>$ sudo knife cookbook upload lamp_stack\nUploading lamp_stack     [0.1.0]\nUploaded 1 cookbook.\n</code></pre> <p>4.Test that the recipe has been added to the chef server:</p> <pre><code>knife cookbook lists\n</code></pre> <p>5.Add the recipe to your chosen node\u2019s run list, replacing <code>nodename</code> with your node\u2019s name:</p> <pre><code>knife node run_list add node2 \"recipe[lamp_stack]\"\n</code></pre> <pre><code>node2:\n  run_list: recipe[lamp_stack]\n</code></pre> <p>Because this is the default recipe, the recipe name does not need to be defined after <code>lamp_stack</code> cookbook in the code above.</p> <p>6.Access your chosen node and run the <code>chef-client</code>:</p>"},{"location":"chap3/chef_basic5/#4apache","title":"4\u3001Apache","text":""},{"location":"chap3/chef_basic5/#4-1-install-and-enable","title":"4-1 Install and Enable","text":"<p>1.In your Chef workstation, Create a new file under the <code>~/chef-repo/cookbooks/lamp_stack/recipes</code> directory called <code>apache.rb</code>. This will contain all of your Apache configuration information.</p> <p>2.Open the file, and define the <code>package resource</code> to install Apache:</p> <pre><code>package \"apache2\" do\n  action :install\nend\n</code></pre> <p>Again, this is a very basic recipe. The package resource calls to a package (<code>apache2</code>). This value must be a legitimate package name. The action is install because Apache is being installed in this step. There is no need for additional values to run the install.</p> <p>3.Set Apache to enable and start at reboot. In the same file, add the additional lines of code:</p> <pre><code>service \"apache2\" do\n  action [:enable, :start]\nend\n</code></pre> <p>This uses the service resource, which calls on the Apache service. The <code>enable</code> action enables it upon startup, and <code>start</code> starts Apache.</p> <p>Save and close the <code>apache.rb</code> file.</p> <p>4.To test the Apache recipe, update the LAMP Stack recipe on the server:</p> <pre><code>sudo knife cookbook upload lamp_stack\n</code></pre> <p>5.Add the recipe to a node\u2019s run-list, replacing <code>nodename</code> with your chosen node\u2019s name:</p> <pre><code>knife node run_list add node2 \"recipe[lamp_stack::apache]\"\n</code></pre> <pre><code>node2:\n  run_list:\n    recipe[lamp_stack]\n    recipe[lamp_stack::apache]\n</code></pre> <p>Because this is not the <code>default.rb</code> recipe, the recipe name, <code>apache</code>, must be appended to the recipe value.</p> <p>6.From that node, run <code>chef-client</code>:</p> <pre><code>sudo chef-client\n</code></pre> <pre><code>YAML safe loading is not available. Please upgrade psych to a version that supports safe loading (&gt;= 2.0).\nStarting Chef Client, version 11.8.2\nresolving cookbooks for run list: [\"lamp_stack\", \"lamp_stack::apache\"]\nSynchronizing Cookbooks:\n  - lamp_stack\nCompiling Cookbooks...\nConverging 3 resources\nRecipe: lamp_stack::default\n  * execute[update-upgrade] action run\n    - execute sudo apt-get update &amp;&amp; sudo apt-get upgrade -y\n\nRecipe: lamp_stack::apache\n  * package[apache2] action install\n    - install version 2.4.7-1ubuntu4.20 of package apache2\n\n  * service[apache2] action enable\n    - enable service service[apache2]\n\n  * service[apache2] action start (up to date)\nChef Client finished, 3 resources updated\n</code></pre> <p>If the recipe fails due to a syntax error, Chef will note it during the output.</p> <p>7.After a successful <code>chef-client</code> run, check to see if Apache is running:</p> <pre><code>$ service apache2 status\n * apache2 is running\n</code></pre> <p>It should say that <code>apache2</code> is running.</p>"},{"location":"chap3/chef_basic5/#5configure-virtual-hosts","title":"5\u3001Configure Virtual Hosts","text":"<p>1.Because multiple websites may need to be configured, use Chef\u2019s attributes feature to define certain aspects of the virtual hosts file(s). The ChefDK has a built-in command to generate the attributes directory and <code>default.rb</code> file within a cookbook. Replace <code>~/chef-repo/cookbooks/lamp_stack</code> with your cookbook\u2019s path:</p> <pre><code>$ chef generate attribute ~/chef-repo/cookbooks/lamp_stack default\n\n  * directory[/home/vagrant/chef-repo/cookbooks/lamp_stack/attributes] action create\n    - create new directory /home/vagrant/chef-repo/cookbooks/lamp_stack/attributes\n    - restore selinux security context\n  * template[/home/vagrant/chef-repo/cookbooks/lamp_stack/attributes/default.rb] action create\n    - create new file /home/vagrant/chef-repo/cookbooks/lamp_stack/attributes/default.rb\n    - update content in file /home/vagrant/chef-repo/cookbooks/lamp_stack/attributes/default.rb from none to e3b0c4\n    (diff output suppressed by config)\n    - restore selinux security context\n</code></pre> <p>2.Within the new <code>default.rb</code>, create the default values of the cookbook:</p> <p><code>~/chef-repo/cookbooks/lamp_stack/attributes/default.rb</code></p> <pre><code>default[\"lamp_stack\"][\"sites\"][\"example.com\"] = { \"port\" =&gt; 80, \"servername\" =&gt; \"cheftest.com\", \"serveradmin\" =&gt; \"cheftest@example.com\" }\n</code></pre> <p>The prefix <code>default</code> defines that these are the normal values to be used in the <code>lamp_stack</code> where the site <code>cheftest.com</code> will be called upon. This can be seen as a hierarchy: Under the cookbook itself are the site(s), which are then defined by their URL.</p> <p>The following values in the array (defined by curly brackets (<code>{}</code>)) are the values that will be used to configure the virtual hosts file. Apache will be set to listen on port 80 and use the listed values for its server name, and administrator email.</p> <pre><code>$ cd ~/chef-repo/cookbooks/lamp_stack/attributes/default.rb\n\ndefault[\"lamp_stack\"][\"sites\"][\"example.com\"] = { \"port\" =&gt; 80, \"servername\" =&gt; \"example.com\", \"serveradmin\" =&gt; \"webmaster@example.com\" }\ndefault[\"lamp_stack\"][\"sites\"][\"example.org\"] = { \"port\" =&gt; 80, \"servername\" =&gt; \"example.org\", \"serveradmin\" =&gt; \"webmaster@example.org\" }\n</code></pre> <p>3.Return to your <code>apache.rb</code> file under <code>recipes</code> to call the attributes that were just defined. Do this with the <code>node</code> resource:</p> <pre><code>#Install &amp; enable Apache\n\npackage \"apache2\" do\n  action :install\nend\n\nservice \"apache2\" do\n  action [:enable, :start]\nend\n\n\n# Virtual Hosts Files\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\nend\n</code></pre> <p>This calls in the values under <code>[\"lamp_stack\"][\"sites\"]</code>. </p> <p>Code added to this block will be generated for each value, which is defined by the word <code>sitename</code>. </p> <p>The data value calls the values that are listed in the array of each <code>sitename</code> attribute.</p> <p>4.Within the <code>node</code> resource, define a document root. This root will be used to define the public HTML files, and any log files that will be generated:</p> <pre><code>node[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  document_root = \"/var/www/html/#{sitename}\"\nend\n</code></pre> <p>5.However, this does not create the directory itself. To do so, the <code>directory</code> resource should be used, with a <code>true</code> recursive value so all directories leading up to the <code>sitename</code> will be created. A permissions value of <code>0755</code> allows for the file owner to have full access to the directory, while group and regular users will have read and execute privileges:</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/apache.rb\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  document_root = \"/var/www/html/#{sitename}\"\n\n  directory document_root do\n    mode \"0755\"\n    recursive true\n  end\n\nend \n</code></pre> <p>6.The template feature will be used to generate the needed virtual hosts files. Within the <code>chef-repo</code> directory run the <code>chef generate template</code> command with the path to your cookbook and template file name defined:</p> <pre><code>$ chef generate template ~/chef-repo/cookbooks/lamp_stack virtualhosts\n\nRecipe: code_generator::template\n  * directory[/home/vagrant/chef-repo/cookbooks/lamp_stack/templates] action create\n    - create new directory /home/vagrant/chef-repo/cookbooks/lamp_stack/templates\n    - restore selinux security context\n  * template[/home/vagrant/chef-repo/cookbooks/lamp_stack/templates/virtualhosts.erb] action create\n    - create new file /home/vagrant/chef-repo/cookbooks/lamp_stack/templates/virtualhosts.erb\n    - update content in file /home/vagrant/chef-repo/cookbooks/lamp_stack/templates/virtualhosts.erb from none to e3b0c4\n    (diff output suppressed by config)\n    - restore selinux security context\n</code></pre> <p>7.Open and edit the <code>virtualhosts.erb</code> file. Instead of writing in the true values for each VirtualHost parameter, use Ruby variables. Ruby variables are identified by the <code>&lt;%= @variable_name %&gt;</code> syntax. The variable names you use will need to be defined in the recipe file:</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/templates/default/virtualhosts.erb\n\n&lt;VirtualHost *:&lt;%= @port %&gt;&gt;\n        ServerAdmin &lt;%= @serveradmin %&gt;\n        ServerName &lt;%= @servername %&gt;\n        ServerAlias www.&lt;%= @servername %&gt;\n        DocumentRoot &lt;%= @document_root %&gt;/public_html\n        ErrorLog &lt;%= @document_root %&gt;/logs/error.log\n        &lt;Directory &lt;%= @document_root %&gt;/public_html&gt;\n                Require all granted\n        &lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <p>Some variables should look familiar. They were created in Step 2, when naming default attributes.</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/recipes/apache.rb\n\n#Virtual Hosts Files\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  document_root = \"/var/www/html/#{sitename}\"\n\n  directory document_root do\n    mode \"0755\"\n    recursive true\n  end\n\n  template \"/etc/apache2/sites-available/#{sitename}.conf\" do\n    source \"virtualhosts.erb\"\n    mode \"0644\"\n    variables(\n      :document_root =&gt; document_root,\n      :port =&gt; data[\"port\"],\n      :serveradmin =&gt; data[\"serveradmin\"],\n      :servername =&gt; data[\"servername\"]\n    )\n  end\n\nend\n</code></pre> <p>The name of the template resource should be the location where the virtual host file is placed on the nodes. The <code>source</code> is the name of the template file. Mode <code>0644</code> gives the file owner read and write privileges, and everyone else read privileges. The values defined in the variables section are taken from the attributes file, and they are the same values that are called upon in the template.</p> <p>9.The sites now need to be enabled in Apache, and the server restarted. This should only occur if there are changes to the virtual hosts, so the <code>notifies</code> value should be added to the <code>template</code> resource. <code>notifies</code> tells Chef when things have changed, and only then runs the commands:</p> <pre><code>template \"/etc/apache2/sites-available/#{sitename}.conf\" do\n  source \"virtualhosts.erb\"\n  mode \"0644\"\n  variables(\n    :document_root =&gt; document_root,\n    :port =&gt; data[\"port\"],\n    :serveradmin =&gt; data[\"serveradmin\"],\n    :servername =&gt; data[\"servername\"]\n  )\n  notifies :restart, \"service[apache2]\"\nend\n</code></pre> <p>The <code>notifies</code> command names the <code>:action</code> to be committed, then the resource, and resource name in square brackets.</p> <p>10.<code>notifies</code> can also call on <code>execute</code> commands, which will run <code>a2ensiteand</code> enable the sites we\u2019ve made virtual hosts files for. Add the following <code>execute</code> command above the <code>template</code> resource code to create the <code>a2ensite</code> script:</p> <pre><code>$vi ~/chef-repo/cookbooks/lamp_stack/recipes/apache.rb\n\n# [...]\n\ndirectory document_root do\n  mode \"0755\"\n  recursive true\nend\n\nexecute \"enable-sites\" do\n  command \"a2ensite #{sitename}\"\n  action :nothing\nend\n\ntemplate \"/etc/apache2/sites-available/#{sitename}.conf\" do\n\n# [...]\n</code></pre> <p>The <code>action :nothing</code> directive means the resource will wait to be called on. Add a new <code>notifies</code> line above the previoues <code>notifies</code> line to the <code>template</code> resource code to use it:</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/recipes/apache.rb\n\n# [...]\n\ntemplate \"/etc/apache2/sites-available/#{sitename}.conf\" do\n  # [...]\n  notifies :run, \"execute[enable-sites]\"\n  notifies :restart, \"service[apache2]\"\nend\n\n# [...]\n</code></pre> <p>11.The paths referenced in the virtual hosts files need to be created. Once more, this is done with the <code>directory</code> resource, and should be added before the final <code>end</code> tag:</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/recipes/apache.rb\n\n# [...]\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  # [...]\n\n  directory \"/var/www/html/#{sitename}/public_html\" do\n    action :create\n  end\n\n  directory \"/var/www/html/#{sitename}/logs\" do\n    action :create\n  end\nend\n</code></pre>"},{"location":"chap3/chef_basic5/#11apache-configuration","title":"11\u3001Apache Configuration","text":"<p>With the virtual hosts files configured and your website enabled, configure Apache to efficiently run on your servers. Do this by enabling and configuring a multi-processing module (MPM), and editing apache2.conf.</p> <p>The MPMs are all located in the <code>mods_available</code> directory of Apache. In this example the event MPM will be used, located at <code>/etc/apache2/mods-available/mpm_event.conf</code>. If we were planning on deploying to nodes of varying size we would create a template file to replace the original, which would allow for more customization of specific variables. In this instance, a cookbook file will be used to edit the file.</p> <p>Cookbook files are static documents that are run against the document in the same locale on your servers. If any changes are made, the cookbook file makes a backup of the original file and replaces it with the new one.</p> <p>1.To create a cookbook file navigate to <code>files/default</code> from your cookbook\u2019s main directory. If the directories do not already exist, create them:</p> <pre><code>mkdir -p ~/chef-repo/cookbooks/lamp_stack/files/default/\ncd ~/chef-repo/cookbooks/lamp_stack/files/default/\nvi mpm_event.conf\n</code></pre> <p>2.Create a file called <code>mpm_event.conf</code> and copy the MPM event configuration into it, changing any needed values:</p> <pre><code>&lt;IfModule mpm_event_module&gt;\n        StartServers        2\n        MinSpareThreads     6\n        MaxSpareThreads     12\n        ThreadLimit         64\n        ThreadsPerChild     25\n        MaxRequestWorkers   25\n        MaxConnectionsPerChild  3000\n&lt;/IfModule&gt;\n</code></pre> <p>3.Return to <code>apache.rb</code>, and use the <code>cookbook_file</code> resource to call the file we just created. Because the MPM will need to be enabled, we\u2019ll use the <code>notifies</code> command again, this time to execute <code>a2enmod mpm_event</code>. Add the <code>execute</code> and <code>cookbook_file</code> resources to the <code>apache.rb</code> file prior to the final <code>end</code> tag:</p> <pre><code># [...]\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  # [...]\n\n  execute \"enable-event\" do\n    command \"a2enmod mpm_event\"\n    action :nothing\n  end\n\n  cookbook_file \"/etc/apache2/mods-available/mpm_event.conf\" do\n    source \"mpm_event.conf\"\n    mode \"0644\"\n    notifies :run, \"execute[enable-event]\"\n  end\nend\n</code></pre> <p>4.Within the <code>apache2.conf</code> the <code>KeepAlive</code> value should be set to <code>off</code>, which is the only change made within the file. This can be altered through templates or cookbook files, although in this instance a simple <code>sed</code> command will be used, paired with the <code>execute</code> resource. Update <code>apache.rb</code> with the new <code>execute</code> resource:</p> <pre><code># [...]\n\ndirectory \"/var/www/html/#{sitename}/logs\" do\n  action :create\nend\n\nexecute \"keepalive\" do\n  command \"sed -i 's/KeepAlive On/KeepAlive Off/g' /etc/apache2/apache2.conf\"\n  action :run\nend\n\nexecute \"enable-event\" do\n\n# [...]\n</code></pre> <p>Your <code>apache.rb</code> is now complete.</p> <pre><code>$ vi\n\npackage \"apache2\" do\n  action :install\nend\n\nservice \"apache2\" do\n  action [:enable, :start]\nend\n\n#Virtual Hosts Files\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  document_root = \"/var/www/html/#{sitename}\"\n\n  directory document_root do\n    mode \"0755\"\n    recursive true\n  end\n\n  execute \"enable-sites\" do\n    command \"a2ensite #{sitename}\"\n    action :nothing\n  end\n\n  template \"/etc/apache2/sites-available/#{sitename}.conf\" do\n    source \"virtualhosts.erb\"\n    mode \"0644\"\n    variables(\n      :document_root =&gt; document_root,\n      :port =&gt; data[\"port\"],\n      :serveradmin =&gt; data[\"serveradmin\"],\n      :servername =&gt; data[\"servername\"]\n    )\n    notifies :run, \"execute[enable-sites]\"\n    notifies :restart, \"service[apache2]\"\n  end\n\n  directory \"/var/www/html/#{sitename}/public_html\" do\n    action :create\n  end\n\n  directory \"/var/www/html/#{sitename}/logs\" do\n    action :create\n  end\n\n  execute \"keepalive\" do\n    command \"sed -i 's/KeepAlive On/KeepAlive Off/g' /etc/apache2/apache2.conf\"\n    action :run\n  end\n\n  execute \"enable-event\" do\n    command \"a2enmod mpm_event\"\n    action :nothing\n  end\n\n  cookbook_file \"/etc/apache2/mods-available/mpm_event.conf\" do\n    source \"mpm_event.conf\"\n    mode \"0644\"\n    notifies :run, \"execute[enable-event]\"\n  end\n\nend\n</code></pre> <pre><code>$ sudo knife cookbook upload lamp_stack\nUploading lamp_stack     [0.1.0]\nUploaded 1 cookbook.\n\n$ knife node run_list add node2 \"recipe[lamp_stack]\"\nnode2:\n  run_list:\n    recipe[lamp_stack]\n    recipe[lamp_stack::apache]\n</code></pre>"},{"location":"chap3/chef_basic5/#12mysql","title":"12\u3001MySQL","text":""},{"location":"chap3/chef_basic5/#12-1-download-the-mysql","title":"12-1 Download the MySQL","text":"<p>1.The Chef Supermarket has an OpsCode-maintained MySQL cookbook that sets up MySQL lightweight resources/providers (LWRPs) to be used. From the workstation, download and install the cookbook:</p> <pre><code>knife cookbook site install mysql\n</code></pre> <p>This will also install any and all dependencies required to use the cookbook. These dependencies include the <code>smf</code> and <code>yum-mysql-community</code> cookbooks, which in turn depend on the <code>rbac</code> and <code>yum</code> cookbooks.</p> <p>2.From the main directory of your LAMP stack cookbook, open the <code>metadata.rb</code> file and add a dependency to the MySQL cookbook:</p> <pre><code>$ vi ~/chef-repo/cookbooks/lamp_stack/metadata.rb\n\ndepends          'mysql', '~&gt; 8.5.1'\n</code></pre> <p>3.Upload these cookbooks to the server:</p> <pre><code>knife cookbook upload mysql --include-dependencies\n</code></pre> <pre><code>sudo knife cookbook upload lamp_stack --force\n</code></pre>"},{"location":"chap3/chef_basic5/#12-2-create-and-encrypt-your-mysql-password","title":"12-2 Create and Encrypt Your MySQL Password","text":"<p>Chef contains a feature known as <code>data bags</code>. Data bags store information, and can be encrypted to store passwords, and other sensitive data.</p> <p>1.On the workstation, generate a secret key:</p> <pre><code>openssl rand -base64 512 &gt; ~/chef-repo/.chef/encrypted_data_bag_secret\n</code></pre> <p>2.Upload this key to your node\u2019s <code>/etc/chef</code> directory, either manually by <code>scp</code> (an example can be found in the Setting Up Chef guide), or through the use of a recipe and cookbook file.</p> <p>3.On the workstation, create a <code>mysql</code> data bag that will contain the file <code>rtpass.json</code> for the root password:</p> <pre><code>knife data bag create mysql rtpass.json --secret-file ~/chef-repo/.chef/encrypted_data_bag_secret\n</code></pre> <pre><code>Created data_bag[mysql]\nERROR: RuntimeError: Please set EDITOR environment variable. See https://docs.chef.io/knife_setup.html for details.\n</code></pre> <pre><code>cd ../../.chef\nvi knife.rb\n\nknife[:editor] = \"/usr/bin/vim\"\n</code></pre> <p>You will be asked to edit the <code>rtpass.json</code> file:</p> <pre><code>{\n  \"id\": \"rtpass.json\",\n  \"password\": \"password123\"\n}\n</code></pre> <p>4.Confirm that the rtpass.json file was created:</p> <pre><code>$ knife data bag show mysql\n\nrtpass.json\n</code></pre> <p>It should output <code>rtpass.json</code>. To ensure that is it encrypted, run:</p> <pre><code>$ knife data bag show mysql rtpass.json\n\nWARNING: Encrypted data bag detected, but no secret provided for decoding. Displaying encrypted data.\nid:       rtpass.json\npassword:\n  auth_tag:       +EoLhhpYKrHtyrbyx9oC7g==\n\n  cipher:         aes-256-gcm\n  encrypted_data: dON+BYY9+vu0JexTVwmiGftpftiv+glLIta7tvL0\n\n  iv:             FrD0NUPg78t4GJCr\n\n  version:        3\n</code></pre>"},{"location":"chap3/chef_basic5/#12-3-set-up-mysql","title":"12-3 Set Up MySQL","text":"<p>With the MySQL library downloaded and an encrypted root password prepared, you can now set up the recipe to download and configure MySQL</p> <p>1.Open a new file in <code>recipes</code> called <code>mysql.rb</code> and define the data bag that will be used:</p> <p><code>vi ~/chef-repo/cookbooks/lamp_stack/recipes/mysql.rb</code></p> <pre><code>mysqlpass = data_bag_item(\"mysql\", \"rtpass.json\")\n</code></pre> <p>2.Thanks to the LWRPs provided through the MySQL cookbook, the initial installation and database creation for MySQL can be done in one resource:</p> <pre><code>mysqlpass = data_bag_item(\"mysql\", \"rtpass.json\")\n\nmysql_service \"mysqldefault\" do\n  version '5.7'\n  initial_root_password mysqlpass[\"password\"]\n  action [:create, :start]\nend\n</code></pre> <p><code>mysqldefault</code> is the name of the MySQL service for this container. The <code>inital_root_password</code> calls to the value defined in the text above, while the action creates the database and starts the MySQL service.</p> <pre><code>sudo knife cookbook upload lamp_stack --force\nknife node run_list add node2 \"recipe[lamp_stack::mysql]\"\n\nnode2:\n  run_list:\n    recipe[lamp_stack]\n    recipe[lamp_stack::apache]\n    recipe[lamp_stack::mysql]\n</code></pre> <p>When running MySQL from your nodes you will need to define the socket:</p> <pre><code>mysql -S /var/run/mysql-mysqldefault/mysqld.sock -p\n</code></pre>"},{"location":"chap3/chef_basic5/#13php","title":"13\u3001PHP","text":"<p>1.Under the recipes directory, create a new <code>php.rb</code> file. The commands below install PHP and all the required packages for working with Apache and MySQL:</p> <pre><code>$ vi php.rb\n\npackage \"php\" do\n  action :install\nend\n\npackage \"php-pear\" do\n  action :install\nend\n\npackage \"php-mysql\" do\n  action :install\nend\n</code></pre> <p>2.For easy configuration, the <code>php.ini</code> file will be created and used as a cookbook file, much like the MPM module above. You can either:</p> <ul> <li>Add the PHP recipe, run <code>chef-client</code> and copy the file from a node (located in <code>/etc/php/7.0/cli/php.ini</code>), or:</li> <li>Copy it from this chef-php.ini sample. The file should be moved to the <code>chef-repo/cookbooks/lamp_stack/files/default/</code> directory. This can also be turned into a template, if that better suits your configuration.</li> </ul> <p>3.<code>php.ini</code> is a large file. Search and edit the following values to best suit your Linodes. The values suggested below are for 2GB Linodes:</p> <pre><code>vi ~/chef-repo/cookbooks/lamp_stack/files/default/php.ini\n</code></pre> <pre><code>max_execution_time = 30\nmemory_limit = 128M\nerror_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR\ndisplay_errors = Off\nlog_errors = On\nerror_log = /var/log/php/error.log\nmax_input_time = 30\n</code></pre> <p>4.Return to <code>php.rb</code> and append the <code>cookbook_file</code> resource to the end of the recipe:</p> <pre><code>cookbook_file \"/etc/php/7.0/cli/php.ini\" do\n  source \"php.ini\"\n  mode \"0644\"\n  notifies :restart, \"service[apache2]\"\nend\n</code></pre> <p>5.Because of the changes made to <code>php.ini</code>, a <code>/var/log/php</code> directory needs to be made and its ownership set to the Apache user. This is done through a <code>notifies</code> command and execute resource, as done previously. Append these resources to the end of <code>php.rb</code>:</p> <pre><code>execute \"chownlog\" do\n  command \"chown www-data /var/log/php\"\n  action :nothing\nend\n\ndirectory \"/var/log/php\" do\n  action :create\n  notifies :run, \"execute[chownlog]\"\nend\n</code></pre> <p>The PHP recipe is now done! </p> <p>6.Ensure that your Chef server contains the updated cookbook, and that your node\u2019s run list is up-to-date. Replace nodename with your Chef node\u2019s name:</p> <pre><code>$ sudo knife cookbook upload lamp_stack --force\n$ knife node run_list add node2 \"recipe[lamp_stack],recipe[lamp_stack::apache],recipe[lamp_stack::mysql],recipe[lamp_stack::php]\"\nnode2:\n  run_list:\n    recipe[lamp_stack]\n    recipe[lamp_stack::apache]\n    recipe[lamp_stack::mysql]\n    recipe[lamp_stack::php]\n</code></pre> <p>You have just created a LAMP Stack cookbook. Through this guide, you should have learned to use the execute, package, service, node, directory, template, cookbook_file, and mysql_service resources within a recipe, as well as download and use LWRPs, create encrypted data bags, upload/update your cookbooks to the server, and use attributes, templates, and cookbook files, giving you a strong basis in Chef and cookbook creation for future projects.</p>"},{"location":"chap3/chef_basic6/","title":"\u7b2c\u4e8c\u8282 Creating LAMP Chef Cookbook Analysis","text":""},{"location":"chap3/chef_basic6/#1add-new-client-node","title":"1\u3001Add new Client Node","text":"<pre><code>knife bootstrap client_ip -x username -P password --sudo --use-sudo-password --node-name node2\n</code></pre> <pre><code>knife client list\n</code></pre> <pre><code>knife client show node_name\n</code></pre>"},{"location":"chap3/chef_basic6/#2create-the-cookbook-on-workstation","title":"2\u3001Create the Cookbook on workstation","text":"<pre><code>cd chef-repo/cookbooks\nchef generate cookbook cookbook_name\n</code></pre>"},{"location":"chap3/chef_basic6/#3default-recipes","title":"3\u3001default recipes","text":""},{"location":"chap3/chef_basic6/#3-1-defaultrb","title":"3-1 default.rb","text":"<pre><code>execute \"update-upgrade\" do\n  command \"sudo apt-get update &amp;&amp; sudo apt-get upgrade -y\"\n  action :run\nend\n</code></pre>"},{"location":"chap3/chef_basic6/#3-2-execute","title":"3-2 execute:","text":"<p>Commands are often run in combination with other Chef resources. </p> <p>Actions:</p> <p><code>:nothing</code></p> <p>Prevent a command from running. This action is used to specify that a command is run only when another resource notifies it</p> <p><code>:run</code></p> <p>Default. Run a command.</p> <p>Examples:</p> <p>Commands are often run in combination with other Chef resources. The following example shows the template resource run with the execute resource to add an entry to a LDAP Directory Interchange Format (LDIF) file:</p> <pre><code>execute 'slapadd' do\n  command 'slapadd &lt; /tmp/something.ldif'\n  creates '/var/lib/slapd/uid.bdb'\n  action :nothing\nend\n\ntemplate '/tmp/something.ldif' do\n  source 'something.ldif'\n  notifies :run, 'execute[slapadd]', :immediately\nend\n\n</code></pre>"},{"location":"chap3/chef_basic6/#3-3-upload-to-the-chef-server-and-upload-to-client","title":"3-3 Upload to the chef server and upload to client","text":"<pre><code>sudo knife cookbook upload cookbook_name\nknife cookbook lists\n\nknife node run_list add node_name \"recipe[cookbook_name]\"\n</code></pre>"},{"location":"chap3/chef_basic6/#4install-apache-and-configuration","title":"4\u3001Install Apache and Configuration","text":""},{"location":"chap3/chef_basic6/#4-1-apacherb","title":"4-1 apache.rb","text":"<p>package: https://docs.chef.io/resource_package.html</p> <pre><code>package \"apache2\" do\n  action :install\nend\n\nservice \"apache2\" do\n  action [:enable, :start]\nend\n</code></pre> <p>Add  the new recipe to the chef node</p> <pre><code>knife node run_list add node2 \"recipe[lamp_stack::apache]\"\n</code></pre> <p>On the chef node</p> <pre><code>sudo chef-client\n</code></pre>"},{"location":"chap3/chef_basic6/#5configure-virtual-hosts","title":"5\u3001Configure Virtual Hosts","text":""},{"location":"chap3/chef_basic6/#5-1-add-attributes","title":"5-1 Add attributes","text":"<pre><code>chef generate attribute ~/chef-repo/cookbooks/lamp_stack default\n</code></pre>"},{"location":"chap3/chef_basic6/#5-2-attributesdefaultrb","title":"5-2 attributes/default.rb","text":"<pre><code>default[\"lamp_stack\"][\"sites\"][\"example.com\"] = { \"port\" =&gt; 80, \"servername\" =&gt; \"example.com\", \"serveradmin\" =&gt; \"webmaster@example.com\" }\ndefault[\"lamp_stack\"][\"sites\"][\"example.org\"] = { \"port\" =&gt; 80, \"servername\" =&gt; \"example.org\", \"serveradmin\" =&gt; \"webmaster@example.org\" }\n</code></pre> <p>loop the attributes</p> <pre><code>node[\"lamp_stack\"][\"sites\"].each do |sitename, data|\nend\n</code></pre> <pre><code>sitename =&gt; [\"example.com\"] [\"example.org\"]\ndatat    =&gt; { \"port\" =&gt; 80, \"servername\" =&gt; \"example.com\", \"serveradmin\" =&gt; \"webmaster@example.com\" }\n</code></pre> <pre><code>node[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n\n  document_root = \"/var/www/html/#{sitename}\"\n\n  directory document_root do\n    mode \"0755\"\n    recursive true\n  end\n\nend \n</code></pre>"},{"location":"chap3/chef_basic6/#5-3-add-template","title":"5-3 Add template","text":"<pre><code>chef generate template ~/chef-repo/cookbooks/lamp_stack virtualhosts\n</code></pre>"},{"location":"chap3/chef_basic6/#5-4-templatesdefaultvirtualhostserb","title":"5-4 templates/default/virtualhosts.erb","text":"<pre><code>&lt;VirtualHost *:&lt;%= @port %&gt;&gt;\n        ServerAdmin &lt;%= @serveradmin %&gt;\n        ServerName &lt;%= @servername %&gt;\n        ServerAlias www.&lt;%= @servername %&gt;\n        DocumentRoot &lt;%= @document_root %&gt;/public_html\n        ErrorLog &lt;%= @document_root %&gt;/logs/error.log\n        &lt;Directory &lt;%= @document_root %&gt;/public_html&gt;\n                Require all granted\n        &lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <pre><code>template \"/etc/apache2/sites-available/#{sitename}.conf\" do\n\n    source \"virtualhosts.erb\"\n    mode \"0644\"\n\n    variables(\n      :document_root =&gt; document_root,\n      :port =&gt; data[\"port\"],\n      :serveradmin =&gt; data[\"serveradmin\"],\n      :servername =&gt; data[\"servername\"]\n    ) \n\n    notifies :restart, \"service[apache2]\"\n\nend\n</code></pre> <p>The name of the template resource should be the location where the virtual host file is placed on the nodes. The source is the name of the template file. <code>Mode 0644</code> gives the file owner read and write privileges, and everyone else read privileges. The values defined in the variables section are taken from the attributes file, and they are the same values that are called upon in the template</p>"},{"location":"chap3/chef_basic6/#6apache-configuration-for-virtual-host","title":"6\u3001Apache Configuration for Virtual host","text":"<p>configuring a multi-processing module (MPM)</p> <pre><code>/files/default/mpm_event.conf\n</code></pre> <pre><code>&lt;IfModule mpm_event_module&gt;\n        StartServers        2\n        MinSpareThreads     6\n        MaxSpareThreads     12\n        ThreadLimit         64\n        ThreadsPerChild     25\n        MaxRequestWorkers   25\n        MaxConnectionsPerChild  3000\n&lt;/IfModule&gt;\n</code></pre>"},{"location":"chap3/chef_basic6/#apacherb","title":"apache.rb","text":"<pre><code>package \"apache2\" do\n  action :install\nend\n\nservice \"apache2\" do\n  action [:enable, :start]\nend\n\n#Virtual Hosts Files\n\nnode[\"lamp_stack\"][\"sites\"].each do |sitename, data|\n  document_root = \"/var/www/html/#{sitename}\"\n\n  directory document_root do\n    mode \"0755\"\n    recursive true\n  end\n\n  execute \"enable-sites\" do\n    command \"a2ensite #{sitename}\"\n    action :nothing\n  end\n\n  template \"/etc/apache2/sites-available/#{sitename}.conf\" do\n    source \"virtualhosts.erb\"\n    mode \"0644\"\n    variables(\n      :document_root =&gt; document_root,\n      :port =&gt; data[\"port\"],\n      :serveradmin =&gt; data[\"serveradmin\"],\n      :servername =&gt; data[\"servername\"]\n    )\n    notifies :run, \"execute[enable-sites]\"\n    notifies :restart, \"service[apache2]\"\n  end\n\n  directory \"/var/www/html/#{sitename}/public_html\" do\n    action :create\n  end\n\n  directory \"/var/www/html/#{sitename}/logs\" do\n    action :create\n  end\n\n  execute \"keepalive\" do\n    command \"sed -i 's/KeepAlive On/KeepAlive Off/g' /etc/apache2/apache2.conf\"\n    action :run\n  end\n\n  execute \"enable-event\" do\n    command \"a2enmod mpm_event\"\n    action :nothing\n  end\n\n  cookbook_file \"/etc/apache2/mods-available/mpm_event.conf\" do\n    source \"mpm_event.conf\"\n    mode \"0644\"\n    notifies :run, \"execute[enable-event]\"\n  end\n\nend\n</code></pre>"},{"location":"chap3/chef_basic6/#7mysql","title":"7\u3001MySQL","text":"<pre><code>knife cookbook site install mysql\n</code></pre> <p>add dependency</p> <pre><code>vi ~/chef-repo/cookbooks/lamp_stack/metadata.rb\n\ndepends          'mysql', '~&gt; 8.5.1\n</code></pre> <pre><code>knife cookbook upload mysql --include-dependencies\nsudo knife cookbook upload lamp_stack --force\n</code></pre>"},{"location":"chap3/chef_basic6/#8create-and-encrypt-your-mysql-password","title":"8\u3001Create and Encrypt Your MySQL Password","text":"<p>On the workstation, create a mysql data bag that will contain the file <code>rtpass.json</code> for the root password</p> <pre><code>openssl rand -base64 512 &gt; ~/chef-repo/.chef/encrypted_data_bag_secret\nknife data bag create mysql rtpass.json --secret-file ~/chef-repo/.chef/encrypted_data_bag_secret\n</code></pre> <p>vi knife.rb</p> <pre><code>knife[:editor] = \"/usr/bin/vim\"\n</code></pre> <p>vi rtpass.json</p> <pre><code>{\n  \"id\": \"rtpass.json\",\n  \"password\": \"password123\"\n}\n</code></pre> <pre><code>$ knife data bag show mysql\n\nrtpass.json\n\n$ knife data bag show mysql rtpass.json\n</code></pre>"},{"location":"chap3/chef_basic6/#9set-up-mysql","title":"9\u3001Set Up MySQL","text":""},{"location":"chap3/chef_basic6/#9-1-mysqlrb","title":"9-1 mysql.rb","text":"<pre><code>mysqlpass = data_bag_item(\"mysql\", \"rtpass.json\")\n\nmysql_service \"mysqldefault\" do\n  version '5.7'\n  initial_root_password mysqlpass[\"password\"]\n  action [:create, :start]\nend\n</code></pre> <pre><code>sudo knife cookbook upload lamp_stack --force\nknife node run_list add node2 \"recipe[lamp_stack::mysql]\"\n</code></pre>"},{"location":"chap3/chef_basic6/#10php","title":"10\u3001PHP","text":"<pre><code>vi php.rb\n\npackage \"php\" do\n  action :install\nend\n\npackage \"php-pear\" do\n  action :install\nend\n\npackage \"php-mysql\" do\n  action :install\nend\n</code></pre> <p>The file will be put on node </p> <p>files/default/php.ini</p> <pre><code>max_execution_time = 30\nmemory_limit = 128M\nerror_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR\ndisplay_errors = Off\nlog_errors = On\nerror_log = /var/log/php/error.log\nmax_input_time = 30\n</code></pre>"},{"location":"chap3/chef_basic6/#10-1-phprb","title":"10-1 php.rb","text":"<pre><code>package \"php\" do\n  action :install\nend\n\npackage \"php-pear\" do\n  action :install\nend\n\npackage \"php-mysql\" do\n  action :install\nend\n\ncookbook_file \"/etc/php/7.0/cli/php.ini\" do\n  source \"php.ini\"\n  mode \"0644\"\n  notifies :restart, \"service[apache2]\"\nend\n\nexecute \"chownlog\" do\n  command \"chown www-data /var/log/php\"\n  action :nothing\nend\n\ndirectory \"/var/log/php\" do\n  action :create\n  notifies :run, \"execute[chownlog]\"\nend\n</code></pre>"},{"location":"chap4/10Ansible_learn_ppt/","title":"L10 Ansible \u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177PPT","text":"<p>Ansible \u662f\u8fd1\u5e74\u6765\u8d8a\u6765\u8d8a\u706b\u7684\u4e00\u6b3e\u5f00\u6e90\u8fd0\u7ef4\u81ea\u52a8\u5316\u5de5\u5177\uff0c\u901a\u8fc7Ansible\u53ef\u4ee5\u5b9e\u73b0\u8fd0\u7ef4\u81ea\u52a8\u5316\uff0c\u63d0\u9ad8\u8fd0\u7ef4\u5de5\u7a0b\u5e08\u7684\u5de5\u4f5c\u6548\u7387\uff0c\u51cf\u5c11\u4eba\u4e3a\u5931\u8bef\u3002</p> <p>Ansible \u901a\u8fc7\u672c\u8eab\u96c6\u6210\u7684\u975e\u5e38\u4e30\u5bcc\u7684\u6a21\u5757\u53ef\u4ee5\u5b9e\u73b0\u5404\u79cd\u7ba1\u7406\u4efb\u52a1\uff0c\u5176\u81ea\u5e26\u6a21\u5757\u8d85\u8fc7\u4e0a\u5343\u4e2a\u3002\u66f4\u4e3a\u91cd\u8981\u7684\u662f\uff0c\u5b83\u64cd\u4f5c\u975e\u5e38\u7b80\u5355\uff0c\u5373\u4f7f\u5c0f\u767d\u4e5f\u53ef\u4ee5\u8f7b\u677e\u4e0a\u624b\uff0c\u4f46\u5b83\u63d0\u4f9b\u7684\u529f\u80fd\u53c8\u975e\u5e38\u4e30\u5bcc\uff0c\u5728\u8fd0\u7ef4\u9886\u57df\uff0c\u51e0\u4e4e\u53ef\u4ee5\u505a\u4efb\u4f55\u4e8b\u3002</p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p>"},{"location":"chap4/11Ansible_task1/","title":"L11 \u4efb\u52a1\u4e2d\u5fc3\u4e4bAnsible\u57fa\u7840\u7bc7","text":""},{"location":"chap4/11Ansible_task1/#1-ansible","title":"1 ansible \u7b80\u4ecb\uff1a","text":"<p>Anasible \u662f\u57fa\u4e8e<code>Python2-Paramiko</code> \u6a21\u5757\u5f00\u53d1\u7684\u81ea\u52a8\u5316\u7ef4\u62a4\u5de5\u5177\uff0c\u5b9e\u73b0\u4e86\u6279\u91cf\u7cfb\u7edf\u914d\u7f6e\u3001\u90e8\u7f72\u3001\u8fd0\u884c\u7b49\u529f\u80fd\u3002Ansible\u662f\u57fa\u4e8e\u6a21\u5757\u5de5\u4f5c\u7684\uff0c\u672c\u8eab\u4e0d\u5177\u5907\u6279\u91cf\u90e8\u7f72\u7684\u529f\u80fd\uff0c\u5982\u679c\u60f3\u8981\u5b9e\u73b0\u6279\u91cf\u81ea\u52a8\u5316\u90e8\u7f72\uff0c\u662fAnsible\u81ea\u8eab\u7684\u5404\u79cd\u6a21\u5757\u7684\u96c6\u5408\u3002</p> <p>\u53ef\u4ee5\u4e0e Ansible \u540c\u53f0\u7ade\u6280\u7684\u8fd0\u7ef4\u5de5\u5177\uff08 pupet\u3001cfengine\u3001chef\u3001func\u3001fabric\u3001saltstack \uff09</p> <p>Ansible \u53d1\u5c55\u53f2</p> <ul> <li>ansible \u4f5c\u8005: Michael DeHaan \u540c\u65f6\u4ed6\u4e5f\u662f Cobbler \u4e0e Func \u4f5c\u8005\u3002</li> <li>2012-03-09 \u53d1\u5e03 0.0.1 \u7248\u672c\u3002</li> <li>2015-10-17 \u88ab Red Hat \u6536\u8d2d\u3002</li> <li>GitHub</li> </ul> <p>ansible \u7279\u6027</p> <ul> <li>Python \u5f00\u53d1</li> <li>\u6a21\u5757\u5316: \u8c03\u7528\u7279\u5b9a\u7684\u6a21\u5757(\u5982: Paramiko\u3001PyYAML\u3001jinja2 \u7b49), \u5b8c\u6210\u7279\u5b9a\u7684\u4efb\u52a1\u3002</li> <li>\u81ea\u5b9a\u4e49\u6a21\u5757</li> <li>\u7b80\u5355\u90e8\u7f72</li> <li>\u652f\u6301\u7f16\u6392\u4efb\u52a1\uff08PlayBook\uff09</li> <li>\u51a5\u7b49\u6027: \u4efb\u52a1\u91cd\u590d\u6267\u884c\u7b49\u4e8e\u53ea\u6267\u884c\u4e00\u6b21, \u4e0d\u4f1a\u91cd\u590d\u6267\u884c\u591a\u6b21\u76f8\u540c\u547d\u4ee4\u3002</li> <li>\u652f\u6301\u591a\u8bed\u8a00\u7f16\u5199\u6a21\u5757</li> <li>YAML \u683c\u5f0f\u7f16\u6392\u4efb\u52a1,\u652f\u6301\u4e30\u5bcc\u7684\u6570\u636e\u7ed3\u6784.</li> </ul>"},{"location":"chap4/11Ansible_task1/#2ansible","title":"2\u3001Ansible \u67b6\u6784\u4e0e\u6267\u884c\u6d41\u7a0b","text":"<p><code>ansible</code> \u4e3b\u8981\u7ec4\u6210\u90e8\u5206:</p> <ul> <li><code>Users:</code> \u7ba1\u7406 <code>Ansible Playbook</code> \u548c <code>Ansible</code> \u5f15\u64ce\u3002</li> <li><code>Ansible playbook</code>: <code>Ansible</code> \u5f15\u64ce\u548c<code>CMDB</code>\u505a\u4ea4\u4e92\u3002</li> <li><code>Public or Private cloud</code>: \u4fbf\u4e8e\u6240\u6709\u6a21\u5757 \u548c <code>API</code>\u4ee5\u53ca\u4e91\u7684\u4ea4\u4e92\u3002</li> <li><code>Inventory:</code> Ansible \u6267\u884c\u4e3b\u673a\u7684\u5217\u8868\u6e05\u5355\uff0c\u9ed8\u8ba4\u8bfb\u53d6\u914d\u7f6e\u4e3a<code>/etc/ansible/host</code>\u3002</li> <li><code>API</code>: \u63d0\u4f9b\u7aef\u5230\u7aef\u4ea4\u4e92\u7684API\u63a5\u53e3\u3002</li> <li><code>Modules</code> Ansible \u6267\u884c\u547d\u4ee4\u7684\u529f\u80fd\u6a21\u5757, \u4e00\u822c\u4e3a <code>Ansible</code> \u5185\u7f6e\u6a21\u5757, \u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b2c\u4e09\u65b9\u6a21\u5757\u3002</li> <li><code>Plugins</code>: \u7528\u4e8e\u8865\u5145\u6a21\u5757\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u81ea\u884c\u7f16\u5199\u63d2\u4ef6\u3002</li> </ul>"},{"location":"chap4/11Ansible_task1/#3ansible","title":"3\u3001Ansible \u5b89\u88c5","text":"<pre><code># Centos\nyum -y install ansible\n\n# Ubuntu\napt install -y ansible\n\n# \u6e90\u7801\u5b89\u88c5\ngit clone https://github.com/ansible/ansible \n\n# \u4f7f\u7528 pip \u547d\u4ee4\u5b89\u88c5\npip install ansible\n</code></pre>"},{"location":"chap4/11Ansible_task1/#4ansible","title":"4\u3001Ansible \u914d\u7f6e\u8bf4\u660e:","text":"<ul> <li><code>/etc/ansible/ansible.cfg</code> \u4e3b\u914d\u7f6e\u6587\u4ef6, \u914d\u7f6e<code>ansible</code>\u7684\u5de5\u4f5c\u7279\u6027.</li> <li><code>/etc/ansible/hosts</code> \u4e3b\u673a\u5217\u8868\u6e05\u5355.</li> <li><code>/etc/ansible/roles/</code> \u5b58\u653e(roles)\u89d2\u8272\u7684\u76ee\u5f55.</li> <li><code>/usr/local/bin/ansible</code> \u4e8c\u8fdb\u5236\u6267\u884c\u6587\u4ef6, ansible \u4e3b\u7a0b\u5e8f.</li> <li><code>/usr/local/bin/ansilbe-doc</code> \u914d\u7f6e\u6587\u6863, \u6a21\u5757\u529f\u80fd\u67e5\u770b\u5de5\u5177.</li> <li><code>/usr/local/bin/ansible-galaxy</code> \u7528\u4e8e\u4e0a\u4f20/\u4e0b\u8f7d roles \u6a21\u5757\u5230\u5b98\u65b9\u5e73\u53f0\u7684\u5de5\u5177.</li> <li><code>/usr/local/bin/ansible-playbook</code> \u81ea\u52a8\u5316\u4efb\u52a1\u3001\u7f16\u6392\u5267\u672c\u5de5\u5177<code>/usr/bin/ansible-pull</code> \u8fdc\u7a0b\u6267\u884c\u547d\u4ee4\u7684\u5de5\u5177.</li> <li><code>/usr/local/bin/ansible-vault</code> \u6587\u4ef6(\u5982: <code>playbook</code> \u6587\u4ef6) \u52a0\u5bc6\u5de5\u5177.</li> <li><code>/usr/local/bin/ansible-console</code> \u57fa\u4e8e \u754c\u9762\u7684\u7528\u6237\u4ea4\u4e92\u6267\u884c\u5de5\u5177.</li> </ul>"},{"location":"chap4/11Ansible_task1/#4-1-etcansiblehosts","title":"4-1 <code>/etc/ansible/hosts</code>","text":"<p>\u521b\u5efa<code>SSH</code>\u79d8\u94a5 <code>ssh-keygen -t rsa -C \"deniss.wang\"</code> \u62f7\u8d1d\u516c\u94a5\u5230\u5176\u4ed6\u88ab\u670d\u52a1\u5668 <code>ssh-copy-id -i ubuntu@ubuntu20-bj01</code></p>"},{"location":"chap4/11Ansible_task1/#4-2-hosts","title":"4-2 <code>hosts</code>","text":"<pre><code>[codo-cluster]\ndemo.opendevops.cn ansible_ssh_user=root\nwww.opendevops.cn ansible_ssh_user=root\n\n[k3s-cluster]\nubuntu20-bj01 ansible_user=ubuntu\nubuntu20-bj02 ansible_user=ubuntu\nubuntu20-bj03 ansible_user=ubuntu\nubuntu20-sh04 ansible_user=ubuntu\n</code></pre> <ul> <li><code>-m</code> \u6307\u5b9a\u6a21\u5757\u6267\u884c\u3002\u5982\uff1aping\u3001yum\u3001copy\u3001file\u7b49\uff0c\u6b64\u5904\u4f7f\u7528\u6a21\u5757ping\u6d4b\u8bd5\u3002</li> <li><code>-k</code> \u4f7f\u7528\u5bc6\u7801\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u662f\u4f7f\u7528<code>SSH-KEY</code>\u767b\u5f55\u3002</li> </ul> <p>\u57fa\u672c\u793a\u4f8b\uff1a</p> <pre><code># ansible \u901a\u8fc7 \u5355\u4e3b\u673a\u8fdb\u884c\u64cd\u4f5c ( -k \u4e3a\u7528\u6237\u5bc6\u7801\u65b9\u5f0f, \u9ed8\u8ba4\u4e3a ssh-key )\nansible 10.0.8.2 -m ping -k\n\n# ansible \u901a\u8fc7 ':' \u7ec4\u5408\u8fdb\u884c\u64cd\u4f5c\nansible \"10.0.8.2:10.0.8.3\" -m ping -k\n\n# ansible \u901a\u8fc7 \u901a\u914d\u7b26\u52a0\u4e3b\u673a \u8fdb\u884c\u64cd\u4f5c\nansible 10.0.8.* -m ping -k\n\n# ansible \u901a\u8fc7 hosts \u7ec4\u540d\u79f0 \u8fdb\u884c\u64cd\u4f5c\nansible codo -m ping -k\n\n# ansible \u901a\u8fc7 ':' \u7ec4\u5408\u7ec4\u8fdb\u884c\u64cd\u4f5c\nansible 'codo-cluster:k3s-cluster' -m ping -k\n\n# ansible \u901a\u8fc7 \u901a\u914d\u7b26 \u8fdb\u884c\u64cd\u4f5c\nansible '*-cluster' -m ping -k\n\n# ansible \u901a\u8fc7 ':&amp;' \u903b\u8f91\u4e0e (\u4e24\u4e2a\u7ec4\u4e2d\u90fd\u5305\u542b\u7684\u4e3b\u673a)\nansible 'codo-cluster:&amp;k3s-cluster' -m ping -k\n\n# ansible \u901a\u8fc7 ':!' \u903b\u8f91\u975e (codo-cluster \u4f46\u4e0d\u5728 k3s-cluster\u7684\u4e3b\u673a)\nansible 'codo-cluster:!k3s-cluster' -m ping -k\n\n# ansible \u4e5f\u652f\u6301\u591a\u903b\u8f91\u7684\u7ec4\u5408\nansible 'webservers:dbserver:&amp;appserver:!ftpservers' -m ping -k\n\n# ansible \u4e5f\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\nansible '~(codo|k3s)-cluster' -m ping -k\n\n# ansible \u901a\u8fc7 all \u5bf9 hosts \u6e05\u5355\u4e0b\u6240\u6709\u4e3b\u673a\u8fdb\u884c\u64cd\u4f5c\nansible all -m ping -k\n\n# ansible \u901a\u8fc7 \u901a\u914d\u7b26 \u5bf9 hosts \u6e05\u5355\u4e0b\u6240\u6709\u4e3b\u673a\u8fdb\u884c\u64cd\u4f5c\nansible '*' -m ping -k\n</code></pre> <p>\u6267\u884c\u7ed3\u679c\uff1a</p> <pre><code># ansible k3s -m 'ping'                                                                                     \nubuntu20-bj03 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nubuntu20-bj02 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nubuntu20-bj01 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nubuntu20-sh04 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n</code></pre>"},{"location":"chap4/11Ansible_task1/#4-3-etcansibleansiblecfg","title":"4-3 <code>/etc/ansible/ansible.cfg</code>","text":"<pre><code># defaults \u4e3a\u9ed8\u8ba4\u914d\u7f6e\n[defaults]\n\n# \u4e3b\u673a\u6e05\u5355\u7684\u8def\u5f84, \u9ed8\u8ba4\u4e3a\u5982\u4e0b\n# inventory = /etc/ansible/hosts\n\n# \u6a21\u5757\u5b58\u653e\u7684\u8def\u5f84 \n# library = /usr/share/my_modules/\n\n# utils \u6a21\u5757\u5b58\u653e\u8def\u5f84\n# module_utils = /usr/share/my_module_utils/\n\n# \u8fdc\u7a0b\u4e3b\u673a\u811a\u672c\u4e34\u65f6\u5b58\u653e\u76ee\u5f55\n# remote_tmp = ~/.ansible/tmp\n\n# \u7ba1\u7406\u8282\u70b9\u811a\u672c\u4e34\u65f6\u5b58\u653e\u76ee\u5f55 \n# local_tmp = ~/.ansible/tmp\n\n# \u63d2\u4ef6\u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\n# plugin_filters_cfg = /etc/ansible/plugin_filters.yml\n\n# \u6267\u884c\u5e76\u53d1\u6570\n# forks = 5\n\n# \u5f02\u6b65\u4efb\u52a1\u67e5\u8be2\u95f4\u9694 \u5355\u4f4d\u79d2\n# poll_interval  = 15\n\n# sudo \u6307\u5b9a\u7528\u6237\n# sudo_user = root\n\n# \u8fd0\u884c ansible \u662f\u5426\u63d0\u793a\u8f93\u5165sudo\u5bc6\u7801\n# ask_sudo_pass = True\n\n# \u8fd0\u884c ansible \u662f\u5426\u63d0\u793a\u8f93\u5165\u5bc6\u7801 \u540c -k\n# ask_pass = True\n\n# \u8fdc\u7a0b\u4f20\u8f93\u6a21\u5f0f\n# transport = smart\n\n# SSH \u9ed8\u8ba4\u7aef\u53e3\n# remote_port = 22\n\n# \u6a21\u5757\u8fd0\u884c\u9ed8\u8ba4\u8bed\u8a00\u73af\u5883\n# module_lang = C\n\n# roles \u5b58\u653e\u8def\u5f84\n# roles_path = /etc/ansible/roles\n\n# \u4e0d\u68c0\u67e5 /root/.ssh/known_hosts \u6587\u4ef6 \u5efa\u8bae\u53d6\u6d88\n# host_key_checking = False\n\n# ansible \u64cd\u4f5c\u65e5\u5fd7\u8def\u5f84 \u5efa\u8bae\u6253\u5f00\n# log_path = /var/log/ansible.log\n</code></pre> <p>ansible\u6267\u884c\u8fc7\u7a0b</p> <ul> <li>load\u914d\u7f6e\u6587\u4ef6 <code>/etc/ansible/ansible.cfg</code></li> <li>Load \u6a21\u5757\u914d\u7f6e\u6587\u4ef6</li> <li>\u901a\u8fc7 Ansible \u5c06\u8c03\u7528\u7684\u6a21\u5757\u6216PlayBook\u751f\u6210\u5bf9\u5e94\u7684\u4e34\u65f6 py\u6587\u4ef6, \u5e76\u5c06\u8be5\u4e34\u65f6\u6587\u4ef6\u4f20\u8f93\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668\u7684\u5bf9\u7684\u6267\u884c\u7528\u6237\u76ee\u5f55\u4e0b <code>$HOME/.ansible/tmp/ansible-tmp-2123/xxxxxxx.py &gt;\u6587\u4ef6</code>.</li> <li>\u5bf9\u751f\u6210\u7684\u6587\u4ef6\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650.</li> <li>\u6267\u884c\u751f\u6210\u6587\u4ef6\uff0c\u5e76\u8fd4\u56de\u5bf9\u5e94\u7684\u7ed3\u679c.</li> <li>\u5220\u9664\u751f\u6210\u6587\u4ef6\uff0c\u9000\u51fa.<ul> <li>\u6267\u884c\u8fd4\u56de\u72b6\u6001\uff1a<ul> <li>\u7eff\u8272\uff1a\u6267\u884c\u6210\u529f\uff0c\u65e0\u66f4\u6539\u64cd\u4f5c\u3002\u5982 ping\u6a21\u5757</li> <li>\u9ec4\u8272\uff1a\u6267\u884c\u6210\u529f\uff0c\u66f4\u65b0\u8fc7\u4e3b\u673a\u7684\u64cd\u4f5c\u3002\u5982\u6267\u884cshell\u6a21\u5757\u6267\u884cifconfig\u547d\u4ee4\u3002</li> <li>\u7ea2\u8272\uff1a\u6267\u884c\u5931\u8d25\u8fd4\u56de\u7ed3\u679c\u3002\u5982FAILED\u3001UNREACHABLE\u72b6\u6001\u3002</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap4/11Ansible_task1/#4-4-ansible-doc","title":"4-4 Ansible-Doc","text":"<p>\u4f7f\u7528\u53c2\u6570\uff1a</p> <ul> <li><code>-l</code> <code>--list</code> \u663e\u793a\u53ef\u7528\u6a21\u5757</li> <li><code>-s`` --snippet</code> \u663e\u793a\u6307\u5b9a\u6a21\u5757\u7684 <code>playbook</code> \u9636\u6bb5</li> </ul> <p>Demo</p> <pre><code># Demo\nansible-doc -l\n\n# ...\u7565\u8fc7\nansible-doc ping\n\n# \u6a21\u5757ping\u663e\u793a\u6587\u6863\nansible-doc -s ping\n</code></pre>"},{"location":"chap4/11Ansible_task1/#4-5-ansible","title":"4-5 Ansible","text":"<p><code>ansible &lt;host-pattern&gt; [-m module_name] [-a args]</code></p> <ul> <li><code>host-pattern</code>: \u4e3b\u673aip\u3001\u4e3b\u673a\u540d\u3001\u4e3b\u673a\u7ec4\u3002</li> <li><code>module_name</code>: \u6a21\u5757\u7684\u540d\u79f0\u3002\u9ed8\u8ba4\u4e3a<code>-m command</code> \u3002</li> <li><code>args</code>: \u6a21\u5757\u7684\u53c2\u6570, \u9700\u8981\u52a0\u4e0a -a \u8fdb\u884c\u6307\u5b9a\u6a21\u5757\u7684\u53c2\u6570\u3002\u5982: <code>ansible all -a \u2018hostname\u2019</code></li> <li><code>-v</code>\u3001<code>-vv</code>\u3001<code>-vvv</code>: \u663e\u793a\u8be6\u7ec6\u7684\u547d\u4ee4\u8f93\u51fa\u65e5\u5fd7, v \u8d8a\u591a\u8d8a\u8be6\u7ec6\u3002\u5982: ansible all -m ping -vvv</li> <li><code>--list</code>: \u663e\u793a\u4e3b\u673a\u7684\u5217\u8868\u3002\u5982: <code>ansible all --list</code></li> <li><code>-k</code> / <code>--ask-pass</code>: \u63d0\u793a\u8f93\u5165ssh\u8fde\u63a5\u5bc6\u7801, \u9ed8\u8ba4\u4e3a <code>ssh-key</code>\u8ba4\u8bc1\u3002\u5982: <code>ansible all -m ping -k</code></li> <li><code>-K / --ask-become-pass</code>: \u63d0\u793a\u8f93\u5165 sudo \u7684\u5bc6\u7801\u3002</li> <li><code>-C / --check</code>: \u68c0\u67e5\u547d\u4ee4\u64cd\u4f5c, \u5e76\u4e0d\u4f1a\u6267\u884c\u3002\u5982: <code>ansible all -m ping -C</code></li> <li><code>-T / --timeout</code>: \u6267\u884c\u547d\u4ee4\u7684\u8d85\u65f6\u65f6\u95f4, \u9ed8\u8ba4\u4e3a 10s\u3002\u5982: <code>ansible all -m ping -T=2</code></li> <li><code>-u / --user:</code> \u6267\u884c\u8fdc\u7a0b\u64cd\u4f5c\u7684\u7528\u6237. \u5982:<code>ansible all -m ping -u=roo</code>t</li> <li><code>-b / --become</code>: \u4ee3\u66ff\u65e7\u7248\u7684 <code>sudo</code> \u5207\u6362\u3002</li> </ul>"},{"location":"chap4/11Ansible_task1/#5ansible","title":"5\u3001ansible \u5e38\u7528\u6a21\u5757","text":""},{"location":"chap4/11Ansible_task1/#5-1-command","title":"5-1 command \u6a21\u5757","text":"<p>\u5728\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u6267\u884c\u547d\u4ee4, \u652f\u6301\u6761\u4ef6\u5224\u65ad. ansible \u9ed8\u8ba4\u6a21\u5757, \u53ef\u5ffd\u7565 <code>-m</code> \u53c2\u6570\u76f4\u63a5\u64cd\u4f5c.</p> <p>\u6ce8\u610f: command \u6a21\u5757 \u4e0d\u652f\u6301 <code>$VARNAME &lt; &gt; | ; &amp;</code> \u7b49\u7b26\u53f7.</p> <p>Demo</p> <pre><code># \u505c\u6b62docker\u670d\u52a1\n\nansible k3s-cluster -m command -a 'systemctl stop docker'\n\n# \u67e5\u770b\u6240\u6709docker\u955c\u50cf\n\nansible k3s-cluster -a 'docker ps -a'\n\n# \u5982\u679c /opt/ansible \u4e0d\u5b58\u5728 \u5c31\u4e0d\u6267\u884c df -h \u64cd\u4f5c, \u5982\u679c /opt/ansible \u5b58\u5728, \u5c31\u6267\u884c df -h \u64cd\u4f5c.\n\nansible k3s-cluster -a 'removes=/mnt/ansible df -h'\n\n\n# \u5982\u679c /opt/ansible \u4e0d\u5b58\u5728 \u5c31\u6267\u884c df -h \u64cd\u4f5c, \u5982\u679c\u5b58\u5728 /opt/ansible \u5c31\u4e0d\u6267\u884c df -h \u64cd\u4f5c.\n\nansible k3s-cluster -a 'creates=/mnt/ansible df -h'\n\n# \u5207\u6362\u76ee\u5f55, \u7b49\u540c\u4e8e cd /mtn &amp;&amp; ls -lt \u64cd\u4f5c\n\nansible k3s-cluster -a 'chdir=/mnt ls -lt'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-2-shell","title":"5-2 shell \u6a21\u5757","text":"<p>shell \u6a21\u5757: shell \u6a21\u5757\u652f\u6301 command \u6240\u6709\u7684\u64cd\u4f5c, \u800c\u4e14\u652f\u6301<code>$VARNAME &lt; &gt; | ; &amp;</code>\u7b49\u7b26\u53f7\u64cd\u4f5c.</p> <p>Demo:</p> <pre><code># \u67e5\u770bdocker\u8fdb\u7a0b\nansible k3s-cluster -m shell -a 'ps -ef|grep docker'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-3-scripts","title":"5-3 scripts \u6a21\u5757","text":"<p><code>script \u6a21\u5757</code>: \u6267\u884c\u811a\u672c. \u53ea\u9700\u8981\u8c03\u7528 ansible \u7684\u5bbf\u4e3b\u673a\u5b58\u653e\u7684\u811a\u672c\u6587\u4ef6\u5c31\u53ef\u4ee5\u5728\u9009\u62e9\u4e3b\u673a\u4e0a\u9762\u6267\u884c\u811a\u672c.</p> <p>Demo</p> <pre><code># shell\ncat /tmp/deniss.sh                                                                                                                               \n#!/bin/bash\necho \"\u6d4b\u8bd5 shell\"\nansible k3s-cluster -m script -a '/tmp/deniss.sh'\n\n# python\ncat /tmp/deniss.py\n#!/usr/bin/python\nimport sys\n\nprint ('Deniss_Wang' )\nprint (sys.version)\nansible k3s-cluster -m script -a '/tmp/deniss.py'\n\n# \u5176\u4ed6\u811a\u672c\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u597d\u73af\u5883\u8bed\u8a00\u89e3\u91ca\u5373\u53ef\u3002 \n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-4-copy","title":"5-4 copy \u6a21\u5757","text":"<p><code>copy</code> \u6a21\u5757: \u590d\u5236ansible\u5bbf\u4e3b\u673a\u6587\u4ef6\u5230\u76ee\u6807\u4e3b\u673a.</p> <p>Demo</p> <pre><code># src=\"\" \u5bbf\u4e3b\u673a\u8def\u5f84 dest=\"\" \u76ee\u6807\u4e3b\u673a\u8def\u5f84 backup=yes \u5982\u679c\u76ee\u6807\u4e3b\u673a\u6587\u4ef6\u5b58\u5728, \u4f1a\u5907\u4efd, \u518d\u8986\u76d6.\nansible k3s-cluster -m copy -a \u2018src=/tmp/deniss.py dest=/tmp/deniss.py backup=yes\n\n# mode=\"\" \u4fee\u6539\u6743\u9650\uff0c owner=\"\" \u4fee\u6539\u7528\u6237\uff0c group=\"\" \u4fee\u6539\u7528\u6237\u7ec4\nansible k3s-cluster -m copy -a 'src=/root/deniss.py dest=/root/deniss.py mode=0644 owner=deniss group=deniss'\n\n# content=\"\" \u5c06\u5185\u5bb9\u5199\u5165\u5230\u76ee\u6807\u6587\u4ef6\u4e2d\nansible k3s-cluster -m copy -a 'content=\"hello\\nworld\\n\" dest=/tmp/deniss.txt'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-5-fetch","title":"5-5 Fetch \u6a21\u5757","text":"<p><code>fetch</code> \u6a21\u5757: \u5c06\u76ee\u6807\u8fdc\u7a0b\u4e3b\u673a\u7684\u6587\u4ef6, \u4e0b\u8f7d\u5230\u672c\u5730, \u4e0b\u8f7d\u6210\u529f\u4f1a\u5b58\u653e\u5728\u4ee5 IP/NAME\u7684\u76ee\u5f55\u4e2d, \u5305\u542b\u539f\u6587\u4ef6\u7684\u6574\u4f53\u8def\u5f84.</p> <p>\u6ce8\u610f\uff1a\u53ea\u80fd\u4e0b\u8f7d\u5355\u4e2a\u6587\u4ef6, \u4e0d\u652f\u6301\u76ee\u5f55, \u60f3\u4e0b\u8f7d\u5b8c\u6574\u8def\u5f84\uff0c\u53ef\u4ee5\u538b\u7f29\u540e\u5728\u4e0b\u8f7d\u3002</p> <pre><code># src=\"\" \u76ee\u6807\u8fdc\u7a0b\u4e3b\u673a\u7684\u6587\u4ef6\u8def\u5f84 dest=\"\" \u672c\u5730\u76ee\u5f55\nansible k3s-cluster -m fetch -a 'src=/var/log/syslog dest=/tmp/'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-6-file","title":"5-6 file \u6a21\u5757","text":"<p>file \u6a21\u5757: \u64cd\u4f5c\u8fdc\u7a0b\u76ee\u6807\u4e3b\u673a\u7684\u6587\u4ef6. \u5982: touch\u3001 absent \u7b49.</p> <p>Demo</p> <pre><code># mode=\"\" \u4fee\u6539\u6743\u9650 owner=\"\" \u4fee\u6539\u7528\u6237 group=\"\" \u4fee\u6539\u7528\u6237\u7ec4 recurse=yes \u9012\u5f52\u6388\u6743\nansible k3s-cluster -m file -a 'name=/tmp/deniss.txt owner=ubuntu group=ubuntu mode=0755 recurse=yes'\n\n# dest\u3001name\u3001path: \u6307\u5b9a\u8fdc\u7a0b\u4e3b\u673a\u7684\u6587\u4ef6\u8def\u5f84\uff0cstate: \u6587\u4ef6\u64cd\u4f5c\u7c7b\u578b,\u9ed8\u8ba4\u4e3a absent\uff0ctouch: \u521b\u5efa\u7a7a\u6587\u4ef6. \nansible k3s-cluster -m file -a 'name=/tmp/deniss.txt state=touch'\n\n# directory: \u521b\u5efa\u6587\u4ef6\u5939\uff0c absent: \u9012\u5f52\u5220\u9664\u6587\u4ef6\u5939/\u6587\u4ef6\uff0clink: \u521b\u5efa\u8f6f\u8fde\u63a5.\nansible k3s-cluster -m file -a 'src=/tmp/deniss.txt dest=/tmp/deniss.link s\n</code></pre>"},{"location":"chap4/11Ansible_task1/#5-7-cron","title":"5-7 Cron \u6a21\u5757","text":"<p>cron \u6a21\u5757: \u4e3a\u8fdc\u7a0b\u4e3b\u673a\u6dfb\u52a0\u5b9a\u65f6\u4efb\u52a1</p> <ul> <li>day: \u8868\u793a \u5929. \u652f\u6301 ( <code>1-31, *, */2</code>) \u5199\u6cd5</li> <li>hour: \u8868\u793a \u5c0f\u65f6. \u652f\u6301 ( <code>0-23, *, */2</code>) \u5199\u6cd5</li> <li>minute: \u8868\u793a \u5206\u949f. \u652f\u6301 ( <code>0-59, *, */2</code> ) \u5199\u6cd5</li> <li>month: \u8868\u793a \u6708. \u652f\u6301 (<code>1-12, *, */2</code>) \u5199\u6cd5</li> <li>weekday: \u8868\u793a \u661f\u671f. \u652f\u6301 ( <code>0-6, Sunday-Saturday, *</code> )\u5199\u6cd5</li> <li>job: \u8868\u793a \u8ba1\u5212\u4efb\u52a1\u7684\u5185\u5bb9.</li> <li>name: \u8868\u793a \u8ba1\u5212\u4efb\u52a1\u540d\u79f0. \u76f8\u540c\u7684\u8ba1\u5212\u4efb\u52a1\u540d\u79f0\u4f1a\u8986\u76d6.</li> </ul> <p>Demo</p> <pre><code># day: \u8868\u793a \u5929. \u652f\u6301 ( 1-31, *, */2 ) \u5199\u6cd5\n# hour: \u8868\u793a \u5c0f\u65f6. \u652f\u6301 ( 0-23, *, */2 ) \u5199\u6cd5\n# minute: \u8868\u793a \u5206\u949f. \u652f\u6301 ( 0-59, *, */2 ) \u5199\u6cd5\n# month: \u8868\u793a \u6708. \u652f\u6301 ( 1-12, *, */2 ) \u5199\u6cd5\n# weekday: \u8868\u793a \u661f\u671f. \u652f\u6301 ( 0-6, Sunday-Saturday, * )\u5199\u6cd5\n# job: \u8868\u793a \u8ba1\u5212\u4efb\u52a1\u7684\u5185\u5bb9.\n# name: \u8868\u793a \u8ba1\u5212\u4efb\u52a1\u540d\u79f0. \u76f8\u540c\u7684\u8ba1\u5212\u4efb\u52a1\u540d\u79f0\u4f1a\u8986\u76d6.\nansible k3s-cluster -m cron -a 'weekday=1-5 job=\"echodate&gt;&gt; /tmp/1.txt\" name=echocron'\n\n# disabled= (true/false\u3001yes/no)\u6ce8\u91ca\u6389\u8ba1\u5212\u4efb\u52a1 \u5173\u95ed\u3001\u542f\u52a8\u8ba1\u5212\u4efb\u52a1 \u5fc5\u987b\u6307\u5b9ajob\u548cname.\nansible k3s-cluster -m cron -a 'disabled=true job=\"echodate&gt;&gt; /root/1.txt\" name=echocron'\n\n# state=absent \u5220\u9664\u8ba1\u5212\u4efb\u52a1\u3002\nansible k3s-cluster -m cron -a 'name=echocron state=absent'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#6yum","title":"6\u3001Yum \u6a21\u5757","text":"<p><code>yum</code>\u6a21\u5757: \u5229\u7528 yum \u64cd\u4f5c\u8f6f\u4ef6\u5305, \u5982 \u5b89\u88c5\u3001\u67e5\u8be2\u3001\u5378\u8f7d\u7b49.</p> <p>Demo</p> <pre><code># name: \u8f6f\u4ef6\u5305\u7684\u540d\u79f0, \u6216\u8005rpm\u5305, \u8fdc\u7a0b\u670d\u52a1\u5668\u5fc5\u987b\u5b58\u5728 rpm \u5305. \u5b89\u88c5\u591a\u4e2a\u8f6f\u4ef6\u4f7f\u7528 ,\u53f7\u9694\u5f00. \u5982 name=nginx,php,mysql\n\n# state=\"present/installed/absent/removed\"\n# present\u3001installed: \u5b89\u88c5\u8f6f\u4ef6.\n# absent\u3001removed: \u5378\u8f7d/\u5220\u9664\u8f6f\u4ef6.\n# update_cache=yes: \u66f4\u65b0 yum \u7f13\u5b58\u540e \u5728\u5b89\u88c5\u8f6f\u4ef6 disable_gpg_check=yes: \u7981\u7528 gpg \u68c0\u67e5.\nansible k3s-cluster -m yum -a 'name=mysql state=present'\nansible k3s-cluster -m yum -a 'name=/tmp/nginx-xx.x.x-x.x.x86_64.rpm'\nansible k3s-cluster -m yum -a 'name=nginx update_cache=yes disable_gpg_check=yes'\n\n# list=\"updates/installed/available/repos\" \u6307\u5b9a\u83b7\u53d6\u72b6\u6001\n# \u72b6\u6001\u91ca\u4e49: installed: \u5df2\u5b89\u88c5\u7684\u8f6f\u4ef6 updates: \u53ef\u4ee5\u5347\u7ea7\u7684\u8f6f\u4ef6 available: \u53ef\u4ee5\u5b89\u88c5\u7684\u8f6f\u4ef6 repos: yum \u6e90\nansible k3s-cluster -m yum -a 'list=installed'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#7service","title":"7\u3001Service \u6a21\u5757","text":"<p><code>service</code>: \u8f6f\u4ef6\u670d\u52a1\u7ba1\u7406\u6a21\u5757. \u542f\u52a8\u3001\u5173\u95ed\u3001\u91cd\u542f \u7b49\u64cd\u4f5c.</p> <pre><code># name=\"\"\uff0c\u5b89\u88c5\u540d\u5b57 \n# state=\"started/stopped/restarted/reloaded\" \u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u3001\u91cd\u8f7d\n# enable=\"yes/no\u3001true/false\" \u8bbe\u7f6e\u662f\u5426\u5f00\u673a\u81ea\u542f\nansible k3s-cluster -m service -a 'name=nginx state=started enabled=yes'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#8user","title":"8\u3001User \u6a21\u5757","text":"<p><code>user</code>: \u7ba1\u7406\u7cfb\u7edf\u7528\u6237\u7684\u6a21\u5757</p> <p>Demo</p> <pre><code># name\"\" \u7528\u6237\u540d\n# shell=\"\" \u6307\u5b9a\u7528\u6237\u7684shell\u7c7b\u578b\n# system=\"yes/no\" \u6307\u5b9a\u662f\u5426\u4e3a \u7cfb\u7edf\u7528\u6237\n# home=\"\" \u6307\u5b9a\u7528\u6237\u989d\u5916\u7684home\u76ee\u5f55, \u9ed8\u8ba4/home/user .\n# groups=\"\" \u7528\u6237\u989d\u5916\u7684 groups \u7ec4.\n# uid=\"\" \u6307\u5b9a\u7528\u6237\u7684UID.\n# comment=\"\" \u7528\u6237\u63cf\u8ff0\nansible k3s-cluster -m user -a 'name=deniss shell=/sbin/nologin system=yes home=/tmp/deniss groups=root uid=777 comment=\"deniss user\"'\n# state=\"present/absent\" \n# present: \u521b\u5efa\u7528\u6237 (\u9ed8\u8ba4\u4e3apresent) absent: \u5220\u9664\u7528\u6237\nansible k3s-cluster -m user -a 'name=deniss state=absent remove=yes'\nansible k3s-cluster -m user -a 'name=nginx state=absent remove=yes'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#9group","title":"9\u3001Group \u6a21\u5757","text":"<p>group: \u7ba1\u7406\u7cfb\u7edf\u7528\u6237\u7ec4\u7684\u6a21\u5757.</p> <p>Demo</p> <pre><code># name\"\" \u7528\u6237\u540d\n# system=\"yes/no\" \u6307\u5b9a\u662f\u5426\u4e3a \u7cfb\u7edf\u7528\u6237\n# home=\"\" \u6307\u5b9a\u7528\u6237\u989d\u5916\u7684home\u76ee\u5f55, \u9ed8\u8ba4/home/user .\n# gid=\"\" \u6307\u5b9aGID.\n# state=\"present/absent\" \n# present: \u521b\u5efa\u7528\u6237\u7ec4 (\u9ed8\u8ba4\u4e3apresent) absent: \u5220\u9664\u7528\u6237\u7ec4\n# \u521b\u5efa\nansible all -m group -a 'name=deniss system=yes gid=777'\n# \u5220\u9664\nansible all -m group -a 'name=deniss state=absent'\n</code></pre>"},{"location":"chap4/11Ansible_task1/#10ansible-galaxy","title":"10\u3001ansible-galaxy","text":"<p>\u5b98\u7f51 https://galaxy.ansible.com/</p> <p>ansible-galaxy \u5de5\u5177\u7528\u4e8e\u4e0b\u8f7d\u5bf9\u5e94\u7684roles</p> <pre><code># list \u67e5\u770b\u672c\u5730\u7684 roles \u89d2\u8272\u3002\nansible-galaxy list geerlingguy.nginx\n\n# install \u4e0b\u8f7d roles \u89d2\u8272\u5b58\u653e\u5230$HOME/.ansible/roles/\u76ee\u5f55\u4e0b\u3002\nansible-galaxy install geerlingguy.nginx\n\n# remove \u5220\u9664\u5df2\u4e0b\u8f7d\u7684 roles \u89d2\u8272\uff0c\u4e5f\u53ef\u4ee5\u5728\u5b58\u653e\u76ee\u5f55\u4e2d\u5220\u9664\u3002\nansible-galaxy remove geerlingguy.nginx\n</code></pre>"},{"location":"chap4/12Ansible_task2/","title":"L12 \u4efb\u52a1\u4e2d\u5fc3\u4e4bAnsible\u8fdb\u9636\u7bc7","text":""},{"location":"chap4/12Ansible_task2/#1ansible-playbook","title":"1\u3001<code>ansible-playbook</code>","text":"<p>playbook &amp; yml \u8bf4\u660e</p> <ul> <li>playbook \u7531\u4e00\u4e2a\u6216\u591a\u4e2a play \u7ec4\u6210.</li> <li>playbook \u4e2d \u6bcf\u4e2aplay \u5fc5\u987b\u5305\u542b hosts \u548c tasks.</li> <li>playbook \u4ee5 yaml \u8bed\u6cd5\u7f16\u5199.<ul> <li>\u53ef\u8bfb\u6027\u5f3a</li> <li>\u811a\u672c\u8bed\u8a00\u4ea4\u4e92\u6027\u80fd\u529b\u5f3a</li> <li>\u4f7f\u7528\u5b9e\u73b0\u8bed\u8a00\u7684\u6570\u636e\u7c7b\u578b</li> <li>\u4e00\u81f4\u6027\u7684\u4fe1\u606f\u6a21\u578b</li> <li>\u6613\u4e8e\u5b9e\u73b0</li> <li>\u57fa\u4e8e\u6d41\u6a21\u5f0f\u5904\u7406</li> <li>\u8868\u8fbe\u80fd\u529b\u597d, \u6269\u5c55\u6027\u5f3a</li> <li>YAML \u7ea6\u5b9a\u4ee5 <code>---</code> \u5f00\u5934 \u548c \u5f00\u59cb\u4e0d\u540c\u7684<code>play</code> .</li> <li>YAML \u4ee5 <code>#</code> \u4f5c\u4e3a\u6ce8\u91ca.</li> <li>YAML \u5fc5\u987b\u7edf\u4e00\u7f29\u8fdb, \u7a7a\u683c \u4e0e <code>tab</code> \u4e0d\u80fd\u6df7\u7528, \u7f29\u8fdb\u7684\u7ea7\u522b\u4e5f\u5fc5\u987b\u76f8\u540c, \u540c\u7ea7\u7f29\u8fdb\u4ee3\u8868\u540c\u6837\u7684\u7ea7\u522b.</li> <li>YAML \u6587\u4ef6\u5185\u5bb9 \u662f\u5927\u5c0f\u5199\u654f\u611f\u7684, \u8ddf <code>Linux</code>\u4e00\u6837\u533a\u5206\u5927\u5c0f\u5199.</li> <li>YAML <code>key/value</code> \u5f62\u5f0f\u53ef\u5199\u5728\u540c\u4e00\u884c\u4e5f\u53ef\u4ee5\u6362\u884c\u5199. \u540c\u884c\u4f7f\u7528 : \u9694\u5f00.</li> <li>YAML \u4e00\u4e2a\u5b8c\u6574\u7684\u4ee3\u7801\u5757\u529f\u80fd\u6700\u5c11\u5305\u542b2\u4e2a\u5143\u7d20. \u5982 <code>name: task</code></li> <li>YAML \u4e00\u4e2a name \u4e0b\u53ea\u80fd\u5305\u542b\u4e00\u4e2a task</li> <li>YAML - \u5f00\u5934\u7684\u4e3a\u5217\u8868,<code>key/value</code> \u5f62\u5f0f\u7684\u4e3a\u5b57\u5178.</li> <li>YAML \u7279\u6027</li> </ul> </li> </ul>"},{"location":"chap4/12Ansible_task2/#2playbook","title":"2\u3001playbook \u6838\u5fc3\u5143\u7d20","text":"<ul> <li>hosts \u8fdc\u7a0b\u4e3b\u673a\u5217\u8868 ( <code>ip_addr/hostname/groupname</code> )</li> <li>tasks \u4efb\u52a1\u96c6, \u4efb\u52a1\u5217\u8868, \u6709\u4e24\u79cd\u5199\u6cd5\u3002<ul> <li>action: module args action \u53c2\u6570\u3002</li> <li>module: args \u53c2\u6570 (\u4e00\u822c\u4f7f\u7528\u8fd9\u79cd)\u3002</li> <li><code>ignore_errors</code>: True \u5f53\u524d task \u51fa\u9519\u65f6\u4ecd\u7136\u4f1a\u5411\u4e0b\u6267\u884c\u3002</li> </ul> </li> <li>varniables \u5185\u7f6e\u53d8\u91cf\u6216\u81ea\u5b9a\u4e49\u53d8\u91cf\u5728 playbook \u6587\u4ef6\u4e2d\u8c03\u7528\u3002</li> <li>templates \u6a21\u677f\uff0c\u53ef\u66ff\u6362\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u53d8\u91cf\u5e76\u5b9e\u73b0\u4e00\u4e9b\u7b80\u5355\u903b\u8f91\u7684\u6587\u4ef6\u3002</li> <li>handles \u4e0e notity \u7ed3\u5408\u4f7f\u7528, \u7531\u7279\u5b9a\u6761\u4ef6\u89e6\u53d1\u7684\u64cd\u4f5c, \u6ee1\u8db3\u6761\u4ef6\u6267\u884c, \u5426\u5219\u4e0d\u6267\u884c\u3002</li> <li>tags \u6807\u7b7e \u6307\u5b9a\u4efb\u52a1\u6267\u884c, \u7528\u4e8e\u6267\u884c\u4e00\u4e2a playbook \u4e2d\u7684\u90e8\u5206\u4ee3\u7801. \u4e3b\u8981\u7528\u4e8e\u6d4b\u8bd5ansible\u7684\u8bed\u6cd5\u4e0e\u6267\u884c\u9a8c\u8bc1\u3002</li> </ul>"},{"location":"chap4/12Ansible_task2/#3ansible-playbook","title":"3\u3001<code>ansible-playbook</code>\u547d\u4ee4","text":"<p><code>ansible-playbook</code>     * <code>-C --check</code> Check \u68c0\u67e5\u811a\u672c\u8fd0\u884c\u60c5\u51b5, \u4e0d\u4f1a\u5728\u8fdc\u7a0b\u670d\u52a1\u5668\u91cc\u8fd0\u884c\u3002     * <code>--list-hosts</code> \u5217\u51fa\u6267\u884c\u6b64\u4efb\u52a1\u7684\u4e3b\u673a\u3002     * <code>--list-tasks</code> \u5217\u51fa\u4efb\u52a1\u7ec4\u7684\u5177\u4f53\u4efb\u52a1\u5217\u8868\u3002     * <code>--limit</code> \u53ea\u5bf9\u4e3b\u673a\u5217\u8868\u4e2d\u7684\u67d0\u53f0\u4e3b\u673a\u6267\u884c\u3002     * <code>-v -vv -vvv</code> \u663e\u793a\u8be6\u7ec6\u7684\u6267\u884cDEBUG\u4fe1\u606f\u8fc7\u7a0b, \u591a\u4e2av\u53c2\u6570\u7b49\u4e8eDEBUG\u4fe1\u606f\u7684\u53e0\u52a0\uff0c\u663e\u793a\u66f4\u4e3a\u8be6\u7ec6</p>"},{"location":"chap4/12Ansible_task2/#4ansible-playbook-setup","title":"4\u3001<code>ansible-playbook setup</code>","text":"<p>\u4ecb\u7ecd: \u8fd9\u4e2a\u6a21\u5757\u9ed8\u8ba4\u4f1a\u88ab<code>playbooks</code>\u81ea\u52a8\u8c03\u7528\uff0c\u7528\u4e8e\u6536\u96c6\u8fdc\u7a0b\u4e3b\u673a\u7684\u76f8\u5173\u53d8\u91cf\u4fe1\u606f\uff0c\u83b7\u53d6\u5230\u53d8\u91cf\u4fe1\u606f\u53ef\u4ee5\u88abplaybooks\u8c03\u7528\u3002\u9488\u5bf9 setup\u6a21\u5757\uff0c\u6211\u4eec\u7ecf\u5e38\u4f7f\u7528\u7684\u662f <code>fact</code> \uff0c\u5728\u6b64\u53ea\u5bf9<code>fact</code>\u505a\u8be6\u7ec6\u8bb2\u89e3\uff0c\u5176\u4ed6\u7684\u5c31\u4e0d\u8fc7\u591a\u53d9\u8ff0\u4e86\uff0c\u5982\u679c\u60f3\u4e86\u89e3\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u8bbf\u95ee\u5b98\u65b9\u6587\u6863\u83b7\u53d6\u5e2e\u52a9\u3002</p> <ul> <li><code>fact</code> \u662f<code>ansible</code>\u6a21\u5757<code>setup</code>\u7684\u529f\u80fd\uff0c\u4e3b\u8981\u7528\u4e8e\u83b7\u53d6\u76f8\u5173\u4fe1\u606f\u4f5c\u4e3a\u53d8\u91cf\u7ee7\u627f\u7ed9playbook\u5b50\u4efb\u52a1\u8c03\u7528\u3002</li> <li><code>gather_facts</code>:</li> </ul> <pre><code># ansible k3s-cluster -m setup\nubuntu20-bj03 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"ansible_all_ipv4_addresses\": [\n            \"10.0.16.4\"\n        ],\n        \"ansible_all_ipv6_addresses\": [\n            \"fe80::5054:ff:fed6:42a8\"\n        ],\n        \"ansible_apparmor\": {\n            \"status\": \"enabled\"\n        },\n        \"ansible_architecture\": \"x86_64\",\n        \"ansible_bios_date\": \"04/01/2014\",\n        \"ansible_bios_vendor\": \"SeaBIOS\",\n        \"ansible_bios_version\": \"seabios-1.9.1-qemu-project.org\",\n        \"ansible_board_asset_tag\": \"NA\",\n        \"ansible_board_name\": \"NA\",\n        \"ansible_board_serial\": \"NA\",\n        \"ansible_board_vendor\": \"NA\",\n        \"ansible_board_version\": \"NA\",\n        \"ansible_chassis_asset_tag\": \"NA\",\n        \"ansible_chassis_serial\": \"NA\",\n        \"ansible_chassis_vendor\": \"Smdbmds\",\n        \"ansible_chassis_version\": \"3.0\",\n\n        # \u591a\u4f59\u7684\u5197\u4f59\u4fe1\u606f\u5c31\u4e0d\u653e\u4e86\uff0c\u81ea\u5df1\u53ef\u4ee5\u6267\u884c\u9a8c\u8bc1\u4e0b\u3002\n        # setup\u83b7\u5f97\u53d8\u91cf\u4fe1\u606f\uff0c\u90fd\u53ef\u4ee5\u7528\u4e8e\u7ee7\u627f\u7ed9playbook\u8c03\u7528\u3002\n}\n</code></pre> <p>\u81ea\u5b9a\u4e49Fact</p> <p>\u624b\u52a8\u8bbe\u7f6e:</p> <p>ansible\u9664\u4e86\u80fd\u83b7\u53d6\u5230\u5185\u7f6e\u7684fact\u7684\u53d8\u91cf\u4fe1\u606f\uff0c\u8fd8\u53ef\u4ee5\u624b\u52a8\u4e3a\u67d0\u4e2a\u4e3b\u673a\u7ec4\u6216\u8005\u4e3b\u673a\u5b9a\u5236\u672c\u5730fact\u3002</p> <p>\u672c\u5730 <code>fact</code>\u9ed8\u8ba4\u5b58\u653e\u5bbf\u4e3b\u673a\u7684<code>/etc/ansible/facts.d</code>\u76ee\u5f55\u4e0b\uff0c\u652f\u6301\u7684\u6587\u4ef6\u683c\u5f0f\u4e3a<code>ini</code>\u3001<code>json</code>\u3002</p> <p>\u52a0\u8f7d\u540e\u7684fact\u7684key\u662f<code>ansible_local</code>\u7684\u7279\u6b8a\u53d8\u91cf\u3002</p> <p><code>denis_test.fact</code></p> <pre><code>[general]\npackage = vsftpd\nservice = vsftpd\nstate = starte\n</code></pre> <p><code>setup_facts.yaml</code></p> <pre><code>---\n- name: Install Remote Facts\n  hosts: k3s-cluster\n  vars: \n    remote_dir: /etc/ansible/facts.d\n    facts_file: denis_test.fact\n  tasks:\n    - name: Create Directory\n      file:\n        state: directory\n        recurse: yes\n        path: \"{{ remote_dir }}\"\n    - name: Install the new facts\n      copy:\n        src: \"{{ facts_file }}\"\n        dest: \"{{ remote_dir }}\"\n</code></pre> <p>\u6267\u884c\u6d4b\u8bd5</p> <pre><code># ansible-playbook setup_facts.yaml\n\n# ansible test -m setup        \nubuntu20-bj03 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n\n        # -----\u5206\u9694\u7b26-----\n\n        \"ansible_local\": {\n            \"custom\": {\n                \"general\": {\n                    \"package\": \"vsftpd\",\n                    \"service\": \"vsftpd\",\n                    \"state\": \"started\"\n                }\n            }\n        },\n\n        # -----\u5206\u9694\u7b26-----\n</code></pre> <p>\u8c03\u7528\u6d4b\u8bd5</p> <p><code>deniss_test.yaml</code></p> <pre><code>- name: Install Apache and starts the service\n  hosts: k3s-cluster\n  tasks:\n    - name: Install Package\n      yum: \n        name: \"{{ ansible_facts.ansible_local.custom.general.package }}\"\n        state: latest\n    - name: Start Service\n      service: \n        name: \"{{ ansible_facts.ansible_local.custom.general.service }}\"\n        state: \"{{ ansible_facts.ansible_local.custom.general.state }}\"\n</code></pre>"},{"location":"chap4/12Ansible_task2/#5ansible-playbook-set_fact","title":"5\u3001<code>ansible-playbook set_fact</code>","text":"<p>\u4f7f\u7528<code>set_fact</code>\u8bbe\u7f6e\u65b0\u7684\u53d8\u91cf</p> <ul> <li><code>set_fact</code>\u53ef\u4ee5\u81ea\u5b9a\u4e49\u53d8\u91cf\u901a\u8fc7template\u6216\u8005\u53d8\u91cf\u7684\u65b9\u5f0f\u5728playbook\u4e2d\u7ee7\u627f\u4f7f\u7528\u3002</li> <li>\u5982\uff1a\u5047\u8bbe\u4f60\u9700\u8981\u83b7\u53d6\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684\u5185\u5b58\u7684\u4f7f\u7528\u7387\uff0c\u5fc5\u987b\u901a\u8fc7<code>set_fact</code>\u6765\u8fdb\u884c\u8ba1\u7b97\u4e4b\u540e\u5f97\u51fa\u7ed3\u679c\uff0c\u5e76\u5c06\u5176\u503c\u5728playbook\u4e2d\u7ee7\u627f\u4f7f\u7528\u3002</li> </ul> <p><code>deniss_fact_demo.yaml</code></p> <pre><code>- name: set_fact demo\n  hosts: k3s-cluster\n  tasks:\n    - name: Calculate InnoDB buffer pool size\n      set_fact: innodb_buffer_pool_size_mb=\"{{ ansible_memtotal_mb / 2 |int }}\"      \n    - debug: var=innodb_buffer_pool_size_mb\n</code></pre> <p>\u6267\u884c\u6d4b\u8bd5</p> <pre><code># ansible-playbook deniss_fact_demo.yaml \nPLAY [set_fact demo] *****************************************************************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Calculate InnoDB buffer pool size] ************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [debug] ****************************************************************************************************************************************************************\nok: [ubuntu20-bj03] =&gt; {\n    \"innodb_buffer_pool_size_mb\": \"2911.2\"\n}\n\nPLAY RECAP ******************************************************************************************************************************************************************\nubuntu20-bj03                : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n</code></pre>"},{"location":"chap4/12Ansible_task2/#fact","title":"\u624b\u52a8\u91c7\u96c6 fact","text":"<p><code>gather_facts: False</code></p> <p>\u6211\u4eec\u5728\u8fd0\u884c<code>playbook</code>\u7684\u65f6\u5019\uff0cAnsible\u4f1a\u5148<code>ssh</code>\u8fde\u63a5\u88ab\u63a7\u7aef\u91c7\u96c6<code>fact</code>\uff0c\u5982\u679c\u88ab\u63a7\u5236\u7aef\u7684<code>ssh</code>\u8fd8\u6ca1\u6709\u5b8c\u6210\u8fd0\u884c\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6574\u4e2a<code>playbook</code>\u6267\u884c\u5931\u8d25\u3002</p> <p>\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u5148\u5728\u914d\u7f6e\u4e2d\u5173\u95ed<code>fact</code>\u91c7\u96c6\uff0c\u7136\u540e\u5728<code>task</code>\u4e2d\u901a\u8fc7<code>wait_for</code>\u63a2\u6d4b\u88ab\u63a7\u7aefssh\u7aef\u53e3\u662f\u5426\u6b63\u5e38\u76d1\u542c\uff0c\u7136\u540e\u5728task\u4e2d\u5728\u624b\u52a8setup\u6a21\u5757\u6765\u91c7\u96c6fact</p> <pre><code>- hosts: k3s-cluster\n  name: test demo \n  gather_facts: False\n  tasks\uff1a\n    - name: wait for ssh to be running\n      local_action: wait_for port=22 host=\"{{ inventory_hostname }}\" search_regex=OpenSSH\n    - name: gather facts\n      setup:\n</code></pre>"},{"location":"chap4/12Ansible_task2/#fact_1","title":"fact\u7f13\u5b58","text":"<p>\u5982\u679c\u5728playbook\u4e2d\u9700\u8981\u7ee7\u627ffact\uff0c\u53ef\u542f\u7528fact\u7f13\u5b58\u6765\u63d0\u9ad8\u6548\u7387\u3002</p> <p>fact\u652f\u6301\u7f13\u5b58 json\u3001memcached\u3001redis</p> <p>ansible.cfg\u4e2d\u7684\u914d\u7f6e\u8bf4\u660e:</p> <p>json \u4ee5json\u683c\u5f0f\u6587\u4ef6\u4f5c\u4e3afact\u7f13\u5b58\u540e\u7aef\uff0cansible\u5c06\u4f1a\u628a\u91c7\u96c6\u7684fact\u5199\u5165\u5230\u5bbf\u4e3b\u673a\u7684\u672c\u5730\u76ee\u5f55\uff0c\u6700\u597d\u662fSSD\u786c\u76d8\u3002</p> <p>redis \u4f7f\u7528redis\u505a\u7f13\u5b58\u3002</p> <p>memcached \u4f7f\u7528memcached\u505a\u7f13\u5b58\u3002</p> <ul> <li>smart \u8868\u793a\u9ed8\u8ba4\u6536\u96c6 facts\uff0c\u4f46 facts \u5df2\u6709\u7684\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u6536\u96c6\uff0c\u5373\u4f7f\u7528\u7f13\u5b58 facts\uff1b</li> <li>implicit \u8868\u793a\u9ed8\u8ba4\u6536\u96c6 facts\uff0c\u8981\u7981\u6b62\u6536\u96c6\uff0c\u5fc5\u987b\u4f7f\u7528 <code>gather_facts: False</code>\uff1b</li> <li>explicit \u5219\u8868\u793a\u9ed8\u8ba4\u4e0d\u6536\u96c6\uff0c\u8981\u663e\u5f0f\u6536\u96c6\uff0c\u5fc5\u987b\u4f7f\u7528 <code>gather_facts: Ture</code>\u3002</li> </ul> <pre><code>[defaults]\ngathering = smart\n# \u7f13\u5b58\u65f6\u95f4\nfact_caching_timeout = 86400    \nfact_caching = {jsonfile/redis/memcached}\n# \u6307\u5b9aansible\u5305\u542bfact\u7684json\u6587\u4ef6\u4f4d\u7f6e\uff0c\u5982\u679c\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\n# local\nfact_caching_connection = /tmp/ansible_fact_cache\n# redis\nfact_caching_connection = 127.0.0.1:6379:admin\n# memcached\nfact_caching_connection = ['127.0.0.1:11211']\n</code></pre>"},{"location":"chap4/12Ansible_task2/#fact_2","title":"\u5173\u95edfact\uff08\u63d0\u9ad8\u6267\u884c\u6548\u7387\uff09","text":"<p>\u5728\u914d\u7f6e\u4e2d\u5173\u95edfact\uff0c\u6574\u4e2aplaybookfact\u53d8\u91cf\u5c06\u4e0d\u4f1a\u5728\u663e\u793a\uff0c\u53ef\u4ee5\u63d0\u9ad8\u6267\u884c\u6548\u7387\uff0c\u4f46\u662f\u6709\u65f6\u5019\u53c8\u9700\u8981\u4f7f\u7528 facts \u4e2d\u7684\u4fe1\u606f\uff0c\u8fd9\u65f6\u5019\u53ef\u4ee5\u6309\u7167\u4e0a\u8ff0\u8bbe\u7f6e facts \u7684\u7f13\u5b58\uff0c\u5728\u7a7a\u95f2\u7684\u65f6\u5019\u6536\u96c6 facts\uff0c\u7f13\u5b58\u4e0b\u6765\uff0c\u5728\u9700\u8981\u7684\u65f6\u5019\u76f4\u63a5\u8bfb\u53d6\u7f13\u5b58\u8fdb\u884c\u5f15\u7528\u3002</p> <pre><code># playbook \u914d\u7f6e\n- hosts: k3s-cluster\n  gather_facts: no\n# ansible.cfg \u914d\u7f6e  \n[defaults]\ngathering = explicit\n</code></pre>"},{"location":"chap4/12Ansible_task2/#6ansible-playbook","title":"6\u3001<code>ansible-playbook</code> \u53d8\u91cf","text":"<p>\u53d8\u91cf\u540d\u8981\u6c42: \u53ea\u5141\u8bb8\u4f7f\u7528 \u5b57\u6bcd \u3001\u6570\u5b57 \u3001 <code>_</code> \u7ec4\u6210, \u800c\u4e14\u53ea\u80fd\u4ee5 \u5b57\u6bcd \u5f00\u5934\u3002</p> <p>\u5185\u7f6e\u7684\u516c\u5171\u53d8\u91cf:</p> <ul> <li><code>ansible k3s-cluster -m setup -a 'filter=*addresses*'</code>  \u53ef\u4f7f\u7528 <code>filter</code> \u53c2\u6570\u8fdb\u884c\u8fc7\u6ee4</li> <li>\u4f7f\u7528 <code>ansible k3s-cluster -m setup</code> \u53ef\u4ee5\u83b7\u53d6\u5230\u4e3b\u673a\u7684\u7cfb\u7edf\u53d8\u91cf\u540d\u79f0</li> </ul> <p>\u901a\u8fc7\u6587\u4ef6\u81ea\u5b9a\u4e49\u53d8\u91cf:</p> <ul> <li>\u5bf9\u4e3b\u673a\u7ec4\u4e2d\u7684\u4e3b\u673a\u5355\u72ec\u5b9a\u4e49\u53d8\u91cf, \u4f18\u5148\u7ea7\u9ad8\u4e8e\u516c\u5171\u53d8\u91cf\u3002</li> <li>\u5bf9\u4e3b\u673a\u7ec4\u4e2d\u7684\u6240\u6709\u4e3b\u673a\u5b9a\u4e49\u7edf\u4e00\u53d8\u91cf, \u4f18\u5148\u7ea7\u4f4e\u4e8e\u5bf9\u5355\u72ec\u4e3b\u673a\u5b9a\u4e49\u7684\u53d8\u91cf\u3002</li> <li><code>/etc/ansible/hosts</code> \u6587\u4ef6\u4e2d\u5b9a\u4e49</li> </ul> <pre><code>[appserver]\n# \u5b9a\u4e49\u53d8\u91cf node_id\n10.0.8.2 node_id=17\n\n# \u5bf9\u4e3b\u673a\u7ec4 \u5b9a\u4e49\u7edf\u4e00\u53d8\u91cf domain_name\n[k3s-cluster:vars]\ndomain_name=deniss.wang\n</code></pre> <p>\u4f7f\u7528\u53d8\u91cf\u7075\u6d3b\u914d\u7f6e\u4e0d\u540c\u4e3b\u673a\u7684 <code>hostname</code></p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: set hostname\n      hostname: name={{ node_id }}.{{ domain_name }}\n</code></pre> <p>\u901a\u8fc7\u547d\u4ee4\u884c\u5b9a\u4e49\u53d8\u91cf: \u901a\u8fc7\u547d\u4ee4\u884c\u5b9a\u4e49\u7684\u53d8\u91cf\u4f18\u5148\u7ea7\u662f\u6700\u9ad8\u7684</p> <pre><code>ansible-playbook -e varname=valur\n</code></pre> <p>\u5728 playbook \u6587\u4ef6\u91cc \u5b9a\u4e49\u53d8\u91cf.</p> <ul> <li>\u901a\u8fc7 <code>{{ \u53d8\u91cf\u540d }}</code> \u4f7f\u7528\u53d8\u91cf\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u6709\u4e2d\u6587\uff0c\u9700\u8981\u4f7f\u7528<code>\"\"</code>\u628a\u53d8\u91cf\u62ec\u8d77\u6765\u3002</li> <li>\u901a\u8fc7 <code>vars:</code> \u5217\u8868 \u5b9a\u4e49\u591a\u4e2a \u53d8\u91cf.</li> </ul> <pre><code>---\n- hosts: k3s-cluster\n  remote_user: root\n\n  # \u5b9a\u4e49\u53d8\u91cf\n  vars:\n    - pkg_name: httpd\n    - env_name: prod\n\n  tasks:\n    - name: {{ env_name }} install {{ pkg_name }}\n      yum: name={{ pkg_name }}\n</code></pre> <p>\u901a\u8fc7\u5b9a\u4e49\u5355\u72ec\u7684\u53d8\u91cf\u6587\u4ef6 \u7528\u4e8e\u7edf\u4e00\u5b58\u653e\u53d8\u91cf, \u53ef\u907f\u514d\u53d8\u91cf\u7684\u91cd\u590d\u5b9a\u4e49\u3002</p> <ul> <li>\u5b9a\u4e49\u5355\u72ec\u7684 \u53d8\u91cf\u6587\u4ef6, \u53ea\u9700\u8981\u5c06\u6240\u6709\u53d8\u91cf\u4ee5 <code>key: value</code> \u5f62\u5f0f\u5199\u5165\u5230 <code>yaml</code>\u6587\u4ef6\u4e2d\u65e2\u53ef\u3002</li> <li>\u5728 <code>playbook</code> \u6587\u4ef6\u4e2d, \u53ea\u9700\u8981\u4f7f\u7528 <code>vars_files:</code> \u6307\u5b9a yaml \u6587\u4ef6\u8def\u5f84\u65e2\u53ef\u3002</li> </ul> <p><code>vars.yaml</code> \u53d8\u91cf\u6587\u4ef6</p> <pre><code>---\npkg_name: httpd\nfile_name: deniss.wang\n</code></pre> <p><code>install.yaml</code></p> <pre><code>---\n- hosts: k3s-cluster\n  remote_user: root\n\n  # \u914d\u7f6e\u6a21\u677f\u6587\u4ef6\n  vars_files:\n    # \u6307\u5b9a\u6587\u4ef6\u7684\u8def\u5f84\n    - vars.yaml\n\n  tasks:\n    - name: install {{ pkg_name }}\n      yum: name={{ pkg_name }}\n    - name: create {{ file_name }} file\n      file: name=/tmp/{{ file_name }}.txt state=touch\n</code></pre> <p>\u6267\u884c playbook \u64cd\u4f5c</p> <pre><code># ansible-playbook install.yaml\nPLAY [k3s-cluster] *******************************************************************************************************\n\nTASK [Gathering Facts] *******************************************************************************************\nok: [10.0.8.2]\n\nTASK [install httpd] *********************************************************************************************\nchanged: [10.0.8.2]\n\nTASK [create deniss.wang file] **************************************************************************************\nchanged: [10.0.8.2]\n\nPLAY RECAP *******************************************************************************************************\n10.0.8.2                  : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#7-ansible-playbook-template","title":"7 ansible-playbook template","text":"<p><code>template</code> \u662f<code>ansible-playbook</code>\u4e00\u4e2a\u6a21\u5757\uff0c\u7528\u4e8e\u5b58\u653e\u751f\u6210\u914d\u7f6e\u7684\u6a21\u677f\uff0c\u4f7f\u7528jinja2\u8bed\u8a00\u7f16\u5199\uff0c\u540e\u7f00\u4e3a<code>xx.j2</code>\uff0c\u53ea\u80fd\u7528\u4e8e playbook\u3002</p> <p><code>templates</code>\u6587\u4ef6, \u53ef\u5d4c\u5957\u5f15\u7528\u811a\u672c\u3002</p> <ul> <li>\u5b57\u7b26\u4e32: \u4f7f\u7528\u5355\u5f15\u53f7\u6216\u53cc\u5f15\u53f7.</li> <li>\u6570\u5b57: \u6574\u6570, \u6d6e\u70b9\u6570.</li> <li>\u5217\u8868: [A1, A2, \u2026]</li> <li>\u5143\u7ec4: (B1, B2, \u2026)</li> <li>\u5b57\u5178: {key1:value1, key2:value2, \u2026}</li> <li>\u5e03\u5c14\u503c: true/false</li> <li>\u7b97\u672f\u8fd0\u7b97: <code>+, -, *, /, //, %, **</code></li> <li>\u6bd4\u8f83\u64cd\u4f5c: <code>==, !=, &gt;, &gt;=, &lt;, &lt;=</code></li> <li>\u903b\u8f91\u8fd0\u7b97: <code>and, or, not</code></li> <li>\u6d41\u8868\u8fbe\u5f0f: <code>for, if, when</code></li> <li>Jinja2 \u8bed\u6cd5\uff1a</li> </ul> <p>templates \u6839\u636e\u6a21\u677f\u5757\u6587\u4ef6\u52a8\u6001\u751f\u6210\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6</p> <ul> <li>templates\u7684\u6a21\u677f\u6587\u4ef6\u5fc5\u987b\u5b58\u653e\u4e8e <code>templates</code> \u76ee\u5f55\u4e0b, \u5e76\u4e14\u4ee5 <code>.j2</code> \u4e3a\u540e\u7f00\u3002</li> <li>templates \u76ee\u5f55\u9700\u8981\u4e0e <code>playbook</code> \u7684 <code>yaml</code> \u6587\u4ef6\u5728\u540c\u7ea7\u76ee\u5f55\u4e2d\u3002</li> </ul> <pre><code># tree nginx/\n|-- nginx.yaml\n|-- templates   \n    |-- nginx.conf.j2\n</code></pre>"},{"location":"chap4/12Ansible_task2/#_1","title":"\u7b97\u672f\u8fd0\u7b97","text":"<p><code>nginx.conf.j2</code></p> <pre><code>user nginx;\n# \u8fd9\u91cc\u4f7f\u7528 \u73af\u5883\u53d8\u91cf vcpus * 2\uff0c\u4f1a\u6839\u636e\u64cd\u4f5c\u7cfb\u7edfCPU\u81ea\u52a8\u751f\u6210\u3002\nworker_processes {{ ansible_processor_vcpus * 2 }};\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 10240;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n</code></pre> <p>nginx.yaml</p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: install nginx\n      yum: name=nginx\n    - name: nginx template conf\n      # \u5982\u679cyaml\u4e0etemplates\u5728\u540c\u4e00\u76ee\u5f55, src\u76f4\u63a5\u5199.j2\u6587\u4ef6\n      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf\n      notify:\n        - restart nginx\n    - name: start nginx\n      service: name=nginx state=started enabled=yes\n\n  handlers:\n    - name: restart nginx\n      service: name=nginx state=restarted\n</code></pre>"},{"location":"chap4/12Ansible_task2/#when","title":"when \u6761\u4ef6\u8bed\u53e5","text":"<p>when \u6761\u4ef6\u8bed\u53e5 \u4f8b\u5b50</p> <pre><code># tree nginx\n|-- nginx.yaml\n|-- templates   \n    |-- nginx.conf.centos7.j2   \n    |-- nginx.conf.centos8.j2\n</code></pre> <p>playbook \u6587\u4ef6</p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: install nginx\n      yum: name=nginx\n    - name: template centos 7 conf\n      # \u5982\u679c yaml \u4e0e templates \u5728\u540c\u4e00\u76ee\u5f55, src \u76f4\u63a5\u5199.j2 \u6587\u4ef6\u3002\n      template: src=nginx.conf.centos7.j2 dest=/etc/nginx/nginx.conf\n      # \u4f7f\u7528 when \u8bed\u53e5\u8fdb\u884c\u5224\u65ad \u5982\u679c\u53d8\u91cf\u4e3a \"7\" \u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\n      when: ansible_distribution_major_version == \"7\"\n      notify:\n        - restart nginx\n    - name: template centos 8 conf\n      # \u540c\u4e0a\n      template: src=nginx.conf.centos8.j2 dest=/etc/nginx/nginx.conf\n      # \u4f7f\u7528 when \u8bed\u53e5\u8fdb\u884c\u5224\u65ad \u5982\u679c\u53d8\u91cf\u4e3a 'Ubuntu' \u4e14\u7248\u672c\u4e3a20 \u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\n   when: (ansible_distribution == \"Ubuntu\" and ansible_distribution_major_version == \"20\"\n      notify:\n        - restart nginx\n    - name: start nginx\n      service: name=nginx state=started enabled=yes\n\n  handlers:\n    - name: restart nginx\n      service: name=nginx state=restarted\n</code></pre> <p>\u6267\u884c playbook \u6587\u4ef6</p> <p><code>skipping</code> \u72b6\u6001\u8868\u793a\u8df3\u8fc7\u6267\u884c\u8fd9\u4e2a TASK\u3002</p> <pre><code>\n# ansible-playbook nginx.yml\n\nPLAY [k3s-cluster] *******************************************************************************************\n\nTASK [Gathering Facts] *******************************************************************************\nok: [10.0.8.2]\n\nTASK [install nginx] *********************************************************************************\nok: [10.0.8.2]\n\nTASK [template centos 7 conf] ************************************************************************\nchanged: [10.0.8.2]\n\nTASK [template centos 8 conf] ************************************************************************\nskipping: [10.0.8.2]\n\nTASK [start nginx] ***********************************************************************************\nok: [10.0.8.2]\n\nRUNNING HANDLER [restart nginx] **********************************************************************\nchanged: [10.0.3.13]\n\nPLAY RECAP *******************************************************************************************\n10.0.8.2      : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#with_tiems","title":"\u8fed\u4ee3\u53d8\u91cf <code>with_tiems</code>","text":"<ul> <li>\u8fed\u4ee3<code>with_items</code> \u6267\u884c\u91cd\u590d\u4efb\u52a1\u3002</li> <li>\u5bf9\u4e8e\u8fed\u4ee3\u9009\u9879, \u56fa\u5b9a\u53d8\u91cf\u540d\u4e3a item \u3002</li> <li>\u5728 task \u4e2d\u4f7f\u7528 <code>with_items</code>\u6307\u5b9a\u9700\u8981\u8fed\u4ee3\u7684\u5143\u7d20\u5217\u8868\u3002</li> </ul> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: create multi files\n      # {{ item }} \u4e3a\u5185\u7f6e\u7279\u6b8a\u53d8\u91cf, \u4ee3\u8868 with_items \u5217\u8868\u4e2d\u7684\u5185\u5bb9\n      file: name=/tmp/{{ item }} state=touch\n      with_items:\n        - file_one\n        - file_two\n        - file_three\n        - file_four\n    - name: install multi software\n      yum: name={{ item }}\n      with_items:\n        - vsftpd\n        - net-tools\n        - iftop\n</code></pre> <p>\u4ee3\u5d4c\u5957\u5b50\u53d8\u91cf (\u5b57\u5178)</p> <ul> <li>\u8fed\u4ee3\u5d4c\u5957\u5b50\u53d8\u91cf.</li> <li>\u5bf9\u8fed\u4ee3\u4e2d\u7684\u53d8\u91cf\u8fdb\u884c\u5d4c\u5957\u5173\u8054\u7684\u64cd\u4f5c.</li> </ul> <p>playbook \u6587\u4ef6</p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: create some files\n      # {{ item }} \u4e3a\u7279\u6b8a\u53d8\u91cf, \u4ee3\u8868 with_itmes \u5217\u8868\u4e2d\u7684\u5185\u5bb9\n      file: name=/tmp/{{ item }} state=touch\n      with_items:\n        - file_one\n        - file_two\n        - file_three\n        - file_four\n\n    - name: create multi group\n      group: name={{ item }}\n      with_items:\n        - jinja2_file1\n        - jinja2_file2\n        - jinja2_file3\n        - jinja2_file4\n\n    - name: create multi user\n      # \u4f7f\u7528 item.key\u503c \u8fdb\u884c\u5f15\u7528\n      user: name={{ item.name }} group={{ item.group }}\n      # \u4f7f\u7528 \u5b57\u5178 \u5b9a\u4e49 \u5d4c\u5957\u7684\u5b50 \u53d8\u91cf\n      with_items:\n        - { name: 'file_one', group: 'jinja2_file1' }\n        - { name: 'file_two', group: 'jinja2_file2' }\n        - { name: 'file_three', group: 'jinja2_file3' }\n        - { name: 'file_four', group: 'jinja2_file4' }\n\n    - name: permission multi files\n      file: name=/tmp/{{ item.name }} owner={{ item.name }} group={{ item.group }}\n      with_items:\n        - { file: 'file_one', name: 'file_one', group: 'jinja2_file1' }\n        - { file: 'file_two', name: 'file_two', group: 'jinja2_file2' }\n        - { file: 'file_three', name: 'file_three', group: 'jinja2_file3' }\n        - { file: 'file_four', name: 'file_four', group: 'jinja2_file4' }\n</code></pre> <p>\u6267\u884c playbook \u6587\u4ef6</p> <p><code>ansible-playbook file.yml</code></p> <pre><code>PLAY [k3s-cluster] *****************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************\nok: [10.0.8.2]\n\nTASK [create multi files] ***************************************************************************\nchanged: [10.0.8.2] =&gt; (item=file_one)\nchanged: [10.0.8.2] =&gt; (item=file_two)\nchanged: [10.0.8.2] =&gt; (item=file_three)\nchanged: [10.0.8.2] =&gt; (item=file_four)\n\nTASK [create multi group] ***************************************************************************\nchanged: [10.0.8.2] =&gt; (item=jinja2_file1)\nchanged: [10.0.8.2] =&gt; (item=jinja2_file2)\nchanged: [10.0.8.2] =&gt; (item=jinja2_file3)\nchanged: [10.0.8.2] =&gt; (item=jinja2_file4)\n\nTASK [create multi user] ****************************************************************************\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file1', u'name': u'file_one'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file2', u'name': u'file_two'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file3', u'name': u'file_three'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file4', u'name': u'file_four'})\n\nTASK [permission multi files] ***********************************************************************\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file1', u'name': u'file_one', u'file': u'file1'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file2', u'name': u'file_two', u'file': u'file2'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file3', u'name': u'file_three', u'file': u'file3'})\nchanged: [10.0.8.2] =&gt; (item={u'group': u'jinja2_file4', u'name': u'file_four', u'file': u'file4'})\n\nPLAY RECAP *****************************************************************************************\n10.0.8.2    : ok=5    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#for-if","title":"\u6d41\u7a0b\u63a7\u5236\u3001\u5faa\u73af for \u4e0e if","text":"<p>for \u5faa\u73af</p> <p><code>{% for \u8bed\u53e5\u5757 %} ... {% endfor %}</code></p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  vars:\n    # \u5217\u8868\n    listen_port:\n      - 80\n      - 81\n      - 82\n    # \u5b57\u5178\n    service:\n      - name: web1\n        domain: deniss.wang\n        port: 9090\n        user: nginx\n        path: /var/www/html \n      - name: web2\n        domain: deniss.wang\n        port: 9091\n        user: nginx\n        path: /var/www/html\n      - name: web3\n        domain: deniss.wang\n        port: 9092\n        user: nginx\n        path: /var/www/html\n\n  tasks:\n    - name: copy template conf\n      template: src=for.conf.j2 dest=/tmp/for.conf\n</code></pre>"},{"location":"chap4/12Ansible_task2/#forconfj2","title":"<code>for.conf.j2</code> \u6587\u4ef6","text":"<p><code>{% for port in listen_port %}</code>\u8bed\u53e5<code>listen_port</code> \u4e3a <code>playbook</code>\u4e2d\u5b9a\u4e49\u7684 <code>vars</code> \u3002</p> <pre><code>{% for port in listen_port %}\n\nserver {\n   listen {{ port }}\n}\n\n{% endfor %}\n</code></pre>"},{"location":"chap4/12Ansible_task2/#forconf","title":"\u67e5\u770b\u751f\u6210 <code>for.conf</code> \u6587\u4ef6","text":"<pre><code># cat /root/for.conf\n\nserver {\n   listen 80\n}\n\n\nserver {\n   listen 81\n}\n\n\nserver {\n   listen 82\n}\n</code></pre>"},{"location":"chap4/12Ansible_task2/#_2","title":"\u5b57\u5178\u5f62\u5f0f","text":"<p><code>nginx.yaml</code></p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  vars:\n    # \u5b57\u5178\u7684\u5f62\u5f0f\n    service:\n      - name: web1\n        domain: deniss.wang\n        port: 9090\n        user: nginx\n        path: /var/www/html\n      - name: web2\n        domain: deniss.wang\n        port: 9091\n        user: nginx\n        path: /var/www/html\n      - name: web3\n        domain: deniss.wang\n        port: 9092\n        user: nginx\n        path: /var/www/html\n\n  tasks:\n    - name: copy template conf\n      template: src=nginx.conf.j2 dest=/tmp/nginx.conf\n</code></pre> <p><code>nginx.conf.j2</code> \u6587\u4ef6\uff0c\u653e\u5728templates\u4e0b\u9762</p> <pre><code>{% for s in service %}\nuser {{ s.user }};\nworker_processes {{ ansible_processor_vcpus * 2 }};\npid /run/nginx.pid;\n    server {\n        listen       {{ s.port }} default_server;\n        listen       [::]:{{ s.port }} default_server;\n        server_name  {{ s.name }}.{{ s.domain }};\n        root         {{ s.path }};\n    }\n\n{% endfor %}\n</code></pre> <p>if \u6d41\u7a0b\u63a7\u5236: <code>{% if \u8bed\u53e5\u5757 %} ... {% else %} ... {% endif %}</code></p> <p>playbook \u6587\u4ef6</p> <p>\u5176\u4e2d web1, web2 \u4e0d\u4f20 user \u53d8\u91cf\uff0cweb3 \u4f20 user \u53d8\u91cf\u3002</p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  vars:\n    # \u5b57\u5178\n    service:\n      - name: web1\n        domain: deniss.wang\n        port: 90\n        path: /var/www/html\n\n      - name: web2\n        domain: deniss.wang\n        port: 91\n        path: /var/www/html\n\n      - name: web3\n        domain: deniss.wang\n        port: 92\n        user: nginx\n        path: /var/www/html\n\n  tasks:\n    - name: copy template conf\n      template: src=nginx2.conf.j2 dest=/tmp/nginx2.conf\n</code></pre> <p><code>nginx2.conf.j2</code> \u6587\u4ef6</p>"},{"location":"chap4/12Ansible_task2/#if-suser-is-defined-suser","title":"<code>{% if s.user is defined %}</code>\u5224\u65ad \u662f\u5426\u6709 <code>s.user</code> \u8fd9\u4e2a\u53d8\u91cf","text":"<pre><code>{% for s in service %}\n\n{% if s.user is defined %}\nuser {{ s.user }};\n{% else %}\nuser root;\n{% endif %}\nworker_processes {{ ansible_processor_vcpus * 2 }};\npid /run/nginx.pid;\n    server {\n        listen       {{ s.port }} default_server;\n        server_name  {{ s.name }}.{{ s.domain }};\n        root         {{ s.path }};\n    }\n\n{% endfor %}\n</code></pre> <p>\u67e5\u770b\u751f\u6210\u540e\u7684 <code>nginx2.conf</code></p> <ul> <li>\u7b2c\u4e00\u4e2aserver \u4e0d\u5305\u542b <code>s.user</code> \u53d8\u91cf \u6240\u4ee5 <code>user root;</code></li> <li>\u7b2c\u4e8c\u4e2aserver \u4e0d\u5305\u542b <code>s.user</code> \u53d8\u91cf \u6240\u4ee5 <code>user root</code>;</li> <li>\u7b2c\u4e09\u4e2aserver \u5305\u542b <code>s.user</code> \u53d8\u91cf \u6240\u4ee5 <code>user nginx</code>; \u7b49\u4e8e\u53d8\u91cf\u503c</li> </ul> <pre><code>\n# cat  nginx2.conf\nuser root;\nworker_processes 4;\npid /run/nginx.pid;\n    server {\n        listen       90 default_server;\n        server_name  web1.deniss.wang;\n        root         /var/www/html;\n    }\n\n\nuser root;\nworker_processes 4;\npid /run/nginx.pid;\n    server {\n        listen       91 default_server;\n        server_name  web2.deniss.wang;\n        root         /var/www/html;\n    }\n\n\nuser nginx;\nworker_processes 4;\npid /run/nginx.pid;\n    server {\n        listen       92 default_server;\n        server_name  web3.deniss.wang;\n        root         /var/www/html;\n    }\n</code></pre> <p>tasks \u793a\u8303</p> <p>\u5b9a\u4e49\u4e00\u7ec4\u6267\u884c\u4efb\u52a1\uff0c\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u6a21\u5757\u7684\u96c6\u5408\u3002</p> <p>Demo</p> <pre><code>---\n# \u6307\u5b9a\u4e3b\u673a\u7ec4\n- hosts: k3s-cluster\n  # \u5f00\u542f\u63d0\u6743\uff0c\u6307\u5b9a\u7528\u6237\n  become: yes\n  become_user: root\n\n  # \u4efb\u52a1\n  tasks:\n    # \u4efb\u52a1\u7684\u540d\u79f0\n    - name: ping server\n      ping:\n    - name: echo hostname\n      # shell \u4e3a\u6a21\u5757\u540d, \u540e\u9762\u7b49\u540c\u4e8e -a '' \u53c2\u6570\n      shell: hostname\n    - name: touch file\n      file: name=/tmp/file.txt state=touch\n    - name: echo file\n      shell: ls -l /tmp/file.txt\n    - name: write file\n      shell: echo \"hello world\" &gt; /tmp/file.txt\n    - name: copy module write file\n      copy: content=\"hello deniss\\n\" dest=/tmp/deniss.txt\n    - name: display file content\n      shell: cat /tmp/file.txt\n      register: display_content1\n    - name: show\n      debug: var=display_content1.stdout verbosity=0\n    - name: display copy module file content\n      shell: cat /tmp/deniss.txt\n      register: display_content2\n    - name: show\n      debug: var=display_content2.stdout verbosity=0\n</code></pre> <pre><code># ansible-playbook hello.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [ping server] *******************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [echo hostname] *****************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [touch file] ********************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [echo file] *********************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [write file] ********************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [copy module write file] ********************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [display file content] **********************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [show] **************************************************************************************************************************************************************************\nok: [ubuntu20-bj03] =&gt; {\n    \"display_content1.stdout\": \"hello world\"\n}\n\nTASK [display copy module file content] **********************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [show] **************************************************************************************************************************************************************************\nok: [ubuntu20-bj03] =&gt; {\n    \"display_content2.stdout\": \"hello deniss\"\n}\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=11   changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre> <p>\u72b6\u6001\u91ca\u4e49:</p> <ul> <li><code>ok</code> : ok \u672a\u4fee\u6539\u6587\u4ef6\u5143\u6570\u636e\uff0c\u7eff\u8272</li> <li><code>changed</code> : \u6570\u636e\u6709\u4fee\u6539\uff0c\u9ec4\u8272</li> </ul>"},{"location":"chap4/12Ansible_task2/#8-handles","title":"8 handles \u793a\u8303","text":"<p>handles \u4e0e notity \u7ed3\u5408\u7684\u4f8b\u5b50</p> <p>\u540c\u4e00\u4e2aname \u4e0b\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a notify \u914d\u7f6e\u5173\u8054\u5230\u4e0d\u540c\u7684 handlers \u4e2d\u3002</p> <pre><code>---\n# \u6307\u5b9a\u4e3b\u673a\u7ec4\n- hosts: k3s-cluster\n  # \u5f00\u542f\u63d0\u6743\uff0c\u6307\u5b9a\u7528\u6237\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: copy httpd.conf\n      copy: src=~/ansible/httpd.conf dest=/etc/httpd/conf/httpd.conf backup=yes\n      # \u5173\u8054\u591a\u4e2a\u89e6\u53d1\u5668\u7684\u5199\u6cd5\n      notify:\n        - restart httpd\n        - check status httpd\n        - check network port\n</code></pre>"},{"location":"chap4/12Ansible_task2/#demo","title":"Demo","text":"<p>Centos</p> <pre><code>---\n# \u6307\u5b9a\u4e3b\u673a\u7ec4\n- hosts: k3s-cluster\n  # \u5f00\u542f\u63d0\u6743\uff0c\u6307\u5b9a\u7528\u6237\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: install httpd\n      yum: name=httpd\n    - name: copy httpd.conf\n      copy: src=/opt/ansible/conf/httpd.conf dest=/etc/httpd/conf/httpd.conf backup=yes\n      # \u6b64\u4efb\u52a1 \u5982\u679c\u6709\u53d8\u52a8\u4f1a\u89e6\u53d1\u5982\u4e0b\u5b9a\u4e49\u540d\u79f0\u7684\u89e6\u53d1\u5668\n      notify: restart httpd\n    - name: start httpd\n      service: name=httpd state=started enabled=yes\n\n  # \u89e6\u53d1\u5668, \u9700\u8981\u914d\u7f6e notify \u89e6\u53d1\n  handlers:\n    - name: restart httpd\n      service: name=httpd state=restarted\n</code></pre> <p>Ubuntu</p> <pre><code>---\n# \u6307\u5b9a\u4e3b\u673a\u7ec4\n- hosts: k3s-cluster\n  # \u5f00\u542f\u63d0\u6743\uff0c\u6307\u5b9a\u7528\u6237\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: Update apt-get repo and cache\n      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600\n    - name: Install Vsftpd\n      apt:\n        name: vsftpd\n    - name: copy vsftpd.conf\n      copy: src=/opt/ansible/conf/vsftpd.conf dest=/etc/vsftpd.conf backup=yes\n      notify: restart vsftpd\n    - name: start vsftpd\n      service: name=vsftpd state=started enabled=yes\n  # \u914d\u7f6e notify \u89e6\u53d1\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u65f6\u5019\u751f\u6548\u3002\n  handlers:\n    - name: restart vsftpd\n      service: name=vsftpd state=restarted\n</code></pre> <p>\u6267\u884c\u5b89\u88c5vsftpd PlayBook</p> <pre><code># ansible-playbook install_vsftpd.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Update apt-get repo and cache] *************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Install Vsftpd] ****************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [copy vsftpd.conf] **************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [start vsftpd] ******************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre> <p>\u4fee\u6539vsftpd\u6587\u4ef6\u4ee5\u540e\u4f1a\u89e6\u53d1\u91cd\u542f\u64cd\u4f5c\u3002</p> <pre><code># ansible-playbook install_pkg.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Update apt-get repo and cache] *************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Install Vsftpd] ****************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [copy vsftpd.conf] **************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [start vsftpd] ******************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nRUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre> <p>\u4fee\u6539vsftpd\u6587\u4ef6\u4ee5\u540e\u4f1a\u89e6\u53d1\u91cd\u542f\u64cd\u4f5c\u3002</p> <pre><code># ansible-playbook install_pkg.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Update apt-get repo and cache] *************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [Install Vsftpd] ****************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [copy vsftpd.conf] **************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nTASK [start vsftpd] ******************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nRUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#9-tags","title":"9 Tags\u793a\u8303","text":""},{"location":"chap4/12Ansible_task2/#9-1-tags","title":"9-1 tags","text":"<ul> <li>\u5b9a\u4e49\u4e86 tags \u540e\u53ef\u901a\u8fc7\u5b9a\u4e49\u7684 tags \u5355\u72ec\u8fd0\u884c\u8be5 tags\u6765\u6267\u884c\u6307\u5b9a\u7684tasks\uff0c \u8fd0\u884c\u591a\u4e2a\u53ef\u7528 , \u53f7\u5206\u9694\u3002</li> <li>\u591a\u4e2a\u4e0d\u540c\u7684\u4efb\u52a1\u4e2d\u53ef\u4ee5\u5b9a\u4e49\u76f8\u540c\u7684 tags\u3002</li> </ul> <pre><code>---\n# \u6307\u5b9a\u4e3b\u673a\u7ec4\n- hosts: k3s-cluster\n  # \u5f00\u542f\u63d0\u6743\uff0c\u6307\u5b9a\u7528\u6237\n  become: yes\n  become_user: root\n\n  tasks:\n    - name: Update apt-get repo and cache\n      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600\n    - name: Install Vsftpd\n      apt:\n        name: vsftpd\n    - name: copy vsftpd.conf\n      copy: src=conf/vsftpd.conf dest=/etc/vsftpd.conf backup=yes\n      notify: restart vsftpd\n      # \u5b9a\u4e49\u6807\u7b7e\n      tags: cpconf      \n    - name: start vsftpd\n      service: name=vsftpd state=started enabled=yes\n      # \u5b9a\u4e49\u6807\u7b7e\n      tags: upvsftpd      \n  # \u914d\u7f6e notify \u89e6\u53d1\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u65f6\u5019\u751f\u6548\u3002\n  handlers:\n    - name: restart vsftpd\n      service: name=vsftpd state=restarted     \n</code></pre> <p><code>-t</code> \u6307\u5b9a\u6807\u7b7e\u6267\u884c</p> <pre><code># ansible-playbook -t upvsftpd  install_vsftpd.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [start vsftpd] ******************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n\n# ansible-playbook -t cpconf  install_vsftpd.yaml\nPLAY [k3s-cluster] *******************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ***************************************************************************************************************************************************************\nok: [ubuntu20-bj03]\n\nTASK [copy vsftpd.conf] **************************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nRUNNING HANDLER [restart vsftpd] *****************************************************************************************************************************************************\nchanged: [ubuntu20-bj03]\n\nPLAY RECAP ***************************************************************************************************************************************************************************\nubuntu20-bj03              : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#10-ansible-vault","title":"10 ansible-vault","text":"<ul> <li>playbook \u6587\u4ef6\u52a0\u5bc6\u5de5\u5177\u3002</li> <li><code>ansible-vault encrypt hello.yaml</code></li> <li><code>encrypt: AES256</code> \u52a0\u5bc6 ( \u4f1a\u63d0\u793a\u8f93\u5165\u5bc6\u7801 )\u3002</li> <li><code>view</code>: \u52a0\u5bc6\u7684\u60c5\u51b5\u4e0b \u67e5\u770b \u539f\u6765\u7684\u5185\u5bb9\u3002</li> <li><code>edit</code>: \u7f16\u8f91\u52a0\u5bc6\u7684 playbook \u6587\u4ef6\u3002</li> <li><code>decrypt</code>: \u89e3\u5bc6\u3002</li> <li><code>rekey</code>: \u4fee\u6539\u52a0\u5bc6\u5bc6\u7801\u3002</li> </ul>"},{"location":"chap4/12Ansible_task2/#11-ansible-console","title":"11 <code>ansible-console</code>","text":"<p><code>ansible-console</code>: \u53ef\u4ea4\u4e92\u6267\u884c\u547d\u4ee4, \u652f\u6301 Tab \u952e\u3002</p> <pre><code># ansible-consoleWelcome to the ansible console.Type help or ? to list commands.deniss.wang@all (10)[f:5]$\n</code></pre> <p><code>root@all (10) [f:5]$</code></p> <ul> <li><code>root</code>\u5f53\u524d\u6267\u884c\u7528\u6237\u3002</li> <li><code>all</code> \u8868\u793a\u5f53\u524d\u4e3b\u673a\u5217\u8868\u3002</li> <li><code>(10)</code> \u8868\u793a\u5f53\u524d\u4e3b\u673a\u6e05\u5355\u4e0b\u5305\u542b 10 \u53f0\u4e3b\u673a\u3002</li> <li><code>[f:5]</code>: \u8868\u793a\u5e76\u53d1\u6267\u884c\u4efb\u52a1\u6570\u4e3a 5 \u4e2a\u3002\u3002</li> </ul>"},{"location":"chap4/12Ansible_task2/#12-ansible-roles","title":"12 ansible Roles","text":"<ul> <li>Roles \u89d2\u8272\u662f Ansible v1.2 \u7248\u672c\u65b0\u52a0\u5165\u7279\u6027\uff0c\u7528\u4e8e\u5c42\u6b21\u6027\u3001\u7ed3\u6784\u5316\u7684\u7ec4\u7ec7 playbook\u3002</li> <li>Roles \u80fd\u591f\u6839\u636e\u5c42\u6b21\u7ed3\u6784\u81ea\u52a8\u52a0\u8f7d- \u53d8\u91cf\u6587\u4ef6\u3001tasks\u3001handler\u3001template \u6587\u4ef6\u7b49. \u7b80\u5355\u6765\u8bb2\u5c31\u662f\u5c06 \u8fd9\u4e9b\u6587\u4ef6\u5f52\u7c7b\u5230\u5404\u81ea\u5355\u72ec\u7684\u6587\u4ef6\u76ee\u5f55\u4e2d, \u4f7f playbook \u6587\u4ef6\u53ef\u4ee5\u66f4\u597d\u7684\u901a\u8fc7 include \u8fd9\u4e9b\u6587\u4ef6\u76ee\u5f55\u3002</li> <li>Roles \u4e00\u822c\u7528\u4e8e\u57fa\u4e8e \u4e3b\u673a\u6784\u5efa\u670d\u52a1 \u7684\u573a\u666f\u4e2d, \u4f46\u4e5f\u53ef\u4ee5\u7528\u4e8e\u6784\u5efa \u5b88\u62a4\u8fdb\u7a0b \u7b49\u573a\u666f\u3002</li> <li>Roles \u9ed8\u8ba4\u7684\u76ee\u5f55\u4e3a <code>/etc/ansible/roles</code> \u3002</li> </ul> <p>\u76ee\u5f55\u7ed3\u6784\u8bf4\u660e</p> <ul> <li>playbook.yml - \u5267\u672c\u6587\u4ef6</li> <li>app \u5177\u4f53\u7684\u89d2\u8272\u9879\u76ee\u540d\u79f0, \u6bd4\u5982 Nginx\u3001PHP\u3001Apache</li> <li>files \u7528\u4e8e\u5b58\u653e\u7531copy \u6216script \u6a21\u5757\u8c03\u7528\u7684\u6587\u4ef6</li> <li><code>templates</code> \u7528\u4e8e\u5b58\u653e Jinja2 \u6a21\u677f, template \u6a21\u5757\u4f1a\u81ea\u52a8\u5728\u6b64\u76ee\u5f55\u4e2d\u5bfb\u627e Jinja2 \u6a21\u677f\u6587\u4ef6</li> <li><code>tasks</code>  main.yml\u6587\u4ef6\u4e3a\u5165\u53e3, \u7528\u4e8e\u5b9a\u4e49\u6b64\u89d2\u8272\u7684\u4efb\u52a1\u5217\u8868, \u6b64\u6587\u4ef6\u53ef\u4ee5\u4f7f\u7528include\u5305\u542b\u5176\u5b83\u7684\u4f4d\u4e8e\u6b64\u76ee\u5f55\u7684 task \u6587\u4ef6</li> <li><code>handlers</code>main.yml\u6587\u4ef6\u4e3a\u5165\u53e3, \u7528\u4e8e\u5b9a\u4e49\u6b64\u89d2\u8272\u4e2d\u89e6\u53d1\u6761\u4ef6\u65f6\u6267\u884c\u7684\u52a8\u4f5c</li> <li><code>vars</code> main.yml\u6587\u4ef6\u4e3a\u5165\u53e3\uff0c\u7528\u4e8e\u5b9a\u4e49\u6b64\u89d2\u8272\u7528\u5230\u7684\u53d8\u91cf</li> <li><code>defaults</code> main.yml\u6587\u4ef6\u4e3a\u5165\u53e3\uff0c \u7528\u4e8e\u4e3a\u5f53\u524d\u89d2\u8272\u8bbe\u5b9a\u9ed8\u8ba4\u53d8\u91cf</li> <li><code>meta</code> main.yml\u6587\u4ef6\u4e3a\u5165\u53e3\uff0c\u7528\u4e8e\u5b9a\u4e49\u6b64\u89d2\u8272\u7684\u7279\u6b8a\u8bbe\u5b9a\u53ca\u5176\u4f9d\u8d56\u5173\u7cfb</li> <li> <p><code>roles:</code> \u6240\u6709\u7684\u89d2\u8272\u5fc5\u987b\u653e\u5728roles\u76ee\u5f55\u4e0b, \u8fd9\u4e2a\u76ee\u5f55\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4f4d\u7f6e\uff0c\u9ed8\u8ba4\u7684\u4f4d\u7f6e\u5728 <code>/etc/ansible/roles</code></p> </li> <li> <p>nginx roles</p> </li> </ul> <pre><code># tree .\n\n|-- nginx\n    |-- defaults\n    |-- files\n    |-- handlers\n    |-- meta\n    |-- tasks\n    |-- templates\n    |-- vars\n</code></pre> <ul> <li>\u521b\u5efa\u5bf9\u5e94\u7684\u6587\u4ef6</li> </ul> <pre><code>\n# tree  roles/\nroles/\n|-- nginx\n    |-- defaults\n    |-- files\n    |-- handlers\n    |-- meta\n    |-- tasks\n    |   |-- group.yaml\n    |   |-- main.yaml\n    |   |-- restart.yaml\n    |   |-- start.yaml\n    |   |-- template.yaml\n    |   |-- user.yaml\n    |   |-- yum.yaml\n    |-- templates\n    |   |-- nginx.conf.j2\n    |-- vars\n</code></pre> <p><code>/etc/ansible/nginx_roles.yml</code> \u4e0e roles\u5b58\u653e\u4f4d\u7f6e\u5728\u540c\u4e00\u76ee\u5f55\u3002</p> <pre><code>---\n- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n  # \u9009\u62e9 \u8c03\u7528\u7684 roles \u5c5e\u6027\n  roles:\n      # \u8c03\u7528\u5b9a\u4e49\u597d\u7684role\uff0c\u5b58\u653e\u5728roles\u76ee\u5f55\u4e2d\u3002\n    - role: nginx\n</code></pre> <p><code>/etc/ansible/roles/nginx/tasks/main.yml</code> \u5165\u53e3\u6587\u4ef6 \u914d\u7f6e task \u6267\u884c\u987a\u5e8f\u3002</p> <ul> <li><code>- include: roles/httpd/tasks/copyfile.yml</code></li> <li>\u8de8 roles \u8c03\u7528 tasks\uff0c\u9700\u8981\u5199 roles \u76ee\u5f55\u7ea7\u7684\u5168\u8def\u5f84\u3002 </li> </ul> <p>\u5982:</p> <pre><code>- include: group.yml\n- include: user.yml\n- include: yum.yml\n- include: template.yml\n- include: start.yml\n</code></pre> <p><code>/etc/ansible/roles/nginx/tasks/group.yml</code> \u5355\u72ec\u7684 tasks \u6587\u4ef6\u53ea\u5199\u5355\u72ec\u7684\u5185\u5bb9 \u5982\u4e0b:</p> <p><code>- name: create group   group: name=nginx gid=80</code></p> <p>\u6267\u884c <code>nginx_roles.yml</code> \u6587\u4ef6</p> <pre><code># ansible-playbook nginx_roles.yml\n\nPLAY [k3s-cluster] ****************************************************************************************\n\nTASK [Gathering Facts] ****************************************************************************\nok: [10.0.8.2]\n\nTASK [nginx : create group] ***********************************************************************\nchanged: [10.0.8.2]\n\nTASK [nginx : create user] ************************************************************************\nchanged: [10.0.8.2]\n\nTASK [nginx : install package] ********************************************************************\nchanged: [10.0.8.2]\n\nTASK [nginx : copy conf] **************************************************************************\nchanged: [10.0.8.2]\n\nTASK [nginx : start service] **********************************************************************\nchanged: [10.0.8.2]\n\nPLAY RECAP ****************************************************************************************\n10.0.8.2   : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre>"},{"location":"chap4/12Ansible_task2/#roles-tags","title":"roles tags \u6807\u7b7e","text":"<p>\u5728 playbook \u6587\u4ef6\u4e2d \u5bf9 roles \u914d\u7f6e\u76f8\u5e94\u7684 tags \u3002</p> <pre><code>- hosts: k3s-cluster\n  become: yes\n  become_user: root\n\n\n  # \u9009\u62e9 roles \u5c5e\u6027\n  roles:\n    # \u914d\u7f6e\u76f8\u5e94\u7684 tags \u7528 { } \u5f15\u7528\n    - { role: nginx, tags: ['web', 'nginx'] }\n    - { role: mysql, tags: ['db', 'mysql'] }\n    - { role: redis, tags: ['db', 'redis'] }\n    - { role: golang, tags: ['web', 'golang'] }\n    - { role: vue, tags: ['web', 'vue'] }   \n    - { role: app_demo, tags: \"app_demo\" }\n</code></pre> <p>\u8ddf\u4e0a\u9762\u7684\u7528\u6cd5\u4e00\u6837\uff0c\u901a\u8fc7 <code>ansible-playbook -t</code> \u53c2\u6570\u6307\u5b9a tags \u8fdb\u884c\u5355\u72ec\u8c03\u7528</p> <p>\u5982\u4e0b\u6307\u5b9a tags \u4e3a web \u7684 role \u6267\u884c\uff0c\u5176\u4e2d\u4f1a\u4f9d\u6b21\u6267\u884cnginx \u3001golang\u3001vue\u7684roles\u3002</p> <pre><code># ansible-playbook -t web playbook.yml\n</code></pre>"},{"location":"chap4/12Ansible_task2/#roles-when","title":"roles when \u8bed\u53e5","text":"<p>\u5bf9 role \u8fdb\u884c\u6761\u4ef6\u7684\u5224\u65ad.</p> <p><code>ansible_distribution_major_version == \"7\"</code></p> <pre><code>---\n- hosts: all\n  become: yes\n  become_user: root\n\n  # \u9009\u62e9 roles \u5c5e\u6027\n  roles:\n    # \u914d\u7f6e\u76f8\u5e94\u7684 tags \u7528 { } \u5f15\u7528\n    - { role: nginx, tags: ['web', 'nginx'] }\n    - { role: mysql, tags: ['db', 'mysql'] }\n    - { role: redis, tags: ['db', 'redis'] }\n    # \u53ea\u9488\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u4e3a Centos7 \u7684\u6267\u884c\n    - { role: golang, tags: ['web', 'golang'], when: ansible_distribution_major_version == \"7\" }\n    # \u53ea\u9488\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u4e3a Ubuntu20 \u7684\u6267\u884c\n    - { role: vue, tags: ['web', 'vue'], when: (ansible_distribution == \"Ubuntu\" and ansible_distribution_major_version == \"20\")}\n    - { role: app, tags: \"app\" }\n</code></pre>"},{"location":"chap4/12Ansible_task2/#extra-vars","title":"<code>extra-vars</code>","text":"<ul> <li><code>--extra-vars</code> \u6267\u884c playboook \u7684\u65f6\u5019\u4ee5\u53c2\u6570\u65b9\u5f0f\u4f20\u5165\u53d8\u91cf\u3002</li> </ul> <pre><code>\n# \u4ee5\u53d8\u91cf\u65b9\u5f0f\u4f20\u53c2\nansible-playbook deploy.yaml --extra-vars \"hosts=k3s-cluster user=ubuntu\" \n# \u4ee5json\u683c\u5f0f\u4f20\u53c2\nansible-playbook deploy.yaml --extra-vars \"{'app_name':'nginx', 'pkg_name':'vsftpd'}\"\n# \u4ee5json\u6587\u4ef6\u65b9\u5f0f\u4f20\u53c2\nansible-playbook deploy.yml --extra-vars \"@test_vars.json\"\n</code></pre>"},{"location":"chap4/12Ansible_task2/#2demo","title":"\u9644\u4e0a2\u4e2aDemo","text":"<p>Ubuntu \u5b89\u88c5\u8f6f\u4ef6\uff0c\u4f20\u5165\u53c2\u6570\u5373\u53ef\u5b89\u88c5\u8f6f\u4ef6\u3002</p> <pre><code>---\n# \u5b9a\u4e49\u96c6\u7fa4\uff0c\u5e76\u8bbe\u7f6e\u63d0\u6743root\uff0c\n- hosts: all\n  become: yes\n  become_user: root\n\n  vars:\n    # \u4f20\u5165\u53c2\u6570\n    - DEPLOY_USER: ubuntu\n    - APP_NAME: '{{ app_name }}'\n\n  tasks:\n    - name: \u66f4\u65b0 apt-get \u4ed3\u5e93\u4ee5\u53ca\u7f13\u5b58\n      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600\n    - name: \u5b89\u88c5 {{ APP_NAME }} \u7a0b\u5e8f\n      apt:\n        name: \"{{ APP_NAME }}\"\n    # - name: \"\u590d\u5236 {{ APP_NAME }} \u914d\u7f6e\u6587\u4ef6\"\n    #   copy: src=./conf/vsftpd.conf dest=/etc/{{ APP_NAME }}.conf backup=yes\n    #   notify: restart {{ APP_NAME }} # \u6b64\u5904\u5fc5\u987b\u4e0ehandlers\u4e00\u81f4\n    #   # \u5b9a\u4e49\u6807\u7b7e\n    #   tags: copyconf\n    - name: \"\u542f\u52a8 {{ APP_NAME }} \u670d\u52a1\"\n      service: name={{ APP_NAME }} state=started enabled=yes\n      # \u5b9a\u4e49\u6807\u7b7e\n      tags: startvsftpd\n\n  # \u914d\u7f6e notify \u89e6\u53d1\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u65f6\u5019\u751f\u6548\u3002\n  handlers:\n    - name: restart {{ APP_NAME }}\n      service: name={{ APP_NAME }} state=restarted\n</code></pre> <p>\u53d1\u5e03\u6d41\u7a0b\uff0cDemo\u4e2d\u7684\u5177\u4f53\u5b9e\u73b0\u903b\u8f91</p> <pre><code>---\n- hosts: all\n  gather_facts: no\n\n  vars:\n    # OSS\u53c2\u6570\n    - OSS_URL: 'https://repo.opendevops.cn'\n    - OSS_PATH: 'codo/codo-api/cclib/production'\n    - OSS_FILE: 'xxxxx_20211020181130_dispatch-service-0.0.7.jar'\n    - OSS_FILE_KEY: '?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'\n    # \u90e8\u7f72\u53c2\u6570\n    - DEPLOY_USER: '{{ deploy_user }}' # \"ubuntu\"\n    - APP_NAME: '{{ app_name }}' # \"tomcat\"\n    - APP_DIR:  '{{ app_dir }}' # \"/tmp\"\n    - DING_URL: '{{ ding_url }}'\n    - DING_TOKEN: '{{ ding_token }}'\n\n  tasks:\n\n    - name: \"\u9a8c\u8bc1 {{ inventory_hostname }} SSH \u7aef\u53e3\"\n      local_action: wait_for port=22 host=\"{{ inventory_hostname }}\" search_regex=OpenSSH\n    - name: gather facts\n      setup:    \n\n    - name: \"\u9489\u9489 {{ ding_url }} {{ ding_token }}\"\n      shell: \"echo {{ ding_url }}\"   \n      register: print_ding_url\n\n    - name: \"\u83b7\u53d6\u5f53\u524d\u53d1\u5e03\u4e3b\u673aIP\"\n      shell: \"curl http://ip.me\"   \n      register: get_ip_addr\n    - name: \"\u83b7\u53d6\u5f53\u524d\u53d1\u5e03\u4e3b\u673aIP SDTOUT\"  \n      debug: var=get_ip_addr.stdout\n\n    - name: \"\u83b7\u53d6\u5f53\u524d\u53d1\u5e03\u4e3b\u673a\u540d\u79f0\"\n      shell: \"hostname\"\n      register: get_hostname\n    - name: \"\u83b7\u53d6\u5f53\u524d\u53d1\u5e03\u4e3b\u673a\u540d\u79f0 SDTOUT\"\n      debug: var=get_hostname\n\n    # \u53d1\u5e03\u7684\u4e00\u4e9b\u52a8\u4f5c\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u76ee\u5f55\"\n      file:\n        path: \"{{ APP_DIR }}/{{ APP_NAME }}\"\n        state: directory\n        mode: '0755'   \n      register: create_dir\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u76ee\u5f55 STDOUT\"\n      debug: var=create_dir\n\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u7a0b\u5e8f\u5305\u4e0b\u8f7d\"            \n      shell: \"wget {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }}'{{ OSS_FILE_KEY }}' -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}\"\n      args:\n        chdir: /opt/\n        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}\n      register: download_file\n      #notify: restart {{ APP_NAME }}\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u7a0b\u5e8f\u5305\u4e0b\u8f7d CMD\"\n      debug: var=download_file.cmd\n\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u6539\u540d\"\n      shell: \"new_file_name=`ls {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }} |awk -F'_' '{print $3}'` &amp;&amp; echo ${new_file_name} &amp;&amp; mv {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }} {{ APP_DIR }}/{{ APP_NAME }}/${new_file_name}\"\n      args:\n        chdir: /opt/\n        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}\n      register: move_file\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u6539\u540d STDOUT\"\n      debug: var=move_file.stdout\n\n   - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u6743\u9650\u4fee\u6539\"\n      file:\n        path: \"{{ APP_DIR }}/{{ APP_NAME }}\"\n        state: directory\n        owner: \"{{ DEPLOY_USER }}\"\n        group: \"{{ DEPLOY_USER }}\"\n        recurse: yes\n      register: changed_permissions\n    - name: \"APP {{ APP_NAME }} \u6743\u9650\u4fee\u6539 STDOUT\"\n      debug: var=changed_permissions\n\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u670d\u52a1\u91cd\u542f\"      \n      shell: \"echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}\"\n      register: restart_service\n      notify: restart {{ APP_NAME }}\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} APP {{ APP_NAME }} \u670d\u52a1\u91cd\u542f SDTOUT\"\n      debug: var=restart_service.cmd\n\n    # \u53d1\u5e03\u5b8c\u6210\u540e\u7684\u9a8c\u8bc1\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u8fdb\u7a0b\u72b6\u6001\"      \n      shell: \"echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}\"\n      args:\n        chdir: /opt/\n        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}\n      register: process_status\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u8fdb\u7a0b\u72b6\u6001 STDOUT\"\n      debug: var=process_status.stdout      \n\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u670d\u52a1\u72b6\u6001\"      \n      shell: \"echo {{ OSS_URL }}/{{ OSS_PATH }}/{{ OSS_FILE }} -O {{ APP_DIR }}/{{ APP_NAME }}/{{ OSS_FILE }}\"\n      args:\n        chdir: /opt/\n        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}\n      register: service_status\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u670d\u52a1\u72b6\u6001 STDOUT\"\n       debug: var=service_status.stdout  \n\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u63a5\u53e3\u72b6\u6001\"      \n      shell: \"curl -s -L %{http_code} {{ OSS_URL }}  | grep \\\"Welcome!\\\" |awk '{print $1}'\"\n      args:\n        chdir: /opt/\n        creates: /opt/{{ OSS_URL }}/{{ OSS_FILE }}\n      register: interface_status\n    - name: \"\u53d1\u5e03\u4e3b\u673a: {{ get_hostname.stdout }} \u9a8c\u8bc1 {{ APP_NAME }} \u63a5\u53e3\u72b6\u6001 STDOUT\"\n      debug: var=interface_status.stdout\n\n  # \u91cd\u542f\u670d\u52a1\n  handlers:\n    - name: restart {{ APP_NAME }}\n      service: name={{ APP_NAME }} state=restarted   \n</code></pre> <p>\u6267\u884c\u53c2\u6570</p> <pre><code># \u53d8\u91cf\nansible-playbook -C deploy.yaml -e \"ding_url=ding.opendevops.cn app_name=tomcat app_dir=/tmp/deniss deploy_user=ubuntu, ding_token=qwerty&amp;^%FDSFBSNFXZ&amp;^%%\"\n# json\nansible-playbook -C deploy.yaml --extra-vars \"{'app_name':'tomcat', 'deploy_user':'ubuntu', 'app_dir':'/tmp/deniss', 'ding_url':'ding.opendevops.cn', 'ding_token':'qwerty&amp;^%FDSFBSNFXZ&amp;^%%'}\"\n</code></pre>"},{"location":"chap4/13Ansible_int/","title":"L13 Ansible \u9762\u8bd5\u77e5\u8bc6\u70b9","text":""},{"location":"chap4/13Ansible_int/#architecture","title":"Architecture","text":"<ul> <li>Ansible: Inventory / Modules / Plugins / Playbooks</li> <li>Group: Servers</li> </ul>"},{"location":"chap4/13Ansible_int/#core","title":"Core","text":"<ul> <li>Ansible \u6838\u5fc3\u7a0b\u5e8f </li> <li>Core Modules \u6838\u5fc3\u6a21\u5757\uff0c \u6240\u6709\u4efb\u52a1\u5747\u6709\u6a21\u5757\u5b8c\u6210</li> <li>Custom Modules \u81ea\u5b9a\u4e49\u6a21\u5757\uff0c\u5b8c\u6210\u6838\u5fc3\u6a21\u5757\u65e0\u6cd5\u5b8c\u6210\u7684\u4efb\u52a1\u652f\u6301\u4efb\u610f\u8bed\u8a00\u7f16\u5199</li> <li>Host Inventory Ansible\u7ba1\u7406\u7684\u4e3b\u673a\u4fe1\u606f\uff0c\u5305\u62ecIP\u5730\u5740\u3001SSH\u7aef\u53e3\u53f7,\u8d26\u53f7\u3001\u5bc6\u7801\u7b49</li> <li>Playbooks \u201c\u5267\u672c\u201d\uff0c YAML\u683c\u5f0f\uff0c\u6a21\u5757\u5316\u5b9a\u4e49\u4e00\u7cfb\u5217\u4efb\u52a1\uff0c\u4f9b\u5916\u90e8\u7edf\u4e00\u8c03\u7528</li> <li>Connection Plugins \u94fe\u63a5\u63d2\u4ef6\uff0c\u5efa\u7acbAnsibe\u4e0e\u5176\u4ed6\u4e3b\u673a\u95f4\u7684\u901a\u4fe1</li> </ul>"},{"location":"chap4/13Ansible_int/#install-ansible","title":"Install Ansible","text":""},{"location":"chap4/13Ansible_int/#_1","title":"\u547d\u4ee4\u96c6","text":"<ul> <li>ansible \u5b9a\u4e49\u5e76\u8fd0\u884c\u7b80\u5355\u4efb\u52a1 </li> <li>ansible-congig \u67e5\u770b\u3001\u7f16\u8f91\u3001\u7ba1\u7406Ansible\u914d\u7f6e </li> <li>ansible-doc \u6587\u6863\u67e5\u770b\u5de5\u5177 </li> <li>ansible-galaxy \u5171\u4eab\u548c\u4e0b\u8f7droles\u7684\u5de5\u5177 </li> <li>ansible-inventory \u67e5\u770bInventory\u503c\u606f </li> <li>ansible-playbook  \u6267\u884cplaybook </li> <li>ansible-pull  \u4ece\u4ed3\u5e93\u4e2d\u62c9\u53d6playbooks </li> <li>ansible-vault \u6587\u4ef6\u52a0\u89e3\u5bc6\u5de5\u5177 </li> <li>ansible-console REPL\u63a7\u5236\u53f0\u6267\u884cAnsible\u4efb\u52a1</li> </ul>"},{"location":"chap4/13Ansible_int/#_2","title":"\u91cd\u8981\u6587\u4ef6","text":"<ul> <li><code>/etc/ansible/ansible.cfg</code>\uff1a \u914d\u7f6e\u6587\u4ef6\uff0c\u4e00\u822c\u60c5\u51b5\u65e0\u9700\u4fee\u6539</li> <li><code>/etc/ansiblelbosts</code>\uff1a  \u4e3b\u673a\u6e05\u5355\uff0c\u4fdd\u5b58\u4efd\u7406\u7684\u4e3b\u673a\u7684\u4fe1\u606f</li> <li><code>/etc/ansible/roles/</code> \u516c\u5171\u89d2\u8272 </li> </ul>"},{"location":"chap4/13Ansible_int/#inventory","title":"Inventory","text":"<p>\u793a\u4f8b\u914d\u7f6e</p> <pre><code>118.25.36.248 ansible_ssh_pass=\"**\"\n111.231.83.137 ansible_ssh_pass=\"**\"\n\n[servers]\n118.25.36.248\n111.231.83.137\n\n[servers:vars]\nansible-ssh_user=root\n</code></pre> <p>\u4e3b\u673a</p> <pre><code>192.168.0.2\n\nwww.example.com\n\nwww[01:50].example.com\ndb-[a:f].example.com\n</code></pre> <p>\u4e3b\u673a\u53d8\u91cf</p> <pre><code>\u4e3b\u673a k1=v1  k2=v2 ...\n</code></pre> <p>\u7ec4</p> <pre><code>[\u7ec4\u540d]\n\u4e3b\u673a k1=v1  k2=v2 ...\n\u4e3b\u673a k1=v1  k2=v2 ...\n</code></pre> <p>\u7ec4\u53d8\u91cf</p> <pre><code>[\u7ec4\u540d:vars]\n\u4e3b\u673a k1=v1  k2=v2 ...\n\u4e3b\u673a k1=v1  k2=v2 ...\n</code></pre>"},{"location":"chap4/13Ansible_int/#_3","title":"\u521d\u6b65\u4f53\u9a8c","text":"<p>\u793a\u4f8b\uff1a\u5728\u6307\u5b9a\u4e3b\u673a\u4e0a\u521b\u7406\u6587\u4ef6 </p> <pre><code>ansible  118.25.36.248 -m copy \"'content='hello' dest=/root/hello.txt\"\n</code></pre> <ul> <li><code>118.25.36.248</code>\uff1a \u4e3b\u673a\u6216\u7ec4</li> <li>copy: \u6a21\u5757</li> <li><code>dest=/root/hello.txt</code> \u53c2\u6570</li> </ul> <p>\u67e5\u770b\u6240\u6709\u6a21\u5757</p> <pre><code>ansible-doc -l\n</code></pre> <p>\u67e5\u770b\u53c2\u6570\u6587\u6863</p> <pre><code>ansible-doc -s copy\n</code></pre> <p>\u5e42\u7b49\u6027</p> <p>\u540c\u6837\u7684\u6761\u4ef6\uff0e\u4e00\u6b21\u8bf7\u6c42\u548c\u91cd\u590d\u7684\u591a\u6b21\u8bf7\u6c42\u5bf9\u7cfb\u7edf\u8d44\u6e90\u7684\u5f71\u664c\u662f\u4e00\u81f4\u7684 </p>"},{"location":"chap4/13Ansible_int/#modules","title":"Modules","text":"<p>\u9ed8\u8ba4\u6a21\u5757\uff1acommand</p> <pre><code>ansible servers -a \"date\"\n</code></pre> <p>\u5e38\u7528\u6a21\u5757\uff1a </p> <pre><code>ping  command shell  yum  pip copy \n\nuser  group  get_url file template unarchive \n</code></pre> <p>\u793a\u4f8b\uff1a\u5b89\u88c5docker/ \u914d\u7f6e\u52a0\u901f\u955c\u50cf\uff0f\u542f\u52a8 </p> <pre><code>ansible servers -m yum -a \"name=docker state=latest skip_broken=yes\" \n\nansible servers -m copy -a \"src=/etc/docker/dasmon.json dest=/etc/docker/daemon.json\" \n\nansible servers -m service -a \"name=docker state=started enabled=yes\" \n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook","title":"playbook","text":"<p>\u7f16\u5199playbook\u6587\u4ef6\uff1a docker.yml</p> <pre><code>---\n- hosts: servers \n  remote_user: root \n  tasks: \n  - name: ensure docker is at the latest version \n    yum: name=docker state=latest skip_broken=yes \n  - name: config docker daemon \n    copy: src=tetc/docker/daemon.json dest=/etc/docker/daemon.json \n    notify: \n    - restart docker \n  - name: ensure docker is running \n    service: name=docker state=started \n  handlers: \n    - name: restart docker \n      service: name=httpd state=restarted \n</code></pre> <p>host:  \u4e3b\u673a / <code>remote_user</code>: \u7528\u6237 / task: \u4efb\u52a1 / name: \u4efb\u52a1\u540d\u79f0 / notify \u53d8\u66f4\u901a\u77e5 / handler \u5904\u7406\u5668</p> <pre><code>ansible-playbook docker.yml\n</code></pre> <p></p> <ul> <li>\u5267\u672c\uff1a site.yml</li> <li>\u89d2\u8272\uff1a docker mongo mariadb<ul> <li>\u666e\u901a\u6587\u4ef6\uff1a files</li> <li>\u6a21\u677f\u6587\u4ef6\uff1atemplaIes </li> <li>\u9ed8\u8ba4\u53d8\u91cf: defaults </li> <li>\u5176\u4ed6\u53d8\u91cf\uff1a vars </li> <li>\u5143\u6570\u636e\uff1a meta</li> <li>\u5305\u542b\u8be5\u89d2\u8272\u8981\u6267\u884c\u7684\u4efb\u52a1\u5217\u8868\uff1a tasks </li> <li>\u5904\u7406\u5668\uff0c\u4e0d\u4ec5\u8be5\u89d2\u8272\u53ef\u4ee5\u4f7f\u7528\uff0c\u5176\u4ed6\u89d2\u8272\u4e5f\u80fd\u4f7f\u7528\uff1bhandlers </li> </ul> </li> </ul>"},{"location":"chap4/13Ansible_int/#playbook-roles","title":"Playbook Roles","text":"<p>\u5267\u672c\uff1a site.yml</p> <pre><code>---\n- hosts: 118.25.36.248 \n  roles:\n    - docker\n    - { role: mongo, port: 27017 } \n- hosts: 111.231.83.137 \n  roles: \n    - docker \n    - { role: mariadb, port: 3306 }\n</code></pre> <p>roles \u4f7f\u7528\u89d2\u8272</p> <p>\u521b\u5efa\u89d2\u8272:   <code>roles/docker/task/main.yml</code></p> <pre><code>- name: ensure docker is at the latest version \n  yum: name=docker state=latest skip_broken=yes \n- name: config docker daemon \n  copy: src=daemon.json dest=/etc/docker/daemon.json \n  notify: \n  - restart docker \n- name: ensure docker is running \n  service: name=docker state=started \n</code></pre> <p><code>roles/docker/handler/main.yml</code></p> <pre><code>- name: restart docker \n   service: name=httpd state=restarted \n</code></pre> <p><code>roles/docker/file/daemon.json</code></p> <pre><code>{\n\"registry-mirrors\": [\"https://obww7jhl.mirror.aliyuncs.com\"]\n}\n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook-variables","title":"Playbook Variables","text":"<p>\u5b9a\u4e49\u53d8\u91cf</p> <ul> <li>\u5728Inventory\u4e2d\u5b9a\u4e49 </li> </ul> <pre><code>test.com http_port=80\n</code></pre> <ul> <li>\u5728Playbook\u4e2d\u5b9a\u4e49</li> </ul> <pre><code>---\n- hosts: 118.25.36.248 \n  vars: \n    port: 27017 \n  roles: \n    - docker \n    - mongo\n</code></pre> <ul> <li>\u5728role\u4e2d\u5b9a\u4e49</li> </ul> <pre><code>---\n- hosts: 118.25.36.248 \n  roles: \n    - docker \n    - { role:mongo, port:27017 }\n</code></pre> <ul> <li>\u7cfb\u7edf\u4fe1\u606f\u53d8\u91cf Facts</li> </ul> <pre><code>ansible hostname -m setup \n</code></pre> <ul> <li>\u5c5e\u6027 <code>{{ ansible_hostname }}</code></li> <li>\u5c42\u7ea7\u5c5e\u6027 <code>{{ ansible_devices.vda.size }}</code> </li> <li>\u6570\u7ec4 <code>{{ ansible_dns.nameservers[0] }}</code></li> </ul> <p>\u4f7f\u7528\u53d8\u91cf</p> <pre><code>- name: Run mongo container \n  docker: \n    name: mongo \n    image: mongo:latest \n    state: started \n    ports: \n    - \"{{port}}:27017\" \n    volumes: \n    - mongo_data:/data/db \n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook-templatejinja2","title":"Playbook Template(Jinja2)","text":"<p>\u7f16\u5199\u6a21\u677f</p> <pre><code>{\n\"registry-mirrors\": [ {{mirror_url }} ]\n}\n</code></pre> <p>\u4f7f\u7528\u6a21\u677f</p> <pre><code>- name: config docker daemon \n    copy: src=tetc/docker/daemon.json dest=/etc/docker/daemon.json \n    notify: \n    - restart docker \n</code></pre> <p>\u9ad8\u7ea7\u5e94\u7528</p> <p>Filter / Test / Lookup</p>"},{"location":"chap4/13Ansible_int/#playbook-loops","title":"Playbook Loops","text":"<pre><code>- name: add several users \n  user: \n    name: \"{{ item.name }}\" \n    state: present \n    groups: \"{{ item.group }}\"  \n  loop: \n    - testuser1 \n    - testuser2 \n</code></pre> <p>Equal:</p> <pre><code>- name: add user testuser1\n  user:\n    name: \"testuser1\" \n    state: present\n    group: \"wheel\"\n- name: add user testuser2\n  user:\n    name: \"testuser2\" \n    state: present\n    group: \"wheel\"\n</code></pre> <p>List\u5bf9\u8c61</p> <pre><code>- name: add several users \n  user: \n    name: \"{{ item.name }}\" \n    state: present \n    groups: \"{{ item.groups }}\" \n  loop: \n    - { name: 'testuser1', groups: 'wheel' } \n    - { name: 'testuser2', groups: 'root' } \n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook-conditionals","title":"Playbook Conditionals","text":"<p>When\uff1a \u6761\u4ef6\u5224\u65ad</p> <pre><code>- tasks: \n  - name: \"shut down CentOS flavored systems\" \n    command: /sbin/shutdown -t now \n    when: anslble os_ family == \"CentOS\" \n</code></pre> <p>\u6761\u4ef6 and\u3001or</p> <pre><code>tasks: \n  - name: \"shut down CentOS 6 and CentOS 7 systems\" \n    command: /sbin/shutdown -t now \n    when: ansible_distribution == \"CentOS\" or \n      ansible distribution == \"Alpine\" \n</code></pre> <p>\u6761\u4ef6 and</p> <pre><code>tasks: \n  - name: \"shut down CentOS 6 and CentOS 7 systems\" \n    command: /sbin/shutdown -t now \n    when: \n      - ansible_distribution == \"CentOS\"      \n      - ansible_distribution_major_version == \"6\" \n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook-tags","title":"Playbook Tags","text":"<pre><code>task\uff1a\n - name \"print date\"\n    command: date\n    tags:\n        - date\n</code></pre> <pre><code>task\uff1a\n - name \"print date\"\n    command: date\n    tags: [date, now]\n</code></pre> <pre><code>roles:\n- { role: webserver, tags:['web','foo'] }\n</code></pre> <p>\u4f7f\u7528TAG</p> <pre><code>ansible-playbook test.yml --tags \"date\"\n</code></pre> <p>\u8df3\u8fc7TAG</p> <pre><code>ansible-playbook test.yml --skip-tags \"date\"\n</code></pre>"},{"location":"chap4/13Ansible_int/#playbook-block","title":"Playbook Block","text":"<pre><code>- name: Attempt and graceful] roll back demo \n  block: \n    - debug: \n        msg: \"I execute normally\" \n    - command: /bin/false \n    - debug:\n        msg: 'I never execute, due to the above task falling' \n  rescue: \n    - debug: \n        msg: 'I caught an error' \n    - command: /bin/false \n    - debug: \n        msg: 'I also never execute'\n  always: \n    - debug: \n        msg: 'this always executes'\n</code></pre> <ul> <li>block: \u666e\u901a\u6a21\u5757</li> <li>rescue: \u5f02\u5e38\u65f6\u6267\u884c</li> <li>always: \u603b\u662f\u6267\u884c</li> </ul>"},{"location":"chap4/13Ansible_int/#ansible-secret","title":"Ansible Secret","text":"<pre><code>.\n\u251c\u2500\u2500 group_vars\n\u2502   \u2514\u2500\u2500 all\n\u2502       \u251c\u2500\u2500 vars\n\u2502       \u2514\u2500\u2500 vault\n\u251c\u2500\u2500 templates\n\u2502   \u2514\u2500\u2500 password.j2\n\u2514\u2500\u2500 vault.yml\n</code></pre> <ul> <li>vars: <code>password: '{{vault_password}}'</code></li> <li>vault: <code>vault_password: thisIsnotAgoodPassword</code></li> </ul> <pre><code>ansible-vault encrypt vault\n\nansible-vault edit vault\n</code></pre> <p>password.j2: <code>The password is {{password}}</code></p> <pre><code>ansible-playbook -i ../inventory.ini vault.yml --tags create --ask-vault-pass\n</code></pre>"},{"location":"chap4/14Ansible_containerd/","title":"L14 Ansible Role\u6279\u91cf\u90e8\u7f72Containerd\u670d\u52a1","text":"<p>kubernetes 1.24\u7248\u672c\u6b63\u5f0f\u5f03\u7528docker\uff0c\u4f7f\u7528Containerd\u66ff\u6362Docker\u4e3akubernetes\u96c6\u7fa4\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u3002</p> <p>\u4f7f\u7528ansible\u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177\u5728\u4f01\u4e1a\u5185\u7f51\u73af\u5883\uff0c\u4f7f\u7528\u4e8c\u8fdb\u5236\u8fdb\u884c\u90e8\u7f72containerd\u670d\u52a1\uff0c\u5e76\u5236\u4f5c\u6210role\uff0c\u8981\u6c42\u5177\u6709\u5e42\u7b49\u6027\uff0c\u670d\u52a1\u4ee5system\u8fdb\u884c\u542f\u52a8\u548c\u7ba1\u7406\uff0c\u4ee5\u53d8\u91cf\u7684\u5f62\u5f0f\u58f0\u660e\u7248\u672c\u53f7\uff0c\u65b9\u4fbf\u8fdb\u884c\u590d\u7528\u3002</p>"},{"location":"chap4/14Ansible_containerd/#1ansible-role","title":"1.\u521b\u5efaAnsible Role","text":"<p>\u4f7f\u7528ansible-galaxy\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u65b0\u7684Ansible Role</p> <pre><code>$ cd /etc/ansible\n$ ansible-galaxy init  roles/containerd\n</code></pre> <p>\u8fd9\u5c06\u521b\u5efa\u4e00\u4e2a\u540d\u4e3acontainerd\u7684\u65b0Role\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u7684\u76ee\u5f55\u548c\u6587\u4ef6\u3002</p>"},{"location":"chap4/14Ansible_containerd/#2","title":"2.\u58f0\u660e\u73af\u5883\u53d8\u91cf","text":"<p>\u58f0\u660e\u76f8\u5173\u73af\u5883\u53d8\u91cf\uff0c\u4e0d\u540c\u7684\u73af\u5883\u4fee\u6539\u53d8\u91cf\u7684\u503c\u5373\u53ef\u3002</p> <pre><code>$ cat /etc/ansible/roles/containerd/vars/main.yml\n---\n# \u58f0\u660econtainerd\u7248\u672c\u53f7\ncontainerd_version: 1.7.4\n# \u58f0\u660e\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u4f4d\u7f6e\ncontainerd_file_dir: /mnt/containerd-file\n# \u58f0\u660enerdctl\u5ba2\u6237\u7aef\u5de5\u5177\u7248\u672c\u53f7\nnerdctl_version: 1.5.0\n</code></pre>"},{"location":"chap4/14Ansible_containerd/#3","title":"3.\u4e0b\u8f7d\u79bb\u7ebf\u5b89\u88c5\u5305","text":"<pre><code>$ wget -P /etc/ansible/roles/containerd/file/ \\\nhttp://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm\n$ wget -P /etc/ansible/roles/containerd/file/ \\\nhttps://github.com/containerd/containerd/releases/download/v1.7.4/containerd-1.7.4-linux-amd64.tar.gz\n$ wget -P /etc/ansible/roles/containerd/file/ \\\nhttps://github.com/containerd/nerdctl/releases/download/v1.5.0/nerdctl-full-1.5.0-linux-amd64.tar.gz\n\n# \u521b\u5efanerdctl\u5ba2\u6237\u7aef\u7ba1\u7406\u5de5\u5177\u7684\u914d\u7f6e\u6587\u4ef6\n$ cat&lt;&lt;EOF &gt; /etc/ansible/roles/containerd/files/crictl.yaml\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///var/run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n</code></pre>"},{"location":"chap4/14Ansible_containerd/#4ansible-playbook","title":"4.\u7f16\u5199Ansible Playbook","text":"<p>\u5728containerd Role\u7684tasks\u76ee\u5f55\u4e0b\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3amain.yml\u7684\u6587\u4ef6\uff0c\u7f16\u5199Ansible Playbook\uff0c\u5b9e\u73b0Containerd\u7684\u4e8c\u8fdb\u5236\u90e8\u7f72\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u793a\u4f8bPlaybook\uff1a</p> <pre><code>$ cat /etc/ansible/roles/containerd/tasks/main.yml\n\n---\n# \u4efb\u52a11\uff1a\u5b89\u88c5\u4f9d\u8d56\u5305\n- name: \"Example Task\"\n  debug: \n    msg: \"Containerd file directory is {{ containerd_file_dir }}\"\n- name: \"[1] \u5b89\u88c5\u4f9d\u8d56\u5305libseccomp\uff08rpm)\"\n  block:\n  - name: \"[1.1] \u521b\u5efa\u6587\u4ef6\u5b58\u653e\u76ee\u5f55\"\n    file: \n      name: \"{{ containerd_file_dir }}/nerdctl\"\n      state: directory\n  - name: \"[1.2] \u5206\u53d1libseccomp\u4f9d\u8d56\u5305\"\n    copy:\n      src: libseccomp-2.5.1-1.el8.x86_64.rpm\n      dest: \"{{ containerd_file_dir }}/libseccomp-2.5.1-1.el8.x86_64.rpm\"\n  - name: \"[1.3] \u5b89\u88c5libseccomp\"\n    yum: \n      name: \"{{ containerd_file_dir }}/libseccomp-2.5.1-1.el8.x86_64.rpm\"\n      state: present\n\n# \u4efb\u52a12\uff1a \u4e8c\u8fdb\u5236\u5b89\u88c5containerd\n- name: \"[2] \u4e8c\u8fdb\u5236\u5b89\u88c5Containerd\u670d\u52a1\"\n  block:\n  - name: \"[2.1] \u521b\u5efa\u5b89\u88c5\u76ee\u5f55\"\n    file:\n      name: /etc/containerd\n      state: directory\n  - name: \"[2.2] \u5206\u53d1\u5e76\u89e3\u538b\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\"\n    unarchive: \n      src: \"cri-containerd-{{ containerd_version }}-linux-amd64.tar.gz\"\n      dest: \"{{ containerd_file_dir }}\"\n    when:  ansible_architecture == \"x86_64\"\n  - name: \"[2.3] Copy\u53ef\u6267\u884c\u6587\u4ef6\u5230PATH\"\n    copy:\n      src: \"{{ containerd_file_dir }}/usr/local/{{ item }}\"\n      dest: /usr/local/bin/\n      remote_src: true\n      mode: '0755'\n    with_items:\n      - 'bin/ctr'\n      - 'bin/crictl'\n      - 'bin/critest'\n      - 'bin/ctd-decoder'\n      - 'bin/containerd'\n      - 'bin/containerd-stress'\n      - 'bin/containerd-shim'\n      - 'bin/containerd-shim-runc-v1'\n      - 'bin/containerd-shim-runc-v2'\n      - 'sbin/runc'\n  - name: \"[2.4] \u521b\u5efa\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\"\n    shell: containerd config default &gt; /etc/containerd/config.toml\n  - name: \"[2.5] \u4fee\u6539\u9a71\u52a8\u4e3asystemd\"\n    shell: sed -i 's#SystemdCgroup = false#SystemdCgroup = true#g' /etc/containerd/config.toml\n  - name: \"[2.6] \u521b\u5efa\u670d\u52a1\u542f\u52a8\u6587\u4ef6\"\n    copy:\n      src: \"{{ containerd_file_dir }}/etc/systemd/system/containerd.service\"\n      dest: /usr/lib/systemd/system/containerd.service\n      remote_src: true\n  - name: \"[2.7] \u542f\u52a8\u670d\u52a1\"\n    service: \n      name: containerd\n      state: started\n      enabled: yes\n  - name: \"[2.8] \u914d\u7f6ecrictl\u5ba2\u6237\u7aef\"\n    copy: \n      src: crictl.yaml\n      dest: /etc/crictl.yaml\n\n# \u90e8\u7f72\u5ba2\u6237\u7aef\u7ba1\u7406\u5de5\u5177nerdctl\n  - name: \"[3] \u90e8\u7f72\u5ba2\u6237\u7aef\u7ba1\u7406\u5de5\u5177nerdctl\"\n    block:\n    - name: \"[3.1] \u5206\u53d1\uff08\u4e8c\u8fdb\u5236\uff09\u5b89\u88c5\u5305\"\n      unarchive:\n        src: \"nerdctl-full-{{ nerdctl_version }}-linux-amd64.tar.gz\"\n        dest: \"{{ containerd_file_dir }}/nerdctl/\"\n    - name: \"[3.2] \u590d\u5236\u53ef\u6267\u884c\u6587\u4ef6\u5230PATH\"\n      copy: \n        src: \"{{ containerd_file_dir }}/nerdctl/bin/nerdctl\"\n        dest: /usr/local/bin/\n        mode: '0755'\n        remote_src: true\n# \u6e05\u7406\u5b89\u88c5\u73af\u5883\n- name: \"[4.0] \u6e05\u7406\u5b89\u88c5\u73af\u5883\"\n  file: \n    name: \"{{ containerd_file_dir }}\"\n    state: absent\n</code></pre>"},{"location":"chap4/14Ansible_containerd/#5role","title":"5.\u4f7f\u7528role\u6279\u91cf\u90e8\u7f72\u670d\u52a1","text":"<p>\u4f7f\u7528Role\uff1a\u5728\u5176\u4ed6Playbook\u6216\u4efb\u52a1\u4e2d\uff0c\u4f7f\u7528\u8fd9\u4e2aRole\u6765\u5b89\u88c5Containerd\u3002\u4f8b\u5982\uff1a</p> <ul> <li>\u8bbe\u7f6ehosts</li> </ul> <p><code>$ cat  /etc/ansible/hosts</code></p> <pre><code>[lidabai]\n192.168.2.20\n192.168.2.21\n192.168.2.22\n\n[lidabai:vars]\nansible_ssh_user=lidabai   #ssh\u7528\u6237\uff08\u88ab\u7ba1\u4e3b\u673a\uff09\nansible_ssh_port=22     #ssh\u7aef\u53e3\uff08\u88ab\u7ba1\u4e3b\u673a\uff09\nansible_ssh_pass=8888888  #ssh\u7528\u6237\u5bc6\u7801\uff08\u88ab\u7ba1\u4e3b\u673a\uff09\n</code></pre> <pre><code>$ cat &lt;&lt;EOF &gt; k8s-install-containerd.yml\n---\n- name: \u201cInstall Containerd Server\u201d\n  hosts: lidabai\n  become: true   #\u662f\u5426\u8fdb\u884csudo\u63d0\u6743\n  roles:\n    - containerd\nEOF\n$ ansible-plabook k8s-install-containerd.yml\n</code></pre> <p>\u8fd9\u4e2aPlaybook\u4f1a\u5728webservers\u4e3b\u673a\u7ec4\u4e0a\u5b89\u88c5Containerd\u3002\u7531\u4e8e\u8fd9\u4e2aRole\u5177\u6709\u5e42\u7b49\u6027\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728\u591a\u6b21\u8fd0\u884c\u65f6\u4fdd\u8bc1\u6b63\u786e\u6027\u3002</p> <p>\u901a\u8fc7\u4ee5\u4e0a\u6b65\u9aa4\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528Ansible\u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177\u4e8c\u8fdb\u5236\u90e8\u7f72Containerd\u670d\u52a1\uff0c\u5e76\u5236\u4f5c\u6210\u5177\u6709\u5e42\u7b49\u6027\u7684Role\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e2aPlaybook\u4e2d\u7684\u53d8\u91cf\u548c\u8def\u5f84\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"chap4/1ansible_intro/","title":"L1 Ansible Introduction","text":""},{"location":"chap4/1ansible_intro/#1what-is-ansible","title":"1\u3001What is Ansible","text":"<p>It's a simple automation language that can perfectly describe an IT application infrastructure in Ansible Playbooks. </p> <p>It's an automation engine that runs Ansible Playbooks. </p> <p>Ansible Tower by Red Hat is an enterprise framework for controlling, securing and managing your Ansible automation with a UI and restful API. </p>"},{"location":"chap4/1ansible_intro/#2why-ansible","title":"2\u3001Why Ansible","text":""},{"location":"chap4/1ansible_intro/#2-1-simple","title":"2-1 Simple","text":"<ul> <li>Human readable automation</li> <li>No special coding skills needed</li> <li>Tasks executed in order</li> <li>Get executed quickly</li> </ul>"},{"location":"chap4/1ansible_intro/#2-2-powerful","title":"2-2 Powerful","text":"<ul> <li>App deployment</li> <li>Configuration management</li> <li>Workflow orchestration</li> <li>Orchestrate the app life cycle</li> </ul>"},{"location":"chap4/1ansible_intro/#2-3-agentless","title":"2-3 Agentless","text":"<ul> <li>Agentless architecture</li> <li>Uses OpenSSH $ WinRM</li> <li>No agent to exploit or update</li> <li>More efficient &amp; more secure</li> </ul>"},{"location":"chap4/1ansible_intro/#3what-can-i-use-ansible-to-do","title":"3\u3001What Can I use ansible to do","text":"<ul> <li>Config management</li> <li>App Deployment</li> <li>Provision</li> <li>Continuous Delivery</li> <li>Security &amp; Compliance</li> <li>Orchestration</li> </ul>"},{"location":"chap4/1ansible_intro/#4ansible-architecture","title":"4\u3001Ansible Architecture","text":""},{"location":"chap4/1ansible_intro/#4-1-modules","title":"4-1 MODULES","text":"<ul> <li>Modules control systems resources, packages, files or nearly anything else </li> <li>Over 450 ship with Ansible </li> <li>Enable regular users to easily work with complex systems </li> <li>But more on these later... </li> </ul>"},{"location":"chap4/1ansible_intro/#5where-go-get-it-and-how-to-install","title":"5\u3001Where go get it and how to install","text":""},{"location":"chap4/1ansible_intro/#5-1-os-packages","title":"5-1 Os packages","text":"<ul> <li>EPEL</li> <li>APT</li> </ul>"},{"location":"chap4/1ansible_intro/#5-2-also-from","title":"5-2 Also from","text":"<ul> <li>Pypi</li> <li>Sources (via Github)</li> </ul>"},{"location":"chap4/1ansible_intro/#6ansible-lanaguage-basics","title":"6\u3001Ansible lanaguage basics","text":""},{"location":"chap4/1ansible_intro/#6-1-playbooks","title":"6-1 playbooks","text":"<ul> <li>Plain-text YAML files that describe the desired state of something </li> <li>Human and machine readable </li> <li>Can be used to build entire application environments</li> </ul>"},{"location":"chap4/1ansible_intro/#6-2-variables","title":"6-2 variables","text":"<p>There are many different ways to source variables</p> <ul> <li>Playbooks</li> <li>Files</li> <li>Inventories(group vars, host vars)</li> <li>Command line</li> <li>Discovered variables(fact)</li> <li>Ansible Tower</li> </ul>"},{"location":"chap4/1ansible_intro/#6-3-inventories","title":"6-3 Inventories","text":"<ul> <li>Static lines of servers</li> <li>Ranges</li> <li>Other custom things</li> <li>Dynamic list of servers: AWS, Azure, GCP. etc</li> </ul>"},{"location":"chap4/1ansible_intro/#6-4-basic-of-playbooks","title":"6-4 Basic of playbooks","text":"<ul> <li>Playbooks contain plays</li> <li>Plays contain tasks</li> <li> <p>Tasks call modules</p> </li> <li> <p>Tasks run sequentially</p> </li> <li> <p>Handlers are tiggered by tasks, and are run once, at the end of plays</p> </li> </ul> <pre><code>---\n- name: install and start apache \n  hosts: web \n  remote_user: justin \n  become_method: sudo  \n  become_user: root\n  vars: \n    http_port: 80 \n    max_clients: 200 \n\n  tasks: \n  - name: install httpd \n    yum: name=httpd state=latest \n  - name: write apache config file \n    template: src=srv/httpd.j2 dest=/etc/httpd.conf \n    notify: \n    - restart apache \n  - name: start httpd \n    service: name=httpd state=running \n\n  handlers: \n  - name: restart apache \n  service: name=httpd state=restarted \n</code></pre>"},{"location":"chap4/1ansible_intro/#6-5-modules","title":"6-5 MODULES","text":"<p>There are over 450 Ansible-provided modules that automate nearly every part of your environment </p> <p>Standard structure: </p> <p><code>module: directivel=value directive2=value</code></p>"},{"location":"chap4/1ansible_intro/#7ansible-simple-usage","title":"7\u3001Ansible Simple Usage","text":""},{"location":"chap4/1ansible_intro/#7-1-advanced-ansible-playbook-capabilities","title":"7-1 Advanced Ansible Playbook Capabilities","text":"<p>Ansible has many different ways to alter how Playbooks run: </p> <pre><code>with items, failed when, changed when, until, ignore errors \n</code></pre> <p><code>http://docs.ansible.com/ansible/playbooks_specialiopics.html</code></p> <p>Ansible Roles are a special kind of Playbook that are fully self-contained with <code>tasks</code>, <code>variables</code>, <code>configurations templates</code>, and <code>other supporting files</code>. </p> <p><code>http://docs.ansible.tom/ansible/playbooks_roles.html</code></p>"},{"location":"chap4/1ansible_intro/#7-2-using-ad-hoc-commands","title":"7-2 Using AD-Hoc Commands","text":"<p>Runs a command or calls module directory from the command line, no Playbook required</p> <pre><code>$ ansible &lt;inventory&gt; &lt;options&gt; \n$ ansible web -a /bin/date \n$ ansible web -m ping \n$ ansible web -m yum -a \"name=openssl state=latest\" \n</code></pre>"},{"location":"chap4/1ansible_intro/#7-3-running-playbooks","title":"7-3 Running Playbooks","text":"<p>Runs a playbook on selected inventories from the command line</p> <pre><code>$ ansible-playbook &lt;options&gt; \n$ ansible-playbook my-playbook.yml \n</code></pre>"},{"location":"chap4/1ansible_intro/#7-4-check-mode-c","title":"7-4 CHECK MODE <code>-C</code>","text":"<p>Dry-run for ad-hoc commands and Playbooks </p> <p>Validate Playbook runs before making state changes on target systems </p> <pre><code>$ ansible web -C -m yum -a \"name=httpd state=latest\" \n$ ansible-playbook -C my-playbook.yml \n</code></pre>"},{"location":"chap4/1ansible_intro/#7-5-ansible-tower","title":"7-5 Ansible Tower","text":""},{"location":"chap4/1ansible_intro/#8ansible-galaxy","title":"8\u3001Ansible Galaxy","text":"<ul> <li>Source of community and vendor-provided Ansible Roles to help you get started faster. </li> <li>Learn from others that are automating with Ansible. </li> <li>Galaxy Roles are often directly runnable with little modification. </li> </ul>"},{"location":"chap4/2ansible_over_install/","title":"L2 Ansible Install(MacOs) and Environment Setup","text":""},{"location":"chap4/2ansible_over_install/#1ansible-overview","title":"1\u3001Ansible Overview","text":"<ul> <li>Ansible is designed to automate systems management tasks (modifying and managing a configuration file, for example) </li> <li>Allows creation of idempotent scripts </li> </ul>"},{"location":"chap4/2ansible_over_install/#2ansible-basic","title":"2\u3001Ansible Basic","text":"<ul> <li>Ansible \"programs\" are called plays, and are a collection of tasks in a playbook </li> </ul> <pre><code>---\n- hosts: all \n  tasks: \n  - name: Do something \n    module: \n      parameter: value \n      parameter: '{{variable}}'\n</code></pre> <ul> <li>Plays are run against target hosts defined in an inventory </li> </ul> <pre><code>[web] \nweb1 ansible_ssh_host=web1.example.com variable=value \nweb2 ansible_ssh_host=web2.example.com variable=value2\n</code></pre>"},{"location":"chap4/2ansible_over_install/#3ansible-install","title":"3\u3001Ansible Install","text":"<p>https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#basics-what-will-be-installed</p>"},{"location":"chap4/2ansible_over_install/#3-1-brew","title":"3-1 brew","text":"<pre><code>$ brew install ansible\n</code></pre>"},{"location":"chap4/2ansible_over_install/#3-2-pip","title":"3-2 pip","text":"<pre><code>$ pip3 search ansible\n$ pip3 install ansible==2.8.4\n</code></pre> <pre><code>$ ansible --version\nansible 2.8.4\n  config file = None\n  configured module search path = ['/Users/i515190/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/local/lib/python3.7/site-packages/ansible\n  executable location = /usr/local/bin/ansible\n  python version = 3.7.4 (default, Jul  9 2019, 18:13:23) [Clang 10.0.1 (clang-1001.0.46.4)]\n</code></pre>"},{"location":"chap4/2ansible_over_install/#4environment-setup","title":"4\u3001Environment Setup","text":"<p>Working with Inventory</p> <p><code>default inventory</code>(<code>/etc/ansible/hosts</code>)</p> <p>You can specify a different inventory file using the <code>-i &lt;path&gt;</code> option on the command line.</p>"},{"location":"chap4/2ansible_over_install/#4-1-inventoryini-for-all-roles-and-servers","title":"4-1 <code>inventory.ini</code> for all roles and servers","text":"<pre><code>[all:children]\ngithost_servers\nk8s_servers\n\n# [DEPRECATION WARNING]: The TRANSFORM_INVALID_GROUP_CHARS settings is set to allow bad characters in group names by default\n# dont use \"-\" dash as \"group name\"\n# \".\" dot and \"_\" underline are working fine\n[githost_servers]\ngithost ansible_ssh_host=192.168.33.10 \n\n[k8s_servers]\nk8s-jx  ansible_ssh_host=10.151.30.11\nk8s-jx1 ansible_ssh_host=10.151.30.22\nk8s-jx2 ansible_ssh_host=10.151.30.23\n\n[k8s_servers:vars]\nansible_ssh_user=vagrant\n\n[githost_servers:vars]\nansible_ssh_user=vagrant\n\n[web]\ngithost\nk8s-jx\n\n[db]\nk8s-jx1\nk8s-jx2\n\n[backup]\nk8s-jx2\n\n\n# [servers:vars]\n# ansible_python_interpreter=/usr/local/bin/python3\n</code></pre>"},{"location":"chap4/2ansible_over_install/#hosts-and-group","title":"Hosts and group","text":"<pre><code>[githost_servers]\ngithost ansible_ssh_host=192.168.33.10 \n\n[k8s_servers]\nk8s-jx  ansible_ssh_host=10.151.30.11\nk8s-jx1 ansible_ssh_host=10.151.30.22\nk8s-jx2 ansible_ssh_host=10.151.30.23\n</code></pre> <p><code>ansible_ssh_host</code></p>"},{"location":"chap4/2ansible_over_install/#group-and-variable","title":"group and variable","text":"<pre><code>[k8s_servers:vars]\nansible_ssh_user=vagrant\n\n[githost_servers:vars]\nansible_ssh_user=vagrant\n</code></pre>"},{"location":"chap4/2ansible_over_install/#groups-and-groups","title":"groups and groups","text":"<ul> <li>all group (because it is the \u2018parent\u2019 of all other groups)</li> <li>parent group</li> <li>child group</li> <li>host</li> </ul> <pre><code>[all:children]\ngithost_servers\nk8s_servers\n</code></pre>"},{"location":"chap4/2ansible_over_install/#ad-hocsh","title":"<code>ad-hoc.sh</code>","text":"<pre><code>#!/bin/bash\nansible -m ping -i ../inventory.ini all\n\n# ansible -m ping -i ../inventory web1 -u vagrant\n</code></pre> <p>Output:</p> <pre><code>k8s-jx1 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nk8s-jx | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\ngithost | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nk8s-jx2 | SUCCESS =&gt; {\n    \"ansible_facts\": {\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\n    },\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n</code></pre>"},{"location":"chap4/3play_task/","title":"L3 Task Execution management","text":""},{"location":"chap4/3play_task/#1-defining-task-execution-with-host-groups","title":"1. Defining task execution with host groups","text":"<p><code>task2-1.yaml</code></p> <pre><code>---\n- hosts: all\n  tasks:\n  - name: create tmp folder on all servers\n    file:\n      dest: $HOME/tmp/\n      state: directory\n\n\n- hosts: all\n  tasks:\n  - name: create a file on a remote machine\n    file:\n      dest: $HOME/tmp/file\n      state: '{{file_state}}'\n\n- hosts: web\n  tasks:\n  - name: create file on web machines\n    file:\n      dest: $HOME/tmp/web-file\n      state: '{{file_state}}'\n\n- hosts: all:!db\n  tasks:\n  - name: create file on web machines\n    file:\n      dest: $HOME/tmp/web-not-db-file\n      state: '{{file_state}}'\n\n- hosts: all:&amp;backup:!web\n  tasks:\n  - name: create file on web machines\n    file:\n      dest: $HOME/tmp/backup-file\n      state: '{{file_state}}'\n\n# operators '&amp; and' and '! not'\n# Set \"file_state\" as variable passed in  '{{file_state}}'\n</code></pre> <ul> <li>operators '&amp; and' and '! not'</li> <li>Set <code>\"file_state\"</code> as variable passed in  <code>'{{file_state}}'</code></li> </ul>"},{"location":"chap4/3play_task/#1-1-filestate-directory","title":"1-1 <code>file.state: directory</code>","text":"<p>If directory, all intermediate subdirectories will be created if they do not exist. Since Ansible 1.7 they will be created with the supplied permissions.</p>"},{"location":"chap4/3play_task/#1-2-filestate-file_state","title":"1-2 <code>file.state: '{{file_state}}'</code>","text":"<ul> <li> <p>File module: https://docs.ansible.com/ansible/latest/modules/file_module.html#file-module</p> </li> <li> <p>once with the state of touch, create this file if it doesn't exist</p> </li> <li>Seoncd time, we'll run it with the state of absent</li> </ul>"},{"location":"chap4/3play_task/#1-3-hosts-alldb-and-allbackupweb","title":"1-3 <code>hosts: all:!db</code> and <code>all:&amp;backup:!web</code>","text":"<ul> <li>operators <code>'&amp; and'</code> and <code>'! not'</code></li> <li>Set \"file_state\" as variable passed in  <code>'{{file_state}}'</code></li> </ul>"},{"location":"chap4/3play_task/#1-4-touch-file","title":"1-4 Touch file","text":"<pre><code>#!/bin/bash\nansible-playbook -i ../inventory.ini task2-1.yaml -e file_state=touch\n</code></pre> <ul> <li> <p><code>-e</code> EXTRA_VARS, set additional variables as <code>key=value</code> or <code>YAML/JSON</code>, if filename prepend with <code>@</code></p> </li> <li> <p>If <code>touch</code> (new in 1.4), an empty file will be created if the <code>path</code> does not exist, while an existing file or directory will receive updated file access and modification times, (similar to the way <code>touch</code> works from the command line).</p> </li> </ul>"},{"location":"chap4/3play_task/#1-5-delete-file","title":"1-5 Delete file","text":"<pre><code>#!/bin/bash\nansible-playbook -i ../inventory.ini task2-1.yaml -e file_state=absent\n</code></pre> <ul> <li> <p>If <code>absent</code>, directories will be recursively deleted, and files or symlinks will be unlinked. </p> </li> <li> <p>Note that <code>absent</code> will not cause <code>file</code> to fail if the path does not exist as the state did not change.</p> </li> </ul>"},{"location":"chap4/3play_task/#2-using-tags-to-limit-play-execution","title":"2. Using tags to limit play execution","text":"<p><code>task2-2-tag.yaml</code></p> <pre><code>---\n- hosts: all\n  tasks:\n  - name: create a file\n    file:\n      dest: $HOME/tmp/file\n      state: touch\n    tags:\n      - create-file\n\n- hosts: all:k8s_servers:!db\n  tags:\n    - delete-file\n  tasks:\n  - name: delete a file\n    file:\n      dest: $HOME/tmp/file\n      state: absent\n\n- hosts: web:githost\n  tasks:\n  - name: delete a file\n    file:\n      dest: /tmp/file\n      state: absent\n    tags:\n      - delete-file\n\n- hosts: all\n  tags:\n    - list-file\n  tasks:\n  - name: Recursively find /tmp files\n    find:\n      paths: $HOME/tmp/\n      recurse: yes\n    register: all_files\n\n  - debug:\n      msg: \"{{ all_files.files[0].path }}\"\n</code></pre>"},{"location":"chap4/3play_task/#2-1-add-tags","title":"2-1 Add tags","text":"<pre><code>- name: delete a file\n  file:\n    dest: $HOME/tmp/file\n    state: absent\n\ntags:\n  - create-file\n</code></pre> <pre><code>- hosts: all:k8s_servers:!db\n  tags:\n    - delete-file\n</code></pre>"},{"location":"chap4/3play_task/#2-2-take-advantage-tags","title":"2-2 Take advantage tags","text":"<pre><code>$ ansible-playbook -i ../inventory.ini task2-2-tag.yaml --skip-tags create-file --tags delete-file\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini task2-2-tag.yaml --tags create-file\n\n\nPLAY RECAP *********************************************************************************************************************************************\ngithost                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx                     : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx1                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n</code></pre> <p>Tags</p> <p>When you execute a playbook, you can filter tasks based on tags in two ways:</p> <p>On the command line, with the <code>--tags</code> or <code>--skip-tags</code> options</p> <pre><code>ansible-playbook -i ../inventory.ini task2-2-tag.yaml --skip-tags create-file --tags delete-file\n</code></pre> <ul> <li><code>--tags</code> or <code>--skip-tags</code> can be used both or just one</li> </ul>"},{"location":"chap4/3play_task/#2-3-list-files-in-directory","title":"2-3 List files in directory","text":"<pre><code>- hosts: all\n  tags:\n    - list-file\n  tasks:\n  - name: Recursively find /tmp files\n    find:\n      paths: $HOME/tmp/\n      recurse: yes\n    register: all_files\n\n  - debug:\n      msg: \"{{ all_files.files[0].path }}\"\n</code></pre> <p>Show output</p> <pre><code>- debug:\n      msg: \"{{ all_files.files[0].path }}\"\n</code></pre> <pre><code>\nTASK [debug] *******************************************************************************************************************************************\nok: [githost] =&gt; {\n    \"msg\": \"/home/vagrant/tmp/file\"\n}\nok: [k8s-jx] =&gt; {\n    \"msg\": \"/home/vagrant/tmp/file\"\n}\nok: [k8s-jx1] =&gt; {\n    \"msg\": \"/home/vagrant/tmp/file\"\n}\nok: [k8s-jx2] =&gt; {\n    \"msg\": \"/home/vagrant/tmp/file\"\n}\n\nPLAY RECAP *********************************************************************************************************************************************\ngithost                    : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx                     : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx1                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx2                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n</code></pre>"},{"location":"chap4/3play_task/#3-executing-tasks-on-localhost","title":"3. Executing tasks on localhost","text":""},{"location":"chap4/3play_task/#3-1-you-dont-have-to-create-host-for-localhost-ininventoryini","title":"3-1 You dont have to create host for <code>localhost</code> in<code>inventory.ini</code>","text":"<pre><code>---\n- hosts: localhost\n  tasks:\n  - name: Create a file via ssh connection\n    file:\n      dest: $HOME/Devops_sap/ansible/code/task2/2-3ssh-created\n      state: touch\n\n- hosts: localhost\n  connection: local\n\n  tasks:\n  - name: Create a file via sdirect local connection\n    file:\n      dest: $HOME/Devops_sap/ansible/code/task2/2-3direct-created\n      state: touch\n</code></pre>"},{"location":"chap4/3play_task/#4-limiting-plays-from-the-command-line","title":"4. Limiting plays from the command line","text":"<pre><code>---\n- hosts: all\n  tasks:\n  - name: the first task\n    file:\n      dest: $HOME/tmp/first-task\n      state: '{{file_state}}'\n  - name: the second task\n    file:\n      dest: $HOME/tmp/second-task\n      state: '{{file_state}}'\n  - name: the last task\n    file:\n      dest: $HOME/tmp/last-task\n      state: '{{file_state}}'\n</code></pre>"},{"location":"chap4/3play_task/#4-1-execute-from-start-and-step-by-name","title":"4-1 execute from <code>Start</code> and <code>Step</code> by name","text":"<pre><code>$ ansible-playbook -i ../inventory.ini task2-4-limit.yaml -e file_state=touch --start-at-task='the second task'\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini task2-4-limit.yaml -e file_state=touch --start-at-task='the second task'\n</code></pre> <p><code>--start-at-task='the second task'</code></p>"},{"location":"chap4/3play_task/#5-specifying-variables-via-inventory","title":"5. Specifying variables via inventory","text":"<p>When we start an Ansible run, one of the very first things that we see is that Ansible wants to gather facts from a host. This is effectively a set of variables that we can consume in our playbooks to make certain actions happen on a host-by-host basis. </p> <p>A very powerful tool. We also find though that sometimes we want to pass specific variables on a host-by-host or group-by-group basis, sort of extending the function of what the inventory provides.</p>"},{"location":"chap4/3play_task/#5-1-2-5-invetoryini","title":"5-1 <code>2-5-invetory.ini</code>","text":"<pre><code>...\n\n[backup]\nk8s-jx2 backup_file=$HOME/tmp/backup_file\n\n[all:vars]\nall_file=$HOME/tmp/all_file\n\n[web:vars]\nweb_file=$HOME/tmp/web_file\n</code></pre> <ul> <li><code>[all:vars]</code></li> <li><code>[web:vars]</code></li> </ul>"},{"location":"chap4/3play_task/#5-2-task2-5-varyaml","title":"5-2 <code>task2-5-var.yaml</code>","text":"<pre><code>---\n- hosts: web\n  tasks:\n  - name: create a web file\n    file:\n      dest: '{{web_file}}'\n      state: '{{file_state}}'\n\n- hosts: backup\n  tasks:\n  - file:\n      dest: '{{backup_file}}'\n      state: '{{file_state}}'\n\n\n- hosts: db\n  tasks:\n  - file:\n      dest: '{{db_file}}'\n      state: '{{file_state}}'\n    when: db_file is defined \n\n- hosts: all\n  tasks:\n  - file:\n      dest: '{{all_file}}'\n      state: '{{file_state}}'\n</code></pre>"},{"location":"chap4/3play_task/#5-3-when","title":"5-3 when","text":"<p><code>when: db_file is defined</code></p> <ul> <li>Sometimes you will want to skip a particular step on a particular host. </li> </ul> <p>This could be something as simple as not installing a certain package if the operating system is a particular version, or it could be something like performing some cleanup steps if a filesystem is getting full.</p> <ul> <li>check db_file is defined: https://medium.com/opsops/is-defined-in-ansible-d490945611ae</li> </ul>"},{"location":"chap4/3play_task/#5-4-run-the-command","title":"**5-4 Run the command **","text":"<pre><code>$ ansible-playbook -i ../2-5-inventory.ini task2-5-var.yaml -e file_state=touch\n$ ansible-playbook -i ../2-5-inventory.ini task2-5-var.yaml -e file_state=absent\n</code></pre> <p>Becasue the <code>db_file</code> is not defined</p> <pre><code>TASK [file] *************************************************************************\nskipping: [k8s-jx1]\nskipping: [k8s-jx2]\n\n...\n\nk8s-jx1   : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nk8s-jx2   : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0  \n</code></pre>"},{"location":"chap4/4Ansible_variables/","title":"L4 Ansible Variable Management","text":""},{"location":"chap4/4Ansible_variables/#1-jinja-and-templates","title":"1. Jinja and templates","text":"<p>template \u2013 Template a file out to a remote server</p> <p>Templates are processed by the Jinja2 templating language.</p>"},{"location":"chap4/4Ansible_variables/#1-1-task2-8jinja2yaml","title":"1-1 <code>task2-8jinja2.yaml</code>","text":"<pre><code>---\n- hosts: all\n  tasks:\n  - name: deploy a simple template file\n    template:\n      src: templates/2-8-template.j2\n      dest: $HOME/tmp/2-8-template.txt\n    tags:\n      - create\n  - name: remove templated file\n    file:\n      dest: $HOME/tmp/2-8-template.txt\n      state: absent\n    tags:\n      - destroy\n</code></pre>"},{"location":"chap4/4Ansible_variables/#1-2-templates2-8-templatej2","title":"1-2 <code>templates/2-8-template.j2</code>","text":"<pre><code>This file is a template on {{hostvars[inventory_hostname]['ansible_fqdn']}}\nbackup_file {% if backup_file is defined %} is defined {% else %} is not defined {% endif %}\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini task2-8jinja2.yaml --tags create\n\nTASK [deploy a simple template file] *****************************************************\nchanged: [githost]\nchanged: [k8s-jx]\nchanged: [k8s-jx2]\nchanged: [k8s-jx1]\n\nPLAY RECAP *******************************************************************************\ngithost                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx                     : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx1                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-jx2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre> <p>jabox</p> <pre><code>This file is a template on jabox\nbackup_file  is not defined\n</code></pre> <p>jabox-node1</p> <pre><code>This file is a template on jabox-node1\nbackup_file  is not defined\n</code></pre> <p>jabox-node2</p> <pre><code>This file is a template on jabox-node2\nbackup_file  is not defined\n</code></pre> <pre><code>ansible-playbook -i ../inventory.ini task2-8jinja2.yaml --tags destroy\n</code></pre>"},{"location":"chap4/4Ansible_variables/#2-host-facts-for-conditional-execution","title":"2. Host facts for <code>conditional</code> execution","text":"<pre><code>---\n- hosts: web\n  tasks:\n  - name: create\n    file:\n      dest: $HOME/tmp/k8s-master-on-githost \n      state: '{{file_state}}'\n    when: hostvars[inventory_hostname]['inventory_hostname'] == 'githost'  \n#where the file gonna be created\n\n  - name: create\n    file:\n      dest: $HOME/tmp/githost-on-k8s-master\n      state: '{{file_state}}'\n    when: inventory_hostname == 'k8s-jx' \n#where the file gonna becreated\n</code></pre>"},{"location":"chap4/4Ansible_variables/#2-1-conditionals","title":"2-1 Conditionals","text":"<p>Sometimes you will want to skip a particular step on a particular host. </p> <p>This could be something as simple as not installing a certain package if the operating system is a particular version, or it could be something like performing some cleanup steps if a filesystem is getting full.</p> <p>This is easy to do in Ansible with the when clause, which contains a raw <code>Jinja2 expression</code> without double curly braces. It\u2019s actually pretty simple:</p> <pre><code>---\n- hosts: web\n  tasks:\n  - name: create\n    file:\n      dest: $HOME/tmp/k8s-master-on-githost \n      state: '{{file_state}}'\n    when: hostvars[inventory_hostname]['inventory_hostname'] == 'githost'  #where the file gonna be created\n\n  - name: create\n    file:\n      dest: $HOME/tmp/githost-on-k8s-master\n      state: '{{file_state}}'\n    when: inventory_hostname == 'k8s-jx' #where the file gonna becreated\n</code></pre> <ul> <li><code>when: hostvars[inventory_hostname]['inventory_hostname']</code> </li> <li><code>when: inventory_hostname == 'k8s-jx'</code></li> </ul> <pre><code>ansible -m debug -i ../inventory.ini -a \"var=hostvars['k8s-jx1']\" k8s-jx2\n</code></pre>"},{"location":"chap4/4Ansible_variables/#2-2-debug-module","title":"2-2 debug module","text":"<p>This is information that I could use on the <code>k8s-jx2</code> host, basically in <code>k8s-jx2</code> host plays, but that's coming from <code>k8s-jx1</code>. gather <code>k8s-jx2</code> fact from all ther machine</p> <pre><code>ansible-playbook -i ../inventory.ini task2-9fact.yaml -e file_state=touch\n</code></pre> <pre><code>TASK [create] ****************************************************************************************\nskipping: [k8s-jx]\nchanged: [githost]\n\nTASK [create] ****************************************************************************************\nskipping: [githost]\nchanged: [k8s-jx]\n\nPLAY RECAP *******************************************************************************************\ngithost                    : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nk8s-jx                     : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0  \n</code></pre> <ul> <li>On <code>githost</code>: <code>k8s-master-on-githost</code></li> <li>On <code>k8s-master</code>: <code>githost-on-k8s-master</code></li> </ul> <pre><code>ansible-playbook -i ../inventory.ini task2-9fact.yaml -e file_state=absent\n</code></pre>"},{"location":"chap4/4Ansible_variables/#3-looping-tasks-with-variable-lists","title":"3. Looping tasks with variable lists","text":""},{"location":"chap4/4Ansible_variables/#3-1-task2-10loopvaryaml","title":"3-1 <code>task2-10loopvar.yaml</code>","text":"<pre><code>---\n- hosts: all\n  vars:\n    packages: [git,vim,ruby]\n  tasks:\n  - name: install packages for Debian style OSs\n    apt:\n      name: '{{item}}'\n      state: '{{pkg_state}}'\n    with_items: '{{packages}}'\n    when: ansible_os_family == \"Debian\"\n    sudo: yes\n    tags:\n      - handle-pkg\n\n  - name: install pacakges for Redhat style OSs\n    yum:\n      name: '{{item}}'\n      state: '{{pkg_state}}'\n    with_items: '{{packages}}'\n    when: ansible_os_family == \"RedHat\"\n    sudo: yes\n    tags:\n      - handle-pkg\n\n  - name: create files based on package names\n    file:\n      dest:  $HOME/tmp/{{item}}\n      state: '{{file_state}}'\n    with_items: '{{packages}}'\n    when: ansible_os_family == \"RedHat\"\n    tags:\n      - handle-files\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini task2-10loopvar.yaml -e file_state=touch -e  pkg_state=latest\n$ ansible-playbook -i ../inventory.ini task2-10loopvar.yaml -e file_state=absent -e  pkg_state=absent\n\n$ ansible-playbook -i ../inventory.ini task2-10loopvar.yaml --skip-tags handle-pkg --tags handle-files -e file_state=absent\n</code></pre> <ul> <li>ansible list variable</li> </ul> <pre><code>vars:\n    packages: [git,vim,ruby]\n</code></pre> <ul> <li>Loops in ansible</li> </ul> <p><code>with_items</code> is replaced by <code>loop</code> and the <code>flatten</code> filter.</p> <p><code>loop: \"{{ items|flatten(levels=1) }}\"</code></p> <pre><code>with_items: '{{packages}}'\n</code></pre> <ul> <li><code>ansible_os_family</code></li> </ul> <p>https://riptutorial.com/ansible/example/12268/-when--condition----ansible-os-family--lists</p> <ul> <li>when: ansible_os_family == \"CentOS\"</li> <li>when: ansible_os_family == \"Redhat\"</li> <li>when: ansible_os_family == \"Darwin\"</li> <li>when: ansible_os_family == \"Debian\"</li> <li> <p>when: ansible_os_family == \"Windows\"</p> </li> <li> <p><code>sudo: yes</code></p> </li> </ul> <p>https://docs.ansible.com/ansible/latest/user_guide/become.html#understanding-privilege-escalation</p> <ul> <li><code>apt.state:</code> and <code>yum.state:</code></li> </ul> <p>yum state:  <code>absent</code>, <code>installed</code>, <code>latest</code>,  <code>present</code>, <code>removed</code></p> <p>Whether to install (<code>present</code> or <code>installed</code>, <code>latest</code>), or remove (<code>absent</code> or <code>removed</code>) a package.</p> <p><code>present</code> and <code>installed</code> will simply ensure that a desired package is installed.</p> <p><code>latest</code> will update the specified package if it's not of the latest available version.</p> <p><code>absent</code> and removed will remove the specified package.</p> <p><code>Default</code> is None, however in effect the default action is present unless the autoremove option is enabled for this module, then <code>absent</code> is inferred.</p> <pre><code># [DEPRECATION WARNING]: Invoking \"apt\" only once while using a loop via squash_actions is deprecated. Instead of using a loop to supply multiple \n# items and specifying `name: \"{{item}}\"`, please use `name: '{{packages}}'` and remove the loop. This feature will be removed in version 2.11. \n# Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n\n- name: \"Install dependencies\"\n  apt:\n    pkg:\n      - libnss3\n      - libasound2\n      - xcb\n      - xinit\n    state: present\n</code></pre>"},{"location":"chap4/4Ansible_variables/#4-looping-tasks-with-dictionaries","title":"4. Looping tasks with dictionaries","text":"<pre><code>---\n- hosts: all\n  vars:\n    animals:\n      cats:\n        tabby:\n          color: grey\n          persnickityness: high\n        calico:\n          color: orange\n          persnickityness: medium\n      dogs:\n        doberman:\n          color: black\n          persnickityness: extreme\n        retriever:\n          color: golden\n          persnickityness: low\n  tasks:\n  - name: iterate over animal array\n    file:\n      name: '$HOME/tmp/{{item.key}}-{{item.value.color}}'\n      state: '{{file_state}}'\n    with_dict: '{{animals.cats}}'\n\n  - name: iterate over animals array\n    file:\n      name: '$HOME/tmp/{{item.key}}-{{item.value.color}}'\n      state: '{{file_state}}'\n    with_dict: '{{animals.dogs}}'\n    when: 'item.value.persnickityness == \"low\"'\n</code></pre> <ul> <li>dictionary variable</li> </ul> <pre><code>vars:\n  animals:\n    cats:\n      ...\n    dogs:\n      ...\n</code></pre> <ul> <li> <p>dict key and value: <code>{{item.key}}-{{item.value.color}}'</code></p> </li> <li> <p><code>with_dict: '{{animals.cats}}</code></p> </li> <li><code>with_dict: '{{animals.dogs}}'</code></li> <li><code>when: 'item.value.persnickityness == \"low\"'</code></li> </ul> <pre><code>$ ansible-playbook -i ../inventory.ini task2-11loopdict.yaml -e file_state=touch\n$ ansible-playbook -i ../inventory.ini task2-11loopdict.yaml -e file_state=absent\n</code></pre> <p>Alphabetical order</p> <pre><code>calico-orange\nretriever-golden\ntabby-grey\n</code></pre>"},{"location":"chap4/4Ansible_variables/#5-looping-in-templates-with-variable-lists","title":"5. Looping in templates with variable lists","text":"<pre><code>---\n- hosts: all\n  vars:\n    packages: [git,vim,ruby]\n  tasks:\n  - name: deploy a template file with a loop\n    template:\n      src: templates/2-12-template.j2\n      dest: $HOME/tmp/2-12-template.txt\n    tags:\n      - create\n  - name: remove the templated file\n    file:\n      dest: $HOME/tmp/2-12-template.txt\n      state: absent\n    tags:\n      - destroy\n</code></pre>"},{"location":"chap4/4Ansible_variables/#5-1-templates2-12-templatej2","title":"5-1 <code>templates/2-12-template.j2</code>","text":"<pre><code>We are on host {{inventory_hostname}}\nWe installed: {% for package in packages %}{{package}}{% if not loop.last %}, {% endif %}{% endfor %}\n</code></pre> <pre><code>ansible-playbook -i ../inventory.ini task2-12looptemplist.yaml --tags create\nansible-playbook -i ../inventory.ini task2-12looptemplist.yaml --tags absent\n</code></pre> <pre><code>We are on host k8s-jx\nWe installed: git, vim, ruby\n\nWe are on host githost\nWe installed: git, vim, ruby\n</code></pre>"},{"location":"chap4/4Ansible_variables/#6-looping-in-templates-with-dictionaries","title":"6. Looping in templates with dictionaries","text":"<pre><code>---\n- hosts: all\n  vars:\n    animals:\n      cats:\n        tabby:\n          color: grey\n          persnickityness: high\n        calico:\n          color: orange\n          persnickityness: medium\n      dogs:\n        doberman:\n          color: black\n          persnickityness: extreme\n        retriever:\n          color: golden\n          persnickityness: low\n  tasks:\n  - name: deploy a dictionary looping template file\n    template:\n      src: templates/2-13-template.j2\n      dest: $HOME/tmp/2-13-template.txt\n    tags:\n      - create\n  - name: remove the templated file\n    file:\n      dest: $HOME/tmp/2-13-template.txt\n      state: absent\n    tags:\n      - destroy\n</code></pre> <p>6-1 <code>templates/2-13-template.j2</code></p> <pre><code>We are in groups: {% for group in hostvars[inventory_hostname]['group_names'] %}{{group}}{% if not loop.last %}, {% endif %}{% endfor %}\n\nWe like both {% for key,value in animals.items() %}{{key}}{% if not loop.last %} and {% endif %}{% endfor %}\n\nW{% for key,value in animals.items() %}e like{% for animal,name in animals[key].items() %} {{name.color}} {{animal}}s{% if not loop.last %} and{% endif %}{% endfor %}{% if not loop.last %} and w{% endif %}{% endfor %}\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini task2-13looptempdict.yaml --tags create\n$ ansible-playbook -i ../inventory.ini task2-13looptempdict.yaml --tags destroy\n\n# k8s-jx\n# We are in groups: k8s_master, k8s_servers, web\n# We like both cats and dogs\n# We like grey tabbys and orange calicos and we like black dobermans and golden retrievers\n\n# githost\n# We are in groups: githost_servers, web\n# We like both cats and dogs\n# We like grey tabbys and orange calicos and we like black dobermans and golden retrievers\n\n# k8s-jx1\n# We are in groups: db, k8s_servers\n# We like both cats and dogs\n# We like grey tabbys and orange calicos and we like black dobermans and golden retrievers\n\n# k8s-jx2\n# We are in groups: backup, db, k8s_servers\n# We like both cats and dogs\n# We like grey tabbys and orange calicos and we like black dobermans and golden retrievers\n</code></pre>"},{"location":"chap4/4Ansible_variables/#7-testing-plays-with-check-mode","title":"7. Testing plays with check mode","text":"<p>2-14 Check mode Check Mode (\u201cDry Run\u201d)</p> <p>When ansible-playbook is executed with <code>--check</code> it will not make any changes on remote systems. </p> <p>check s a way of validating that our ansible is actually valid in advance of impacting our systems.</p>"},{"location":"chap4/5Complex_roles/","title":"L5 Managing complex playbooks with roles and ansible galaxy","text":"<p>(Create <code>group:user</code> on linux machine)</p>"},{"location":"chap4/5Complex_roles/#1simple-way-to-create-groupuser","title":"1\u3001Simple way to create <code>group:user</code>","text":"<pre><code>.\n\u251c\u2500\u2500 3-1create_play.yml\n\u251c\u2500\u2500 tasks\n\u2502   \u2514\u2500\u2500 create_user.yml\n\u2514\u2500\u2500 templates\n    \u2514\u2500\u2500 bashrc.j2\n</code></pre>"},{"location":"chap4/5Complex_roles/#1-1-3-1create_playyml","title":"1-1 <code>3-1create_play.yml</code>","text":"<pre><code>---\n- hosts: all\n  vars:\n    user_name: jacob\n    user_state: present\n    # user_state: absent\n    ssh_key: ~/.ssh/id_rsa.pub\n  tasks:\n     - include_tasks: tasks/create_user.yml\n</code></pre> <ul> <li>Defining variables in a playbook</li> </ul> <pre><code>hosts: all\n  vars:\n    user_name: jacob\n    user_state: present\n    # user_state: absent\n    ssh_key: ~/.ssh/id_rsa.pub\n</code></pre> <ul> <li>Defining <code>tasks</code></li> <li><code>include_tasks</code> \u2013 Dynamically include a task list: -    <code>include_tasks: tasks/create_user.yml</code></li> </ul>"},{"location":"chap4/5Complex_roles/#1-2-taskscreate_useryml","title":"1-2 <code>tasks/create_user.yml</code>","text":"<pre><code>---\n# tasks file for user_create\n- name: Create user on remote host\n  user:\n    name: '{{user_name}}'\n    state: '{{user_state}}'\n    remove: yes\n    shell: /bin/bash\n    groups: vagrant\n    append: yes\n  become: yes\n  become_method: \"sudo\"\n\n- name: Publish local ssh public key for remote login\n  authorized_key:\n    user: '{{user_name}}'\n    state: '{{user_state}}'\n    key: \"{{ lookup('file', '{{ssh_key}}') }}\"\n  become: yes\n  become_method: \"sudo\"\n\n- name: Add bashrc to include host and user\n  template:\n    dest: '~{{user_name}}/.bashrc'\n    src: templates/bashrc.j2\n  become: yes\n  become_method: \"sudo\"  \n</code></pre>"},{"location":"chap4/5Complex_roles/#1-3-user-manage-user-accounts","title":"1-3 user \u2013 Manage user accounts","text":"<p>Manage user accounts and user attributes.</p> <ul> <li>name: Name of the user to create, remove or modify.</li> <li>state: <code>[absent / present]</code> Whether the account should exist or not, taking action if the state is different from what is stated.</li> <li>remove: <code>When state is 'absent' and user exists</code> Whether or not to remove the user account</li> <li>shell: <code>When state is 'absent' and user exists</code>Whether or not to remove the user account</li> <li>groups:   Optionally sets the user's primary group (takes a group name).</li> <li>append: <code>When state is 'present' and the user exists</code> Whether or not to append the user to groups</li> </ul> <p>Check Linux existing user and group</p> <pre><code>$ groups\nvagrant\n\n$ awk -F: '{ print $1}' /etc/passwd\nusers...\n</code></pre> <p>Errors:</p> <pre><code>fatal: [githost]: FAILED! =&gt; {\"changed\": false, \"cmd\": \"/sbin/useradd -G vagrant -s /bin/bash -m jacob\", \"msg\": \"[Errno 13] Permission denied\", \"rc\": 13}\n\nbecome: yes\nbecome_method: \"sudo\"\n</code></pre>"},{"location":"chap4/5Complex_roles/#1-4-authorized_key-adds-or-removes-an-ssh-authorized-key","title":"1-4 <code>authorized_key</code> \u2013 Adds or removes an SSH authorized key","text":"<pre><code>authorized_key:\n    user: '{{user_name}}'\n    state: '{{user_state}}'\n    key: \"{{ lookup('file', '{{ssh_key}}') }}\"\n</code></pre> <ul> <li>key: The SSH public key(s), as a string or (since Ansible 1.9) url </li> <li><code>lookup</code>: <code>{{ lookup('file', '{{ssh_key}}') }}</code></li> </ul>"},{"location":"chap4/5Complex_roles/#1-5-jinja-template","title":"1-5 Jinja template","text":"<pre><code>template:\n    dest: '~{{user_name}}/.bashrc'\n    src: templates/bashrc.j2\n</code></pre> <p>Run the play book</p> <pre><code>ansible-playbook -i ../inventory.ini 3-1create_play.yml\n</code></pre>"},{"location":"chap4/5Complex_roles/#2comprehenisve-role-to-create-groupuser-with-ansible-galxy","title":"2\u3001Comprehenisve role to create <code>group:user</code> with <code>ansible galxy</code>","text":"<pre><code>ansible-galaxy init create_user\n</code></pre> <p>galaxy is a directory of roles. </p> <p>So when people find something really useful like let's deploy Apache or Engine X web servers, we can create a role for that and store it in galaxy and then share amongst not only our local peers but potentially the internet at large.</p> <pre><code>cp tasks/create_user.yml create_user/tasks/main.yml\ncp templates/bashrc.j2 create_user/templates/\n</code></pre> <pre><code>$ tree create_user/\ncreate_user/\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 defaults\n\u2502   \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 files\n\u251c\u2500\u2500 handlers\n\u2502   \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 meta\n\u2502   \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 tasks\n\u2502   \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 templates\n\u2502   \u2514\u2500\u2500 bashrc.j2\n\u251c\u2500\u2500 tests\n\u2502   \u251c\u2500\u2500 inventory\n\u2502   \u2514\u2500\u2500 test.yml\n\u2514\u2500\u2500 vars\n    \u2514\u2500\u2500 main.yml\n\n8 directories, 9 files\n</code></pre>"},{"location":"chap4/5Complex_roles/#2-1-3-1create_roleyml","title":"2-1 <code>3-1create_role.yml</code>","text":"<pre><code>---\n- hosts: all\n  tasks:\n    - include_role:\n          name: create_user\n      vars:\n        user_name: jacob\n        # user_state: present\n        user_state: absent\n        ssh_key: ~/.ssh/id_rsa.pub\n</code></pre>"},{"location":"chap4/5Complex_roles/#2-2-tasksmainyml","title":"2-2 <code>tasks/main.yml</code>","text":"<pre><code>---\n# tasks file for user_create\n- name: Create user on remote host\n  user:\n    name: '{{user_name}}'\n    state: '{{user_state}}'\n    remove: yes\n    shell: /bin/bash\n    groups: vagrant\n    append: yes\n  become: yes\n  become_method: \"sudo\"\n\n- name: Publish local ssh public key for remote login\n  authorized_key:\n    user: '{{user_name}}'\n    state: '{{user_state}}'\n    key: \"{{ lookup('file', '{{ssh_key}}') }}\"\n  become: yes\n  become_method: \"sudo\"\n\n- name: Add bashrc to include host and user\n  template:\n    dest: '~{{user_name}}/.bashrc'\n    src: templates/bashrc.j2\n  become: yes\n  become_method: \"sudo\"  \n</code></pre>"},{"location":"chap4/5Complex_roles/#2-3-templatesbashrcj2","title":"2-3 <code>templates/bashrc.j2</code>","text":"<pre><code>export PS1='{{inventory_hoastname}}:{{user_name}} $'\n</code></pre> <pre><code>ansible-playbook -i ../inventory.ini 3-2create_role.yml\n</code></pre>"},{"location":"chap4/5Complex_roles/#3variables-in-roles-and-variable-precedence","title":"3\u3001Variables in roles and variable precedence","text":""},{"location":"chap4/5Complex_roles/#3-1-3-1create_roleyml-delete-user_state-from-tasks","title":"3-1 <code>3-1create_role.yml</code> Delete <code>user_state</code> from tasks","text":"<pre><code>---\n- hosts: all\n  tasks:\n    - include_role:\n          name: create_user\n      vars:\n        user_name: jacob\n        # user_state: present\n        # user_state: absent\n        ssh_key: ~/.ssh/id_rsa.pub\n</code></pre>"},{"location":"chap4/5Complex_roles/#3-2-add-this-is-variable-in-defaultmainyml","title":"3-2 Add this is variable in <code>default/main.yml</code>","text":"<pre><code>---\n# defaults file for create_user\n user_state: present\n</code></pre> <pre><code>ansible-playbook -i ../inventory.ini 3-2create_role.yml\n</code></pre>"},{"location":"chap4/5Complex_roles/#3-3-add-this-is-variable-can-be-also-passed-in-defaultmainyml","title":"3-3 Add this is variable can be also passed in <code>default/main.yml</code>","text":"<pre><code>ansible-playbook -i ../inventory.ini 3-2create_role.yml -e user_state= absent\n</code></pre> <p><code>-e user_state= absent</code></p>"},{"location":"chap4/5Complex_roles/#4role-based-templates","title":"4\u3001Role-based templates","text":"<p>Add more variables <code>default/main.yml</code></p> <pre><code>---\n# defaults file for create_user\nuser_state: present\nuser_name: default\n</code></pre>"},{"location":"chap4/5Complex_roles/#4-1-dont-forget-document-newly-added-variables-readememd","title":"4-1 Dont forget document newly added variables\uff1a <code>READEME.md</code>","text":"<pre><code>Role Variables\n--------------\n\n# Define the user you would like to create\nuser_name: default\n\n# Define the user state present or absent\nuser_state: present\n</code></pre>"},{"location":"chap4/5Complex_roles/#5documenting-your-role-for-reuse","title":"5\u3001Documenting your role for reuse","text":""},{"location":"chap4/5Complex_roles/#5-1-readememd","title":"5-1 <code>READEME.md</code>","text":"<pre><code>Role Variables\n--------------\n\n# Define the user you would like to create\nuser_name: default\n\n# Define the user state present or absent\nuser_state: present\n\n# Define the path to the ssh public key\nssh_key: ~/.ssh/id_rsa.pub\n\n\nDependencies\n------------\n\nNone\n\nExample Playbook\n----------------\n\n---\n- hosts: all\n  tasks:\n    - include_role:\n          name: create_user\n      vars:\n        user_name: jacob\n        ssh_key: ~/.ssh/id_rsa.pub\n\nLicense\n-------\n\nMIT\n\nAuthor Information\n------------------\n\n...\n</code></pre>"},{"location":"chap4/5Complex_roles/#5-2-metamainyml","title":"5-2 <code>meta/main.yml</code>","text":"<pre><code>galaxy_info:\n  author: jaocb\n  description: Create user with ssh authentication\n  company: your company (optional)\n\n license: MIT \n\n min_ansible_version: 2.4\n\n galaxy_tags: [user,admin]\n\n</code></pre>"},{"location":"chap4/5Complex_roles/#6pushing-a-role-to-galaxy","title":"6\u3001Pushing a role to Galaxy","text":"<ul> <li>Step one push projects into github</li> <li><code>ansible-galaxy login</code> with github token(username and password)</li> <li><code>ansible-galaxy import chao-xi(repo_owner) create_user(project_name)</code></li> </ul>"},{"location":"chap4/5Complex_roles/#7finding-roles-via-ansible-galaxy","title":"7\u3001Finding roles via Ansible Galaxy","text":""},{"location":"chap4/5Complex_roles/#7-1-search","title":"7-1 Search","text":"<pre><code>ansible-galaxy search create_user\n\nFound 1816 roles matching your search. Showing first 1000.\n\n Name                                                      Description\n ----                                                      -----------\n 0utsider.ansible_zabbix_agent                             Installing and maintaining zabbix-agent for RedHat/Debian/Ub\n 0x5a17ed.ansible_role_netbox                              Installs and configures NetBox, a DCIM suite, in a productio\n 1davidmichael.ansible-role-nginx                          Nginx installation for Linux, FreeBSD and OpenBSD.\n 1it.users                                                 Ansible role \n ...\n</code></pre>"},{"location":"chap4/5Complex_roles/#7-2-download","title":"7-2 download","text":"<pre><code>$ ansible-galaxy search create_user | grep docker\n alexinthesky.docker                                       Install Docker and Docker Compose.\n\n\n$ ansible-galaxy install alexinthesky.docker -p ./\n- downloading role 'docker', owned by alexinthesky\n- downloading role from https://github.com/alexinthesky/ansible-docker/archive/v0.1.6.tar.gz\n- extracting alexinthesky.docker to /Users/i515190/Devops_sap/ansible/code/task3/alexinthesky.docker\n- alexinthesky.docker (v0.1.6) was installed successfully\n</code></pre> <pre><code>$  tree alexinthesky.docker\nalexinthesky.docker\n\u251c\u2500\u2500 CHANGES.md\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 defaults\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 handlers\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 meta\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 tasks\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n\u251c\u2500\u2500 templates\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 etc\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 systemd\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 system\n\u2502\u00a0\u00a0             \u2514\u2500\u2500 docker.service.j2\n\u2514\u2500\u2500 tests\n    \u251c\u2500\u2500 inventory\n    \u2514\u2500\u2500 main.yml\n\n9 directories, 10 files\n</code></pre> <p>Centralizing roles with <code>roles_path</code></p> <pre><code>$ vi /etc/ansible/ansible.cfg\n\n[defaults]\nrole_path=/etc/ansible/roles\n</code></pre>"},{"location":"chap4/6Secret_management/","title":"L6 Working with Secrets","text":"<ul> <li>Creating a secrets vault</li> <li>Using secrets in plays</li> </ul>"},{"location":"chap4/6Secret_management/#1creating-a-secrets-vault","title":"1\u3001Creating a secrets vault","text":"<pre><code>$ tree .\n.\n\u251c\u2500\u2500 group_vars\n\u2502   \u2514\u2500\u2500 all\n\u2502       \u251c\u2500\u2500 vars\n\u2502       \u2514\u2500\u2500 vault\n\u251c\u2500\u2500 templates\n\u2502   \u2514\u2500\u2500 password.j2\n\u2514\u2500\u2500 vault.yml\n\n3 directories, 4 files\n</code></pre> <ul> <li><code>vars</code></li> </ul> <pre><code>password: '{{vault_password}}'\n</code></pre> <ul> <li><code>vault</code></li> </ul> <pre><code>vault_password: thisIsnotAgoodPassword\n</code></pre> <pre><code>$ ansible-vault -h\n\nencryption/decryption utility for Ansible data files\nOptions:\n  --ask-vault-pass      ask for vault password\n  -h, --help            show this help message and exit\n  --new-vault-id=NEW_VAULT_ID\n                        the new vault identity to use for rekey\n  --new-vault-password-file=NEW_VAULT_PASSWORD_FILE\n                        new vault password file for rekey\n  --vault-id=VAULT_IDS  the vault identity to use\n  --vault-password-file=VAULT_PASSWORD_FILES\n                        vault password file\n  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable\n                        connection debugging)\n  --version             show program's version number, config file location,\n                        configured module search path, module location,\n                        executable location and exit\n\n See 'ansible-vault &lt;command&gt; --help' for more information on a specific\ncommand.\n</code></pre>"},{"location":"chap4/6Secret_management/#1-1-encrypt-password","title":"1-1 Encrypt password","text":"<pre><code>ansible-vault encrypt vault\nNew Vault password: (12345)\nConfirm New Vault password: (12345)\nEncryption successful\n</code></pre> <pre><code>$ more vault\n$ANSIBLE_VAULT;1.1;AES256\n39366238636135663636323265363238613163363138633964643965613330373562623261306366\n6139623430343038383734353730323035656231663562310a613866383935376434313637613236\n37666265333162666561643964323630363234336364383232623034336435396330346137643936\n3437373636356532330a666437393866346661353239326562363431666564616134646535613738\n65653434373736376335663237663131386561663934353866386635363030346436383435333839\n3430656637363034386337366562333638636537333261373463\n</code></pre>"},{"location":"chap4/6Secret_management/#1-2-edit-vault","title":"1-2 Edit vault","text":"<pre><code>$ ansible-vault edit vault\nVault password: (12345)\nvault_password: NewthisIsnotAgoodPassword\n</code></pre> <pre><code>$ more vault \n$ANSIBLE_VAULT;1.1;AES256\n39383639343364616130396164643665353564396535373739373337353764333132356364373065\n6563303034393431373863353136323564356137633462620a373832623862633036613339303539\n32616163663763653463313463613566306238346438373439656463306430666635303637623061\n6561343732353835330a393633346532623666643039663162633763653335393261623966356262\n66383032643566613437346362353436306461393434366262366336303961663062616238383330\n3534346664303139346630343665656237306564373062383034\n</code></pre> <p>It's changed</p>"},{"location":"chap4/6Secret_management/#2using-secrets-in-plays","title":"2\u3001Using secrets in plays","text":"<p><code>vault.yml</code></p> <pre><code>---\n- hosts: all\n  tasks:\n  - name: embed the secure password in a file\n    template:\n      src: templates/password.j2\n      dest: $HOME/tmp/password\n      mode: 0600\n    tags:\n      - create\n  - name: clean up the secure passwords file\n    file:\n      name: $HOME/tmp/password\n      state: absent\n    tags:\n      - destroy\n  - name: debug the password that was encrypted\n    debug:\n      msg: 'the password is {{password}}'\n    tags:\n      - create\n      - destroy\n</code></pre> <p><code>password.j2</code></p> <pre><code>The password is {{password}}\n</code></pre>"},{"location":"chap4/6Secret_management/#2-1-no-password-offered-will-report-error","title":"2-1 No password offered will report error","text":"<pre><code>$ ansible-playbook -i ../inventory.ini vault.yml --tags create\n\nPLAY [all] *********************************************************************************\nERROR! Attempting to decrypt but no vault secrets found\n</code></pre>"},{"location":"chap4/6Secret_management/#2-2-ask-vault-pass-import-encrypt-password","title":"2-2 <code>--ask-vault-pass</code>: import encrypt password","text":"<pre><code>$ ansible-playbook -i ../inventory.ini vault.yml --tags create --ask-vault-pass\nVault password: (12345)\n...\nTASK [debug the password that was encrypted] ***********************************************\nok: [githost] =&gt; {\n    \"msg\": \"the password is NewthisIsnotAgoodPassword\"\n}\nok: [k8s-jx] =&gt; {\n    \"msg\": \"the password is NewthisIsnotAgoodPassword\"\n}\nok: [k8s-jx1] =&gt; {\n    \"msg\": \"the password is NewthisIsnotAgoodPassword\"\n}\nok: [k8s-jx2] =&gt; {\n    \"msg\": \"the password is NewthisIsnotAgoodPassword\"\n}\n...\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini vault.yml --tags destroy --ask-vault-pass\nVault password: (12345)\n</code></pre>"},{"location":"chap4/7Network_management/","title":"L7 Network Management with Ansible","text":""},{"location":"chap4/7Network_management/#1netaddr","title":"1\u3001netaddr","text":"<pre><code>---\n- hosts: localhost\n  connection: local\n  vars:\n    net1: 10.0.0.0/24\n    net2gw: 10.10.0.1\n    net2nm: 255.255.0.0\n  tasks:\n  - set_fact: net2=\"{{net2gw}}/{{net2nm}}\"\n  - set_fact: net2gw={{net2|ipaddr('host/prefix')}}\n  - debug:\n      msg: \"net2 is {{net2}}, gateway is {{net2gw}}\"\n</code></pre> <ul> <li><code>set_fact</code> \u2013 Set host facts from a task</li> </ul> <pre><code>$ ansible-playbook -i ../inventory.ini 5-1netaddr.yaml --check\n</code></pre> <pre><code>fatal: [localhost]: FAILED! =&gt; {\"msg\": \"The ipaddr filter requires python's netaddr be installed on the ansible controller\"}\n</code></pre> <p>Fix problem:</p> <pre><code>$ pip3 install netaddr\n</code></pre> <pre><code>ok: [localhost] =&gt; {\n    \"msg\": \"net2 is 10.10.0.1/255.255.0.0, gateway is 10.10.0.1/16\"\n}\n</code></pre>"},{"location":"chap4/7Network_management/#1-1-ipaddr-filter","title":"1-1 ipaddr filter","text":"<p><code>ipaddr()</code> is a Jinja2 filter designed to provide an interface to the <code>netaddr</code> Python package from within Ansible. </p> <p>It can operate on strings or lists of items, test various data to check if they are valid IP addresses, and manipulate the input data to extract requested information. <code>ipaddr()</code> works with both IPv4 and IPv6 addresses in various forms. There are also additional functions available to manipulate IP subnets and MAC addresses.</p>"},{"location":"chap4/7Network_management/#2netaddr_incremenet","title":"2\u3001<code>netaddr_incremenet</code>","text":"<pre><code>---\n- hosts: localhost\n  connection: local\n  vars:\n    netgw: 10.10.0.1\n    netnm: 255.255.255.224\n  tasks:\n  - set_fact: net2=\"{{netgw}}/{{netnm}}\"\n  - set_fact: net2gw=\"{{net2|ipaddr('host/prefix')}}\"\n  - debug:\n      msg: \"net2 is {{net2}}, gateway is {{net2gw}}\"\n  - set_fact: net2int=\"{{netgw|ipaddr('int') + 1}}\"\n  - set_fact: net2=\"{{net2int|ipv4('address')}}/{{net2gw|ipaddr('prefix')}}\"\n  - debug:\n      msg: \"net2 is now {{net2}}\"\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini 5-2increment.yaml --check\n</code></pre> <pre><code>...\nTASK [debug] ****************************************************************************************\nok: [localhost] =&gt; {\n    \"msg\": \"net2 is 10.10.0.1/255.255.255.224, gateway is 10.10.0.1/27\"\n}\n...\nTASK [debug] ****************************************************************************************\nok: [localhost] =&gt; {\n    \"msg\": \"net2 is now 10.10.0.2/27\"\n}\n</code></pre>"},{"location":"chap4/7Network_management/#3network-interface-config-for-hosts","title":"3\u3001Network interface config for hosts","text":""},{"location":"chap4/7Network_management/#3-1-hostintyaml","title":"3-1 <code>hostint.yaml</code>","text":"<pre><code>---\n- hosts: web\n  vars:\n    network: 10.13.36.96/27\n    host: 6\n  tasks:\n  - set_fact: hostint=\"{{network|ipaddr('network')|ipaddr('int')}}\"\n  - set_fact: addrint=\"{{host+hostint|int()}}\"\n  - set_fact: address=\"{{addrint|ipv4('address')}}\"\n  - set_fact: netmask=\"{{network|ipaddr('netmask')}}\"\n  - set_fact: gatewayint={{hostint|int()+1}}\n  - set_fact: gateway=\"{{gatewayint|ipv4('address')}}\"\n  - name: ensure network file is set to use interfaces.d\n    lineinfile:\n      dest: /etc/network/interfaces\n      regexp: \"^source /etc/network/interfaces.*$\"\n      line: \"source /etc/network/interfaces.d/*.cfg\"\n      insertafter: EOF\n    tags:\n      - create\n  - name: upload network template for internal bridge\n    template:\n      src: templates/br10.j2\n      dest: /etc/network/interfaces.d/br10.cfg\n    tags:\n      - create\n  - name: install bridge utils\n    apt:\n      name: bridge-utils\n      state: installed\n    tags:\n      - create\n</code></pre>"},{"location":"chap4/7Network_management/#3-2-tempaltesbr10j2","title":"3-2 <code>tempaltes/br10.j2</code>","text":"<pre><code>auto br10\niface br10 inet static\n   address {{address}}\n   netmask {{netmask}}\n   gateway {{gateway}}\n   bridge_ports none\n   bridge_stp off\n   bridge_fd 0\n   bridge_maxwait 0\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini 5-3hostint.yaml --check\n</code></pre>"},{"location":"chap4/7Network_management/#network-device-interface-config","title":"Network device interface config","text":"<p>vyos_config \u2013 Manage VyOS configuration on remote device</p> <p>VyOS is a fully open source network OS that runs on a wide range of hardware, virtual machines, and cloud providers and offers features for any networks, small and large.</p> <pre><code>---\n- hosts: all\n  connection: local\n  become: true\n  vars:\n    tenone: 10.10.1.0/24\n  tasks:\n  - set_fact: vonenetint=\"{{tenone|ipaddr('network')}}\"\n  - set_fact: vonenm=\"{{tenone|ipaddr('prefix')}}\"\n  - set_fact: tenoneaddrint=\"{{vonenetint|ipaddr('int')+id}}\"\n  - set_fact: tenoneaddr=\"{{tenoneaddrint|ipv4('address')}}/{{vonenm}}\"\n  - debug: var=tenoneaddr\n  - vyos_config:\n     provider:\n       username: vyos\n       password: vyos\n       host: '{{hostvars[inventory_hostname].host}}'\n     lines:\n       - set interface ethernet eth1 address {{tenoneaddr}}\n</code></pre> <p><code>invetory-vyos.ini</code></p> <pre><code>[vyos]\nv1 host=192.168.122.19 id=2\nv2 host=192.168.122.120 id=3\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory-vyos.ini 5-4vyos_ip.yml\n</code></pre> <p></p>"},{"location":"chap4/8idempotentence/","title":"L8 Idempotentence with Ansible play","text":"<pre><code>$ tree .\n.\n\u251c\u2500\u2500 create.yml\n\u251c\u2500\u2500 files\n\u2502   \u2514\u2500\u2500 idempotent.txt\n\u251c\u2500\u2500 idempotent.yml\n\u2514\u2500\u2500 state.yml\n\n1 directory, 4 files\n</code></pre>"},{"location":"chap4/8idempotentence/#1idempotent-prototype-model","title":"1\u3001Idempotent \"prototype\" model","text":"<pre><code>---\n- hosts: k8s_master\n  tasks:\n  - name: an idempotent create command\n    copy:\n      src: files/idempotent.txt\n      dest: $HOME/tmp/idempotent.txt\n    tags:\n      - create\n  - name: an idempotent command\n    lineinfile:\n      dest: $HOME/tmp/idempotent.txt\n      regexp: '^(.*)is an(.*)$'\n      backrefs: true\n      line: '\\1is really an\\2'\n    tags:\n      - create\n  - name: a non idempotent command\n    shell: \"echo this is a non-idempotent file &gt;&gt; $HOME/tmp/non-idempotent.txt\"\n    tags:\n      - create\n\n  - name: remove the file we created\n    file:\n      path: $HOME/tmp/{{ item }}\n      state: absent\n    with_items:\n    - non-idempotent.txt\n    - idempotent.txt\n    tags:\n      - destroy\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini idempotent.yml --tags create\n</code></pre> <p><code>lineinfile</code> \u2013 Manage lines in text files</p> <ul> <li>This module ensures a particular line is in a file, or replace an existing line using a back-referenced regular expression.</li> <li>This is primarily useful when you want to change a single line in a file only.</li> <li><code>regexp</code>: The regular expression to look for in every line of the file.</li> <li><code>backrefs: true</code>: If set, <code>line</code> can contain backreferences (both positional and named) that will get populated if the <code>regexp</code> matches.</li> <li><code>line</code>: The line to insert/replace into the file.</li> </ul> <p>After run twice and check non-idempotent file</p> <pre><code>$ cat non-idempotent.txt\nthis is a non-idempotent file\nthis is a non-idempotent file\n</code></pre> <p>After run twice and check idempotent file</p> <pre><code>$ cat idempotent.txt\nthis is really an idempotent file\n</code></pre>"},{"location":"chap4/8idempotentence/#remove-multiple-files-inside-directory","title":"Remove multiple files inside directory","text":"<pre><code>- name: remove the file we created\n    file:\n      path: $HOME/tmp/{{ item }}\n      state: absent\n    with_items:\n    - non-idempotent.txt\n    - idempotent.txt\n    tags:\n      - destroy\n</code></pre> <pre><code>$ ansible-playbook -i ../inventory.ini idempotent.yml --tags destroy\nTASK [remove the file we created] **********************************************************************\nchanged: [k8s-jx] =&gt; (item=non-idempotent.txt)\nchanged: [k8s-jx] =&gt; (item=idempotent.txt)\n</code></pre>"},{"location":"chap4/8idempotentence/#2registering-discovered-state","title":"2\u3001Registering discovered state","text":"<pre><code>- hosts: k8s_master\n  vars:\n    target: $HOME/tmp/idempotent.txt\n  tasks:\n  - name: an idempotent create command\n    copy:\n      src: files/idempotent.txt\n      dest: '{{target}}'\n    tags:\n      - create\n\n  - name: modify the file\n    command: sed -ie 's/is an/is really an/' {{target}}\n    tags:\n      - create\n\n  - name: remove the file\n    file:\n       path: '{{target}}'\n       state: absent\n    tags:\n      - destroy\n\n  - name: remove the backup file\n    file:\n       path: $HOME/tmp/idempotent.txte\n       state: absent\n    tags:\n      - destroy\n\n  - name: discover state\n    command: grep 'is really an' {{target}}\n    register: grep_state\n    tags:\n      - create\n      - destroy\n    ignore_errors: true\n\n  - name: show the state of the file\n    debug:\n      var: grep_state.rc\n    tags:\n      - create\n      - destroy\n</code></pre>"},{"location":"chap4/8idempotentence/#2-1-sed-ie","title":"2-1 <code>sed -ie</code>","text":"<ul> <li><code>-i[SUFFIX]</code>(-ie) </li> </ul> <p>Edit files in place (this makes a backup with file extension SUFFIX, if SUFFIX is supplied).</p> <p>After run <code>modify the file</code>, generate a new backup file <code>idempotent.txt</code></p>"},{"location":"chap4/8idempotentence/#2-2-register-and-debug","title":"2-2 register and debug","text":"<pre><code>register: grep_state\n</code></pre> <pre><code>debug:\n    var: grep_state.rc\n</code></pre> <p>When you execute a task and save the return value in a variable for use in later tasks, you create a registered variable.</p>"},{"location":"chap4/8idempotentence/#2-3-ignoring-failed-commands","title":"2-3 Ignoring Failed Commands","text":"<p>Generally playbooks will stop executing any more steps on a host that has a task fail. Sometimes, though, you want to continue on. To do so, write a task that looks like this:</p> <pre><code>ignore_errors: true\n</code></pre>"},{"location":"chap4/8idempotentence/#2-4-grep_state-return-true-after-create","title":"2-4 <code>grep_state</code> return true after create","text":"<pre><code>ansible-playbook -i ../inventory.ini state.yml --tags create\n\nTASK [show the state of the file] ********************************************************************\nok: [k8s-jx] =&gt; {\n    \"grep_state.rc\": \"0\"\n}\n</code></pre>"},{"location":"chap4/8idempotentence/#2-5-grep_state-return-false-after-destroy","title":"2-5 <code>grep_state</code> return false after destroy","text":"<pre><code>$ ansible-playbook -i ../inventory.ini state.yml --tags destroy\n\nTASK [show the state of the file] ********************************************************************\nok: [k8s-jx] =&gt; {\n    \"grep_state.rc\": \"2\"\n}\n</code></pre>"},{"location":"chap4/8idempotentence/#3creating-an-idempotent-play","title":"3\u3001Creating an idempotent play","text":"<pre><code>---\n- hosts: k8s_master\n  vars:\n    target: $HOME/tmp/idempotent.txt\n  tasks:\n  - name: discover state\n    command: grep 'is really an' {{target}}\n    register: grep_state\n    tags:\n      - create\n      - destroy\n    ignore_errors: true\n\n  - name: show the state of the file\n    debug:\n      var: grep_state.rc\n\n  - name: an idempotent create command\n    copy:\n      src: files/idempotent.txt\n      dest: '{{target}}'\n    when: grep_state.rc != 0\n    tags:\n      - create\n      - destroy\n\n  - name: modify the file\n    command: sed -ie 's/is/is really an/' {{target}}\n    when: grep_state.rc != 0\n    tags:\n      - create\n      - destroy\n\n  - name: remove the file\n    file:\n      path: '{{target}}'\n      state: absent\n    tags:\n      - destroy\n\n  - name: remove the backup file\n    file:\n       path: $HOME/tmp/idempotent.txte\n       state: absent\n    tags:\n      - destroy\n</code></pre> <ol> <li>Check the state of file</li> <li>Show the state of the file</li> <li>Create and modify file when <code>grep_state</code> is fasle</li> <li>delete both</li> </ol> <p>So after first run, the task <code>an idempotent create command</code> and <code>modify the file</code> will skip</p>"},{"location":"chap4/9Ansible_interview/","title":"L9 Ansible Interview","text":"<p>Ansible\u662f\u4e00\u6b3e\u6781\u5176\u7b80\u5355\u7684\u5f00\u6e90\u7684\u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177\uff0c\u57fa\u4e8ePython\u5f00\u53d1\uff0c\u96c6\u5408\u4e86\u4f17\u591a\u8fd0\u7ef4\u5de5\u5177(puppet, cfengine, chef, func, fabric)\u7684\u4f18\u70b9\u3002\u5b9e\u73b0\u4e86\u6279\u91cf\u7cfb\u7edf\u914d\u7f6e\uff0c\u6279\u91cf\u7a0b\u5e8f\u90e8\u7f72\uff0c\u6279\u91cf\u8fd0\u884c\u547d\u4ee4\u7b49\u529f\u80fd\u3002</p> <p>\u540c\u65f6Ansible\u662f\u57fa\u4e8e\u6a21\u5757\u5de5\u4f5c\uff0c\u5176\u5b9e\u73b0\u6279\u91cf\u90e8\u7f72\u7684\u662fansible\u6240\u8fd0\u884c\u7684\u6a21\u5757\u3002</p>"},{"location":"chap4/9Ansible_interview/#1ansible","title":"1\u3001Ansible\u5176\u4ed6\u91cd\u8981\u7684\u4f18\u52bf\uff1a","text":"<ul> <li>\u8de8\u5e73\u53f0\u652f\u6301\uff1aAnsible\u5728\u7269\u7406\u3001\u865a\u62df\u3001\u4e91\u548c\u5bb9\u5668\u73af\u5883\u4e2d\u4e3aLinux\u3001Windows\u3001UNIX\u548c\u7f51\u7edc\u8bbe\u5907\u63d0\u4f9b\u65e0\u4ee3\u7406\u652f\u6301\u3002</li> <li>\u4eba\u7c7b\u53ef\u8bfb\u7684\u81ea\u52a8\u5316\uff1aAnsible playbook\u4ee5YAML\u6587\u672c\u6587\u4ef6\u7684\u5f62\u5f0f\u7f16\u5199\uff0c\u6613\u4e8e\u9605\u8bfb\uff0c\u6709\u52a9\u4e8e\u786e\u4fdd\u6bcf\u4e2a\u4eba\u90fd\u7406\u89e3\u4ed6\u4eec\u5c06\u8981\u505a\u7684\u4e8b\u60c5\u3002</li> <li>\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7684\u5b8c\u7f8e\u63cf\u8ff0\uff1aAnsible playbook\u53ef\u4ee5\u8fdb\u884c\u4efb\u4f55\u66f4\u6539\uff0c\u5e76\u4e14\u53ef\u4ee5\u63cf\u8ff0\u548c\u8bb0\u5f55\u5e94\u7528\u7a0b\u5e8f\u73af\u5883\u7684\u6bcf\u4e2a\u7ec6\u8282\u3002</li> <li>\u6613\u4e8e\u7ba1\u7406\u7684\u7248\u672c\u63a7\u5236\uff1aAnsible\u5267\u672c\u548c\u9879\u76ee\u662f\u7eaf\u6587\u672c\u3002\u5b83\u4eec\u53ef\u4ee5\u50cf\u6e90\u4ee3\u7801\u4e00\u6837\u5904\u7406\uff0c\u5e76\u653e\u5728\u73b0\u6709\u7684\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u4e2d\u3002</li> <li>\u652f\u6301\u52a8\u6001\u5e93\u5b58\uff1aAnsible\u7ba1\u7406\u7684\u673a\u5668\u5217\u8868\u53ef\u4ee5\u4ece\u5916\u90e8\u8d44\u6e90\u52a8\u6001\u66f4\u65b0\uff0c\u4ee5\u4fbf\u968f\u65f6\u6355\u83b7\u6240\u6709\u53d7\u7ba1\u670d\u52a1\u5668\u7684\u6b63\u786e\u7684\u5f53\u524d\u5217\u8868\uff0c\u65e0\u8bba\u57fa\u7840\u8bbe\u65bd\u6216\u4f4d\u7f6e\u5982\u4f55\u3002</li> <li>\u6613\u4e8e\u4e0e\u5176\u4ed6\u7cfb\u7edf\u96c6\u6210\u7684\u7f16\u6392\uff1aHP SA\u3001Puppet\u3001Jenkins\u3001Red Hat Satellite\uff0c\u4ee5\u53ca\u5b58\u5728\u4e8e\u73af\u5883\u4e2d\u7684\u5176\u4ed6\u7cfb\u7edf\uff0c\u90fd\u53ef\u4ee5\u88ab\u5229\u7528\u5e76\u96c6\u6210\u5230Ansible\u5de5\u4f5c\u6d41\u4e2d\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#2ansible","title":"2\u3001\u7b80\u8ff0Ansible\u5de5\u4f5c\u673a\u5236\u53ca\u5176\u7279\u6027\uff1f","text":"<p>Ansible\u662f\u4e00\u6b3e\u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177\uff0c\u57fa\u4e8ePython\u5f00\u53d1\uff0c\u5177\u6709\u6279\u91cf\u7cfb\u7edf\u914d\u7f6e, \u6279\u91cf\u7a0b\u5e8f\u90e8\u7f72, \u6279\u91cf\u8fd0\u884c\u547d\u4ee4\u7b49\u529f\u80fd\u3002</p> <p>\u5176\u5de5\u4f5c\u673a\u5236\u5982\u4e0b\uff1a</p> <ul> <li>\u7528\u6237\u4f7f\u7528Ansible\u6216Playbook\uff0c\u5728\u670d\u52a1\u5668\u4e2d\u65ad\u8f93\u5165Ansible\u7684Ad-Hoc\u547d\u4ee4\u96c6\u6216Playbook\uff1b</li> <li>Ansible\u9075\u5faa\u9884\u5148\u7f16\u6392\u7684\u89c4\u5219\u5c06Playbooks\u9010\u6761\u62c6\u89e3\u4e3aPlay\uff1b</li> <li>Play\u7ec4\u7ec7\u6210Ansible\u53ef\u8bc6\u522b\u7684\u4efb\u52a1\uff08Task\uff09\uff1b</li> <li>Task\u4f1a\u8c03\u7528\u4efb\u52a1\u6240\u6d89\u53ca\u7684\u6240\u6709\u6a21\u5757\uff08Module\uff09\u548c\u63d2\u4ef6\uff08Plugin\uff09\uff1b</li> <li>\u8bfb\u53d6Inventroy\u4e2d\u5b9a\u4e49\u7684\u4e3b\u673a\u5217\u8868\uff1b</li> <li>\u901a\u8fc7SSH\u8ba4\u8bc1\uff08\u9ed8\u8ba4\uff09\u5c06\u4efb\u52a1\u96c6\u4ee5\u4e34\u65f6\u6587\u4ef6\u6216\u547d\u4ee4\u7684\u5f62\u5f0f\u4f20\u8f93\u5230\u8fdc\u7a0b\u5ba2\u6237\u7aef\u6267\u884c\u5e76\u8fd4\u56de\u6267\u884c\u7ed3\u679c\u3002</li> </ul> <p>\u5176\u7279\u6027\u5982\u4e0b\uff1a</p> <ul> <li>no agents\uff1a\u4e0d\u9700\u8981\u5728\u88ab\u7ba1\u63a7\u4e3b\u673a\u4e0a\u5b89\u88c5\u4efb\u4f55\u5ba2\u6237\u7aef\uff0c\u53ea\u9700SSH\u3001Python\u5373\u53ef\uff0c\u5efa\u8baePython\u7248\u672c\u4e3a2.6.6\u4ee5\u4e0a\uff1b</li> <li>no server\uff1a\u65e0\u670d\u52a1\u5668\u7aef, \u4f7f\u7528\u65f6\u76f4\u63a5\u8fd0\u884c\u547d\u4ee4\u5373\u53ef\uff1b</li> <li>modules in any languages\uff1a\u57fa\u4e8e\u6a21\u5757\u5de5\u4f5c, \u4e30\u5bcc\u7684\u5185\u7f6e\u6a21\u5757\uff0c\u53ef\u4f7f\u7528\u4efb\u610f\u8bed\u8a00\u5f00\u53d1\u6a21\u5757\uff1b</li> <li>yaml, not code\uff1a\u4f7f\u7528yaml\u8bed\u8a00\u5b9a\u5236\u5267\u672cplaybook\uff0c\u6613\u4e8e\u7ba1\u7406\uff0cAPI\u7b80\u5355\u660e\u4e86\uff1b</li> <li>ssh by default\uff1a\u57fa\u4e8eSSH\u5de5\u4f5c\uff0c\u6574\u4e2a\u8fc7\u7a0b\u7b80\u5355\u3001\u65b9\u4fbf\u3001\u5b89\u5168\uff0c\u5efa\u8bae\u4f7f\u7528\u516c\u94a5\u65b9\u5f0f\u8ba4\u8bc1\uff1b</li> <li>strong multi-tier solution\uff1a\u53ef\u5b9e\u73b0\u591a\u7ea7\u6307\u6325\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#3ansible","title":"3\u3001\u7b80\u8ff0Ansible\u4e2d\u5982\u4f55\u4fdd\u5b58\u654f\u611f\u6570\u636e\uff1f","text":"<p>\u5728ansible\u5185\u5bb9\u4e2d\u4fdd\u7559\u79d8\u5bc6\u6570\u636e\u5e76\u4ecd\u7136\u516c\u5f00\u5171\u4eab\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728playbooks\u4e2d\u4f7f\u7528Vault\u3002Ansible Vault\uff0c\u5b83\u5305\u542b\u5728Ansible\u4e2d\uff0c\u53ef\u4ee5\u52a0\u5bc6\u548c\u89e3\u5bc6Ansible\u4f7f\u7528\u7684\u4efb\u4f55\u7ed3\u6784\u5316\u6570\u636e\u6587\u4ef6\u3002</p>"},{"location":"chap4/9Ansible_interview/#4ansible","title":"4\u3001\u7b80\u8ff0Ansible\u9002\u5408\u7684\u573a\u666f\uff1f","text":"<p>Ansible\u5c06\u7f16\u6392\u4e0e\u914d\u7f6e\u7ba1\u7406\u3001\u4f9b\u5e94\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u7ed3\u5408\u5e76\u7edf\u4e00\u5728\u4e00\u4e2a\u6613\u4e8e\u4f7f\u7528\u7684\u5e73\u53f0\u4e0a\u3002Ansible\u7684\u4e00\u4e9b\u4e3b\u8981\u573a\u666f\u5305\u62ec:</p> <ul> <li>\u914d\u7f6e\u7ba1\u7406\uff1a\u96c6\u4e2d\u914d\u7f6e\u6587\u4ef6\u7ba1\u7406\u548c\u90e8\u7f72\u662fAnsible\u7684\u4e00\u4e2a\u5e38\u89c1\u573a\u666f\u3002</li> <li>\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\uff1a\u5f53\u4f7f\u7528Ansible\u5b9a\u4e49\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u4f7f\u7528Ansible Tower\u7ba1\u7406\u90e8\u7f72\u65f6\uff0c\u56e2\u961f\u53ef\u4ee5\u6709\u6548\u5730\u7ba1\u7406\u4ece\u5f00\u53d1\u5230\u751f\u4ea7\u7684\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u751f\u547d\u5468\u671f\u3002</li> <li>\u90e8\u7f72\uff1a\u5f53\u5728\u7cfb\u7edf\u4e0a\u90e8\u7f72\u6216\u5b89\u88c5\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cAnsible\u548cAnsible Tower\u53ef\u4ee5\u5e2e\u52a9\u7b80\u5316\u4f9b\u5e94\u7cfb\u7edf\u7684\u6d41\u7a0b\uff0c\u65e0\u8bba\u662fPXE\u542f\u52a8\u7684\u88f8\u91d1\u5c5e\u670d\u52a1\u5668\u6216\u865a\u62df\u673a\uff0c\u8fd8\u662f\u4ece\u6a21\u677f\u521b\u5efa\u865a\u62df\u673a\u6216\u4e91\u5b9e\u4f8b\u3002</li> <li>\u6301\u7eed\u4ea4\u4ed8\uff1a\u521b\u5efaCI/CD\u7ba1\u9053\u9700\u8981\u8bb8\u591a\u56e2\u961f\u7684\u534f\u8c03\u548c\u53c2\u4e0e\u3002\u5982\u679c\u6ca1\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u81ea\u52a8\u5316\u5e73\u53f0\uff0c\u56e2\u961f\u534f\u4f5c\u5f88\u96be\u5b8c\u6210\u3002\u800cAnsible playbook\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\u53ef\u4ee5\u4fdd\u6301\u9002\u5f53\u7684\u90e8\u7f72(\u548c\u7ba1\u7406)</li> <li>\u5b89\u5168\u6027\u548c\u5ba1\u8ba1\uff1a\u5f53\u5b89\u5168\u7b56\u7565\u5728Ansible\u4e2d\u5b9a\u4e49\u65f6\uff0c\u53ef\u4ee5\u5c06\u7ad9\u70b9\u8303\u56f4\u7684\u5b89\u5168\u7b56\u7565\u7684\u626b\u63cf\u548c\u4fee\u590d\u96c6\u6210\u5230\u5176\u4ed6\u81ea\u52a8\u5316\u6d41\u7a0b\u4e2d\u3002\u5b89\u5168\u6027\u662f\u90e8\u7f72\u7684\u6240\u6709\u5185\u5bb9\u4e2d\u4e0d\u53ef\u6216\u7f3a\u7684\u4e00\u90e8\u5206\u3002</li> <li>\u7f16\u6392\uff1a\u914d\u7f6e\u672c\u8eab\u4e0d\u80fd\u5b9a\u4e49\u73af\u5883\uff0c\u9700\u8981\u5b9a\u4e49\u591a\u4e2a\u914d\u7f6e\u5982\u4f55\u4ea4\u4e92\uff0c\u5e76\u786e\u4fdd\u53ef\u4ee5\u5c06\u4e0d\u540c\u7684\u90e8\u5206\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u6765\u7ba1\u7406</li> </ul>"},{"location":"chap4/9Ansible_interview/#5ansible-inventory","title":"5\u3001\u7b80\u8ff0Ansible Inventory\uff1f","text":"<p>Ansible\u4e2d\u53d7\u7ba1\u4e3b\u673a\u5217\u5728\u4e3b\u673a\u6e05\u5355\uff08inventory\uff09\u6587\u672c\u6587\u4ef6\u4e2d\uff0c\u6e05\u5355\u8fd8\u5c06\u8fd9\u4e9b\u7cfb\u7edf\u7ec4\u7ec7\u6210group\uff0c\u4ee5\u4fbf\u66f4\u5bb9\u6613\u5730\u8fdb\u884c\u6279\u91cf\u7ba1\u7406\u3002</p> <p>\u4e00\u4e2aInventory\u5b9a\u4e49\u4e86Ansible\u5c06\u7ba1\u7406\u7684\u4e3b\u673a\u96c6\u5408\u3002\u8fd9\u4e9b\u4e3b\u673a\u8fd8\u53ef\u4ee5\u5206\u914d\u81f3\u7ec4\uff0c\u53ef\u4ee5\u5bf9\u7ec4\u8fdb\u884c\u6279\u91cf\u7ba1\u7406\u3002\u7ec4\u53ef\u4ee5\u5305\u542b\u5b50\u7ec4\uff0c\u4e3b\u673a\u53ef\u4ee5\u662f\u591a\u4e2a\u7ec4\u7684\u6210\u5458\u3002Inventory\u6839\u636e\u7c7b\u578b\u53ef\u5206\u4e3a\u9759\u6001\u6e05\u5355\u548c\u52a8\u6001\u6e05\u5355\uff1a</p> <ul> <li>\u9759\u6001\u4e3b\u673aInventory\u53ef\u4ee5\u7531\u6587\u672c\u6587\u4ef6\u5b9a\u4e49\u3002</li> <li>\u52a8\u6001\u4e3b\u673aInventory\u53ef\u4ee5\u7531\u811a\u672c\u6216\u5176\u4ed6\u7a0b\u5e8f\u6839\u636e\u9700\u8981\u4f7f\u7528\u5916\u90e8\u4fe1\u606f\u63d0\u4f9b\u8005\u751f\u6210\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#6ansible","title":"6\u3001\u7b80\u8ff0Ansible\u914d\u7f6e\u6587\u4ef6\u4f18\u5148\u7ea7\uff1f","text":"<p>Ansible \u53ea\u4f7f\u7528\u6700\u9ad8\u4f18\u5148\u7ea7\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u8bbe\u7f6e\uff0c\u5176\u5b83\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u8bbe\u7f6e\u5c06\u88ab\u5ffd\u7565\u3002\u5373\u4f7f\u5b58\u5728\u5176\u4ed6\u4f18\u5148\u7ea7\u8f83\u4f4e\u7684\u6587\u4ef6\uff0c\u5b83\u4eec\u7684\u8bbe\u7f6e\u4e5f\u5c06\u88ab\u5ffd\u7565\uff0c\u5e76\u4e14\u4e0d\u4f1a\u4e0e\u6240\u9009\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u8bbe\u7f6e\u76f8\u7ed3\u5408\u3002</p> <p><code>$ANSIBLE_CONFIG</code>\u73af\u5883\u53d8\u91cf\u6307\u5b9a\u7684\u4efb\u4f55\u6587\u4ef6\u90fd\u5c06\u8986\u76d6\u6240\u6709\u5176\u4ed6\u914d\u7f6e\u6587\u4ef6\u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8be5\u53d8\u91cf\uff0c\u63a5\u4e0b\u6765\u5c06\u68c0\u67e5\u8fd0\u884cansible\u547d\u4ee4\u7684\u76ee\u5f55\u4ee5\u67e5\u627e<code>ansible.cfg</code>\u6587\u4ef6\u3002</p> <p>\u5982\u679c\u8be5\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219\u68c0\u67e5\u7528\u6237\u7684\u4e3b\u76ee\u5f55\u4ee5\u67e5\u627e<code>.ansible.cfg</code>\u6587\u4ef6\u3002\u5982\u4e0a\u914d\u7f6e\u6587\u4ef6\u90fd\u4e0d\u5b58\u5728\u65f6\uff0c\u624d\u4f7f\u7528\u5168\u5c40<code>/etc/ansible/ansible.cfg</code>\u6587\u4ef6\u3002</p>"},{"location":"chap4/9Ansible_interview/#7ansible-ad-hoc","title":"7\u3001\u7b80\u8ff0Ansible ad-hoc\u547d\u4ee4\uff1f","text":"<p>Ad-Hoc\u547d\u4ee4\u662f\u4e00\u79cd\u5feb\u901f\u6267\u884c\u5355\u4e2aAnsible\u4efb\u52a1\u7684\u65b9\u6cd5\uff0c\u9002\u5408\u4e8e\u4e0d\u9700\u8981\u6c38\u4e45\u4fdd\u5b58\u8be5\u4efb\u52a1\uff0c\u4e34\u65f6\u6267\u884c\u7684\u573a\u666f\u3002Ad-Hoc\u662f\u7b80\u5355\u7684\u63a7\u5236\u53f0\u64cd\u4f5c\uff0c\u65e0\u9700\u7f16\u5199\u5267\u672c\u5c31\u53ef\u4ee5\u8fd0\u884c\u3002\u5b83\u4eec\u5bf9\u4e8e\u5feb\u901f\u6d4b\u8bd5\u548c\u66f4\u6539\u975e\u5e38\u6709\u7528\u3002</p>"},{"location":"chap4/9Ansible_interview/#8ansible-ad-hocplaybook","title":"8\u3001\u7b80\u8ff0Ansible ad-hoc\u548cplaybook\u7684\u533a\u522b\uff1f","text":"<ul> <li>Ad-Hoc \u547d\u4ee4\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u6b21\u6027\u547d\u4ee4\u5bf9\u4e00\u7ec4\u76ee\u6807\u4e3b\u673a\u8fd0\u884c\u5355\u4e2a\u3001\u7b80\u5355\u7684\u4efb\u52a1\u3002</li> <li>Ad-Hoc \u4e0d\u9002\u5408\u590d\u6742\u914d\u7f6e\u7ba1\u7406\u6216\u7f16\u914d\u573a\u666f\uff0cAd-Hoc \u4e00\u6b21\u53ea\u80fd\u8c03\u7528\u4e00\u4e2a\u6a21\u5757\u548c\u4e00\u7ec4\u53c2\u6570\u3002\u5f53\u9700\u8981\u591a\u4e2a\u64cd\u4f5c\u65f6\uff0c\u5fc5\u987b\u4f7f\u7528\u591a\u4e2a Ad-Hoc \u6765\u6267\u884c\u3002</li> <li>playbook\u53ef\u4ee5\u5b9e\u73b0\u4ee5\u4e00\u79cd\u7b80\u6613\u91cd\u590d\u7684\u65b9\u5f0f\u5bf9\u4e00\u7ec4\u76ee\u6807\u4e3b\u673a\u8fd0\u884c\u591a\u4e2a\u590d\u6742\u7684\u4efb\u52a1\u3002</li> <li>Playbook \u662f\u63cf\u8ff0\u8981\u5728\u53d7\u7ba1\u4e3b\u673a\u4e0a\u5b9e\u65bd\u7684\u5fc5\u8981\u914d\u7f6e\u6216\u7a0b\u5e8f\u6027\u6b65\u9aa4\u7684\u6587\u4ef6\u3002</li> <li>Playbook \u4e3a\u914d\u7f6e\u7ba1\u7406\u548c\u90e8\u7f72\u63d0\u4f9b\u4e86\u5f3a\u5927\u800c\u7075\u6d3b\u7684\u89e3\u51b3\u65b9\u6848\u3002</li> <li>Playbook \u53ef\u4ee5\u5c06\u5197\u957f\u800c\u590d\u6742\u7684\u7ba1\u7406\u4efb\u52a1\u8f6c\u53d8\u4e3a\u53ef\u8f7b\u677e\u91cd\u590d\u7684\u5386\u7a0b\uff0c\u5e76\u4e14\u53ef\u9884\u6d4b\u6210\u679c\u7136\u800c\u3002</li> <li>playbook \u662f\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u6309\u987a\u5e8f\u8fd0\u884c\u7684play\u7684\u5217\u8868\u3002</li> <li>playbook\u4e2d\uff0c\u53ef\u4ee5\u5c06playbook\u4e2d\u7684tasks\u4fdd\u5b58\u4e3a\u4eba\u7c7b\u53ef\u8bfb\u4e14\u53ef\u7acb\u5373\u8fd0\u884c\u7684\u5f62\u5f0f\u3002</li> <li>play \u662f\u4e00\u7ec4\u6709\u5e8f\u7684\u4efb\u52a1\uff0c\u5e94\u8be5\u5bf9\u4ece\u76ee\u5f55\u4e2d\u9009\u62e9\u7684\u4e3b\u673a\u8fd0\u884c\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#9ansible","title":"9\u3001\u7b80\u8ff0Ansible\u53d8\u91cf\uff1f","text":"<p>Ansible \u5229\u7528\u53d8\u91cf\u5b58\u50a8\u6574\u4e2a Ansible \u9879\u76ee\u6587\u4ef6\u4e2d\u53ef\u91cd\u590d\u4f7f\u7528\u7684\u503c\uff0c\u4ece\u800c\u53ef\u4ee5\u7b80\u5316\u9879\u76ee\u7684\u521b\u5efa\u548c\u7ef4\u62a4\uff0c\u5e76\u51cf\u5c11\u9519\u8bef\u7684\u53d1\u751f\u7387\u3002\u5728\u5b9a\u4e49Ansible\u53d8\u91cf\u65f6\uff0c\u901a\u5e38\u6709\u5982\u4e0b\u4e09\u79cd\u8303\u56f4\u7684\u53d8\u91cf\uff1a</p> <ul> <li>global\u8303\u56f4\uff1a\u4ece\u547d\u4ee4\u884c\u6216Ansible\u914d\u7f6e\u4e2d\u8bbe\u7f6e\u7684\u53d8\u91cf\uff1b</li> <li>play\u8303\u56f4\uff1a\u5728 play \u548c\u76f8\u5173\u7ed3\u6784\u4e2d\u8bbe\u7f6e\u7684\u53d8\u91cf\uff1b</li> <li>host\u8303\u56f4\uff1ainventory\u3001facts \u6216 register \u7684\u53d8\u91cf\uff0c\u5728\u4e3b\u673a\u7ec4\u548c\u4e2a\u522b\u4e3b\u673a\u4e0a\u8bbe\u7f6e\u7684\u53d8\u91cf\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#10ansible","title":"10\u3001\u7b80\u8ff0Ansible\u5982\u4f55\u5b9e\u73b0\u4efb\u52a1\u7684\u5faa\u73af\uff1f","text":"<p>\u7b80\u5355\u5faa\u73af\uff1a</p> <ul> <li>Ansible\u652f\u6301\u4f7f\u7528loop\u5728\u4e00\u7ec4item\u4e0a\u8fed\u4ee3\u4efb\u52a1\uff1b</li> <li>loop\u53ef\u4ee5\u4f7f\u7528\u5217\u8868\u4e2d\u7684\u6bcf\u4e2a\u9879\u3001\u5217\u8868\u4e2d\u6bcf\u4e2a\u6587\u4ef6\u7684\u5185\u5bb9\u3001\u751f\u6210\u7684\u6570\u5b57\u5e8f\u5217\u6216\u4f7f\u7528\u66f4\u590d\u6742\u7684\u7ed3\u6784\u6765\u91cd\u590d\u4efb\u52a1\u3002</li> <li>\u4f7f\u7528loop\u4f7f\u7ba1\u7406\u5458\u4e0d\u5fc5\u7f16\u5199\u4f7f\u7528\u76f8\u540c\u6a21\u5757\u7684\u591a\u4e2a\u4efb\u52a1\u3002</li> </ul> <p>\u590d\u6742\uff08\u5d4c\u5957\uff09\u5faa\u73af\uff1a</p> <ul> <li><code>with_nested</code>\u952e\u7528\u4e8e\u5d4c\u5957\u5faa\u73af\uff0c\u5faa\u73af\u5728\u5faa\u73af\u4e2d\u8fd0\u884c\u3002\u5b83\u9700\u8981\u4e00\u4e2a\u5305\u542b\u4e24\u4e2a\u6216\u591a\u4e2a\u5217\u8868\u7684\u5217\u8868\u3002\u4f8b\u5982\uff0c\u5c06\u4e00\u4e2a\u5217\u8868\u5212\u5206\u4e3a\u4e24\u4e2a\u5217\u8868\uff0c\u4efb\u52a1\u5c06\u8fed\u4ee3\u7b2c\u4e00\u4e2a\u5217\u8868\u4e2d\u7684\u6bcf\u4e00\u9879\u4e0e\u7b2c\u4e8c\u4e2a\u5217\u8868\u4e2d\u7684\u6bcf\u4e00\u9879\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#11ansible-hanlder","title":"11\u3001\u7b80\u8ff0Ansible hanlder\uff1f","text":"<p>Ansible\u6a21\u5757\u88ab\u8bbe\u8ba1\u6210\u5e42\u7b49\u7684\uff0c\u5373\u5728\u4e00\u4e2a\u9002\u5f53\u7f16\u5199\u7684\u5267\u672c\u4e2d\uff0c\u5267\u672c\u53ca\u5176\u4efb\u52a1\u53ef\u4ee5\u5728\u4e0d\u66f4\u6539\u53d7\u7ba1\u4e3b\u673a\u7684\u60c5\u51b5\u4e0b\u591a\u6b21\u8fd0\u884c\uff0c\u9664\u975e\u5b83\u4eec\u9700\u8981\u8fdb\u884c\u66f4\u6539\u4ee5\u4f7f\u53d7\u7ba1\u4e3b\u673a\u8fbe\u5230\u6240\u9700\u7684\u72b6\u6001\u3002</p> <p>\u7136\u800c\uff0c\u6709\u65f6\u5f53\u4e00\u4e2a\u4efb\u52a1\u5bf9\u7cfb\u7edf\u8fdb\u884c\u4e86\u66f4\u6539\u540e\u540c\u65f6\u9700\u8981\u8fd0\u884c\u53e6\u4e00\u4e2a\u4efb\u52a1\u3002\u4f8b\u5982\uff0c\u5bf9\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u7684\u66f4\u6539\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u52a0\u8f7d\u670d\u52a1\uff0c\u4ee5\u4fbf\u66f4\u6539\u540e\u7684\u914d\u7f6e\u751f\u6548\u3002\u6b64\u65f6\u5c31\u9700\u8981\u4f7f\u7528hanlder\u7a0b\u5e8f\u3002handler\u7a0b\u5e8f\u662f\u54cd\u5e94\u7531\u5176\u4ed6\u4efb\u52a1\u7ec4\u6210\u7684\u901a\u77e5\u7684\u4efb\u52a1\u3002\u6bcf\u4e2ahandler\u7a0b\u5e8f\u90fd\u6709\u4e00\u4e2a\u5168\u5c40\u60df\u4e00\u7684\u540d\u79f0\uff0c\u5e76\u5728\u5267\u672c\u4e2d\u4efb\u52a1\u5757\u7684\u672b\u5c3e\u89e6\u53d1\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u4efb\u52a1\u901a\u8fc7\u540d\u79f0\u8c03\u7528handler\u7a0b\u5e8f\uff0c\u5b83\u5c06\u4e0d\u4f1a\u8fd0\u884c\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u6216\u591a\u4e2a\u4efb\u52a1\u90fd\u8c03\u7528handler\u7a0b\u5e8f\uff0c\u5b83\u5c06\u5728\u5267\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u4efb\u52a1\u5b8c\u6210\u540e\u4ec5\u8fd0\u884c\u4e00\u6b21\u3002</p> <p>\u56e0\u4e3ahandler\u7a0b\u5e8f\u662f\u4efb\u52a1\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728handler\u7a0b\u5e8f\u4e2d\u4f7f\u7528\u4e0e\u5904\u7406\u4efb\u4f55\u5176\u4ed6\u4efb\u52a1\u76f8\u540c\u7684\u6a21\u5757\u3002\u901a\u5e38\uff0chandler\u7a0b\u5e8f\u7528\u4e8e\u91cd\u65b0\u542f\u52a8\u4e3b\u673a\u548c\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u3002</p> <p>handler\u7a0b\u5e8f\u53ef\u4ee5\u89c6\u4e3a\u975e\u6d3b\u52a8\u4efb\u52a1\uff0c\u53ea\u6709\u5728\u4f7f\u7528notify\u8bed\u53e5\u663e\u5f0f\u8c03\u7528\u65f6\u624d\u4f1a\u89e6\u53d1\u8fd9\u4e9b\u4efb\u52a1\u3002</p>"},{"location":"chap4/9Ansible_interview/#12ansible-block","title":"12\u3001\u7b80\u8ff0Ansible Block\uff1f","text":"<p>\u5728 playbook \u4e2d\uff0c blocks \u662f\u56ca\u62ec\u4e86\u4efb\u52a1\u7684\u5b50\u53e5\uff1b</p> <p>blocks \u5141\u8bb8\u5bf9\u4efb\u52a1\u8fdb\u884c\u903b\u8f91\u5206\u7ec4\uff0c\u5e76\u53ef\u7528\u4e8e\u63a7\u5236\u4efb\u52a1\u7684\u6267\u884c\u65b9\u5f0f\uff0c\u4f8b\u5982\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7ec4\u4e3b\u8981\u4efb\u52a1\u548c\u4e00\u7ec4\u9644\u52a0\u4efb\u52a1\uff0c\u9644\u52a0\u4efb\u52a1\u4ec5\u5728\u7b2c\u4e00\u7ec4\u5931\u8d25\u65f6\u6267\u884c\u3002\u4e3a\u6b64\uff0c\u53ef\u5229\u7528\u4e09\u4e2a\u5173\u952e\u5b57\u5728 playbook \u4e2d\u4f7f\u7528\u5757\uff1a</p> <ul> <li>block\uff1a\u5b9a\u4e49\u8981\u8fd0\u884c\u7684\u4e3b\u8981\u4efb\u52a1\uff1b</li> <li>rescue\uff1a\u5b9a\u4e49\u5c06\u5728 block \u5b50\u53e5\u4e2d\u5b9a\u4e49\u7684\u4efb\u52a1\u5931\u8d25\u65f6\u8fd0\u884c\u7684\u4efb\u52a1\uff1b</li> <li>always\uff1a\u5b9a\u4e49\u59cb\u7ec8\u90fd\u72ec\u7acb\u8fd0\u884c\u7684\u4efb\u52a1\uff0c\u4e0d\u8bba block \u548c rescue \u5b50\u53e5\u4e2d\u5b9a\u4e49\u7684\u4efb\u52a1\u662f\u6210\u529f\u8fd8\u662f\u5931\u8d25\u3002 \u7b80\u8ff0Ansible\u5982\u4f55\u5904\u7406play\u9519\u8bef\u7684\uff1f</li> </ul>"},{"location":"chap4/9Ansible_interview/#13ansibleplay","title":"13\u3001\u7b80\u8ff0Ansible\u5982\u4f55\u5904\u7406play\u9519\u8bef\u7684\uff1f","text":"<p>Ansible\u5ba1\u67e5\u6bcf\u4e2a\u4efb\u52a1\u7684\u8fd4\u56de\u4ee3\u7801\uff0c\u4ee5\u786e\u5b9a\u4efb\u52a1\u662f\u5426\u6210\u529f\u6216\u5931\u8d25\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5f53\u4e00\u4e2a\u4efb\u52a1\u5931\u8d25\u65f6\uff0cAnsible\u4f1a\u7acb\u5373\u4e2d\u6b62\u8be5\u4e3b\u673a\u4e0a\u7684\u5176\u4ed6\u64cd\u4f5c\uff0c\u5e76\u8df3\u8fc7\u6240\u6709\u540e\u7eed\u4efb\u52a1\u3002</p> <p>\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u82e5\u5e0c\u671b\u5373\u4f7f\u4efb\u52a1\u5931\u8d25\u4e5f\u80fd\u7ee7\u7eed\u6267\u884cplay\uff0cAnsible\u4e5f\u5305\u542b\u4e86\u591a\u79cd\u7279\u6027\u7528\u4e8e\u7ba1\u7406\u4efb\u52a1\u9519\u8bef\uff1a</p> <p>\u5ffd\u7565\u4efb\u52a1\u5931\u8d25\uff1a\u5728\u4efb\u52a1\u4e2d\u4f7f\u7528<code>ignore_errors</code>\u5173\u952e\u5b57\u5ffd\u7565\u9519\u8bef\uff0c\u5373\u4f7f\u4efb\u52a1\u5931\u8d25\uff0c\u4e5f\u7ee7\u7eed\u5728\u4e3b\u673a\u4e0a\u6267\u884cplaybook\u3002</p>"},{"location":"chap4/9Ansible_interview/#14ansible","title":"14\u3001\u7b80\u8ff0Ansible\u89d2\u8272\uff1f","text":"<p>\u6570\u636e\u4e2d\u5fc3\u6709\u5404\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u4e3b\u673a\u3002\u5982web\u670d\u52a1\u5668\u3001\u6570\u636e\u5e93\u670d\u52a1\u5668\uff0c\u57fa\u4e8e\u5f00\u53d1\u73af\u5883\u7684\u670d\u52a1\u5668\u3002\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5177\u6709\u5904\u7406\u6240\u6709\u8fd9\u4e9b\u60c5\u51b5\u7684\u4efb\u52a1\u548c\u4eba\u5458\u7684Ansible playbook\u5c06\u53d8\u5f97\u5e9e\u5927\u800c\u590d\u6742\u3002</p> <ul> <li>\u89d2\u8272\u5141\u8bb8\u5c06\u590d\u6742\u7684\u5267\u672c\u7ec4\u7ec7\u6210\u72ec\u7acb\u7684\u3001\u66f4\u5c0f\u7684\u5267\u672c\u548c\u6587\u4ef6\u3002</li> <li>\u89d2\u8272\u63d0\u4f9b\u4e86\u4e00\u79cd\u4ece\u5916\u90e8\u6587\u4ef6\u52a0\u8f7d\u4efb\u52a1\u3001\u5904\u7406\u7a0b\u5e8f\u548c\u53d8\u91cf\u7684\u65b9\u6cd5\u3002</li> <li>\u89d2\u8272\u4e5f\u53ef\u5173\u8054\u548c\u5f15\u7528\u9759\u6001\u7684\u6587\u4ef6\u548c\u6a21\u677f\u3002</li> <li>\u89d2\u8272\u53ef\u4ee5\u7f16\u5199\u6210\u6ee1\u8db3\u666e\u901a\u7528\u9014\u9700\u6c42\uff0c\u5e76\u4e14\u80fd\u88ab\u91cd\u590d\u5229\u7528\u3002</li> <li>\u5b9a\u4e49\u89d2\u8272\u7684\u6587\u4ef6\u5177\u6709\u7279\u5b9a\u7684\u540d\u79f0\uff0c\u5e76\u4ee5\u4e25\u683c\u7684\u76ee\u5f55\u7ed3\u6784\u8fdb\u884c\u7ec4\u7ec7\u3002</li> </ul>"},{"location":"chap4/9Ansible_interview/#15ansible-galaxy","title":"15\u3001\u7b80\u8ff0Ansible Galaxy\uff1f","text":"<p>Ansible Galaxy\u662f\u4e00\u4e2a\u7531\u5404\u79cdAnsible\u7ba1\u7406\u5458\u548c\u7528\u6237\u7f16\u5199\u7684Ansible\u89d2\u8272\u7684\u516c\u5171\u5e93\u3002</p> <p>\u5b83\u662f\u4e00\u4e2a\u5305\u542b\u6570\u5343\u4e2aAnsible\u89d2\u8272\u7684\u5f52\u6863\u6587\u4ef6\uff0c\u5e76\u4e14\u6709\u4e00\u4e2a\u53ef\u641c\u7d22\u7684\u6570\u636e\u5e93\uff0c\u5e2e\u52a9Ansible\u7528\u6237\u8bc6\u522b\u53ef\u80fd\u5e2e\u52a9\u4ed6\u4eec\u5b8c\u6210\u7ba1\u7406\u4efb\u52a1\u7684\u89d2\u8272\u3002Ansible Galaxy\u5305\u62ec\u6307\u5411\u65b0\u7528\u6237\u548c\u89d2\u8272\u5f00\u53d1\u4eba\u5458\u7684\u6587\u6863\u548c\u89c6\u9891\u7684\u94fe\u63a5\u3002</p>"},{"location":"chap4/9Ansible_interview/#16ansible","title":"16\u3001\u7b80\u8ff0Ansible\u5982\u4f55\u63a7\u5236\u4efb\u52a1\u7684\u5e76\u884c\u6267\u884c\uff1f","text":"<p>\u901a\u8fc7\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u5e76\u884c\u8fd0\u884c\u4efb\u52a1\uff0cAnsible\u53ef\u4ee5\u5bf9\u5267\u672c\u7684\u6267\u884c\u8fdb\u884c\u66f4\u591a\u7684\u63a7\u5236\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cAnsible\u9ed8\u8ba4\u6700\u591a\u5e76\u884c5\u4e2a\uff0c\u56e0\u6b64\u5b83\u5c06\u540c\u65f6\u57285\u53f0\u4e0d\u540c\u7684\u673a\u5668\u4e0a\u8fd0\u884c\u4e00\u4e2a\u7279\u5b9a\u7684\u4efb\u52a1\u3002Ansible\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6eforks\u6765\u8bbe\u7f6e\u5e76\u884c\u6267\u884c\u4efb\u52a1\u6570\u91cf\u3002</p> <p>\u540c\u65f6Ansible\u4e5f\u53ef\u4ee5\u901a\u8fc7serial\u6765\u51cf\u5c11ork\u6570\u91cf\u6240\u6307\u5b9a\u7684\u5e76\u884c\u4e66\uff0cserial\u5173\u952e\u5b57\u4e3b\u8981\u7528\u4e8e\u63a7\u5236\u6eda\u52a8\u66f4\u65b0\uff0c\u907f\u514d\u4e00\u6b21\u6027\u66f4\u65b0\u8fc7\u591a\u7684\u8282\u70b9\u3002</p>"},{"location":"chap4/9Ansible_interview/#17ansible","title":"17\u3001\u7b80\u8ff0Ansible\u6545\u969c\u540e\u7684\u6392\u67e5\u601d\u8def\uff1f","text":"<ul> <li>\u65e5\u5fd7\u5224\u65ad\uff1a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cAnsible\u6ca1\u6709\u914d\u7f6e\u4e3a\u5c06\u5176\u8f93\u51fa\uff0c\u8bb0\u5f55\u5230\u4efb\u4f55\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\u53ef\u901a\u8fc7<code>ansible.cfg</code>\u914d\u7f6e\u6587<code>default</code>\u90e8\u5206\u4e2d<code>\u7684log_path</code>\u53c2\u6570\u6216<code>$ANSIBLE_LOG\u73af</code>\u5883\u53d8\u91cf\u8fdb\u884c\u914d\u7f6e\u3002\u7136\u540e\u901a\u8fc7\u65e5\u5fd7\u8fdb\u884c\u5b9a\u4f4d\u3002</li> <li>Debug\u6a21\u5757\uff1a\u8c03\u8bd5\u6a21\u5757\u662fAnsible\u53ef\u7528\u7684\u6a21\u5757\u4e4b\u4e00\uff0c\u5b83\u53ef\u4ee5\u66f4\u597d\u5730\u4e86\u89e3\u63a7\u5236\u8282\u70b9\u4e0a\u6b63\u5728\u8fdb\u884c\u7684\u64cd\u4f5c\u3002\u8fd9\u4e2a\u6a21\u5757\u53ef\u4ee5\u5728playbook\u6267\u884c\u65f6\u4e3a\u67d0\u4e2a\u53d8\u91cf\u63d0\u4f9b\u503c\u3002</li> <li><code>syntax-check</code>\uff1a\u901a\u8fc7<code>ansible-playbook</code> \u547d\u4ee4\u7684 <code>--syntax-check</code>\u547d\u9009\u9879\u68c0\u67e5\u5267\u672c\u7684YAML\u8bed\u6cd5\u3002</li> <li>\u2022 diff\uff1aAnsible\u8fd8\u63d0\u4f9b\u4e86<code>--diff</code>\u9009\u9879\u3002\u6b64\u9009\u9879\u62a5\u544a\u5bf9\u53d7\u7ba1\u4e3b\u673a\u4e0a\u7684\u6a21\u677f\u6587\u4ef6\u6240\u505a\u7684\u66f4\u6539\u3002\u5982\u679c\u4e0e<code>--check</code>\u9009\u9879\u4e00\u8d77\u4f7f\u7528\uff0c\u8fd9\u4e9b\u66f4\u6539\u5c06\u663e\u793a\u51fa\u6765\uff0c\u800c\u4e0d\u662f\u5b9e\u9645\u6267\u884c\u3002\u4ece\u800c\u5224\u65adAnsible\u6574\u4e2a\u8fc7\u7a0b\u9700\u8981\u505a\u4f55\u79cd\u66f4\u6539\u3002</li> </ul>"},{"location":"chap5/10terraform_adv/","title":"Terraform Advanced(Troubleshooting/Data Sources/Existing Resource)","text":""},{"location":"chap5/10terraform_adv/#1-troubleshooting-terraform","title":"1 Troubleshooting Terraform","text":""},{"location":"chap5/10terraform_adv/#overview","title":"Overview","text":"<ul> <li>Validating configurations</li> <li>Enable verbose logging</li> <li>Resource taints</li> <li>Crash logs</li> </ul> <p>Example: Application Update</p> <p></p>"},{"location":"chap5/10terraform_adv/#type-of-errors-in-terraform","title":"Type of Errors in Terraform","text":"<p>Command error / Syntax validation / Provider validation /  Deployment error / Panic!</p> <ul> <li>The first is a command error\uff0c so this is simply an error that happens when you're using the command line, and there are definitelv ways to troubleshoot that error.</li> <li>There's syntax validation, and this is the process by which Terraform validates the HashiCorp configuration language that you've laid out for your configuration and also some of the logic within that configuration</li> <li>Provider validation , when Terraform runs its plan process, the provider has to agree with what's in that configuration. Now, even if the provider agrees, when we get to the apply stage, sometimes deployment errors happen</li> <li>Things like resource taints.</li> <li>Sometimes Terraform just breaks.</li> </ul>"},{"location":"chap5/10terraform_adv/#command-error","title":"Command Error","text":"<ul> <li>Happens at the command line</li> <li>Bad CLI syntax or arguments</li> <li>Use the help argument</li> <li>Read the docs</li> </ul> <p>Example: test Terraform file</p> <p><code>s3.tf</code></p> <pre><code>#### S3 buckets\nvariable \"aws_bucket_prefix\" {\n  type    = strings\n  #type = string\n\n  default = \"jack\"\n}\n\nresource \"random_integer\" \"rand\" {\n  min = 10000\n  max = 99999\n}\n\nlocals {\n  bucket_name         = \"${var.aws_bucket_prefix}_${random_integer.rand.result}\"\n  #bucket_name         = \"${var.aws_bucket_prefix}-${random_integer.rand.result}\"\n}\n\nresource \"aws_s3_bucket\" \"logs_bucket\" {\n  bucket        = local.bucket_name\n  acl           = \"private\"\n  force_destroy = true\n\n  versioning {\n    enabled = true\n  }\n\n}\n\n#### Instance profiles\n\nresource \"aws_iam_instance_profile\" \"asg\" {\n\n  lifecycle {\n    create_before_destroy = false\n  }\n\n  name = \"${terraform.workspace}_asg_profile_bug\"\n  role = \"aws_iam_role.asg.name\"\n  #role = aws_iam_role.asg.name\n}\n\n#### Instance roles\n\nresource \"aws_iam_role\" \"asg\" {\n  name = \"${terraform.workspace}_asg_role\"\n  path = \"/\"\n\n  assume_role_policy = &lt;&lt;EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\n  EOF\n}\n\n#### S3 policies\n\nresource \"aws_iam_role_policy\" \"asg\" {\n  name = \"${terraform.workspace}-jack-primary-rds\"\n  role = aws_iam_role.asg.ids\n  #role = aws_iam_role.asg.id\n\n  policy = &lt;&lt;-EOF\n  {\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n      {\n        \"Action\": [\n          \"s3:*\"\n        ],\n        \"Effect\": \"Allow\",\n        \"Resource\": [\n                \"arn:aws:s3:::${local.bucket_name}\",\n                \"arn:aws:s3:::${local.bucket_name}/*\"\n            ]\n      }\n    ]\n  }\n  EOF\n}\n</code></pre> <pre><code>terraform init -h\n</code></pre> <p>Try to run terraform init with a bad command switch</p> <pre><code>terraform init -backend-confi=\"path=applications/state/primary\"\n# Report Error. -backend-confi\n</code></pre> <pre><code>terraform init -backend-config=\"path=applications/state/primary\"\nInitializine provider plugins.\n- Checkine for available provider plugins...\n- Downloading plugin for provider \"aws\" (hashicorp/aws) 2.70.0.\n</code></pre>"},{"location":"chap5/10terraform_adv/#syntax-validation","title":"Syntax Validation","text":"<ul> <li>Terraform init first</li> <li>Checks syntax and logic</li> <li>Does not check state</li> <li>Manual or automatic</li> <li>Automation checks</li> </ul> <p>Validating the syntax of HashiCorp</p> <p>configuration language, it's actually validating some of the logic in the providers, you're using in your configuration and we'll see how that works, it's simply checking the configuration itself,</p> <p>The validation run can happen manually or automatically </p> <pre><code>terraform validate\n\nError: Invalid type specification\n\n    on s3.tf line 3, in variable \"aws_bucket_prefix\" :\n    3: type = strings\nThe keyword \"strings\" is not a valid type specification.\n</code></pre> <pre><code>terraform validate\n\nError: Unsupported attribute\n\n    on s3.tf line 65, in resource \"aws_iam_role_policy\" \"asg\"\n    65:  role = aws_iam_role.asg.ids\n\nThis object has no argument, nested block, or exported attribute named \"ids\"\nDid you mean \"id\"?\n</code></pre> <pre><code>### Try to run terraform validate \nterraform validate\n\nterraform fmt\n\n### Fix issues and run again\nterraform validate\n</code></pre>"},{"location":"chap5/10terraform_adv/#provider-validation-and-deployment-errors","title":"Provider Validation and Deployment Errors","text":"<ul> <li>Happens during plan or apply</li> <li>Read the error message, then read it again</li> <li>Enable logging for more detail</li> <li>Use taint to destroy bad resources</li> </ul> <pre><code>terraform workspace select development\nSwitched to workspace \"development\"\n\nterraform plan -out dev.tfplan\n</code></pre> <pre><code>bucket_name         = \"${var.aws_bucket_prefix}_${random_integer.rand.result}\"\n</code></pre> <ul> <li><code>\"${var.aws_bucket_prefix}_$**</code>: They cannot include an underscore, and that's why we got an error.</li> </ul> <pre><code>Error: Error creating S3 bucket: InvalidBucketName: The specified bucket is not valid.\n</code></pre> <pre><code>Error: Error creating IAM instance profile development asg profile: EntityAlreadyExists: Instance\nProfile development_asg_profile already exists.\n</code></pre>"},{"location":"chap5/10terraform_adv/#verbose-logging","title":"Verbose Logging","text":"<ul> <li>Exposes Terraform actions</li> <li>Enabled through <code>TF_LOG</code></li> <li>Write to file with <code>TF_LOG_PATH</code></li> <li>Trace is most verbose</li> <li>Useful in automation</li> </ul> <p>Terraform takes are being exposed at different levels depending on what type of verbose logging you enable.</p> <p>The way that you enable it is by setting the environment variable <code>TF_LOG</code> to one of a number of different settings. You can also write this logging out to a file by setting the environment variable <code>TF_LOG_PATH</code>, and that has to be the full path to a file, not just a directory. </p> <p>That's where it will write the data from the logging variable <code>TF_LOG_PATH</code>, and that has to be the full path to a file,</p> <p>As far as different levels of logging, the most verbose is called trace, and then there's debug, info, warn, and error.</p> <p>Generally speaking, you want to set it to something like info or warn, because trace and debug are incredibly verbose.</p> <p>Example</p> <p>you may want a report of everything that Terraform did at a particular information level. So you can set <code>TF_LOG</code> as part of your automation process, and set <code>TF_LOG_PATH</code> to store that information in a file.</p> <pre><code># Mac or Linux\nexport TF_LOG=INFO\n\n# PowerShell\n$env:TF_LOG=\"INFO\"\n</code></pre> <pre><code>### Fix issues and run again\nterraform plan -out dev.tfplan\nterraform apply \"dev.tfplan\"\n</code></pre> <pre><code>resource \"aws_iam_instance_profile\" \"asg\" {\n\n  lifecycle {\n    create_before_destroy = false\n  }\n\n  name = \"${terraform.workspace}_asg_profile_bug\"\n  role = \"aws_iam_role.asg.name\"\n  #role = aws_iam_role.asg.name\n}\n</code></pre>"},{"location":"chap5/10terraform_adv/#resource-taints","title":"Resource Taints","text":"<ul> <li>Marks a resource for recreation</li> <li>Terraform will taint automatically</li> <li>Identify resources by address</li> <li>Resources can be untainted as well</li> </ul> <p>Resource taints are a way to force the recreation of a resource. It basically tells Terraform recreate that resource for me because there's something is wrong with it. </p> <p>Terraform will taint things automatically if it knows they weren't created successfully. You can also taint something manually and you identify that object by its address within Terraform. </p> <p>Taint and Untaint Command</p> <pre><code># Command syntax\nterraform taint [options] address\n\n# Example single resource\nterraform taint aws_instance.example\n\n# Example module or collection\nterraform taint aws_instance.collection[0]\nterraform taint module.asg.aws_instance.example\n\n#Untaint syntax\nterraform untaint [options] address\n\n# Example single resource\nterraform untaint aws_instance.example\n</code></pre> <pre><code>### Taint asg and try to destroy\nterraform state list\nterraform taint aws_autoscaling_group.webapp_asg\nterraform taint aws_autoscaling_policy.scale_down\nterraform taint aws_autoscaling_policy.scale_up\nterraform taint aws_cloudwatch_metric_alarm.scale_down_alarm\nterraform taint aws_cloudwatch_metric_alarm.scale_up_alarm\n</code></pre> <p></p> <p>In our case, the autoscaling policies and CloudWatch metric alarms are both associated with that autoscaling group so those need to be tainted and recreated as well.</p> <pre><code>Error: Error creating AutoScaling Group: AlreadyExists: AutoScalingGroup by this name already exists\n\u2022 A group with the name ddt webapp asg-development already exists\n</code></pre> <pre><code>#create before destroy\n</code></pre> <p>The lifecycle setting, it should now destroy it before it tries to create </p>"},{"location":"chap5/10terraform_adv/#crash-log","title":"Crash Log","text":"<ul> <li>Generated when Terraform panics</li> <li>Caused by Terraform or provider</li> <li>Similar to trace logging</li> <li>Open an issue on GitHub</li> </ul> <pre><code>terraform init -from-module=\"../toplevel\"\n\n\nSECURITY WARNING: the\n\"crash.log\" file that was created may contain\nsensitive information that must be redacted before it is safe to share\non the issue tracker\n[1]: https://github.com/hashicorp/terraform/issues\n\nTERRAFORM CRASH \n</code></pre>"},{"location":"chap5/10terraform_adv/#2-using-data-sources-and-templates","title":"2 Using Data Sources and Templates","text":""},{"location":"chap5/10terraform_adv/#data-sources","title":"Data Sources","text":"<ul> <li>Glue for multiple configurations</li> <li>Resources are data sources</li> <li>Providers have data sources</li> <li> <p>Alternate data sources</p> <ul> <li>Templates</li> <li>HTTP</li> <li>External</li> <li>Consul</li> </ul> </li> <li> <p>HTTP Data Source</p> </li> </ul> <pre><code># Example data source\ndata \"http\" \"my_ip\"\n{\n    url = \"http: //ifconfig.me\"\n}\n\n# Using the response\ndata.http.my_ip.body\n</code></pre>"},{"location":"chap5/10terraform_adv/#consul-data-source","title":"Consul Data Source","text":"<pre><code># Consul data source\n\ndata \"consul_keys\" \"networking\" {\n\n    key { \n        name = \"vpc_cidr_range\"\n        path = \"networking/config/vpc/cidr_range\"\n        default = \"10.0.0.0/16\"\n    }\n}\n\n# Using the response\ndata.consul_keys.networking.var.vpc_cidr_range\n</code></pre> <p>Consul Setup</p> <p></p> <p><code>consul/primary-2.json</code></p> <pre><code>{\n    \"cidr_block\": \"10.0.0.0/16\",\n    \"subnet_count\": \"3\"\n}\n</code></pre> <p><code>networking/backend.tf</code></p> <pre><code>terraform {\n  backend \"consul\" {\n    address = \"127.0.0.1:8500\"\n    scheme  = \"http\"\n  }\n}\n</code></pre> <p><code>networking/variables.tf</code></p> <pre><code>##################################################################################\n# VARIABLES\n##################################################################################\n\nvariable \"region\" {\n  default = \"us-east-1\"\n}\n\nvariable \"consul_address\" {\n  type        = string\n  description = \"Address of Consul server\"\n  default     = \"127.0.0.1\"\n}\n\nvariable \"consul_port\" {\n  type        = number\n  description = \"Port Consul server is listening on\"\n  default     = \"8500\"\n}\n\nvariable \"consul_datacenter\" {\n  type        = string\n  description = \"Name of the Consul datacenter\"\n  default     = \"dc1\"\n}\n</code></pre> <p><code>networking/resources.tf</code></p> <pre><code>##################################################################################\n# CONFIGURATION - added for Terraform 0.14\n##################################################################################\n\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~&gt;3.0\"\n    }\n    consul = {\n      source  = \"hashicorp/consul\"\n      version = \"~&gt;2.0\"\n    }\n  }\n}\n\n##################################################################################\n# PROVIDERS\n##################################################################################\n\nprovider \"aws\" {\n  profile = \"deep-dive\"\n  region  = var.region\n}\n\nprovider \"consul\" {\n  address    = \"${var.consul_address}:${var.consul_port}\"\n  datacenter = var.consul_datacenter\n}\n\n##################################################################################\n# DATA\n##################################################################################\n\ndata \"aws_availability_zones\" \"available\" {}\n\ndata \"consul_keys\" \"networking\" {\n  key {\n    name = \"networking\"\n    path = \"networking/configuration/jack-primary/net_info\"\n  }\n}\n\n##################################################################################\n# LOCALS\n##################################################################################\n\nlocals {\n  cidr_block      = jsondecode(data.consul_keys.networking.var.networking)[\"cidr_block\"]\n  private_subnets = jsondecode(data.consul_keys.networking.var.networking)[\"private_subnets\"]\n  public_subnets  = jsondecode(data.consul_keys.networking.var.networking)[\"public_subnets\"]\n  subnet_count    = jsondecode(data.consul_keys.networking.var.networking)[\"subnet_count\"]\n}\n\n##################################################################################\n# RESOURCES\n##################################################################################\n\n# NETWORKING #\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~&gt;2.0\"\n\n  name = \"jack-primary\"\n\n  cidr            = local.cidr_block\n  azs             = slice(data.aws_availability_zones.available.names, 0, local.subnet_count)\n  private_subnets = local.private_subnets\n  public_subnets  = local.public_subnets\n\n  enable_nat_gateway = false\n\n  create_database_subnet_group = false\n\n\n  tags = {\n    Environment = \"Production\"\n    Team        = \"Network\"\n  }\n}\n</code></pre> <p>Read from consul</p> <pre><code>locals {\n  cidr_block      = jsondecode(data.consul_keys.networking.var.networking)[\"cidr_block\"]\n</code></pre> <p>Let's set the Consul token</p> <pre><code># Let's set the Consul token\n# Replace SECRETID_VALUE with secret ID\n# Linux and MacOS\nexport CONSUL_HTTP_TOKEN=SECRETID_VALUE\n\n# Windows\n$env:CONSUL_HTTP_TOKEN=\"SECRETID_VALUE\"\n\n# Write the configuration data for jack-primary config\nconsul kv put networking/configuration/jack-primary/net_info @jack-primary.json\nconsul kv put networking/configuration/jack-primary/common_tags @common-tags.json\n\n## Now go up and into the networking folder\ncd ..\\networking\n\n## We're going to initialize the Terraform config to use the Consul backend\nterraform init -backend-config=\"path=networking/state/jack-primary\"\n\n# Verify our state is loaded\nterraform state list\n</code></pre> <p></p>"},{"location":"chap5/10terraform_adv/#template-as-resource","title":"Template as resource","text":"<ul> <li>Manipulation of strings</li> <li>Overloaded term<ul> <li>Quoted strings</li> <li>Heredoc syntax</li> <li>Provider</li> <li>Function</li> </ul> </li> <li>Interpolation and directives</li> </ul> <p>Simple interpolation</p> <pre><code>\"S{var.prefix}-app\"\n</code></pre> <p>Conditional directive</p> <pre><code>\"%{ if var.prefix != \"\"}S(var.prefix}-app%{ else }generic-app%{ endif }\"\n</code></pre> <p>Collection directive with heredoc</p> <pre><code>&lt;&lt;EOT\n%{ for name in local.names }\n${name}-app\n%{ endfor }\nFOT\n</code></pre> <p>Template Syntax In-line</p> <pre><code># Template data source\ndata \"template_file\" \"example\" {\n    count = \"2\"\n  template = \"$${var1}-$${current_count}\"\n\n  vars = {\n        var1 = var.some_string\n        current_count = count.index\n}\n</code></pre> <p>Using the template</p> <pre><code>data.template_file.example.rendered\n</code></pre> <p></p> <pre><code># Template configuration\ndata \"template_file\" \"peer-role\"{\n    template = file(\"peer_policy.txt\")\n    vars = { \n            vpc_arn = var.vpc_arn\n    }\n}\n</code></pre> <p>Or templatefile function</p> <pre><code>templatefile(\"peer_policy.txt\", { vpc arn = var.vpc arn } )\n</code></pre> <p>Example: Networking projects</p> <p><code>networking/templates.tf</code></p> <pre><code>data \"template_file\" \"public_cidrsubnet\" {\n  count = local.subnet_count\n\n  template = \"$${cidrsubnet(vpc_cidr,8,current_count)}\"\n\n  vars = {\n    vpc_cidr      = local.cidr_block\n    current_count = count.index\n  }\n}\n\ndata \"template_file\" \"private_cidrsubnet\" {\n  count = local.subnet_count\n\n  template = \"$${cidrsubnet(vpc_cidr,8,current_count)}\"\n\n  vars = {\n    vpc_cidr      = local.cidr_block\n    current_count = count.index + 10\n  }\n}\n</code></pre> <p>What cidrsubnet does, is it takes a CIDR range and then, it adds whatever, number comes in the second argument to that CIDR range.</p> <p><code>networking/resource.tf</code></p> <pre><code>##################################################################################\n# CONFIGURATION - added for Terraform 0.14\n##################################################################################\n\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~&gt;3.0\"\n    }\n    consul = {\n      source  = \"hashicorp/consul\"\n      version = \"~&gt;2.0\"\n    }\n  }\n}\n\n##################################################################################\n# PROVIDERS\n##################################################################################\n\nprovider \"aws\" {\n  profile = \"deep-dive\"\n  region  = var.region\n}\n\nprovider \"consul\" {\n  address    = \"${var.consul_address}:${var.consul_port}\"\n  datacenter = var.consul_datacenter\n}\n\n##################################################################################\n# DATA\n##################################################################################\n\ndata \"aws_availability_zones\" \"available\" {}\n\ndata \"consul_keys\" \"networking\" {\n  key {\n    name = \"networking\"\n    path = \"networking/configuration/jack-primary/net_info\"\n  }\n\n  key {\n    name = \"common_tags\"\n    path = \"networking/configuration/jack-primary/common_tags\"\n  }\n}\n\n##################################################################################\n# LOCALS\n##################################################################################\n\nlocals {\n  cidr_block   = jsondecode(data.consul_keys.networking.var.networking)[\"cidr_block\"]\n  subnet_count = jsondecode(data.consul_keys.networking.var.networking)[\"subnet_count\"]\n  common_tags  = jsondecode(data.consul_keys.networking.var.common_tags)\n}\n\n##################################################################################\n# RESOURCES\n##################################################################################\n\n# NETWORKING #\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~&gt;2.0\"\n\n  name = \"jack-primary\"\n\n  cidr            = local.cidr_block\n  azs             = slice(data.aws_availability_zones.available.names, 0, local.subnet_count)\n  private_subnets = data.template_file.private_cidrsubnet.*.rendered\n  public_subnets  = data.template_file.public_cidrsubnet.*.rendered\n\n  enable_nat_gateway = false\n\n  create_database_subnet_group = false\n\n\n  tags = local.common_tags\n}\n</code></pre> <pre><code>private_subnets = data.template_file.private_cidrsubnet.*.rendered\npublic_subnets  = data.template_file.public_cidrsubnet.*.rendered\n</code></pre> <p>Run the example</p> <pre><code>## We're going to initialize the Terraform config to use the Consul backend\nterraform init -backend-config=\"path=networking/state/jack-primary\"\n\n# Verify our state is loaded\nterraform state list\n\n# Now we'll run a plan using the values stored in Consul.\n# All the tags should be updated\nterraform plan -out config.tfplan\n\nterraform apply config.tfplan\n</code></pre>"},{"location":"chap5/10terraform_adv/#3-working-with-existing-resources","title":"3 Working with Existing Resources","text":"<pre><code>##################################################################################\n# CONFIGURATION - added for Terraform 0.14\n##################################################################################\n\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~&gt;3.0\"\n    }\n  }\n}\n\n##################################################################################\n# PROVIDERS\n##################################################################################\n\nprovider \"aws\" {\n  profile = \"deep-dive\"\n  region  = var.region\n}\n\n##################################################################################\n# DATA\n##################################################################################\n\ndata \"aws_availability_zones\" \"available\" {}\n\n##################################################################################\n# RESOURCES\n##################################################################################\n\n# NETWORKING #\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~&gt;2.0\"\n\n  name = \"jack-primary\"\n\n  cidr            = var.cidr_block\n  azs             = slice(data.aws_availability_zones.available.names, 0, var.subnet_count)\n  private_subnets = var.private_subnets\n  public_subnets  = var.public_subnets\n\n  enable_nat_gateway = false\n\n  create_database_subnet_group = false\n\n\n  tags = {\n    Environment = \"Production\"\n    Team        = \"Network\"\n  }\n}\n</code></pre>"},{"location":"chap5/10terraform_adv/#using-workspaces-and-collaboration","title":"Using Workspaces and Collaboration","text":"<ul> <li>Common configuration</li> <li>Individual state data instance</li> <li>Multiple environments</li> <li>terraform.workspace</li> </ul> <p>Consul Setup</p> <p></p>"},{"location":"chap5/10terraform_adv/#state-as-data-source","title":"State as Data Source","text":"<pre><code>data \"terraform_remote state\" \"networking\"\n{\n    backend = \"consul\"\n    config = {\n        path    = var.network_path\n        address = var.consul_address\n        scheme  = var. consul_scheme\n  }\n}\n</code></pre>"},{"location":"chap5/10terraform_adv/#the-import-command","title":"The Import Command","text":"<pre><code># Command syntax\nterraform import [options] ADDR ID\n\n# ADDR - configuration resource identifier\n# EX. - module.vpc.aws_subnet.public[2]\n\n# ID - provider specific resource identifier\n# EX.- subnet-ad536afg9\n\n# Importing a subnet into a configuration\n\nterraform import -var-file=\"terraform.tfvars\" \\\nmodule.vpc.aws_subnet.public[2] subnet-ad536afg9\n</code></pre> <p><code>datasources.tf</code></p> <pre><code>##################################################################################\n# DATA SOURCES\n##################################################################################\n\ndata \"consul_keys\" \"applications\" {\n  key {\n    name = \"applications\"\n    path = terraform.workspace == \"default\" ? \"applications/configuration/globo-primary/app_info\" : \"applications/configuration/globo-primary/${terraform.workspace}/app_info\"\n  }\n\n  key {\n    name = \"common_tags\"\n    path = \"applications/configuration/globo-primary/common_tags\"\n  }\n}\n\ndata \"terraform_remote_state\" \"networking\" {\n  backend = \"consul\"\n\n  config = {\n    address = \"127.0.0.1:8500\"\n    scheme  = \"http\"\n    path    = terraform.workspace == \"default\" ? \"networking/state/globo-primary\" : \"networking/state/globo-primary-env:${terraform.workspace}\"\n  }\n}\n\ndata \"aws_ami\" \"aws_linux\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"amzn-ami-hvm-20*\"]\n  }\n\n  filter {\n    name   = \"architecture\"\n    values = [\"x86_64\"]\n  }\n\n  filter {\n    name   = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n\n  filter {\n    name   = \"root-device-type\"\n    values = [\"ebs\"]\n  }\n}\n</code></pre> <p><code>resources.tf</code></p> <pre><code>#Based on the work from https://github.com/arbabnazar/terraform-ansible-aws-vpc-ha-wordpress\n\n##################################################################################\n# CONFIGURATION - added for Terraform 0.14\n##################################################################################\n\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~&gt;3.0\"\n    }\n    consul = {\n      source  = \"hashicorp/consul\"\n      version = \"~&gt;2.0\"\n    }\n  }\n}\n\n##################################################################################\n# PROVIDERS\n##################################################################################\n\nprovider \"aws\" {\n  profile = \"deep-dive\"\n  region  = var.region\n}\n\nprovider \"consul\" {\n  address    = \"${var.consul_address}:${var.consul_port}\"\n  datacenter = var.consul_datacenter\n}\n\n##################################################################################\n# LOCALS\n##################################################################################\n\nlocals {\n  asg_instance_size = jsondecode(data.consul_keys.applications.var.applications)[\"asg_instance_size\"]\n  asg_max_size      = jsondecode(data.consul_keys.applications.var.applications)[\"asg_max_size\"]\n  asg_min_size      = jsondecode(data.consul_keys.applications.var.applications)[\"asg_min_size\"]\n  rds_storage_size  = jsondecode(data.consul_keys.applications.var.applications)[\"rds_storage_size\"]\n  rds_engine        = jsondecode(data.consul_keys.applications.var.applications)[\"rds_engine\"]\n  rds_version       = jsondecode(data.consul_keys.applications.var.applications)[\"rds_version\"]\n  rds_instance_size = jsondecode(data.consul_keys.applications.var.applications)[\"rds_instance_size\"]\n  rds_multi_az      = jsondecode(data.consul_keys.applications.var.applications)[\"rds_multi_az\"]\n  rds_db_name       = jsondecode(data.consul_keys.applications.var.applications)[\"rds_db_name\"]\n\n  common_tags = merge(jsondecode(data.consul_keys.applications.var.common_tags),\n    {\n      Environment = terraform.workspace\n    }\n  )\n}\n\n##################################################################################\n# RESOURCES\n##################################################################################\n\nresource \"aws_launch_configuration\" \"webapp_lc\" {\n  lifecycle {\n    create_before_destroy = true\n  }\n\n  name_prefix   = \"${terraform.workspace}-ddt-lc-\"\n  image_id      = data.aws_ami.aws_linux.id\n  instance_type = local.asg_instance_size\n\n  security_groups = [\n    aws_security_group.webapp_http_inbound_sg.id,\n    aws_security_group.webapp_ssh_inbound_sg.id,\n    aws_security_group.webapp_outbound_sg.id,\n  ]\n\n  user_data                   = file(\"./templates/userdata.sh\")\n  associate_public_ip_address = true\n}\n\nresource \"aws_elb\" \"webapp_elb\" {\n  name    = \"ddt-webapp-elb-${terraform.workspace}\"\n  subnets = data.terraform_remote_state.networking.outputs.public_subnets\n\n  listener {\n    instance_port     = 80\n    instance_protocol = \"http\"\n    lb_port           = 80\n    lb_protocol       = \"http\"\n  }\n\n  health_check {\n    healthy_threshold   = 2\n    unhealthy_threshold = 2\n    timeout             = 3\n    target              = \"HTTP:80/\"\n    interval            = 10\n  }\n\n  security_groups = [aws_security_group.webapp_http_inbound_sg.id]\n\n  tags = local.common_tags\n}\n\nresource \"aws_autoscaling_group\" \"webapp_asg\" {\n  lifecycle {\n    create_before_destroy = true\n  }\n\n  vpc_zone_identifier   = data.terraform_remote_state.networking.outputs.public_subnets\n  name                  = \"ddt_webapp_asg-${terraform.workspace}\"\n  max_size              = local.asg_max_size\n  min_size              = local.asg_min_size\n  wait_for_elb_capacity = local.asg_min_size\n  force_delete          = true\n  launch_configuration  = aws_launch_configuration.webapp_lc.id\n  load_balancers        = [aws_elb.webapp_elb.name]\n\n  dynamic \"tag\" {\n    for_each = local.common_tags\n    content {\n      key                 = tag.key\n      value               = tag.value\n      propagate_at_launch = true\n    }\n  }\n}\n\n#\n# Scale Up Policy and Alarm\n#\nresource \"aws_autoscaling_policy\" \"scale_up\" {\n  name                   = \"ddt_asg_scale_up-${terraform.workspace}\"\n  scaling_adjustment     = 2\n  adjustment_type        = \"ChangeInCapacity\"\n  cooldown               = 300\n  autoscaling_group_name = aws_autoscaling_group.webapp_asg.name\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"scale_up_alarm\" {\n  alarm_name                = \"ddt-high-asg-cpu-${terraform.workspace}\"\n  comparison_operator       = \"GreaterThanThreshold\"\n  evaluation_periods        = \"2\"\n  metric_name               = \"CPUUtilization\"\n  namespace                 = \"AWS/EC2\"\n  period                    = \"120\"\n  statistic                 = \"Average\"\n  threshold                 = \"80\"\n  insufficient_data_actions = []\n\n  dimensions = {\n    AutoScalingGroupName = aws_autoscaling_group.webapp_asg.name\n  }\n\n  alarm_description = \"EC2 CPU Utilization\"\n  alarm_actions     = [aws_autoscaling_policy.scale_up.arn]\n}\n\n#\n# Scale Down Policy and Alarm\n#\nresource \"aws_autoscaling_policy\" \"scale_down\" {\n  name                   = \"ddt_asg_scale_down-${terraform.workspace}\"\n  scaling_adjustment     = -1\n  adjustment_type        = \"ChangeInCapacity\"\n  cooldown               = 600\n  autoscaling_group_name = aws_autoscaling_group.webapp_asg.name\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"scale_down_alarm\" {\n  alarm_name                = \"ddt-low-asg-cpu-${terraform.workspace}\"\n  comparison_operator       = \"LessThanThreshold\"\n  evaluation_periods        = \"5\"\n  metric_name               = \"CPUUtilization\"\n  namespace                 = \"AWS/EC2\"\n  period                    = \"120\"\n  statistic                 = \"Average\"\n  threshold                 = \"30\"\n  insufficient_data_actions = []\n\n  dimensions = {\n    AutoScalingGroupName = aws_autoscaling_group.webapp_asg.name\n  }\n\n  alarm_description = \"EC2 CPU Utilization\"\n  alarm_actions     = [aws_autoscaling_policy.scale_down.arn]\n}\n\n## Database Config \n\nresource \"aws_db_subnet_group\" \"db_subnet_group\" {\n  name       = \"${terraform.workspace}-ddt-rds-subnet-group\"\n  subnet_ids = data.terraform_remote_state.networking.outputs.private_subnets\n}\n\nresource \"aws_db_instance\" \"rds\" {\n  identifier             = \"${terraform.workspace}-ddt-rds\"\n  allocated_storage      = local.rds_storage_size\n  engine                 = local.rds_engine\n  engine_version         = local.rds_version\n  instance_class         = local.rds_instance_size\n  multi_az               = local.rds_multi_az\n  name                   = \"${terraform.workspace}${local.rds_db_name}\"\n  username               = var.rds_username\n  password               = var.rds_password\n  db_subnet_group_name   = aws_db_subnet_group.db_subnet_group.id\n  vpc_security_group_ids = [aws_security_group.rds_sg.id]\n  skip_final_snapshot    = true\n\n  tags = local.common_tags\n}\n</code></pre> <p><code>security_groups.tf</code></p> <pre><code>##################################################################################\n# RESOURCES\n##################################################################################\n\nresource \"aws_security_group\" \"webapp_http_inbound_sg\" {\n  name        = \"demo_webapp_http_inbound\"\n  description = \"Allow HTTP from Anywhere\"\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  vpc_id = data.terraform_remote_state.networking.outputs.vpc_id\n\n  tags = {\n    Name = \"terraform_demo_webapp_http_inbound\"\n  }\n}\n\nresource \"aws_security_group\" \"webapp_ssh_inbound_sg\" {\n  name        = \"demo_webapp_ssh_inbound\"\n  description = \"Allow SSH from certain ranges\"\n\n  ingress {\n    from_port   = 22\n    to_port     = 22\n    protocol    = \"tcp\"\n    cidr_blocks = [var.ip_range]\n  }\n\n  vpc_id = data.terraform_remote_state.networking.outputs.vpc_id\n\n  tags = merge(local.common_tags, {\n    Name = \"terraform_demo_webapp_ssh_inbound\"\n  })\n}\n\nresource \"aws_security_group\" \"webapp_outbound_sg\" {\n  name        = \"demo_webapp_outbound\"\n  description = \"Allow outbound connections\"\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  vpc_id = data.terraform_remote_state.networking.outputs.vpc_id\n\n  tags = merge(local.common_tags, {\n    Name = \"terraform_demo_webapp_outbound\"\n  })\n}\n\nresource \"aws_security_group\" \"rds_sg\" {\n  name        = \"demo_rds_inbound\"\n  description = \"Allow inbound from web tier\"\n  vpc_id      = data.terraform_remote_state.networking.outputs.vpc_id\n\n  tags = {\n    Name = \"demo_rds_inbound\"\n  }\n\n  // allows traffic from the SG itself\n  ingress {\n    from_port = 0\n    to_port   = 0\n    protocol  = \"-1\"\n    self      = true\n  }\n\n  // allow traffic for TCP 3306\n  ingress {\n    from_port       = 3306\n    to_port         = 3306\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.webapp_http_inbound_sg.id]\n  }\n\n  // outbound internet access\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n</code></pre>"},{"location":"chap5/11tf_adv_exam/","title":"Terraform Exam(Backend/Command/Script/Others)","text":""},{"location":"chap5/11tf_adv_exam/#remote-backend","title":"Remote Backend","text":"<p>1.You are working on your Terraform infrastructure with the <code>google-beta</code> provider and are trying to store the remote state backend in Google Cloud Storage(GCS). What argument would you use to properly configure the backend?</p> <p><code>data \"terraform_remote_state\" \"foo\" { }</code></p> <p><code>data \"terraform_remote_state\"</code></p> <p>2.You are going through the Terraform state locking process to prevent others from acquiring your lock and potentially corrupting state. However, Terraform is not continuing due to automatic state locking failing. How could you fix this issue?</p> <p>Manually unlock the state with the <code>force-unlock</code> command</p> <p>3.What stores a state as a given key in a given bucket on Amazon S3 and provides support for state locking and consistency checking via DynamoDB?</p> <p>The S3 backend</p> <p>4.You are trying to use the terraform validate command and you need an initialized working directory with any referenced plugins and modules installed. What command could you use to initialize a working directory for validation without accessing any configured remote backend?</p> <p><code>terraform init -backend=false</code></p> <p>5.What is the difference between a remote backend and a local backend?</p> <p>Local backends store files in a local JSON file on disk, while remote backends allow you to store the state file in a remote, shared store</p> <p>Local backends: store files in a local JSON file on disk</p> <p>Remote backends allow you to store the state file in a remote, shared store</p> <p>6.Which mechanism retrieves state data from a remote data store?</p> <p><code>terraform_remote_state</code></p> <p>7.You are trying to collaborate with remote state to improve the quality of your team's workflow. You have configured an S3 bucket policy and would like to enable remote state. What script could you use as a template to accomplish this?</p> <pre><code>terraform {\n    backend \"s3\" {\n        encrypt = true\n        bucket  =  \"terraform-remote-state-storage\"\n        region  = \"us-east-1\"\n        key     = terraform/state\n        dynamo_table = \"terraform-state-lock\"\n    }\n}\n</code></pre> <p>7.What is the purpose of running Terraform through the Google Cloud Platform Cloud Shell?</p> <p>To enable the usage of tools from both Terraform and it's GCP provider resources, as well as maintaining optimal use of GCP services and features.</p> <p>8.What is remote state a feature of?</p> <p>Backends</p> <p>9.What service stores a state as an object in a configurable prefix in a given bucket on Google Cloud Storage, and supports state locking?</p> <p>The GCS backend</p>"},{"location":"chap5/11tf_adv_exam/#terraform-command","title":"Terraform command","text":"<p>1.You are using Terraform and want to create a new workspace from a pre-existing local state file. What script could you use as a template to accomplish this?</p> <p><code>-state=old.terraform.tfstate example</code></p> <pre><code>terraform workspace new -state=old.terraform.tfstate example\n</code></pre> <p>2.What is the function of the terraform console command?</p> <ul> <li>command provides an interactive console for evaluating expressions.</li> <li>It allows you to experiment with the behavior of Terraform built-in functions.</li> </ul> <p>3.When using the <code>terraform refresh</code> command, what is the purpose of the <code>-var \"foo=bar\"</code> flag?</p> <p>Setting a variable in the Terraform configuration</p> <p>4.You are trying to taint resources in your deployment with the <code>terraform taint</code> command. The command is occasionally not succeeding due to some of your resources being missing. How can you prevent this failure?</p> <p>Specify the <code>-allow-missing</code> command-line flag</p> <p>5.You write a new Terraform configuration and are using the <code>terraform init</code> command. You are having issues because Terraform is searching for default plugin locations, but you want it to only search for a specified path. What can you do to fix this issue?</p> <pre><code>Run `terraform init` with the `-plugin-dir=&lt;PATH&gt;`\noption and a non-empty&lt;PATH&gt;/\n</code></pre> <p>6.You are initializing a Terraform configuration with the <code>init</code> command and you need a given module to be copied into a target directory before any other initialization steps are run. What option could you use to accomplish this?</p> <pre><code>from-module=MODULE-SOURCE\n</code></pre> <p>7.What command accepts all the arguments and flags that the apply command accepts, with the exception of a plan file argument?</p> <p>The <code>terraform destroy</code> command</p> <p>8.Company A suffered a major security breach after saved plan files containing hundreds of variables with secrets were easily accessed. In hindsight, what Terraform fact, if known, could have helped prevent this issue from occurring?</p> <p>For plan files that are saved with the <code>-out</code> flag, Terraform itself does not encrypt the plan file</p> <p>9.You are importing an AWS security group which imports an <code>aws_security_group</code> and a <code>aws_security_group</code> rule for each rule. However, you run into an issue as Terraform planned to destroy some of your imported objects in the next run. What can you do to prevent the objects being destroyed?</p> <p>Consult the import output and create a resource block in your configuration for each secondary resource</p>"},{"location":"chap5/11tf_adv_exam/#terraform-script","title":"Terraform script","text":"<p>1.You are utilizing source control to enable code storage in your Terraform infrastructure with the Azure Provider, and are configuring a Source Control token. You run the command resource</p> <pre><code>\"azure_app_service_control_source_token\" \"example\" {type =\"GitHub\" token =\"7e57735e77e577e57\"}\n</code></pre> <p>but encounter an invalid command prompt. What is the correct command to run?</p> <p>Answer</p> <pre><code>resource \"azurerm app_service_source_control_token\"  \"example\" {type=\"GitHub\" token=\"7e57735677e577e57\"}\n</code></pre> <p>2.You are trying to successfully specify required provider versions. You want to specify a version that is greater than the version number \"2.7.0\" What script could you use as a template to accomplish this?</p> <pre><code>terraform {\n    required_providers {\n        aws = \"&gt;2.7.0\" \n    }\n}\n</code></pre> <p>3.You are using count loops in a Terraform configuration and you want to use count to get the index of each iteration in the loop. What script could you use to accomplish this?</p> <pre><code>resource \"awe_iam_user\" \"example\" {\n   count  = 3\n   name   = \"neo.${count.index}\"\n} \n</code></pre> <p>4.You are going over the process of merging <code>variable</code> blocks. Your original variable block defines a <code>default</code> value and your override block changes the variable's <code>type</code>. After Terraform attempts to convert the default value to the overridden type. you receive an error. Why?</p> <p>The conversion is not possible due to incompatible types.</p> <p>5.You are working on your Terraform infrastructure, and are adding and configuring the Azure Provider. What argument would you use to instantiate the Azure provider?</p> <p><code>provider \"azurerm\" { }</code></p> <p>6.You are declaring an input variable in Terraform, however, after writing the below script you realize that Terraform is not letting you use source as a variable name. Why? </p> <p><code>variable \"source\" { type = string }</code></p> <p>The \"source\" term is reserved for meta-arguments in module configuration blocks</p> <p>7.You are dealing with outputs in Terraform and require creating additional explicit dependencies. What argument would accomplish your goal?</p> <p><code>depends_on</code></p> <p>8.You are utilizing source control to enable code storage in your Terraform infrastructure with the Azure Provider, and are configuring a Source Control token. You run the command </p> <pre><code>resource \"azure_app_service_control_source_token\" \"example\" { type = \"GitHub\" token =\n\"7e57735e77e577e57\"\n</code></pre> <p>but encounter an invalid command prompt. What is the correct command to run?</p> <pre><code>resource \"azure_app_service_control_source_token\" \"example\" { type=\"GitHub\" token= \"7e57735e77e577e57\" }\n</code></pre> <p>9.You are using the file provisioner and want to copy the string in content into <code>/tmp/file.log</code>, What script could you use to accomplish this?</p> <pre><code>provisioner \"file\" {\n    ...\n    destination = \"/tmo/file.log\"\n}\n</code></pre> <p>10.You are new to using Hashicorp Configuration Language and want to include multi-line strings. What can you do to accomplish this?</p> <p>Use an opening &lt;&lt;EOF, followed by a closing EOF on its own line.</p> <p>11.What happens when you call a child module from your Terraform script?</p> <p>The contents of that module are included in the configuration with specific values for its input variables</p>"},{"location":"chap5/11tf_adv_exam/#data-resource","title":"Data Resource","text":"<p>1.You are pulling information about an existing virtual network using the azurerm virtual network data source in Terraform with the Azure Provider. What command would you run to utilize the data source?</p> <pre><code>data \"azurerm_virtual_network\" \"example\"\n{\n    name = \"production\"\n    resource_group_name = \"networking\"\n}\n\n</code></pre> <p>2.You are using the <code>template_file</code> data source to read a file at a given path and have its contents rendered as a template using a supplied set of template variables. In the past, you've had problems with the syntax of this command. What script example could you use as a template to help prevent this from occurring again?</p> <pre><code>data \"template_file\" \"init\" {\n    template = \"${file(\"${path.module}/init.tpl\")}\"\n    vars = {\n        consul_address = \"${aws_instance.consul.private_ip}\"\n    }\n}\n</code></pre> <p><code>$</code>sign is pretty important</p> <p>4.You are pulling information about an existing virtual network using the <code>azurerm_virtual_network</code> data source in Terraform with the Azure Provid What command would you run to utilize the data source?</p> <pre><code>data \"azurerm_virtual_network\" \"example\"\n{\n    name = \"production\"\n    resource_group_name = \"networking\"\n}\n</code></pre> <p>5.Using the AzureRM Provider, which blocks of code creates a Resource Group in the West Europe region?</p> <pre><code>provider \"azurerm\"\n    version = \"=2.20.0\"\n  features {}\n}\n\nresource \"azurerm_resource_group\" \"example\"{\n\n    name = \"example-resources\"\n    location = \"West Europe\"\n}\n</code></pre> <p>6.You are trying to create multiple instances of the google-beta provider within your Terraform infrastructure, and pass the command</p> <pre><code>provider \"google-beta\" {credentials = \"{file (\"account.jsile\")}\" project = \"my-project-id\" region = \"us-centrall\"} \n</code></pre> <p>To enable the additional provider google-beta, but you are encountering an issue where your instance is receiving invalid credentials. What command should you run to correctly initialize the google beta provider?</p> <pre><code>provider \"google-beta\" {credentials = \"(file(\"account.json\")}\" project= \"my-project-id\" region=\"us-centrall\"}\n</code></pre> <p>7.Which Terraform functionality gives you the ability to connect to the Azure Provider and enable access to information through the source?</p> <p><code>Data Source</code></p> <p>8.What does the coalesce function do?</p> <p>Takes any number of arguments and returns the first one that is not null or an empty string</p> <p>9.What is the purpose of utilizing multiple instances of the AWS provider?</p> <p>To support multiple regions for a cloud platform, as well as multiple Docker hosts, Consul hosts, and to select which one to use on a per-resource basis</p> <p>10.Which mechanism retrieves state data from a remote data store?</p> <p><code>terraform_remote_state</code></p> <p>11.To write data that reads from the <code>\"aws_ami\"</code> data source and exports to \"example.\" which script template could you use?</p> <pre><code>data \"aws_ami\" \"example\" {\n        most_recent = true\n        Owners      = [\"self\"]\n        tags        = {\n            Name   = \"app-server\"\n          Tested =  \"true\"\n        }\n}\n</code></pre>"},{"location":"chap5/11tf_adv_exam/#others","title":"Others","text":"<p>1.You are importing an AWS security group which imports an <code>aws_security_group</code> and a <code>as_security_group_rule</code> for each rule. However you run into an issue as Terraform planned to destroy some of your imported objects in the next run. What can you do to prevent the objects being destroyed?</p> <p>Consult the import output and create a resource block in your configuration for each secondary resource</p> <p>2.Which provisioner would you use to copy files or directories from the host machine to newly created resources?</p> <p>The File provisioner</p> <p>3.You are working on your Terraform infrastructure and are trying to debug your code. You want to make the most verbose logs appear so you efficiently debug your configuration. How can you accomplish this?</p> <p>Set the <code>TF_LOG</code> environment variable to a positive value and set the level to TRACE verbosity</p> <p>4.You are working on your Terraform infrastructure and are adding and configuring the <code>google-beta</code> provider. What argument would you use to instantiate the google-beta provider?</p> <p><code>provider \"google-beta\"</code></p> <p>5.You declare the following variables:</p> <pre><code>variable \"red\" {}\nvariable \"blue\" { default=\"false\"}\n</code></pre> <p>red is mandatory and blue is assigned with the default value false. How can you override the \"blue\" value?</p> <p>Set the \"blue\" variable to a new value <code>export TF_VAR_bar=newvalue</code> and then run terraform in that session</p> <p>6.You are using the <code>terraform plan</code> command and need to save your generated plan to a file for later execution. What argument would best suit your needs?</p> <p><code>-out</code></p> <p>7.You are pulling information for your Terraform infrastructure while utilizing the AWS provider. You want to use the aws instance data source to get the ID of an Amazon EC2 instance, but are encountering an issue where you have the incorrect instance ID. What can you do to fix this issue?</p> <p>Ensure you have configured the data source with the proper instance ID using the argument <code>instance_id = \"instanceid\"</code></p> <p>8.What are some of the methods of authenticating Azure Terraform?</p> <p>Service Principal and Client Certificate</p> <p>9.If you needed to deploy AWS resources using Terraform, where would you find an appropriate provider for the task?</p> <p><code>Terraform Registry</code></p> <p>10.You need to override a portion of an existing configuration object in a separate file. What can you end your configuration files in to achieve this?</p> <p><code>_override.tf</code> or <code>_override.tf.json</code></p> <p>11.Your team is going through the configuring provisioner connection settings process and wants to provide multiple connections to have an initial provisioner connect as the root user to set up user accounts, but does not know how to copy the file as the root user using SSH. What script could you use as a template to fix this problem?</p> <p>``` provisioner \"file\" {             source  =  \"conf/myapp.conf\"     destination =   \"/etc/myapp.conf\"</p> <pre><code>connection  {\n        type   =  \"ssh\"\n        user   =  \"root\"\n        password = \"${var.root_password}\"\n        host     = \"${var.host}\"\n</code></pre> <p>} }</p> <p>12.What is terraform distributed as?</p> <p><code>A single binary</code></p>"},{"location":"chap5/12terraform_jenkins/","title":"12 Adding Terraform to a CI/CD Pipeline","text":""},{"location":"chap5/12terraform_jenkins/#1-cicd-pipelines","title":"1 CI/CD Pipelines","text":"<p>Multiple platforms</p> <ul> <li>Jenkins, CodePipeline, Bamboo</li> </ul> <p>Continuous Integration for code check-in</p> <p>Continuous Delivery of builds</p> <p>Automated testing and validation</p> <p>Multiple environments</p> <ul> <li>Development, UAT, QA, Production</li> </ul> <p></p>"},{"location":"chap5/12terraform_jenkins/#jenkins-pipeline","title":"Jenkins pipeline","text":""},{"location":"chap5/12terraform_jenkins/#2-jenkins-setup","title":"2 Jenkins Setup","text":"<ul> <li>Install Jenkins as a traditional app</li> <li>Deploy Jenkins in a container</li> <li>Deploy Jenkins in the cloud</li> </ul>"},{"location":"chap5/12terraform_jenkins/#2-1-start-consul","title":"2-1 Start Consul","text":"<p>Make sure consul is still running, if not open a separate terminal</p> <p><code>config/consul-config.hcl</code></p> <pre><code>## server.hcl\n\nui = true\nserver = true\nbootstrap_expect = 1\ndatacenter = \"dc1\"\ndata_dir = \"./data\"\n\nacl = {\n    enabled = true\n    default_policy = \"deny\"\n    enable_token_persistence = true\n}\n</code></pre> <pre><code>consul agent -bootstrap -config-file=\"config/consul-config.hcl\" -bind=\"127.0.0.1\"\n</code></pre> <pre><code># We are going to create two tokens for Jenkins to use net and app\n# First use the root token\n\n# Linux and MacOS\nexport CONSUL_HTTP_TOKEN=SECRETID_VALUE\n\n# Windows\n$env:CONSUL_HTTP_TOKEN=\"SECRETID_VALUE\"\n</code></pre> <pre><code># Create two tokens (networking and applications)\nconsul acl token create -policy-name=networking -description=\"Jenkins networking\"\nconsul acl token create -policy-name=applications -description=\"Jenkins applications\"\n</code></pre>"},{"location":"chap5/12terraform_jenkins/#create-a-jenkins-container","title":"Create a Jenkins container","text":"<pre><code>docker pull jenkins/jenkins:lts\ndocker run -p 8080:8080 -p 50000:50000 -d -v jenkins_home:/var/jenkins_home --name jenkins jenkins/jenkins:lts\ndocker logs jenkins\n</code></pre> <pre><code># Install suggested plugins\n# Create a user\n# Manage jenkins\n# Manage plugins\n# Search for Terraform in Available and install without restart\n</code></pre> <pre><code># Back to Manage jenkins\n# Global Tool Configuration\n# Add Terraform\n</code></pre> <pre><code># Add Terraform\n# Name: terraform \n# Install automatically\n# Version - latest for linux (amd64)\n# Click Save\n</code></pre> <p>Add consul and terraform(aws) secret into Jenkins</p> <ul> <li>Go to credentials -&gt; global</li> <li>Create a credential of type secret text with ID <code>networking_consul_token</code> and the consul token as the secret</li> <li>Create a credential of type secret text with ID <code>applications_consul_token</code> and the consul token as the secret</li> <li>Create a credential of type secret text with ID <code>aws_access_key</code> and the access key as the secret</li> <li>Create a credential of type secret text with ID <code>aws_secret_access_key</code> and the access secret as the secret</li> </ul> <p></p> <p></p> <p></p> <p>Automation Environment Variables</p> <ul> <li><code>TF_IN_AUTOMATION = TRUE</code><ul> <li><code>TF_IN_AUTOMATION</code> that can help you reduce the amount of output and the chatty-ness of Terraform by letting it know that there's not going to be a human being watching this output. </li> </ul> </li> <li><code>TF_LOG = \"INFO\"</code></li> <li><code>TF_LOG_PATH = \"tf_10g_MMDDYY_hhmmss\"</code></li> <li> <p><code>TF_INPUT = FALSE</code></p> <ul> <li>If that's set to false, Terraform will not prompt the end user for input, meaning if you run terraform destroy and it promots you yes or no, Terraform is not going to do that, it's just going to cancel an error out at that point. So if it encounters any situation where it does need user input, it's actually just going to error out rather than waiting for that user input.</li> </ul> </li> <li> <p><code>TF_VAR_name = \"value\"</code></p> <ul> <li><code>TF_VAR</code> THE name of the variable in the Terraform configuration. Terraform will see that and use that value in the value without adding it to the command line.</li> </ul> </li> <li><code>TF_CLI_ARGS = \"-input=false\"</code></li> </ul> <p>Plug-in source  /  Workspace usage  /  State control  /  Output control  / Deploy pattern</p> <p>And our pattern has mostly been to initialize, plan, and apply.</p>"},{"location":"chap5/12terraform_jenkins/#creating-the-networking-pipeline","title":"Creating the Networking Pipeline","text":"<p><code>Jenkinsfile</code></p> <p>https://github.com/ned1313/Deep-Dive-Terraform/tree/v2/m8/networking</p> <pre><code>pipeline {\n    agent any\n    tools {\n        \"org.jenkinsci.plugins.terraform.TerraformInstallation\" \"terraform\"\n    }\n    parameters {\n        string(name: 'CONSUL_STATE_PATH', defaultValue: 'networking/state/globo-primary', description: 'Path in Consul for state data')\n        string(name: 'WORKSPACE', defaultValue: 'development', description:'workspace to use in Terraform')\n    }\n\n    environment {\n        TF_HOME = tool('terraform')\n        TF_INPUT = \"0\"\n        TF_IN_AUTOMATION = \"TRUE\"\n        TF_VAR_consul_address = \"host.docker.internal\"\n        TF_LOG = \"WARN\"\n        CONSUL_HTTP_TOKEN = credentials('networking_consul_token')\n        AWS_ACCESS_KEY_ID = credentials('aws_access_key')\n        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')\n        PATH = \"$TF_HOME:$PATH\"\n    }\n\n    stages {\n        stage('NetworkInit'){\n            steps {\n                dir('m8/networking/'){\n                    sh 'terraform --version'\n                    sh \"terraform init --backend-config='path=${params.CONSUL_STATE_PATH}'\"\n                }\n            }\n        }\n        stage('NetworkValidate'){\n            steps {\n                dir('m8/networking/'){\n                    sh 'terraform validate'\n                }\n            }\n        }\n        stage('NetworkPlan'){\n            steps {\n                dir('m8/networking/'){\n                    script {\n                        try {\n                           sh \"terraform workspace new ${params.WORKSPACE}\"\n                        } catch (err) {\n                            sh \"terraform workspace select ${params.WORKSPACE}\"\n                        }\n                        sh \"terraform plan -out terraform-networking.tfplan;echo \\$? &gt; status\"\n                        stash name: \"terraform-networking-plan\", includes: \"terraform-networking.tfplan\"\n                    }\n                }\n            }\n        }\n        stage('NetworkApply'){\n            steps {\n                script{\n                    def apply = false\n                    try {\n                        input message: 'confirm apply', ok: 'Apply Config'\n                        apply = true\n                    } catch (err) {\n                        apply = false\n                        dir('m8/networking/'){\n                            sh \"terraform destroy -auto-approve\"\n                        }\n                        currentBuild.result = 'UNSTABLE'\n                    }\n                    if(apply){\n                        dir('m8/networking/'){\n                            unstash \"terraform-networking-plan\"\n                            sh 'terraform apply terraform-networking.tfplan'\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <pre><code># Create a new item\n# Name: net-deploy\n# Type pipeline\n# Select poll SCM\n# Definition: Pipeline script from SCM\n# SCM: Git\n# Repo URL: YOUR_REPO_URL or https://github.com/ned1313/Deep-Dive-Terraform.git\n# Script path: m8/networking/Jenkinsfile\n# Uncheck lightweight checkout\n</code></pre> <p></p> <p>Now we can run a build of the network pipeline</p> <p>First build might fail, but now the parameters will be Available</p> <p>Run a new build WITH parameters</p> <p>When build is successful create a new pipeline for the application stack</p>"},{"location":"chap5/12terraform_jenkins/#creating-the-application-pipeline","title":"Creating the Application Pipeline","text":"<pre><code>pipeline {\n    agent any\n    tools {\n        \"org.jenkinsci.plugins.terraform.TerraformInstallation\" \"terraform\"\n    }\n    parameters {\n        string(name: 'CONSUL_STATE_PATH', defaultValue: 'networking/state/globo-primary', description: 'Path in Consul for state data')\n        string(name: 'WORKSPACE', defaultValue: 'development', description:'workspace to use in Terraform')\n    }\n\n    environment {\n        TF_HOME = tool('terraform')\n        TF_INPUT = \"0\"\n        TF_IN_AUTOMATION = \"TRUE\"\n        TF_VAR_consul_address = \"host.docker.internal\"\n        TF_LOG = \"WARN\"\n        CONSUL_HTTP_TOKEN = credentials('networking_consul_token')\n        AWS_ACCESS_KEY_ID = credentials('aws_access_key')\n        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')\n        PATH = \"$TF_HOME:$PATH\"\n    }\n\n    stages {\n        stage('NetworkInit'){\n            steps {\n                dir('m8/networking/'){\n                    sh 'terraform --version'\n                    sh \"terraform init --backend-config='path=${params.CONSUL_STATE_PATH}'\"\n                }\n            }\n        }\n        stage('NetworkValidate'){\n            steps {\n                dir('m8/networking/'){\n                    sh 'terraform validate'\n                }\n            }\n        }\n        stage('NetworkPlan'){\n            steps {\n                dir('m8/networking/'){\n                    script {\n                        try {\n                           sh \"terraform workspace new ${params.WORKSPACE}\"\n                        } catch (err) {\n                            sh \"terraform workspace select ${params.WORKSPACE}\"\n                        }\n                        sh \"terraform plan -out terraform-networking.tfplan;echo \\$? &gt; status\"\n                        stash name: \"terraform-networking-plan\", includes: \"terraform-networking.tfplan\"\n                    }\n                }\n            }\n        }\n        stage('NetworkApply'){\n            steps {\n                script{\n                    def apply = false\n                    try {\n                        input message: 'confirm apply', ok: 'Apply Config'\n                        apply = true\n                    } catch (err) {\n                        apply = false\n                        dir('m8/networking/'){\n                            sh \"terraform destroy -auto-approve\"\n                        }\n                        currentBuild.result = 'UNSTABLE'\n                    }\n                    if(apply){\n                        dir('m8/networking/'){\n                            unstash \"terraform-networking-plan\"\n                            sh 'terraform apply terraform-networking.tfplan'\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <pre><code># Create a new item\n# Name: app-deploy\n# Type pipeline\n# Select poll SCM\n# Definition: Pipeline script from SCM\n# SCM: Git\n# Repo URL: YOUR_REPO_URL or https://github.com/ned1313/Deep-Dive-Terraform.git\n# Script path: m8/applications/Jenkinsfile\n# Uncheck lightweight checkout\n</code></pre> <p>First build might fail, but now the parameters will be Available</p> <p></p>"},{"location":"chap5/13terraform_cmt/","title":"Terraform Integrating with Configuration Managers(Anisble)","text":""},{"location":"chap5/13terraform_cmt/#configuration-management","title":"Configuration Management","text":"<ul> <li>Identification  What to manage</li> <li>Control  How to manage</li> <li>Accounting How to report</li> <li>Verification  How to validate</li> </ul> <p>How do you push configuration or do you pull the configuration?</p>"},{"location":"chap5/13terraform_cmt/#push-the-configuration","title":"Push the configuration","text":"<p>means there's some sort of centralized server that has the desired configuration and an inventory of nodes to apply that configuration to and it goes out and pushes against each node.</p> <p>Ansible is a good example of that deployment methodology. When you run Ansible, you run it on a local box, you give it a list of remote hosts, and a configuration you want applied to those hosts, and it uses something like SSH or WinRM to push that config to each node</p>"},{"location":"chap5/13terraform_cmt/#pull-configuration","title":"Pull configuration","text":"<p>In a pull configuration, you have a centralized repository that has configurations in it, but each individual node is responsible for pulling that configuration down and applying it locally. Often that's done through some sort of agent. </p> <p>Puppet has an agent that you install on each node and then you set that agent to run on specific intervals to pull the current configuration from a Puppet Server.</p>"},{"location":"chap5/13terraform_cmt/#deployment-options","title":"Deployment Options","text":"<ul> <li>Terraform hand-off</li> <li>Push or pull</li> <li>Centralized or distributed</li> </ul> <p>So a centralized model would mean that there is a centralized inventory and configuration server that holds all that information, and often that works in tandem with some sort of push configuration, </p> <p>configuration management deployment</p> <p>The configuration could be stored in some sort of shared repository, but it's a distributed repository and there's no centralized server that is forcing configuration to happen on a certain cadence.</p> <p>In the case of a distributed configuration, that scales much easier because you don't have to rely on but you are giving up some of the control of that centralized server when it comes to things like auditing and logging.</p> <p></p> <p>https://github.com/ned1313/Deep-Dive-Terraform/tree/v2/m9</p> <pre><code>consul agent -bootstrap -config-file=\"config/consul-config.hcl\" -bind=\"127.0.0.1\"\n\n## If you don't already have the development networking environment deployed\n## let's do that know\n\n# Let's set the Consul token to Mary Moe\n# Replace SECRETID_VALUE with Mary Moe's secret ID\n# Linux and MacOS\nexport CONSUL_HTTP_TOKEN=SECRETID_VALUE\n\n# Windows\n$env:CONSUL_HTTP_TOKEN=\"SECRETID_VALUE\"\n\n# Initialize the backend\nterraform init -backend-config=\"path=networking/state/globo-primary\"\n\n# Select the workspace\nterraform workspace select development\n\n# Create and apply the configuration\nterraform plan -out dev.tfplan\n\nterraform apply \"dev.tfplan\"\n</code></pre>"},{"location":"chap5/13terraform_cmt/#applicationserver-with-ansible","title":"Application(server with ansible)","text":"<p><code>applications/datasources.tf</code></p> <pre><code>##################################################################################\n# DATA SOURCES\n##################################################################################\n\ndata \"template_file\" \"userdata\" {\n  template = file(\"templates/userdata.sh\")\n\n  vars = {\n    wp_db_hostname      = aws_db_instance.rds.endpoint\n    wp_db_name          = \"${terraform.workspace}${local.rds_db_name}\"\n    wp_db_user          = var.rds_username\n    wp_db_password      = var.rds_password\n    playbook_repository = var.playbook_repository\n  }\n}\n\ndata \"consul_keys\" \"applications\" {\n  key {\n    name = \"applications\"\n    path = terraform.workspace == \"default\" ? \"applications/configuration/globo-primary/app_info\" : \"applications/configuration/globo-primary/${terraform.workspace}/app_info\"\n  }\n\n  key {\n    name = \"common_tags\"\n    path = \"applications/configuration/globo-primary/common_tags\"\n  }\n}\n\ndata \"terraform_remote_state\" \"networking\" {\n  backend = \"consul\"\n\n  config = {\n    address = \"${var.consul_address}:8500\"\n    scheme  = \"http\"\n    path    = terraform.workspace == \"default\" ? \"networking/state/globo-primary\" : \"networking/state/globo-primary-env:${terraform.workspace}\"\n  }\n}\n\ndata \"aws_ami\" \"ubuntu\" {\n  most_recent = true\n  owners      = [\"099720109477\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server*\"]\n  }\n\n  filter {\n    name   = \"architecture\"\n    values = [\"x86_64\"]\n  }\n\n  filter {\n    name   = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n\n  filter {\n    name   = \"root-device-type\"\n    values = [\"ebs\"]\n  }\n}\n</code></pre> <p><code>template = file(\"templates/userdata.sh\")</code></p> <p><code>applications/templates/userdata.sh</code></p> <pre><code>#!/bin/bash\n# Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file\n# except in compliance with the License. A copy of the License is located at\n#\n#     http://aws.amazon.com/apache2.0/\n#\n# or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\"\n# BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n# License for the specific language governing permissions and limitations under the License.\napt-get update\napt-get install git ansible -y\nmkdir /var/ansible_playbooks\ngit clone ${playbook_repository} /var/ansible_playbooks\nansible-playbook /var/ansible_playbooks/playbook.yml -i /var/ansible_playbooks/hosts --extra-vars \"wp_db_hostname=${wp_db_hostname} wp_db_name=${wp_db_name} wp_db_user=${wp_db_user} wp_db_password=${wp_db_password}\"\n</code></pre> <p><code>git clone ${playbook_repository} /var/ansible_playbooks ansible-playbook /var/ansible_playbooks/playbook.yml</code></p> <p>https://github.com/ned1313/ansible-playbook-wordpress-nginx</p> <pre><code>$ tree ansible-playbook-wordpress-nginx\nansible-playbook-wordpress-nginx\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 group_vars\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 all\n\u251c\u2500\u2500 hosts\n\u251c\u2500\u2500 installansible.sh\n\u251c\u2500\u2500 playbook.retry\n\u251c\u2500\u2500 playbook.yml\n\u2514\u2500\u2500 roles\n    \u251c\u2500\u2500 nginx\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 handlers\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 tasks\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 templates\n    \u2502\u00a0\u00a0     \u251c\u2500\u2500 default-site.conf\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 nginx-wp-common.conf\n    \u251c\u2500\u2500 php\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 handlers\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 tasks\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 main.yml\n    \u251c\u2500\u2500 postfix\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 handlers\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 tasks\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 main.yml\n    \u2514\u2500\u2500 wordpress\n        \u251c\u2500\u2500 README.md\n        \u251c\u2500\u2500 handlers\n        \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n        \u251c\u2500\u2500 tasks\n        \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.yml\n        \u2514\u2500\u2500 templates\n            \u2514\u2500\u2500 wp-config.php\n</code></pre> <p><code>playbook.yml</code></p> <pre><code>- hosts: webservers\n\n  roles:\n    - nginx\n    - wordpress\n    - php\n    - postfix\n</code></pre> <p><code>hosts</code></p> <pre><code>[webservers]\nlocalhost ansible_connection=local\n</code></pre> <pre><code>cd ../applications\n\n# Initialize the backend\nterraform init -backend-config=\"path=applications/state/globo-primary\"\n\n# Select the workspace\nterraform workspace select development\n\n# Create and apply the configuration\nterraform plan -out dev.tfplan\n\nterraform apply \"dev.tfplan\"\n</code></pre>"},{"location":"chap5/1hashicorp_certified_terraform/","title":"HashiCorp Certified Terraform Associate Learning Path","text":"<p>HashiCorp Certified Terraform Associate Learning Path</p>"},{"location":"chap5/1hashicorp_certified_terraform/#hashicorp-certified-terraform-associate-exam-summary","title":"HashiCorp Certified Terraform Associate Exam Summary","text":"<ul> <li>HashiCorp Certified Terraform Associate exam focuses on Terraform as a Infrastructure as a Code tool</li> <li>HashiCorp Certified Terraform Associate exam has 57 questions with a time limit of 60 minutes</li> <li>Exam has a multi answer, multiple choice, fill in the blanks and True/False type of questions</li> <li>Questions and answer options are pretty short and if you have experience on Terraform they are pretty easy and the time if more than sufficient.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#hashicorp-certified-terraform-associate-exam-topic-summary","title":"HashiCorp Certified Terraform Associate Exam Topic Summary","text":"<p>Refer Terraform Cheat Sheet for details</p>"},{"location":"chap5/1hashicorp_certified_terraform/#3understand-infrastructure-as-code-iac-concepts","title":"3\u3001Understand Infrastructure as Code (IaC) concepts","text":""},{"location":"chap5/1hashicorp_certified_terraform/#3-1-explain-what-iac-is","title":"3-1 Explain what IaC is","text":"<ul> <li>Infrastructure is described using a high-level configuration syntax</li> <li>IaC allows Infrastructure to be versioned and treated as you would any other code.</li> <li>Infrastructure can be shared and re-used.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#3-2-describe-advantages-of-iac-patterns","title":"3-2 Describe advantages of IaC patterns","text":"<ul> <li>makes Infrastructure more reliable</li> <li>makes Infrastructure more manageable</li> <li>makes Infrastructure more automated and less error prone</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#4-understand-terraforms-purpose-vs-other-iac","title":"4 Understand Terraform\u2019s purpose (vs other IaC)","text":""},{"location":"chap5/1hashicorp_certified_terraform/#4-1-explain-multi-cloud-and-provider-agnostic-benefits","title":"4-1 Explain multi-cloud and provider-agnostic benefits","text":"<ul> <li>using multi-cloud setup increases fault tolerance and reduces dependency on a single Cloud</li> <li>Terraform provides a cloud-agnostic framework and allows a single configuration to be used to manage multiple providers, and to even handle cross-cloud dependencies.</li> <li>Terraform simplifies management and orchestration, helping operators build large-scale multi-cloud infrastructures.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#4-2-explain-the-benefits-of-state","title":"4-2 Explain the benefits of state","text":"<ul> <li>State is a necessary requirement for Terraform to function.</li> <li>Terraform requires some sort of database to map Terraform config to the real world.</li> <li>Terraform uses its own state structure for mapping configuration to resources in the real world</li> <li>Terraform state helps<ul> <li>track metadata such as resource dependencies.</li> <li>provides performance as it stores a cache of the attribute values for all resources in the state</li> <li>aids syncing when using in team with multiple users</li> </ul> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#5-understand-terraform-basics","title":"5\u3001 Understand Terraform basics","text":""},{"location":"chap5/1hashicorp_certified_terraform/#5-1-handle-terraform-and-provider-installation-and-versioning","title":"5-1 Handle Terraform and provider installation and versioning","text":"<ul> <li>Providers provide abstraction above the upstream API and is responsible for understanding API interactions and exposing resources.</li> <li>Terraform configurations must declare which providers they require, so that Terraform can install and use them</li> <li>Provider requirements are declared in a <code>required_providers</code> block.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#5-2-describe-plugin-based-architecture","title":"5-2 Describe plugin based architecture","text":"<ul> <li>Terraform relies on plugins called \u201cproviders\u201d to interact with remote systems.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#5-3-demonstrate-using-multiple-providers","title":"5-3 Demonstrate using multiple providers","text":"<ul> <li>supports multiple provider instances using alias for e.g. multiple aws provides with different region</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#5-4-describe-how-terraform-finds-and-fetches-providers","title":"5-4 Describe how Terraform finds and fetches providers","text":"<ul> <li> <p>Terraform finds and installs providers when initializing a working directory. It can automatically download providers from a Terraform registry, or load them from a local mirror or cache.</p> </li> <li> <p>Each Terraform module must declare which providers it requires, so that Terraform can install and use them.</p> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#5-5-explain-when-to-use-and-not-use-provisioners-and-when-to-use-local-exec-or-remote-exec","title":"5-5 Explain when to use and not use provisioners and when to use local-exec or remote-exec","text":"<ul> <li>Terraform provides local-exec and remote-exec to execute tasks not provided by Terraform<ul> <li>local exec executes code on the machine running terraform</li> <li>remote exec executes on the resource provisioned and supports ssh and winrm</li> </ul> </li> <li>Provisioners should only be used as a last resort.</li> <li>are defined within the resource block.</li> <li>support types \u2013 Create and Destroy<ul> <li>if creation time fails, resource is tainted if provisioning failed, by default. (next apply it will be re-created)</li> <li>behavior can be overridden by setting the <code>on_failure</code> to <code>continue</code>, which means ignore and continue</li> <li>for destroy, if it fails \u2013 resources are not removed</li> </ul> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#6-use-the-terraform-cli-outside-of-core-workflow","title":"6 Use the Terraform CLI (outside of core workflow)","text":"<p>Given a scenario: choose when to use terraform fmt to format code</p> <p>terraform fmt helps format code to lint into a standard format. It usually aligns the spaces and matches the =</p> <p>Given a scenario: choose when to use terraform taint to taint Terraform resources</p> <ul> <li>terraform taint marks a Terraform-managed resource as tainted, forcing it to be destroyed and recreated on the next apply.</li> <li>will not modify infrastructure, but does modify the state file in order to mark a resource as tainted.</li> <li>Infrastructure and state are changed in next apply.</li> <li>can be used to taint a resource within a module</li> </ul> <p>Given a scenario: choose when to use terraform import to import existing infrastructure into your Terraform state</p> <ul> <li>terraform import helps import already-existing external resources, not managed by Terraform, into Terraform state and allow it to manage those resources</li> <li>Terraform is not able to auto-generate configurations for those imported modules, for now, and requires you to first write the resource definition in Terraform and then import this resource</li> </ul> <p>Given a scenario: choose when to use <code>terraform workspace</code> to create workspaces</p> <ul> <li>Terraform workspace helps manage multiple distinct sets of infrastructure resources or environments with the same code.</li> <li>state files for each workspace are stored in the directory <code>terraform.tfstate.d</code></li> <li><code>terraform workspace new dev</code> creates a new workspace with name dev and switches to it as well does not provide strong separation as it uses the same backend</li> </ul> <p>Given a scenario: choose when to use terraform state to view Terraform state</p> <ul> <li>state helps keep track of the infrastructure Terraform manages</li> <li>stored locally in the <code>terraform.tfstate</code></li> <li>recommended not to edit the state manually</li> <li>Use terraform state command<ul> <li>mv \u2013 to move/rename modules</li> <li>rm \u2013 to safely remove resource from the state. (destroy/retain like)</li> <li>pull \u2013 to observe current remote state</li> <li>list &amp; show \u2013 to write/debug modules</li> </ul> </li> </ul> <p>Given a scenario: choose when to enable verbose logging and what the outcome/value is</p> <ul> <li>debugging can be controlled using <code>TF_LOG</code>, which can be configured for different levels TRACE, DEBUG, INFO, WARN or ERROR, with TRACE being the more verbose.</li> <li>logs path can be controlled <code>TF_LOG_PATH</code>.  <code>TF_LOG</code> needs to be specified.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#7interact-with-terraform-modules","title":"7\u3001Interact with Terraform modules","text":""},{"location":"chap5/1hashicorp_certified_terraform/#7-1-contrast-module-source-options","title":"7-1 Contrast module source options","text":"<p>Terraform Module Registry allows you to browse, filter and search for modules</p>"},{"location":"chap5/1hashicorp_certified_terraform/#7-2-interact-with-module-inputs-and-outputs","title":"7-2 Interact with module inputs and outputs","text":"<ul> <li>Input variables serve as parameters for a Terraform module, allowing aspects of the module to be customized without altering the module\u2019s own source code, and allowing modules to be shared between different configurations.</li> <li>Resources defined in a module are encapsulated, so the calling module cannot access their attributes directly.</li> <li>Child module can declare output values to selectively export certain values to be accessed by the calling module <code>module.module_name.output_value</code></li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#7-3-describe-variable-scope-within-moduleschild-modulesf","title":"7-3 Describe variable scope within modules/child modulesf","text":"<ul> <li>Modules are called from within other modules using module blocks</li> <li>All modules require a source argument, which is a meta-argument defined by Terraform</li> <li>To call a module means to include the contents of that module into the configuration with specific values for its input variables.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#7-4-discover-modules-from-the-public-terraform-module-registry","title":"7-4 Discover modules from the public Terraform Module Registry","text":"<p>Terraform Module Registry allows you to browse, filter and search for modules</p>"},{"location":"chap5/1hashicorp_certified_terraform/#7-5-defining-module-version","title":"7-5 Defining module version","text":"<ul> <li>must be on GitHub and must be a public repo, if using public registry.</li> <li>must be named <code>terraform-&lt;PROVIDER&gt;-&lt;NAME&gt;</code>, where <code>&lt;NAME&gt;</code> reflects the type of infrastructure the module manages and <code>&lt;PROVIDER&gt;</code> is the main provider where it creates that infrastructure. for e.g. terraform-google-vault or terraform-aws-ec2-instance.</li> <li>must maintain <code>x.y.z</code> tags for releases to identify module versions. and can optionally be prefixed with a v for example, v1.0.4 and 0.9.2. Tags that don\u2019t look like version numbers are ignored.</li> <li>must maintain a Standard module structure, which allows the registry to inspect the module and generate documentation, track resource usage, parse submodules and examples, and more.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8navigate-terraform-workflow","title":"8\u3001Navigate Terraform workflow","text":""},{"location":"chap5/1hashicorp_certified_terraform/#8-1-describe-terraform-workflow-write-plan-create","title":"8-1 Describe Terraform workflow ( Write -&gt; Plan -&gt; Create )","text":"<ul> <li>Core Terraform workflow has three steps:<ul> <li>Write \u2013 Author infrastructure as code.</li> <li>Plan \u2013 Preview changes before applying.</li> <li>Apply \u2013 Provision reproducible infrastructure.</li> </ul> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8-2-initialize-a-terraform-working-directory-terraform-init","title":"8-2 Initialize a Terraform working directory terraform init","text":"<ul> <li>initializes a working directory containing Terraform configuration files.</li> <li>performs backend initialization, modules and plugins installation.</li> <li>plugins are downloaded in the sub-directory of the present working directory at the path of <code>.terraform/plugins</code></li> <li>does not delete the existing configuration or state</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8-3-validate-a-terraform-configuration-terraform-validate","title":"8-3 Validate a Terraform configuration <code>terraform validate</code>","text":"<ul> <li>validates the configuration files in a directory, referring only to the configuration and not accessing any remote services such as remote state, provider APIs, etc.</li> <li>verifies whether a configuration is syntactically valid and internally consistent, regardless of any provided variables or existing state.</li> <li>useful for general verification of reusable modules, including the correctness of attribute names and value types.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8-4-generate-and-review-an-execution-plan-for-terraform-terraform-plan","title":"8-4 Generate and review an execution plan for Terraform terraform plan","text":"<ul> <li><code>terraform plan</code> create a execution plan as it traverses each vertex and requests each provider using parallelism</li> <li>calculates the difference between the last-known state and the current state and presents this difference as the output of the terraform plan operation to user in their terminal</li> <li>does not modify the infrastructure or state.</li> <li>allows a user to see which actions Terraform will perform prior to making any changes to reach the desired state</li> <li>performs refresh for each resource and might hit rate limiting issues as it calls provider APIs</li> <li> <p>all resources refresh can be disabled or avoided using</p> <ul> <li><code>-refresh=false</code> or</li> <li><code>target=xxxx</code> or</li> <li>break resources into different directories.</li> </ul> </li> <li> <p>Execute changes to infrastructure with Terraform <code>terraform apply</code></p> <ul> <li>will always ask for confirmation before executing unless passed the <code>-auto-approve</code> flag.</li> <li>if a resource successfully creates but fails during provisioning, Terraform will error and mark the resource as \u201ctainted\u201d. Terraform does not roll back the changes</li> </ul> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8-5-destroy-terraform-managed-infrastructure-terraform-destroy","title":"8-5 Destroy Terraform managed infrastructure terraform destroy","text":"<ul> <li>will always ask for confirmation before executing unless passed the <code>-auto-approve</code> flag.</li> <li>if a resource successfully creates but fails during provisioning, Terraform will error and mark the resource as \u201ctainted\u201d. Terraform does not roll back the changes</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#8-6-destroy-terraform-managed-infrastructure-terraform-destroy","title":"8-6 Destroy Terraform managed infrastructure terraform destroy","text":"<p>will always ask for confirmation before executing unless passed the <code>-auto-approve</code> flag.</p>"},{"location":"chap5/1hashicorp_certified_terraform/#9implement-and-maintain-state","title":"9\u3001Implement and maintain state","text":""},{"location":"chap5/1hashicorp_certified_terraform/#9-1-describe-default-local-backend","title":"9-1 Describe default local backend","text":"<ul> <li>A \u201cbackend\u201d in Terraform determines how state is loaded and how an operation such as apply is executed. This abstraction enables non-local file state storage, remote execution, etc.</li> <li>determines how state is loaded and how an operation such as apply is executed</li> <li>is responsible for storing state and providing an API for optional state locking</li> <li>needs to be initialized</li> <li>helps<ul> <li>collaboration and working as a team, with the state maintained remotely and state locking</li> <li>can provide enhanced security for sensitive data</li> <li>support remote operations</li> </ul> </li> <li>local (default) backend stores state in a local JSON file on disk</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-2-outline-state-locking","title":"9-2 Outline state locking","text":"<ul> <li>happens for all operations that could write state, if supported by backend for e.g. <code>S3 with DynamoDB, Consul</code> etc.</li> <li>prevents others from acquiring the lock &amp; potentially corrupting the state</li> <li>use <code>force-unlock</code> command to manually unlock the state if unlocking failed</li> <li> <p>backends which support state locking are</p> <ul> <li>azurerm</li> <li>Hashicorp consul</li> <li>Tencent Cloud Object Storage (COS)</li> <li>etcdv3</li> <li>Google Cloud Storage GCS</li> <li>HTTP endpoints</li> <li>Kubernetes Secret with locking done using a Lease resource</li> <li>AliCloud Object Storage OSS with locking via TableStore</li> <li>PostgreSQL</li> <li>AWS S3 with locking via DynamoDB</li> <li>Terraform Enterprise</li> </ul> </li> <li> <p>Backends which do not support state locking are</p> <ul> <li>artifactory</li> <li>etcd</li> </ul> </li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-3-handle-backend-authentication-methods","title":"9-3 Handle backend authentication methods","text":"<ul> <li>every remote backend support different authentication mechanism and can be configured with the backend configuration</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-4-describe-remote-state-storage-mechanisms-and-supported-standard-backends","title":"9-4 Describe remote state storage mechanisms and supported standard backends","text":"<ul> <li>remote backend stores state remotely like S3, OSS, GCS, Consul and support features like remote operation, state locking, encryption, versioning etc.</li> <li>github is not a supported backend type.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-5-describe-effect-of-terraform-refresh-on-state","title":"9-5 Describe effect of Terraform refresh on state","text":"<ul> <li><code>terraform refresh</code> is used to reconcile the state Terraform knows about (via its state file) with the real-world infrastructure.</li> <li>can be used to detect any drift from the last-known state, and to update the state file.</li> <li>does not modify infrastructure but does modify the state file.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-6-describe-backend-block-in-configuration-and-best-practices-for-partial-configurations","title":"9-6 Describe backend block in configuration and best practices for partial configurations","text":"<ul> <li>Backend configuration doesn\u2019t support interpolations.</li> <li>supports partial configuration with remaining configuration arguments provided as part of the initialization process</li> <li>if switching the backed for the first time setup, Terraform provides a migration option</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#9-7-understand-secret-management-in-state-files","title":"9-7 Understand secret management in state files","text":"<ul> <li><code>terraform state</code> command is used for advanced state management</li> <li>Terraform has no mechanism to redact or protect secrets that are returned via data sources, so secrets read via this provider will be persisted into the Terraform state, into any plan files, and in some cases in the console output produced while planning and applying.</li> <li>can be protected accordingly either by using Vault and remote backends with encryption and proper access control</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10read-generate-and-modify-configuration","title":"10\u3001Read, generate, and modify configuration","text":""},{"location":"chap5/1hashicorp_certified_terraform/#10-1-demonstrate-use-of-variables-and-outputs","title":"10-1 Demonstrate use of variables and outputs","text":"<p>Variables</p> <ul> <li>serve as parameters for a Terraform module and</li> <li>act like function arguments</li> <li>count is a reserved word and cannot be used as variable name</li> </ul> <p>Output</p> <ul> <li>are like function return values.</li> <li>can be marked sensitive which prevents showing its value in the list of outputs. However, they are stored in the state as plain text.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10-2-describe-secure-secret-injection-best-practice","title":"10-2 Describe secure secret injection best practice","text":""},{"location":"chap5/1hashicorp_certified_terraform/#10-3-understand-the-use-of-collection-and-structural-types","title":"10-3 Understand the use of collection and structural types","text":"<ul> <li>supports primitive data types of<ul> <li>string, number and bool</li> <li>automatically convert number and bool values to string values</li> </ul> </li> </ul> <p>supports complex data types of</p> <ul> <li>list \u2013 sequence of values identified by consecutive whole numbers starting with zero.</li> <li>map \u2013 collection of values where each is identified by a string label</li> <li>set \u2013 collection of unique values that do not have any secondary identifiers or ordering.</li> </ul> <p>supports structural data types of</p> <ul> <li>object \u2013 a collection of named attributes with their own type</li> <li>tuple \u2013 a sequence of elements identified by consecutive whole numbers starting with zero, where each element has its own type.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10-4-create-and-differentiate-resource-and-data-configuration","title":"10-4 Create and differentiate resource and data configuration","text":"<ul> <li>Resources describe one or more infrastructure objects, such as virtual networks, instances, or higher-level components such as DNS records.</li> <li>Data sources allow data to be fetched or computed for use elsewhere in Terraform configuration. Use of data sources allows a Terraform configuration to make use of information defined outside of Terraform, or defined by another separate Terraform configuration.</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10-5-use-resource-addressing-and-resource-parameters-to-connect-resources-together","title":"10-5 Use resource addressing and resource parameters to connect resources together","text":""},{"location":"chap5/1hashicorp_certified_terraform/#10-6-use-terraform-built-in-functions-to-write-configuration","title":"10-6 Use Terraform built-in functions to write configuration","text":"<ul> <li>lookup retrieves the value of a single element from a map, given its key. If the given key does not exist, a the given default value is returned instead. <code>lookup(map, key, default)</code></li> <li>zipmap constructs a map from a list of keys and a corresponding list of values. A map is denoted by <code>{ }</code> whereas a list is donated by <code>[ ]</code> for e.g. <code>zipmap([\"a\", \"b\"], [1, 2])</code> results into <code>{\"a\" = 1, \"b\" = 2}</code></li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10-7-configure-resource-using-a-dynamic-block","title":"10-7 Configure resource using a dynamic block","text":"<ul> <li>dynamic acts much like a for expression, but produces nested blocks instead of a complex typed value. It iterates over a given complex value, and generates a nested block for each element of that complex value.</li> <li>Overuse of dynamic block is not recommended as it makes the code hard to understand and debug</li> </ul>"},{"location":"chap5/1hashicorp_certified_terraform/#10-8-describe-built-in-dependency-management-order-of-execution-based","title":"10-8 Describe built-in dependency management (order of execution based)","text":"<ul> <li>Terraform analyses any expressions within a resource block to find references to other objects and treats those references as implicit ordering requirements when creating, updating, or destroying resources.</li> <li>Explicit dependency can be defined using the depends_on attribute where dependencies between resources that are not visible</li> </ul> <p>support comments using <code>#</code>, <code>//</code> and <code>/* */</code></p>"},{"location":"chap5/1hashicorp_certified_terraform/#11-understand-terraform-cloud-and-enterprise-capabilities","title":"11 Understand Terraform Cloud and Enterprise capabilities","text":""},{"location":"chap5/1hashicorp_certified_terraform/#11-1-describe-the-benefits-of-sentinel-registry-and-workspaces","title":"11-1 Describe the benefits of Sentinel, registry, and workspaces","text":"<p>Terraform Cloud provides private module registry for storing modules private to be used within the organization</p>"},{"location":"chap5/1hashicorp_certified_terraform/#11-2-differentiate-oss-and-tfe-workspaces","title":"11-2 Differentiate OSS and TFE workspaces","text":""},{"location":"chap5/1hashicorp_certified_terraform/#11-3-summarize-features-of-terraform-cloud","title":"11-3 Summarize features of Terraform Cloud","text":"<p>Terraform Enterprise currently supports running under the following operating systems for a Clustered deployment:</p> <ul> <li>Ubuntu 16.04.3 \u2013 16.04.5 / 18.04</li> <li>Red Hat Enterprise Linux 7.4 through 7.7</li> <li>CentOS 7.4 \u2013 7.7</li> <li>Amazon Linux</li> <li>Oracle Linux</li> <li>Clusters currently don\u2019t support other Linux variants.</li> </ul> <p>Terraform Enterprise install that is provisioned on a network that does not have Internet access is generally known as an air-gapped install.</p>"},{"location":"chap5/2terraform_cs/","title":"L2 Terraform Cheat Sheet","text":"<ul> <li>An open source provisioning declarative tool that based on Infrastructure as a Code paradigm</li> <li>designed on immutable infrastructure principles</li> <li>Written in Golang and uses own syntax \u2013 HCL (Hashicorp Configuration Language), but also supports JSON</li> <li>Helps to evolve the infrastructure, safely and predictably</li> <li>Applies Graph Theory to IaaC and provides Automation, Versioning and Reusability</li> <li>Terraform is a multipurpose composition tool:<ul> <li>Composes multiple tiers (SaaS/PaaS/IaaS)</li> <li>A plugin-based architecture model</li> </ul> </li> <li>Terraform is not a cloud agnostic tool. It embraces all major Cloud</li> <li>Providers and provides common language to orchestrate the infrastructure resources</li> <li>Terraform is not a configuration management tool and other tools like chef, ansible exists in the market.</li> </ul>"},{"location":"chap5/2terraform_cs/#1terraform-architecture","title":"1\u3001Terraform Architecture","text":""},{"location":"chap5/2terraform_cs/#2terraform-providers-plugins","title":"2\u3001Terraform Providers (Plugins)","text":"<ul> <li>provide abstraction above the upstream API and is responsible for understanding API interactions and exposing resources.</li> <li>Invoke only upstream APIs for the basic CRUD operations</li> <li>Providers are unaware of anything related to configuration loading, graph theory, etc.</li> <li>supports multiple provider instances using <code>alias</code> for e.g. multiple aws provides with different region</li> <li>can be integrated with any API using providers framework</li> <li>Most providers configure a specific infrastructure platform (either cloud or self-hosted).</li> <li>can also offer local utilities for tasks like generating random numbers for unique resource names.</li> </ul>"},{"location":"chap5/2terraform_cs/#3terraform-provisioners","title":"3\u3001Terraform Provisioners","text":"<ul> <li> <p>run code locally or remotely on resource creation</p> <ul> <li>local exec executes code on the machine running terraform</li> <li>remote exec<ul> <li>runs on the provisioned resource</li> <li>supports ssh and winrm</li> </ul> </li> <li>requires inline list of commands</li> </ul> </li> <li> <p>should be used as a last resort</p> </li> <li>are defined within the resource block.</li> <li>support types \u2013 Create and Destroy<ul> <li>if creation time fails, resource is tainted if provisioning failed, by default. (next apply it will be re-created)</li> <li>behavior can be overridden by setting the <code>on_failure</code> to <code>continue</code>, which means ignore and continue</li> <li>for destroy, if it fails \u2013 resources are not removed</li> </ul> </li> </ul>"},{"location":"chap5/2terraform_cs/#4terraform-workspaces","title":"4\u3001Terraform Workspaces","text":"<ul> <li>helps manage multiple distinct sets of infrastructure resources or environments with the same code.</li> <li>just need to create needed workspace and use them, instead of creating a directory for each environment to manage</li> <li>state files for each workspace are stored in the directory <code>terraform.tfstate.d</code></li> <li><code>terraform workspace new dev</code> creates a new workspace and switches to it as well</li> <li><code>terraform workspace select dev</code> helps select workspace</li> <li><code>terraform workspace list</code> lists the workspaces and shows the current active one with <code>*</code></li> <li>does not provide strong separation as it uses the same backend</li> </ul>"},{"location":"chap5/2terraform_cs/#5terraform-workflow","title":"5\u3001Terraform Workflow","text":""},{"location":"chap5/2terraform_cs/#5-1-init","title":"5-1 init","text":"<ul> <li><code>initializes</code> a working directory containing Terraform configuration files.</li> <li> <p>performs</p> <ul> <li>backend initialization , storage for terraform state file.</li> <li>modules installation, downloaded from terraform registry to local path</li> <li>provider(s) plugins installation, the plugins are downloaded in the sub-directory of the present working directory at the path of <code>.terraform/plugins</code></li> </ul> </li> <li> <p>supports <code>-upgrade</code> to update all previously installed plugins to the newest version that complies with the configuration\u2019s version constraints</p> </li> <li>is safe to run multiple times, to bring the working directory up to date with changes in the configuration</li> <li>does not delete the existing configuration or state</li> </ul>"},{"location":"chap5/2terraform_cs/#5-2-validate","title":"5-2 validate","text":"<ul> <li>validates syntactically for format and correctness.</li> <li>is used to validate/check the syntax of the Terraform files.</li> <li>verifies whether a configuration is syntactically valid and internally consistent, regardless of any provided variables or existing state.</li> <li>A syntax check is done on all the terraform files in the directory, and will display an error if any of the files doesn\u2019t validate.</li> </ul>"},{"location":"chap5/2terraform_cs/#5-3-plan","title":"5-3 plan","text":"<ul> <li>create a execution plan</li> <li>traverses each vertex and requests each provider using parallelism</li> <li>calculates the difference between the last-known state and the current state and presents this difference as the output of the terraform plan operation to user in their terminal</li> <li>does not modify the infrastructure or state.</li> <li>allows a user to see which actions Terraform will perform prior to making any changes to reach the desired state</li> <li>will scan all <code>*.tf</code> \u2000files in the directory and create the plan</li> <li>will perform refresh for each resource and might hit rate limiting issues as it calls provider APIs</li> <li>all resources refresh can be disabled or avoided using<ul> <li><code>-refresh=false</code> or</li> <li><code>target=xxxx</code> or</li> <li>break resources into different directories.</li> </ul> </li> <li>supports <code>-out</code> to save the plan</li> </ul>"},{"location":"chap5/2terraform_cs/#5-4-apply","title":"5-4 apply","text":"<ul> <li>apply changes to reach the desired state.</li> <li>scans the current directory for the configuration and applies the changes appropriately.</li> <li>can be provided with a explicit plan, saved as out from <code>terraform plan</code></li> <li>If no explicit plan file is given on the command line, <code>terraform apply</code> will create a new plan automatically and prompt for approval to apply it</li> <li>will modify the infrastructure and the state.</li> <li>if a resource successfully creates but fails during provisioning,<ul> <li>Terraform will error and mark the resource as \u201ctainted\u201d.</li> <li>A resource that is tainted has been physically created, but can\u2019t be considered safe to use since provisioning failed.</li> <li>Terraform also does not automatically roll back and destroy the resource during the apply when the failure happens, because that would go against the execution plan: the execution plan would\u2019ve said a resource will be created, but does not say it will ever be deleted.</li> </ul> </li> <li>does not import any resource.</li> <li>supports <code>-auto-approve</code> to apply the changes without asking for a confirmation</li> <li>supports <code>-target</code> to apply a specific module</li> </ul>"},{"location":"chap5/2terraform_cs/#5-5-refresh","title":"5-5 refresh","text":"<ul> <li>used to reconcile the state Terraform knows about (via its state file) with the real-world infrastructure</li> <li>does not modify infrastructure, but does modify the state file</li> </ul>"},{"location":"chap5/2terraform_cs/#5-6-destroy","title":"5-6 destroy","text":"<ul> <li>destroy the infrastructure and all resources</li> <li>modifies both state and infrastructure</li> <li><code>terraform destroy -target</code> can be used to destroy targeted resources</li> <li><code>terraform plan -destroy</code> allows creation of destroy plan</li> </ul>"},{"location":"chap5/2terraform_cs/#5-7-import","title":"5-7 import","text":"<ul> <li>helps import already-existing external resources, not managed by Terraform, into Terraform state and allow it to manage those resources</li> <li>Terraform is not able to auto-generate configurations for those imported modules, for now, and requires you to first write the resource definition in Terraform and then import this resource</li> </ul>"},{"location":"chap5/2terraform_cs/#5-8-taint","title":"5-8 taint","text":"<ul> <li>marks a Terraform-managed resource as tainted, forcing it to be destroyed and recreated on the next apply.</li> <li>will not modify infrastructure, but does modify the state file in order to mark a resource as tainted. Infrastructure and state are changed in next apply.</li> <li>can be used to taint a resource within a module</li> </ul>"},{"location":"chap5/2terraform_cs/#5-9-fmt","title":"5-9 fmt","text":"<p>format to lint the code into a standard format</p>"},{"location":"chap5/2terraform_cs/#5-10-console","title":"5-10 console","text":"<p>command provides an interactive console for evaluating expressions.</p>"},{"location":"chap5/2terraform_cs/#6terraform-modules","title":"6\u3001Terraform Modules","text":"<ul> <li>enables code reuse</li> <li>supports versioning to maintain compatibility</li> <li>stores code remotely</li> <li>enables easier testing</li> <li>enables encapsulation with all the separate resources under one</li> <li>configuration block</li> <li>modules can be nested inside other modules, allowing you to quickly spin up whole separate environments.</li> <li>can be referred using source attribute</li> <li>supports Local and Remote modules<ul> <li>Local modules are stored alongside the Terraform configuration (in a separate directory, outside of each environment but in the same repository) with source path <code>./</code> or <code>../</code></li> <li>Remote modules are stored externally in a separate repository, and supports versioning</li> </ul> </li> <li>supports following backends<ul> <li>Local paths</li> <li>Terraform Registry</li> <li>GitHub</li> <li>Bitbucket</li> <li>Generic Git, Mercurial repositories</li> <li>HTTP URLs</li> <li>S3 buckets</li> <li>GCS buckets</li> </ul> </li> </ul>"},{"location":"chap5/2terraform_cs/#6-1-module-requirements","title":"6-1 Module requirements","text":"<ul> <li>must be on GitHub and must be a public repo, if using public registry.</li> <li>must be named <code>terraform-&lt;PROVIDER&gt;-&lt;NAME&gt;</code>, where <code>&lt;NAME&gt;</code> reflects the type of infrastructure the module manages and <code>&lt;PROVIDER&gt;</code> is the main provider where it creates that infrastructure. for e.g. <code>terraform-google-vault</code> or <code>terraform-aws-ec2-instance</code>.</li> <li>must maintain <code>x.y.z</code> tags for releases to identify module versions. Release tag names must be a semantic version, which can optionally be prefixed with a v for example, v1.0.4 and 0.9.2. Tags that don\u2019t look like version numbers are ignored.</li> <li>must maintain a Standard module structure, which allows the registry to inspect the module and generate documentation, track resource usage, parse submodules and examples, and more.</li> </ul>"},{"location":"chap5/2terraform_cs/#7terraform-read-and-write-configuration","title":"7\u3001Terraform Read and write configuration","text":""},{"location":"chap5/2terraform_cs/#7-1-resources","title":"7-1 Resources","text":"<ul> <li>resource are the most important element in the Terraform language that describes one or more infrastructure objects, such as compute instances etc</li> <li>resource type and local name together serve as an identifier for a given resource and must be unique within a module for e.g.  <code>aws_instance.local_name</code></li> </ul>"},{"location":"chap5/2terraform_cs/#7-2-data-sources","title":"7-2 Data Sources","text":"<ul> <li>data allow data to be fetched or computed for use elsewhere in Terraform configuration</li> <li>allows a Terraform configuration to make use of information defined outside of Terraform, or defined by another separate Terraform configuration</li> </ul>"},{"location":"chap5/2terraform_cs/#7-3-variables","title":"7-3 Variables","text":"<ul> <li>variable serve as parameters for a Terraform module and act like function arguments</li> <li>allows aspects of the module to be customized without altering the module\u2019s own source code, and allowing modules to be shared between different configurations</li> <li>can be defined through multiple ways<ul> <li>command line for e.g.<code>-var=\"image_id=ami-abc123\"</code></li> <li>variable definition files <code>.tfvars</code> or <code>.tfvars.json</code>. By default, terraform automatically loads<ul> <li>Files named exactly <code>terraform.tfvars</code> or <code>terraform.tfvars.json</code>.</li> <li>Any files with names ending in <code>.auto.tfvars</code> or <code>.auto.tfvars.json</code></li> <li>file can also be passed with <code>-var-file</code></li> </ul> </li> <li>environment variables can be used to set variables using the format <code>TF_VAR_name</code></li> </ul> </li> </ul> <p>Environment variables</p> <ul> <li><code>terraform.tfvars</code> file, if present.</li> <li><code>terraform.tfvars.json</code> file, if present.</li> <li>Any <code>*.auto.tfvars</code> or <code>*.auto.tfvars.json</code> files, processed in lexical order of their filenames.</li> <li>Any <code>-var</code> and <code>-var-file</code> options on the command line, in the order they are provided. Terraform loads variables in the following order, with later sources taking precedence over earlier ones:</li> </ul>"},{"location":"chap5/2terraform_cs/#7-4-local-values","title":"7-4 Local Values","text":"<ul> <li>locals assigns a name to an expression, allowing it to be used multiple times within a module without repeating it.</li> <li>are like a function\u2019s temporary local variables.</li> <li>helps to avoid repeating the same values or expressions multiple times in a configuration.</li> </ul>"},{"location":"chap5/2terraform_cs/#7-5-output","title":"7-5 Output","text":"<ul> <li>are like function return values.</li> <li>output can be marked as containing sensitive material using the optional <code>sensitive</code> argument, which prevents Terraform from showing its value in the list of outputs. However, they are still stored in the state as plain text.</li> <li>In a parent module, outputs of child modules are available in expressions as <code>module.&lt;MODULE NAME&gt;.&lt;OUTPUT NAME&gt;</code>.</li> </ul>"},{"location":"chap5/2terraform_cs/#7-6-named-values","title":"7-6 Named Values","text":"<ul> <li>is an expression that references the associated value for e.g. <code>aws_instance.local_name, data.aws_ami.centos</code>, <code>var.instance_type</code> etc.</li> <li></li> <li>support Local named values for e.g <code>count.index</code></li> </ul>"},{"location":"chap5/2terraform_cs/#7-7-dependencies","title":"7-7 Dependencies","text":"<p>identifies implicit dependencies as Terraform automatically infers when one resource depends on another by studying the resource attributes used in interpolation expressions for e.g <code>aws_eip</code> on resource <code>aws_instance</code></p> <p>explicit dependencies can be defined using <code>depends_on</code> where dependencies between resources that are <code>not visible</code> to Terraform</p>"},{"location":"chap5/2terraform_cs/#7-8-data-types","title":"7-8 Data Types","text":"<ul> <li> <p>supports primitive data types of</p> <ul> <li>string, number and bool</li> <li>Terraform language will automatically convert number and bool values to string values when needed</li> </ul> </li> <li> <p>supports complex data types of</p> <ul> <li>list \u2013 a sequence of values identified by consecutive whole numbers starting with zero.</li> <li>map \u2013 a collection of values where each is identified by a string label.</li> <li>set \u2013  a collection of unique values that do not have any secondary  identifiers or ordering.</li> </ul> </li> <li> <p>supports structural data types of</p> <ul> <li>object \u2013 a collection of named attributes that each have their own type</li> <li>tuple \u2013 a sequence of elements identified by consecutive whole numbers starting with zero, where each element has its own type.</li> </ul> </li> </ul>"},{"location":"chap5/2terraform_cs/#7-9-built-in-functions","title":"7-9 Built-in Functions","text":"<ul> <li>includes a number of built-in functions that can be called from within expressions to transform and combine values for e.g. min, max, file, concat, element, index, lookup etc.</li> <li>does not support user-defined functions</li> </ul>"},{"location":"chap5/2terraform_cs/#7-10-dynamic-blocks","title":"7-10 Dynamic Blocks","text":"<p>acts much like a for expression, but produces nested blocks instead of a complex typed value. It iterates over a given complex value, and generates a nested block for each element of that complex value.</p>"},{"location":"chap5/2terraform_cs/#7-11-terraform-comments","title":"7-11 Terraform Comments","text":"<p>supports three different syntaxes for comments:</p> <ul> <li><code>#</code></li> <li><code>//</code></li> <li><code>/*</code> and <code>*/</code></li> </ul>"},{"location":"chap5/2terraform_cs/#8terraform-backends","title":"8\u3001Terraform Backends","text":"<ul> <li>determines how state is loaded and how an operation such as apply is executed</li> <li>are responsible for storing state and providing an API for optional state locking</li> <li>needs to be initialized</li> <li>if switching the backed for the first time setup, Terraform provides a migration option</li> </ul>"},{"location":"chap5/2terraform_cs/#8-1-helps","title":"8-1 helps","text":"<ul> <li>collaboration and working as a team, with the state maintained remotely and state locking</li> <li>can provide enhanced security for sensitive data</li> <li>support remote operations</li> </ul>"},{"location":"chap5/2terraform_cs/#8-2-supports-local-vs-remote-backends","title":"8-2 supports local vs remote backends","text":"<ul> <li>local (default) backend stores state in a local JSON file on disk</li> <li> <p>remote backend stores state remotely like S3, OSS, GCS, Consul and support features like remote operation, state locking, encryption, versioning etc.</p> </li> <li> <p>supports partial configuration with remaining configuration arguments provided as part of the initialization process</p> </li> <li>Backend configuration doesn\u2019t support interpolations.</li> <li>GitHub is not the supported backend type in Terraform.</li> </ul>"},{"location":"chap5/2terraform_cs/#9terraform-state-management","title":"9\u3001Terraform State Management","text":"<ul> <li>state helps keep track of the infrastructure Terraform manages</li> <li>stored locally in the <code>terraform.tfstate</code></li> <li>recommended not to edit the state manually</li> <li>Use <code>terraform state</code> command<ul> <li>mv \u2013 to move/rename modules</li> <li>rm \u2013 to safely remove resource from the state. (destroy/retain like)</li> <li>pull \u2013 to observe current remote state</li> <li>list &amp; show \u2013 to write/debug modules</li> </ul> </li> </ul>"},{"location":"chap5/2terraform_cs/#10state-locking","title":"10\u3001State Locking","text":"<ul> <li>happens for all operations that could write state, if supported by backend</li> <li>prevents others from acquiring the lock &amp; potentially corrupting the state</li> <li> <p>backends which support state locking are</p> <ul> <li>azurerm</li> <li>Hashicorp consul</li> <li>Tencent Cloud Object Storage (COS)</li> <li>etcdv3</li> <li>Google Cloud Storage GCS</li> <li>HTTP endpoints</li> <li>Kubernetes Secret with locking done using a Lease resource</li> <li>AliCloud Object Storage OSS with locking via TableStore</li> <li>PostgreSQL</li> <li>AWS S3 with locking via DynamoDB</li> <li>Terraform Enterprise</li> </ul> </li> <li> <p>Backends which do not support state locking are</p> <ul> <li>artifactory</li> <li>etcd</li> </ul> </li> <li> <p>can be disabled for most commands with the <code>-lock</code> flag</p> </li> <li>use force-unlock command to manually unlock the state if unlocking failed</li> </ul>"},{"location":"chap5/2terraform_cs/#11state-security","title":"11\u3001State Security","text":"<ul> <li>can contain sensitive data, depending on the resources in use for e.g passwords and keys</li> <li>using local state, data is stored in plain-text JSON files using remote state, state is held in memory when used by Terraform. It may be encrypted at rest, if supported by backend for e.g. S3, OSS</li> </ul>"},{"location":"chap5/2terraform_cs/#12terraform-logging","title":"12\u3001Terraform Logging","text":"<ul> <li>debugging can be controlled using <code>TF_LOG</code> , which can be configured for different levels TRACE, DEBUG, INFO, WARN or ERROR, with TRACE being the more verbose.</li> <li>logs path can be controlled <code>TF_LOG_PATH</code>. <code>TF_LOG</code> needs to be specified.</li> </ul>"},{"location":"chap5/2terraform_cs/#13terraform-cloud-and-terraform-enterprise","title":"13\u3001Terraform Cloud and Terraform Enterprise","text":"<ul> <li>Terraform Cloud provides Cloud Infrastructure Automation as a Service. It is offered as a multi-tenant SaaS platform and is designed to suit the needs of smaller teams and organizations. Its smaller plans default to one run at a time, which prevents users from executing multiple runs concurrently.</li> <li>Terraform Enterprise is a private install for organizations who prefer to self-manage. It is designed to suit the needs of organizations with specific requirements for security, compliance and custom operations.</li> </ul>"},{"location":"chap5/2terraform_cs/#13-1-terraform-cloud-provides-features","title":"13-1 Terraform Cloud provides features","text":"<ul> <li>Remote Terraform Execution \u2013 supports Remote Operations for Remote Terraform execution which helps provide consistency and visibility for critical provisioning operations.</li> <li>Workspaces \u2013 organizes infrastructure with workspaces instead of directories. Each workspace contains everything necessary to manage a given collection of infrastructure, and Terraform uses that content whenever it executes in the context of that workspace.</li> <li>Remote State Management \u2013 acts as a remote backend for the Terraform state. State storage is tied to workspaces, which helps keep state associated with the configuration that created it.</li> <li>Version Control Integration \u2013 is designed to work directly with the version control system (VCS) provider.</li> <li>Private Module Registry \u2013 provides a private and central library of versioned &amp; validated modules to be used within the organization</li> <li>Team based Permission System \u2013 can define groups of users that match the organization\u2019s real-world teams and assign them only the permissions they need</li> <li>Sentinel Policies \u2013 embeds the Sentinel policy-as-code framework, which lets you define and enforce granular policies for how the organization provisions infrastructure. Helps eliminate provisioned resources that don\u2019t follow security, compliance, or operational policies.</li> <li>Cost Estimation \u2013 can display an estimate of its total cost, as well as any change in cost caused by the proposed updates</li> <li>Security \u2013 encrypts state at rest and protects it with TLS in transit.</li> </ul>"},{"location":"chap5/2terraform_cs/#13-2-terraform-enterprise-features","title":"13-2 Terraform Enterprise features","text":"<ul> <li>includes all the Terraform Cloud features with</li> <li>Audit \u2013 supports detailed audit logging and tracks the identity of the user requesting state and maintains a history of state changes.</li> <li>SSO/SAML \u2013 SAML for SSO provides the ability to govern user access to your applications.</li> </ul> <p>Terraform Enterprise currently supports running under the following operating systems for a Clustered deployment:</p> <ul> <li>Ubuntu 16.04.3 \u2013 16.04.5 / 18.04</li> <li>Red Hat Enterprise Linux 7.4 through 7.7</li> <li>CentOS 7.4 \u2013 7.7</li> <li>Amazon Linux</li> <li>Oracle Linux</li> <li>Clusters currently don\u2019t support other Linux variants.</li> </ul> <p>Terraform Cloud currently supports following VCS Provider</p> <ul> <li>GitHub.com</li> <li>GitHub.com (OAuth)</li> <li>GitHub Enterprise</li> <li>GitLab.com</li> <li>GitLab EE and CE</li> <li>Bitbucket Cloud</li> <li>Bitbucket Server</li> <li>Azure DevOps Server</li> <li>Azure DevOps Services</li> </ul> <p>A Terraform Enterprise install that is provisioned on a network that does not have Internet access is generally known as an air-gapped install. These types of installs require you to pull updates, providers, etc. from external sources vs. being able to download them directly.</p>"},{"location":"chap5/3terraform_lock/","title":"<code>.terraform.lock.hcl</code> \u7b80\u4ecb","text":"<p>\u6bcf\u79cd\u7f16\u7a0b\u8bed\u8a00\u90fd\u6709\u81ea\u5df1\u7684\u5305\u7ba1\u7406\u5de5\u5177\uff0cJavascript \u6709 npm\uff0cRuby \u6709 Bundler\uff0cPython \u6709 pip\u3002\u8fd9\u7c7b\u7ba1\u7406\u5de5\u5177\u901a\u5e38\u4f1a\u4e3a\u9879\u76ee\u521b\u5efa\u4e00\u4e2a\u7c7b\u4f3c <code>package.lock</code> \u7684\u6587\u4ef6\uff0c\u9501\u5b9a\u9879\u76ee\u4f9d\u8d56\u7248\u672c\uff0c\u4ece\u800c\u4fdd\u8bc1\u5728\u4e0d\u540c\u7684\u673a\u5668\u4e0a\u8fd0\u884c\u7a0b\u5e8f\u65f6\uff0c\u4f9d\u8d56\u73af\u5883\u90fd\u76f8\u540c\u3002</p> <ul> <li>\u5bf9\u4e8e Ruby \u9879\u76ee\uff0c\u8fd9\u4e2a\u6587\u4ef6\u662f <code>Gemfile.lock</code></li> <li>\u5bf9\u4e8e\u524d\u7aef\u9879\u76ee\uff0c\u8fd9\u4e2a\u6587\u4ef6\u662f <code>package-lock.json</code> \u6216 <code>yarn.lock</code></li> <li>\u5bf9\u4e8ePython \u9879\u76ee\uff0c\u8fd9\u4e2a\u6587\u4ef6\u662f <code>Pipfile.lock</code></li> </ul> <p>Terraform \u4e5f\u6709\u201c\u5305\u201d\u7684\u6982\u5ff5\uff0c\u79f0\u4e4b\u4e3a module\u3002\u6bcf\u4e2a module \u6253\u5305\u4e86\u4e00\u5806\u8d44\u6e90\u3002\u5728\u4ee3\u7801\u4e2d\u5f15\u5165\u4e00\u4e2amodule\uff0c\u5c31\u4f1a\u521b\u5efa\u4e86\u8fd9\u4e2a\u5305\u4e2d\u7684\u4e00\u5806\u8d44\u6e90\u3002</p>"},{"location":"chap5/3terraform_lock/#module","title":"module \u521d\u4f53\u9a8c","text":"<p>\u6bd4\u5982\u8981\u5728 AWS \u4e2d\u521b\u5efa\u4e00\u4e2aweb\u670d\u52a1\u5668\u7684\u5b89\u5168\u7ec4\uff08Security Group\uff09\uff0c\u9700\u8981\u521b\u5efa Security Group\uff0cIngress Rule\uff0cEgress Rule\u3002</p> <pre><code>resource \"aws_security_group\" \"web-server\" {\n  name        = \"web-server\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description      = \"HTTP\"\n    from_port        = 80\n    to_port          = 80\n    protocol         = \"tcp\"\n    cidr_blocks      = \"0.0.0.0\"\n  }\n\n    ingress {\n    description      = \"HTTPs\"\n    from_port        = 443\n    to_port          = 443\n    protocol         = \"tcp\"\n    cidr_blocks      = \"0.0.0.0\"\n  }\n\n\n  egress {\n    from_port        = 0\n    to_port          = 0\n    protocol         = \"-1\"\n    cidr_blocks      = [\"0.0.0.0/0\"]\n  }\n}\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u4f60\u4f7f\u7528 AWS Security Group module \uff0c\u51e0\u884c\u4ee3\u7801\u5c31\u641e\u5b9a\u4e86\u3002</p> <pre><code>module \"web_server_sg\" {\n  source = \"terraform-aws-modules/security-group/aws\"\n  name        = \"web-server\"\n  description = \"Security group for web-server with HTTP ports open within VPC\"\n  vpc_id      = \"vpc-12345678\"\n\n  ingress_rules       = [\"http-80-tcp\", \"https-443-tcp\"]\n  egress_rules        = [\"all-all\"]\n}\n</code></pre> <p>\u4f60\u751a\u81f3\u53ef\u4ee5\u5728 module \u4e2d\u6253\u5305\u4e00\u4efd RDS\uff0cRedis\uff0cMemcached\uff0cEC2\uff0c S3\u7684\u8d44\u6e90\u5168\u5bb6\u6876\uff0c\u4e00\u53e3\u6c14\u521b\u5efa\u6574\u4e2a web \u5e94\u7528\u7684\u6280\u672f\u6808\u3002</p>"},{"location":"chap5/3terraform_lock/#terraformlockhcl_1","title":"<code>.terraform.lock.hcl</code> \u7528\u9014","text":"<p>\u5199\u597d\u4e86 Terraform \u4ee3\u7801\uff0c\u9700\u8981\u5148\u6267\u884c terraform init \u521d\u59cb\u5316\uff0c\u8fd9\u6761\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6 <code>.terraform.lock.hcl</code>\u3002</p> <p>\u719f\u6089\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u7684\u7a0b\u5e8f\u5458\uff0c\u5f80\u5f80\u4f1a\u8bef\u89e3\u8fd9\u4e2a\u6587\u4ef6\uff0c\u8ba4\u4e3a\u5b83\u662f module \u7684\u7248\u672c\u9501\u5b9a\u6587\u4ef6\u3002</p> <p>\u4e8b\u5b9e\u4e0a\u5b83\u5e76\u4e0d\u9501\u5b9a module \u7684\u7248\u672c\uff0c\u5b83\u53ea\u9501\u5b9a provider \u7684\u7248\u672c\u3002</p> <p>Terraform Documentation:</p> <p>At present, the dependency lock file tracks only provider dependencies. Terraform does not remember version selections for remote modules, and so Terraform will always select the newest available module version that meets the specified version constraints. You can use an exact version constraint to ensure that Terraform will always select the same module version.</p>"},{"location":"chap5/3terraform_lock/#terraformlockhcl_2","title":"<code>.terraform.lock.hcl \u4e2d\u6709\u4ec0\u4e48\uff1f</code>","text":"<p>\u8fd9\u662f\u4e00\u4e2a <code>.terraform.lock.hcl</code> \u8303\u4f8b\uff0c\u91cc\u9762\u5e76\u6ca1\u6709\u5404\u79cd module \u7684\u7248\u672c\u4fe1\u606f\uff0c\u90a3\u5b83\u6709\u4ec0\u4e48\uff1f</p> <pre><code>provider \"registry.terraform.io/hashicorp/aws\" {\n    version     = \"3.63.0\"\n    constraints = \"&gt;= 2.7.0, &gt;= 2.42.0, &gt;= 2.49.0, &gt;= 3.27.0, 3.63.0\"\n    hashes = [\n    \"h1:Z+2GvXLgqQ/uPMH8dv+dXJ/t+jd6sriYjhCJS6kSO6g=\",\n    \"h1:lf8Qex8bhCmh8TUEAU6H4brzjy3+d4BXB6gcOYnNtNY=\",\n    \"zh:42c6c98b294953a4e1434a331251e539f5372bf6779bd61ab5df84cac0545287\",\n    \"zh:5493773762a470889c9a23db97582d3a82035847c8d3bd13323b4c3012abf325\",\n    \"zh:550d22ff9fed4d817a922e7b84bd9d1f2ef8d3afa00832cf66b8cd5f0e6dc748\",\n    \"zh:632cb5e2d9d5041875f57174236eafe5b05dbf26750c1041ab57eb08c5369fe2\",\n    \"zh:7cfeaf5bde1b28bd010415af1f3dc494680a8374f1a26ec19db494d99938cc4e\",\n    \"zh:99d871606b67c8aefce49007315de15736b949c09a9f8f29ad8af1e9ce383ed3\",\n    \"zh:c4fc8539ffe90df5c7ae587fde495fac6bc0186fec2f2713a8988a619cef265f\",\n    \"zh:d0a26493206575c99ca221d78fe64f96a8fbcebe933af92eea6b39168c1f1c1d\",\n    \"zh:e156fdc964fdd4a7586ec15629e20d2b06295b46b4962428006e088145db07d6\",\n    \"zh:eb04fc80f652b5c92f76822f0fec1697581543806244068506aed69e1bb9b2af\",\n    \"zh:f5638a533cf9444f7d02b5527446cdbc3b2eab8bcc4ec4b0ca32035fe6f479d3\",\n  ]\n}\n</code></pre> <p>\u8ba9\u6211\u4eec\u6765\u9010\u884c\u5206\u6790\u8fd9\u4e2a\u6587\u4ef6\u3002</p> <ul> <li>\u7b2c1\u884c\uff0c\u4f60\u7684 terraform \u4ee3\u7801\u4f9d\u8d56 <code>aws provider</code>\u3002</li> <li>\u7b2c2\u884c\uff0c<code>provider</code> \u7684 <code>version</code>\u3002\u7531 terraform \u6839\u636e\u4e00\u4e9b\u89c4\u5219\u5e2e\u4f60\u9009\u5b9a\u3002</li> <li>\u7b2c3\u884c\uff0c<code>constraints</code> \u8868\u793a <code>provider</code> \u7248\u672c\u7684\u9650\u5236\u6761\u4ef6\u3002 \u4f60\u7684\u4ee3\u7801\u4e2d\u5f15\u5165\u4e86\u591a\u4e2a module \u540e\uff0c\u6bcf\u4e2amodule \u90fd\u5bf9 aws provider \u6709\u7248\u672c\u8981\u6c42\uff0c\u4e8e\u662f Terraform \u5c31\u628a\u5b83\u4eec\u6c47\u603b\u4e86\u8d77\u6765\u3002\u6240\u4ee5\u7b2c2\u884c\u7684\u7248\u672c\u5176\u5b9e\u662f\u7531\u7b2c3\u884c\u7684constraints\u51b3\u5b9a\u7684\u3002</li> <li>\u7b2c4\u884c\uff0c<code>hashes</code> \u4ee3\u8868 <code>checksum</code>\uff0c\u7528\u6765\u786e\u4fdd\u4e0b\u8f7d\u7684 <code>provider</code> \u5e76\u6ca1\u6709\u88ab\u4eba\u6076\u610f\u7be1\u6539\u8fc7\u3002</li> </ul>"},{"location":"chap5/3terraform_lock/#checksum","title":"\u4ec0\u4e48\u662f checksum\uff1f","text":"<p>\u6587\u4ef6\u7ecf\u8fc7\u52a0\u5bc6\u51fd\u6570\u5904\u7406\u540e\uff0c\u90fd\u4f1a\u751f\u6210\u552f\u4e00\u5bf9\u5e94\u7684\u54c8\u5e0c\u503c\uff0c\u4e0d\u540c\u6587\u4ef6\u6709\u4e0d\u540c\u7684\u54c8\u5e0c\u503c\u3002</p> <ul> <li>\u6587\u4ef61 \u2014&gt; \u52a0\u5bc6\u51fd\u6570 \u2014&gt; \u54c8\u5e0c\u503c1 <code>a7iwc</code></li> <li>\u6587\u4ef62 \u2014&gt; \u52a0\u5bc6\u51fd\u6570 \u2014&gt; \u54c8\u5e0c\u503c2 <code>ufj4c</code></li> <li>\u6587\u4ef63 \u2014&gt; \u52a0\u5bc6\u51fd\u6570 \u2014&gt; \u54c8\u5e0c\u503c3 <code>4iEDH</code></li> <li>\u6587\u4ef64 \u2014&gt; \u52a0\u5bc6\u51fd\u6570 \u2014&gt; \u54c8\u5e0c\u503c4 <code>xca3t</code></li> </ul> <p>checksum \u7528\u4e8e\u201c\u6587\u4ef6\u9632\u7be1\u6539\u201d\u3002\u6bd4\u5982 Java \u5b98\u65b9\u7f51\u7ad9\u4f1a\u6302\u51fa\u6bcf\u4e2a\u7248\u672c\u7684\u4e0b\u8f7d\u5730\u5740\uff0c\u4f46\u662f\u5b83\u7684\u4e0b\u8f7d\u901f\u5ea6\u592a\u6162\u4e86\u3002\u4e8e\u662f\u4f60\u5728\u4e00\u4e9b\u975e\u5b98\u65b9\u7684\u955c\u50cf\u7f51\u7ad9\u4e0b\u8f7d\u4e86 Java\uff0c\u4f46\u662f\u53c8\u53ef\u80fd\u600e\u4e48\u4fdd\u8bc1\u8fd9\u4e9b\u6587\u4ef6\u662f\u5b89\u5168\u7684\uff0c\u6ca1\u6709\u7be1\u6539\u8fc7\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u7528\u52a0\u5bc6\u51fd\u6570\u5bf9\u4e0b\u8f7d\u7684\u6587\u4ef6\u8fdb\u884c\u8ba1\u7b97\uff0c\u5f97\u5230\u4e00\u4e2a\u54c8\u5e0c\u503c\u3002</p> <ul> <li>\u5982\u679c\u4f60\u5f97\u5230\u7684\u54c8\u5e0c\u503c\u4e0e Java \u5b98\u7f51\u4e00\u81f4\uff0c\u8bf4\u660e\u6587\u4ef6\u6ca1\u88ab\u7be1\u6539\u3002</li> <li>\u5982\u679c\u4f60\u5f97\u5230\u7684\u54c8\u5e0c\u503c\u548c\u5b98\u7f51\u4e0d\u4e00\u81f4\uff0c\u8bf4\u660e\u6587\u4ef6\u88ab\u4eba\u52a8\u8fc7\u624b\u811a\u4e86</li> </ul> <p></p> <p>Terraform \u4e2d\u7684 hashes \u4e5f\u662f\u7c7b\u4f3c\u9053\u7406\uff0c\u5f53 Terraform \u53d1\u5e03\u67d0\u4e2a\u7248\u672c\u7684 provider \u65f6\uff0c\u7528\u7279\u5b9a\u7684\u54c8\u5e0c\u7b97\u6cd5\u4e3a\u8be5\u7248\u672c\u521b\u5efa\u54c8\u5e0c\u503c\u3002\u5982\u679c\u4f60\u4e0b\u8f7d\u7684\u6587\u4ef6\u548c\u8fd9\u4e2a hash \u503c\u5bf9\u4e0d\u4e0a\uff0c\u5c31\u8868\u793a\u6587\u4ef6\u88ab\u7be1\u6539\u4e86\u3002</p> <p>\u4e3a\u4ec0\u4e48\u6709\u7684\u54c8\u5e0c\u503c\u7684\u524d\u7f00\u662f <code>h1:</code>\uff0c\u6709\u4e9b\u524d\u7f00\u662f <code>zh</code>\uff1f</p> <p>h1\u548c zh \u4ee3\u8868\u4e86\u4e0d\u540c\u7684\u54c8\u5e0c\u7b97\u6cd5\uff0c\u6240\u4ee5\u4f1a\u4ea7\u751f\u4e24\u4efd\u54c8\u5e0c\u503c\u3002</p> <p>\u65e2\u7136\u4e00\u4e2a\u7279\u5b9a\u7248\u672c\u4f1a\u4ea7\u751f\u4e24\u4efd\u54c8\u5e0c\u503c\uff0c\u4e3a\u4ec0\u4e48\u793a\u4f8b\u6587\u4ef6\u6709 12 \u4e2a\u54c8\u5e0c\u503c\uff1f</p> <p>\u8fd9\u53ef\u80fd\u4e0e\u6211\u8fd0\u884c\u4e86\u4ee5\u4e0b\u547d\u4ee4\u53c8\u5173\u7cfb\u3002</p> <p>\u6211\u7684\u540c\u4e8b\u6709\u4e9b\u4f7f\u7528 Mac \u4e0a\uff0c\u6709\u4e9b\u4f7f\u7528 Windows \u4e0a\uff0c\u6709\u4e9b\u4f7f\u7528 Ubuntu \u4e0a\uff0c\u6b64\u5916 Atlantis \u8fd0\u884c\u5728 Ubuntu \u4e0a\u3002\u6240\u4ee5\u6211\u6267\u884c\u4e86\u4ee5\u4e0b\u547d\u4ee4\uff0c\u628a\u6240\u6709\u5e73\u53f0\u7684\u54c8\u5e0c\u503c\u90fd\u8ba1\u7b97\u597d\u4e86\uff0c\u8fd9\u6837\u540c\u4e8b\u4eec\u5728\u81ea\u5df1\u7684\u7535\u8111\u6216\u670d\u52a1\u5668\u4e0a\u6267\u884c\u3002</p> <p>\u6211\u731c\u6d4b\uff1a</p> <p><code>\u54c8\u5e0c\u503c\u7684\u6570\u91cf = \u7248\u672c * \u5e73\u53f0\u6570\u91cf * \u54c8\u5e0c\u51fd\u6570\u6570\u91cf</code></p> <pre><code>terraform providers lock \\\n  -platform=linux_arm64 \\\n  -platform=linux_amd64 \\\n  -platform=darwin_amd64 \\\n  -platform=windows_amd64\n</code></pre>"},{"location":"chap5/3terraform_lock/#module_1","title":"\u9501\u5b9a <code>module</code>\u7684\u7248\u672c\u53f7","text":"<p>\u65e2\u7136 <code>.terraform.lock.hcl</code> \u6587\u4ef6\u65e0\u6cd5\u9501\u5b9a <code>module</code> \u7684\u7248\u672c\uff0c\u5982\u4f55\u9501\u5b9a <code>module</code>\u7684\u7248\u672c\u53f7\u5462\uff1f</p> <pre><code>module \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"2.21.0\"  #\u6307\u5b9a\u7248\u672c\u53f7\n\n  name            = \"${var.project}-${var.environment}\"\n  cidr            = var.vpc_cidr\n  azs             = var.vpc_azs\n  public_subnets  = var.vpc_public_subnets\n  private_subnets = var.vpc_private_subnets\n  tags            = local.tags\n}\n</code></pre> <p>\u770b\u5b8c\u672c\u6587\uff0c\u5982\u679c\u975e\u8981\u8bb0\u4f4f\u4e00\u4e2a\u7ed3\u8bba\uff0c\u90a3\u5c31\u662f <code>.terraform.lock.hcl</code>\u5e76\u4e0d\u9501\u5b9a module \u7684\u7248\u672c\uff0c\u5b83\u53ea\u9501\u5b9a <code>provider</code> \u7684\u7248\u672c\u3002</p>"},{"location":"chap5/4terraform_var/","title":"4 <code>terraform.tfvars</code> \u4e0e <code>variables.tf</code> \u7684\u533a\u522b","text":"<p>\u901a\u5e38\u4e00\u4e2a Terraform \u9879\u76ee\u4e0b\uff0c\u5173\u4e8e\u53d8\u91cf\u7684\u6587\u4ef6\u6709\u597d\u51e0\u4e2a\uff1a</p> <ul> <li><code>output.tf</code></li> <li><code>variables.t</code></li> <li><code>locals.tf</code></li> <li><code>terraform.tfvars</code></li> </ul> <p>\u5176\u4e2d variables.tf \u548c terraform.tfvars \u6700\u5bb9\u6613\u8ba9\u4eba\u56f0\u60d1\uff0c\u4ed6\u4eec\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\u548c\u8054\u7cfb\uff1f</p>"},{"location":"chap5/4terraform_var/#variablestf","title":"<code>variables.tf</code>","text":"<p>variables.tf \u7528\u6765\u5b9a\u4e49\u53d8\u91cf\uff0c\u6bd4\u5982\u53d8\u91cf\u540d\uff0c\u7c7b\u578b\uff0c\u6709\u70b9\u50cf\u5199\u4ee3\u7801\u65f6\u51fd\u6570\u7684\u53c2\u6570\u5b9a\u4e49\u3002</p> <p>\u5728\u4ee5\u4e0b\u8303\u4f8b\u6587\u4ef6\u4e2d\u6211\u5b9a\u4e49\u4e86\u4e24\u4e2a\u53d8\u91cf project \u548c environment\uff0c\u4ed6\u4eec\u7684\u7c7b\u578b\u662f string\u3002</p> <pre><code># variables.tf\n# Input variable definitions\n\nvariable \"project\" {\n  description = \"project name\"\n  type = string\n}\n\nvariable \"environment\" {\n  description = \"the environment of project, e.g. production, sandbox, staging\"\n  type = string\n}\n</code></pre>"},{"location":"chap5/4terraform_var/#terraformtfvars","title":"terraform.tfvars","text":"<p><code>terraform.tfvars</code> \u7c7b\u4f3c\u4e8e\u4e00\u4e2a <code>.env</code> \u6587\u4ef6\uff0c\u4fdd\u5b58\u4e86\u4e00\u4e9b key-value\uff0c\u7528\u6765\u6279\u91cf\u7ed9\u53d8\u91cf\u8d4b\u503c\u3002</p> <pre><code>project = \"paylocity\"\nenvironment = \"sandbox\"\n</code></pre>"},{"location":"chap5/5terraform_random/","title":"Terraform: Random \u7b80\u4ecb","text":""},{"location":"chap5/5terraform_random/#provider","title":"Provider","text":"<p>Provider \u662f\u8fde\u63a5 Terraform \u548c\u4e91\u7684\u6865\u6881\uff0cProvider \u5b9a\u4e49\u4e86\u5404\u79cd\u8d44\u6e90\uff0c\u6bd4\u5982 EC2\uff0cRDS\uff0cVPC\uff0cNAT \u7b49\u7b49\u3002Terraform \u53ef\u4ee5\u901a\u8fc7\u4e0d\u540c\u7684 provider \u4e0e\u4e0d\u540c\u7684\u4e91\u6253\u4ea4\u9053\uff0c\u751a\u81f3\u79c1\u6709\u4e91\u3002</p> <p>\u51e0\u4e2a\u5e38\u7528\u7684 provider \u6e90\u7801\uff1a</p> <ul> <li>terraform AWS provider</li> <li>Google Cloud Platform provider</li> <li>Microsoft Azure provider</li> </ul>"},{"location":"chap5/5terraform_random/#terraform-random-provider","title":"Terraform Random Provider \u7b80\u4ecb","text":"<p>Terraform Random \u5b83\u662f\u4e00\u4e2a\u201d\u903b\u8f91\u5c42\u201d\u7684 provider\u3002\u4e4b\u6240\u4ee5\u79f0\u4e4b\u4e3a\u201d\u903b\u8f91provider\u201c\uff0c\u662f\u56e0\u4e3a\u5b83\u80cc\u540e\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684\u4e91\u3002</p> <p>\u5b83\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u8d44\u6e90\u7c7b\u578b\u3002</p> <ul> <li><code>random_id</code>\uff0c\u7528\u6765\u521b\u5efa\u968f\u673a\u5b57\u7b26\u4e32\uff0c\u6bd4\u5982 9baf56f751636fcf\u3002</li> <li><code>random_integer</code>\uff0c\u7528\u6765\u521b\u5efa\u968f\u673a\u6570\u5b57\u3002</li> <li><code>random_pet</code>, \u7528\u6765\u521b\u5efa\u4e00\u4e2a\u968f\u673a\u52a8\u7269\u540d\uff0c\u6bd4\u5982 dog, cat, panda\u3002</li> <li><code>random_string</code>\uff0c\u53ef\u4ee5\u7528\u521b\u5efa\u542b\u6709\u7279\u6b8a\u5b57\u7b26\u7684\u5b57\u7b26\u4e32\uff0c\u6bd4\u5982 /@\u00a3$4iLAWXjfUPHE\uff0c\u53ef\u4ee5\u7528\u6765\u505a\u5bc6\u7801\u3002</li> <li><code>random_uuid</code>\uff0c\u521b\u5efa\u4e00\u4e2a uuid\uff0c\u6bd4\u5982 <code>a2af1b5b-fdf2-04ce-b85e-cd235d08b76e</code>\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u6bb5\u793a\u4f8b\u4ee3\u7801\uff0c\u5b83\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2a VPC\uff0c\u7136\u540e\u521b\u5efa\u4e86\u4e00\u53f0\u670d\u52a1\u5668\uff0c\u670d\u52a1\u5668\u7684\u540d\u5b57\u5f15\u7528\u4e86 <code>random_pet</code> \u7684\u503c\u3002</p> <pre><code>terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"&gt;= 3.4.0\"\n    }\n\n    random = {\n      source = \"hashicorp/random\"\n      version = \"2.3.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = \"us-west-2\"\n}\n\n## \u521b\u5efa VPC\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  name            = \"test_vpc\" \n  cidr            = \"10.0.0.0/16\"\n  azs             = [\"us-west-2a\"]\n  public_subnets  = [\"10.0.1.0/24\", \"10.0.2.0/24\"]\n  private_subnets = [\"10.0.101.0/24\", \"10.0.102.0/24\"]\n  enable_nat_gateway = true\n}\n\n## \u521b\u5efa Random \u7684\u52a8\u7269\u540d\u5b57\nresource \"random_pet\" \"server\" {\n}\n\n## \u521b\u5efa\u670d\u52a1\u5668\nresource \"aws_instance\" \"server\" {\n  ami = \"ami-a0cfeed8\"\n  instance_type = \"t3.nano\"\n  tags = {\n    Name = \"web-server-${random_pet.server.id}\"\n  }\n}\n</code></pre> <p>\u8fd0\u884c\u5b8c\u4ee3\u7801\u4e4b\u540e\uff0c\u53ef\u4ee5\u5728 AWS Console \u770b\u5230\u4e00\u53f0\u540d\u5b57\u53eb \u201c\u60ca\u8bb6\u7684\u82b1\u6817\u9f20\u201d\u7684\u670d\u52a1\u5668\u3002</p> <p></p>"},{"location":"chap5/5terraform_random/#terraform-random_1","title":"Terraform Random \u662f\u968f\u673a\u51fd\u6570\u5417\uff1f","text":"<p>\u6211\u7684\u7591\u60d1\uff1a\u5982\u679c\u6211\u7684\u8d44\u6e90\u5305\u542b Random \u7684\u5c5e\u6027\uff0c\u8fd9\u4e2a\u5c5e\u6027\u7684\u503c\u4f1a\u53d8\u6765\u53d8\u53bb\u5417\uff1f</p> <p>\u6bd4\u5982\u7b2c\u4e00\u6b21\u7528 Terraform \u521b\u5efa\u670d\u52a1\u5668\uff0c\u5b83\u540d\u5b57\u662f\u201c\u60ca\u8bb6\u7684\u82b1\u6817\u9f20\u201d\uff0c\u7b2c\u4e8c\u6b21\u8fd0\u884c\uff0c\u5b83\u7684\u540d\u5b57\u53d8\u4e3a \u201c\u5a01\u4e25\u7684\u8001\u864e\u201d\uff0c\u7b2c\u4e09\u6b21\u8fd0\u884c\uff0c\u5b83\u53d8\u4e3a \u201d\u6fb3\u6d32\u8003\u62c9\u201c\u3002</p> <p>\u4ea6\u6216\u7b2c\u4e00\u6b21\u8fd0\u884c Terraform \u521b\u5efa\u6570\u636e\u5e93\uff0c\u5b83\u7684\u5bc6\u7801\u662f \u201cNiceWork123\u201d\uff0c\u7b2c\u4e8c\u6b21\u8fd0\u884c\u540e\uff0c\u5bc6\u7801\u88ab\u66f4\u65b0\u4e3a \u201cYouAreAwesome123\u201d\uff0c\u7b2c\u4e09\u6b21\u8fd0\u884c\u540e\uff0c\u5bc6\u7801\u53c8\u88ab\u66f4\u65b0\u3002</p> <p>\u5b9e\u9a8c\u53d1\u73b0\uff0c\u91cd\u590d\u8fd0\u884c <code>Terraform apply</code> \u540e\uff0c\u670d\u52a1\u5668\u7684\u540d\u5b57\u5e76\u6ca1\u6709\u53d8\u6765\u53d8\u53bb\u3002</p> <p>\u539f\u6765 Terraform \u628a random \u751f\u6210\u7684\u503c\u4fdd\u5b58\u5230\u4e86 <code>terrraform.tfstate</code> \u4e2d\u3002</p> <ul> <li>\u5b83\u7528 random \u51fd\u6570\u521b\u5efa\u4e86\u4e00\u4e2a\u503c\u3002</li> <li>\u7136\u540e\u628a\u503c\u4fdd\u5b58\u5230 terraform state \u4e2d\u3002</li> <li>\u8fd9\u4e2a\u8d44\u6e90\u7684\u503c\u53ef\u4ee5\u88ab\u5176\u4ed6\u8d44\u6e90\u5f15\u7528</li> <li>\u6bcf\u6b21\u8fd0\u884c\u65f6\u8bfb\u53d6\u6587\u4ef6\u4e2d\u7684\u503c\u3002</li> </ul> <pre><code>// terraform.tfstate\n// \u7701\u7565\u65e0\u5173\u4ee3\u7801\n...\n    {\n      \"mode\": \"managed\",\n      \"type\": \"random_pet\",\n      \"name\": \"server\",\n      \"provider\": \"provider[\\\"registry.terraform.io/hashicorp/random\\\"]\",\n      \"instances\": [\n        {\n          \"schema_version\": 0,\n          \"attributes\": {\n            \"id\": \"amazed-chipmunk\",\n            \"keepers\": null,\n            \"length\": 2,\n            \"prefix\": null,\n            \"separator\": \"-\"\n          },\n          \"sensitive_attributes\": [],\n          \"private\": \"bnVsbA==\"\n        }\n      ]\n    }\n...\n// \u7701\u7565\u65e0\u5173\u4ee3\u7801\n</code></pre>"},{"location":"chap5/6terraform_int/","title":"6 Top Terraform Interview Questions and Answers (2022)","text":""},{"location":"chap5/6terraform_int/#1-what-is-terraform","title":"1 What is Terraform?","text":"<p>Terraform is a tool for creating, updating, and versioning infrastructure securely and efficiently. </p> <p>Terraform is capable of managing both current and popular service providers, as well as custom in-house solutions. </p> <p>Configuration files notify Terraform which components are required to run a single application or an entire datacenter.</p> <p>Terraform helps you Manage All of Your Infrastructure as Infrastructure as Code and promote Self-Service Infrastructure allows you to construct infrastructure as needed :</p> <ul> <li>Terraform code is written in the HCL programming language.</li> <li>Stop constructing things by hand.</li> <li>Put everything into a Terraform setup that can be repeated.</li> <li>All of the build steps are now written in code.</li> <li>It's a lot easier if you ever have to rebuild something!</li> </ul>"},{"location":"chap5/6terraform_int/#2-what-are-the-key-features-of-terraform","title":"2 What are the key features of Terraform","text":"<p>Below are the key features of Terraform:</p> <ul> <li>Infrastructure as Code: A high-level configuration syntax is used to define infrastructure.</li> <li>Execution Plans: Terraform generates an execution plan during the \"planning\" phase.</li> <li>Resource Graph</li> <li>Change Automation</li> </ul>"},{"location":"chap5/6terraform_int/#3-what-are-most-useful-terraform-commands","title":"3 What are most useful terraform commands?","text":"<p>Below are the key commands of Terraform:</p> <pre><code>terraform init    # Initialize the current directory\nterraform plan    # Dry run to see what Terraform will do\nterraform apply   # Apply the Terraform code and build stuff\nterraform destroy # Destroy what was built by Terraform\nterraform refresh # Refresh the state file\nterraform output  # View Terraform outputs\nterraform graph   # Create a DOT-formatted graph\n</code></pre>"},{"location":"chap5/6terraform_int/#4-what-is-terraform-cloud","title":"4 What is Terraform Cloud","text":"<p>Terraform Cloud is a hosted application that includes remote state management, API-driven runs, policy management, and other capabilities. </p> <p>Many users prefer a SaaS solution that is hosted in the cloud since they do not want to manage the infrastructure required to run it.</p>"},{"location":"chap5/6terraform_int/#5-what-is-terraform-cloud-for-business","title":"5 What is Terraform Cloud for Business","text":"<p>Terraform Cloud for Business uses the same hosted environment as Terraform Cloud, but with additional features for larger teams. Single sign-on, audit logging, and the ability to Terraform on-premise resources from the cloud are just a few of the features available.</p>"},{"location":"chap5/6terraform_int/#6-what-is-terraform-enterprise","title":"6 What is Terraform Enterprise","text":"<p>Terraform Enterprise is the same tool, but it runs in your own data centre or cloud environment. </p> <p>Some users want more control over the Terraform Cloud application, or they want to execute it behind corporate firewalls in restricted networks.</p>"},{"location":"chap5/6terraform_int/#7-what-is-module-in-terraform","title":"7 What is module in terraform?","text":"<p>A module is a container for several resources that are used in conjunction with one another. Modules can be used to construct lightweight abstractions, allowing you to define the infrastructure in terms of architecture instead of physical objects.</p> <p>\u6a21\u5757\u662f\u591a\u4e2a\u8d44\u6e90\u7684\u5bb9\u5668\uff0c\u8fd9\u4e9b\u8d44\u6e90\u76f8\u4e92\u7ed3\u5408\u4f7f\u7528\u3002\u6a21\u5757\u53ef\u7528\u4e8e\u6784\u5efa\u8f7b\u91cf\u7ea7\u62bd\u8c61\uff0c\u5141\u8bb8\u60a8\u6839\u636e\u67b6\u6784\u800c\u4e0d\u662f\u7269\u7406\u5bf9\u8c61\u6765\u5b9a\u4e49\u57fa\u7840\u67b6\u6784\u3002</p> <p>A Terraform module is a set of Terraform configuration files contained within a single directory. </p> <p>Or a basic configuration with a single directory having one or more .tf file is a module. When Terraform commands are run directly from such a directory, it is referred to as the root module.</p> <p>In this way, each Terraform configuration is a module. You may have a basic collection of Terraform configuration files like:</p> <pre><code>.\n|--- LICENSE\n|--- README.md\n|--- main.tf\n|--- variables.tf\n|--- output.tf\n</code></pre>"},{"location":"chap5/6terraform_int/#8-what-is-private-module-registry","title":"8 What is Private Module Registry?","text":"<p>Terraform Cloud provides a Private Module Registry, which allows you to store, version, and distribute modules to your organisations and teams.</p>"},{"location":"chap5/6terraform_int/#9-what-is-main-tf-in-terraform","title":"9 What is main TF in terraform?","text":"<p><code>main.tf</code> contains the primary configuration for your module.</p> <p>You can also build additional configuration files and arrange them in some helpful way for your project.</p> <p>Variable definitions for your module will be stored in variables.tf.</p>"},{"location":"chap5/6terraform_int/#10-how-do-you-call-a-main-tf-module","title":"10 How do you call a main TF module?","text":"<p>When you run terraform plan or terraform apply, the<code>.tf</code> files in your working directory combine to form the root module. </p> <p>This module will call other modules and bind them by transferring output values from one to input values from another.</p>"},{"location":"chap5/6terraform_int/#11-what-language-does-terraform-use","title":"11  What language does terraform use?","text":"<p>Terraform configuration syntax is known as HashiCorp Configuration Language (HCL). It is designed to be both human-readable and editable, as well as machine-friendly. </p> <p>Terraform can also read JSON configurations for machine-friendliness.</p>"},{"location":"chap5/6terraform_int/#12-how-does-terraform-integrate-with-github-and-public-cloud","title":"12 How does terraform integrate with github and public cloud?","text":"<p>The majority of businesses are migrating to the public cloud. Managing infrastructure in a secure and controlled manner is a critical step for businesses.</p>"},{"location":"chap5/6terraform_int/#13-what-is-terraform-state","title":"13 What is Terraform State?","text":"<p>Terraform keeps track of the resources it has created in a state file. </p> <p>This crucial file contains all of the information Terraform requires to change, update, and delete infrastructure.</p> <p>The state file is saved in your local workspace by default. We can use Terraform Cloud to store the state file as a Remote State on the cloud.</p>"},{"location":"chap5/6terraform_int/#14-what-are-the-disadvantages-of-maintaining-the-terraform-state-file-on-the-local-machine","title":"14 What are the disadvantages of maintaining the Terraform state file on the local machine?","text":"<ul> <li>State file sometimes contains secrets or sensitive data may be exposed</li> <li>We are unable to collaborate with the team because the file is on someone's laptop.</li> <li>On a local machine, there is a possibility of losing or deleting the state file.</li> <li>There is no centralised record keeping to track historical developments.</li> </ul>"},{"location":"chap5/6terraform_int/#15-what-exactly-is-sentinel","title":"15 What exactly is Sentinel?","text":"<p>Sentinel is the policy enforcement language used by HashiCorp. Sentinel policies are validated when the Terraform plan is executed. Sentinel will detect incorrect settings before they reach production, not later.</p> <p></p> <p>We can choose the scope of Sentinel policies that will be enforced at the Organization or Workspace level.</p> <pre><code># Restricting region in GCP\ngoogle_region_valid = rule {\n  all region_values as rv {\n    rv == \"us-west-1\"\n  }\n}\n</code></pre>"},{"location":"chap5/6terraform_int/#16-what-exactly-do-you-mean-when-you-say-policy-as-code","title":"16 What exactly do you mean when you say Policy-as-Code?","text":"<ul> <li>Treat policies as applications</li> <li>Store in version control</li> <li>Proactive vs. reactive</li> <li>Automate enforcement and review</li> <li>Automate logic testing</li> </ul>"},{"location":"chap5/6terraform_int/#17-can-you-provide-few-examples-where-we-can-use-for-sentinel-policies","title":"17 Can you provide few examples where we can use for Sentinel policies?","text":"<p>Sentinel is a powerful tool that can be used to implement a variety of policies. Here are a few examples:</p> <p>Security Standards</p> <ul> <li>Forbid or allow only certain resources, providers or data sources</li> <li>Restrict roles the cloud provider can assume</li> <li>Restrict roles the cloud provider can assume</li> </ul> <p>Audit Tracking</p> <ul> <li>Review an audit trail for Terraform Cloud operations</li> <li>Enforce explicit ownership in resources</li> </ul> <p>Resource Restriction</p> <ul> <li>Limit the size of VMs and clusters for cost</li> <li>Enforce mandatory tagging on resources built with Terraform</li> <li>Restrict modules to your organizations Private Module Registry</li> </ul>"},{"location":"chap5/6terraform_int/#18-what-are-the-various-levels-of-sentinel-enforcement","title":"18 What are the various levels of sentinel enforcement?","text":"<p>Sentinel is a powerful tool that can be used to implement a variety of policies. Here are a few examples:</p> <p>Advisory</p> <ul> <li>Logged but allowed to pass</li> <li>When a user triggers a plan that violates the policy, an advisory is issued to the user.</li> </ul> <p>Soft-Mandatory</p> <ul> <li>Teams based permissions for overrides</li> <li>Overrides logged for audit if the policy fails</li> <li>Prevents non-compliant infrastructure from being deployed by regular users. Only administrators have the ability to overrule.</li> </ul> <p>Hard-Mandatory</p> <ul> <li>Default enforcement level</li> <li>The policy must pass</li> <li>Only way to override is to explicitly remove the policy</li> <li>Prevents non-compliant infrastructure from being deployed by all users and apps.</li> </ul>"},{"location":"chap5/6terraform_int/#19-why-write-tests-for-sentinel-policies","title":"19 Why write tests for Sentinel policies?","text":"<ul> <li>Policies and infrastructure are prone to change for refactoring.</li> <li>Writing tests assures that your policy will continue to work as intended even if things change.</li> <li>Writing testing instils trust in the policymaking process.</li> </ul>"},{"location":"chap5/6terraform_int/#20-what-are-best-practices-in-policy-repo-management","title":"20 What are best practices in Policy Repo Management?","text":""},{"location":"chap5/6terraform_int/#21-how-to-store-sensitive-data-in-terraform","title":"21 How to Store Sensitive Data in Terraform?","text":"<p>In order to communicate with your cloud provider's API, Terraform requires credentials.</p> <p>Although config files and environment variables are a preferable alternative, the credentials are still saved in plaintext on your desktop.</p> <p>Sensitive Variable is Secure Place for API Credentials : Terraform Cloud can securely store and encrypt your passwords. This encrypted storage can be used to store passwords, TLS certificates, SSH keys, and anything else that shouldn't be stored in plain text.</p>"},{"location":"chap5/6terraform_int/#22-explain-what-terraform-is-and-how-does-it-works","title":"22 Explain what Terraform is and how does it works","text":"<p>Terraform.io: \"Terraform is an infrastructure as code (IaC) tool that allows you to build, change, and version infrastructure safely and efficiently.\"</p>"},{"location":"chap5/6terraform_int/#23-why-one-would-prefer-using-terraform-and-not-other-technologies-eg-ansible-puppet-cloudformation","title":"23 Why one would prefer using Terraform and not other technologies? (e.g. Ansible, Puppet, CloudFormation)","text":"<p>The benefits of Terraform over the other tools:</p> <ul> <li>It follows the immutable infrastructure approach which has benefits like avoiding a configuration drift over time</li> <li>Ansible and Puppet are more procedural (you mention what to execute in each step) and Terraform is declarative since you describe the overall desired state and not per resource or task. <ul> <li>You can give the example of going from 1 to 2 servers in each tool. In Terraform you specify 2, in Ansible and puppet you have to only provision 1 additional server so you need to explicitly make sure you provision only another one server.</li> </ul> </li> </ul>"},{"location":"chap5/6terraform_int/#24-how-do-you-structure-your-terraform-projects","title":"24 How do you structure your Terraform projects?","text":"<p><code>terraform_directory providers.tf</code> -&gt; List providers (source, version, etc.) <code>variables.tf</code> -&gt; any variable used in other files such as main.tf main.tf -&gt; Lists the resources</p>"},{"location":"chap5/6terraform_int/#25-true-or-false-terraform-follows-the-mutable-infrastructure-paradigm","title":"25 True or False? Terraform follows the mutable infrastructure paradigm","text":"<p>False. Terraform follows immutable infrastructure paradigm.</p>"},{"location":"chap5/6terraform_int/#26-true-or-false-terraform-uses-declarative-style-to-describe-the-expected-end-state","title":"26 True or False? Terraform uses declarative style to describe the expected end state","text":"<p>True</p>"},{"location":"chap5/6terraform_int/#27-what-is-hcl","title":"27 What is HCL?","text":"<p>HCL stands for Hashicorp Configuration Language. It is the language Hashicorp made to use as the configuration language for a number of its tools, including terraform.</p>"},{"location":"chap5/6terraform_int/#terraform-resources","title":"Terraform - Resources","text":""},{"location":"chap5/6terraform_int/#what-is-a-resource","title":"What is a \"resource\"?","text":"<p>\"Terraform uses resource blocks to manage infrastructure, such as virtual networks, compute instances, or higher-level components such as DNS records. Resource blocks represent one or more infrastructure objects in your Terraform configuration.\"</p>"},{"location":"chap5/6terraform_int/#explain-each-part-of-the-following-line-resource-aws_instance-web_server","title":"Explain each part of the following line: <code>resource \"aws_instance\" \"web_server\" {...}</code>","text":"<ul> <li>resource: keyword for defining a resource</li> <li><code>\"aws_instance\"</code>: the type of the resource</li> <li><code>\"web_server\"</code>: the name of the resource</li> </ul>"},{"location":"chap5/6terraform_int/#what-is-the-id-of-the-following-resource-resource-aws_instance-web_server","title":"What is the ID of the following resource: <code>resource \"aws_instance\" \"web_server\" {...}</code>","text":"<p><code>aws_instance.web_server</code></p>"},{"location":"chap5/6terraform_int/#how-would-you-enforce-users-that-use-your-variables-to-provide-values-with-certain-constraints-for-example-a-number-greater-than-1","title":"How would you enforce users that use your variables to provide values with certain constraints? For example, a number greater than 1","text":"<p>Using validation block</p> <pre><code>variable \"some_var\" {\n  type = number\n\n  validation {\n    condition = var.some_var &gt; 1\n    error_message = \"you have to specify a number greater than 1\"\n  }\n\n}\n</code></pre>"},{"location":"chap5/6terraform_int/#the-same-variable-is-defined-in-the-following-places","title":"The same variable is defined in the following places:","text":"<ul> <li>The file <code>terraform.tfvars</code></li> <li>Environment variable</li> <li>Using <code>-var</code> or <code>-var-file</code></li> </ul>"},{"location":"chap5/6terraform_int/#what-terraformtfstate-file-is-used-for","title":"What <code>terraform.tfstate</code> file is used for?","text":"<p>It keeps track of the IDs of created resources so that Terraform knows what it's managing.</p>"},{"location":"chap5/6terraform_int/#how-do-you-rename-an-existing-resource","title":"How do you rename an existing resource?","text":"<pre><code>terraform state mv\n</code></pre>"},{"location":"chap5/6terraform_int/#mention-some-best-practices-related-to-tfstate","title":"Mention some best practices related to tfstate","text":"<ul> <li>Don't edit it manually. tfstate was designed to be manipulated by terraform and not by users directly.</li> <li>Store it in secured location (since it can include credentials and sensitive data in general)</li> <li>Backup it regularly so you can roll-back easily when needed</li> <li>Store it in remote shared storage. This is especially needed when working in a team and the state can be updated by any of the team members</li> <li>Enabled versioning if the storage where you store the state file, supports it. Versioning is great for backups and roll-backs in case of an issue.</li> </ul>"},{"location":"chap5/6terraform_int/#what-is-a-tainted-resource","title":"What is a \"tainted resource\"?","text":"<p>It's a resource which was successfully created but failed during provisioning. Terraform will fail and mark this resource as \"tainted\".</p>"},{"location":"chap5/6terraform_int/#what-terraform-taint-does","title":"What terraform taint does?","text":"<p>**<code>terraform taint resource.id</code> manually marks the resource as tainted in the state file. **</p> <p>So when you run terraform apply the next time, the resource will be destroyed and recreated.</p>"},{"location":"chap5/6terraform_int/#what-is-a-data-source-in-what-scenarios-for-example-would-need-to-use-it","title":"What is a data source? In what scenarios for example would need to use it?","text":"<p>Data sources lookup or compute values that can be used elsewhere in terraform configuration.</p> <p>There are quite a few cases you might need to use them:</p> <ul> <li>you want to reference resources not managed through terraform</li> <li>you want to reference resources managed by a different terraform module</li> <li>you want to cleanly compute a value with typechecking, such as with <code>aws_iam_policy_document</code></li> </ul>"},{"location":"chap5/6terraform_int/#explain-state-locking","title":"Explain \"State Locking\"","text":"<p>State locking is a mechanism that blocks an operations against a specific state file from multiple callers so as to avoid conflicting operations from different team members. Once the first caller's operation's lock is released the other team member may go ahead to carryout his own operation. Nevertheless Terraform will first check the state file to see if the desired resource already exist and if not it goes ahead to create it.</p> <p>\u72b6\u6001\u9501\u5b9a\u662f\u4e00\u79cd\u963b\u6b62\u6765\u81ea\u591a\u4e2a\u8c03\u7528\u8005\u5bf9\u7279\u5b9a\u72b6\u6001\u6587\u4ef6\u7684\u64cd\u4f5c\u7684\u673a\u5236\uff0c\u4ee5\u907f\u514d\u6765\u81ea\u4e0d\u540c\u56e2\u961f\u6210\u5458\u7684\u51b2\u7a81\u64cd\u4f5c\u3002\u4e00\u65e6\u7b2c\u4e00\u4e2a\u8c03\u7528\u8005\u7684\u64cd\u4f5c\u7684\u9501\u88ab\u91ca\u653e\uff0c\u5176\u4ed6\u56e2\u961f\u6210\u5458\u5c31\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u4ed6\u81ea\u5df1\u7684\u64cd\u4f5c\u3002\u5c3d\u7ba1\u5982\u6b64\uff0cTerraform \u5c06\u9996\u5148\u68c0\u67e5\u72b6\u6001\u6587\u4ef6\u4ee5\u67e5\u770b\u6240\u9700\u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u5b58\u5728\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u7ee7\u7eed\u521b\u5efa\u5b83\u3002</p>"},{"location":"chap5/6terraform_int/#what-is-terraform-import","title":"What is Terraform import?","text":"<p>Terraform import is used to import existing infrastructure. It allows you to bring resources created by some other means (eg. manually launched cloud resources) and bring it under Terraform management.</p>"},{"location":"chap5/6terraform_int/#how-do-you-import-existing-resource-using-terraform-import","title":"How do you import existing resource using Terraform import?","text":"<ul> <li>Identify which resource you want to import.</li> <li>Write terraform code matching configuration of that resource.</li> <li>Run terraform command <code>terraform import RESOURCE ID</code></li> </ul> <p>Let's say you want to import an aws instance. Then you'll perform following:</p> <ul> <li>Identify that aws instance in console</li> <li>Refer to it's configuration and write Terraform code which will look something like:</li> </ul> <pre><code>resource \"aws_instance\" \"tf_aws_instance\" {\n  ami           = data.aws_ami.ubuntu.id\n  instance_type = \"t3.micro\"\n\n  tags = {\n    Name = \"import-me\"\n  }\n}\n</code></pre> <p>Run terraform command <code>terraform import aws_instance.tf_aws_instance i-12345678</code></p>"},{"location":"chap5/7terraform_provider/","title":"Terraform provider update","text":"<p>https://www.terraform.io/internals/provider-registry-protocol</p> <pre><code>$ terraform init\nInitializing modules...\n\nInitializing the backend...\n...\n\u2502 Error: Invalid legacy provider address\n\u2502 \n\u2502 This configuration or its associated state refers to the unqualified provider \"azurerm\".\n\u2502 \n\u2502 You must complete the Terraform 0.13 upgrade process before upgrading to later versions.\n</code></pre> <pre><code>$ terraform providers\n\nProviders required by configuration:\n.\n\u251c\u2500\u2500 provider[registry.terraform.io/hashicorp/azurerm] 2.10.0\n\u251c\u2500\u2500 module.storageaccount\n\u2502   \u2514\u2500\u2500 provider[registry.terraform.io/hashicorp/azurerm]\n\u251c\u2500\u2500 module.subnet\n\u2502   \u2514\u2500\u2500 provider[registry.terraform.io/hashicorp/azurerm]\n\u251c\u2500\u2500 module.cdn\n\u2502   \u2514\u2500\u2500 provider[registry.terraform.io/hashicorp/azurerm]\n\u2514\u2500\u2500 module.database\n    \u2514\u2500\u2500 provider[registry.terraform.io/hashicorp/azurerm]\n\nProviders required by state:\n\n    provider[registry.terraform.io/-/azurerm]\n</code></pre> <pre><code>$ terraform state replace-provider registry.terraform.io/-/azurerm registry.terraform.io/hashicorp/azurerm\nAcquiring state lock. This may take a few moments...\nTerraform will perform the following actions:\n\n  ~ Updating provider:\n    - registry.terraform.io/-/azurerm\n    + registry.terraform.io/hashicorp/azurerm\n ...\n</code></pre> <pre><code>$ terraform state replace-provider registry.terraform.io/-/azurerm registry.terraform.io/hashicorp/azurerm\n</code></pre> <pre><code> terraform init \nInitializing modules...\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding hashicorp/aws versions matching \"~&gt; 2.70\"...\n- Finding latest version of hashicorp/azurerm...\n- Installing hashicorp/aws v2.70.1...\n- Installed hashicorp/aws v2.70.1 (signed by HashiCorp)\n- Installing hashicorp/azurerm v3.1.0...\n- Installed hashicorp/azurerm v3.1.0 (signed by HashiCorp)\n\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run \"terraform init\" in the future.\n</code></pre> <pre><code># This file is maintained automatically by \"terraform init\".\n# Manual edits may be lost in future updates.\n\nprovider \"registry.terraform.io/hashicorp/aws\" {\n  version     = \"2.70.1\"\n  constraints = \"~&gt; 2.70\"\n  hashes = [\n    \"h1:B+Cs8HwWnLn9ymYI/r3B5S10w1+hOD5WmfFxiLHTUIA=\",\n    \"zh:04137cdf128cf21dcd190bbba4d4bba43c7868c52ad646b0eaa54a8b8b8160a7\",\n    \"zh:30c9f956133a102b4a426d76dd3ef1a42332d9875261a06aa877409aa6b2b556\",\n    \"zh:3107a43647454a3d6d847fba6aa593650af0f6a353272c04450408af5f4d353a\",\n    \"zh:3f17285478313af822447b453fa4e37f30ef221f0b0e8f2e4655f1ac9f9de1a2\",\n    \"zh:5a626f7a3c4a9fea3bdfde63aedbf6eea73760f3b228f776f1132b61d00c7ff2\",\n    \"zh:6aafc9dd79b511b9e3d0ec49f7df1d1fd697c3c873d1d70a2be1a12475b50206\",\n    \"zh:6fb29b48ccc85f7e9dfde3867ce99d6d65fb76bea68c97d404fae431758a8f03\",\n    \"zh:c47be92e1edf2e8675c932030863536c1a79decf85b2baa4232e5936c5f7088f\",\n    \"zh:cd0a4b28c5e4b5092043803d17fd1d495ecb926c2688603c4cdab4c20f3a91f4\",\n    \"zh:fb0ff763cb5d7a696989e58e0e4b88b1faed2a62b9fb83f4f7c2400ad6fabb84\",\n  ]\n}\n\nprovider \"registry.terraform.io/hashicorp/azurerm\" {\n  version = \"3.1.0\"\n  hashes = [\n    \"h1:XuBendit3GIKmev2A9YpdxDxBO+FeUxnzrcPNLK/aVY=\",\n    \"zh:39f925413e88c608f5319e01a540505d5ac4a1aa3073ad31823f5e9f8a00aafa\",\n    \"zh:3a4d42ee0b1b5ae76949a25b2d2ca11ac98f3ae483b407e56d48ba4bd6f249be\",\n    \"zh:5f220c18ebf2f848450b34f1f12a946e3e7b0585c7681eb6135be7e4658d8c0c\",\n    \"zh:7e176275fbb87987ef84515a588b4a5a5a692b3c2ae31171cbec0a0c977c8e64\",\n    \"zh:8980a4f2aca62b3833c12999abdc090a850a22cb88ef7e80fe6f33d6e688dc78\",\n    \"zh:a3c5da6f59afd566b77b789bfc2d4acddc7bf4c777fab9fc2483c1580143e1e0\",\n    \"zh:a9db6d2aec9bb17f08f3bac940ae313dd8d9e83726e71b27daeffca39eca7e67\",\n    \"zh:db5d31bade0ee02d33f620b266de435e630defd91f0b79398b94163fdaa6a3af\",\n    \"zh:e6d22de2fc2cd61a2d72d306d62c212aedc2667564e02915723f92775289cda5\",\n    \"zh:e92b6e64601cffbf891558047a6effeaacb1180df993270ecbab2a9f7f964c03\",\n    \"zh:fd40d50a64109b26f6db0178ce4a2f78e81a709ad4b1728c7d923b5e5c551cde\",\n  ]\n}\n</code></pre>"},{"location":"chap5/8terraform_docker_jenkins/","title":"Terraform install Jenkins in Docker","text":"<p>Terraform \u662f\u7531 HashiCorp \u6240\u5f00\u53d1\u7684\u81ea\u52a8\u5316\u5de5\u5177\uff0c\u662f\u4e00\u4e2a\u4e13\u6ce8\u5728 Infrastructure as code(\u57fa\u7840\u8bbe\u65bd\u5373\u4ee3\u7801)\u7684\u7ba1\u7406\u5de5\u5177\u3002</p> <p></p> <p></p>"},{"location":"chap5/8terraform_docker_jenkins/#terraform-with-docker","title":"Terraform with docker","text":"<p>What is docker Terraform provider</p> <p>The Docker provider is used to interact with Docker containers and images. It uses the Docker API to manage the lifecycle of Docker containers. Because the Docker provider uses the Docker API, it is immediately compatible not only with single server Docker but Swarm and any additional Docker-compatible API hosts.</p> <p>Terraform 0.13 and later:</p> <p>Terraform need to upgrade to 0.13</p>"},{"location":"chap5/8terraform_docker_jenkins/#terraform-install-jenkins-with-docker","title":"Terraform install Jenkins with Docker","text":"<p><code>required_providers</code>: kreuzwerker/docker</p> <p><code>main.tf</code></p> <pre><code>terraform {\n  required_providers {\n    docker = {\n      source  = \"kreuzwerker/docker\"\n      version = \"2.16.0\"\n    }\n  }\n}\n\nprovider \"docker\" {}\n  # host = \"remote host\"\n  # host = \"tcp://192/169.1.200:2375\"\n  # host = \"unix:///var/run/docker.sock\"\n</code></pre> <ul> <li>\u5982\u679c\u5b9e\u5728\u672c\u5730\u8dd1\uff0c host \u503c\u53ef\u4ee5\u5ffd\u7565</li> <li>\u5982\u679c\u662f\u8fdc\u7a0b\u8dd1\u7684\u8bdd\uff0c\u9700\u8981\u52a0\u4e0ahost\u7684IP\u5df2\u7ecf\u7aef\u53e3</li> </ul>"},{"location":"chap5/8terraform_docker_jenkins/#jenkinstf","title":"<code>jenkins.tf</code>","text":"<pre><code>resource \"docker_image\" \"jekins\" {\n  name         = \"jenkins/jenkins:2.332.2-centos7-jdk8\"\n  keep_locally = true // Destroy will not delete local image\n}\n\nresource \"docker_container\" \"jenkins\" {\n  image = docker_image.jekins.name\n  name  = \"docker_jenkins\"\n  ports {\n    internal = 8080\n    external = 8080\n  }\n  ports {\n    internal = 50000\n    external = 50000 # for agent connection\n  }\n  volumes {\n    container_path = \"/var/jenkins_home\"\n    host_path      = \"/tmp/jenkins_home\"\n    # chmod 777 /tmp/jenkins_home\n  }\n}\n</code></pre> <ul> <li><code>keep_locally</code> (Boolean) If true, then the Docker image won't be deleted on destroy operation. If this is false, it will delete the image from the docker local storage on destroy operation.</li> <li><code>host_path</code>:  \u672c\u5730\u5b9a\u4e49\uff0c \u4f5c\u4e3a\u6301\u4e45\u5316\u76ee\u5f55</li> </ul>"},{"location":"chap5/8terraform_docker_jenkins/#init","title":"\u8fd0\u884cinit\u6574\u4e2a\u76ee\u5f55","text":"<pre><code>$ terraform init \n\nInitializing the backend...\n\nInitializing provider plugins...\n- Reusing previous version of kreuzwerker/docker from the dependency lock file\n- Using previously-installed kreuzwerker/docker v2.16.0\n\nTerraform has been successfully initialized!\n\nYou may now begin working with Terraform. Try running \"terraform plan\" to see\nany changes that are required for your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever set or change modules or backend configuration for Terraform,\nrerun this command to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to do so if necessary.\n</code></pre> <pre><code>$ tree\n.\n\u251c\u2500\u2500 jenkins.tf\n\u251c\u2500\u2500 main.tf\n\u251c\u2500\u2500 terraform.tfstate\n\u2514\u2500\u2500 terraform.tfstate.backup\n\n0 directories, 4 files\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6<code>.terraform.lock.hcl</code>, <code>terraform.tfstate</code>\u548c<code>terraform.tfstate.bak</code></p> <ul> <li><code>terraform.lock.hcl</code>\u4f1a\u9501\u5b9a provider \u7684\u7248\u672c</li> <li><code>terraform.tfstate</code> \u4f1a\u4fdd\u6301 terraform \u7684\u72b6\u6001\u4fe1\u606f</li> </ul>"},{"location":"chap5/8terraform_docker_jenkins/#apply","title":"\u8fd0\u884capply\uff0c\u521b\u5efa\u9879\u76ee","text":"<ul> <li>\u9996\u5148\u5148\u770b<code>terraform plan</code>, \u4f1a\u8f93\u51fa\u7684\u7684\u521b\u5efa\u7ed3\u679c<ul> <li>docker container</li> <li>ports</li> <li>volumes</li> </ul> </li> </ul> <pre><code>$ terraform plan \n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n...\n\n  # docker_image.jekins will be created\n  + resource \"docker_image\" \"jekins\" {\n      + id           = (known after apply)\n      + keep_locally = true\n      + latest       = (known after apply)\n      + name         = \"jenkins/jenkins:2.332.2-centos7-jdk8\"\n      + output       = (known after apply)\n      + repo_digest  = (known after apply)\n    }\n\nPlan: 2 to add, 0 to change, 0 to destroy.\n</code></pre> <ul> <li><code>terraform apply</code> \u521b\u5efajenkins \u670d\u52a1</li> </ul> <pre><code>$ terraform apply\n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  # docker_container.jenkins will be created\n  + resource \"docker_container\" \"jenkins\" {\n      ...\n\n      + ports {\n          + external = 8080\n          + internal = 8080\n          + ip       = \"0.0.0.0\"\n          + protocol = \"tcp\"\n        }\n      + ports {\n          + external = 50000\n          + internal = 50000\n          + ip       = \"0.0.0.0\"\n          + protocol = \"tcp\"\n        }\n\n      + volumes {\n          + container_path = \"/var/jenkins_home\"\n          + host_path      = \"/tmp/jenkins_home\"\n        }\n    }\n\n  # docker_image.jekins will be created\n  + resource \"docker_image\" \"jekins\" {\n      + id           = (known after apply)\n      + keep_locally = true\n      + latest       = (known after apply)\n      + name         = \"jenkins/jenkins:2.332.2-centos7-jdk8\"\n      + output       = (known after apply)\n      + repo_digest  = (known after apply)\n    }\n\nPlan: 2 to add, 0 to change, 0 to destroy.\n\nDo you want to perform these actions?\n  Terraform will perform the actions described above.\n  Only 'yes' will be accepted to approve.\n\n  Enter a value: yes\n\ndocker_image.jekins: Creating...\ndocker_image.jekins: Still creating... [10s elapsed]\n...\ndocker_image.jekins: Creation complete after 1m6s [id=sha256:0548d6c4555c748ace7a50448fff8ff5505e5bfdcc7611726d6eb9bb059f1e7ejenkins/jenkins:2.332.2-centos7-jdk8]\ndocker_container.jenkins: Creating...\ndocker_container.jenkins: Creation complete after 1s [id=53183d8421a2f3ad436eb224f7ccce12c9b877bef2893ac9e0462eec37a33080]\n\nApply complete! Resources: 2 added, 0 changed, 0 destroyed.\n</code></pre> <p>\u83b7\u53d6<code>initial-password</code></p> <pre><code>$ docker ps | grep jenkins\n53183d8421a2   jenkins/jenkins:2.332.2-centos7-jdk8   \"/sbin/tini -- /usr/\u2026\"   About a minute ago   Up About a minute   0.0.0.0:8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp   docker_jenkins\n\n$ docker exec -it 53183d8421a2 sh\nsh-4.2$ cd /var/jenkins_home/secrets/\nh-4.2$ less initialAdminPassword\nsh-4.2$ cat /var/jenkins_home/secrets/initialAdminPassword\ncd58e709806b44778f3a4d97c0864275\n</code></pre> <p></p>"},{"location":"chap5/8terraform_docker_jenkins/#destroy","title":"Destroy \u9879\u76ee","text":"<pre><code>$ terraform destroy\n</code></pre> <p>\u6211\u4eec\u4f1a\u53d1\u73b0Jenkins\u9879\u76ee\u76ee\u5f55\u6301\u4e45\u5316\u5230\u4e86\u672c\u5730\u76ee\u5f55</p> <pre><code>$ cd /tmp/jenkins_home\n$ ls\nconfig.xml                                      jenkins.model.JenkinsLocationConfiguration.xml  secret.key.not-so-secret\ncopy_reference_file.log                         jenkins.telemetry.Correlator.xml                secrets\nhudson.model.UpdateCenter.xml                   jobs                                            updates\nhudson.plugins.git.GitTool.xml                  nodeMonitors.xml                                userContent\nidentity.key.enc                                nodes                                           users\njenkins.install.InstallUtil.lastExecVersion     plugins                                         war\njenkins.install.UpgradeWizard.state             secret.key                                      workflow-libs\n</code></pre>"},{"location":"chap5/9terraform_local/","title":"\u89e3\u51b3Terraform\u521d\u59cb\u5316\u6162~\u914d\u7f6e\u672c\u5730\u79bb\u7ebf\u6e90","text":"<p>\u9700\u8981\u624b\u52a8\u6216\u8005terraform init\u4e00\u6b21\u4e0b\u8f7d\uff0c \u7136\u540e\u7f13\u5b58\u3002\u540e\u7eed\u76f4\u63a5\u4f7f\u7528\u7f13\u5b58\u3002</p> <p>\u672c\u6b21\u5b9e\u8df5\u4f7f\u7528\u7684\u662fLinux/Mac \u7cfb\u7edf\uff0c\u5982\u679c\u662fwindows\u7cfb\u7edf\u6709\u4e24\u70b9\u4e0d\u540c\u7684\u914d\u7f6e\u3002</p> <ul> <li>CLI\u914d\u7f6e\u6587\u4ef6\u7684\u540d\u79f0\u4e3a<code>terraform.rc</code></li> <li><code>plugin_cache_dir: D:/xxx/xxx</code></li> </ul>"},{"location":"chap5/9terraform_local/#1","title":"1. \u521b\u5efa\u914d\u7f6e\u6587\u4ef6","text":"<p><code>.terraformrc</code>\u662fTerraform CLI\u7684\u914d\u7f6e\u6587\u4ef6</p> <pre><code>plugin_cache_dir  = \"$HOME/.terraform.d/terraform-plugin-cache\" \ndisable_checkpoint = true\n</code></pre> <ul> <li><code>plugin_cache_dir</code> \u662f\u63d2\u4ef6\u7684\u7f13\u5b58\u76ee\u5f55\uff08\u6b64\u76ee\u5f55\u9700\u8981\u63d0\u524d\u521b\u5efa\u4e0d\u7136init\u62a5\u9519\uff09</li> <li><code>disable_checkpoint</code> \u7981\u7528 \u9700\u8981\u8fde\u63a5HashiCorp \u63d0\u4f9b\u7684\u7f51\u7edc\u670d\u52a1\u7684\u5347\u7ea7\u548c\u5b89\u5168\u516c\u544a\u68c0\u67e5</li> </ul> <pre><code>mkdir -p $HOME/.terraform.d/terraform-plugin-cache\n</code></pre> <p>\u6587\u4ef6\u521b\u5efa\u597d\u4e86\u4e4b\u540e\uff0c \u8981\u901a\u8fc7\u914d\u7f6e<code>TF_CLI_CONFIG_FILE</code>\u53d8\u91cf\uff0c\u8ba9TerraformCLI\u53ef\u4ee5\u52a0\u8f7d\u5230\u914d\u7f6e\u6587\u4ef6\u3002\u8fd9\u4e2a\u53d8\u91cf\u7684\u503c\u6ca1\u6709\u56fa\u5b9a\u914d\u7f6e\uff0c\u800c\u662f\u53d6\u51b3\u4e8e<code>.terraformrc</code>\u6587\u4ef6\u8def\u5f84\u3002</p> <pre><code>export TF_CLI_CONFIG_FILE=$HOME/Desktop/terraform/terraform-module-example/.terrafo\nrmrc\n</code></pre>"},{"location":"chap5/9terraform_local/#2","title":"2. \u8fdb\u884c\u521d\u59cb\u5316","text":"<p>\u63d2\u4ef6\u4e0b\u8f7d\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a</p> <p>\u901a\u8fc7 <code>terraform init</code> \u81ea\u52a8\u4e0b\u8f7dprovider \u63d2\u4ef6\uff1b</p> <p>\u767b\u5165<code>registry.terraform.io</code> \u624b\u52a8\u5230 GitHub\u4e0b\u8f7d\uff0c\u5e76\u6309\u7167\u76ee\u5f55\u7ed3\u6784\u5b58\u653e\u5230<code>plugin_cache_dir</code>;</p> <p>\u672c\u6b21\u6f14\u793a\u5148\u4f7f\u7528<code>terraform init</code>\u8fdb\u884c\u64cd\u4f5c\uff0c \u5982\u679c\u624b\u52a8\u5230registry\u4e0b\u8f7d\uff0c\u9700\u8981\u6309\u7167\u76ee\u5f55\u7ed3\u6784\u5b58\u653e\uff1b</p> <pre><code>terraform init\nInitializing modules...\n- mydns in ../../modules/dns\n- myecs in ../../modules/ecs\n- myssecgroup in ../../modules/secgroup\n- myvpc in ../../modules/vpc\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding hashicorp/alicloud versions matching \"1.164.0\"...\n- Installing hashicorp/alicloud v1.164.0...\n- Installed hashicorp/alicloud v1.164.0 (signed by HashiCorp)\n\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run \"terraform init\" in the future.\n</code></pre> <p>\u521d\u59cb\u5316\u4e4b\u540e\uff0c \u67e5\u770b<code>plugin_cache_dir</code>\u4e2d\u7684\u5185\u5bb9\uff1a <code>$HOME/.terraform.d/terraform-plugin-cache/registry.terraform.io/hashicorp/alicloud/1.164.0/darwin_arm64</code></p> <pre><code>\u279c  .terraform.d pwd\n/Users/lizeyang/.terraform.d\n\n\u279c  .terraform.d tree\n.\n|____checkpoint_cache\n|____checkpoint_signature\n|____terraform-plugin-cache\n| |____registry.terraform.io\n| | |____hashicorp\n| | | |____alicloud\n| | | | |____1.164.0\n| | | | | |____darwin_arm64\n| | | | | | |____terraform-provider-alicloud_v1.164.0\n</code></pre>"},{"location":"chap5/9terraform_local/#3","title":"3. \u6a21\u62df\u65ad\u7f51\uff0c\u79bb\u7ebf\u521d\u59cb\u5316","text":"<p>\u65b9\u6cd51\uff1a\u521d\u59cb\u5316\u65f6\u6307\u5b9a<code>plugin-dir</code></p> <p><code>terraform init --plugin-dir $HOME/.terraform.d/terraform-plugin-cache/</code></p> <pre><code>\nterraform init  --plugin-dir $HOME/.terraform.d/terraform-plugin-cache/\nInitializing modules...\n- mydns in ../../modules/dns\n- myecs in ../../modules/ecs\n- myssecgroup in ../../modules/secgroup\n- myvpc in ../../modules/vpc\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding hashicorp/alicloud versions matching \"1.164.0\"...\n- Using hashicorp/alicloud v1.164.0 from the shared cache directory\n\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run \"terraform init\" in the future.\n\nTerraform has been successfully initialized!\n</code></pre> <p>\u65b9\u6cd52\uff1a\u5b9a\u4e49Terraform\u63d2\u4ef6\u4f7f\u7528\u672c\u5730mirror</p> <pre><code>\nprovider_installation {\n  filesystem_mirror {\n    path    = \"/Users/lizeyang/.terraform.d/terraform-plugin-cache\"\n    include = [\"registry.terraform.io/*/*\"]\n  }\n}\n</code></pre> <pre><code>\u279c  dev terraform init\nInitializing modules...\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding hashicorp/alicloud versions matching \"1.164.0\"...\n- Using hashicorp/alicloud v1.164.0 from the shared cache directory\n\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run \"terraform init\" in the future.\n\nTerraform has been successfully initialized!\n</code></pre> <p>\u5230\u6b64\u5c31\u5b8c\u6210\u4e86terraform\u79bb\u7ebf\u672c\u5730\u6e90\u7684\u914d\u7f6e\u4e86\uff0c \u9664\u4e86\u8fd9\u79cd\u65b9\u5f0f\u5916\u5176\u5b9e\u4e5f\u53ef\u4ee5\u57fa\u4e8eterraform\u5f00\u653e\u7684HTTP API\u534f\u8bae\uff0c\u4f7f\u7528Python Flask\u5199\u4e00\u4e2aregistry server\u3002</p>"},{"location":"chap6_pp/10pp_api/","title":"10 Puppet - RESTful API","text":"<p>Puppet \u4f7f\u7528 RESTful API \u4f5c\u4e3a Puppet master \u548c Puppet \u4ee3\u7406\u4e4b\u95f4\u7684\u901a\u4fe1\u901a\u9053\u3002\u4ee5\u4e0b\u662f\u8bbf\u95ee\u6b64 RESTful API \u7684\u57fa\u672c URL\u3002</p> <pre><code>https://brcleprod001:8140/{environment}/{resource}/{key}\nhttps://brcleprod001:8139/{environment}/{resource}/{key}\n</code></pre>"},{"location":"chap6_pp/10pp_api/#rest-api","title":"REST API \u5b89\u5168","text":"<p>Puppet \u901a\u5e38\u8d1f\u8d23\u5b89\u5168\u6027\u548c SSL \u8bc1\u4e66\u7ba1\u7406\u3002\u4f46\u662f\uff0c\u5982\u679c\u5e0c\u671b\u5728\u96c6\u7fa4\u5916\u4f7f\u7528 RESTful API\uff0c\u5219\u9700\u8981\u5728\u5c1d\u8bd5\u8fde\u63a5\u5230\u673a\u5668\u65f6\u81ea\u884c\u7ba1\u7406\u8bc1\u4e66\u3002 Puppet \u7684\u5b89\u5168\u7b56\u7565\u53ef\u4ee5\u901a\u8fc7 rest authconfig \u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"chap6_pp/10pp_api/#rest-api_1","title":"\u6d4b\u8bd5 REST API","text":"<p>Curl \u5b9e\u7528\u7a0b\u5e8f\u53ef\u7528\u4f5c\u4f11\u606f RESTful API \u8fde\u63a5\u7684\u57fa\u672c\u5b9e\u7528\u7a0b\u5e8f\u3002\u4ee5\u4e0b\u662f\u6211\u4eec\u5982\u4f55\u4f7f\u7528 REST API curl comman \u68c0\u7d22\u8282\u70b9\u76ee\u5f55\u7684\u793a\u4f8b</p> <pre><code>curl --cert /etc/puppet/ssl/certs/brcleprod001.pem --key\n/etc/puppet/ssl/private_keys/brcleprod001.pem\n</code></pre> <p>\u5728\u4e0b\u9762\u7684\u4e00\u7ec4\u547d\u4ee4\u4e2d\uff0c\u6211\u4eec\u53ea\u662f\u8bbe\u7f6e SSL \u8bc1\u4e66\uff0c\u8fd9\u5c06\u6839\u636e SSL \u76ee\u5f55\u7684\u4f4d\u7f6e\u548c\u6b63\u5728\u4f7f\u7528\u7684\u8282\u70b9\u7684\u540d\u79f0\u800c\u6709\u6240\u4e0d\u540c\u3002\u4f8b\u5982\uff0c\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <pre><code>curl --insecure -H 'Accept: yaml'\nhttps://brcleprod002:8140/production/catalog/brcleprod001\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\uff0c\u6211\u4eec\u53ea\u9700\u53d1\u9001\u4e00\u4e2a\u6807\u5934\uff0c\u6307\u5b9a\u6211\u4eec\u60f3\u8981\u8fd4\u56de\u7684\u683c\u5f0f\u548c\u4e00\u4e2a\u7528\u4e8e\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u751f\u6210 brcleprod001 \u76ee\u5f55\u7684 RESTful URL\uff0c\u5c06\u751f\u6210\u4ee5\u4e0b\u8f93\u51fa\u3002</p> <pre><code>--- &amp;id001 !ruby/object:Puppet::Resource::Catalog\naliases: {}\napplying: false\nclasses: []\n...\n</code></pre> <p>\u8ba9\u6211\u4eec\u5047\u8bbe\u53e6\u4e00\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u60f3\u4ece Puppet Master \u90a3\u91cc\u53d6\u56de CA \u8bc1\u4e66\u3002\u5b83\u4e0d\u9700\u8981\u4f7f\u7528\u81ea\u5df1\u7b7e\u540d\u7684 SSL \u8bc1\u4e66\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\uff0c\u56e0\u4e3a\u8fd9\u662f\u5728\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u4e4b\u524d\u9700\u8981\u7684\u4e1c\u897f\u3002</p> <pre><code>curl --insecure -H 'Accept: s' https://brcleprod001:8140/production/certificate/ca\n\n-----BEGIN CERTIFICATE-----\nMIICHTCCAYagAwIBAgIBATANBgkqhkiG9w0BAQUFADAXMRUwEwYDVQQDDAxwdXBw\n</code></pre>"},{"location":"chap6_pp/10pp_api/#puppet-master-api","title":"Puppet Master \u548c\u4ee3\u7406\u5171\u4eab API \u53c2\u8003","text":"<pre><code>GET /certificate/{ca, other}\n\ncurl -k -H \"Accept: s\" https://brcelprod001:8140/production/certificate/ca\ncurl -k -H \"Accept: s\" https://brcleprod002:8139/production/certificate/brcleprod002\n</code></pre>"},{"location":"chap6_pp/10pp_api/#2-puppet-master-api","title":"2 Puppet Master API \u53c2\u8003","text":"<p>\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u8d44\u6e90\uff08\u9700\u8981\u6709\u6548\u7684\u7b7e\u540d\u8bc1\u4e66\uff09</p>"},{"location":"chap6_pp/10pp_api/#catalogs","title":"Catalogs","text":"<pre><code>GET /{environment}/catalog/{node certificate name}\n\ncurl -k -H \"Accept: pson\" https://brcelprod001:8140/production/catalog/myclient\n</code></pre>"},{"location":"chap6_pp/10pp_api/#certificate-request","title":"Certificate Request","text":"<pre><code>GET /{environment}/certificate_requests/{anything} GET\n/{environment}/certificate_request/{node certificate name}\n\ncurl -k -H \"Accept: yaml\" https://brcelprod001:8140/production/certificate_requests/all\ncurl -k -H \"Accept: yaml\" https://brcleprod001:8140/production/certificate_request/puppetclient\n</code></pre>"},{"location":"chap6_pp/10pp_api/#reports-submit-a-report","title":"Reports Submit a Report","text":"<pre><code>PUT /{environment}/report/{node certificate name}\ncurl -k -X PUT -H \"Content-Type: text/yaml\" -d \"{key:value}\" https://brcleprod002:8139/production\n</code></pre>"},{"location":"chap6_pp/10pp_api/#node-facts-regarding-a-specific-node","title":"Node \u2212 Facts Regarding a Specific Node","text":"<pre><code>GET /{environment}/node/{node certificate name}\n\ncurl -k -H \"Accept: yaml\" https://brcleprod002:8140/production/node/puppetclient\n</code></pre>"},{"location":"chap6_pp/10pp_api/#status-used-for-testing","title":"Status \u2212 Used for Testing","text":"<pre><code>GET /{environment}/status/{anything}\n\ncurl -k -H \"Accept: pson\" https://brcleprod002:8140/production/certificate_request/puppetclient\n</code></pre>"},{"location":"chap6_pp/10pp_api/#puppet-api","title":"Puppet \u4ee3\u7406 API \u53c2\u8003","text":"<p>\u5728\u4efb\u4f55\u673a\u5668\u4e0a\u8bbe\u7f6e\u65b0\u4ee3\u7406\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Puppet \u4ee3\u7406\u4e0d\u4f1a\u4fa6\u542c HTTP \u8bf7\u6c42\u3002\u5b83\u9700\u8981\u901a\u8fc7\u5728 puppet.conf \u6587\u4ef6\u4e2d\u6dfb\u52a0<code>\u201clisten=true\u201d</code>\u5728 Puppet \u4e2d\u542f\u7528\u3002</p> <p>\u8fd9\u5c06\u4f7f Puppet \u4ee3\u7406\u80fd\u591f\u5728 Puppet \u4ee3\u7406\u542f\u52a8\u65f6\u4fa6\u542c HTTP \u8bf7\u6c42\u3002</p>"},{"location":"chap6_pp/10pp_api/#facts","title":"Facts","text":"<pre><code>GET /{environment}/facts/{anything}\n\ncurl -k -H \"Accept: yaml\" https://brcelprod002:8139/production/facts/{anything}\n</code></pre>"},{"location":"chap6_pp/10pp_api/#run-causes-the-client-to-update-like-puppetturn-or-puppet-kick","title":"Run \u2212 Causes the client to update like puppetturn or puppet kick.","text":"<pre><code>PUT /{environment}/run/{node certificate name}\n\ncurl -k -X PUT -H \"Content-Type: text/pson\" -d \"{}\"\nhttps://brcleprod002:8139/production/run/{anything}\n</code></pre>"},{"location":"chap6_pp/11pp_proj1/","title":"Puppet - Live Project 1","text":"<p>\u4e3a\u4e86\u5728 Puppet \u8282\u70b9\u4e0a\u6267\u884c\u5e94\u7528\u914d\u7f6e\u548c\u6e05\u5355\u7684\u5b9e\u65f6\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u5b9e\u65f6\u5de5\u4f5c\u6f14\u793a\u3002\u8fd9\u53ef\u4ee5\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u6765\u6d4b\u8bd5\u914d\u7f6e\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002\u5982\u679c\u7528\u6237\u5e0c\u671b\u4f7f\u7528\u76f8\u540c\u7684\u4ee3\u7801\u96c6\uff0c\u4ed6\u9700\u8981\u5177\u6709\u76f8\u540c\u7684\u547d\u540d\u7ea6\u5b9a\uff0c\u5982\u4e0b\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u6240\u793a\u3002</p> <p>\u8ba9\u6211\u4eec\u4ece\u521b\u5efa\u4e00\u4e2a\u65b0\u6a21\u5757\u5f00\u59cb\u3002</p>"},{"location":"chap6_pp/11pp_proj1/#_1","title":"\u521b\u5efa\u65b0\u6a21\u5757","text":"<p>\u6d4b\u8bd5\u548c\u5e94\u7528 httpd \u914d\u7f6e\u7684\u7b2c\u4e00\u6b65\u662f\u521b\u5efa\u4e00\u4e2a\u6a21\u5757\u3002</p> <p>\u4e3a\u6b64\uff0c\u7528\u6237\u9700\u8981\u5c06\u5176\u5de5\u4f5c\u76ee\u5f55\u66f4\u6539\u4e3a Puppet \u6a21\u5757\u76ee\u5f55\u5e76\u521b\u5efa\u57fa\u672c\u6a21\u5757\u7ed3\u6784\u3002\u7ed3\u6784\u521b\u5efa\u53ef\u4ee5\u624b\u52a8\u5b8c\u6210\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Puppet \u4e3a\u6a21\u5757\u521b\u5efa\u6837\u677f\u3002</p> <pre><code># cd /etc/puppet/modules\n# puppet module generate Live-module\n</code></pre> <p>\u6ce8\u610f - Puppet \u6a21\u5757\u751f\u6210\u547d\u4ee4\u8981\u6c42\u6a21\u5757\u540d\u79f0\u91c7\u7528 [\u7528\u6237\u540d]-[\u6a21\u5757] \u7684\u683c\u5f0f\u4ee5\u7b26\u5408 Puppet forge \u89c4\u8303\u3002</p> <p>\u65b0\u6a21\u5757\u5305\u542b\u4e00\u4e9b\u57fa\u672c\u6587\u4ef6\uff0c\u5305\u62ec\u6e05\u5355\u76ee\u5f55\u3002</p> <p>\u8be5\u76ee\u5f55\u5df2\u7ecf\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>init.pp</code> \u7684\u6e05\u5355\uff0c\u5b83\u662f\u6a21\u5757\u7684\u4e3b\u8981\u6e05\u5355\u6587\u4ef6\u3002\u8fd9\u662f\u6a21\u5757\u7684\u7a7a\u7c7b\u58f0\u660e\u3002</p> <pre><code>class live-module {\n}\n</code></pre> <p>\u8be5\u6a21\u5757\u8fd8\u5305\u542b\u4e00\u4e2a\u6d4b\u8bd5\u76ee\u5f55\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>init.pp</code> \u7684\u6e05\u5355\u3002\u6b64\u6d4b\u8bd5\u6e05\u5355\u5305\u542b\u5bf9 <code>manifest/init.pp</code> \u4e2d <code>live-module</code> \u7c7b\u7684\u5f15\u7528\uff1a</p> <pre><code>include live-module\n</code></pre> <p>Puppet \u5c06\u4f7f\u7528\u8fd9\u4e2a\u6d4b\u8bd5\u6a21\u5757\u6765\u6d4b\u8bd5\u6e05\u5355\u3002\u73b0\u5728\u6211\u4eec\u51c6\u5907\u5c06\u914d\u7f6e\u6dfb\u52a0\u5230\u6a21\u5757\u4e2d\u3002</p>"},{"location":"chap6_pp/11pp_proj1/#http","title":"\u5b89\u88c5 HTTP \u670d\u52a1\u5668","text":"<p>Puppet \u6a21\u5757\u5c06\u5b89\u88c5\u5fc5\u8981\u7684\u5305\u6765\u8fd0\u884c http \u670d\u52a1\u5668\u3002\u8fd9\u9700\u8981\u4e00\u4e2a\u8d44\u6e90\u5b9a\u4e49\u6765\u5b9a\u4e49 httpd \u5305\u7684\u914d\u7f6e\u3002</p> <p>\u5728\u6a21\u5757\u7684\u6e05\u5355\u76ee\u5f55\u4e2d\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a httpd.pp \u7684\u65b0\u6e05\u5355\u6587\u4ef6</p> <pre><code># touch test-module/manifests/httpd.pp\n</code></pre> <p>\u6b64\u6e05\u5355\u5c06\u5305\u542b\u6211\u4eec\u6a21\u5757\u7684\u6240\u6709 HTTP \u914d\u7f6e\u3002\u51fa\u4e8e\u5206\u79bb\u76ee\u7684\uff0c\u6211\u4eec\u5c06 httpd.pp \u6587\u4ef6\u4e0e init.pp \u6e05\u5355\u6587\u4ef6\u5206\u5f00</p> <p>\u6211\u4eec\u9700\u8981\u5c06\u4ee5\u4e0b\u4ee3\u7801\u653e\u5165 httpd.pp \u6e05\u5355\u6587\u4ef6\u4e2d\u3002</p> <pre><code>class test-module::httpd { \n   package { 'httpd': \n      ensure =&gt; installed, \n   } \n}\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a httpd \u7684 test-module \u5b50\u7c7b\uff0c\u7136\u540e\u4e3a httpd \u5305\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5305\u8d44\u6e90\u58f0\u660e\u3002 </p> <p><code>ensure =&gt; installed</code> \u5c5e\u6027\u68c0\u67e5\u662f\u5426\u5b89\u88c5\u4e86\u6240\u9700\u7684\u5305\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c<code>Puppet</code>\u4f7f\u7528 <code>yum</code> \u5b9e\u7528\u7a0b\u5e8f\u6765\u5b89\u88c5\u5b83\u3002\u63a5\u4e0b\u6765\uff0c\u662f\u5c06\u8fd9\u4e2a\u5b50\u7c7b\u5305\u542b\u5728\u6211\u4eec\u7684\u4e3b\u6e05\u5355\u6587\u4ef6\u4e2d\u3002\u6211\u4eec\u9700\u8981\u7f16\u8f91 <code>init.pp</code> \u6e05\u5355\u3002</p> <pre><code>class test-module { \n   include test-module::httpd \n}\n</code></pre> <p>\u73b0\u5728\uff0c\u662f\u65f6\u5019\u6d4b\u8bd5\u6a21\u5757\u4e86\uff0c\u53ef\u4ee5\u6309\u5982\u4e0b\u65b9\u5f0f\u5b8c\u6210</p> <pre><code># puppet apply test-module/tests/init.pp --noop\n</code></pre> <p><code>puppet apply</code> \u547d\u4ee4\u5e94\u7528\u5b58\u5728\u4e8e\u76ee\u6807\u7cfb\u7edf\u6e05\u5355\u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\u3002</p> <p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u4f7f\u7528\u7684\u662f <code>test init.pp</code>\uff0c\u5b83\u6307\u7684\u662f <code>main init.pp</code>\u3002 </p> <p><code>\u2013noop</code> \u6267\u884c\u914d\u7f6e\u7684\u8bd5\u8fd0\u884c\uff0c\u5b83\u53ea\u663e\u793a\u8f93\u51fa\u4f46\u5b9e\u9645\u4e0a\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\u3002</p> <p>\u4ee5\u4e0b\u662f\u8f93\u51fa\u3002</p> <pre><code>Notice: Compiled catalog for puppet.example.com in environment\nproduction in 0.59 seconds\n\nNotice: /Stage[main]/test-module::Httpd/Package[httpd]/ensure:\ncurrent_value absent, should be present (noop)\n\nNotice: Class[test-module::Httpd]: Would have triggered 'refresh' from 1\nevents\n\nNotice: Stage[main]: Would have triggered 'refresh' from 1 events\nNotice: Finished catalog run in 0.67 seconds\n</code></pre> <p>\u9ad8\u4eae\u7ebf\u662f <code>ensure =&gt; installed</code> \u5c5e\u6027\u7684\u7ed3\u679c\u3002 </p> <p><code>current_value</code>\u4e0d\u5b58\u5728\u610f\u5473\u7740 Puppet \u5df2\u68c0\u6d4b\u5230 httpd \u5305\u5df2\u5b89\u88c5\u3002\u5982\u679c\u6ca1\u6709 <code>\u2013noop</code> \u9009\u9879\uff0cPuppet \u5c06\u5b89\u88c5 httpd \u5305\u3002</p>"},{"location":"chap6_pp/11pp_proj1/#httpd","title":"\u8fd0\u884c httpd \u670d\u52a1\u5668","text":"<p>\u5b89\u88c5\u597dhttpd\u670d\u52a1\u5668\u540e\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u8d44\u6e90\u542f\u52a8\u670d\u52a1\uff1aService</p> <p>\u6211\u4eec\u9700\u8981\u7f16\u8f91 httpd.pp \u6e05\u5355\u6587\u4ef6\u5e76\u7f16\u8f91\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <pre><code>class test-module::httpd { \n   package { 'httpd': \n      ensure =&gt; installed, \n   } \n   service { 'httpd': \n      ensure =&gt; running, \n      enable =&gt; true, \n      require =&gt; Package[\"httpd\"], \n   } \n}\n</code></pre> <p>\u4ee5\u4e0b\u662f\u6211\u4eec\u901a\u8fc7\u4e0a\u8ff0\u4ee3\u7801\u5b9e\u73b0\u7684\u76ee\u6807\u5217\u8868\u3002</p> <ul> <li> <p><code>ensure =&gt; running</code> \u72b6\u6001\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5728\u8fd0\u884c\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u542f\u7528\u5b83\u3002</p> </li> <li> <p><code>enable =&gt; true</code>\u5c5e\u6027\u5c06\u670d\u52a1\u8bbe\u7f6e\u4e3a\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u8fd0\u884c\u3002</p> </li> <li> <p><code>require =&gt; Package[\"httpd\"]</code> \u5c5e\u6027\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8d44\u6e90\u51cf\u901f\u548c\u53e6\u4e00\u4e2a\u4e4b\u95f4\u7684\u6392\u5e8f\u5173\u7cfb\u3002\u5728\u4e0a\u8ff0\u60c5\u51b5\u4e0b\uff0c\u5b83\u786e\u4fdd\u4e86 httpd \u670d\u52a1\u5728 http \u5305\u5b89\u88c5\u540e\u542f\u52a8\u3002\u8fd9\u4f1a\u5728\u670d\u52a1\u548c\u76f8\u5e94\u7684\u5305\u4e4b\u95f4\u521b\u5efa\u4f9d\u8d56\u5173\u7cfb</p> </li> </ul> <p>\u8fd0\u884c puppet apply \u547d\u4ee4\u518d\u6b21\u6d4b\u8bd5\u66f4\u6539\u3002</p> <pre><code># puppet apply test-module/tests/init.pp --noop\nNotice: Compiled catalog for puppet.example.com in environment\nproduction in 0.56 seconds\n\nNotice: /Stage[main]/test-module::Httpd/Package[httpd]/ensure:\ncurrent_value absent, should be present (noop)\n\nNotice: /Stage[main]/test-module::Httpd/Service[httpd]/ensure:\ncurrent_value stopped, should be running (noop)\n\nNotice: Class[test-module::Httpd]: Would have triggered 'refresh' from 2\nevents\n\nNotice: Stage[main]: Would have triggered 'refresh' from 1 events\nNotice: Finished catalog run in 0.41 seconds\n</code></pre>"},{"location":"chap6_pp/11pp_proj1/#httpd_1","title":"\u914d\u7f6e httpd \u670d\u52a1\u5668","text":"<p>\u5b8c\u6210\u4e0a\u8ff0\u6b65\u9aa4\u540e\uff0c\u6211\u4eec\u5c06\u5b89\u88c5\u5e76\u542f\u7528 HTTP \u670d\u52a1\u5668\u3002\u4e0b\u4e00\u6b65\u662f\u4e3a\u670d\u52a1\u5668\u63d0\u4f9b\u4e00\u4e9b\u914d\u7f6e\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0chttpd \u5728 <code>/etc/httpd/conf/httpd.conf</code>\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e2a webhost \u7aef\u53e3 80\u3002\u6211\u4eec\u5c06\u6dfb\u52a0\u4e00\u4e9b\u989d\u5916\u7684\u4e3b\u673a\u6765\u4e3a web-host \u63d0\u4f9b\u4e00\u4e9b\u7528\u6237\u7279\u5b9a\u7684\u8bbe\u65bd\u3002</p> <p>\u6a21\u677f\u5c06\u7528\u4e8e\u63d0\u4f9b\u989d\u5916\u7684\u7aef\u53e3\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u53d8\u91cf\u8f93\u5165\u3002\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>template</code> \u7684\u76ee\u5f55\uff0c\u5e76\u5728\u65b0\u76ee\u5f55\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a <code>test-server.config.erb</code> \u7684\u6587\u4ef6\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <p><code>test-server.config.erb</code></p> <pre><code>Listen &lt;%= @httpd_port %&gt; \nNameVirtualHost *:&lt;% = @httpd_port %&gt; \n\n&lt;VirtualHost *:&lt;% = @httpd_port %&gt;&gt; \n   DocumentRoot /var/www/testserver/ \n   ServerName &lt;% = @fqdn %&gt; \n\n   &lt;Directory \"/var/www/testserver/\"&gt; \n      Options All Indexes FollowSymLinks \n      Order allow,deny \n      Allow from all \n   &lt;/Directory&gt; \n&lt;/VirtualHost&gt;\n</code></pre> <p>\u4e0a\u9762\u7684\u6a21\u677f\u9075\u5faa\u6807\u51c6\u7684 apache-tomcat \u670d\u52a1\u5668\u914d\u7f6e\u683c\u5f0f\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\u4f7f\u7528 Ruby \u8f6c\u4e49\u5b57\u7b26\u4ece\u6a21\u5757\u4e2d\u6ce8\u5165\u53d8\u91cf\u3002\u6211\u4eec\u6709\u5b58\u50a8\u7cfb\u7edf\u5b8c\u5168\u9650\u5b9a\u57df\u540d\u7684 FQDN\u3002\u8fd9\u88ab\u79f0\u4e3a\u7cfb\u7edf\u4e8b\u5b9e\u3002</p> <p>\u5728\u751f\u6210\u6bcf\u4e2a\u76f8\u5e94\u7cfb\u7edf\u7684 puppet \u76ee\u5f55\u4e4b\u524d\uff0c\u4ece\u6bcf\u4e2a\u7cfb\u7edf\u6536\u96c6\u7cfb\u7edf\u4e8b\u5b9e\u3002 </p> <p>Puppet \u4f7f\u7528 facter \u547d\u4ee4\u83b7\u53d6\u6b64\u4fe1\u606f\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f7f\u7528 facter \u83b7\u53d6\u6709\u5173\u7cfb\u7edf\u7684\u5176\u4ed6\u8be6\u7ec6\u4fe1\u606f\u3002\u6211\u4eec\u9700\u8981\u5728 httpd.pp \u6e05\u5355\u6587\u4ef6\u4e2d\u6dfb\u52a0\u9ad8\u4eae\u884c\u3002</p> <pre><code>class test-module::httpd { \n   package { 'httpd': \n      ensure =&gt; installed, \n   } \n   service { 'httpd': \n      ensure =&gt; running, \n      enable =&gt; true, \n      require =&gt; Package[\"httpd\"], \n   } \n   file {'/etc/httpd/conf.d/testserver.conf': \n      notify =&gt; Service[\"httpd\"], \n      ensure =&gt; file, \n      require =&gt; Package[\"httpd\"], \n      content =&gt; template(\"test-module/testserver.conf.erb\"), \n   } \n   file { \"/var/www/myserver\": \n      ensure =&gt; \"directory\", \n   } \n}\n</code></pre> <p>\u8fd9\u6709\u52a9\u4e8e\u5b9e\u73b0\u4ee5\u4e0b\u76ee\u6807 -</p> <ul> <li> <p>\u8fd9\u4f1a\u4e3a\u670d\u52a1\u5668\u914d\u7f6e\u6587\u4ef6 (<code>/etc/httpd/conf.d/test-server.conf</code>) \u6dfb\u52a0\u6587\u4ef6\u8d44\u6e90\u58f0\u660e\u3002\u8be5\u6587\u4ef6\u7684\u5185\u5bb9\u662f\u4e4b\u524d\u521b\u5efa\u7684 <code>test-serverconf.erb</code> \u6a21\u677f\u3002\u6211\u4eec\u8fd8\u68c0\u67e5\u4e86\u5728\u6dfb\u52a0\u6b64\u6587\u4ef6\u4e4b\u524d\u5b89\u88c5\u7684 httpd \u5305\u3002</p> </li> <li> <p>\u8fd9\u6dfb\u52a0\u4e86\u7b2c\u4e8c\u4e2a\u6587\u4ef6\u8d44\u6e90\u58f0\u660e\uff0c\u5b83\u4e3a Web \u670d\u52a1\u5668\u521b\u5efa\u4e86\u4e00\u4e2a\u76ee\u5f55 (<code>/var/www/test-server</code>)\u3002</p> </li> <li> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4f7f\u7528 <code>notify =&gt; Service[\"httpd\"]</code>  \u5c5e\u6027\u6dfb\u52a0\u914d\u7f6e\u6587\u4ef6\u548c https \u670d\u52a1\u7684\u5173\u7cfb\u3002\u8fd9\u5c06\u68c0\u67e5\u662f\u5426\u6709\u4efb\u4f55\u914d\u7f6e\u6587\u4ef6\u66f4\u6539\u3002\u5982\u679c\u6709\uff0c\u5219 Puppet \u91cd\u65b0\u542f\u52a8\u670d\u52a1\u3002</p> </li> </ul> <p>\u63a5\u4e0b\u6765\u662f\u5728\u4e3b\u6e05\u5355\u6587\u4ef6\u4e2d\u5305\u542b <code>httpd_port</code>\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u7ed3\u675f\u4e3b init.pp \u6e05\u5355\u6587\u4ef6\u5e76\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>class test-module ( \n   $http_port = 80 \n) { \n   include test-module::httpd \n}\n</code></pre> <p>\u8fd9\u4f1a\u5c06 httpd \u7aef\u53e3\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u503c 80\u3002\u63a5\u4e0b\u6765\u662f\u8fd0\u884c Puppet \u5e94\u7528\u547d\u4ee4\u3002</p> <p>\u4ee5\u4e0b\u5c06\u662f\u8f93\u51fa\u3002</p> <pre><code># puppet apply test-module/tests/init.pp --noop\nWarning: Config file /etc/puppet/hiera.yaml not found, using Hiera\ndefaults\n\nNotice: Compiled catalog for puppet.example.com in environment\nproduction in 0.84 seconds\n\nNotice: /Stage[main]/test-module::Httpd/File[/var/www/myserver]/ensure:\ncurrent_value absent, should be directory (noop)\n\nNotice: /Stage[main]/test-module::Httpd/Package[httpd]/ensure:\ncurrent_value absent, should be present (noop)\n\nNotice:\n/Stage[main]/test-module::Httpd/File[/etc/httpd/conf.d/myserver.conf]/ensure:\ncurrent_value absent, should be file (noop)\n\nNotice: /Stage[main]/test-module::Httpd/Service[httpd]/ensure:\ncurrent_value stopped, should be running (noop)\n\nNotice: Class[test-module::Httpd]: Would have triggered 'refresh' from 4\nevents\n\nNotice: Stage[main]: Would have triggered 'refresh' from 1 events\nNotice: Finished catalog run in 0.51 seconds\n</code></pre>"},{"location":"chap6_pp/11pp_proj1/#_2","title":"\u914d\u7f6e\u9632\u706b\u5899","text":"<p>\u4e3a\u4e86\u4e0e\u670d\u52a1\u5668\u901a\u4fe1\uff0c\u9700\u8981\u4e00\u4e2a\u5f00\u653e\u7aef\u53e3\u3002\u8fd9\u91cc\u7684\u95ee\u9898\u662f\u4e0d\u540c\u7c7b\u578b\u7684\u64cd\u4f5c\u7cfb\u7edf\u4f7f\u7528\u4e0d\u540c\u7684\u65b9\u6cd5\u6765\u63a7\u5236\u9632\u706b\u5899\u3002\u5728 Linux \u7684\u60c5\u51b5\u4e0b\uff0c\u4f4e\u4e8e 6 \u7684\u7248\u672c\u4f7f\u7528 iptables\uff0c\u800c\u7248\u672c 7 \u4f7f\u7528 firewalld\u3002</p> <p>Puppet \u4f7f\u7528\u7cfb\u7edf\u4e8b\u5b9e\u53ca\u5176\u903b\u8f91\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u5904\u7406\u4e86\u4f7f\u7528\u9002\u5f53\u670d\u52a1\u7684\u51b3\u5b9a\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u9996\u5148\u68c0\u67e5\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7136\u540e\u8fd0\u884c\u76f8\u5e94\u7684\u9632\u706b\u5899\u547d\u4ee4\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u9700\u8981\u5728 <code>testmodule::http</code> \u7c7b\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u7801\u7247\u6bb5\u3002</p> <pre><code>if $operatingsystemmajrelease &lt;= 6 { \n   exec { 'iptables': \n      command =&gt; \"iptables -I INPUT 1 -p tcp -m multiport --ports \n      ${httpd_port} -m comment --comment 'Custom HTTP Web Host' -j ACCEPT &amp;&amp; \n      iptables-save &gt; /etc/sysconfig/iptables\", \n      path =&gt; \"/sbin\", \n      refreshonly =&gt; true, \n      subscribe =&gt; Package['httpd'], \n   } \n   service { 'iptables': \n      ensure =&gt; running, \n      enable =&gt; true, \n      hasrestart =&gt; true, \n      subscribe =&gt; Exec['iptables'], \n   } \n}  elsif $operatingsystemmajrelease == 7 { \n   exec { 'firewall-cmd': \n      command =&gt; \"firewall-cmd --zone=public --addport = $ { \n      httpd_port}/tcp --permanent\", \n      path =&gt; \"/usr/bin/\", \n      refreshonly =&gt; true, \n      subscribe =&gt; Package['httpd'], \n   } \n   service { 'firewalld': \n      ensure =&gt; running, \n      enable =&gt; true, \n      hasrestart =&gt; true, \n      subscribe =&gt; Exec['firewall-cmd'], \n   } \n} \n</code></pre> <p>\u4e0a\u9762\u7684\u4ee3\u7801\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c -</p> <ul> <li>\u4f7f\u7528 <code>operatingsystemmajrelease</code> \u786e\u5b9a\u4f7f\u7528\u7684\u64cd\u4f5c\u7cfb\u7edf\u662f\u7248\u672c 6 \u8fd8\u662f 7\u3002</li> <li>\u5982\u679c\u7248\u672c\u662f 6\uff0c\u90a3\u4e48\u5b83\u8fd0\u884c\u6240\u6709\u5fc5\u9700\u7684\u914d\u7f6e\u547d\u4ee4\u6765\u914d\u7f6e Linux 6 \u7248\u672c\u3002</li> <li>\u5982\u679c\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u4e3a 7\uff0c\u5219\u5b83\u8fd0\u884c\u914d\u7f6e\u9632\u706b\u5899\u6240\u9700\u7684\u6240\u6709\u547d\u4ee4\u3002</li> <li>\u4e24\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684\u4ee3\u7801\u7247\u6bb5\u90fd\u5305\u542b\u4e00\u4e2a\u903b\u8f91\uff0c\u8be5\u903b\u8f91\u786e\u4fdd\u914d\u7f6e\u4ec5\u5728\u5b89\u88c5 http \u5305\u540e\u8fd0\u884c\u3002</li> </ul> <p>\u6700\u540e\uff0c\u8fd0\u884c Puppet \u5e94\u7528\u547d\u4ee4\u3002</p> <pre><code># puppet apply test-module/tests/init.pp --noop\nWarning: Config file /etc/puppet/hiera.yaml not found, using Hiera\ndefaults\n\nNotice: Compiled catalog for puppet.example.com in environment\nproduction in 0.82 seconds\n\nNotice: /Stage[main]/test-module::Httpd/Exec[iptables]/returns:\ncurrent_value notrun, should be 0 (noop)\n\nNotice: /Stage[main]/test-module::Httpd/Service[iptables]: Would have\ntriggered 'refresh' from 1 events\n</code></pre>"},{"location":"chap6_pp/11pp_proj1/#selinux","title":"\u914d\u7f6e SELinux","text":"<p>\u7531\u4e8e\u6211\u4eec\u6b63\u5728\u4f7f\u7528\u7248\u672c 7 \u53ca\u66f4\u9ad8\u7248\u672c\u7684 Linux \u673a\u5668\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u914d\u7f6e\u4ee5\u8fdb\u884c http \u901a\u4fe1\u3002 SELinux \u9ed8\u8ba4\u9650\u5236\u5bf9 HTTP \u670d\u52a1\u5668\u7684\u975e\u6807\u51c6\u8bbf\u95ee\u3002\u5982\u679c\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7aef\u53e3\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u914d\u7f6e SELinux \u4ee5\u63d0\u4f9b\u5bf9\u8be5\u7aef\u53e3\u7684\u8bbf\u95ee\u3002</p> <p>Puppet \u5305\u542b\u4e00\u4e9b\u8d44\u6e90\u7c7b\u578b\u6765\u7ba1\u7406 SELinux \u529f\u80fd\uff0c\u4f8b\u5982\u5e03\u5c14\u503c\u548c\u6a21\u5757\u3002</p> <p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u9700\u8981\u6267\u884c semanage \u547d\u4ee4\u6765\u7ba1\u7406\u7aef\u53e3\u8bbe\u7f6e\u3002\u8be5\u5de5\u5177\u662f <code>policycoreutils-python</code> \u8f6f\u4ef6\u5305\u7684\u4e00\u90e8\u5206\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u672a\u5b89\u88c5\u5728 red-hat \u670d\u52a1\u5668\u4e0a\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u4e0a\u8ff0\u76ee\u7684\uff0c\u6211\u4eec\u9700\u8981\u5728 <code>test-module::http</code> \u7c7b\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u7801\u3002</p> <pre><code>exec { 'semanage-port': \n   command =&gt; \"semanage port -a -t http_port_t -p tcp ${httpd_port}\", \n   path =&gt; \"/usr/sbin\", \n   require =&gt; Package['policycoreutils-python'], \n   before =&gt; Service ['httpd'], \n   subscribe =&gt; Package['httpd'], \n   refreshonly =&gt; true, \n} \n\npackage { 'policycoreutils-python': \n   ensure =&gt; installed, \n} \n</code></pre> <p>\u4e0a\u9762\u7684\u4ee3\u7801\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c -</p> <ul> <li><code>require =&gt; Package['policycoreutils-python']</code>\u786e\u4fdd\u6211\u4eec\u5b89\u88c5\u4e86\u6240\u9700\u7684 python \u6a21\u5757\u3002</li> <li>Puppet \u4f7f\u7528 semanage \u6253\u5f00\u7aef\u53e3\uff0c\u4f7f\u7528 <code>httpd_port</code> \u4f5c\u4e3a\u9a8c\u8bc1\u3002</li> <li>before =&gt; \u670d\u52a1\u786e\u4fdd\u5728 httpd \u670d\u52a1\u542f\u52a8\u4e4b\u524d\u6267\u884c\u6b64\u547d\u4ee4\u3002\u5982\u679c HTTPD \u5728 SELinux \u547d\u4ee4\u4e4b\u524d\u542f\u52a8\uff0c\u5219 SELinux \u670d\u52a1\u8bf7\u6c42\u548c\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\u3002</li> </ul> <pre><code># puppet apply test-module/tests/init.pp --noop\n...\nNotice: /Stage[main]/test-module::Httpd/Package[policycoreutilspython]/\nensure: current_value absent, should be present (noop)\n...\nNotice: /Stage[main]/test-module::Httpd/Exec[semanage-port]/returns:\ncurrent_value notrun, should be 0 (noop)\n...\nNotice: /Stage[main]/test-module::Httpd/Service[httpd]/ensure:\ncurrent_value stopped, should be running (noop)\n</code></pre> <p>Puppet\u5148\u5b89\u88c5python\u6a21\u5757\uff0c\u7136\u540e\u914d\u7f6e\u7aef\u53e3\u8bbf\u95ee\uff0c\u6700\u540e\u542f\u52a8httpd\u670d\u52a1\u3002</p>"},{"location":"chap6_pp/11pp_proj1/#web-html","title":"\u5728 Web \u4e3b\u673a\u4e2d\u590d\u5236 HTML \u6587\u4ef6","text":"<p>\u901a\u8fc7\u4ee5\u4e0a\u6b65\u9aa4\u6211\u4eec\u5c31\u5b8c\u6210\u4e86http\u670d\u52a1\u5668\u7684\u914d\u7f6e\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u5b89\u88c5\u4e00\u4e2a\u57fa\u4e8e Web \u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5e73\u53f0\uff0cPuppet \u4e5f\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u914d\u7f6e\u3002\u4e3a\u4e86\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06\u4e00\u4e9b\u793a\u4f8b html \u7d22\u5f15\u7f51\u9875\u590d\u5236\u5230\u670d\u52a1\u5668\u3002</p> <p>\u5728 files \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a index.html \u6587\u4ef6\u3002</p> <pre><code>&lt;html&gt; \n   &lt;head&gt; \n      &lt;title&gt;Congratulations&lt;/title&gt; \n   &lt;head&gt; \n\n   &lt;body&gt; \n      &lt;h1&gt;Congratulations&lt;/h1&gt; \n      &lt;p&gt;Your puppet module has correctly applied your configuration.&lt;/p&gt; \n   &lt;/body&gt; \n&lt;/html&gt; \n</code></pre> <p>\u5728 manifest \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a <code>manifest app.pp</code> \u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <pre><code>class test-module::app { \n   file { \"/var/www/test-server/index.html\": \n      ensure =&gt; file, \n      mode =&gt; 755, \n      owner =&gt; root, \n      group =&gt; root, \n      source =&gt; \"puppet:///modules/test-module/index.html\", \n      require =&gt; Class[\"test-module::httpd\"], \n   } \n}\n</code></pre> <p>\u8fd9\u4e2a\u65b0\u7c7b\u5305\u542b\u5355\u4e2a\u8d44\u6e90\u3002\u8fd9\u4f1a\u5c06\u6587\u4ef6\u4ece\u6a21\u5757\u7684\u6587\u4ef6\u76ee\u5f55\u590d\u5236\u5230 Web \u670d\u52a1\u5668\u5e76\u8bbe\u7f6e\u5176\u6743\u9650\u3002 <code>required</code> \u5c5e\u6027\u786e\u4fdd <code>test-module::http</code>\u7c7b\u5728\u5e94\u7528 <code>test-module::app</code> \u4e4b\u524d\u6210\u529f\u5b8c\u6210\u914d\u7f6e\u3002</p> <p>\u6700\u540e\uff0c\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684\u4e3b <code>init.pp</code> \u6e05\u5355\u4e2d\u5305\u542b\u4e00\u4e2a\u65b0\u6e05\u5355\u3002</p> <pre><code>class test-module ( \n   $http_port = 80 \n) { \n   include test-module::httpd \n   include test-module::app \n} \n</code></pre> <p>\u73b0\u5728\uff0c\u8fd0\u884c apply \u547d\u4ee4\u6765\u5b9e\u9645\u6d4b\u8bd5\u6b63\u5728\u53d1\u751f\u7684\u4e8b\u60c5\u3002\u4ee5\u4e0b\u5c06\u662f\u8f93\u51fa\u3002</p> <pre><code># puppet apply test-module/tests/init.pp --noop\nWarning: Config file /etc/puppet/hiera.yaml not found, using Hiera\ndefaults\n\nNotice: Compiled catalog for brcelprod001.brcle.com in environment\nproduction in 0.66 seconds\n\nNotice: /Stage[main]/Test-module::Httpd/Exec[iptables]/returns:\ncurrent_value notrun, should be 0 (noop)\n\nNotice: /Stage[main]/Test-module::Httpd/Package[policycoreutilspython]/\nensure: current_value absent, should be present (noop)\n\nNotice: /Stage[main]/Test-module::Httpd/Service[iptables]: Would have\ntriggered 'refresh' from 1 events\n\nNotice: /Stage[main]/Test-module::Httpd/File[/var/www/myserver]/ensure:\ncurrent_value absent, should be directory (noop)\n\nNotice: /Stage[main]/Test-module::Httpd/Package[httpd]/ensure:\ncurrent_value absent, should be present (noop)\n\nNotice:\n/Stage[main]/Test-module::Httpd/File[/etc/httpd/conf.d/myserver.conf]/ensur\ne: current_value absent, should be file (noop)\n\nNotice: /Stage[main]/Test-module::Httpd/Exec[semanage-port]/returns:\ncurrent_value notrun, should be 0 (noop)\n\nNotice: /Stage[main]/Test-module::Httpd/Service[httpd]/ensure:\ncurrent_value stopped, should be running (noop)\n\nNotice: Class[test-module::Httpd]: Would have triggered 'refresh' from 8\nNotice:\n/Stage[main]/test-module::App/File[/var/www/myserver/index.html]/ensur:\ncurrent_value absent, should be file (noop)\n\nNotice: Class[test-module::App]: Would have triggered 'refresh' from 1\nNotice: Stage[main]: Would have triggered 'refresh' from 2 events Notice:\nFinished catalog run in 0.74 seconds\n</code></pre> <p>\u7a81\u51fa\u663e\u793a\u7684\u884c\u663e\u793a\u4e86 index.html \u6587\u4ef6\u88ab\u590d\u5236\u5230\u7f51\u7edc\u4e3b\u673a\u7684\u7ed3\u679c\u3002</p>"},{"location":"chap6_pp/11pp_proj1/#_3","title":"\u5b8c\u6210\u6a21\u5757","text":"<p>\u901a\u8fc7\u4e0a\u8ff0\u6240\u6709\u6b65\u9aa4\uff0c\u6211\u4eec\u521b\u5efa\u7684\u65b0\u6a21\u5757\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002\u5982\u679c\u6211\u4eec\u60f3\u521b\u5efa\u6a21\u5757\u7684\u5b58\u6863\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b8c\u6210\u3002</p> <pre><code># puppet module build test-module\n</code></pre>"},{"location":"chap6_pp/1pp_overview/","title":"1 Puppet - Overview &amp; Architecture","text":"<p>https://www.tutorialspoint.com/puppet/index.html</p> <p>Puppet \u662f Puppet Labs \u5f00\u53d1\u7684\u4e00\u4e2a\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u7528\u4e8e\u81ea\u52a8\u5316\u57fa\u7840\u8bbe\u65bd\u7ba1\u7406\u548c\u914d\u7f6e\u3002 Puppet \u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u6709\u52a9\u4e8e\u5b9e\u73b0\u57fa\u7840\u8bbe\u65bd\u5373\u4ee3\u7801\u7684\u6982\u5ff5\u3002</p> <p>\u8be5\u5de5\u5177\u662f\u7528 Ruby DSL \u8bed\u8a00\u7f16\u5199\u7684\uff0c\u6709\u52a9\u4e8e\u5c06\u5b8c\u6574\u7684\u57fa\u7840\u8bbe\u65bd\u8f6c\u6362\u4e3a\u4ee3\u7801\u683c\u5f0f\uff0c\u53ef\u4ee5\u662f Puppet \u662f Puppet Labs \u5f00\u53d1\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u7528\u4e8e\u81ea\u52a8\u5316\u57fa\u7840\u8bbe\u65bd\u7ba1\u7406\u548c\u914d\u7f6e\u3002 Puppet \u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u6709\u52a9\u4e8e\u5b9e\u73b0\u57fa\u7840\u8bbe\u65bd\u5373\u4ee3\u7801\u7684\u6982\u5ff5\u3002\u8be5\u5de5\u5177\u662f\u7528 Ruby DSL \u8bed\u8a00\u7f16\u5199\u7684\uff0c\u6709\u52a9\u4e8e\u5c06\u5b8c\u6574\u7684\u57fa\u7840\u8bbe\u65bd\u8f6c\u6362\u4e3a\u4ee3\u7801\u683c\u5f0f\uff0c\u6613\u4e8e\u7ba1\u7406\u548c\u914d\u7f6e\u3002</p> <p>Puppet \u9075\u5faa\u5ba2\u6237\u7aef-\u670d\u52a1\u5668\u6a21\u578b\uff0c\u5176\u4e2d\u4efb\u4f55\u96c6\u7fa4\u4e2d\u7684\u4e00\u53f0\u673a\u5668\u5145\u5f53\u670d\u52a1\u5668\uff0c\u79f0\u4e3a puppet \u4e3b\u673a\uff0c\u53e6\u4e00\u53f0\u5145\u5f53\u5ba2\u6237\u7aef\uff0c\u79f0\u4e3a\u8282\u70b9\u4e0a\u7684\u4ece\u673a\u3002 Puppet \u80fd\u591f\u4ece\u5934\u5f00\u59cb\u7ba1\u7406\u4efb\u4f55\u7cfb\u7edf\uff0c\u4ece\u521d\u59cb\u914d\u7f6e\u5230\u4efb\u4f55\u7279\u5b9a\u673a\u5668\u7684\u751f\u547d\u5468\u671f\u7ed3\u675f\u3002</p>"},{"location":"chap6_pp/1pp_overview/#1-features-of-puppet-system","title":"1 Features of Puppet System","text":"<p>\u4ee5\u4e0b\u662f Puppet \u6700\u91cd\u8981\u7684\u529f\u80fd\u3002</p>"},{"location":"chap6_pp/1pp_overview/#1-1","title":"1-1 \u5e42\u7b49\u6027","text":"<p>Puppet \u652f\u6301\u5e42\u7b49\u6027\uff0c\u4f7f\u5176\u72ec\u4e00\u65e0\u4e8c\u3002\u4e0e Chef \u7c7b\u4f3c\uff0c\u5728 Puppet \u4e2d\uff0c\u53ef\u4ee5\u5b89\u5168\u5730\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\u591a\u6b21\u8fd0\u884c\u540c\u4e00\u7ec4\u914d\u7f6e\u3002\u5728\u6b64\u6d41\u7a0b\u4e2d\uff0cPuppet \u68c0\u67e5\u76ee\u6807\u673a\u5668\u7684\u5f53\u524d\u72b6\u6001\uff0c\u5e76\u4e14\u4ec5\u5728\u914d\u7f6e\u53d1\u751f\u4efb\u4f55\u7279\u5b9a\u66f4\u6539\u65f6\u624d\u4f1a\u8fdb\u884c\u66f4\u6539\u3002</p>"},{"location":"chap6_pp/1pp_overview/#1-2","title":"1-2 \u8de8\u5e73\u53f0","text":"<p>\u5728 Puppet \u4e2d\uff0c\u501f\u52a9\u4f7f\u7528 Puppet \u7684 Resource Abstraction Layer (RAL) \uff0c\u53ef\u4ee5\u9488\u5bf9\u7cfb\u7edf\u7684\u6307\u5b9a\u914d\u7f6e\uff0c\u800c\u65e0\u9700\u62c5\u5fc3\u5e95\u5c42\u914d\u7f6e\u4e2d\u5b9a\u4e49\u7684\u5b9e\u73b0\u7ec6\u8282\u4ee5\u53ca\u914d\u7f6e\u547d\u4ee4\u5728\u7cfb\u7edf\u5185\u90e8\u7684\u5de5\u4f5c\u65b9\u5f0f\u6587\u4ef6\u3002</p>"},{"location":"chap6_pp/1pp_overview/#2-puppet-workflow","title":"2 Puppet \u2212 Workflow","text":"<p>Puppet \u4f7f\u7528\u4ee5\u4e0b\u5de5\u4f5c\u6d41\u7a0b\u5728\u7cfb\u7edf\u4e0a\u5e94\u7528\u914d\u7f6e\u3002</p> <p></p> <ul> <li>\u5728 Puppet \u4e2d\uff0cPuppet master \u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u5c31\u662f\u6536\u96c6\u76ee\u6807\u673a\u5668\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u4f7f\u7528\u6240\u6709 Puppet \u8282\u70b9\u4e0a\u5b58\u5728\u7684\u56e0\u5b50\uff08\u7c7b\u4f3c\u4e8e Chef \u4e2d\u7684 Ohai\uff09\uff0c\u5b83\u53ef\u4ee5\u83b7\u53d6\u6240\u6709\u673a\u5668\u7ea7\u522b\u7684\u914d\u7f6e\u8be6\u7ec6\u4fe1\u606f\u3002\u8fd9\u4e9b\u8be6\u7ec6\u4fe1\u606f\u88ab\u6536\u96c6\u5e76\u53d1\u9001\u56de Puppet master\u3002</li> <li>\u7136\u540e\uff0cpuppet master \u5c06\u68c0\u7d22\u5230\u7684\u914d\u7f6e\u4e0e\u5b9a\u4e49\u7684\u914d\u7f6e\u8be6\u7ec6\u4fe1\u606f\u8fdb\u884c\u6bd4\u8f83\uff0c\u5e76\u6839\u636e\u5b9a\u4e49\u7684\u914d\u7f6e\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\u5e76\u5c06\u5176\u53d1\u9001\u5230\u76ee\u6807 Puppet \u4ee3\u7406\u3002</li> <li>\u7136\u540e\uff0cPuppet \u4ee3\u7406\u5e94\u7528\u8fd9\u4e9b\u914d\u7f6e\u4ee5\u4f7f\u7cfb\u7edf\u8fdb\u5165\u6240\u9700\u72b6\u6001\u3002</li> <li>\u6700\u540e\uff0c\u4e00\u65e6\u76ee\u6807\u8282\u70b9\u5904\u4e8e\u6240\u9700\u72b6\u6001\uff0c\u5b83\u5c31\u4f1a\u5411 Puppet Master \u53d1\u9001\u4e00\u4efd\u62a5\u544a\uff0c\u8fd9\u6709\u52a9\u4e8e Puppet Master \u4e86\u89e3\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\uff0c\u5982\u76ee\u5f55\u4e2d\u5b9a\u4e49\u7684\u90a3\u6837\u3002</li> </ul>"},{"location":"chap6_pp/1pp_overview/#3-puppet-key-components","title":"3 Puppet \u2212 Key Components","text":"<p>\u4ee5\u4e0b\u662f Puppet \u7684\u5173\u952e\u7ec4\u4ef6\u3002</p> <p></p>"},{"location":"chap6_pp/1pp_overview/#3-1-puppet","title":"3-1 Puppet \u8d44\u6e90","text":"<p>Puppet \u8d44\u6e90\u662f\u4e3a\u4efb\u4f55\u7279\u5b9a\u673a\u5668\u5efa\u6a21\u7684\u5173\u952e\u7ec4\u4ef6\u3002\u8fd9\u4e9b\u8d44\u6e90\u6709\u81ea\u5df1\u7684\u5b9e\u73b0\u6a21\u578b\u3002 Puppet \u4f7f\u7528\u76f8\u540c\u7684\u6a21\u578b\u6765\u83b7\u53d6\u5904\u4e8e\u6240\u9700\u72b6\u6001\u7684\u4efb\u4f55\u7279\u5b9a\u8d44\u6e90\u3002</p>"},{"location":"chap6_pp/1pp_overview/#3-2-providers","title":"3-2 Providers","text":"<p>Providers\u57fa\u672c\u4e0a\u662f Puppet \u4e2d\u4f7f\u7528\u7684\u4efb\u4f55\u7279\u5b9a\u8d44\u6e90\u7684\u5c65\u884c\u8005\u3002\u4f8b\u5982\uff0c\u5305\u7c7b\u578b\u201capt-get\u201d\u548c\u201cyum\u201d\u90fd\u5bf9\u5305\u7ba1\u7406\u6709\u6548\u3002\u6709\u65f6\uff0c\u4e00\u4e2a\u7279\u5b9a\u5e73\u53f0\u4e0a\u4f1a\u63d0\u4f9b\u591a\u4e2a\u63d0\u4f9b\u5546\u3002\u867d\u7136\u6bcf\u4e2a\u5e73\u53f0\u603b\u662f\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684\u63d0\u4f9b\u8005\u3002</p>"},{"location":"chap6_pp/1pp_overview/#3-3-manifest","title":"3-3 Manifest","text":"<p>Manifest\u662f\u8d44\u6e90\u7684\u96c6\u5408\uff0c\u5b83\u4eec\u8026\u5408\u5728\u51fd\u6570\u6216\u7c7b\u5185\u90e8\u4ee5\u914d\u7f6e\u4efb\u4f55\u76ee\u6807\u7cfb\u7edf\u3002\u5b83\u4eec\u5305\u542b\u4e00\u7ec4 Ruby \u4ee3\u7801\u4ee5\u914d\u7f6e\u7cfb\u7edf\u3002</p>"},{"location":"chap6_pp/1pp_overview/#3-4-modules","title":"3-4 Modules","text":"<p>Modules \u662f Puppet \u7684\u5173\u952e\u6784\u5efa\u5757\uff0c\u5b83\u53ef\u4ee5\u5b9a\u4e49\u4e3a\u8d44\u6e90\u3001\u6587\u4ef6\u3001\u6a21\u677f\u7b49\u7684\u96c6\u5408\u3002\u5b83\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5206\u5e03\u5728\u88ab\u5b9a\u4e49\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\uff0c\u5b83\u4eec\u5177\u6709\u76f8\u540c\u7684\u98ce\u683c\u3002\u7531\u4e8e\u5b83\u4eec\u6613\u4e8e\u5206\u53d1\uff0c\u56e0\u6b64\u4e00\u4e2a\u6a21\u5757\u53ef\u4ee5\u5728\u76f8\u540c\u914d\u7f6e\u4e0b\u591a\u6b21\u4f7f\u7528\u3002</p>"},{"location":"chap6_pp/1pp_overview/#3-5","title":"3-5 \u6a21\u677f","text":"<p>\u6a21\u677f\u4f7f\u7528 Ruby \u8868\u8fbe\u5f0f\u6765\u5b9a\u4e49\u81ea\u5b9a\u4e49\u5185\u5bb9\u548c\u53d8\u91cf\u8f93\u5165\u3002\u5b83\u4eec\u7528\u4e8e\u5f00\u53d1\u81ea\u5b9a\u4e49\u5185\u5bb9\u3002\u6a21\u677f\u5728\u6e05\u5355\u4e2d\u5b9a\u4e49\u5e76\u590d\u5236\u5230\u7cfb\u7edf\u4e0a\u7684\u67d0\u4e2a\u4f4d\u7f6e\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u60f3\u7528\u53ef\u81ea\u5b9a\u4e49\u7684\u7aef\u53e3\u5b9a\u4e49 httpd\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u6765\u5b8c\u6210\u3002</p> <pre><code>Listen &lt;% = @httpd_port %&gt;\n</code></pre> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c<code>httpd_port</code> \u53d8\u91cf\u662f\u5728\u5f15\u7528\u6b64\u6a21\u677f\u7684\u6e05\u5355\u4e2d\u5b9a\u4e49\u7684</p>"},{"location":"chap6_pp/1pp_overview/#3-6-static-files","title":"3-6 Static Files","text":"<p>\u9759\u6001\u6587\u4ef6\u53ef\u4ee5\u5b9a\u4e49\u4e3a\u6709\u65f6\u9700\u8981\u6267\u884c\u7279\u5b9a\u4efb\u52a1\u7684\u901a\u7528\u6587\u4ef6\u3002\u53ef\u4ee5\u4f7f\u7528 Puppet \u5c06\u5b83\u4eec\u7b80\u5355\u5730\u4ece\u4e00\u4e2a\u4f4d\u7f6e\u590d\u5236\u5230\u53e6\u4e00\u4e2a\u4f4d\u7f6e\u3002\u6240\u6709\u9759\u6001\u6587\u4ef6\u90fd\u4f4d\u4e8e\u4efb\u4f55\u6a21\u5757\u7684\u6587\u4ef6\u76ee\u5f55\u4e2d\u3002\u6e05\u5355\u4e2d\u6587\u4ef6\u7684\u4efb\u4f55\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528\u6587\u4ef6\u8d44\u6e90\u5b8c\u6210\u7684\u3002</p>"},{"location":"chap6_pp/1pp_overview/#4-puppet-architecture","title":"4 Puppet - Architecture","text":"<p>Puppet Master </p> <p>Puppet Master \u662f\u5904\u7406\u6240\u6709\u914d\u7f6e\u76f8\u5173\u5185\u5bb9\u7684\u5173\u952e\u673a\u5236\u3002\u5b83\u4f7f\u7528 Puppet \u4ee3\u7406\u5c06\u914d\u7f6e\u5e94\u7528\u4e8e\u8282\u70b9</p> <p>Puppet Agents </p> <p>Puppet Agents \u662f\u7531 Puppet master \u7ba1\u7406\u7684\u5b9e\u9645\u5de5\u4f5c\u673a\u5668\u3002\u4ed6\u4eec\u5728\u5176\u4e2d\u8fd0\u884c Puppet \u4ee3\u7406\u5b88\u62a4\u7a0b\u5e8f\u670d\u52a1\u3002</p> <p>Config Repository</p> <p>\u8fd9\u662f\u6240\u6709\u8282\u70b9\u548c\u670d\u52a1\u5668\u76f8\u5173\u914d\u7f6e\u5728\u9700\u8981\u65f6\u4fdd\u5b58\u548c\u62c9\u53d6\u7684\u5b58\u50a8\u5e93\u3002</p> <p>Facts</p> <p>Facts \u662f\u4e0e\u8282\u70b9\u6216\u4e3b\u673a\u76f8\u5173\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u57fa\u672c\u4e0a\u7528\u4e8e\u5206\u6790\u4efb\u4f55\u8282\u70b9\u7684\u5f53\u524d\u72b6\u6001\u3002\u6839\u636e\u4e8b\u5b9e\uff0c\u5728\u4efb\u4f55\u76ee\u6807\u673a\u5668\u4e0a\u8fdb\u884c\u66f4\u6539\u3002 Puppet \u4e2d\u6709\u9884\u5b9a\u4e49\u548c\u81ea\u5b9a\u4e49\u7684\u4e8b\u5b9e\u3002</p> <p>Catalog</p> <p>\u6240\u6709\u7528 Puppet \u7f16\u5199\u7684\u6e05\u5355\u6587\u4ef6\u6216\u914d\u7f6e\u9996\u5148\u8f6c\u6362\u4e3a\u79f0\u4e3aCatalog\u7684\u7f16\u8bd1\u683c\u5f0f\uff0c\u7136\u540e\u5c06\u8fd9\u4e9bCatalog\u5e94\u7528\u5230\u76ee\u6807\u673a\u5668\u4e0a\u3002</p>"},{"location":"chap6_pp/2pp_install_config/","title":"2 Puppet - \u5b89\u88c5, \u914d\u7f6e\u4ee5\u53ca\u9a8c\u8bc1","text":""},{"location":"chap6_pp/2pp_install_config/#1-installation","title":"1 Installation","text":"<p>Puppet \u5de5\u4f5c\u5728\u5ba2\u6237\u7aef\u670d\u52a1\u5668\u67b6\u6784\u4e0a\uff0c\u5176\u4e2d\u6211\u4eec\u5c06\u670d\u52a1\u5668\u79f0\u4e3a Puppet \u4e3b\u673a\uff0c\u5c06\u5ba2\u6237\u7aef\u79f0\u4e3a Puppet \u8282\u70b9\u3002\u8fd9\u4e2a\u8bbe\u7f6e\u662f\u901a\u8fc7\u5728\u5ba2\u6237\u7aef\u548c\u6240\u6709\u670d\u52a1\u5668\u673a\u5668\u4e0a\u5b89\u88c5 Puppet \u6765\u5b9e\u73b0\u7684\u3002</p> <p>\u5bf9\u4e8e\u5927\u591a\u6570\u5e73\u53f0\uff0c\u53ef\u4ee5\u901a\u8fc7\u9009\u62e9\u7684\u5305\u7ba1\u7406\u5668\u5b89\u88c5 Puppet\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u5c11\u6570\u5e73\u53f0\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5 tarball \u6216 RubyGems \u6765\u5b8c\u6210</p>"},{"location":"chap6_pp/2pp_install_config/#_1","title":"\u5148\u51b3\u6761\u4ef6","text":"<p>Factor \u662f Chef \u4e2d\u552f\u4e00\u4e0d\u4e0e Ohai \u4e00\u8d77\u51fa\u73b0\u7684\u5148\u51b3\u6761\u4ef6\u3002</p> <p>Standard OS Library</p> <p>\u6211\u4eec\u9700\u8981\u6709\u4efb\u4f55\u5e95\u5c42\u64cd\u4f5c\u7cfb\u7edf\u7684\u6807\u51c6\u5e93\u96c6\u3002\u5176\u4f59\u6240\u6709\u7cfb\u7edf\u90fd\u9644\u5e26 Ruby 1.8.2 + \u7248\u672c\u3002\u4ee5\u4e0b\u662f\u64cd\u4f5c\u7cfb\u7edf\u5e94\u5305\u542b\u7684\u5e93\u9879\u76ee\u5217\u8868\u3002</p> <ul> <li>base64</li> <li>cgi</li> <li>digest/md5</li> <li>etc</li> <li>fileutils</li> <li>ipaddr</li> <li>openssl</li> <li>strscan</li> <li>syslog</li> <li>uri</li> <li>webrick</li> <li>webrick/https</li> <li>xmlrpc</li> </ul>"},{"location":"chap6_pp/2pp_install_config/#facter-installation","title":"Facter Installation","text":"<p>\u5982\u524d\u6240\u8ff0\uff0c\u6807\u51c6\u7248 Ruby \u4e0d\u9644\u5e26\u8be5\u56e0\u7d20\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u5728\u76ee\u6807\u7cfb\u7edf\u4e2d\u83b7\u53d6\u56e0\u5b50\uff0c\u9700\u8981\u4ece\u6e90\u624b\u52a8\u5b89\u88c5\u5b83\uff0c\u56e0\u4e3afacter library\u662f Puppet \u7684\u5148\u51b3\u6761\u4ef6\u3002</p> <p>\u8be5\u8f6f\u4ef6\u5305\u53ef\u7528\u4e8e\u591a\u4e2a\u5e73\u53f0\uff0c\u4f46\u4e3a\u4e86\u66f4\u5b89\u5168\uff0c\u53ef\u4ee5\u4f7f\u7528 tarball \u5b89\u88c5\u5b83\uff0c\u8fd9\u6709\u52a9\u4e8e\u83b7\u53d6\u6700\u65b0\u7248\u672c\u3002</p> <p>\u9996\u5148\uff0c\u4f7f\u7528 wget \u5b9e\u7528\u7a0b\u5e8f\u4ece Puppet \u7684\u5b98\u65b9\u7f51\u7ad9\u4e0b\u8f7d tarball\u3002</p> <pre><code>$ wget http://puppetlabs.com/downloads/facter/facter-latest.tgz ------: 1\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u89e3\u538b\u7f29 tar \u6587\u4ef6\u3002\u4f7f\u7528 CD \u547d\u4ee4\u8fdb\u5165\u89e3\u538b\u76ee\u5f55\u3002\u6700\u540e\uff0c\u4f7f\u7528facter \u76ee\u5f55\u4e2d\u7684<code>install.rb</code> \u6587\u4ef6\u5b89\u88c5facter\u3002</p> <pre><code>$ gzip -d -c facter-latest.tgz | tar xf - -----: 2\n$ cd facter-* ------: 3\n$ sudo ruby install.rb # or become root and run install.rb -----:4\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#installing-puppet-from-the-source","title":"Installing Puppet from the Source","text":"<p>\u9996\u5148\uff0c\u4f7f\u7528 wget \u4ece Puppet \u7ad9\u70b9\u5b89\u88c5 Puppet tarball\u3002\u7136\u540e\uff0c\u5c06 tarball \u89e3\u538b\u7f29\u5230\u76ee\u6807\u4f4d\u7f6e\u3002\u4f7f\u7528 CD \u547d\u4ee4\u5728\u521b\u5efa\u7684\u76ee\u5f55\u4e2d\u79fb\u52a8\u3002\u4f7f\u7528 install.rb \u6587\u4ef6\uff0c\u5728\u5e95\u5c42\u670d\u52a1\u5668\u4e0a\u5b89\u88c5 Puppet\u3002</p> <pre><code># get the latest tarball\n$ wget http://puppetlabs.com/downloads/puppet/puppet-latest.tgz -----: 1\n\n# untar and install it\n$ gzip -d -c puppet-latest.tgz | tar xf - ----: 2\n$ cd puppet-* ------: 3\n$ sudo ruby install.rb # or become root and run install.rb -------: 4\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#ruby-gem-puppet-facter","title":"\u4f7f\u7528 Ruby Gem \u5b89\u88c5 Puppet \u548c Facter","text":"<pre><code># Installing Facter\n$ wget http://puppetlabs.com/downloads/gems/facter-1.5.7.gem\n$ sudo gem install facter-1.5.7.gem\n\n# Installing Puppet\n$ wget http://puppetlabs.com/downloads/gems/puppet-0.25.1.gem\n$ sudo gem install puppet-0.25.1.gem\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#2-configuration","title":"2 Configuration","text":"<p>\u4e00\u65e6\u6211\u4eec\u5728\u7cfb\u7edf\u4e0a\u5b89\u88c5\u4e86 Puppet\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u5bf9\u5176\u8fdb\u884c\u914d\u7f6e\u4ee5\u6267\u884c\u67d0\u4e9b\u521d\u59cb\u64cd\u4f5c\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_2","title":"\u6253\u5f00\u673a\u5668\u4e0a\u7684\u9632\u706b\u5899\u7aef\u53e3","text":"<p>\u4e3a\u4e86\u4f7f Puppet \u670d\u52a1\u5668\u96c6\u4e2d\u7ba1\u7406\u5ba2\u6237\u7aef\u7684\u670d\u52a1\u5668\uff0c\u9700\u8981\u5728\u6240\u6709\u673a\u5668\u4e0a\u6253\u5f00\u4e00\u4e2a\u6307\u5b9a\u7684\u7aef\u53e3\uff0c\u5373\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u914d\u7f6e\u7684\u4efb\u4f55\u673a\u5668\u4e0a\u90fd\u6ca1\u6709\u4f7f\u7528 8140\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 8140\u3002\u6211\u4eec\u9700\u8981\u5728\u6240\u6709\u673a\u5668\u4e0a\u540c\u65f6\u542f\u7528 TCP \u548c UDP \u901a\u4fe1\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_3","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>Puppet \u7684\u4e3b\u8981\u914d\u7f6e\u6587\u4ef6\u662f <code>etc/puppet/puppet.conf</code>\u3002\u6240\u6709\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u5728\u57fa\u4e8e\u5305\u7684 Puppet \u914d\u7f6e\u4e2d\u521b\u5efa\u7684\u3002\u914d\u7f6e Puppet \u6240\u9700\u7684\u5927\u90e8\u5206\u914d\u7f6e\u90fd\u4fdd\u5b58\u5728\u8fd9\u4e9b\u6587\u4ef6\u4e2d\uff0c\u4e00\u65e6 Puppet \u8fd0\u884c\uff0c\u5b83\u4f1a\u81ea\u52a8\u83b7\u53d6\u8fd9\u4e9b\u914d\u7f6e\u3002</p> <p>\u4f46\u662f\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u7279\u5b9a\u4efb\u52a1\uff0c\u4f8b\u5982\u914d\u7f6e Web \u670d\u52a1\u5668\u6216\u5916\u90e8\u8bc1\u4e66\u9881\u53d1\u673a\u6784 (CA)\uff0cPuppet \u5bf9\u6587\u4ef6\u548c\u8bbe\u7f6e\u6709\u5355\u72ec\u7684\u914d\u7f6e\u3002</p> <p>\u670d\u52a1\u5668\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>conf.d</code> \u76ee\u5f55\u4e2d\uff0c\u4e5f\u79f0\u4e3a <code>Puppet master</code>\u3002\u8fd9\u4e9b\u6587\u4ef6\u9ed8\u8ba4\u4f4d\u4e8e <code>/etc/puppetlabs/puppetserver/conf.d</code>\u8def\u5f84\u4e0b\u3002</p> <p>\u8fd9\u4e9b\u914d\u7f6e\u6587\u4ef6\u91c7\u7528 HOCON \u683c\u5f0f\uff0c\u4fdd\u7559\u4e86 JSON \u7684\u57fa\u672c\u7ed3\u6784\uff0c\u4f46\u66f4\u5177\u53ef\u8bfb\u6027\u3002\u5f53 Puppet \u542f\u52a8\u65f6\uff0c\u5b83\u4f1a\u4ece conf.d \u76ee\u5f55\u4e2d\u63d0\u53d6\u6240\u6709 <code>.cong</code> \u6587\u4ef6\uff0c\u5e76\u4f7f\u7528\u5b83\u4eec\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\u66f4\u6539\u3002\u8fd9\u4e9b\u6587\u4ef6\u4e2d\u7684\u4efb\u4f55\u66f4\u6539\u4ec5\u5728\u670d\u52a1\u5668\u91cd\u65b0\u542f\u52a8\u65f6\u53d1\u751f</p>"},{"location":"chap6_pp/2pp_install_config/#_4","title":"\u5217\u8868\u6587\u4ef6\u548c\u8bbe\u7f6e\u6587\u4ef6","text":"<ul> <li>global.conf</li> <li>webserver.conf</li> <li>web-routes.conf</li> <li>puppetserver.conf</li> <li>auth.conf</li> <li>master.conf (deprecated)</li> <li>ca.conf (deprecated)</li> </ul> <p>Puppet \u4e2d\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5b83\u4eec\u7279\u5b9a\u4e8e Puppet \u4e2d\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#puppetconf","title":"Puppet.conf","text":"<p>Puppet.conf \u6587\u4ef6\u662f Puppet \u7684\u4e3b\u8981\u914d\u7f6e\u6587\u4ef6\u3002 Puppet \u4f7f\u7528\u76f8\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u914d\u7f6e\u6240\u6709\u5fc5\u9700\u7684 Puppet \u547d\u4ee4\u548c\u670d\u52a1\u3002</p> <p>\u6240\u6709\u4e0e Puppet \u76f8\u5173\u7684\u8bbe\u7f6e\uff0c\u5982 Puppet master\u3001Puppet agent\u3001Puppet apply \u548c\u8bc1\u4e66\u7684\u5b9a\u4e49\u90fd\u5728\u8fd9\u4e2a\u6587\u4ef6\u4e2d\u5b9a\u4e49\u3002 Puppet \u53ef\u4ee5\u6839\u636e\u9700\u8981\u5f15\u7528\u5b83\u4eec\u3002</p> <p>\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8e\u6807\u51c6 ini \u6587\u4ef6\uff0c\u5176\u4e2d\u8bbe\u7f6e\u53ef\u4ee5\u8fdb\u5165\u4e3b\u8981\u90e8\u5206\u7684\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u90e8\u5206\u3002</p> <p>\u4e3b\u8981\u914d\u7f6e\u90e8\u5206</p> <pre><code>[main]\ncertname = Test1.vipin.com\nserver = TestingSrv\nenvironment = production\nruninterval = 1h\n</code></pre> <p>Puppet Master Config File</p> <pre><code>[main]\ncertname = puppetmaster.vipin.com\nserver = MasterSrv\nenvironment = production\nruninterval = 1h\nstrict_variables = true\n[master]\n\ndns_alt_names = MasterSrv,brcleprod01.vipin.com,puppet,puppet.test.com\nreports = puppetdb\nstoreconfigs_backend = puppetdb\nstoreconfigs = true\nenvironment_timeout = unlimited\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#_5","title":"\u8be6\u7ec6\u6982\u8ff0","text":"<p>\u5728 Puppet \u914d\u7f6e\u4e2d\uff0c\u5c06\u8981\u4f7f\u7528\u7684\u6587\u4ef6\u5177\u6709\u591a\u4e2a\u914d\u7f6e\u90e8\u5206\uff0c\u5176\u4e2d\u6bcf\u4e2a\u90e8\u5206\u5177\u6709\u4e0d\u540c\u7c7b\u578b\u7684\u591a\u4e2a\u8bbe\u7f6e\u3002</p> <p>\u914d\u7f6e\u90e8\u5206</p> <p>Puppet \u914d\u7f6e\u6587\u4ef6\u4e3b\u8981\u7531\u4ee5\u4e0b\u914d\u7f6e\u90e8\u5206\u7ec4\u6210\u3002</p> <ul> <li>Main - \u8fd9\u88ab\u79f0\u4e3a\u5168\u5c40\u90e8\u5206\uff0c\u88ab Puppet \u4e2d\u7684\u6240\u6709\u547d\u4ee4\u548c\u670d\u52a1\u4f7f\u7528\u3002\u4e00\u4e2a\u5b9a\u4e49\u4e3b\u8981\u90e8\u5206\u4e2d\u7684\u9ed8\u8ba4\u503c\uff0c\u53ef\u4ee5\u88ab <code>puppet.conf</code> \u6587\u4ef6\u4e2d\u5b58\u5728\u7684\u4efb\u4f55\u90e8\u5206\u8986\u76d6\u3002</li> <li>Master - \u6b64\u90e8\u5206\u7531 Puppet master \u670d\u52a1\u548c Puppet cert \u547d\u4ee4\u5f15\u7528\u3002</li> <li>Agent - \u6b64\u90e8\u5206\u7531 Puppet \u4ee3\u7406\u670d\u52a1\u5f15\u7528\u3002</li> <li>\u7528\u6237 - \u5b83\u4e3b\u8981\u7531 Puppet \u5e94\u7528\u547d\u4ee4\u4ee5\u53ca\u8bb8\u591a\u4e0d\u592a\u5e38\u89c1\u7684\u547d\u4ee4\u4f7f\u7528\u3002</li> </ul> <pre><code>[main]\ncertname = PuppetTestmaster1.example.com\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#_6","title":"\u914d\u7f6e\u6587\u4ef6\u7684\u5173\u952e\u7ec4\u4ef6","text":"<p>\u4ee5\u4e0b\u662f\u914d\u7f6e\u6587\u4ef6\u7684\u5173\u952e\u7ec4\u6210\u90e8\u5206\u3002</p> <p>\u6ce8\u91ca\u884c</p> <p>\u5728 Puppet \u4e2d\uff0c\u4efb\u4f55\u6ce8\u91ca\u884c\u90fd\u4ee5 (#) \u7b26\u53f7\u5f00\u5934\u3002\u8fd9\u53ef\u80fd\u610f\u5473\u7740\u4efb\u4f55\u6570\u91cf\u7684\u7a7a\u95f4\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u540c\u4e00\u884c\u4e2d\u8fdb\u884c\u90e8\u5206\u6ce8\u91ca</p> <pre><code># This is a comment.\nTesting = true #this is also a comment in same line\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#settings-lines","title":"Settings Lines","text":"<p>\u8bbe\u7f6e\u884c\u5fc5\u987b\u5305\u62ec -</p> <ul> <li>\u4efb\u610f\u6570\u91cf\u7684\u524d\u5bfc\u7a7a\u683c\uff08\u53ef\u9009\uff09</li> <li>\u8bbe\u7f6e\u540d\u79f0</li> <li>\u4e00\u4e2a\u7b49\u4e8e = \u7b26\u53f7\uff0c\u5b83\u53ef\u4ee5\u88ab\u4efb\u610f\u6570\u91cf\u7684\u7a7a\u683c\u5305\u56f4</li> <li>\u8bbe\u7f6e\u503c</li> </ul> <p>\u8bbe\u7f6e\u53d8\u91cf</p> <p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u8bbe\u7f6e\u7684\u503c\u5c06\u662f\u4e00\u4e2a\u5355\u8bcd\uff0c\u4f46\u5728\u67d0\u4e9b\u7279\u6b8a\u60c5\u51b5\u4e0b\uff0c\u5f88\u5c11\u6709\u7279\u6b8a\u503c\u3002</p> <p>\u8def\u5f84</p> <p>\u5728\u914d\u7f6e\u6587\u4ef6\u8bbe\u7f6e\u4e2d\uff0c\u83b7\u53d6\u76ee\u5f55\u5217\u8868\u3002\u5728\u5b9a\u4e49\u8fd9\u4e9b\u76ee\u5f55\u65f6\uff0c\u5e94\u8be5\u8bb0\u4f4f\u5b83\u4eec\u5e94\u8be5\u7531\u7cfb\u7edf\u8def\u5f84\u5206\u9694\u7b26\u5206\u9694\uff0c\u5728 *nix \u5e73\u53f0\u4e0a\u662f (:)\uff0c\u5728 Windows \u4e0a\u662f\u5206\u53f7 (;)\u3002</p> <pre><code># *nix version:\nenvironmentpath = $codedir/special_environments:$codedir/environments\n\n# Windows version:\nenvironmentpath = $codedir/environments;C:\\ProgramData\\PuppetLabs\\code\\environment\n</code></pre> <p>\u5728\u5b9a\u4e49\u4e2d\uff0c\u9996\u5148\u5217\u51fa\u7684\u6587\u4ef6\u76ee\u5f55\u88ab\u626b\u63cf\uff0c\u7136\u540e\u5982\u679c\u6ca1\u6709\u627e\u5230\uff0c\u5219\u79fb\u52a8\u5230\u5217\u8868\u4e2d\u7684\u53e6\u4e00\u4e2a\u76ee\u5f55\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_7","title":"\u6587\u4ef6\u548c\u76ee\u5f55","text":"<p>\u91c7\u7528\u5355\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u6240\u6709\u8bbe\u7f6e\u90fd\u53ef\u4ee5\u63a5\u53d7\u53ef\u9009\u7684\u6743\u9650\u54c8\u5e0c\u3002\u5f53\u670d\u52a1\u5668\u542f\u52a8\u65f6\uff0cPuppet \u5c06\u5f3a\u5236\u6267\u884c\u5217\u8868\u4e2d\u7684\u90a3\u4e9b\u6587\u4ef6\u6216\u76ee\u5f55\u3002</p> <pre><code>ssldir = $vardir/ssl {owner = service, mode = 0771}\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u5141\u8bb8\u7684\u54c8\u5e0c\u662f\u6240\u6709\u8005\u3001\u7ec4\u548c\u6a21\u5f0f\u3002\u6240\u6709\u8005\u548c\u7ec4\u5bc6\u94a5\u53ea\u6709\u4e24\u4e2a\u6709\u6548\u503c\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#3-environment-conf","title":"3 Environment Conf","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6240\u6709\u73af\u5883\u90fd\u6709 environment.conf \u6587\u4ef6\u3002\u6bcf\u5f53\u4e3b\u670d\u52a1\u5668\u4e3a\u4efb\u4f55\u8282\u70b9\u6216\u5206\u914d\u7ed9\u8be5\u7279\u5b9a\u73af\u5883\u7684\u6240\u6709\u8282\u70b9\u63d0\u4f9b\u670d\u52a1\u65f6\uff0c\u6b64\u6587\u4ef6\u53ef\u4ee5\u8986\u76d6\u51e0\u4e2a\u9ed8\u8ba4\u8bbe\u7f6e\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#location","title":"Location","text":"<p>\u5728 Puppet \u4e2d\uff0c\u5bf9\u4e8e\u6240\u6709\u5b9a\u4e49\u7684\u73af\u5883\uff0c<code>environment.conf</code> \u6587\u4ef6\u4f4d\u4e8e\u5176\u4e3b\u73af\u5883\u7684\u9876\u5c42\uff0c\u975e\u5e38\u9760\u8fd1manifest\u548cmodules\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u60a8\u7684\u73af\u5883\u5728\u9ed8\u8ba4\u76ee\u5f55\uff08<code>Vipin/testing/environment</code>\uff09\u4e2d\uff0c\u90a3\u4e48\u6d4b\u8bd5\u73af\u5883\u7684\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>Vipin/testing/environments/test/environment.conf</code>\u3002</p> <p>Example</p> <pre><code># /etc/testingdir/code/environments/test/environment.conf\n# Puppet Enterprise requires $basemodulepath; see note below under modulepath\".\nmodulepath = site:dist:modules:$basemodulepath\n# Use our custom script to get a git commit for the current state of the code:\nconfig_version = get_environment_commit.sh\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#format","title":"Format","text":"<p>Puppet \u4e2d\u7684\u6240\u6709\u914d\u7f6e\u6587\u4ef6\u90fd\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u4f7f\u7528\u76f8\u540c\u7684\u7c7b\u4f3c <code>INI \u7684\u683c\u5f0f</code>\u3002 <code>environment.conf</code>\u6587\u4ef6\u9075\u5faa\u4e0e\u5176\u4ed6\u7c7b\u4f3c <code>Puppet.conf</code> \u6587\u4ef6\u76f8\u540c\u7684\u7c7b\u4f3c INI \u7684\u683c\u5f0f\u3002 </p> <p><code>environment.conf</code> \u548c <code>puppet.conf</code> \u4e4b\u95f4\u7684\u552f\u4e00\u533a\u522b\u662f <code>environment.conf</code> \u6587\u4ef6\u4e0d\u80fd\u5305\u542b [main] \u90e8\u5206\u3002 </p> <p>environment.conf \u6587\u4ef6\u4e2d\u7684\u6240\u6709\u8bbe\u7f6e\u90fd\u5fc5\u987b\u5728\u4efb\u4f55\u914d\u7f6e\u90e8\u5206\u4e4b\u5916</p>"},{"location":"chap6_pp/2pp_install_config/#interpolation-in-values","title":"Interpolation in Values","text":"<p>Environment.conf \u8bbe\u7f6e\u6587\u4ef6\u80fd\u591f\u4f7f\u7528\u5176\u4ed6\u8bbe\u7f6e\u7684\u503c\u4f5c\u4e3a\u53d8\u91cf\u3002\u6709\u591a\u4e2a\u6709\u7528\u7684\u53d8\u91cf\u53ef\u4ee5\u63d2\u5165\u5230 <code>environment.conf</code> \u6587\u4ef6\u4e2d\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u91cd\u8981\u53d8\u91cf\u7684\u5217\u8868 -</p> <ul> <li><code>$basemodulepath</code> \u2212 \u5bf9\u4e8e\u5728\u6a21\u5757\u8def\u5f84\u8bbe\u7f6e\u4e2d\u5305\u542b\u76ee\u5f55\u5f88\u6709\u7528\u3002 Puppet \u4f01\u4e1a\u7528\u6237\u901a\u5e38\u5e94\u8be5\u5305\u542b\u8fd9\u4e2a modulepath \u7684\u503c\uff0c\u56e0\u4e3a Puppet \u5f15\u64ce\u5728 basemodulepath \u4e2d\u4f7f\u7528\u6a21\u5757\u3002</li> <li><code>$environment</code> \u2212 \u4f5c\u4e3a <code>config_version</code> \u811a\u672c\u7684\u547d\u4ee4\u884c\u53c2\u6570\u5f88\u6709\u7528\u3002\u60a8\u53ea\u80fd\u5728 <code>config_version</code> \u8bbe\u7f6e\u4e2d\u63d2\u5165\u6b64\u53d8\u91cf\u3002</li> <li><code>$codedir</code> \u2212 \u7528\u4e8e\u5b9a\u4f4d\u6587\u4ef6.</li> </ul>"},{"location":"chap6_pp/2pp_install_config/#allowed-settings","title":"Allowed Settings","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPuppet environment.conf \u6587\u4ef6\u53ea\u5141\u8bb8\u8986\u76d6\u914d\u7f6e\u4e2d\u5217\u51fa\u7684\u56db\u4e2a\u8bbe\u7f6e\u3002</p> <ul> <li>Modulepath</li> <li>Manifest</li> <li><code>Config_version</code></li> <li><code>Environment_timeout</code></li> </ul> <p>Modulepath</p> <p>\u8fd9\u662f environment.conf \u6587\u4ef6\u4e2d\u7684\u5173\u952e\u8bbe\u7f6e\u4e4b\u4e00\u3002</p> <p>\u5728 modulepath \u4e2d\u5b9a\u4e49\u7684\u6240\u6709\u5bfc\u5411\u5668\u9ed8\u8ba4\u7531 Puppet \u52a0\u8f7d\u3002\u8fd9\u662f Puppet \u52a0\u8f7d\u5176\u6a21\u5757\u7684\u8def\u5f84\u4f4d\u7f6e\u3002\u9700\u8981\u660e\u786e\u8bbe\u7f6e\u3002\u5982\u679c\u672a\u8bbe\u7f6e\u4e0a\u8ff0\u8bbe\u7f6e\uff0c\u5219 Puppet \u4e2d\u4efb\u4f55\u73af\u5883\u7684\u9ed8\u8ba4\u6a21\u5757\u8def\u5f84\u5c06\u662f -</p> <pre><code>&lt;MODULES DIRECTORY FROM ENVIRONMENT&gt;:$basemodulepath\n</code></pre> <p>Manifest</p> <p>\u8fd9\u7528\u4e8e\u5b9a\u4e49\u4e3bManifest\u6587\u4ef6\uff0cPuppet master \u5c06\u5728\u542f\u52a8\u548c\u7f16\u8bd1\u76ee\u5f55\u65f6\u4f7f\u7528\u5df2\u5b9a\u4e49\u7684\u6e05\u5355\u6587\u4ef6\uff0c\u8be5\u6e05\u5355\u6587\u4ef6\u5c06\u7528\u4e8e\u914d\u7f6e\u73af\u5883\u3002\u5728\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u5355\u4e2a\u6587\u4ef6\u3001\u6587\u4ef6\u5217\u8868\uff0c\u751a\u81f3\u662f\u7531\u591a\u4e2a\u6e05\u5355\u6587\u4ef6\u7ec4\u6210\u7684\u76ee\u5f55\uff0c\u8fd9\u4e9b\u6587\u4ef6\u9700\u8981\u6309\u7167\u5b9a\u4e49\u7684\u5b57\u6bcd\u987a\u5e8f\u8fdb\u884c\u8bc4\u4f30\u548c\u7f16\u8bd1\u3002</p> <p>\u9700\u8981\u5728 environment.conf \u6587\u4ef6\u4e2d\u660e\u786e\u5b9a\u4e49\u6b64\u8bbe\u7f6e\u3002\u5982\u679c\u4e0d\u662f\uff0c\u90a3\u4e48 Puppet \u5c06\u4f7f\u7528\u73af\u5883\u9ed8\u8ba4\u6e05\u5355\u76ee\u5f55\u4f5c\u4e3a\u5176\u4e3b\u8981\u6e05\u5355\u3002</p> <p><code>Config_version</code></p> <p><code>Config_version</code> \u53ef\u4ee5\u5b9a\u4e49\u4e3a\u7528\u4e8e\u6807\u8bc6catalogs\u548cevents\u7684\u786e\u5b9a\u7248\u672c\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5f53 Puppet \u7f16\u8bd1\u4efb\u4f55\u6e05\u5355\u6587\u4ef6\u65f6\uff0c\u5b83\u4f1a\u5c06\u914d\u7f6e\u7248\u672c\u6dfb\u52a0\u5230\u751f\u6210\u7684\u76ee\u5f55\u4ee5\u53ca <code>Puppet Master</code> \u5728 <code>Puppet</code> \u8282\u70b9\u4e0a\u5e94\u7528\u4efb\u4f55\u5b9a\u4e49\u7684\u76ee\u5f55\u65f6\u751f\u6210\u7684\u62a5\u544a\u4e2d\u3002</p> <p>Puppet \u8fd0\u884c\u4e00\u4e2a\u811a\u672c\u6765\u6267\u884c\u4e0a\u8ff0\u6240\u6709\u6b65\u9aa4\uff0c\u5e76\u5c06\u6240\u6709\u751f\u6210\u7684\u8f93\u51fa\u7528\u4f5c <code>Config_version</code>\u3002</p> <p>Environment Timeout</p> <p>\u5b83\u7528\u4e8e\u83b7\u53d6\u6709\u5173 Puppet \u5e94\u7528\u4e8e\u4e3a\u7ed9\u5b9a\u73af\u5883\u52a0\u8f7d\u6570\u636e\u7684\u65f6\u95f4\u91cf\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u5982\u679c\u8be5\u503c\u5728 puppet.conf \u6587\u4ef6\u4e2d\u5b9a\u4e49\uff0c\u90a3\u4e48\u8fd9\u4e9b\u503c\u5c06\u8986\u76d6\u9ed8\u8ba4\u8d85\u65f6\u503c\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#environmentconf","title":"\u793a\u4f8b environment.conf \u6587\u4ef6","text":"<pre><code>[master]\nmanifest = $confdir/environments/$environment/manifests/site.pp\nmodulepath = $confdir/environments/$environment/modules\n</code></pre> <ul> <li>\u4e0a\u9762\u4ee3\u7801\u4e2d<code>$confdir</code>\u662f\u76ee\u5f55\u7684\u8def\u5f84\uff0c\u73af\u5883\u914d\u7f6e\u6587\u4ef6\u6240\u5728\u7684\u76ee\u5f55\u3002</li> <li><code>$environment</code> \u662f\u6b63\u5728\u4e3a\u5176\u5b8c\u6210\u914d\u7f6e\u7684\u73af\u5883\u7684\u540d\u79f0\u3002</li> </ul>"},{"location":"chap6_pp/2pp_install_config/#_8","title":"\u751f\u4ea7\u5c31\u7eea\u73af\u5883\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># The environment configuration file\n# The main manifest directory or file where Puppet starts to evaluate code\n# This is the default value. Works with just a site.pp file or any other\nmanifest = manifests/\n# The directories added to the module path, looked in first match first used order:\n# modules - Directory for external modules, populated by r10k based on Puppetfile\n# $basemodulepath - As from: puppet config print basemodulepath\nmodulepath = site:modules:$basemodulepath\n# Set the cache timeout for this environment.\n# This overrides what is set directly in puppet.conf for the whole Puppet server\n# environment_timeout = unlimited\n# With caching you need to flush the cache whenever new Puppet code is deployed\n# This can also be done manually running: bin/puppet_flush_environment_cache.sh\n# To disable catalog caching:\nenvironment_timeout = 0\n# Here we pass to one in the control repo the Puppet environment (and git branch)\n# to get title and essential info of the last git commit\nconfig_version = 'bin/config_script.sh $environment'\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#4-master","title":"4 Master","text":"<p>\u5728 Puppet \u4e2d\uff0cPuppet Master \u7684\u5ba2\u6237\u7aef\u670d\u52a1\u5668\u67b6\u6784\u88ab\u8ba4\u4e3a\u662f\u6574\u4e2a\u8bbe\u7f6e\u7684\u63a7\u5236\u6743\u9650\u3002 Puppet Master \u5728\u8bbe\u7f6e\u4e2d\u5145\u5f53\u670d\u52a1\u5668\u5e76\u63a7\u5236\u6240\u6709\u8282\u70b9\u4e0a\u7684\u6240\u6709\u6d3b\u52a8\u3002</p> <p>\u5bf9\u4e8e\u4efb\u4f55\u9700\u8981\u5145\u5f53 Puppet Master \u7684\u670d\u52a1\u5668\uff0c\u5b83\u90fd\u5e94\u8be5\u8fd0\u884c Puppet \u670d\u52a1\u5668\u8f6f\u4ef6\u3002\u8be5\u670d\u52a1\u5668\u8f6f\u4ef6\u662f\u63a7\u5236\u8282\u70b9\u4e0a\u6240\u6709\u6d3b\u52a8\u7684\u5173\u952e\u7ec4\u4ef6\u3002\u5728\u6b64\u8bbe\u7f6e\u4e2d\uff0c\u8981\u8bb0\u4f4f\u7684\u4e00\u4e2a\u5173\u952e\u70b9\u662f\u8ba9\u8d85\u7ea7\u7528\u6237\u8bbf\u95ee\u5c06\u5728\u8bbe\u7f6e\u4e2d\u4f7f\u7528\u7684\u6240\u6709\u673a\u5668\u3002\u4ee5\u4e0b\u662f\u8bbe\u7f6e Puppet Master \u7684\u6b65\u9aa4\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_9","title":"\u5148\u51b3\u6761\u4ef6","text":"<ul> <li>Private Network DNS - \u5e94\u8be5\u914d\u7f6eForward and backward\uff0c\u5176\u4e2d\u6bcf\u4e2a\u670d\u52a1\u5668\u5e94\u8be5\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u4e3b\u673a\u540d\u3002\u5982\u679c\u6ca1\u6709\u914d\u7f6e DNS\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4e13\u7528\u7f51\u7edc\u4e0e\u57fa\u7840\u8bbe\u65bd\u8fdb\u884c\u901a\u4fe1\u3002</li> <li>Firewall Open Port - Puppet master \u5e94\u8be5\u5728\u7279\u5b9a\u7aef\u53e3\u4e0a\u6253\u5f00\uff0c\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u4fa6\u542c\u7279\u5b9a\u7aef\u53e3\u4e0a\u7684\u4f20\u5165\u8bf7\u6c42\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u9632\u706b\u5899\u4e0a\u6253\u5f00\u7684\u4efb\u4f55\u7aef\u53e3\u3002</li> </ul>"},{"location":"chap6_pp/2pp_install_config/#creating-puppet-master-server","title":"Creating Puppet Master Server","text":"<p>\u6211\u4eec\u6b63\u5728\u521b\u5efa\u7684 Puppet Master \u5c06\u5728 CentOS 7 \u00d7 64 \u673a\u5668\u4e0a\u4f7f\u7528 Puppet \u4f5c\u4e3a\u4e3b\u673a\u540d\u3002\u521b\u5efa Puppet Master \u7684\u6700\u4f4e\u7cfb\u7edf\u914d\u7f6e\u662f\u4e24\u4e2a CPU \u6838\u5fc3\u548c 1GB \u5185\u5b58\u3002\u914d\u7f6e\u4e5f\u53ef\u80fd\u5177\u6709\u66f4\u5927\u7684\u5927\u5c0f\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u6211\u4eec\u8981\u4f7f\u7528\u8be5\u4e3b\u8282\u70b9\u7ba1\u7406\u7684\u8282\u70b9\u6570\u91cf\u3002\u5728\u57fa\u7840\u67b6\u6784\u4e2d\uff0c\u6bd4\u4f7f\u7528 2 GB RAM \u914d\u7f6e\u7684\u8981\u5927\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u9700\u8981\u751f\u6210 Puppet master SSL \u8bc1\u4e66\uff0c\u5e76\u5c06 master \u673a\u5668\u7684\u540d\u79f0\u590d\u5236\u5230\u6240\u6709\u8282\u70b9\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#ntp","title":"\u5b89\u88c5 NTP","text":"<p>\u7531\u4e8e Puppet Master \u662f\u4efb\u4f55\u7ed9\u5b9a\u8bbe\u7f6e\u4e2d\u4ee3\u7406\u8282\u70b9\u7684\u4e2d\u592e\u6743\u5a01\uff0c\u56e0\u6b64\u7ef4\u62a4\u51c6\u786e\u7684\u7cfb\u7edf\u65f6\u95f4\u4ee5\u907f\u514d\u6f5c\u5728\u7684\u914d\u7f6e\u95ee\u9898\u662f Puppet Master \u7684\u4e3b\u8981\u804c\u8d23\u4e4b\u4e00\uff0c\u8fd9\u4e9b\u95ee\u9898\u53ef\u80fd\u5728\u5411\u8282\u70b9\u9881\u53d1\u4ee3\u7406\u8bc1\u4e66\u65f6\u51fa\u73b0\u3002</p> <p>\u5982\u679c\u51fa\u73b0\u65f6\u95f4\u51b2\u7a81\u95ee\u9898\uff0c\u5219\u5982\u679c\u4e3b\u8282\u70b9\u548c\u8282\u70b9\u4e4b\u95f4\u5b58\u5728\u65f6\u95f4\u5dee\u5f02\uff0c\u5219\u8bc1\u4e66\u53ef\u80fd\u4f1a\u8fc7\u671f\u3002\u7f51\u7edc\u65f6\u95f4\u534f\u8bae\u662f\u907f\u514d\u6b64\u7c7b\u95ee\u9898\u7684\u5173\u952e\u673a\u5236\u4e4b\u4e00\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_10","title":"\u5217\u51fa\u53ef\u7528\u65f6\u533a","text":"<pre><code>$ timedatectl list-timezones\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u5c06\u63d0\u4f9b\u53ef\u7528\u65f6\u533a\u7684\u5b8c\u6574\u5217\u8868\u3002\u5b83\u5c06\u4e3a\u533a\u57df\u63d0\u4f9b\u65f6\u533a\u53ef\u7528\u6027\u3002</p> <p>\u4ee5\u4e0b\u547d\u4ee4\u53ef\u7528\u4e8e\u5728\u673a\u5668\u4e0a\u8bbe\u7f6e\u6240\u9700\u7684\u65f6\u533a\u3002</p> <pre><code>$ sudo timedatectl set-timezone India/Delhi\n</code></pre> <p>\u4f7f\u7528 CentOS \u673a\u5668\u7684 yum \u5b9e\u7528\u7a0b\u5e8f\u5728 Puppet \u670d\u52a1\u5668\u673a\u5668\u4e0a\u5b89\u88c5 NTP\u3002</p> <pre><code>$ sudo yum -y install ntp\n</code></pre> <p>\u5c06 NTP \u4e0e\u6211\u4eec\u5728\u4e0a\u8ff0\u547d\u4ee4\u4e2d\u8bbe\u7f6e\u7684\u7cfb\u7edf\u65f6\u95f4\u540c\u6b65\u3002</p> <pre><code>$ sudo ntpdate pool.ntp.org\n</code></pre> <p>\u5728\u901a\u5e38\u7684\u5b9e\u8df5\u4e2d\uff0c\u6211\u4eec\u5c06\u66f4\u65b0 NTP \u914d\u7f6e\u4ee5\u4f7f\u7528\u66f4\u9760\u8fd1\u673a\u5668\u6570\u636e\u4e2d\u5fc3\u7684\u516c\u5171\u6c60\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u7f16\u8f91 <code>/etc</code> \u4e0b\u7684 <code>ntp.conf</code> \u6587\u4ef6\u3002</p> <pre><code>$ sudo vi /etc/ntp.conf\n</code></pre> <p>\u4ece\u53ef\u7528\u7684 NTP \u6c60\u65f6\u533a\u6dfb\u52a0\u65f6\u95f4\u670d\u52a1\u5668\u3002\u4ee5\u4e0b\u662f ntp.conf \u6587\u4ef6\u7684\u5916\u89c2\u3002</p> <pre><code>brcleprod001.brcl.pool.ntp.org\nbrcleprod002.brcl.pool.ntp.org\nbrcleprod003.brcl.pool.ntp.org\nbrcleprod004.brcl.pool.ntp.org\n</code></pre> <p>Save the configuration. Start the server and enable the daemon.</p> <pre><code>$ sudo systemctl restart ntpd\n$ sudo systemctl enable ntpd\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#puppet","title":"\u8bbe\u7f6e Puppet \u670d\u52a1\u5668\u8f6f\u4ef6","text":"<p>Puppet \u670d\u52a1\u5668\u8f6f\u4ef6\u662f\u5728 Puppet \u4e3b\u673a\u4e0a\u8fd0\u884c\u7684\u8f6f\u4ef6\u3002\u5b83\u662f\u5c06\u914d\u7f6e\u63a8\u9001\u5230\u8fd0\u884c Puppet \u4ee3\u7406\u8f6f\u4ef6\u7684\u5176\u4ed6\u673a\u5668\u7684\u673a\u5668\u3002</p> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u7528\u5b98\u65b9 Puppet \u5b9e\u9a8c\u5ba4\u96c6\u5408\u5b58\u50a8\u5e93\u3002</p> <pre><code>$ sudo rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-pc1-el7.noarch.rpm\n</code></pre> <p>Install puppetserver package.</p> <pre><code>$ sudo yum -y install puppetserver\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#puppet_1","title":"\u5728 Puppet \u670d\u52a1\u5668\u4e0a\u914d\u7f6e\u5185\u5b58\u5206\u914d","text":"<p>\u6b63\u5982\u6211\u4eec\u6240\u8ba8\u8bba\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPuppet \u670d\u52a1\u5668\u914d\u7f6e\u5728 2GB RAM \u7684\u673a\u5668\u4e0a\u3002\u53ef\u4ee5\u6839\u636e\u673a\u5668\u4e0a\u7684\u53ef\u7528\u5185\u5b58\u4ee5\u53ca\u670d\u52a1\u5668\u5c06\u7ba1\u7406\u7684\u8282\u70b9\u6570\u91cf\u6765\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u3002</p> <p>\u5728 vi \u6a21\u5f0f\u4e0b\u7f16\u8f91 puppet \u670d\u52a1\u5668\u914d\u7f6e</p> <pre><code>$ sudo vi /etc/sysconfig/puppetserver\nFind the JAVA_ARGS and use the \u2013Xms and \u2013Xms options to set the memory allocation.\nWe will allocate 3GB of space\nJAVA_ARGS=\"-Xms3g -Xmx3g\"\n</code></pre> <p>\u5b8c\u6210\u540e\uff0c\u4fdd\u5b58\u5e76\u9000\u51fa\u7f16\u8f91\u6a21\u5f0f\u3002</p> <p>\u4e0a\u8ff0\u6240\u6709\u8bbe\u7f6e\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5728\u4e3b\u673a\u4e0a\u542f\u52a8 Puppet \u670d\u52a1\u5668\u4e86\u3002</p> <pre><code>$ sudo systemctl start puppetserver\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u8fdb\u884c\u8bbe\u7f6e\uff0c\u4ee5\u4fbf\u5728\u4e3b\u670d\u52a1\u5668\u542f\u52a8\u65f6\u542f\u52a8 puppet \u670d\u52a1\u5668\u3002</p> <pre><code>$ sudo systemctl enable puppetserver\n</code></pre> <p><code>Puppet.conf</code> Master Section</p> <pre><code>[master]\nautosign = $confdir/autosign.conf { mode = 664 }\nreports = foreman\nexternal_nodes = /etc/puppet/node.rb\nnode_terminus = exec\nca = true\nssldir = /var/lib/puppet/ssl\ncertname = sat6.example.com\nstrict_variables = false\nmanifest =\n/etc/puppet/environments/$environment/manifests/site.pp\nmodulepath = /etc/puppet/environments/$environment/modules\nconfig_version =\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#agent-setup","title":"Agent Setup","text":"<p>Puppet Agent \u662f\u7531 Puppet \u5b9e\u9a8c\u5ba4\u63d0\u4f9b\u7684\u8f6f\u4ef6\u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u8fd0\u884c\u5728 Puppet \u96c6\u7fa4\u4e2d\u7684\u4efb\u4f55\u8282\u70b9\u4e0a\u3002\u5982\u679c\u60f3\u8981\u4f7f\u7528 Puppet Master \u7ba1\u7406\u4efb\u4f55\u670d\u52a1\u5668\uff0c\u5219\u9700\u8981\u5728\u8be5\u7279\u5b9a\u670d\u52a1\u5668\u4e0a\u5b89\u88c5 Puppet Agent\u8f6f\u4ef6\u3002</p> <p>\u901a\u5e38\uff0cPuppet \u4ee3\u7406\u5c06\u5b89\u88c5\u5728\u4efb\u4f55\u7ed9\u5b9a\u57fa\u7840\u8bbe\u65bd\u4e0a\u9664 Puppet \u4e3b\u673a\u4e4b\u5916\u7684\u6240\u6709\u673a\u5668\u4e0a\u3002 Puppet \u4ee3\u7406\u8f6f\u4ef6\u80fd\u591f\u5728\u5927\u591a\u6570 Linux\u3001UNIX \u548c Windows \u673a\u5668\u4e0a\u8fd0\u884c\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 CentOS \u673a\u5668\u5b89\u88c5 Puppet \u4ee3\u7406\u8f6f\u4ef6\u5c31\u53ef\u4ee5\u4e86</p> <p>Step 1 \u2212 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u7528\u5b98\u65b9 Puppet \u5b9e\u9a8c\u5ba4\u96c6\u5408\u5b58\u50a8\u5e93\u3002</p> <pre><code>$ sudo rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-pc1-el7.noarch.rpm\n</code></pre> <p>Step 2 \u2212 \u5b89\u88c5 Puppet \u4ee3\u7406\u5305\u3002</p> <pre><code>$ sudo yum -y install puppet-agent\n</code></pre> <p>Step 3 - \u5b89\u88c5 Puppet \u4ee3\u7406\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u7528\u5b83\u3002</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet resource service puppet ensure=running enable = true\n</code></pre> <p>Puppet \u4ee3\u7406\u7684\u4e00\u4e2a\u5173\u952e\u7279\u6027\u662f\uff0c\u5f53 Puppet \u4ee3\u7406\u7b2c\u4e00\u6b21\u5f00\u59cb\u8fd0\u884c\u65f6\uff0c\u5b83\u4f1a\u751f\u6210\u4e00\u4e2a SSL \u8bc1\u4e66\u5e76\u5c06\u5176\u53d1\u9001\u7ed9\u5c06\u8981\u7ba1\u7406\u5b83\u7684 Puppet Master \u4ee5\u8fdb\u884c\u7b7e\u540d\u548c\u6279\u51c6\u3002\u4e00\u65e6 Puppet Master \u6279\u51c6\u4ee3\u7406\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff0c\u5b83\u5c06\u80fd\u591f\u4e0e\u4ee3\u7406\u8282\u70b9\u8fdb\u884c\u901a\u4fe1\u548c\u7ba1\u7406\u3002</p> <p>\u6ce8\u610f - \u9700\u8981\u5728\u9700\u8981\u914d\u7f6e\u548c\u7ba1\u7406\u4efb\u4f55\u7ed9\u5b9a Puppet Master \u7684\u6240\u6709\u8282\u70b9\u4e0a\u91cd\u590d\u4e0a\u8ff0\u6b65\u9aa4\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#5-ssl-sign-certificate-setup","title":"5 SSL Sign Certificate Setup","text":"<p>\u5f53 Puppet \u4ee3\u7406\u8f6f\u4ef6\u7b2c\u4e00\u6b21\u5728\u4efb\u4f55 Puppet \u8282\u70b9\u4e0a\u8fd0\u884c\u65f6\uff0c\u5b83\u4f1a\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66\u5e76\u5c06\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u53d1\u9001\u7ed9 Puppet Master\u3002\u5728 Puppet \u670d\u52a1\u5668\u80fd\u591f\u901a\u4fe1\u548c\u63a7\u5236\u4ee3\u7406\u8282\u70b9\u4e4b\u524d\uff0c\u5b83\u5fc5\u987b\u7b7e\u7f72\u8be5\u7279\u5b9a\u4ee3\u7406\u8282\u70b9\u7684\u8bc1\u4e66\u3002\u5728\u4ee5\u4e0b\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u63cf\u8ff0\u5982\u4f55\u7b7e\u540d\u548c\u68c0\u67e5\u7b7e\u540d\u8bf7\u6c42\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_11","title":"\u5217\u51fa\u5f53\u524d\u7684\u8bc1\u4e66\u8bf7\u6c42","text":"<p>\u5728 Puppet Master \u4e0a\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u67e5\u770b\u6240\u6709\u672a\u7b7e\u540d\u7684\u8bc1\u4e66\u8bf7\u6c42\u3002</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet cert list\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u521a\u521a\u5efa\u7acb\u4e86\u4e00\u4e2a\u65b0\u7684\u4ee3\u7406\u8282\u70b9\uff0c\u6211\u4eec\u5c06\u770b\u5230\u4e00\u4e2a\u6279\u51c6\u8bf7\u6c42\u3002\u4ee5\u4e0b\u5c06\u662f\u8f93\u51fa\u3002</p> <pre><code>\"Brcleprod004.brcl.com\" (SHA259)\n15:90:C2:FB:ED:69:A4:F7:B1:87:0B:BF:F7:ll:\nB5:1C:33:F7:76:67:F3:F6:45:AE:07:4B:F 6:E3:ss:04:11:8d\n</code></pre> <p>\u5b83\u7684\u5f00\u5934\u4e0d\u5305\u542b\u4efb\u4f55+\uff08\u7b26\u53f7\uff09\uff0c\u8fd9\u8868\u660e\u8bc1\u4e66\u4ecd\u7136\u6ca1\u6709\u7b7e\u540d\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_12","title":"\u7b7e\u7f72\u8bf7\u6c42","text":"<p>\u4e3a\u4e86\u5bf9\u5728\u65b0\u8282\u70b9\u4e0a\u8fd0\u884c Puppet \u4ee3\u7406\u65f6\u751f\u6210\u7684\u65b0\u8bc1\u4e66\u8bf7\u6c42\u8fdb\u884c\u7b7e\u540d\uff0c\u5c06\u4f7f\u7528 Puppet cert sign \u547d\u4ee4\u4ee5\u53ca\u8bc1\u4e66\u7684\u4e3b\u673a\u540d\uff0c\u8be5\u8bc1\u4e66\u7531\u65b0\u914d\u7f6e\u7684\u8282\u70b9\u751f\u6210\uff0c\u9700\u8981\u7b7e\u7f72\u3002\u7531\u4e8e\u6211\u4eec\u6709 Brcleprod004.brcl.com \u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet cert sign Brcleprod004.brcl.com\n</code></pre> <p>\u4ee5\u4e0b\u5c06\u662f\u8f93\u51fa\u3002</p> <pre><code>Notice: Signed certificate request for Brcle004.brcl.com\nNotice: Removing file Puppet::SSL::CertificateRequest Brcle004.brcl.com at\n'/etc/puppetlabs/puppet/ssl/ca/requests/Brcle004.brcl.com.pem'\n</code></pre> <p>puppet \u670d\u52a1\u5668\u73b0\u5728\u53ef\u4ee5\u4e0e\u7b7e\u540d\u8bc1\u4e66\u6240\u5c5e\u7684\u8282\u70b9\u8fdb\u884c\u901a\u4fe1\u3002</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet cert sign --all\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#puppet_2","title":"\u4ece Puppet \u8bbe\u7f6e\u4e2d\u64a4\u9500\u4e3b\u673a","text":"<p>\u5f53\u9700\u8981\u4ece\u8bbe\u7f6e\u4e2d\u5220\u9664\u4e3b\u673a\u5e76\u91cd\u65b0\u6dfb\u52a0\u65f6\uff0c\u5185\u6838\u91cd\u5efa\u7684\u914d\u7f6e\u5b58\u5728\u6761\u4ef6\u3002\u8fd9\u4e9b\u662f\u5076\u4eba\u81ea\u8eab\u65e0\u6cd5\u7ba1\u7406\u7684\u6761\u4ef6\u3002\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b8c\u6210\u3002</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet cert clean hostname\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#_13","title":"\u67e5\u770b\u6240\u6709\u7b7e\u540d\u7684\u8bf7\u6c42","text":"<p>\u4ee5\u4e0b\u547d\u4ee4\u5c06\u751f\u6210\u5e26\u6709 +\uff08\u7b26\u53f7\uff09\u7684\u7b7e\u540d\u8bc1\u4e66\u5217\u8868\uff0c\u8868\u793a\u8bf7\u6c42\u5df2\u88ab\u6279\u51c6</p> <pre><code>$ sudo /opt/puppetlabs/bin/puppet cert list --all\n</code></pre> <p>\u4ee5\u4e0b\u5c06\u662f\u5b83\u7684\u8f93\u51fa\u3002</p> <pre><code>+ \"puppet\" (SHA256) 5A:71:E6:06:D8:0F:44:4D:70:F0:\nBE:51:72:15:97:68:D9:67:16:41:B0:38:9A:F2:B2:6C:B\nB:33:7E:0F:D4:53 (alt names: \"DNS:puppet\", \"DNS:Brcle004.nyc3.example.com\")\n\n+ \"Brcle004.brcl.com\" (SHA259) F5:DC:68:24:63:E6:F1:9E:C5:FE:F5:\n1A:90:93:DF:19:F2:28:8B:D7:BD:D2:6A:83:07:BA:F E:24:11:24:54:6A\n\n+ \" Brcle004.brcl.com\" (SHA259) CB:CB:CA:48:E0:DF:06:6A:7D:75:E6:CB:22:BE:35:5A:9A:B3\n</code></pre> <p>\u5b8c\u6210\u4e0a\u8ff0\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u7684\u57fa\u7840\u8bbe\u65bd\u5df2\u7ecf\u51c6\u5907\u5c31\u7eea\uff0cPuppet master \u73b0\u5728\u80fd\u591f\u7ba1\u7406\u65b0\u6dfb\u52a0\u7684\u8282\u70b9\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#6-r10k","title":"6 \u5b89\u88c5\u548c\u914d\u7f6e r10K","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u79f0\u4e3a r10k \u7684\u4ee3\u7801\u7ba1\u7406\u5de5\u5177\uff0c\u5b83\u6709\u52a9\u4e8e\u7ba1\u7406\u4e0e\u6211\u4eec\u53ef\u4ee5\u5728 Puppet \u4e2d\u914d\u7f6e\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u73af\u5883\u76f8\u5173\u7684\u73af\u5883\u914d\u7f6e\uff0c\u4f8b\u5982\u5f00\u53d1\u3001\u6d4b\u8bd5\u548c\u751f\u4ea7\u3002\u8fd9\u6709\u52a9\u4e8e\u5728\u6e90\u4ee3\u7801\u5b58\u50a8\u5e93\u4e2d\u5b58\u50a8\u4e0e\u73af\u5883\u76f8\u5173\u7684\u914d\u7f6e\u3002\u4f7f\u7528\u6e90\u4ee3\u7801\u63a7\u5236 repo \u5206\u652f\uff0cr10k \u5728 Puppet master \u673a\u5668\u4e0a\u521b\u5efa\u73af\u5883\uff0c\u4f7f\u7528 repo \u4e2d\u5b58\u5728\u7684\u6a21\u5757\u5b89\u88c5\u548c\u66f4\u65b0\u73af\u5883\u3002</p> <p>Gem \u6587\u4ef6\u53ef\u7528\u4e8e\u5728\u4efb\u4f55\u673a\u5668\u4e0a\u5b89\u88c5 r10k\uff0c\u4f46\u4e3a\u4e86\u6a21\u5757\u5316\uff0c\u4e3a\u4e86\u83b7\u5f97\u6700\u65b0\u7248\u672c\uff0c\u6211\u4eec\u5c06\u4f7f\u7528 rpm \u548c rpm \u5305\u7ba1\u7406\u5668\u3002\u4ee5\u4e0b\u662f\u76f8\u540c\u7684\u793a\u4f8b\u3002</p> <pre><code>$ urlgrabber -o /etc/yum.repos.d/timhughes-r10k-epel-6.repo\nhttps://copr.fedoraproject.org/coprs/timhughes/yum -y install rubygem-r10k\n</code></pre> <p>Configure environment in /etc/puppet/puppet.conf</p> <pre><code>[main]\nenvironmentpath = $confdir/environments\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#r10k-config","title":"\u4e3a r10k Config \u521b\u5efa\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6","text":"<pre><code>cat &lt;&lt;EOF &gt;/etc/r10k.yaml\n# The location to use for storing cached Git repos\n:cachedir: '/var/cache/r10k'\n# A list of git repositories to create\n:sources:\n# This will clone the git repository and instantiate an environment per\n# branch in /etc/puppet/environments\n:opstree:\n#remote: 'https://github.com/fullstack-puppet/fullstackpuppet-environment.git'\nremote: '/var/lib/git/fullstackpuppet-environment.git'\nbasedir: '/etc/puppet/environments'\nEOF\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#puppet-manifest","title":"\u5b89\u88c5 Puppet Manifest \u548c\u6a21\u5757","text":"<pre><code>r10k deploy environment -pv\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u9700\u8981\u5728\u6bcf 15 \u5206\u949f\u5185\u7ee7\u7eed\u66f4\u65b0\u73af\u5883\uff0c\u6211\u4eec\u5c06\u4e3a\u6b64\u521b\u5efa\u4e00\u4e2a cron \u4f5c\u4e1a\u3002</p> <pre><code>cat &lt;&lt; EOF &gt; /etc/cron.d/r10k.conf\nSHELL = /bin/bash\nPATH = /sbin:/bin:/usr/sbin:/usr/bin\nH/15 * * * * root r10k deploy environment -p\nEOF\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#_14","title":"\u6d4b\u8bd5\u5b89\u88c5","text":"<p>\u4e3a\u4e86\u6d4b\u8bd5\u662f\u5426\u4e00\u5207\u6b63\u5e38\uff0c\u9700\u8981\u4e3a Puppet \u6a21\u5757\u7f16\u8bd1 Puppet \u6e05\u5355\u3002\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5e76\u83b7\u5f97 YAML \u8f93\u51fa\u4f5c\u4e3a\u7ed3\u679c\u3002</p> <pre><code>curl --cert /etc/puppet/ssl/certs/puppet.corp.guest.pem \\\n--key /etc/puppet/ssl/private_keys/puppet.corp.guest.pem \\\n--cacert /etc/puppet/ssl/ca/ca_crt.pem \\\n-H 'Accept: yaml' \\\nhttps://puppet.corp.guest:8140/production/catalog/puppet.corp.guest\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#7-puppet","title":"7 \u9a8c\u8bc1 Puppet \u8bbe\u7f6e","text":"<p>\u5728 Puppet \u4e2d\uff0c\u53ef\u4ee5\u5728\u672c\u5730\u6d4b\u8bd5\u8bbe\u7f6e\u3002\u56e0\u6b64\uff0c\u4e00\u65e6\u6211\u4eec\u8bbe\u7f6e\u4e86 Puppet \u4e3b\u8282\u70b9\u548c\u8282\u70b9\uff0c\u5c31\u8be5\u5728\u672c\u5730\u9a8c\u8bc1\u8bbe\u7f6e\u4e86\u3002\u6211\u4eec\u9700\u8981\u5728\u672c\u5730\u5b89\u88c5 Vagrant \u548c Vagrant box\uff0c\u8fd9\u6709\u52a9\u4e8e\u5728\u672c\u5730\u6d4b\u8bd5\u8bbe\u7f6e\u3002</p>"},{"location":"chap6_pp/2pp_install_config/#_15","title":"\u8bbe\u7f6e\u865a\u62df\u673a","text":"<p>\u7531\u4e8e\u6211\u4eec\u5728\u672c\u5730\u6d4b\u8bd5\u8bbe\u7f6e\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u5e76\u4e0d\u9700\u8981\u6b63\u5728\u8fd0\u884c\u7684 Puppet Master\u3002\u8fd9\u610f\u5473\u7740\u65e0\u9700\u5728\u670d\u52a1\u5668\u4e0a\u5b9e\u9645\u8fd0\u884c <code>Puppet Master</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528 Puppet \u5e94\u7528\u547d\u4ee4\u6765\u9a8c\u8bc1 Puppet \u8bbe\u7f6e\u3002 </p> <p><code>Puppet apply</code> \u547d\u4ee4\u5c06\u6839\u636e\u914d\u7f6e\u6587\u4ef6\u4e2d\u865a\u62df\u673a\u7684\u4e3b\u673a\u540d\u5e94\u7528\u6765\u81ea\u672c\u5730<code>/etc/puppet</code> \u7684\u66f4\u6539\u3002</p> <p>\u4e3a\u4e86\u6d4b\u8bd5\u8bbe\u7f6e\uff0c\u6211\u4eec\u9700\u8981\u6267\u884c\u7684\u7b2c\u4e00\u6b65\u662f\u6784\u5efa\u4ee5\u4e0b Vagrantfile \u5e76\u542f\u52a8\u4e00\u53f0\u673a\u5668\u5e76\u5c06 <code>/etc/puppet</code> \u6587\u4ef6\u5939\u5b89\u88c5\u5230\u4f4d\u3002\u6240\u6709\u9700\u8981\u7684\u6587\u4ef6\u90fd\u5c06\u653e\u5728\u5177\u6709\u4ee5\u4e0b\u7ed3\u6784\u7684\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u4e2d\u3002</p> <p>Directory Structure</p> <pre><code>- manifests\n\\- site.pp\n- modules\n\\- your modules\n- test\n\\- update-puppet.sh\n\\- Vagrantfile\n- puppet.conf\n</code></pre> <p>Vagrant File</p> <pre><code># -*- mode: ruby -*-\n# vi: set ft = ruby :\nVagrant.configure(\"2\") do |config|\nconfig.vm.box = \"precise32\"\nconfig.vm.box_url = \"http://files.vagrantup.com/precise64.box\"\nconfig.vm.provider :virtualbox do |vb|\nvb.customize [\"modifyvm\", :id, \"--memory\", 1028, \"--cpus\", 2]\nend\n\n# Mount our repo onto /etc/puppet\nconfig.vm.synced_folder \"../\", \"/etc/puppet\"\n\n# Run our Puppet shell script\nconfig.vm.provision \"shell\" do |s|\ns.path = \"update-puppet.sh\"\nend\n\nconfig.vm.hostname = \"localdev.example.com\"\nend\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 Shell \u914d\u7f6e\u5668\uff0c\u6211\u4eec\u8bd5\u56fe\u5728\u5176\u4e2d\u8fd0\u884c\u4e00\u4e2a\u540d\u4e3a <code>update-puppet.sh</code> \u7684 Shell \u811a\u672c\u3002\u8be5\u811a\u672c\u4f4d\u4e8e Vagrant \u6587\u4ef6\u6240\u5728\u7684\u540c\u4e00\u76ee\u5f55\u4e2d\uff0c\u811a\u672c\u7684\u5185\u5bb9\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>!/bin/bash\necho \"Puppet version is $(puppet --version)\"\nif [ $( puppet --version) != \"3.4.1\" ]; then\necho \"Updating puppet\"\napt-get install --yes lsb-release\nDISTRIB_CODENAME = $(lsb_release --codename --short)\nDEB = \"puppetlabs-release-${DISTRIB_CODENAME}.deb\"\nDEB_PROVIDES=\"/etc/apt/sources.list.d/puppetlabs.list\"\n\nif [ ! -e $DEB_PROVIDES ]\nthen\nwget -q http://apt.puppetlabs.com/$DEB\nsudo dpkg -i $DEB\nfi\nsudo apt-get update\nsudo apt-get install -o Dpkg::Options:: = \"--force-confold\"\n--force-yes -y puppet\nelse\necho \"Puppet is up to date!\"\nfi\n</code></pre> <p>\u8fdb\u4e00\u6b65\u5904\u7406\uff0c\u7528\u6237\u9700\u8981\u5728 Manifests \u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a site.pp \u7684\u6e05\u5355\u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u5c06\u5728 VM \u4e0a\u5b89\u88c5\u4e00\u4e9b\u8f6f\u4ef6\u3002</p> <pre><code>node 'brclelocal03.brcl.com' { \n   package { ['vim','git'] : \n      ensure =&gt; latest \n   } \n} \necho \"Running puppet\" \nsudo puppet apply /etc/puppet/manifests/site.pp \n</code></pre> <p>\u4e00\u65e6\u7528\u6237\u51c6\u5907\u597d\u4e0a\u8ff0\u811a\u672c\u548c\u6240\u9700\u7684 Vagrant \u6587\u4ef6\u914d\u7f6e\uff0c\u7528\u6237\u53ef\u4ee5 cd \u5230 test \u76ee\u5f55\u5e76\u8fd0\u884c vagrant up \u547d\u4ee4\u3002\u8fd9\u5c06\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u865a\u62df\u673a\uff0c\u7a0d\u540e\u5b89\u88c5 Puppet\uff0c\u7136\u540e\u4f7f\u7528 Shell \u811a\u672c\u8fd0\u884c\u5b83\u3002</p> <p>\u4ee5\u4e0b\u5c06\u662f\u8f93\u51fa\u3002</p> <pre><code>Notice: Compiled catalog for localdev.example.com in environment production in 0.09 seconds\nNotice: /Stage[main]/Main/Node[brclelocal03.brcl.com]/Package[git]/ensure: created\nNotice: /Stage[main]/Main/Node[brcllocal03.brcl.com]/Package[vim]/ensure: ensure changed 'purged' to 'latest'\n</code></pre>"},{"location":"chap6_pp/2pp_install_config/#_16","title":"\u9a8c\u8bc1\u591a\u53f0\u673a\u5668\u914d\u7f6e","text":"<p>\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u672c\u5730\u6d4b\u8bd5\u591a\u53f0\u673a\u5668\u7684\u914d\u7f6e\uff0c\u53ea\u9700\u4fee\u6539 Vagrant \u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002</p> <p>\u65b0\u914d\u7f6e\u7684 Vagrant \u6587\u4ef6</p> <pre><code>config.vm.define \"brclelocal003\" do |brclelocal003|\nbrclelocal03.vm.hostname = \"brclelocal003.brcl.com\"\nend\n\nconfig.vm.define \"production\" do |production|\nproduction.vm.hostname = \"brcleprod004.brcl.com\"\nend\n</code></pre> <p>\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u4e2a\u65b0\u7684\u751f\u4ea7\u670d\u52a1\u5668\uff0c\u9700\u8981\u5b89\u88c5 SSL \u5b9e\u7528\u7a0b\u5e8f\u3002\u6211\u4eec\u53ea\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\u6269\u5c55\u65e7\u6e05\u5355\u3002</p> <pre><code>node 'brcleprod004.brcl.com' inherits 'brcleloacl003.brcl.com' { \n   package { ['SSL'] : \n      ensure =&gt; latest \n   } \n} \n</code></pre> <p>\u5728\u6e05\u5355\u6587\u4ef6\u4e2d\u8fdb\u884c\u914d\u7f6e\u66f4\u6539\u540e\uff0c\u6211\u4eec\u53ea\u9700\u8981\u79fb\u52a8\u5230\u6d4b\u8bd5\u76ee\u5f55\u5e76\u8fd0\u884c\u57fa\u672c\u7684 vagrant up \u547d\u4ee4\uff0c\u8fd9\u5c06\u6253\u5f00 brclelocal003.brcl.com \u548c brcleprod004.brcl.com \u673a\u5668\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u6b63\u5728\u5c1d\u8bd5\u542f\u52a8\u751f\u4ea7\u673a\u5668\uff0c\u8fd9\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c vagrant up production \u547d\u4ee4\u6765\u5b8c\u6210\u3002\u8fd9\u5c06\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a production \u7684\u65b0\u673a\u5668\uff0c\u5982 Vagrant \u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u90a3\u6837\uff0c\u5b83\u5c06\u5b89\u88c5 SSL \u5305\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/","title":"3 Puppet \u7f16\u7801\u98ce\u683c","text":"<p>\u5728 Puppet \u4e2d\uff0c\u7f16\u7801\u98ce\u683c\u5b9a\u4e49\u4e86\u5728\u5c1d\u8bd5\u5c06\u673a\u5668\u914d\u7f6e\u4e0a\u7684\u57fa\u7840\u8bbe\u65bd\u8f6c\u6362\u4e3a\u4ee3\u7801\u65f6\u9700\u8981\u9075\u5faa\u7684\u6240\u6709\u6807\u51c6\u3002 Puppet \u4f7f\u7528\u8d44\u6e90\u5de5\u4f5c\u5e76\u6267\u884c\u6240\u6709\u5b9a\u4e49\u7684\u4efb\u52a1\u3002</p> <p>Puppet \u7684\u8bed\u8a00\u5b9a\u4e49\u6709\u52a9\u4e8e\u4ee5\u7ed3\u6784\u5316\u65b9\u5f0f\u6307\u5b9a\u6240\u6709\u8d44\u6e90\uff0c\u8fd9\u662f\u7ba1\u7406\u4efb\u4f55\u9700\u8981\u7ba1\u7406\u7684\u76ee\u6807\u673a\u5668\u6240\u5fc5\u9700\u7684\u3002 Puppet \u4f7f\u7528 Ruby \u4f5c\u4e3a\u5176\u7f16\u7801\u8bed\u8a00\uff0c\u5b83\u5177\u6709\u591a\u4e2a\u5185\u7f6e\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee3\u7801\u7aef\u7684\u7b80\u5355\u914d\u7f6e\u8f7b\u677e\u5b8c\u6210\u5de5\u4f5c\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#1-fundamental-units","title":"1 Fundamental Units","text":"<p>Puppet \u4f7f\u7528\u591a\u79cd\u57fa\u672c\u7f16\u7801\u98ce\u683c\uff0c\u6613\u4e8e\u7406\u89e3\u548c\u7ba1\u7406\u3002\u4ee5\u4e0b\u662f\u51e0\u4e2a\u5217\u8868</p>"},{"location":"chap6_pp/3pp_coding_style/#1-2","title":"1-2 \u8d44\u6e90","text":"<p>\u5728 Puppet \u4e2d\uff0c\u8d44\u6e90\u88ab\u79f0\u4e3a\u57fa\u672c\u5efa\u6a21\u5355\u5143\uff0c\u7528\u4e8e\u7ba1\u7406\u6216\u4fee\u6539\u4efb\u4f55\u76ee\u6807\u7cfb\u7edf\u3002\u8d44\u6e90\u6db5\u76d6\u7cfb\u7edf\u7684\u6240\u6709\u65b9\u9762\uff0c\u4f8b\u5982\u6587\u4ef6\u3001\u670d\u52a1\u548c\u5305\u3002 Puppet \u5177\u6709\u5185\u7f6e\u529f\u80fd\uff0c\u5141\u8bb8\u7528\u6237\u6216\u5f00\u53d1\u4eba\u5458\u5f00\u53d1\u81ea\u5b9a\u4e49\u8d44\u6e90\uff0c\u8fd9\u6709\u52a9\u4e8e\u7ba1\u7406\u673a\u5668\u7684\u4efb\u4f55\u7279\u5b9a\u5355\u5143</p> <p>\u5728 Puppet \u4e2d\uff0c\u6240\u6709\u8d44\u6e90\u90fd\u901a\u8fc7\u4f7f\u7528\u201c\u5b9a\u4e49Define\u201d\u6216\u201c\u7c7bClass\u201d\u805a\u5408\u5728\u4e00\u8d77\u3002\u8fd9\u4e9b\u805a\u5408\u529f\u80fd\u6709\u52a9\u4e8e\u7ec4\u7ec7\u6a21\u5757\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u793a\u4f8b\u8d44\u6e90\uff0c\u5b83\u5305\u542b\u591a\u4e2a\u7c7b\u578b\u3001\u4e00\u4e2a\u6807\u9898\u548c\u4e00\u4e2a Puppet \u53ef\u4ee5\u652f\u6301\u591a\u4e2a\u5c5e\u6027\u7684\u5c5e\u6027\u5217\u8868\u3002 Puppet \u4e2d\u7684\u6bcf\u4e2a\u8d44\u6e90\u90fd\u6709\u81ea\u5df1\u7684\u9ed8\u8ba4\u503c\uff0c\u53ef\u4ee5\u5728\u9700\u8981\u65f6\u8986\u76d6\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#1-3-puppet","title":"1-3 \u6587\u4ef6\u7684\u6837\u672c Puppet \u8d44\u6e90","text":"<p>\u5728\u4ee5\u4e0b\u547d\u4ee4\u4e2d\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e3a\u7279\u5b9a\u6587\u4ef6\u6307\u5b9a\u6743\u9650\u3002</p> <pre><code>file {  \n   '/etc/passwd': \n   owner =&gt; superuser, \n   group =&gt; superuser, \n   mode =&gt; 644, \n}\n</code></pre> <p>\u6bcf\u5f53\u5728\u4efb\u4f55\u673a\u5668\u4e0a\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\u65f6\uff0c\u5b83\u90fd\u4f1a\u9a8c\u8bc1\u7cfb\u7edf\u4e2d\u7684 passwd \u6587\u4ef6\u662f\u5426\u5df2\u6309\u7167\u63cf\u8ff0\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u524d\u9762\u7684\u6587\u4ef6  <code>:colon</code> \u662f\u8d44\u6e90\u7684\u6807\u9898\uff0c\u5728Puppet\u914d\u7f6e\u7684\u5176\u4ed6\u90e8\u5206\u53ef\u4ee5\u79f0\u4e3a\u8d44\u6e90</p>"},{"location":"chap6_pp/3pp_coding_style/#2","title":"2 \u9664\u6807\u9898\u5916\u8fd8\u6307\u5b9a\u672c\u5730\u540d\u79f0","text":"<pre><code>file { 'sshdconfig': \n   name =&gt; $operaSystem ? { \n      solaris =&gt; '/usr/local/etc/ssh/sshd_config', \n      default =&gt; '/etc/ssh/sshd_config', \n   }, \n   owner =&gt; superuser, \n   group =&gt; superuser, \n   mode =&gt; 644, \n}\n</code></pre> <p>\u901a\u8fc7\u4f7f\u7528\u59cb\u7ec8\u76f8\u540c\u7684title\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5728\u914d\u7f6e\u4e2d\u5f15\u7528\u6587\u4ef6\u8d44\u6e90\uff0c\u800c\u65e0\u9700\u91cd\u590d\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u903b\u8f91\u3002</p> <p>\u53e6\u4e00\u4e2a\u793a\u4f8b\u53ef\u80fd\u662f\u4f7f\u7528\u4f9d\u8d56\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u3002</p> <pre><code>service { 'sshd': \n   subscribe =&gt; File[sshdconfig], \n} \n</code></pre> <p>\u6709\u4e86\u8fd9\u4e2a\u4f9d\u8d56\uff0c\u4e00\u65e6 sshdconfig \u6587\u4ef6\u53d1\u751f\u53d8\u5316\uff0csshd \u670d\u52a1\u603b\u662f\u4f1a\u91cd\u542f\u3002</p> <p>\u8fd9\u91cc\u8981\u8bb0\u4f4f\u7684\u4e00\u70b9\u662f File[sshdconfig] \u662f\u4e00\u4e2a\u5c0f\u5199\u5f62\u5f0f\u7684 File \u58f0\u660e\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u5c06\u5176\u66f4\u6539\u4e3a FILE[sshdconfig] \u90a3\u4e48\u5b83\u5c06\u662f\u4e00\u4e2a\u5f15\u7528\u3002</p> <p>\u5728\u58f0\u660e\u8d44\u6e90\u65f6\u9700\u8981\u7262\u8bb0\u7684\u4e00\u4e2a\u57fa\u672c\u70b9\u662f\uff0c\u6bcf\u4e2a\u914d\u7f6e\u6587\u4ef6\u53ea\u80fd\u58f0\u660e\u4e00\u6b21\u3002\u591a\u6b21\u91cd\u590d\u58f0\u660e\u540c\u4e00\u8d44\u6e90\u4f1a\u5bfc\u81f4\u9519\u8bef\u3002\u901a\u8fc7\u8fd9\u4e2a\u57fa\u672c\u6982\u5ff5\uff0cPuppet \u786e\u4fdd\u914d\u7f6e\u5f97\u5230\u5f88\u597d\u7684\u5efa\u6a21\u3002</p> <p>\u6211\u4eec\u751a\u81f3\u6709\u80fd\u529b\u7ba1\u7406\u8d44\u6e90\u4f9d\u8d56\uff0c\u8fd9\u6709\u52a9\u4e8e\u7ba1\u7406\u591a\u4e2a\u5173\u7cfb\u3002</p> <pre><code>service { 'sshd': \n   require =&gt; File['sshdconfig', 'sshconfig', 'authorized_keys']\n}   \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#2-metaparameters","title":"2 Metaparameters","text":"<p>Metaparameters\u5728 Puppet \u4e2d\u79f0\u4e3a\u5168\u5c40\u53c2\u6570\u3002Metaparameters\u7684\u5173\u952e\u7279\u6027\u4e4b\u4e00\u662f\uff0c\u5b83\u9002\u7528\u4e8e Puppet \u4e2d\u7684\u4efb\u4f55\u7c7b\u578b\u7684\u8d44\u6e90\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#2-1","title":"2-1 \u8d44\u6e90\u9ed8\u8ba4\u503c","text":"<p>\u5f53\u9700\u8981\u5b9a\u4e49\u9ed8\u8ba4\u8d44\u6e90\u5c5e\u6027\u503c\u65f6\uff0cPuppet \u63d0\u4f9b\u4e86\u4e00\u7ec4\u8bed\u6cd5\u6765\u5f52\u6863\u5b83\uff0c\u4f7f\u7528\u6ca1\u6709\u6807\u9898\u7684\u5927\u5199\u8d44\u6e90\u89c4\u8303\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8bbe\u7f6e\u6240\u6709\u53ef\u6267\u884c\u6587\u4ef6\u7684\u9ed8\u8ba4\u8def\u5f84\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b8c\u6210\u3002</p> <pre><code>Exec { path =&gt; '/usr/bin:/bin:/usr/sbin:/sbin' } \nexec { 'echo Testing mataparamaters.': } \n</code></pre> <p>\u5728\u4e0a\u8ff0\u547d\u4ee4\u4e2d\uff0c\u7b2c\u4e00\u6761\u8bed\u53e5 Exec \u5c06\u8bbe\u7f6e exec \u8d44\u6e90\u7684\u9ed8\u8ba4\u503c\u3002 Exec \u8d44\u6e90\u9700\u8981\u5b8c\u5168\u9650\u5b9a\u7684\u8def\u5f84\u6216\u770b\u8d77\u6765\u50cf\u53ef\u6267\u884c\u6587\u4ef6\u7684\u8def\u5f84\u3002</p> <p>\u6709\u4e86\u8fd9\u4e2a\uff0c\u53ef\u4ee5\u4e3a\u6574\u4e2a\u914d\u7f6e\u5b9a\u4e49\u4e00\u4e2a\u9ed8\u8ba4\u8def\u5f84\u3002\u9ed8\u8ba4\u503c\u9002\u7528\u4e8e Puppet \u4e2d\u7684\u4efb\u4f55\u8d44\u6e90\u7c7b\u578b\u3002</p> <p>\u9ed8\u8ba4\u503c\u4e0d\u662f\u5168\u5c40\u503c\uff0c\u4f46\u662f\uff0c\u5b83\u4eec\u53ea\u5f71\u54cd\u5b9a\u4e49\u5b83\u4eec\u7684\u8303\u56f4\u6216\u5b83\u7684\u4e0b\u4e00\u4e2a\u53d8\u91cf\u3002</p> <p>\u5982\u679c\u60f3\u8981\u4e3a\u5b8c\u6574\u7684\u914d\u7f6e\u5b9a\u4e49\u9ed8\u8ba4\u503c\uff0c\u90a3\u4e48\u6211\u4eec\u5c06\u5728\u4e0b\u4e00\u8282\u4e2d\u5b9a\u4e49\u9ed8\u8ba4\u503c\u548c\u7c7b\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#3","title":"3 \u8d44\u6e90\u96c6\u5408","text":"<p>\u805a\u5408\u662f\u5c06\u4e8b\u7269\u6536\u96c6\u5728\u4e00\u8d77\u7684\u65b9\u6cd5\u3002 Puppet \u652f\u6301\u975e\u5e38\u5f3a\u5927\u7684\u805a\u5408\u6982\u5ff5\u3002\u5728 Puppet \u4e2d\uff0c\u805a\u5408\u7528\u4e8e\u5c06 Puppet \u7684\u57fa\u672c\u5355\u5143\u8d44\u6e90\u5206\u7ec4\u5728\u4e00\u8d77\u3002 </p> <p>Puppet \u4e2d\u7684\u8fd9\u79cd\u805a\u5408\u6982\u5ff5\u662f\u901a\u8fc7\u4f7f\u7528\u79f0\u4e3a\u7c7b\u548c\u5b9a\u4e49\u7684\u4e24\u79cd\u5f3a\u5927\u65b9\u6cd5\u6765\u5b9e\u73b0\u7684\u3002</p> <p>\u805a\u5408\u662f\u5c06\u4e8b\u7269\u6536\u96c6\u5728\u4e00\u8d77\u7684\u65b9\u6cd5\u3002 Puppet \u652f\u6301\u975e\u5e38\u5f3a\u5927\u7684\u805a\u5408\u6982\u5ff5\u3002\u5728 Puppet \u4e2d\uff0c\u805a\u5408\u7528\u4e8e\u5c06 Puppet \u7684\u57fa\u672c\u5355\u5143\u8d44\u6e90\u5206\u7ec4\u5728\u4e00\u8d77\u3002 Puppet \u4e2d\u7684\u8fd9\u79cd\u805a\u5408\u6982\u5ff5\u662f\u901a\u8fc7\u4f7f\u7528\u79f0\u4e3a\u7c7bClass\u548c\u5b9a\u4e49definition\u7684\u4e24\u79cd\u5f3a\u5927\u65b9\u6cd5\u6765\u5b9e\u73b0\u7684\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#3-1-classes-and-definition","title":"3-1 Classes and Definition","text":"<p>\u7c7bClasses \u8d1f\u8d23\u5bf9\u8282\u70b9\u7684\u57fa\u672c\u65b9\u9762\u8fdb\u884c\u5efa\u6a21\u3002\u4ed6\u4eec\u53ef\u4ee5\u8bf4\u8282\u70b9\u662f\u4e00\u4e2a Web \u670d\u52a1\u5668\uff0c\u800c\u8fd9\u4e2a\u7279\u5b9a\u7684\u8282\u70b9\u5c31\u662f\u5176\u4e2d\u4e4b\u4e00\u3002</p> <p>\u5728 Puppet \u4e2d\uff0c\u7f16\u7a0b\u7c7b\u662f\u5355\u4f8b\u7684\uff0c\u6bcf\u4e2a\u8282\u70b9\u53ef\u4ee5\u8bc4\u4f30\u4e00\u6b21\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u5b9a\u4e49\u53ef\u4ee5\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u591a\u6b21\u4f7f\u7528\u3002\u5b83\u4eec\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e\u4f7f\u7528\u8be5\u8bed\u8a00\u521b\u5efa\u81ea\u5df1\u7684 Puppet \u7c7b\u578b\u7c7b\u4f3c\u3002</p> <p>\u5b83\u4eec\u88ab\u521b\u5efa\u4e3a\u591a\u6b21\u4f7f\u7528\uff0c\u6bcf\u6b21\u90fd\u6709\u4e0d\u540c\u7684\u8f93\u5165\u3002\u8fd9\u610f\u5473\u7740\u53ef\u4ee5\u5c06\u53d8\u91cf\u503c\u4f20\u9012\u5230\u5b9a\u4e49\u4e2d\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#3-2","title":"3-2 \u7c7b\u4e0e\u5b9a\u4e49\u7684\u533a\u522b","text":"<p>\u7c7b\u548c\u5b9a\u4e49\u4e4b\u95f4\u7684\u552f\u4e00\u5173\u952e\u533a\u522b\u662f\u5728\u5b9a\u4e49\u6784\u5efa\u7ed3\u6784\u548c\u5206\u914d\u8d44\u6e90\u65f6\uff0c\u6bcf\u4e2a\u8282\u70b9\u53ea\u5bf9\u7c7b\u8fdb\u884c\u4e00\u6b21\u8bc4\u4f30\uff0c\u800c\u53e6\u4e00\u65b9\u9762\uff0c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u591a\u6b21\u4f7f\u7528\u5b9a\u4e49\u3002</p> <p>Classes</p> <p>Puppet \u4e2d\u7684\u7c7b\u662f\u4f7f\u7528 class \u5173\u952e\u5b57\u5f15\u5165\u7684\uff0c\u8be5\u7279\u5b9a\u7c7b\u7684\u5185\u5bb9\u5305\u542b\u5728\u82b1\u62ec\u53f7\u5185\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>class unix { \n   file { \n      '/etc/passwd': \n      owner =&gt; 'superuser', \n      group =&gt; 'superuser', \n      mode =&gt; 644; \n      '/etc/shadow': \n      owner =&gt; 'vipin', \n      group =&gt; 'vipin', \n      mode =&gt; 440; \n   } \n}\n</code></pre> <p>\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u4e9b\u7c7b\u4f3c\u4e8e\u4e0a\u9762\u7684\u7b80\u5199\u3002</p> <pre><code>class unix { \n   file { \n      '/etc/passwd': \n      owner =&gt; 'superuser', \n      group =&gt; 'superuser', \n      mode =&gt; 644; \n   }  \n\n   file {'/etc/shadow': \n      owner =&gt; 'vipin', \n      group =&gt; 'vipin', \n      mode =&gt; 440; \n   } \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#3-3-puppet","title":"3-3 Puppet \u7c7b\u4e2d\u7684\u7ee7\u627f","text":"<p>\u5728 Puppet \u4e2d\uff0c\u9ed8\u8ba4\u652f\u6301 OOP \u7684\u7ee7\u627f\u6982\u5ff5\uff0c\u5176\u4e2d\u7c7b\u53ef\u4ee5\u6269\u5c55\u5148\u524d\u7684\u529f\u80fd\uff0c\u800c\u65e0\u9700\u5728\u65b0\u521b\u5efa\u7684\u7c7b\u4e2d\u518d\u6b21\u590d\u5236\u548c\u7c98\u8d34\u5b8c\u6574\u7684\u4ee3\u7801\u4f4d\u3002\u7ee7\u627f\u5141\u8bb8\u5b50\u7c7b\u8986\u76d6\u7236\u7c7b\u4e2d\u5b9a\u4e49\u7684\u8d44\u6e90\u8bbe\u7f6e\u3002\u4f7f\u7528\u7ee7\u627f\u65f6\u8981\u8bb0\u4f4f\u7684\u4e00\u4ef6\u4e8b\u662f\uff0c\u4e00\u4e2a\u7c7b\u53ea\u80fd\u4ece\u4e00\u4e2a\u7236\u7c7b\u7ee7\u627f\u7279\u6027\uff0c\u4e0d\u80fd\u8d85\u8fc7\u4e00\u4e2a\u3002</p> <pre><code>class superclass inherits testsubclass { \n   File['/etc/passwd'] { group =&gt; wheel } \n   File['/etc/shadow'] { group =&gt; wheel } \n}\n</code></pre> <p>\u5982\u679c\u9700\u8981\u64a4\u6d88\u7236\u7c7b\u4e2d\u6307\u5b9a\u7684\u67d0\u4e9b\u903b\u8f91\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 undef \u547d\u4ee4\u3002</p> <pre><code>class superclass inherits testsubcalss { \n   File['/etc/passwd'] { group =&gt; undef } \n} \n</code></pre> <p>\u4f7f\u7528\u7ee7\u627f\u7684\u53e6\u4e00\u79cd\u65b9\u5f0f</p> <pre><code>class tomcat { \n   service { 'tomcat': require =&gt; Package['httpd'] } \n} \nclass open-ssl inherits tomcat { \n   Service[tomcat] { require +&gt; File['tomcat.pem'] } \n}\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#3-4-puppet","title":"3-4 Puppet \u4e2d\u7684\u5d4c\u5957\u7c7b","text":"<p>Puppet \u652f\u6301\u7c7b\u5d4c\u5957\u7684\u6982\u5ff5\uff0c\u5b83\u5141\u8bb8\u4f7f\u7528\u5d4c\u5957\u7c7b\uff0c\u8fd9\u610f\u5473\u7740\u4e00\u4e2a\u7c7b\u5728\u53e6\u4e00\u4e2a\u7c7b\u4e2d\u3002\u8fd9\u6709\u52a9\u4e8e\u5b9e\u73b0\u6a21\u5757\u5316\u548c\u8303\u56f4\u754c\u5b9a\u3002</p> <pre><code>class testclass { \n   class nested { \n      file {  \n         '/etc/passwd': \n         owner =&gt; 'superuser', \n         group =&gt; 'superuser', \n         mode =&gt; 644; \n      } \n   } \n} \nclass anotherclass { \n   include myclass::nested \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#3-5","title":"3-5 \u53c2\u6570\u5316\u7c7b","text":"<p>\u5728 Puppet \u4e2d\uff0c\u7c7b\u53ef\u4ee5\u6269\u5c55\u5176\u529f\u80fd\u4ee5\u5141\u8bb8\u5c06\u53c2\u6570\u4f20\u9012\u7ed9\u7c7b\u3002</p> <p>\u8981\u5728\u7c7b\u4e2d\u4f20\u9012\u53c2\u6570\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6784\u9020 -</p> <pre><code>class tomcat($version) { \n   ... class contents ... \n} \n</code></pre> <p>\u5728 Puppet \u4e2d\u8981\u8bb0\u4f4f\u7684\u4e00\u4e2a\u5173\u952e\u70b9\u662f\uff0c\u5e26\u53c2\u6570\u7684\u7c7b\u4e0d\u662f\u4f7f\u7528 include \u51fd\u6570\u6dfb\u52a0\u7684\uff0c\u800c\u662f\u53ef\u4ee5\u5c06\u751f\u6210\u7684\u7c7b\u4f5c\u4e3a\u5b9a\u4e49\u6dfb\u52a0</p> <pre><code>node webserver { \n   class { tomcat: version =&gt; \"1.2.12\" } \n}\n</code></pre> <p>\u9ed8\u8ba4\u503c\u4f5c\u4e3a\u7c7b\u4e2d\u7684\u53c2\u6570</p> <pre><code>class tomcat($version = \"1.2.12\",$home = \"/var/www\") { \n   ... class contents ... \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#4-run-stages","title":"4 Run Stages","text":"<p>Puppet \u652f\u6301\u8fd0\u884c\u9636\u6bb5\u7684\u6982\u5ff5\uff0c\u8fd9\u610f\u5473\u7740\u7528\u6237\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6dfb\u52a0\u591a\u4e2a\u9636\u6bb5\uff0c\u4ee5\u7ba1\u7406\u4efb\u4f55\u7279\u5b9a\u8d44\u6e90\u6216\u591a\u4e2a\u8d44\u6e90\u3002\u5f53\u7528\u6237\u60f3\u8981\u5f00\u53d1\u590d\u6742\u7684\u76ee\u5f55\u65f6\uff0c\u6b64\u529f\u80fd\u975e\u5e38\u6709\u7528\u3002</p> <p>\u5728\u4e00\u4e2a\u590d\u6742\u7684\u76ee\u5f55\u4e2d\uff0c\u6709\u5927\u91cf\u7684\u8d44\u6e90\u9700\u8981\u7f16\u8bd1\uff0c\u540c\u65f6\u8bb0\u4f4f\u4e0d\u5e94\u8be5\u5f71\u54cd\u5b9a\u4e49\u7684\u8d44\u6e90\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>Run Stage \u5728\u7ba1\u7406\u8d44\u6e90\u4f9d\u8d56\u65b9\u9762\u975e\u5e38\u6709\u5e2e\u52a9\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728\u5b9a\u4e49\u7684\u9636\u6bb5\u6dfb\u52a0\u7c7b\u6765\u5b8c\u6210\uff0c\u5176\u4e2d\u7279\u5b9a\u7c7b\u5305\u542b\u8d44\u6e90\u96c6\u5408\u3002</p> <p>\u901a\u8fc7\u8fd0\u884c\u9636\u6bb5\uff0cPuppet \u4fdd\u8bc1\u5b9a\u4e49\u7684\u9636\u6bb5\u5c06\u5728\u6bcf\u6b21\u76ee\u5f55\u8fd0\u884c\u5e76\u5e94\u7528\u4e8e\u4efb\u4f55 Puppet \u8282\u70b9\u65f6\u4ee5\u6307\u5b9a\u7684\u53ef\u9884\u6d4b\u987a\u5e8f\u8fd0\u884c\u3002</p> <p>\u4e3a\u4e86\u4f7f\u7528\u5b83\uff0c\u9700\u8981\u5728\u5df2\u7ecf\u5b58\u5728\u7684\u9636\u6bb5\u4e4b\u5916\u58f0\u660e\u989d\u5916\u7684\u9636\u6bb5\uff0c\u7136\u540e\u53ef\u4ee5\u5c06 Puppet \u914d\u7f6e\u4e3a\u4f7f\u7528\u76f8\u540c\u7684\u8d44\u6e90\u5173\u7cfb\u8bed\u6cd5\u6309\u6307\u5b9a\u7684\u987a\u5e8f\u7ba1\u7406\u6bcf\u4e2a\u9636\u6bb5\uff0c\u7136\u540e\u518d\u4f7f\u7528 <code>require \u201c-&gt;\u201d</code> \u548c <code>\u201c+&gt;\u201d</code>\u3002\u7136\u540e\uff0c\u8be5\u5173\u7cfb\u5c06\u4fdd\u8bc1\u4e0e\u6bcf\u4e2a\u9636\u6bb5\u5173\u8054\u7684\u7c7b\u7684\u987a\u5e8f\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#4-1-puppet","title":"4-1 \u4f7f\u7528 Puppet \u58f0\u660e\u5f0f\u8bed\u6cd5\u58f0\u660e\u5176\u4ed6\u9636\u6bb5","text":"<pre><code>stage { \"first\": before =&gt; Stage[main] } \nstage { \"last\": require =&gt; Stage[main] } \n</code></pre> <p>\u4e00\u65e6\u58f0\u660e\u4e86\u9636\u6bb5\uff0c\u4e00\u4e2a\u7c7b\u53ef\u4ee5\u4e0e\u8be5\u9636\u6bb5\u76f8\u5173\u8054\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u8be5\u9636\u6bb5\u7684\u4e3b\u8981\u9636\u6bb5\u3002</p> <pre><code>class { \n   \"apt-keys\": stage =&gt; first; \n   \"sendmail\": stage =&gt; main; \n   \"apache\": stage =&gt; last; \n}\n</code></pre> <ul> <li>\u4e0e\u7c7b apt-key \u5173\u8054\u7684\u6240\u6709\u8d44\u6e90\u5c06\u9996\u5148\u8fd0\u884c\u3002 </li> <li>Sendmail \u4e2d\u7684\u6240\u6709\u8d44\u6e90\u5c06\u662f\u4e3b\u7c7b\uff0c</li> <li>\u4e0e Apache \u76f8\u5173\u7684\u8d44\u6e90\u5c06\u662f\u6700\u540e\u4e00\u4e2a\u9636\u6bb5\u3002</li> </ul>"},{"location":"chap6_pp/3pp_coding_style/#5-definitions","title":"5 \u5b9a\u4e49 Definitions","text":"<p>\u5728 Puppet \u4e2d\uff0c\u4efb\u4f55\u6e05\u5355\u6587\u4ef6\u4e2d\u7684\u8d44\u6e90\u6536\u96c6\u90fd\u662f\u901a\u8fc7\u7c7bclass\u6216\u5b9a\u4e49defintions\u5b8c\u6210\u7684\u3002</p> <p>\u5b9a\u4e49\u4e0e Puppet \u4e2d\u7684\u7c7b\u975e\u5e38\u76f8\u4f3c\uff0c\u4f46\u662f\u5b83\u4eec\u662f\u901a\u8fc7\u5b9a\u4e49 \u5173\u952e\u5b57\uff08\u4e0d\u662f\u7c7b\uff09define keyword (not class) \u5f15\u5165\u7684\uff0c\u5e76\u4e14\u5b83\u4eec\u652f\u6301\u53c2\u6570\u800c\u4e0d\u662f\u7ee7\u627f\u3002\u5b83\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u53c2\u6570\u5728\u540c\u4e00\u7cfb\u7edf\u4e0a\u591a\u6b21\u8fd0\u884c\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a\u4eba\u60f3\u8981\u521b\u5efa\u4e00\u4e2a\u5b9a\u4e49\u6765\u63a7\u5236\u6e90\u4ee3\u7801\u5b58\u50a8\u5e93\uff0c\u5176\u4e2d\u4e00\u4e2a\u4eba\u8bd5\u56fe\u5728\u540c\u4e00\u7cfb\u7edf\u4e0a\u521b\u5efa\u591a\u4e2a\u5b58\u50a8\u5e93\uff0c\u90a3\u4e48\u53ef</p> <pre><code>define perforce_repo($path) { \n   exec {  \n      \"/usr/bin/svnadmin create $path/$title\": \n      unless =&gt; \"/bin/test -d $path\", \n   } \n} \nsvn_repo { puppet_repo: path =&gt; '/var/svn_puppet' } \nsvn_repo { other_repo: path =&gt; '/var/svn_other' }\n</code></pre> <p>\u8fd9\u91cc\u8981\u6ce8\u610f\u7684\u5173\u952e\u70b9\u662f\u5982\u4f55\u5c06\u53d8\u91cf\u4e0e\u5b9a\u4e49\u4e00\u8d77\u4f7f\u7528\u3002\u6211\u4eec\u4f7f\u7528 <code>($)</code>\u7f8e\u5143\u7b26\u53f7\u53d8\u91cf\u3002</p> <p>\u5728\u4e0a\u9762\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 <code>$title</code>\u3002\u5b9a\u4e49\u53ef\u4ee5\u540c\u65f6\u5177\u6709 <code>$title</code>\u548c <code>$name</code> \u6765\u8868\u793a\u540d\u79f0\u548c\u6807\u9898\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>$title</code> \u548c <code>$name</code> \u8bbe\u7f6e\u4e3a\u76f8\u540c\u7684\u503c\uff0c\u4f46\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a title \u5c5e\u6027\u5e76\u5c06\u4e0d\u540c\u7684\u540d\u79f0\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u3002 <code>$title</code> \u548c <code>$name</code> \u4ec5\u9002\u7528\u4e8e\u5b9a\u4e49\uff0c\u4e0d\u9002\u7528\u4e8e\u7c7b\u6216\u5176\u4ed6\u8d44\u6e90\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#6-modules","title":"6 Modules","text":"<p>\u4e00\u4e2a\u6a21\u5757\u53ef\u4ee5\u5b9a\u4e49\u4e3a\u6240\u6709\u914d\u7f6e\u7684\u96c6\u5408\uff0cPuppet master \u5c06\u4f7f\u7528\u8fd9\u4e9b\u914d\u7f6e\u5728\u4efb\u4f55\u7279\u5b9a\u7684 Puppet \u8282\u70b9\uff08\u4ee3\u7406\uff09\u4e0a\u5e94\u7528\u914d\u7f6e\u66f4\u6539\u3002</p> <p>\u5b83\u4eec\u4e5f\u88ab\u79f0\u4e3a\u6267\u884c\u7279\u5b9a\u4efb\u52a1\u6240\u9700\u7684\u4e0d\u540c\u7c7b\u578b\u914d\u7f6e\u7684\u4fbf\u643a\u5f0f\u96c6\u5408\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u6a21\u5757\u53ef\u80fd\u5305\u542b\u914d\u7f6e Postfix \u548c Apache \u6240\u9700\u7684\u6240\u6709\u8d44\u6e90\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#7","title":"7 \u8282\u70b9","text":"<p>\u8282\u70b9\u662f\u975e\u5e38\u7b80\u5355\u7684\u5269\u4f59\u6b65\u9aa4\uff0c\u8fd9\u662f\u6211\u4eec\u5982\u4f55\u5c06\u6211\u4eec\u5b9a\u4e49\u7684\u5185\u5bb9\uff08\u201c\u8fd9\u5c31\u662fWebserver\u7684\u6837\u5b50\u201d\uff09\u4e0e\u9009\u62e9\u54ea\u4e9b\u673a\u5668\u6765\u5b8c\u6210\u8fd9\u4e9b\u6307\u4ee4\u76f8\u5339\u914d\u3002</p> <p>\u8282\u70b9\u5b9a\u4e49\u770b\u8d77\u6765\u5c31\u50cf\u7c7b\uff0c\u5305\u62ec\u652f\u6301\u7684\u7ee7\u627f\uff0c\u4f46\u662f\u5b83\u4eec\u662f\u7279\u6b8a\u7684\uff0c\u5f53\u4e00\u4e2a\u8282\u70b9\uff08\u8fd0\u884c puppet \u5ba2\u6237\u7aef\u7684\u6258\u7ba1\u8ba1\u7b97\u673a\uff09\u8fde\u63a5\u5230 Puppet \u4e3b\u5b88\u62a4\u7a0b\u5e8f\u65f6\uff0c\u5b83\u7684\u540d\u79f0\u5c06\u5728\u5b9a\u4e49\u7684\u8282\u70b9\u5217\u8868\u4e2d\u67e5\u627e\u3002\u5b9a\u4e49\u7684\u4fe1\u606f\u5c06\u9488\u5bf9\u8282\u70b9\u8fdb\u884c\u8bc4\u4f30\uff0c\u7136\u540e\u8282\u70b9\u5c06\u53d1\u9001\u8be5\u914d\u7f6e\u3002</p> <pre><code>node 'www.vipin.com' { \n   include common \n   include apache, squid \n}\n</code></pre> <p>\u4e0a\u9762\u7684\u5b9a\u4e49\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a www.vipin.com \u7684\u8282\u70b9\uff0c\u5e76\u5305\u542b\u4e86 common\u3001Apache \u548c Squid \u7c7b</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7528\u9017\u53f7\u5206\u9694\u6bcf\u4e2a\u8282\u70b9\u6765\u5c06\u76f8\u540c\u7684\u914d\u7f6e\u53d1\u9001\u5230\u4e0d\u540c\u7684\u8282\u70b9\u3002</p> <pre><code>node 'www.testing.com', 'www.testing2.com', 'www3.testing.com' { \n   include testing \n   include tomcat, squid \n}\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#_1","title":"\u5339\u914d\u8282\u70b9\u7684\u6b63\u5219\u8868\u8fbe\u5f0f","text":"<pre><code>node /^www\\d+$/ { \n   include testing \n}\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#_2","title":"\u8282\u70b9\u7ee7\u627f","text":"<p>Node \u652f\u6301\u6709\u9650\u7684\u7ee7\u627f\u6a21\u578b\u3002\u50cf\u7c7b\u4e00\u6837\uff0c\u8282\u70b9\u53ea\u80fd\u4ece\u53e6\u4e00\u4e2a\u8282\u70b9\u7ee7\u627f</p> <pre><code>node 'www.testing2.com' inherits 'www.testing.com' { \n   include loadbalancer \n}\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0cwww.testing2.com \u7ee7\u627f\u4e86 www.testing.com \u7684\u6240\u6709\u529f\u80fd\u4ee5\u53ca\u4e00\u4e2a\u989d\u5916\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u7c7b\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#8","title":"8 \u9ad8\u7ea7\u652f\u6301\u7684\u529f\u80fd","text":"<p>\u5f15\u7528 - \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u5728 Puppet \u4e2d\u5f15\u7528\u5b57\u7b26\u4e32\u3002\u4efb\u4f55\u4ee5\u5b57\u6bcd\u5f00\u5934\u7684\u5b57\u6bcd\u6570\u5b57\u5b57\u7b26\u4e32\u90fd\u5e94\u4e0d\u52a0\u5f15\u53f7\u3002\u4f46\u662f\uff0c\u4e3a\u4efb\u4f55\u975e\u8d1f\u503c\u5f15\u7528\u5b57\u7b26\u4e32\u59cb\u7ec8\u662f\u6700\u4f73\u5b9e\u8df5\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#variable-interpolation-with-quotes","title":"\u5e26\u5f15\u53f7\u7684\u53d8\u91cf\u63d2\u503c Variable Interpolation with Quotes","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u5728\u5b9a\u4e49\u65b9\u9762\u63d0\u5230\u4e86\u53d8\u91cf\u3002\u5982\u679c\u9700\u8981\u5c06\u8fd9\u4e9b\u53d8\u91cf\u4e0e\u5b57\u7b26\u4e32\u4e00\u8d77\u4f7f\u7528\uff0c\u8bf7\u4f7f\u7528\u53cc\u5f15\u53f7\uff0c\u800c\u4e0d\u662f\u5355\u5f15\u53f7\u3002\u5355\u5f15\u53f7\u5b57\u7b26\u4e32\u4e0d\u4f1a\u505a\u4efb\u4f55\u53d8\u91cf\u63d2\u503c\uff0c\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u4f1a\u505a\u3002\u53d8\u91cf\u53ef\u4ee5\u62ec\u5728 <code>{}</code> \u4e2d\uff0c\u8fd9\u4f7f\u5b83\u4eec\u66f4\u6613\u4e8e\u4e00\u8d77\u4f7f\u7528\u4e14\u66f4\u6613\u4e8e\u7406\u89e3\u3002</p> <pre><code>$value = \"${one}${two}\"\n</code></pre> <p>\u4f5c\u4e3a\u4e00\u79cd\u6700\u4f73\u5b9e\u8df5\uff0c\u5e94\u8be5\u5bf9\u6240\u6709\u4e0d\u9700\u8981\u5b57\u7b26\u4e32\u63d2\u503c\u7684\u5b57\u7b26\u4e32\u4f7f\u7528\u5355\u5f15\u53f7\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#9-capitalization","title":"9 Capitalization","text":"<p>Capitalization\u662f\u7528\u4e8e\u5f15\u7528\u3001\u7ee7\u627f\u548c\u8bbe\u7f6e\u7279\u5b9a\u8d44\u6e90\u7684\u9ed8\u8ba4\u5c5e\u6027\u7684\u8fc7\u7a0b\u3002\u57fa\u672c\u4e0a\u6709\u4e24\u79cd\u57fa\u672c\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <ul> <li>\u5f15\u7528 Referencing - \u8fd9\u662f\u5f15\u7528\u5df2\u521b\u5efa\u8d44\u6e90\u7684\u65b9\u5f0f\u3002\u5b83\u4e3b\u8981\u7528\u4e8e\u4f9d\u8d56\u76ee\u7684\uff0c\u5fc5\u987b\u5c06\u8d44\u6e90\u540d\u79f0\u5927\u5199\u3002\u4f8b\u5982\uff0c<code>\u8981\u6c42 =&gt; \u6587\u4ef6 [sshdconfig]</code></li> <li>\u7ee7\u627f Inheritance - \u4ece\u5b50\u7c7b\u8986\u76d6\u7236\u7c7b\u7684\u8bbe\u7f6e\u65f6\uff0c\u4f7f\u7528\u8d44\u6e90\u540d\u79f0\u7684\u5927\u5199\u7248\u672c\u3002\u4f7f\u7528\u5c0f\u5199\u7248\u672c\u5c06\u5bfc\u81f4\u9519\u8bef\u3002</li> <li>\u8bbe\u7f6e\u9ed8\u8ba4\u5c5e\u6027\u503c - \u4f7f\u7528\u6ca1\u6709\u6807\u9898\u7684\u5927\u5199\u8d44\u6e90\u6765\u8bbe\u7f6e\u8d44\u6e90\u7684\u9ed8\u8ba4\u503c\u3002</li> </ul>"},{"location":"chap6_pp/3pp_coding_style/#10","title":"10 \u6570\u7ec4","text":"<p>Puppet \u5141\u8bb8\u5728\u591a\u4e2a\u533a\u57df [1,2,3] \u4e2d\u4f7f\u7528\u6570\u7ec4\u3002</p> <p>\u4e00\u4e9b\u7c7b\u578b\u6210\u5458\uff0c\u4f8b\u5982\u4e3b\u673a\u5b9a\u4e49\u4e2d\u7684\u522b\u540d\uff0c\u5728\u5176\u503c\u4e2d\u63a5\u53d7\u6570\u7ec4\u3002\u5177\u6709\u591a\u4e2a\u522b\u540d\u7684\u4e3b\u673a\u8d44\u6e90\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>host { 'one.vipin.com': \n   alias =&gt; [ 'satu', 'dua', 'tiga' ], \n   ip =&gt; '192.168.100.1', \n   ensure =&gt; present, \n}\n</code></pre> <p>\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u5c06\u4e3b\u673a<code>\u201cone.brcletest.com\u201d</code>\u6dfb\u52a0\u5230\u5177\u6709\u4e09\u4e2a\u522b\u540d<code>\u201csatu\u201d\u201cdua\u201d\u201ctiga\u201d</code>\u7684\u4e3b\u673a\u5217\u8868\u4e2d\u3002\u5982\u679c\u60f3\u5c06\u591a\u4e2a\u8d44\u6e90\u6dfb\u52a0\u5230\u4e00\u4e2a\u8d44\u6e90\u4e2d\uff0c\u53ef\u4ee5\u5982\u4e0b\u4f8b\u6240\u793a\u8fdb\u884c\u3002</p> <pre><code>resource { 'baz': \n   require =&gt; [ Package['rpm'], File['testfile'] ], \n}\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#11","title":"11 \u53d8\u91cf","text":"<p>\u50cf\u5927\u591a\u6570\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u4e00\u6837\uff0cPuppet \u652f\u6301\u591a\u4e2a\u53d8\u91cf\u3002 Puppet \u53d8\u91cf\u7528 <code>$</code> \u8868\u793a\u3002</p> <pre><code>$content = 'some content\\n' \nfile { '/tmp/testing': content =&gt; $content } \n</code></pre> <p>\u5982\u524d\u6240\u8ff0\uff0cPuppet \u662f\u4e00\u79cd\u58f0\u660e\u5f0f\u8bed\u8a00\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u7684\u4f5c\u7528\u57df\u548c\u8d4b\u503c\u89c4\u5219\u4e0e\u547d\u4ee4\u5f0f\u8bed\u8a00\u4e0d\u540c\u3002</p> <p>\u4e3b\u8981\u533a\u522b\u5728\u4e8e\u4e0d\u80fd\u5728\u5355\u4e2a\u8303\u56f4\u5185\u66f4\u6539\u53d8\u91cf\uff0c\u56e0\u4e3a\u5b83\u4eec\u4f9d\u8d56\u4e8e\u6587\u4ef6\u4e2d\u7684\u987a\u5e8f\u6765\u786e\u5b9a\u53d8\u91cf\u7684\u503c\u3002\u987a\u5e8f\u5728\u58f0\u660e\u6027\u8bed\u8a00\u4e2d\u65e0\u5173\u7d27\u8981\u3002</p> <pre><code>$user = root \nfile {  \n   '/etc/passwd': \n   owner =&gt; $user, \n} \n\n$user = bin \n   file {  \n      '/bin': \n      owner =&gt; $user, \n      recurse =&gt; true, \n   }\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#_3","title":"\u53d8\u91cf\u8303\u56f4","text":"<p>\u53d8\u91cf\u8303\u56f4\u5b9a\u4e49\u662f\u5426\u6240\u6709\u5b9a\u4e49\u7684\u53d8\u91cf\u90fd\u6709\u6548\u3002\u4e0e\u6700\u65b0\u529f\u80fd\u4e00\u6837\uff0cPuppet \u76ee\u524d\u662f\u52a8\u6001\u8303\u56f4\u7684\uff0c\u5728 Puppet \u672f\u8bed\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u6240\u6709\u5b9a\u4e49\u7684\u53d8\u91cf\u90fd\u5728\u5176\u8303\u56f4\u5185\u8fdb\u884c\u8bc4\u4f30\uff0c\u800c\u4e0d\u662f\u5728\u5b83\u4eec\u5b9a\u4e49\u7684\u4f4d\u7f6e\u4e0a\u8fdb\u884c\u8bc4\u4f30\u3002</p> <pre><code>$test = 'top' \nclass Testclass { \n   exec { \"/bin/echo $test\": logoutput =&gt; true } \n} \n\nclass Secondtestclass { \n   $test = 'other' \n   include myclass \n} \n\ninclude Secondtestclass \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#_4","title":"\u9650\u5b9a\u53d8\u91cf","text":"<p>Puppet \u652f\u6301\u5728\u7c7b\u6216\u5b9a\u4e49\u4e2d\u4f7f\u7528\u9650\u5b9a\u53d8\u91cf\u3002\u5f53\u7528\u6237\u5e0c\u671b\u5728\u4ed6\u5df2\u7ecf\u5b9a\u4e49\u6216\u5c06\u8981\u5b9a\u4e49\u7684\u5176\u4ed6\u7c7b\u4e2d\u4f7f\u7528\u76f8\u540c\u7684\u53d8\u91cf\u65f6\uff0c\u8fd9\u975e\u5e38\u6709\u7528</p> <pre><code>class testclass { \n   $test = 'content' \n} \n\nclass secondtestclass { \n   $other = $myclass::test \n} \n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c$other \u53d8\u91cf\u7684\u503c\u8bc4\u4f30\u4e86\u5185\u5bb9\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#12-conditionals","title":"12 Conditionals","text":"<p>\u6761\u4ef6\u662f\u7528\u6237\u5e0c\u671b\u5728\u6ee1\u8db3\u5b9a\u4e49\u7684\u6761\u4ef6\u6216\u6240\u9700\u6761\u4ef6\u65f6\u6267\u884c\u4e00\u7ec4\u8bed\u53e5\u6216\u4ee3\u7801\u7684\u60c5\u51b5\u3002 Puppet \u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u6761\u4ef6\u3002</p> <p>\u53ea\u80fd\u5728\u5b9a\u4e49\u7684\u8d44\u6e90\u5185\u4f7f\u7528\u9009\u62e9\u5668\u6761\u4ef6\u6765\u9009\u62e9\u673a\u5668\u7684\u6b63\u786e\u503c\u3002</p> <p>\u8bed\u53e5\u6761\u4ef6\u662f\u6e05\u5355\u4e2d\u66f4\u5e7f\u6cdb\u4f7f\u7528\u7684\u6761\u4ef6\uff0c\u5b83\u6709\u52a9\u4e8e\u5305\u542b\u7528\u6237\u5e0c\u671b\u5305\u542b\u5728\u540c\u4e00\u6e05\u5355\u6587\u4ef6\u4e2d\u7684\u5176\u4ed6\u7c7b\u3002\u5728\u4e00\u4e2a\u7c7b\u4e2d\u5b9a\u4e49\u4e00\u7ec4\u4e0d\u540c\u7684\u8d44\u6e90\uff0c\u6216\u505a\u51fa\u5176\u4ed6\u7ed3\u6784\u51b3\u7b56\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#13","title":"13 \u9009\u62e9\u5668","text":"<p>\u5f53\u7528\u6237\u5e0c\u671b\u6307\u5b9a\u4e0e\u57fa\u4e8e\u4e8b\u5b9e\u6216\u5176\u4ed6\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u4e0d\u540c\u7684\u8d44\u6e90\u5c5e\u6027\u548c\u53d8\u91cf\u65f6\uff0c\u9009\u62e9\u5668\u5f88\u6709\u7528\u3002\u5728 Puppet \u4e2d\uff0c\u9009\u62e9\u5668\u7d22\u5f15\u7684\u5de5\u4f5c\u65b9\u5f0f\u7c7b\u4f3c\u4e8e\u591a\u503c\u4e09\u5411\u8fd0\u7b97\u7b26\u3002\u9009\u62e9\u5668\u8fd8\u80fd\u591f\u5728 no \u503c\u4e2d\u5b9a\u4e49\u81ea\u5b9a\u4e49\u9ed8\u8ba4\u503c\uff0c\u8fd9\u4e9b\u503c\u5728\u6e05\u5355\u4e2d\u5b9a\u4e49\u5e76\u5339\u914d\u6761\u4ef6\u3002</p> <pre><code>$owner = $Sysoperenv ? { \n   sunos =&gt; 'adm', \n   redhat =&gt; 'bin', \n   default =&gt; undef, \n}\n</code></pre> <p>\u5728 Puppet 0.25.0 \u7684\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u9009\u62e9\u5668\u53ef\u4ee5\u7528\u4f5c\u6b63\u5219\u8868\u8fbe\u5f0f\u3002</p> <pre><code>$owner = $Sysoperenv ? { \n   /(Linux|Ubuntu)/ =&gt; 'bin', \n   default =&gt; undef, \n}\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u9009\u62e9\u5668 <code>$Sysoperenv</code> \u7684\u503c\u5339\u914d Linux \u6216 Ubuntu\uff0c\u90a3\u4e48 bin \u5c06\u662f\u9009\u62e9\u7684\u7ed3\u679c\uff0c\u5426\u5219\u7528\u6237\u5c06\u88ab\u8bbe\u7f6e\u4e3a undefined\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#14","title":"14 \u8bed\u53e5\u6761\u4ef6","text":"<p>\u8bed\u53e5\u6761\u4ef6\u662f Puppet \u4e2d\u7684\u53e6\u4e00\u79cd\u6761\u4ef6\u8bed\u53e5\uff0c\u4e0e Shell \u811a\u672c\u4e2d\u7684 switch case \u6761\u4ef6\u975e\u5e38\u76f8\u4f3c\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5b9a\u4e49\u4e86\u4e00\u7ec4\u591a\u4f8b\u8bed\u53e5\uff0c\u5e76\u4e14\u7ed9\u5b9a\u7684\u8f93\u5165\u503c\u4e0e\u6bcf\u4e2a\u6761\u4ef6\u5339\u914d\u3002</p> <p>\u5339\u914d\u7ed9\u5b9a\u8f93\u5165\u6761\u4ef6\u7684 case \u8bed\u53e5\u88ab\u6267\u884c\u3002\u6b64 case \u8bed\u53e5\u6761\u4ef6\u6ca1\u6709\u4efb\u4f55\u8fd4\u56de\u503c\u3002\u5728 Puppet \u4e2d\uff0c\u6761\u4ef6\u8bed\u53e5\u7684\u4e00\u4e2a\u975e\u5e38\u5e38\u89c1\u7684\u7528\u4f8b\u662f\u8fd0\u884c\u4e00\u7ec4\u57fa\u4e8e\u5e95\u5c42\u64cd\u4f5c\u7cfb\u7edf\u7684\u4ee3\u7801\u4f4d</p> <pre><code>case $ Sysoperenv { \n   sunos: { include solaris }  \n   redhat: { include redhat }  \n   default: { include generic}  \n}\n</code></pre> <p>Case \u8bed\u53e5\u8fd8\u53ef\u4ee5\u901a\u8fc7\u7528\u9017\u53f7\u5206\u9694\u591a\u4e2a\u6761\u4ef6\u6765\u6307\u5b9a\u591a\u4e2a\u6761\u4ef6\u3002</p> <pre><code>case $Sysoperenv { \n   development,testing: { include development } testing,production: { include production }\n   default: { include generic }  \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#15-if-else","title":"15 If-Else \u8bed\u53e5","text":"<p>Puppet \u652f\u6301\u57fa\u4e8e\u6761\u4ef6\u7684\u64cd\u4f5c\u7684\u6982\u5ff5\u3002\u4e3a\u4e86\u5b9e\u73b0\u5b83\uff0cIf/else \u8bed\u53e5\u63d0\u4f9b\u4e86\u57fa\u4e8e\u6761\u4ef6\u8fd4\u56de\u503c\u7684\u5206\u652f\u9009\u9879\u3002\u5982\u4ee5\u4e0b\u793a\u4f8b\u6240\u793a -</p> <pre><code>if $Filename { \n   file { '/some/file': ensure =&gt; present } \n} else { \n   file { '/some/other/file': ensure =&gt; present } \n} \n</code></pre> <p>\u6700\u65b0\u7248\u672c\u7684 Puppet \u652f\u6301\u53d8\u91cf\u8868\u8fbe\u5f0f\uff0c\u5176\u4e2d if \u8bed\u53e5\u4e5f\u53ef\u4ee5\u6839\u636e\u8868\u8fbe\u5f0f\u7684\u503c\u8fdb\u884c\u5206\u652f\u3002</p> <pre><code>if $machine == 'production' { \n   include ssl \n} else { \n   include nginx \n}\n</code></pre> <p>\u4e3a\u4e86\u5b9e\u73b0\u4ee3\u7801\u7684\u66f4\u591a\u591a\u6837\u6027\u548c\u6267\u884c\u590d\u6742\u7684\u6761\u4ef6\u64cd\u4f5c\uff0cPuppet \u652f\u6301\u5d4c\u5957 if/else \u8bed\u53e5\uff0c\u5982\u4e0b\u4ee3\u7801\u6240\u793a\u3002</p> <pre><code>if $ machine == 'production' { \n   include ssl \n} elsif $ machine == 'testing' { \n   include nginx\n} else { \n   include openssl \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#16","title":"16 \u865a\u62df\u8d44\u6e90","text":"<p>\u865a\u62df\u8d44\u6e90\u662f\u90a3\u4e9b\u9664\u975e\u5b9e\u73b0\u624d\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u8d44\u6e90\u3002</p> <p>\u4ee5\u4e0b\u662f\u5728 Puppet \u4e2d\u4f7f\u7528\u865a\u62df\u8d44\u6e90\u7684\u8bed\u6cd5\u3002</p> <pre><code>@user { vipin: ensure =&gt; present }\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u865a\u62df\u5b9a\u4e49\u4e86\u7528\u6237vipin\uff0c\u4ee5\u5b9e\u73b0\u53ef\u4ee5\u5728\u96c6\u5408\u4e2d\u4f7f\u7528\u7684\u5b9a\u4e49</p> <pre><code>User &lt;| title == vipin |&gt;\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#17","title":"17 \u6ce8\u91ca","text":"<p>\u5728\u4efb\u4f55\u4ee3\u7801\u4f4d\u4e2d\u90fd\u4f7f\u7528\u6ce8\u91ca\u6765\u521b\u5efa\u5173\u4e8e\u4e00\u7ec4\u4ee3\u7801\u884c\u53ca\u5176\u529f\u80fd\u7684\u9644\u52a0\u8282\u70b9\u3002\u5728 Puppet \u4e2d\uff0c\u76ee\u524d\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u8bc4\u8bba\u3002</p> <ul> <li>Unix shell \u98ce\u683c\u7684\u6ce8\u91ca\u3002\u4ed6\u4eec\u53ef\u4ee5\u5728\u81ea\u5df1\u7684\u4e00\u884c\u6216\u4e0b\u4e00\u884c\u3002</li> <li>\u591a\u884c c \u6837\u5f0f\u6ce8\u91ca\u3002</li> </ul> <p>\u4ee5\u4e0b\u662f shell \u6837\u5f0f\u6ce8\u91ca\u7684\u793a\u4f8b\u3002</p> <pre><code># this is a comment\n</code></pre> <p>Following is an example of multiline comment.</p> <pre><code>/*\nThis is a comment\n*/\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#18","title":"18 \u8fd0\u7b97\u7b26\u4f18\u5148\u7ea7","text":"<p>Puppet \u8fd0\u7b97\u7b26\u4f18\u5148\u7ea7\u7b26\u5408\u5927\u591a\u6570\u7cfb\u7edf\u4e2d\u7684\u6807\u51c6\u4f18\u5148\u7ea7\uff0c\u4ece\u6700\u9ad8\u5230\u6700\u4f4e\u3002</p> <p>\u4ee5\u4e0b\u662f\u8868\u8fbe\u5f0f\u5217\u8868</p> <ul> <li><code>!</code> = not</li> <li><code>/</code> = times and divide</li> <li><code>- +</code> = minus, plus</li> <li><code>&lt;&lt; &gt;&gt;</code> = left shift and right shift</li> <li><code>== !=</code> = not equal, equal</li> <li><code>&gt;= &lt;= &gt; &lt;</code> = greater equal, less or equal, greater than, less than</li> </ul>"},{"location":"chap6_pp/3pp_coding_style/#19","title":"19 \u6bd4\u8f83\u8868\u8fbe\u5f0f","text":"<p>\u5f53\u7528\u6237\u60f3\u8981\u5728\u6ee1\u8db3\u7ed9\u5b9a\u6761\u4ef6\u65f6\u6267\u884c\u4e00\u7ec4\u8bed\u53e5\u65f6\u4f7f\u7528\u6bd4\u8f83\u8868\u8fbe\u5f0f\u3002\u6bd4\u8f83\u8868\u8fbe\u5f0f\u5305\u62ec\u4f7f\u7528 == \u8868\u8fbe\u5f0f\u7684\u76f8\u7b49\u6027\u6d4b\u8bd5\u3002</p> <pre><code>if $environment == 'development' { \n   include openssl \n} else { \n   include ssl \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#not-equal-example","title":"Not Equal Example","text":"<pre><code>if $environment != 'development' { \n   $otherenvironment = 'testing' \n} else { \n   $otherenvironment = 'production' \n} \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#arithmetic-expression","title":"Arithmetic Expression","text":"<pre><code>$one = 1 \n$one_thirty = 1.30 \n$two = 2.034e-2 $result = ((( $two + 2) / $one_thirty) + 4 * 5.45) - \n   (6 &lt;&lt; ($two + 4)) + (0\u00d7800 + -9)\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#boolean-expression","title":"Boolean Expression","text":"<p>Boolean expressions are possible using or, and, &amp; not.</p> <pre><code>$one = 1 \n$two = 2 \n$var = ( $one &lt; $two ) and ( $one + 1 == $two ) \n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#regular-expression","title":"Regular Expression","text":"<p>Puppet supports regular expression matching using <code>=~ (match)</code> and <code>!~ (not-match)</code>.</p> <pre><code>if $website =~ /^www(\\d+)\\./ { \n   notice('Welcome web server #$1') \n}\n</code></pre> <p>\u50cf\u5927\u5c0f\u5199\u548c\u9009\u62e9\u5668\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u4e00\u6837\uff0c\u4f1a\u4e3a\u6bcf\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f\u521b\u5efa\u6709\u9650\u7684\u8303\u56f4\u53d8\u91cf\u3002</p> <pre><code>exec { \"Test\": \n   command =&gt; \"/bin/echo now we don\u2019t have openssl installed on machine &gt; /tmp/test.txt\", \n   unless =&gt; \"/bin/which php\" \n}\n</code></pre> <p>\u540c\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u9664\u975e\uff0c\u9664\u975e\u4e00\u76f4\u6267\u884c\u547d\u4ee4\uff0c\u9664\u975eunless\u4e0b\u7684\u547d\u4ee4\u6210\u529f\u9000\u51fa\u3002</p> <pre><code>exec { \"Test\": \n   command =&gt; \"/bin/echo now we don\u2019t have openssl installed on machine &gt; /tmp/test.txt\", \n   unless =&gt; \"/bin/which php\" \n}\n</code></pre>"},{"location":"chap6_pp/3pp_coding_style/#19_1","title":"19 \u4f7f\u7528\u6a21\u677f","text":"<p>\u5f53\u4e00\u4e2a\u4eba\u5e0c\u671b\u6709\u4e00\u4e2a\u9884\u5b9a\u4e49\u7684\u7ed3\u6784\u65f6\u4f7f\u7528\u6a21\u677f\uff0c\u8be5\u7ed3\u6784\u5c06\u5728 Puppet \u7684\u591a\u4e2a\u6a21\u5757\u4e2d\u4f7f\u7528\uff0c\u5e76\u4e14\u8fd9\u4e9b\u6a21\u5757\u5c06\u5206\u5e03\u5728\u591a\u53f0\u673a\u5668\u4e0a\u3002\u4f7f\u7528\u6a21\u677f\u7684\u7b2c\u4e00\u6b65\u662f\u521b\u5efa\u4e00\u4e2a\u4f7f\u7528\u6a21\u677f\u65b9\u6cd5\u5448\u73b0\u6a21\u677f\u5185\u5bb9\u7684\u6a21\u677f\u3002</p> <pre><code>file { \"/etc/tomcat/sites-available/default.conf\": \n   ensure =&gt; \"present\", \n   content =&gt; template(\"tomcat/vhost.erb\")  \n}\n</code></pre> <p>Puppet \u5728\u5904\u7406\u672c\u5730\u6587\u4ef6\u65f6\u51e0\u4e4e\u6ca1\u6709\u505a\u4efb\u4f55\u5047\u8bbe\uff0c\u4ee5\u52a0\u5f3a\u7ec4\u7ec7\u548c\u6a21\u5757\u5316\u3002 Puppet \u5728\u6a21\u5757\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u5939 <code>apache/templates</code> \u4e2d\u67e5\u627e <code>vhost.erb</code> \u6a21\u677f\u3002</p>"},{"location":"chap6_pp/3pp_coding_style/#20","title":"20 \u5b9a\u4e49\u548c\u89e6\u53d1\u670d\u52a1","text":"<p>\u5728 Puppet \u4e2d\uff0c\u5b83\u6709\u4e00\u4e2a\u540d\u4e3a service \u7684\u8d44\u6e90\uff0c\u5b83\u80fd\u591f\u7ba1\u7406\u5728\u4efb\u4f55\u7279\u5b9a\u673a\u5668\u6216\u73af\u5883\u4e0a\u8fd0\u884c\u7684\u6240\u6709\u670d\u52a1\u7684\u751f\u547d\u5468\u671f\u3002\u670d\u52a1\u8d44\u6e90\u7528\u4e8e\u786e\u4fdd\u670d\u52a1\u5df2\u521d\u59cb\u5316\u548c\u542f\u7528\u3002\u5b83\u4eec\u4e5f\u7528\u4e8e\u670d\u52a1\u91cd\u542f\u3002</p> <p>\u4f8b\u5982\uff0c\u5728\u524d\u9762\u7684tomcat \u6a21\u677f\u4e2d\uff0c\u6211\u4eec\u8bbe\u7f6e\u4e86apache \u865a\u62df\u4e3b\u673a\u3002\u5982\u679c\u8981\u786e\u4fdd apache \u5728\u865a\u62df\u4e3b\u673a\u66f4\u6539\u540e\u91cd\u65b0\u542f\u52a8\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e3a apache \u670d\u52a1\u521b\u5efa\u670d\u52a1\u8d44\u6e90\u3002</p> <pre><code>service { 'tomcat': \n   ensure =&gt; running, \n   enable =&gt; true \n}\n</code></pre> <p>\u5728\u5b9a\u4e49\u8d44\u6e90\u65f6\uff0c\u6211\u4eec\u9700\u8981\u5305\u542b\u901a\u77e5\u9009\u9879\u4ee5\u89e6\u53d1\u91cd\u542f\u3002</p> <pre><code>file { \"/etc/tomcat/sites-available/default.conf\": \n   ensure =&gt; \"present\", \n   content =&gt; template(\"vhost.erb\"), \n   notify =&gt; Service['tomcat']  \n}\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/","title":"4 Puppet - \u6838\u5fc3\u6a21\u5757","text":""},{"location":"chap6_pp/4pp_key_comps/#1-manifest-files","title":"1 Manifest Files","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6240\u6709\u4f7f\u7528 Ruby \u7f16\u7a0b\u8bed\u8a00\u7f16\u5199\u5e76\u4ee5 <code>.pp</code> \u6269\u5c55\u540d\u4fdd\u5b58\u7684\u7a0b\u5e8f\u90fd\u79f0\u4e3a\u6e05\u5355\u3002\u4e00\u822c\u800c\u8a00\uff0c\u6240\u6709\u65e8\u5728\u521b\u5efa\u6216\u7ba1\u7406\u4efb\u4f55\u76ee\u6807\u4e3b\u673a\u7684 Puppet \u7a0b\u5e8f\u90fd\u79f0\u4e3a\u6e05\u5355\u3002</p> <p>\u6240\u6709\u7528 Puppet \u7f16\u5199\u7684\u7a0b\u5e8f\u90fd\u9075\u5faa Puppet \u7f16\u7801\u98ce\u683c\u3002</p> <p>Puppet \u7684\u6838\u5fc3\u662f\u58f0\u660e\u8d44\u6e90\u7684\u65b9\u5f0f\u4ee5\u53ca\u8fd9\u4e9b\u8d44\u6e90\u5982\u4f55\u8868\u793a\u5b83\u4eec\u7684\u72b6\u6001\u3002\u5728\u4efb\u4f55\u6e05\u5355\u4e2d\uff0c\u7528\u6237\u90fd\u53ef\u4ee5\u62e5\u6709\u4e00\u7ec4\u4e0d\u540c\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u8fd9\u4e9b\u8d44\u6e90\u4f7f\u7528\u7c7b\u548c\u5b9a\u4e49\u7ec4\u5408\u5728\u4e00\u8d77\u3002</p> <p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c<code>Puppet manifest</code> \u751a\u81f3\u53ef\u4ee5\u6709\u4e00\u4e2a\u6761\u4ef6\u8bed\u53e5\u4ee5\u8fbe\u5230\u6240\u9700\u7684\u72b6\u6001\u3002\u4f46\u662f\uff0c\u6700\u7ec8\u5f52\u6839\u7ed3\u5e95\u662f\u8981\u786e\u4fdd\u6240\u6709\u8d44\u6e90\u90fd\u4ee5\u6b63\u786e\u7684\u65b9\u5f0f\u5b9a\u4e49\u548c\u4f7f\u7528\uff0c\u5e76\u4e14\u5728\u8f6c\u6362\u4e3a\u76ee\u5f55\u540e\u5e94\u7528\u5b9a\u4e49\u7684\u6e05\u5355\u80fd\u591f\u6267\u884c\u5176\u8bbe\u8ba1\u7684\u4efb\u52a1\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#manifest","title":"Manifest\u6587\u4ef6\u5de5\u4f5c\u6d41\u7a0b","text":"<p>Puppet manifest \u7531\u4ee5\u4e0b\u7ec4\u4ef6\u7ec4\u6210 -</p> <ul> <li>File\uff08\u8fd9\u4e9b\u662f Puppet \u4e0e\u5b83\u4eec\u65e0\u5173\u7684\u666e\u901a\u6587\u4ef6\uff0c\u53ea\u662f\u5c06\u5b83\u4eec\u62fe\u53d6\u5e76\u653e\u7f6e\u5728\u76ee\u6807\u4f4d\u7f6e\uff09</li> <li>\u8d44\u6e90Resources</li> <li>\u6a21\u677fTemplates\uff08\u8fd9\u4e9b\u53ef\u7528\u4e8e\u5728\u8282\u70b9\u4e0a\u6784\u5efa\u914d\u7f6e\u6587\u4ef6\uff09\u3002</li> <li>\u8282\u70b9Nodes\uff08\u6240\u6709\u4e0e\u5ba2\u6237\u7aef\u8282\u70b9\u76f8\u5173\u7684\u5b9a\u4e49\u90fd\u5728\u8fd9\u91cc\u5b9a\u4e49\uff09</li> <li>\u7c7bClasses</li> </ul>"},{"location":"chap6_pp/4pp_key_comps/#_1","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6240\u6709\u6e05\u5355\u6587\u4ef6\u90fd\u4f7f\u7528 Ruby \u4f5c\u4e3a\u5176\u7f16\u7801\u8bed\u8a00\uff0c\u5e76\u4ee5 .pp \u6269\u5c55\u540d\u4fdd\u5b58\u3002</p> <p>\u8bb8\u591a\u6e05\u5355\u4e2d\u7684\u201cimport\u201d\u8bed\u53e5\u7528\u4e8e\u5728 Puppet \u542f\u52a8\u65f6\u52a0\u8f7d\u6587\u4ef6\u3002</p> <p>\u4e3a\u4e86\u5bfc\u5165\u76ee\u5f55\u4e2d\u5305\u542b\u7684\u6240\u6709\u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u4ee5\u53e6\u4e00\u79cd\u65b9\u5f0f\u4f7f\u7528 import \u8bed\u53e5\uff0c\u4f8b\u5982 <code>import 'clients/*</code>'\u3002\u8fd9\u5c06\u5bfc\u5165\u8be5\u76ee\u5f55\u4e2d\u7684\u6240\u6709 .pp \u6587\u4ef6\u3002</p> <p></p>"},{"location":"chap6_pp/4pp_key_comps/#manifests","title":"\u5199Manifests","text":"<p>\u4f7f\u7528\u53d8\u91cf</p> <p>\u5728\u7f16\u5199\u6e05\u5355\u65f6\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u6e05\u5355\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\u5b9a\u4e49\u65b0\u53d8\u91cf\u6216\u4f7f\u7528\u73b0\u6709\u53d8\u91cf\u3002 Puppet \u652f\u6301\u4e0d\u540c\u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u4f46\u5176\u4e2d\u5f88\u5c11\u6709\u4eba\u7ecf\u5e38\u4f7f\u7528\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u548c\u5b57\u7b26\u4e32\u6570\u7ec4\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u652f\u6301\u5176\u4ed6\u683c\u5f0f\u3002</p> <p>\u5b57\u7b26\u4e32\u53d8\u91cf\u793a\u4f8b</p> <pre><code>$package = \"vim\"  \n\npackage {  $package: \n   ensure =&gt; \"installed\" \n}\n</code></pre> <p>\u4f7f\u7528\u5faa\u73af</p> <p>\u5f53\u4eba\u4eec\u5e0c\u671b\u5bf9\u540c\u4e00\u7ec4\u4ee3\u7801\u8fdb\u884c\u591a\u6b21\u8fed\u4ee3\u76f4\u5230\u6ee1\u8db3\u5b9a\u4e49\u7684\u6761\u4ef6\u65f6\uff0c\u5c31\u4f1a\u4f7f\u7528\u5faa\u73af\u3002\u5b83\u4eec\u8fd8\u7528\u4e8e\u6267\u884c\u5177\u6709\u4e0d\u540c\u503c\u96c6\u7684\u91cd\u590d\u6027\u4efb\u52a1\u3002\u4e3a 10 \u4e2a\u4e0d\u540c\u7684\u4e8b\u7269\u521b\u5efa 10 \u4e2a\u4efb\u52a1\u3002\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\u5e76\u4f7f\u7528\u5faa\u73af\u91cd\u590d\u8be5\u4efb\u52a1\uff0c\u5e76\u4f7f\u7528\u60f3\u8981\u5b89\u88c5\u7684\u4e0d\u540c\u5305\u3002</p> <p>\u6700\u5e38\u89c1\u7684\u662f\u6570\u7ec4\u7528\u4e8e\u91cd\u590d\u5177\u6709\u4e0d\u540c\u503c\u7684\u6d4b\u8bd5\u3002</p> <pre><code>$packages = ['vim', 'git', 'curl']  \n\npackage { $packages: \n   ensure =&gt; \"installed\" \n}\n</code></pre> <p>\u4f7f\u7528\u6761\u4ef6</p> <p>Puppet \u652f\u6301\u4f20\u7edf\u7f16\u7a0b\u8bed\u8a00\u4e2d\u7684\u5927\u591a\u6570\u6761\u4ef6\u7ed3\u6784\u3002\u6761\u4ef6\u53ef\u7528\u4e8e\u52a8\u6001\u5b9a\u4e49\u662f\u6267\u884c\u7279\u5b9a\u4efb\u52a1\u8fd8\u662f\u6267\u884c\u4e00\u7ec4\u4ee3\u7801\u3002\u50cf if/else \u548c case \u8bed\u53e5\u3002\u6b64\u5916\uff0c\u50cf\u6267\u884c\u8fd9\u6837\u7684\u6761\u4ef6\u4e5f\u5c06\u652f\u6301\u50cf\u6761\u4ef6\u4e00\u6837\u5de5\u4f5c\u7684\u5c5e\u6027\uff0c\u4f46\u53ea\u63a5\u53d7\u547d\u4ee4\u8f93\u51fa\u4f5c\u4e3a\u6761\u4ef6\u3002</p> <pre><code>if $OperatingSystem != 'Linux' { \n   warning('This manifest is not supported on this other OS apart from linux.') \n} else { \n   notify { 'the OS is Linux. We are good to go!': }\n} \n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#2-module","title":"2 Module","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6a21\u5757\u53ef\u4ee5\u5b9a\u4e49\u4e3aresources\u3001classes\u3001files\u3001definition\u548ctemplates\u7684\u96c6\u5408\u3002 </p> <p>Puppet \u652f\u6301\u8f7b\u677e\u7684\u6a21\u5757\u91cd\u65b0\u5206\u53d1\uff0c\u8fd9\u5bf9\u4e8e\u4ee3\u7801\u7684\u6a21\u5757\u5316\u975e\u5e38\u6709\u5e2e\u52a9\uff0c\u56e0\u4e3a\u4e00\u4e2a\u4eba\u53ef\u4ee5\u7f16\u5199\u4e00\u4e2a\u6307\u5b9a\u7684\u901a\u7528\u6a21\u5757\uff0c\u5e76\u4e14\u53ef\u4ee5\u591a\u6b21\u4f7f\u7528\u5b83\uff0c\u53ea\u9700\u5f88\u5c11\u7684\u7b80\u5355\u4ee3\u7801\u66f4\u6539\u3002\u4f8b\u5982\uff0c\u8fd9\u5c06\u542f\u7528 <code>/etc/puppet</code> \u4e0b\u7684\u9ed8\u8ba4\u7ad9\u70b9\u914d\u7f6e\uff0cPuppet \u63d0\u4f9b\u7684\u6a21\u5757\u5728 <code>/etc/share/puppet</code> \u4e2d\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#module-configuration","title":"Module Configuration","text":"<p>\u5728\u4efb\u4f55 Puppet \u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u90fd\u6709\u4e24\u4e2a\u5206\u533a\u6765\u5e2e\u52a9\u5b9a\u4e49\u4ee3\u7801\u7ed3\u6784\u548c\u63a7\u5236\u9762\u989d\u3002</p> <p>\u6a21\u5757\u7684\u641c\u7d22\u8def\u5f84\u662f\u4f7f\u7528 puppetmasterd \u6216 masterd \u4e2d\u4ee5\u5192\u53f7\u5206\u9694\u7684\u76ee\u5f55\u5217\u8868\u914d\u7f6e\u7684\uff0c\u540e\u8005\u662f Puppet \u4e3b\u914d\u7f6e\u6587\u4ef6\u7684\u540e\u9762\u90e8\u5206\uff0c\u5e26\u6709 modulepath \u53c2\u6570\u3002</p> <pre><code>[puppetmasterd]\n...\nmodulepath = /var/lib/puppet/modules:/data/puppet/modules\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e PUPPETLAB \u73af\u5883\u53d8\u91cf\u5728\u8fd0\u884c\u65f6\u6dfb\u52a0\u641c\u7d22\u8def\u5f84\uff0c\u8be5\u73af\u5883\u53d8\u91cf\u4e5f\u5fc5\u987b\u662f\u5192\u53f7\u5206\u9694\u7684\u53d8\u91cf\u5217\u8868\u3002</p> <p><code>fileserver.conf</code>\u4e2d\u6587\u4ef6\u670d\u52a1\u5668\u6a21\u5757\u7684\u8bbf\u95ee\u63a7\u5236\u8bbe\u7f6e\uff0c\u8be5\u6a21\u5757\u7684\u8def\u5f84\u914d\u7f6e\u59cb\u7ec8\u88ab\u5ffd\u7565\uff0c\u6307\u5b9a\u8def\u5f84\u5c06\u4ea7\u751f\u8b66\u544a\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#modules-source","title":"\u6a21\u5757\u6e90 Modules Source","text":"<p>Puppet \u652f\u6301\u5b58\u50a8\u6a21\u5757\u7684\u4e0d\u540c\u4f4d\u7f6e\u3002\u4efb\u4f55\u6a21\u5757\u90fd\u53ef\u4ee5\u5b58\u50a8\u5728\u4efb\u4f55\u7279\u5b9a\u673a\u5668\u7684\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002\u4f46\u662f\uff0c\u5b58\u50a8\u6a21\u5757\u7684\u6240\u6709\u8def\u5f84\u90fd\u5fc5\u987b\u5728\u79f0\u4e3a modulepath \u7684\u914d\u7f6e\u53d8\u91cf\u4e2d\u6307\u5b9a\uff0c\u8fd9\u901a\u5e38\u662f\u4e00\u4e2a\u8def\u5f84\u53d8\u91cf\uff0cPuppet \u626b\u63cf\u6240\u6709\u6a21\u5757\u76ee\u5f55\u5e76\u5728\u542f\u52a8\u65f6\u52a0\u8f7d\u5b83\u4eec\u3002</p> <p>\u4e00\u4e2a\u5408\u7406\u7684\u9ed8\u8ba4\u8def\u5f84\u53ef\u4ee5\u914d\u7f6e\u4e3a -</p> <pre><code>/etc/puppet/modules:/usr/share/puppet:/var/lib/modules.\n</code></pre> <p>\u6216\u8005\uff0c\u53ef\u4ee5\u5c06 /etc/puppet \u76ee\u5f55\u5efa\u7acb\u4e3a\u4e00\u4e2a\u7279\u6b8a\u7684\u533f\u540d\u6a21\u5757\uff0c\u5b83\u603b\u662f\u9996\u5148\u88ab\u641c\u7d22\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#_2","title":"\u6a21\u5757\u547d\u540d","text":"<p>Puppet \u9075\u5faa\u7279\u5b9a\u6a21\u5757\u7684\u76f8\u540c\u547d\u540d\u6807\u51c6\uff0c\u5176\u4e2d\u6a21\u5757\u540d\u79f0\u5fc5\u987b\u662f\u666e\u901a\u5355\u8bcd\uff0c\u5339\u914d <code>[-\\\\w+]</code>\uff08\u5b57\u6bcd\u3001\u5355\u8bcd\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf\u548c\u7834\u6298\u53f7\uff09\u5e76\u4e14\u4e0d\u5305\u542b\u547d\u540d\u7a7a\u95f4\u5206\u9694\u7b26\uff1a: \u6216 /\u3002\u867d\u7136\u53ef\u80fd\u5141\u8bb8\u5173\u4e8e\u6a21\u5757\u5c42\u6b21\u7ed3\u6784\uff0c\u4f46\u5bf9\u4e8e\u65b0\u6a21\u5757\uff0c\u5b83\u4e0d\u80fd\u5d4c\u5957\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#_3","title":"\u6a21\u5757\u5185\u90e8\u7ec4\u7ec7","text":"<p>\u5f53\u7528\u6237\u5728 Puppet \u4e2d\u521b\u5efa\u65b0\u6a21\u5757\u65f6\uff0c\u5b83\u9075\u5faa\u76f8\u540c\u7684\u7ed3\u6784\uff0c\u5e76\u5305\u542b\u6309\u7279\u5b9a\u76ee\u5f55\u7ed3\u6784\u6392\u5217\u7684\u6e05\u5355\u3001\u5206\u5e03\u5f0f\u6587\u4ef6\u3001\u63d2\u4ef6\u548c\u6a21\u677f\uff0c\u5982\u4ee5\u4e0b\u4ee3\u7801\u6240\u793a\u3002</p> <pre><code>MODULE_PATH/\ndowncased_module_name/\nfiles/\nmanifests/\ninit.pp\nlib/\npuppet/\nparser/\nfunctions\nprovider/\ntype/\nfacter/\ntemplates/\nREADME\n</code></pre> <p>\u6bcf\u5f53\u521b\u5efa\u4e00\u4e2a\u6a21\u5757\u65f6\uff0c\u5b83\u90fd\u4f1a\u5728\u6e05\u5355\u76ee\u5f55\u5185\u7684\u6307\u5b9a\u4fee\u590d\u4f4d\u7f6e\u5305\u542b <code>init.pp</code> \u6e05\u5355\u6587\u4ef6\u3002\u6b64\u6e05\u5355\u6587\u4ef6\u662f\u4e00\u4e2a\u9ed8\u8ba4\u6587\u4ef6\uff0c\u5b83\u9996\u5148\u5728\u4efb\u4f55\u7279\u5b9a\u6a21\u5757\u4e2d\u6267\u884c\uff0c\u5e76\u5305\u542b\u4e0e\u8be5\u7279\u5b9a\u6a21\u5757\u5173\u8054\u7684\u6240\u6709\u7c7b\u7684\u96c6\u5408\u3002</p> <p>\u53ef\u4ee5\u76f4\u63a5\u5728 manifests \u6587\u4ef6\u5939\u4e0b\u6dfb\u52a0\u5176\u4ed6 <code>.pp</code> \u6587\u4ef6\u3002\u5982\u679c\u6211\u4eec\u8981\u6dfb\u52a0\u989d\u5916\u7684<code>.pp</code> \u6587\u4ef6\uff0c\u5b83\u4eec\u5e94\u8be5\u4ee5\u7c7b\u547d\u540d\u3002</p> <p>\u4f7f\u7528\u6a21\u5757\u5b9e\u73b0\u7684\u5173\u952e\u7279\u6027\u4e4b\u4e00\u662f\u4ee3\u7801\u5171\u4eab\u3002</p> <p>\u4e00\u4e2a\u6a21\u5757\u672c\u8d28\u4e0a\u5e94\u8be5\u662f\u81ea\u5305\u542b\u7684\uff0c\u8fd9\u610f\u5473\u7740\u4e00\u4e2a\u4eba\u5e94\u8be5\u80fd\u591f\u4ece\u4efb\u4f55\u5730\u65b9\u5305\u542b\u4efb\u4f55\u6a21\u5757\u5e76\u5c06\u5176\u653e\u5230\u6a21\u5757\u8def\u5f84\u4e0a\uff0c\u5f53 Puppet \u542f\u52a8\u65f6\u4f1a\u52a0\u8f7d\u8be5\u8def\u5f84\u3002\u5728\u6a21\u5757\u7684\u5e2e\u52a9\u4e0b\uff0c\u4eba\u4eec\u5728 Puppet \u57fa\u7840\u8bbe\u65bd\u7f16\u7801\u4e2d\u83b7\u5f97\u4e86\u6a21\u5757\u5316\u3002</p> <p></p> <p>\u4f8b\u5b50</p> <p>\u8003\u8651\u4e00\u4e2a\u5b89\u88c5\u56fa\u5b9a <code>auto.homes</code> \u6620\u5c04\u5e76\u4ece\u6a21\u677f\u751f\u6210 <code>auto.master</code> \u7684 <code>autofs</code> \u6a21\u5757\u3002</p> <pre><code>class autofs { \n   package { autofs: ensure =&gt; latest } \n   service { autofs: ensure =&gt; running } \n\n   file { \"/etc/auto.homes\": \n      source =&gt; \"puppet://$servername/modules/autofs/auto.homes\" \n   } \n   file { \"/etc/auto.master\": \n      content =&gt; template(\"autofs/auto.master.erb\") \n   } \n}\n</code></pre> <p>\u6587\u4ef6\u7cfb\u7edf\u5c06\u5177\u6709\u4ee5\u4e0b\u6587\u4ef6\u3002</p> <pre><code>MODULE_PATH/\nautofs/\nmanifests/\ninit.pp\nfiles/\nauto.homes\ntemplates/\nauto.master.erb\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#module-lookup","title":"\u6a21\u5757\u67e5\u627e Module Lookup","text":"<p>Puppet \u9075\u5faa\u4e00\u4e2a\u9884\u5b9a\u4e49\u7684\u7ed3\u6784\uff0c\u5176\u4e2d\u5b83\u5728\u4e00\u4e2a\u5b9a\u4e49\u7684\u7ed3\u6784\u4e2d\u5305\u542b\u591a\u4e2a\u76ee\u5f55\u548c\u5b50\u76ee\u5f55\u3002\u8fd9\u4e9b\u76ee\u5f55\u5305\u542b\u6a21\u5757\u6267\u884c\u67d0\u4e9b\u64cd\u4f5c\u6240\u9700\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u4ef6\u3002\u4e00\u4e9b\u5e55\u540e\u9b54\u672f\u786e\u4fdd\u6b63\u786e\u7684\u6587\u4ef6\u4e0e\u6b63\u786e\u7684\u4e0a\u4e0b\u6587\u76f8\u5173\u8054\u3002</p> <p>\u6240\u6709\u6a21\u5757\u641c\u7d22\u90fd\u5728 <code>modulepath</code> \u4e2d\uff0c\u8fd9\u662f\u4e00\u4e2a\u4ee5\u5192\u53f7\u5206\u9694\u7684\u76ee\u5f55\u5217\u8868\u3002</p> <p>\u5bf9\u4e8e\u6587\u4ef6\u670d\u52a1\u5668\u4e0a\u7684\u6587\u4ef6\u5f15\u7528\uff0c\u4f7f\u7528\u7c7b\u4f3c\u7684\u5f15\u7528\uff0c\u4ee5\u4fbf\u5bf9 puppet \u7684\u5f15\u7528\uff1a<code>//$servername/modules/autofs/auto.homes</code> \u89e3\u6790\u4e3a\u6a21\u5757\u8def\u5f84\u4e2d\u7684\u6587\u4ef6 <code>autofs/files/auto.homes</code>\u3002</p> <p>\u8981\u4f7f\u6a21\u5757\u53ef\u7528\u4e8e\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\u548c puppet master\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>from puppet:///path</code> \u7684 URL\u3002\u5373\u6ca1\u6709\u660e\u786e\u670d\u52a1\u5668\u540d\u79f0\u7684 URL\u3002</p> <p>Puppet \u548c puppetd \u200b\u200b\u5bf9\u6b64\u7c7b URL \u7684\u5904\u7406\u65b9\u5f0f\u7565\u6709\u4e0d\u540c\u3002 Puppet \u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\u641c\u7d22\u65e0\u670d\u52a1\u5668 URL\u3002</p> <p>\u6a21\u677f\u6587\u4ef6\u7684\u641c\u7d22\u65b9\u5f0f\u7c7b\u4f3c\u4e8e\u6e05\u5355\u548c\u6587\u4ef6\uff1a</p> <p>\u63d0\u53ca\u6a21\u677f\uff08<code>autofs/auto.master.erb</code>\uff09\u5c06\u4f7f <code>puppetmaster</code> \u9996\u5148\u5728 <code>$templatedir/autofs/auto.master.erb</code> \u4e2d\u67e5\u627e\u6587\u4ef6\uff0c\u7136\u540e<code>autofs/templates/auto.master.erb</code> \u5728\u6a21\u5757\u8def\u5f84\u4e0a\u3002</p> <p>\u6709\u4e86 Puppet \u4e0b\u6240\u6709\u4e1c\u897f\u7684 Puppet \u7248\u672c\uff0c\u5b83\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002\u8fd9\u79f0\u4e3a\u6a21\u5757\u81ea\u52a8\u52a0\u8f7d\u3002 Puppet \u5c06\u5c1d\u8bd5\u4ece\u6a21\u5757\u4e2d\u81ea\u52a8\u52a0\u8f7d\u7c7b\u548c\u5b9a\u4e49\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#3","title":"3 \u6587\u4ef6\u670d\u52a1\u5668","text":"<p>Puppet \u9075\u5faa\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7684\u6982\u5ff5\uff0c\u5176\u4e2d\u8bbe\u7f6e\u4e2d\u7684\u4e00\u53f0\u673a\u5668\u4f5c\u4e3a\u8fd0\u884c Puppet \u670d\u52a1\u5668\u8f6f\u4ef6\u7684\u670d\u52a1\u5668\u673a\u5668\uff0c\u5176\u4f59\u4f5c\u4e3a\u8fd0\u884c Puppet \u4ee3\u7406\u8f6f\u4ef6\u7684\u5ba2\u6237\u7aef\u5de5\u4f5c\u3002</p> <p>\u6587\u4ef6\u670d\u52a1\u5668\u7684\u8fd9\u4e00\u7279\u6027\u6709\u52a9\u4e8e\u5728\u591a\u53f0\u673a\u5668\u4e0a\u590d\u5236\u6587\u4ef6\u3002 Puppet \u4e2d\u6587\u4ef6\u670d\u52a1\u529f\u80fd\u7684\u8fd9\u4e00\u7279\u6027\u662f\u4e2d\u592e Puppet \u5b88\u62a4\u8fdb\u7a0b\u7684\u4e00\u90e8\u5206\u3002 </p> <p>Puppetmasterd \u548c\u5ba2\u6237\u7aef\u529f\u80fd\u5728\u5c06\u6587\u4ef6\u5c5e\u6027\u4f5c\u4e3a\u6587\u4ef6\u5bf9\u8c61\u65f6\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002</p> <pre><code>class { 'java':  \n   package               =&gt; 'jdk-8u25-linux-x64',  \n   java_alternative      =&gt; 'jdk1.8.0_25',  \n   java_alternative_path =&gt; '/usr/java/jdk1.8.0_25/jre/bin/java'  \n}\n</code></pre> <p>\u5982\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\uff0cPuppet \u7684\u6587\u4ef6\u670d\u52a1\u529f\u80fd\u901a\u8fc7\u652f\u6301\u6587\u4ef6\u670d\u52a1\u6a21\u5757\u6765\u62bd\u8c61\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u62d3\u6251\u3002\u6211\u4eec\u5c06\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u6307\u5b9a\u6587\u4ef6\u670d\u52a1\u6a21\u5757\u3002</p> <pre><code>\"puppet://server/modules/module_name/sudoers\"\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#_4","title":"\u6587\u4ef6\u683c\u5f0f","text":"<p>\u5728 Puppet \u76ee\u5f55\u7ed3\u6784\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6587\u4ef6\u670d\u52a1\u5668\u914d\u7f6e\u4f4d\u4e8e <code>/etc/puppet/fileserver.config</code>\u76ee\u5f55\u4e0b\uff0c\u5982\u679c\u7528\u6237\u5e0c\u671b\u66f4\u6539\u6b64\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\uff0c\u53ef\u4ee5\u4f7f\u7528\u65b0\u7684\u914d\u7f6e\u6807\u5fd7\u6765\u5b8c\u6210 puppetmasterd\u3002</p> <p>\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8e INI \u6587\u4ef6\uff0c\u4f46\u4e0d\u5b8c\u5168\u76f8\u540c\u3002</p> <pre><code>[module]\npath /path/to/files\nallow *.domain.com\ndeny *.wireless.domain.com\n</code></pre> <p>\u5982\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u6240\u793a\uff0c\u6240\u6709\u4e09\u4e2a\u9009\u9879\u90fd\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8868\u793a\u3002\u6a21\u5757\u540d\u79f0\u6709\u70b9\u653e\u5728\u62ec\u53f7\u4e2d\u3002\u8def\u5f84\u662f\u552f\u4e00\u5fc5\u9700\u7684\u9009\u9879\u3002</p> <p>\u9ed8\u8ba4\u5b89\u5168\u9009\u9879\u662f\u62d2\u7edd\u6240\u6709\u8bbf\u95ee\uff0c\u56e0\u6b64\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5141\u8bb8\u884c\uff0c\u5c06\u914d\u7f6e\u7684\u6a21\u5757\u5c06\u53ef\u4f9b\u4efb\u4f55\u4eba\u4f7f\u7528\u3002</p> <p>\u8def\u5f84\u53ef\u4ee5\u5305\u542b\u4efb\u4f55\u6216\u6240\u6709 %d\u3001%h \u548c %H\uff0c\u5b83\u4eec\u4f1a\u88ab\u5176\u57df\u540d\u3001\u4e3b\u673a\u540d\u548c\u5b8c\u5168\u9650\u5b9a\u7684\u4e3b\u673a\u540d\u52a8\u6001\u66ff\u6362\u3002</p> <p>\u6240\u6709\u5185\u5bb9\u5747\u53d6\u81ea\u5ba2\u6237\u7aef\u7684 SSL \u8bc1\u4e66\uff08\u56e0\u6b64\uff0c\u5982\u679c\u4e3b\u673a\u540d\u548c\u8bc1\u4e66\u540d\u79f0\u4e0d\u5339\u914d\uff0c\u8bf7\u52a1\u5fc5\u5c0f\u5fc3\uff09\u3002\u8fd9\u5728\u521b\u5efa\u6a21\u5757\u65f6\u975e\u5e38\u6709\u7528\uff0c\u5176\u4e2d\u6bcf\u4e2a\u5ba2\u6237\u7aef\u7684\u6587\u4ef6\u5b8c\u5168\u5206\u5f00\u4fdd\u5b58\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8e\u79c1\u6709\u4e3b\u673a\u5bc6\u94a5\u3002</p> <pre><code>[private]\npath /data/private/%h\nallow *\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u4ee3\u7801\u8bd5\u56fe\u4ece\u5ba2\u6237\u7aef<code>client1.vipin.com</code> \u641c\u7d22\u6587\u4ef6<code>/private/file.txt</code>\u3002</p> <p>\u5b83\u5c06\u5728 <code>/data/private/client1/file.txt</code> \u4e2d\u67e5\u627e\u5b83\uff0c\u800c\u5bf9 <code>client2.vipin.com</code> \u7684\u76f8\u540c\u8bf7\u6c42\u5c06\u5c1d\u8bd5\u5728\u6587\u4ef6\u670d\u52a1\u5668\u4e0a\u68c0\u7d22\u6587\u4ef6 <code>/data/private/client2/file.txt</code>\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#_5","title":"\u5b89\u5168","text":"<p>Puppet \u652f\u6301 Puppet \u6587\u4ef6\u670d\u52a1\u5668\u4e0a\u4fdd\u62a4\u6587\u4ef6\u7684\u4e24\u4e2a\u57fa\u672c\u6982\u5ff5\u3002</p> <p>\u8fd9\u662f\u901a\u8fc7\u5141\u8bb8\u8bbf\u95ee\u7279\u5b9a\u6587\u4ef6\u5e76\u62d2\u7edd\u8bbf\u95ee\u4e0d\u9700\u8981\u7684\u6587\u4ef6\u6765\u5b9e\u73b0\u7684\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPuppet \u4e0d\u5141\u8bb8\u8bbf\u95ee\u4efb\u4f55\u6587\u4ef6\u3002\u5b83\u9700\u8981\u660e\u786e\u5b9a\u4e49\u3002\u53ef\u4ee5\u5728\u6587\u4ef6\u4e2d\u4f7f\u7528\u7684\u5141\u8bb8\u6216\u62d2\u7edd\u8bbf\u95ee\u7684\u683c\u5f0f\u662f\u4f7f\u7528 IP \u5730\u5740\u3001\u540d\u79f0\u6216\u5168\u5c40\u5141\u8bb8\u3002</p> <p>\u5982\u679c\u5ba2\u6237\u7aef\u6ca1\u6709\u76f4\u63a5\u8fde\u63a5\u5230 Puppet \u6587\u4ef6\u670d\u52a1\u5668\uff0c\u4f8b\u5982\u4f7f\u7528\u53cd\u5411\u4ee3\u7406\u548c Mongrel\uff0c\u90a3\u4e48\u6587\u4ef6\u670d\u52a1\u5668\u4f1a\u5c06\u6240\u6709\u8fde\u63a5\u89c6\u4e3a\u6765\u81ea\u4ee3\u7406\u670d\u52a1\u5668\u800c\u4e0d\u662f Puppet \u5ba2\u6237\u7aef\u3002\u5728\u4e0a\u8ff0\u60c5\u51b5\u4e0b\uff0c\u57fa\u4e8e\u4e3b\u673a\u540d\u9650\u5236\u4e3b\u673a\u540d\u662f\u6700\u4f73\u5b9e\u8df5\u3002</p> <p>\u5b9a\u4e49\u6587\u4ef6\u7ed3\u6784\u65f6\u8981\u6ce8\u610f\u7684\u4e00\u4e2a\u5173\u952e\u70b9\u662f\uff0c\u6240\u6709\u7684\u62d2\u7edd\u8bed\u53e5\u90fd\u5728\u5141\u8bb8\u8bed\u53e5\u4e4b\u524d\u89e3\u6790\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4efb\u4f55\u62d2\u7edd\u8bed\u53e5\u4e0e\u4e3b\u673a\u5339\u914d\uff0c\u5219\u8be5\u4e3b\u673a\u5c06\u88ab\u62d2\u7edd\uff0c\u5982\u679c\u5728\u5373\u5c06\u5230\u6765\u7684\u6587\u4ef6\u4e2d\u6ca1\u6709\u5199\u5165\u4efb\u4f55\u5141\u8bb8\u8bed\u53e5\uff0c\u5219\u8be5\u4e3b\u673a\u5c06\u88ab\u62d2\u7edd\u3002\u6b64\u529f\u80fd\u6709\u52a9\u4e8e\u8bbe\u7f6e\u4efb\u4f55\u7279\u5b9a\u7ad9\u70b9\u7684\u4f18\u5148\u7ea7\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#_6","title":"\u4e3b\u673a\u540d","text":"<p>\u5728\u4efb\u4f55\u6587\u4ef6\u670d\u52a1\u5668\u914d\u7f6e\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u6307\u5b9a\u6587\u4ef6\u4e3b\u673a\u540d\uff0c\u5373\u4f7f\u7528\u5b8c\u6574\u7684\u4e3b\u673a\u540d\u6216\u4f7f\u7528 <code>* \u901a\u914d\u7b26</code>\u6307\u5b9a\u6574\u4e2a\u57df\u540d\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>[export]\npath /usr\nallow brcleprod001.brcl.com\nallow *.brcl.com\ndeny brcleprod002.brcl.com\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#ip","title":"IP\u5730\u5740","text":"<p>\u5728\u4efb\u4f55\u6587\u4ef6\u670d\u52a1\u5668\u914d\u7f6e\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528\u5b8c\u6574\u7684 IP \u5730\u5740\u6216\u901a\u914d\u7b26\u5730\u5740\u5c06\u6587\u4ef6\u5730\u5740\u6307\u5b9a\u4e3a\u7c7b\u4f3c\u4e8e\u4e3b\u673a\u540d\u3002\u4e5f\u53ef\u4ee5\u4f7f\u7528 CIDR \u7cfb\u7edf\u8868\u793a\u6cd5</p> <pre><code>[export]\npath /usr\nallow 127.0.0.1\nallow 172.223.30.*\nallow 172.223.30.0/24\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#_7","title":"\u5168\u5c40\u5141\u8bb8","text":"<p>\u5f53\u7528\u6237\u5e0c\u671b\u6bcf\u4e2a\u4eba\u90fd\u53ef\u4ee5\u8bbf\u95ee\u7279\u5b9a\u6a21\u5757\u65f6\u4f7f\u7528\u5168\u5c40\u5141\u8bb8\u3002\u4e3a\u6b64\uff0c\u5355\u4e2a\u901a\u914d\u7b26\u6709\u52a9\u4e8e\u8ba9\u6bcf\u4e2a\u4eba\u90fd\u8bbf\u95ee\u8be5\u6a21\u5757\u3002</p> <pre><code>[export]\npath /export\nallow *\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#4-facter-facts","title":"4 Facter &amp; Facts","text":"<p>Puppet \u652f\u6301\u5c06\u591a\u4e2a\u503c\u4fdd\u5b58\u4e3a\u73af\u5883\u53d8\u91cf\u3002 Puppet \u901a\u8fc7\u4f7f\u7528 facter \u652f\u6301\u6b64\u529f\u80fd\u3002</p> <p>\u5728 Puppet \u4e2d\uff0cfacter \u662f\u4e00\u4e2a\u4fdd\u5b58\u73af\u5883\u7ea7\u522b\u53d8\u91cf\u7684\u72ec\u7acb\u5de5\u5177\u3002 in \u53ef\u4ee5\u8ba4\u4e3a\u7c7b\u4f3c\u4e8e Bash \u6216 Linux \u7684 env \u53d8\u91cf\u3002\u6709\u65f6\uff0c\u5b58\u50a8\u5728\u4e8b\u5b9e\u4e2d\u7684\u4fe1\u606f\u4e0e\u673a\u5668\u7684\u73af\u5883\u53d8\u91cf\u4e4b\u95f4\u53ef\u80fd\u5b58\u5728\u91cd\u53e0\u3002</p> <p>\u5728 Puppet \u4e2d\uff0c\u952e\u503c\u5bf9\u88ab\u79f0\u4e3a\u201c\u4e8b\u5b9e\u201d\u3002\u6bcf\u4e2a\u8d44\u6e90\u90fd\u6709\u81ea\u5df1\u7684\u4e8b\u5b9e\uff0c\u5728 Puppet \u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u6784\u5efa\u81ea\u5df1\u7684\u81ea\u5b9a\u4e49\u4e8b\u5b9e\u3002</p> <pre><code># facter\n</code></pre> <p>Factor \u547d\u4ee4\u53ef\u7528\u4e8e\u5217\u51fa\u6240\u6709\u4e0d\u540c\u7684\u73af\u5883\u53d8\u91cf\u53ca\u5176\u76f8\u5173\u503c\u3002\u8fd9\u4e9b\u4e8b\u5b9e\u96c6\u5408\u662f\u5f00\u7bb1\u5373\u7528\u7684\u4e8b\u5b9e\uff0c\u88ab\u79f0\u4e3a\u6838\u5fc3\u4e8b\u5b9e\u3002\u53ef\u4ee5\u5c06\u81ea\u5b9a\u4e49\u4e8b\u5b9e\u6dfb\u52a0\u5230\u96c6\u5408\u4e2d\u3002</p> <p>\u5982\u679c\u53ea\u60f3\u67e5\u770b\u4e00\u4e2a\u53d8\u91cf\u3002\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6765\u5b8c\u6210\u3002</p> <pre><code># facter {Variable Name}\n\nExample\n[root@puppetmaster ~]# facter virtual\nvirtualbox\n</code></pre> <p>facter \u5bf9 Puppet \u5f88\u91cd\u8981\u7684\u539f\u56e0\u662f\uff0cfacter \u548c facter \u5728\u6574\u4e2a Puppet \u4ee3\u7801\u4e2d\u90fd\u53ef\u4ee5\u4f5c\u4e3a\u201c\u5168\u5c40\u53d8\u91cf\u201d\u4f7f\u7528\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u95f4\u70b9\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528\uff0c\u800c\u65e0\u9700\u4efb\u4f55\u5176\u4ed6\u5f15\u7528\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#example-to-test","title":"Example to Test","text":"<pre><code>[root@puppetmaster modules]# tree brcle_account \nbrcle_account \n\u2514\u2500\u2500 manifests  \n\u2514\u2500\u2500 init.pp \n\n\n[root@puppetmaster modules]# cat brcle_account/manifests/init.pp  \nclass brcle_account {  \n   user { 'G01063908': \n      ensure =&gt; 'present', \n      uid =&gt; '121', \n      shell =&gt; '/bin/bash', \n      home =&gt; '/home/G01063908', \n   }  \n\n   file {'/tmp/userfile.txt': \n      ensure =&gt; file, \n      content =&gt; \"the value for the 'OperatingSystem' fact is: $OperatingSystem \\n\", \n   } \n} \n</code></pre> <p>Testing It</p> <pre><code>[root@puppetmaster modules]# puppet agent --test \nNotice: /Stage[main]/Activemq::Service/Service[activemq]/ensure: \nensure changed 'stopped' to 'running' \nInfo: /Stage[main]/Activemq::Service/Service[activemq]: \nUnscheduling refresh on Service[activemq] \n\nNotice: Finished catalog run in 4.09 seconds  \n[root@puppetmaster modules]# cat /tmp/testfile.txt  \nthe value for the 'OperatingSystem' fact is: Linux   \n\n[root@puppetmaster modules]# facter OperatingSystem \nLinux\n</code></pre> <p>\u6b63\u5982\u6211\u4eec\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\u6ce8\u610f\u5230\u7684\u90a3\u6837\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u5b9a\u4e49OperatingSystem\u3002\u6211\u4eec\u521a\u521a\u5c06\u503c\u66ff\u6362\u4e3a\u8f6f\u7f16\u7801\u503c <code>$OperatingSystem</code> \u4f5c\u4e3a\u666e\u901a\u53d8\u91cf\u3002</p> <p>\u5728 Puppet \u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528\u548c\u5b9a\u4e49\u4e09\u79cd\u7c7b\u578b\u7684\u4e8b\u5b9e -</p> <ul> <li>Core Facts</li> <li>Custom Facts</li> <li>External Facts</li> </ul> <p>\u6838\u5fc3\u4e8b\u5b9e\u662f\u5728\u9876\u5c42\u5b9a\u4e49\u7684\uff0c\u5e76\u4e14\u5728\u4ee3\u7801\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\u90fd\u53ef\u4ee5\u8bbf\u95ee\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#puppet","title":"Puppet \u4e8b\u5b9e","text":"<p>\u5c31\u5728\u4ee3\u7406\u5411\u4e3b\u670d\u52a1\u5668\u8bf7\u6c42\u76ee\u5f55\u4e4b\u524d\uff0c\u4ee3\u7406\u9996\u5148\u4ee5\u952e\u503c\u5bf9\u7684\u5f62\u5f0f\u7f16\u8bd1\u5176\u81ea\u8eab\u53ef\u7528\u4fe1\u606f\u7684\u5b8c\u6574\u5217\u8868\u3002\u4ee3\u7406\u7684\u4fe1\u606f\u7531\u4e00\u4e2a\u540d\u4e3afacter\u7684\u5de5\u5177\u6536\u96c6\uff0c\u6bcf\u4e2a\u952e\u503c\u5bf9\u79f0\u4e3a\u4e00\u4e2a\u4e8b\u5b9e\u3002\u4ee5\u4e0b\u662f\u4ee3\u7406\u4e8b\u5b9e\u7684\u5e38\u89c1\u8f93\u51fa\u3002</p> <pre><code>[root@puppetagent1 ~]# facter\narchitecture =&gt; x86_64\naugeasversion =&gt; 1.0.0\nbios_release_date =&gt; 13/09/2012\nbios_vendor =&gt; innotek GmbH\nbios_version =&gt; VirtualBox\nblockdevice_sda_model =&gt; VBOX HARDDISK\nblockdevice_sda_size =&gt; 22020587520\nblockdevice_sda_vendor =&gt; ATA\nblockdevice_sr0_model =&gt; CD-ROM\nblockdevice_sr0_size =&gt; 1073741312\nblockdevice_sr0_vendor =&gt; VBOX\nblockdevices =&gt; sda,sr0\nboardmanufacturer =&gt; Oracle Corporation\nboardproductname =&gt; VirtualBox\nboardserialnumber =&gt; 0\n\ndomain =&gt; codingbee.dyndns.org\nfacterversion =&gt; 2.1.0\nfilesystems =&gt; ext4,iso9660\nfqdn =&gt; puppetagent1.codingbee.dyndns.org\nhardwareisa =&gt; x86_64\nhardwaremodel =&gt; x86_64\nhostname =&gt; puppetagent1\nid =&gt; root\ninterfaces =&gt; eth0,lo\nipaddress =&gt; 172.228.24.01\nipaddress_eth0 =&gt; 172.228.24.01\nipaddress_lo =&gt; 127.0.0.1\nis_virtual =&gt; true\nkernel =&gt; Linux\nkernelmajversion =&gt; 2.6\nkernelrelease =&gt; 2.6.32-431.23.3.el6.x86_64\nkernelversion =&gt; 2.6.32\nlsbdistcodename =&gt; Final\nlsbdistdescription =&gt; CentOS release 6.5 (Final)\nlsbdistid =&gt; CentOS\nlsbdistrelease =&gt; 6.5\nlsbmajdistrelease =&gt; 6\nlsbrelease =&gt; :base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0noarch:graphics-4.0-amd64:\ngraphics-4.0-noarch:printing-4.0-amd64:printing-4.0noarch\nmacaddress =&gt; 05:00:22:47:H9:77\nmacaddress_eth0 =&gt; 05:00:22:47:H9:77\nmanufacturer =&gt; innotek GmbH\nmemoryfree =&gt; 125.86 GB\nmemoryfree_mb =&gt; 805.86\nmemorysize =&gt; 500 GB\nmemorysize_mb =&gt; 996.14\nmtu_eth0 =&gt; 1500\nmtu_lo =&gt; 16436\nnetmask =&gt; 255.255.255.0\nnetmask_eth0 =&gt; 255.255.255.0\n\nnetwork_lo =&gt; 127.0.0.0\noperatingsystem =&gt; CentOS\noperatingsystemmajrelease =&gt; 6\noperatingsystemrelease =&gt; 6.5\nosfamily =&gt; RedHat\npartitions =&gt; {\"sda1\"=&gt;{\n\"uuid\"=&gt;\"d74a4fa8-0883-4873-8db0-b09d91e2ee8d\", \"size\" =&gt;\"1024000\",\n\"mount\" =&gt; \"/boot\", \"filesystem\" =&gt; \"ext4\"}, \"sda2\"=&gt;{\"size\" =&gt; \"41981952\",\n\"filesystem\" =&gt; \"LVM2_member\"}\n}\npath =&gt; /usr/lib64/qt3.3/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin\nphysicalprocessorcount =&gt; 1\nprocessor0 =&gt; Intel(R) Core(TM) i7 CPU 920 @ 2.67GHz\nprocessor1 =&gt; Intel(R) Core(TM) i7 CPU 920 @ 2.67GHz\nprocessor2 =&gt; Intel(R) Core(TM) i7 CPU 920 @ 2.67GHz\nprocessorcount =&gt; 3\nproductname =&gt; VirtualBox\nps =&gt; ps -ef\npuppetversion =&gt; 3.6.2\nrubysitedir =&gt; /usr/lib/ruby/site_ruby/1.8\nrubyversion =&gt; 1.8.7\nselinux =&gt; true\nselinux_config_mode =&gt; enforcing\nselinux_config_policy =&gt; targeted\nselinux_current_mode =&gt; enforcing\nselinux_enforced =&gt; true\nselinux_policyversion =&gt; 24\nserialnumber =&gt; 0\nsshdsakey =&gt; AAAAB3NzaC1kc3MAAACBAK5fYwRM3UtOs8zBCtRTjuHLw56p94X/E0UZBZwFR3q7\nWH0x5+MNsjfmdCxKvpY/WlIIUcFJzvlfjXm4qDaTYalbzSZJMT266njNbw5WwLJcJ74KdW92ds76pjgm\nCsjAh+R9YnyKCEE35GsYjGH7whw0gl/rZVrjvWYKQDOmJA2dAAAAFQCoYABgjpv3EkTWgjLIMnxA0Gfud\nQAAAIBM4U6/nerfn6Qvt43FC2iybvwVo8ufixJl5YSEhs92uzsW6jiw68aaZ32q095/gEqYzeF7a2knr\nOpASgO9xXqStYKg8ExWQVaVGFTR1NwqhZvz0oRSbrN3h3tHgknoKETRAg/imZQ2P6tppAoQZ8wpuLrXU\nCyhgJGZ04Phv8hinAAAAIBN4xaycuK0mdH/YdcgcLiSn8cjgtiETVzDYa+jF\nswapfree =&gt; 3.55 GB\nswapfree_mb =&gt; 2015.99\nswapsize =&gt; 3.55 GB\nswapsize_mb =&gt; 2015.99\ntimezone =&gt; GMT\ntype =&gt; Other\nuniqueid =&gt; a8c0af01\nuptime =&gt; 45:012 hours\nuptime_days =&gt; 0\nuptime_hours =&gt; 6\nuptime_seconds =&gt; 21865\nuuid =&gt; BD8B9D85-1BFD-4015-A633-BF71D9A6A741\nvirtual =&gt; virtualbox\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u6570\u636e\u4e0e <code>bash \"env\"</code> \u53d8\u91cf\u4e2d\u53ef\u7528\u7684\u4fe1\u606f\u5f88\u5c11\u91cd\u53e0\u3002 Puppet \u76f4\u63a5\u4e0d\u4f7f\u7528\u6570\u636e\uff0c\u800c\u662f\u4f7f\u7528facter data\uff0cfacter data\u88ab\u89c6\u4e3a\u5168\u5c40\u53d8\u91cf\u3002</p> <p>\u4e8b\u5b9e\u968f\u540e\u53ef\u4f5c\u4e3a\u9876\u7ea7\u53d8\u91cf\u4f7f\u7528\uff0cPuppet master \u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u4e3a\u8bf7\u6c42\u4ee3\u7406\u7f16\u8bd1 Puppet \u76ee\u5f55\u3002\u56e0\u7d20\u5728\u6e05\u5355\u4e2d\u88ab\u79f0\u4e3a\u5e26\u6709 <code>$ prefix</code>\u7684\u666e\u901a\u53d8\u91cf\u3002</p>"},{"location":"chap6_pp/4pp_key_comps/#example","title":"Example","text":"<pre><code>if ($OperatingSystem == \"Linux\") { \n   $message = \"This machine OS is of the type $OperatingSystem \\n\" \n} else { \n   $message = \"This machine is unknown \\n\" \n} \n\nfile { \"/tmp/machineOperatingSystem.txt\": \n   ensure =&gt; file, \n   content =&gt; \"$message\" \n}\n</code></pre> <p>\u4e0a\u9762\u7684\u6e05\u5355\u6587\u4ef6\u53ea\u5173\u5fc3\u4e00\u4e2a\u540d\u4e3a <code>machineOperatingSystem.txt</code> \u7684\u6587\u4ef6\uff0c\u5176\u4e2d\u8be5\u6587\u4ef6\u7684\u5185\u5bb9\u88ab\u79f0\u4e3a <code>OperatingSystem</code> \u7684\u4e8b\u5b9e\u6263\u9664\u3002</p> <pre><code>[root@puppetagent1 /]# facter OperatingSystem \nLinux  \n\n[root@puppetagent1 /]# puppet apply /tmp/ostype.pp \nNotice: Compiled catalog for puppetagent1.codingbee.dyndns.org \nin environment production in 0.07 seconds \nNotice: /Stage[main]/Main/File[/tmp/machineOperatingSystem.txt]/ensure: \ndefined content as '{md5}f59dc5797d5402b1122c28c6da54d073' \nNotice: Finished catalog run in 0.04 seconds  \n\n[root@puppetagent1 /]# cat /tmp/machinetype.txt \nThis machine OS is of the type Linux\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#custom-facts","title":"Custom Facts","text":"<p>\u4ee5\u4e0a\u6211\u4eec\u770b\u5230\u7684\u6240\u6709\u4e8b\u5b9e\u90fd\u662f\u673a\u5668\u7684\u6838\u5fc3\u4e8b\u5b9e\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5c06\u6b64\u81ea\u5b9a\u4e49\u4e8b\u5b9e\u6dfb\u52a0\u5230\u8282\u70b9 -</p> <ul> <li>Using the \u201cexport FACTER \u2026 Syntax\u201d</li> <li>Using the $LOAD_PATH settings</li> <li>FACTERLIB</li> <li>Pluginsync</li> </ul>"},{"location":"chap6_pp/4pp_key_comps/#using-the-export-facter-syntax","title":"Using the \u201cexport FACTER\u201d Syntax","text":"<p>One can manually add the facts using the <code>export FACTER_{fact\u2019s name}</code> syntax.</p> <p>Example</p> <pre><code>[root@puppetagent1 facter]# export FACTER_tallest_mountain=\"Everest\"\n[root@puppetagent1 facter]# facter tallest_mountain Everest\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#using-the-load_path-settings","title":"Using the <code>$LOAD_PATH</code> Settings","text":"<p>\u5728 Ruby \u4e2d\uff0c<code>$LOAD_PATH</code> \u7b49\u4ef7\u4e8e Bash \u7279\u6b8a\u53c2\u6570\u3002\u867d\u7136\u5b83\u7c7b\u4f3c\u4e8e bash <code>$PATH</code> \u53d8\u91cf\uff0c\u4f46\u5b9e\u9645\u4e0a <code>$LOAD_PATH</code> \u4e0d\u662f\u73af\u5883\u53d8\u91cf\uff0c\u800c\u662f\u9884\u5b9a\u4e49\u53d8\u91cf\u3002</p> <p><code>$LOAD_PATH</code> has a synonym <code>\u201c$:\u201d</code>. This variable is an array to search and load the values.</p> <pre><code>[root@puppetagent1 ~]# ruby -e 'puts $LOAD_PATH'\n# note you have to use single quotes.\n/usr/lib/ruby/site_ruby/1.6\n/usr/lib64/ruby/site_ruby/1.6\n/usr/lib64/ruby/site_ruby/1.6/x86_64-linux\n/usr/lib/ruby/site_ruby\n/usr/lib64/ruby/site_ruby\n/usr/lib64/site_ruby/1.6\n/usr/lib64/site_ruby/1.6/x86_64-linux\n/usr/lib64/site_ruby\n/usr/lib/ruby/1.6\n/usr/lib64/ruby/1.6\n/usr/lib64/ruby/1.6/x86_64-linux\n</code></pre> <p>\u8ba9\u6211\u4eec\u4e3e\u4e00\u4e2a\u521b\u5efa\u76ee\u5f55\u56e0\u5b50\u5e76\u6dfb\u52a0 .pp \u6587\u4ef6\u5e76\u5411\u5176\u9644\u52a0\u5185\u5bb9\u7684\u793a\u4f8b\u3002</p> <pre><code>[root@puppetagent1 ~]# cd /usr/lib/ruby/site_ruby/\n[root@puppetagent1 site_ruby]# mkdir facter\n[root@puppetagent1 site_ruby]# cd facter/\n[root@puppetagent1 facter]# ls\n[root@puppetagent1 facter]# touch newadded_facts.rb\n</code></pre> <p>Add the following content to the <code>custom_facts.rb</code> file.</p> <pre><code>[root@puppetagent1 facter]# cat newadded_facts.rb\nFacter.add('tallest_mountain') do\nsetcode \"echo Everest\"\nend\n</code></pre> <p>Facter \u7684\u5de5\u4f5c\u65b9\u5f0f\u662f\u626b\u63cf <code>$LOAD_PATH</code> \u4e2d\u5217\u51fa\u7684\u6240\u6709\u6587\u4ef6\u5939\uff0c\u5e76\u5bfb\u627e\u4e00\u4e2a\u540d\u4e3a <code>facter</code> \u7684\u5bfc\u5411\u5668\u3002</p> <p>\u4e00\u65e6\u627e\u5230\u8be5\u7279\u5b9a\u6587\u4ef6\u5939\uff0c\u5b83\u5c06\u5728\u6587\u4ef6\u5939\u7ed3\u6784\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\u52a0\u8f7d\u5b83\u4eec\u3002\u5982\u679c\u5b83\u627e\u5230\u8fd9\u4e2a\u6587\u4ef6\u5939\uff0c\u90a3\u4e48\u5b83\u4f1a\u5728\u90a3\u4e2a facter \u6587\u4ef6\u5939\u4e2d\u67e5\u627e\u4efb\u4f55 Ruby \u6587\u4ef6\uff0c\u5e76\u52a0\u8f7d\u5173\u4e8e\u5185\u5b58\u4e2d\u4efb\u4f55\u7279\u5b9a\u914d\u7f6e\u7684\u6240\u6709\u5df2\u5b9a\u4e49\u4e8b\u5b9e</p>"},{"location":"chap6_pp/4pp_key_comps/#using-facterlib","title":"Using FACTERLIB","text":"<p>\u5728 Puppet \u4e2d\uff0cFACTERLIB \u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e <code>$LOAD_PATH</code> \u975e\u5e38\u76f8\u4f3c\uff0c\u4f46\u53ea\u6709\u4e00\u4e2a\u5173\u952e\u533a\u522b\uff0c\u5b83\u662f\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u73af\u5883\u53c2\u6570\uff0c\u800c\u4e0d\u662f Ruby \u7279\u6b8a\u53d8\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u672a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u3002</p> <pre><code>[root@puppetagent1 facter]# env | grep \"FACTERLIB\"\n[root@puppetagent1 facter]#\n</code></pre> <p>\u8981\u6d4b\u8bd5 FACTERLIB\uff0c\u6211\u4eec\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\u3002</p> <p>\u5728\u4ee5\u4e0b\u7ed3\u6784\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>test_facts</code> \u7684\u6587\u4ef6\u5939\u3002</p> <pre><code>[root@puppetagent1 tmp]# tree /tmp/test_facts/\n/tmp/some_facts/\n\u251c\u2500\u2500 vipin\n\u2502 \u2514\u2500\u2500 longest_river.rb\n\u2514\u2500\u2500 testing\n\u2514\u2500\u2500 longest_wall.rb\n</code></pre> <p>Add the following contents to the <code>.rb</code> files.</p> <pre><code>[root@puppetagent1 vipin]# cat longest_river.rb \nFacter.add('longest_river') do \n   setcode \"echo Nile\" \nend \n\n[root@puppetagent1 testing]# cat longest_wall.rb \nFacter.add('longest_wall') do \n   setcode \"echo 'China Wall'\" \nend \n</code></pre> <p>\u4f7f\u7528\u5bfc\u51fa\u8bed\u53e5\u3002</p> <pre><code>[root@puppetagent1 /]# export\nFACTERLIB = \"/tmp/some_facts/river:/tmp/some_facts/wall\"\n[root@puppetagent1 /]# env | grep \"FACTERLIB\"\nFACTERLIB = /tmp/some_facts/river:/tmp/some_facts/wall\n</code></pre> <p>\u6d4b\u8bd5\u65b0\u56e0\u7d20\u3002</p> <pre><code>[root@puppetagent1 /]# facter longest_river\nNile\n[root@puppetagent1 /]# facter longest_wall\nChina Wall\n</code></pre>"},{"location":"chap6_pp/4pp_key_comps/#facts","title":"\u5916\u90e8 Facts","text":"<p>\u5f53\u7528\u6237\u5e0c\u671b\u5e94\u7528\u5728\u4f9b\u5e94\u65f6\u521b\u5efa\u7684\u4e00\u4e9b\u65b0\u4e8b\u5b9e\u65f6\uff0c\u5916\u90e8\u4e8b\u5b9e\u975e\u5e38\u6709\u7528\u3002\u5916\u90e8 Facts\u662f\u5728\u914d\u7f6e\u9636\u6bb5\uff08\u4f8b\u5982\u4f7f\u7528 vSphere\u3001OpenStack\u3001AWS \u7b49\uff09\u5c06\u5143\u6570\u636e\u5e94\u7528\u5230 VM \u7684\u5173\u952e\u65b9\u5f0f\u4e4b\u4e00\u3002</p> <p>Puppet \u53ef\u4ee5\u4f7f\u7528\u521b\u5efa\u7684\u6240\u6709\u5143\u6570\u636e\u53ca\u5176\u8be6\u7ec6\u4fe1\u606f\u6765\u786e\u5b9a\u76ee\u5f55\u4e2d\u5e94\u8be5\u5b58\u5728\u54ea\u4e9b\u8be6\u7ec6\u4fe1\u606f\uff0c\u8fd9\u4e9b\u8be6\u7ec6\u4fe1\u606f\u5c06\u88ab\u5e94\u7528\u3002</p> <p>Creating an External Fact</p> <p>\u5728\u4ee3\u7406\u673a\u5668\u4e0a\uff0c\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\uff0c\u5982\u4e0b\u6240\u8ff0\u3002</p> <pre><code>$ mkdir -p /etc/facter/facts.d\n</code></pre> <p>Create a Shell script in the directory with the following content.</p> <pre><code>$ ls -l /etc/facter/facts.d\ntotal 4\n-rwxrwxrwx. 1 root root 65 Sep 18 13:11 external-factstest.sh\n$ cat /etc/facter/facts.d/external-factstest.sh\n#!/bin/bash\necho \"hostgroup = dev\"\necho \"environment = development\"\n</code></pre> <p>\u66f4\u6539\u811a\u672c\u6587\u4ef6\u7684\u6743\u9650\u3002</p> <pre><code>$ chmod u+x /etc/facter/facts.d/external-facts.sh\n</code></pre> <p>\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u5e26\u6709\u952e/\u503c\u5bf9\u7684\u53d8\u91cf\u3002</p> <pre><code>$ facter hostgroup\ndev\n$ facter environment\ndevelopment\n</code></pre> <p>\u53ef\u4ee5\u5728 Puppet \u4e2d\u7f16\u5199\u81ea\u5b9a\u4e49\u4e8b\u5b9e\u3002\u4f5c\u4e3a\u53c2\u8003\uff0c\u8bf7\u4f7f\u7528 Puppet \u7f51\u7ad9\u7684\u4ee5\u4e0b\u94fe\u63a5\u3002</p> <p>https://docs.puppet.com/facter/latest/fact_overview.html#writing-structured-facts</p>"},{"location":"chap6_pp/5pp_resource/","title":"5 Puppet \u8d44\u6e90","text":"<p>\u8d44\u6e90\u662f\u7528\u4e8e\u8bbe\u8ba1\u548c\u6784\u5efa\u4efb\u4f55\u7279\u5b9a\u57fa\u7840\u8bbe\u65bd\u6216\u673a\u5668\u7684 Puppet \u7684\u5173\u952e\u57fa\u672c\u5355\u5143\u4e4b\u4e00\u3002\u5b83\u4eec\u4e3b\u8981\u7528\u4e8e\u5efa\u6a21\u548c\u7ef4\u62a4\u7cfb\u7edf\u914d\u7f6e\u3002 Puppet \u5177\u6709\u591a\u79cd\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u53ef\u7528\u4e8e\u5b9a\u4e49\u7cfb\u7edf\u67b6\u6784\uff0c\u6216\u8005\u7528\u6237\u53ef\u4ee5\u5229\u7528\u8fd9\u4e9b\u8d44\u6e90\u6765\u6784\u5efa\u548c\u5b9a\u4e49\u65b0\u8d44\u6e90\u3002</p> <p>\u6e05\u5355\u6587\u4ef6\u6216\u4efb\u4f55\u5176\u4ed6\u6587\u4ef6\u4e2d\u7684 Puppet \u4ee3\u7801\u5757\u79f0\u4e3a\u8d44\u6e90\u58f0\u660e\u3002\u4ee3\u7801\u5757\u662f\u7528\u4e00\u79cd\u79f0\u4e3a Declarative Modelling Language (DML) \u7684\u8bed\u8a00\u7f16\u5199\u7684\u3002\u4ee5\u4e0b\u662f\u5b83\u7684\u5916\u89c2\u793a\u4f8b\u3002</p> <pre><code>user { 'vipin': \n   ensure =&gt; present, \n   uid    =&gt; '552', \n   shell  =&gt; '/bin/bash', \n   home   =&gt; '/home/vipin', \n}\n</code></pre> <p>\u5728 Puppet \u4e2d\uff0c\u4efb\u4f55\u7279\u5b9a\u8d44\u6e90\u7c7b\u578b\u7684\u8d44\u6e90\u58f0\u660e\u90fd\u662f\u5728\u4ee3\u7801\u5757\u4e2d\u5b8c\u6210\u7684\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u7528\u6237\u4e3b\u8981\u7531\u56db\u4e2a\u9884\u5b9a\u4e49\u53c2\u6570\u7ec4\u6210\u3002</p> <ul> <li>Resource Type \u2212 \u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u5b83\u662f\u7528\u6237</li> <li>Resource Parameter \u2212 \u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u5b83\u662f Vipin\u3002.</li> <li>Attributes \u2212 \u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u662f ensure, uid, shell, home</li> <li>Values \u2212 \u8fd9\u4e9b\u662f\u5bf9\u5e94\u4e8e\u6bcf\u4e2a\u5c5e\u6027\u7684\u503c\u3002</li> </ul> <p>\u6bcf\u79cd\u8d44\u6e90\u7c7b\u578b\u90fd\u6709\u81ea\u5df1\u5b9a\u4e49\u5b9a\u4e49\u548c\u53c2\u6570\u7684\u65b9\u5f0f\uff0c\u7528\u6237\u6709\u6743\u9009\u62e9\u4ed6\u5e0c\u671b\u8d44\u6e90\u7684\u5916\u89c2\u3002</p>"},{"location":"chap6_pp/5pp_resource/#_1","title":"\u8d44\u6e90\u7c7b\u578b","text":"<p>Puppet \u4e2d\u6709\u4e0d\u540c\u7c7b\u578b\u7684\u8d44\u6e90\u53ef\u7528\uff0c\u5b83\u4eec\u6709\u81ea\u5df1\u7684\u529f\u80fd\u65b9\u5f0f\u3002\u53ef\u4ee5\u4f7f\u7528<code>describe</code>\u547d\u4ee4\u548c<code>-list</code>\u9009\u9879\u67e5\u770b\u8fd9\u4e9b\u8d44\u6e90\u7c7b\u578b\u3002</p> <pre><code>[root@puppetmaster ~]# puppet describe --list\nThese are the types known to puppet:\naugeas - Apply a change or an array of changes to the ...\ncomputer - Computer object management using DirectorySer ...\ncron - Installs and manages cron jobs\nexec - Executes external commands\nfile - Manages files, including their content, owner ...\nfilebucket - A repository for storing and retrieving file ...\ngroup - Manage groups\nhost - Installs and manages host entries\ninterface - This represents a router or switch interface\nk5login - Manage the \u2018.k5login\u2019 file for a user\nmacauthorization - Manage the Mac OS X authorization database\nmailalias - .. no documentation ..\nmaillist - Manage email lists\nmcx - MCX object management using DirectoryService ...\nmount - Manages mounted filesystems, including puttin ...\nnagios_command - The Nagios type command\nnagios_contact - The Nagios type contact\nnagios_contactgroup - The Nagios type contactgroup\nnagios_host - The Nagios type host\nnagios_hostdependency - The Nagios type hostdependency\nnagios_hostescalation - The Nagios type hostescalation\nnagios_hostextinfo - The Nagios type hostextinfo\nnagios_hostgroup - The Nagios type hostgroup\n\nnagios_service - The Nagios type service\nnagios_servicedependency - The Nagios type servicedependency\nnagios_serviceescalation - The Nagios type serviceescalation\nnagios_serviceextinfo - The Nagios type serviceextinfo\nnagios_servicegroup - The Nagios type servicegroup\nnagios_timeperiod - The Nagios type timeperiod\nnotify - .. no documentation ..\npackage - Manage packages\nresources - This is a metatype that can manage other reso ...\nrouter - .. no documentation ..\nschedule - Define schedules for Puppet\nscheduled_task - Installs and manages Windows Scheduled Tasks\nselboolean - Manages SELinux booleans on systems with SELi ...\nservice - Manage running services\nssh_authorized_key - Manages SSH authorized keys\nsshkey - Installs and manages ssh host keys\nstage - A resource type for creating new run stages\ntidy - Remove unwanted files based on specific crite ...\nuser - Manage users\nvlan - .. no documentation ..\nwhit - Whits are internal artifacts of Puppet's curr ...\nyumrepo - The client-side description of a yum reposito ...\nzfs - Manage zfs\nzone - Manages Solaris zones\nzpool - Manage zpools\n</code></pre>"},{"location":"chap6_pp/5pp_resource/#_2","title":"\u8d44\u6e90\u6807\u9898","text":"<p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u6211\u4eec\u7684\u8d44\u6e90\u6807\u9898\u4e3a vipin\uff0c\u5b83\u5bf9\u4e8e\u5728\u540c\u4e00\u4ee3\u7801\u6587\u4ef6\u4e2d\u4f7f\u7528\u7684\u6bcf\u4e2a\u8d44\u6e90\u90fd\u662f\u552f\u4e00\u7684\u3002\u8fd9\u662f\u6b64\u7528\u6237\u8d44\u6e90\u7c7b\u578b\u7684\u552f\u4e00\u6807\u9898\u3002\u6211\u4eec\u4e0d\u80fd\u62e5\u6709\u540c\u540d\u7684\u8d44\u6e90\uff0c\u56e0\u4e3a\u5b83\u4f1a\u5bfc\u81f4\u51b2\u7a81\u3002</p> <p>\u8d44\u6e90\u547d\u4ee4\u53ef\u7528\u4e8e\u67e5\u770b\u6240\u6709\u4f7f\u7528\u7c7b\u578b\u7528\u6237\u7684\u8d44\u6e90\u5217\u8868\u3002</p> <pre><code>[root@puppetmaster ~]# puppet resource user \nuser { 'abrt': \n   ensure           =&gt; 'present', \n   gid              =&gt; '173', \n   home             =&gt; '/etc/abrt', \n   password         =&gt; '!!', \n   password_max_age =&gt; '-1', \n   password_min_age =&gt; '-1', \n   shell            =&gt; '/sbin/nologin', \n   uid              =&gt; '173', \n} \n\nuser { 'admin': \n   ensure           =&gt; 'present', \n   comment          =&gt; 'admin', \n   gid              =&gt; '444', \n   groups           =&gt; ['sys', 'admin'], \n   home             =&gt; '/var/admin', \n   password         =&gt; '*', \n   password_max_age =&gt; '99999', \n   password_min_age =&gt; '0', \n   shell            =&gt; '/sbin/nologin', \n   uid              =&gt; '55', \n} \n\nuser { 'tomcat': \n   ensure           =&gt; 'present', \n   comment          =&gt; 'tomcat', \n   gid              =&gt; '100', \n   home             =&gt; '/var/www', \n   password         =&gt; '!!', \n   password_max_age =&gt; '-1', \n   password_min_age =&gt; '-1', \n   shell            =&gt; '/sbin/nologin', \n   uid              =&gt; '100', \n} \n</code></pre>"},{"location":"chap6_pp/5pp_resource/#_3","title":"\u5217\u51fa\u7279\u5b9a\u7528\u6237\u7684\u8d44\u6e90","text":"<pre><code>[root@puppetmaster ~]# puppet resource user tomcat \nuser { 'apache': \n   ensure           =&gt; 'present', \n   comment          =&gt; 'tomcat', \n   gid              =&gt; '100', \n   home             =&gt; '/var/www', \n   password         =&gt; '!!', \n   password_max_age =&gt; '-1', \n   password_min_age =&gt; '-1', \n   shell            =&gt; '/sbin/nologin', \n   uid              =&gt; '100\u2019, \n}\n</code></pre>"},{"location":"chap6_pp/5pp_resource/#_4","title":"\u5c5e\u6027\u548c\u503c","text":"<p>\u4efb\u4f55\u8d44\u6e90\u7684\u4e3b\u4f53\u90fd\u662f\u7531\u4e00\u7ec4\u5c5e\u6027\u503c\u5bf9\u7ec4\u6210\u7684\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u6307\u5b9a\u7ed9\u5b9a\u8d44\u6e90\u5c5e\u6027\u7684\u503c\u3002\u6bcf\u79cd\u8d44\u6e90\u7c7b\u578b\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7ec4\u5c5e\u6027\uff0c\u53ef\u4ee5\u4f7f\u7528\u952e\u503c\u5bf9\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u63cf\u8ff0\u53ef\u7528\u4e8e\u83b7\u53d6\u6709\u5173\u7279\u5b9a\u8d44\u6e90\u5c5e\u6027\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u7684\u5b50\u547d\u4ee4\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u62e5\u6709\u6709\u5173\u7528\u6237\u8d44\u6e90\u7684\u8be6\u7ec6\u4fe1\u606f\u53ca\u5176\u6240\u6709\u53ef\u914d\u7f6e\u5c5e\u6027\u3002</p> <pre><code>root@puppetmaster ~]# puppet describe user \nuser \n==== \nManage users.  This type is mostly built to manage system users, \nso it is lacking some features useful for managing normal users. \n\nThis resource type uses the prescribed native tools for creating groups \nand generally uses POSIX APIs for retrieving information about them.\nIt does not directly modify \u2018/etc/passwd\u2019 or anything. \n\n**Autorequires:** If Puppet is managing the user's primary group \n(as provided in the \u2018gid\u2019 attribute), \nthe user resource will autorequire that group. \nIf Puppet is managing any role accounts corresponding to the user's roles, \nthe user resource will autorequire those role accounts.  \n\nParameters \n---------- \n- **allowdupe** \n   Whether to allow duplicate UIDs. Defaults to \u2018false\u2019. \n   Valid values are \u2018true\u2019, \u2018false\u2019, \u2018yes\u2019, \u2018no\u2019.  \n\n- **attribute_membership** \n   Whether specified attribute value pairs should be treated as the \n   **complete list** (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of \n   attribute/value pairs for the user. Defaults to \u2018minimum\u2019. \n   Valid values are \u2018inclusive\u2019, \u2018minimum\u2019.  \n\n- **auths** \n   The auths the user has.  Multiple auths should be \n   specified as an array. \n   Requires features manages_solaris_rbac.  \n\n- **comment** \n   A description of the user.  Generally the user's full name.  \n\n- **ensure** \n   The basic state that the object should be in. \n   Valid values are \u2018present\u2019, \u2018absent\u2019, \u2018role\u2019.  \n\n- **expiry**\n   The expiry date for this user. Must be provided in \n   a zero-padded YYYY-MM-DD format --- e.g. 2010-02-19. \n   If you want to make sure the user account does never \n   expire, you can pass the special value \u2018absent\u2019. \n   Valid values are \u2018absent\u2019. Values can match \u2018/^\\d{4}-\\d{2}-\\d{2}$/\u2019. \n   Requires features manages_expiry.  \n\n- **forcelocal** \n   Forces the mangement of local accounts when accounts are also \n   being managed by some other NSS  \n\n- **gid** \n   The user's primary group. Can be specified numerically or by name. \n   This attribute is not supported on Windows systems; use the \u2018groups\u2019 \n   attribute instead. (On Windows, designating a primary group is only \n   meaningful for domain accounts, which Puppet does not currently manage.)  \n\n- **groups** \n   The groups to which the user belongs. The primary group should \n   not be listed, and groups should be identified by name rather than by \n   GID.  Multiple groups should be specified as an array.  \n\n- **home** \n   The home directory of the user.  The directory must be created \n   separately and is not currently checked for existence.  \n\n- **ia_load_module** \n   The name of the I&amp;A module to use to manage this user. \n   Requires features manages_aix_lam.  \n\n- **iterations** \n   This is the number of iterations of a chained computation of the \n   password hash (http://en.wikipedia.org/wiki/PBKDF2).  This parameter \n   is used in OS X. This field is required for managing passwords on OS X \n   &gt;= 10.8. \n   Requires features manages_password_salt. \n\n- **key_membership**  \n\n- **managehome** \n   Whether to manage the home directory when managing the user. \n   This will create the home directory when \u2018ensure =&gt; present\u2019, and \n   delete the home directory when \u2018ensure =&gt; absent\u2019. Defaults to \u2018false\u2019. \n   Valid values are \u2018true\u2019, \u2018false\u2019, \u2018yes\u2019, \u2018no\u2019.  \n\n- **membership** \n   Whether specified groups should be considered the **complete list** \n   (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of groups to which \n   the user belongs. Defaults to \u2018minimum\u2019. \n   Valid values are \u2018inclusive\u2019, \u2018minimum\u2019.  \n\n- **name** \n   The user name. While naming limitations vary by operating system, \n   it is advisable to restrict names to the lowest common denominator, \n   which is a maximum of 8 characters beginning with a letter. \n   Note that Puppet considers user names to be case-sensitive, regardless \n   of the platform's own rules; be sure to always use the same case when \n   referring to a given user.  \n\n- **password** \n   The user's password, in whatever encrypted format the local \n   system requires. \n   * Most modern Unix-like systems use salted SHA1 password hashes. You can use \n      Puppet's built-in \u2018sha1\u2019 function to generate a hash from a password. \n   * Mac OS X 10.5 and 10.6 also use salted SHA1 hashes.  \n\nWindows API \n   for setting the password hash. \n   [stdlib]: https://github.com/puppetlabs/puppetlabs-stdlib/ \n   Be sure to enclose any value that includes a dollar sign ($) in single \n   quotes (') to avoid accidental variable interpolation. \n   Requires features manages_passwords.  \n\n- **password_max_age** \n   The maximum number of days a password may be used before it must be changed. \n   Requires features manages_password_age.  \n\n- **password_min_age** \n   The minimum number of days a password must be used before it may be changed. \n   Requires features manages_password_age.  \n\n- **profile_membership** \n   Whether specified roles should be treated as the **complete list** \n   (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of roles \n   of which the user is a member. Defaults to \u2018minimum\u2019. \n   Valid values are \u2018inclusive\u2019, \u2018minimum\u2019.  \n\n- **profiles** \n   The profiles the user has.  Multiple profiles should be \n   specified as an array. \n   Requires features manages_solaris_rbac.  \n\n- **project** \n   The name of the project associated with a user. \n   Requires features manages_solaris_rbac.  \n\n- **uid** \n   The user ID; must be specified numerically. If no user ID is \n   specified when creating a new user, then one will be chosen \n   automatically. This will likely result in the same user having \n   different UIDs on different systems, which is not recommended. This is \n   especially noteworthy when managing the same user on both Darwin and \n   other platforms, since Puppet does UID generation on Darwin, but \n   the underlying tools do so on other platforms. \n   On Windows, this property is read-only and will return the user's \n   security identifier (SID). \n</code></pre>"},{"location":"chap6_pp/5pp_resource/#puppet","title":"Puppet \u8d44\u6e90\u62bd\u8c61\u5c42","text":"<p>\u5728 Puppet \u4e2d\uff0c\u8d44\u6e90\u62bd\u8c61\u5c42 (RAL) \u53ef\u4ee5\u88ab\u89c6\u4e3a\u6574\u4e2a\u57fa\u7840\u67b6\u6784\u548c Puppet \u8bbe\u7f6e\u5de5\u4f5c\u7684\u6838\u5fc3\u6982\u5ff5\u5316\u6a21\u578b\u3002\u5728 RAL \u4e2d\uff0c\u6bcf\u4e2a\u5b57\u6bcd\u90fd\u6709\u81ea\u5df1\u7684\u91cd\u8981\u542b\u4e49\uff0c\u5b9a\u4e49\u5982\u4e0b\u3002</p>"},{"location":"chap6_pp/5pp_resource/#resource-r","title":"Resource [R]","text":"<p>\u4e00\u4e2a\u8d44\u6e90\u53ef\u4ee5\u88ab\u8ba4\u4e3a\u662f\u7528\u4e8e\u5bf9 Puppet \u4e2d\u7684\u4efb\u4f55\u914d\u7f6e\u8fdb\u884c\u5efa\u6a21\u7684\u6240\u6709\u8d44\u6e90\u3002\u5b83\u4eec\u57fa\u672c\u4e0a\u662f\u5185\u7f6e\u8d44\u6e90\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5b58\u5728\u4e8e Puppet \u4e2d\u3002\u5b83\u4eec\u53ef\u4ee5\u88ab\u8ba4\u4e3a\u662f\u5c5e\u4e8e\u9884\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578b\u7684\u4e00\u7ec4\u8d44\u6e90\u3002\u5b83\u4eec\u7c7b\u4f3c\u4e8e\u4efb\u4f55\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u4e2d\u7684 OOP \u6982\u5ff5\uff0c\u5176\u4e2d\u5bf9\u8c61\u662f\u7c7b\u7684\u5b9e\u4f8b\u3002\u5728 Puppet \u4e2d\uff0c\u5b83\u7684\u8d44\u6e90\u662f\u4e00\u79cd\u8d44\u6e90\u7c7b\u578b\u7684\u5b9e\u4f8b\u3002</p>"},{"location":"chap6_pp/5pp_resource/#abstraction-a","title":"Abstraction [A]","text":"<p>\u62bd\u8c61\u53ef\u4ee5\u88ab\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5173\u952e\u7279\u6027\uff0c\u5176\u4e2d\u8d44\u6e90\u662f\u72ec\u7acb\u4e8e\u76ee\u6807\u64cd\u4f5c\u7cfb\u7edf\u5b9a\u4e49\u7684\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5728\u7f16\u5199\u4efb\u4f55\u6e05\u5355\u6587\u4ef6\u65f6\uff0c\u7528\u6237\u4e0d\u5fc5\u62c5\u5fc3\u76ee\u6807\u673a\u5668\u6216\u5b58\u5728\u4e8e\u8be5\u7279\u5b9a\u673a\u5668\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u62bd\u8c61\u5730\u8bf4\uff0c\u8d44\u6e90\u63d0\u4f9b\u4e86\u5173\u4e8e Puppet \u4ee3\u7406\u4e0a\u9700\u8981\u5b58\u5728\u4ec0\u4e48\u7684\u8db3\u591f\u4fe1\u606f\u3002</p> <p>Puppet \u5c06\u8d1f\u8d23\u5e55\u540e\u53d1\u751f\u7684\u6240\u6709\u529f\u80fd\u6216Magic\u3002\u65e0\u8bba\u8d44\u6e90\u548c\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\uff0cPuppet \u90fd\u4f1a\u8d1f\u8d23\u5728\u76ee\u6807\u673a\u5668\u4e0a\u5b9e\u65bd\u914d\u7f6e\uff0c\u7528\u6237\u65e0\u9700\u62c5\u5fc3 Puppet \u5728\u5e55\u540e\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002</p> <p>\u5728\u62bd\u8c61\u4e2d\uff0cPuppet \u5c06\u8d44\u6e90\u4e0e\u5176\u5b9e\u73b0\u5206\u79bb\u3002\u6b64\u5e73\u53f0\u7279\u5b9a\u914d\u7f6e\u6765\u81ea\u63d0\u4f9b\u8005\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u5b50\u547d\u4ee4\u53ca\u5176\u63d0\u4f9b\u7a0b\u5e8f\u3002</p>"},{"location":"chap6_pp/5pp_resource/#layer-l","title":"Layer [L]","text":"<p>\u53ef\u4ee5\u6839\u636e\u8d44\u6e90\u96c6\u5408\u5b9a\u4e49\u6574\u4e2a\u673a\u5668\u8bbe\u7f6e\u548c\u914d\u7f6e\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7 Puppet \u7684 CLI \u754c\u9762\u67e5\u770b\u548c\u7ba1\u7406\u3002</p>"},{"location":"chap6_pp/5pp_resource/#_5","title":"\u7528\u6237\u8d44\u6e90\u7c7b\u578b\u793a\u4f8b","text":"<pre><code>[root@puppetmaster ~]# puppet describe user --providers \nuser \n==== \nManage users.\nThis type is mostly built to manage systemusers, \nso it is lacking some features useful for managing normalusers. \nThis resource type uses the prescribed native tools for \ncreating groups and generally uses POSIX APIs for retrieving informationabout them.\nIt does not directly modify '/etc/passwd' or anything. \n\n- **comment** \n   A description of the user.  Generally the user's full name.  \n\n- **ensure** \n   The basic state that the object should be in. \n   Valid values are 'present', 'absent', 'role'.  \n\n- **expiry** \n   The expiry date for this user. \n   Must be provided in a zero-padded YYYY-MM-DD format --- e.g. 2010-02-19. \n   If you want to make sure the user account does never expire, \n   you can pass the special value 'absent'. \n   Valid values are 'absent'. \n   Values can match '/^\\d{4}-\\d{2}-\\d{2}$/'. \n   Requires features manages_expiry.  \n\n- **forcelocal** \n   Forces the management of local accounts when accounts are also \n   being managed by some other NSS \n   Valid values are 'true', 'false', 'yes', 'no'. \n   Requires features libuser.  \n\n- **gid** \n   The user's primary group.  Can be specified numerically or by name. \n   This attribute is not supported on Windows systems; use the \u2018groups\u2019 \n   attribute instead. (On Windows, designating a primary group is only \n   meaningful for domain accounts, which Puppet does not currently manage.)  \n\n- **groups** \n   The groups to which the user belongs. The primary group should \n   not be listed, and groups should be identified by name rather than by \n   GID. Multiple groups should be specified as an array.  \n\n- **home** \n   The home directory of the user.  The directory must be created \n   separately and is not currently checked for existence.  \n\n- **ia_load_module**\n   The name of the I&amp;A module to use to manage this user. \n   Requires features manages_aix_lam.  \n\n- **iterations** \n   This is the number of iterations of a chained computation of the \n   password hash (http://en.wikipedia.org/wiki/PBKDF2).  \n   This parameter is used in OS X. \n   This field is required for managing passwords on OS X &gt;= 10.8.  \n\n- **key_membership** \n   Whether specified key/value pairs should be considered the \n   **complete list** ('inclusive') or the **minimum list** ('minimum') of \n   the user's attributes. Defaults to 'minimum'. \n   Valid values are 'inclusive', 'minimum'.  \n\n- **keys** \n   Specify user attributes in an array of key = value pairs. \n   Requires features manages_solaris_rbac.  \n\n- **managehome** \n   Whether to manage the home directory when managing the user. \n   This will create the home directory when 'ensure =&gt; present', and \n   delete the home directory when \u2018ensure =&gt; absent\u2019. Defaults to \u2018false\u2019. \n   Valid values are \u2018true\u2019, \u2018false\u2019, \u2018yes\u2019, \u2018no\u2019.  \n\n- **membership** \n   Whether specified groups should be considered the **complete list** \n   (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of groups to which \n   the user belongs. Defaults to \u2018minimum\u2019. \n   Valid values are \u2018inclusive\u2019, \u2018minimum\u2019. \n\n- **name** \n   The user name. While naming limitations vary by operating system, \n   it is advisable to restrict names to the lowest common denominator.  \n\n- **password** \n   The user's password, in whatever encrypted format the local system requires. \n   * Most modern Unix-like systems use salted SHA1 password hashes. You can use \n      Puppet's built-in \u2018sha1\u2019 function to generate a hash from a password. \n   * Mac OS X 10.5 and 10.6 also use salted SHA1 hashes. \n   * Mac OS X 10.7 (Lion) uses salted SHA512 hashes. \n   The Puppet Labs [stdlib][] module contains a \u2018str2saltedsha512\u2019 \n   function which can generate password hashes for Lion. \n   * Mac OS X 10.8 and higher use salted SHA512 PBKDF2 hashes. \n   When managing passwords on these systems the salt and iterations properties \n   need to be specified as well as the password. \n   [stdlib]: https://github.com/puppetlabs/puppetlabs-stdlib/ \n   Be sure to enclose any value that includes a dollar sign ($) in single \n   quotes (') to avoid accidental variable interpolation. \n   Requires features manages_passwords.  \n\n- **password_max_age** \n   The maximum number of days a password may be used before it must be changed. \nRequires features manages_password_age.  \n\n- **password_min_age** \n   The minimum number of days a password must be used before it may be changed. \nRequires features manages_password_age.  \n\n- **profile_membership** \n   Whether specified roles should be treated as the **complete list** \n   (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of roles \n   of which the user is a member. Defaults to \u2018minimum\u2019. \n   Valid values are \u2018inclusive\u2019, \u2018minimum\u2019. \n\n- **profiles** \n   The profiles the user has.  Multiple profiles should be \n   specified as an array. \nRequires features manages_solaris_rbac.  \n\n- **project** \n   The name of the project associated with a user. \n   Requires features manages_solaris_rbac.  \n\n- **purge_ssh_keys** \n   Purge ssh keys authorized for the user \n   if they are not managed via ssh_authorized_keys. \n   When true, looks for keys in .ssh/authorized_keys in the user's home directory. \n   Possible values are true, false, or an array of \n   paths to file to search for authorized keys. \n   If a path starts with ~ or %h, this token is replaced with the user's home directory. \n   Valid values are \u2018true\u2019, \u2018false\u2019.  \n\n- **role_membership** \n   Whether specified roles should be considered the **complete list** \n   (\u2018inclusive\u2019) or the **minimum list** (\u2018minimum\u2019) of roles the user has. \n   Defaults to \u2018minimum\u2019. \nValid values are \u2018inclusive\u2019, \u2018minimum\u2019.  \n\n- **roles** \n   The roles the user has.  Multiple roles should be \n   specified as an array. \nRequires features manages_solaris_rbac.  \n\n- **salt** \n   This is the 32 byte salt used to generate the PBKDF2 password used in \n   OS X. This field is required for managing passwords on OS X &gt;= 10.8. \n   Requires features manages_password_salt. \n\n- **shell** \n   The user's login shell.  The shell must exist and be \n   executable. \n   This attribute cannot be managed on Windows systems. \n   Requires features manages_shell. \n\n- **system** \n   Whether the user is a system user, according to the OS's criteria; \n   on most platforms, a UID less than or equal to 500 indicates a system \n   user. Defaults to \u2018false\u2019. \n   Valid values are \u2018true\u2019, \u2018false\u2019, \u2018yes\u2019, \u2018no\u2019.  \n\n- **uid** \n   The user ID; must be specified numerically. If no user ID is \n   specified when creating a new user, then one will be chosen \n   automatically. This will likely result in the same user having \n   different UIDs on different systems, which is not recommended. \n   This is especially noteworthy when managing the same user on both Darwin and \n   other platforms, since Puppet does UID generation on Darwin, but \n   the underlying tools do so on other platforms. \n   On Windows, this property is read-only and will return the user's \n   security identifier (SID).  \n\nProviders \n--------- \n\n- **aix** \n   User management for AIX. \n   * Required binaries: '/bin/chpasswd', '/usr/bin/chuser', \n   '/usr/bin/mkuser', '/usr/sbin/lsgroup', '/usr/sbin/lsuser', \n   '/usr/sbin/rmuser'. \n   * Default for \u2018operatingsystem\u2019 == \u2018aix\u2019. \n   * Supported features: \u2018manages_aix_lam\u2019, \u2018manages_expiry\u2019, \n   \u2018manages_homedir\u2019, \u2018manages_password_age\u2019, \u2018manages_passwords\u2019, \n   \u2018manages_shell\u2019. \n\n- **directoryservice** \n   User management on OS X. \n   * Required binaries: \u2018/usr/bin/dscacheutil\u2019, \u2018/usr/bin/dscl\u2019, \n   \u2018/usr/bin/dsimport\u2019, \u2018/usr/bin/plutil\u2019, \u2018/usr/bin/uuidgen\u2019. \n   * Default for \u2018operatingsystem\u2019 == \u2018darwin\u2019. \n   * Supported features: \u2018manages_password_salt\u2019, \u2018manages_passwords\u2019, \n   \u2018manages_shell\u2019.\n\n- **hpuxuseradd** \n   User management for HP-UX. This provider uses the undocumented \u2018-F\u2019 \n   switch to HP-UX's special \u2018usermod\u2019 binary to work around the fact that \n   its standard \u2018usermod\u2019 cannot make changes while the user is logged in. \n   * Required binaries: \u2018/usr/sam/lbin/useradd.sam\u2019, \n   \u2018/usr/sam/lbin/userdel.sam\u2019, \u2018/usr/sam/lbin/usermod.sam\u2019. \n   * Default for \u2018operatingsystem\u2019 == \u2018hp-ux\u2019. \n   * Supported features: \u2018allows_duplicates\u2019, \u2018manages_homedir\u2019, \n   \u2018manages_passwords\u2019.  \n\n- **ldap** \n   User management via LDAP. \n   This provider requires that you have valid values for all of the \n   LDAP-related settings in \u2018puppet.conf\u2019, including \u2018ldapbase\u2019.\n   You will almost definitely need settings for \u2018ldapuser\u2019 and \u2018ldappassword\u2019 in order \n   for your clients to write to LDAP. \n* Supported features: \u2018manages_passwords\u2019, \u2018manages_shell\u2019.  \n\n- **pw** \n   User management via \u2018pw\u2019 on FreeBSD and DragonFly BSD. \n   * Required binaries: \u2018pw\u2019. \n   * Default for \u2018operatingsystem\u2019 == \u2018freebsd, dragonfly\u2019. \n   * Supported features: \u2018allows_duplicates\u2019, \u2018manages_expiry\u2019, \n   \u2018manages_homedir\u2019, \u2018manages_passwords\u2019, \u2018manages_shell\u2019. \n\n- **user_role_add** \n   User and role management on Solaris, via \u2018useradd\u2019 and \u2018roleadd\u2019. \n   * Required binaries: \u2018passwd\u2019, \u2018roleadd\u2019, \u2018roledel\u2019, \u2018rolemod\u2019, \n   \u2018useradd\u2019, \u2018userdel\u2019, \u2018usermod\u2019. \n   * Default for \u2018osfamily\u2019 == \u2018solaris\u2019. \n   * Supported features: \u2018allows_duplicates\u2019, \u2018manages_homedir\u2019, \n   \u2018manages_password_age\u2019, \u2018manages_passwords\u2019, \u2018manages_solaris_rbac\u2019.  \n\n- **useradd** \n   User management via \u2018useradd\u2019 and its ilk.  Note that you will need to \n   install Ruby's shadow password library (often known as \u2018ruby-libshadow\u2019) \n   if you wish to manage user passwords. \n   * Required binaries: \u2018chage\u2019, \u2018luseradd\u2019, \u2018useradd\u2019, \u2018userdel\u2019, \u2018usermod\u2019. \n   * Supported features: \u2018allows_duplicates\u2019, \u2018libuser\u2019, \u2018manages_expiry\u2019, \n   \u2018manages_homedir\u2019, \u2018manages_password_age\u2019, \u2018manages_passwords\u2019, \n   \u2018manages_shell\u2019, \u2018system_users\u2019.  \n\n- **windows_adsi** \n   Local user management for Windows. \n   * Default for 'operatingsystem' == 'windows'. \n   * Supported features: 'manages_homedir', 'manages_passwords'. \n</code></pre>"},{"location":"chap6_pp/5pp_resource/#_6","title":"\u6d4b\u8bd5\u8d44\u6e90","text":"<p>\u5728 Puppet \u4e2d\uff0c\u6d4b\u8bd5\u8d44\u6e90\u76f4\u63a5\u610f\u5473\u7740\u9700\u8981\u5148\u7533\u8bf7\u81ea\u5df1\u60f3\u8981\u4f7f\u7528\u7684\u8d44\u6e90\u6765\u914d\u7f6e\u76ee\u6807\u8282\u70b9\uff0c\u4ece\u800c\u4f7f\u673a\u5668\u7684\u72b6\u6001\u53d1\u751f\u76f8\u5e94\u7684\u53d8\u5316\u3002</p> <p>\u4e3a\u4e86\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06\u5728\u672c\u5730\u5e94\u7528\u8d44\u6e90\u3002\u56e0\u4e3a\u6211\u4eec\u5728\u4e0a\u9762\u4f7f\u7528 <code>user = vipin</code> \u9884\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8d44\u6e90\u3002\u5e94\u7528\u8d44\u6e90\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u901a\u8fc7 CLI\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5c06\u5b8c\u6574\u8d44\u6e90\u91cd\u5199\u4e3a\u5355\u4e2a\u547d\u4ee4\u7136\u540e\u5c06\u5176\u4f20\u9012\u7ed9\u8d44\u6e90\u5b50\u547d\u4ee4\u6765\u5b8c\u6210\u3002</p> <pre><code>puppet resource user vipin ensure = present uid = '505'\nshell = '/bin/bash' home = '/home/vipin'\n</code></pre> <p>\u6d4b\u8bd5\u5e94\u7528\u7684\u8d44\u6e90\u3002</p> <pre><code>[root@puppetmaster ~]# cat /etc/passwd | grep \"vipin\"\nvipin:x:505:501::/home/vipin:/bin/bash\n</code></pre> <p>\u4e0a\u9762\u7684\u8f93\u51fa\u663e\u793a\u8d44\u6e90\u5df2\u5e94\u7528\u4e8e\u7cfb\u7edf\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a Vipin \u7684\u65b0\u7528\u6237\u3002\u5efa\u8bae\u60a8\u81ea\u884c\u6d4b\u8bd5\uff0c\u56e0\u4e3a\u4e0a\u8ff0\u6240\u6709\u4ee3\u7801\u90fd\u7ecf\u8fc7\u6d4b\u8bd5\u5e76\u4e14\u662f\u5de5\u4f5c\u4ee3\u7801\u3002</p>"},{"location":"chap6_pp/6pp_tmp_cls/","title":"6 Puppet - \u6a21\u677f &amp; \u7c7b","text":""},{"location":"chap6_pp/6pp_tmp_cls/#1","title":"1 \u6a21\u677f","text":"<p>Templating\u662f\u4e00\u79cd\u4ee5\u6807\u51c6\u683c\u5f0f\u83b7\u53d6\u5185\u5bb9\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u4f4d\u7f6e\u4f7f\u7528\u3002</p> <p>\u5728 Puppet \u4e2d\uff0c\u4f7f\u7528 erb \u652f\u6301\u6a21\u677f\u548c\u6a21\u677f\uff0cerb \u4f5c\u4e3a\u6807\u51c6 Ruby \u5e93\u7684\u4e00\u90e8\u5206\uff0c\u53ef\u7528\u4e8e\u9664 Ruby \u4e4b\u5916\u7684\u5176\u4ed6\u9879\u76ee\uff0c\u4f8b\u5982 Ruby on Rails \u9879\u76ee\u3002</p> <p>\u4f5c\u4e3a\u4e00\u79cd\u6807\u51c6\u505a\u6cd5\uff0c\u9700\u8981\u5bf9 Ruby \u6709\u57fa\u672c\u7684\u4e86\u89e3\u3002\u5f53\u7528\u6237\u5c1d\u8bd5\u7ba1\u7406\u6a21\u677f\u6587\u4ef6\u7684\u5185\u5bb9\u65f6\uff0c\u6a21\u677f\u5316\u975e\u5e38\u6709\u7528\u3002\u5f53\u65e0\u6cd5\u901a\u8fc7\u5185\u7f6e Puppet \u7c7b\u578b\u7ba1\u7406\u914d\u7f6e\u65f6\uff0c\u6a21\u677f\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002</p>"},{"location":"chap6_pp/6pp_tmp_cls/#_1","title":"\u8bc4\u4f30\u6a21\u677f","text":"<p>\u6a21\u677f\u4f7f\u7528\u7b80\u5355\u7684\u51fd\u6570\u8fdb\u884c\u8bc4\u4f30\u3002</p> <pre><code>$value = template (\"testtemplate.erb\")\n</code></pre> <p>\u53ef\u4ee5\u6307\u5b9a\u6a21\u677f\u7684\u5b8c\u6574\u8def\u5f84\uff0c\u4e5f\u53ef\u4ee5\u62c9\u53d6 Puppet \u7684\u6a21\u677f\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6a21\u677f\uff0c\u6a21\u677f\u76ee\u5f55\u901a\u5e38\u4f4d\u4e8e <code>/var/puppet/templates</code>\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c <code>puppet --configprint templatedir</code> \u627e\u5230\u76ee\u5f55\u4f4d\u7f6e\u3002</p> <p>\u6a21\u677f\u603b\u662f\u7531\u89e3\u6790\u5668\u800c\u4e0d\u662f\u5ba2\u6237\u7aef\u8bc4\u4f30\uff0c\u8fd9\u610f\u5473\u7740\u5982\u679c\u4f7f\u7528 puppetmasterd\uff0c\u90a3\u4e48\u6a21\u677f\u53ea\u9700\u8981\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u4e0d\u9700\u8981\u5c06\u5b83\u4eec\u4e0b\u8f7d\u5230\u5ba2\u6237\u7aef\u3002</p> <p>\u5ba2\u6237\u7aef\u5982\u4f55\u770b\u5f85\u4f7f\u7528\u6a21\u677f\u548c\u5c06\u6587\u4ef6\u7684\u6240\u6709\u5185\u5bb9\u6307\u5b9a\u4e3a\u5b57\u7b26\u4e32\u4e4b\u95f4\u6ca1\u6709\u533a\u522b\u3002\u8fd9\u6e05\u695a\u5730\u8868\u660e\uff0cpuppetmasterd \u5728 puppet \u542f\u52a8\u9636\u6bb5\u9996\u5148\u5b66\u4e60\u4e86\u7279\u5b9a\u4e8e\u5ba2\u6237\u7aef\u7684\u53d8\u91cf\u3002</p>"},{"location":"chap6_pp/6pp_tmp_cls/#_2","title":"\u4f7f\u7528\u6a21\u677f","text":"<p>\u4ee5\u4e0b\u662f\u4e3a\u6d4b\u8bd5\u7ad9\u70b9\u751f\u6210 tomcat \u914d\u7f6e\u7684\u793a\u4f8b\u3002</p> <pre><code>define testingsite($cgidir, $tracdir) { \n   file { \"testing-$name\": \n   path =&gt; \"/etc/tomcat/testing/$name.conf\", \n   owner =&gt; superuser, \n   group =&gt; superuser, \n   mode =&gt; 644, \n   require =&gt; File[tomcatconf], \n   content =&gt; template(\"testsite.erb\"), \n   notify =&gt; Service[tomcat] \n}  \n   symlink { \"testsym-$name\": \n      path =&gt; \"$cgidir/$name.cgi\", \n      ensure =&gt; \"/usr/share/test/cgi-bin/test.cgi\" \n   } \n} \n</code></pre> <p>\u4ee5\u4e0b\u662f\u6a21\u677f\u5b9a\u4e49\u3002</p> <pre><code>&lt;Location \"/cgi-bin/ &lt;%= name %&gt;.cgi\"&gt; \n   SetEnv TEST_ENV \"/export/svn/test/&lt;%= name %&gt;\" \n&lt;/Location&gt;  \n\n# You need something like this to authenticate users \n&lt;Location \"/cgi-bin/&lt;%= name %&gt;.cgi/login\"&gt; \n   AuthType Basic \n   AuthName \"Test\" \n   AuthUserFile /etc/tomcat/auth/svn \n   Require valid-user \n&lt;/Location&gt;\n</code></pre> <p>\u8fd9\u4f1a\u5c06\u6bcf\u4e2a\u6a21\u677f\u6587\u4ef6\u63a8\u9001\u5230\u4e00\u4e2a\u5355\u72ec\u7684\u6587\u4ef6\u4e2d\uff0c\u7136\u540e\u53ea\u9700\u544a\u8bc9 Apache \u52a0\u8f7d\u8fd9\u4e9b\u914d\u7f6e\u6587\u4ef6\u3002</p> <pre><code>Include /etc/apache2/trac/[^.#]*\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_3","title":"\u7ec4\u5408\u6a21\u677f","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u8f7b\u677e\u7ec4\u5408\u4e24\u4e2a\u6a21\u677f\u3002</p> <pre><code>template('/path/to/template1','/path/to/template2')\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_4","title":"\u6a21\u677f\u4e2d\u7684\u8fed\u4ee3","text":"<p>Puppet \u6a21\u677f\u8fd8\u652f\u6301\u6570\u7ec4\u8fed\u4ee3\u3002\u5982\u679c <code>variable one</code> \u6b63\u5728\u8bbf\u95ee\u7684\u53d8\u91cf\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u90a3\u4e48\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u8fed\u4ee3\u3002</p> <pre><code>$values = [val1, val2, otherval]\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u6709\u5982\u4e0b\u6a21\u677f\u3002</p> <pre><code>&lt;% values.each do |val| -%&gt;\nSome stuff with &lt;%= val %&gt;\n&lt;% end -%&gt;\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u5c06\u4ea7\u751f\u4ee5\u4e0b\u7ed3\u679c\u3002</p> <pre><code>Some stuff with val1\nSome stuff with val2\nSome stuff with otherval\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_5","title":"\u6a21\u677f\u4e2d\u7684\u6761\u4ef6","text":"<p>erb \u6a21\u677f\u652f\u6301\u6761\u4ef6\u3002\u4ee5\u4e0b\u6784\u9020\u662f\u6709\u6761\u4ef6\u5730\u5c06\u5185\u5bb9\u653e\u5165\u6587\u4ef6\u4e2d\u7684\u4e00\u79cd\u5feb\u901f\u7b80\u4fbf\u7684\u65b9\u6cd5\u3002</p> <pre><code>&lt;% if broadcast != \"NONE\" %&gt; broadcast &lt;%= broadcast %&gt; &lt;% end %&gt;\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_6","title":"\u6a21\u677f\u548c\u53d8\u91cf","text":"<p>\u9664\u4e86\u586b\u5199\u6587\u4ef6\u5185\u5bb9\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u6a21\u677f\u586b\u5199\u53d8\u91cf\u3002</p> <pre><code>testvariable = template('/var/puppet/template/testvar')\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_7","title":"\u672a\u5b9a\u4e49\u7684\u53d8\u91cf","text":"<p>\u5982\u679c\u9700\u8981\u5728\u4f7f\u7528\u53d8\u91cf\u4e4b\u524d\u68c0\u67e5\u53d8\u91cf\u662f\u5426\u5df2\u5b9a\u4e49\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <pre><code>&lt;% if has_variable?(\"myvar\") then %&gt;\nmyvar has &lt;%= myvar %&gt; value\n&lt;% end %&gt;\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#_8","title":"\u8d85\u51fa\u8303\u56f4\u7684\u53d8\u91cf","text":"<p>\u53ef\u4ee5\u4f7f\u7528 lookupvar \u51fd\u6570\u663e\u5f0f\u67e5\u627e\u8d85\u51fa\u8303\u56f4\u7684\u53d8\u91cf\u3002</p> <pre><code>&lt;%= scope.lookupvar('apache::user') %&gt;\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#sample-project-template","title":"Sample Project Template","text":"<pre><code>&lt;#Autogenerated by puppet. Do not edit. \n[default] \n#Default priority (lower value means higher priority) \npriority = &lt;%= @priority %&gt; \n#Different types of backup. Will be done in the same order as specified here. \n#Valid options: rdiff-backup, mysql, command \nbackups = &lt;% if @backup_rdiff %&gt;rdiff-backup, \n&lt;% end %&gt;&lt;% if @backup_mysql %&gt;mysql, \n&lt;% end %&gt;&lt;% if @backup_command %&gt;command&lt;% end %&gt; \n&lt;% if @backup_rdiff -%&gt;  \n\n[rdiff-backup]  \n\n&lt;% if @rdiff_global_exclude_file -%&gt; \n   global-exclude-file = &lt;%= @rdiff_global_exclude_file %&gt; \n&lt;% end -%&gt; \n   &lt;% if @rdiff_user -%&gt; \n      user = &lt;%= @rdiff_user %&gt; \n&lt;% end -%&gt; \n&lt;% if @rdiff_path -%&gt; \n   path = &lt;%= @rdiff_path %&gt; \n&lt;% end -%&gt;  \n\n#Optional extra parameters for rdiff-backup  \n\nextra-parameters = &lt;%= @rdiff_extra_parameters %&gt;  \n\n#How long backups are going to be kept \nkeep = &lt;%= @rdiff_keep %&gt; \n&lt;% end -%&gt; \n&lt;% if @backup_mysql -%&gt;%= scope.lookupvar('apache::user') %&gt;  \n\n[mysql]  \n\n#ssh user to connect for running the backup \nsshuser =  &lt;%= @mysql_sshuser %&gt;\n\n#ssh private key to be used \n   sshkey = &lt;%= @backup_home %&gt;/&lt;%= @mysql_sshkey %&gt; \n   &lt;% end -%&gt; \n&lt;% if @backup_command -%&gt;  \n[command] \n\n#Run a specific command on the backup server after the backup has finished  \n\ncommand = &lt;%= @command_to_execute %&gt; \n&lt;% end -%&gt;\n</code></pre>"},{"location":"chap6_pp/6pp_tmp_cls/#classes","title":"Classes","text":"<p>Puppet \u7c7b\u88ab\u5b9a\u4e49\u4e3a\u8d44\u6e90\u7684\u96c6\u5408\uff0c\u8fd9\u4e9b\u8d44\u6e90\u88ab\u7ec4\u5408\u5728\u4e00\u8d77\u4ee5\u4f7f\u76ee\u6807\u8282\u70b9\u6216\u673a\u5668\u5904\u4e8e\u6240\u9700\u72b6\u6001\u3002\u8fd9\u4e9b\u7c7b\u5728\u4f4d\u4e8e Puppet \u6a21\u5757\u5185\u7684 Puppet \u6e05\u5355\u6587\u4ef6\u4e2d\u5b9a\u4e49\u3002\u4f7f\u7528\u7c7b\u7684\u4e3b\u8981\u76ee\u7684\u662f\u51cf\u5c11\u4efb\u4f55\u6e05\u5355\u6587\u4ef6\u6216\u4efb\u4f55\u5176\u4ed6 Puppet \u4ee3\u7801\u4e2d\u7684\u76f8\u540c\u4ee3\u7801\u91cd\u590d\u3002</p> <p>\u4ee5\u4e0b\u662f Puppet \u7c7b\u7684\u793a\u4f8b\u3002</p> <pre><code>[root@puppetmaster manifests]# cat site.pp  \nclass f3backup ( \n   $backup_home   = '/backup', \n   $backup_server = 'default', \n   $myname        = $::fqdn, \n   $ensure        = 'directory', \n) { \n   include '::f3backup::common' \n   if ( $myname == '' or $myname == undef ) { \n      fail('myname must not be empty') \n   }  \n   @@file { \"${backup_home}/f3backup/${myname}\": \n      # To support 'absent', though force will be needed \n      ensure =&gt; $ensure, \n      owner  =&gt; 'backup', \n      group  =&gt; 'backup', \n      mode   =&gt; '0644', \n      tag    =&gt; \"f3backup-${backup_server}\", \n   }\n}\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u7528\u6237\u9700\u8981\u5b58\u5728\u7684\u5ba2\u6237\u7aef\u3002\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u6211\u4eec\u91cd\u590d\u4e86\u4e24\u6b21\u76f8\u540c\u7684\u8d44\u6e90\u3002\u5728\u7ec4\u5408\u4e24\u4e2a\u8282\u70b9\u65f6\u4e0d\u6267\u884c\u76f8\u540c\u4efb\u52a1\u7684\u4e00\u79cd\u65b9\u6cd5\u3002</p> <pre><code>[root@puppetmaster manifests]# cat site.pp \nnode 'Brcleprod001','Brcleprod002' { \n   user { 'vipin': \n      ensure =&gt; present, \n      uid    =&gt; '101', \n      shell  =&gt; '/bin/bash', \n      home   =&gt; '/home/homer', \n   } \n}\n</code></pre> <p>\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u5408\u5e76\u8282\u70b9\u6765\u6267\u884c\u914d\u7f6e\u5e76\u4e0d\u662f\u4e00\u4e2a\u597d\u7684\u505a\u6cd5\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u7c7b\u5e76\u5c06\u521b\u5efa\u7684\u7c7b\u5305\u542b\u5728\u8282\u70b9\u4e2d\u6765\u7b80\u5355\u5730\u5b9e\u73b0\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>class vipin_g01063908 { \n   user { 'g01063908': \n      ensure =&gt; present, \n      uid    =&gt; '101', \n      shell  =&gt; '/bin/bash', \n      home   =&gt; '/home/g01063908', \n   } \n}  \nnode 'Brcleprod001' { \n   class {vipin_g01063908:} \n}  \nnode 'Brcleprod002' { \n   class {vipin_g01063908:} \n}\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\u7c7b\u7ed3\u6784\u7684\u5916\u89c2\u4ee5\u53ca\u6211\u4eec\u5982\u4f55\u4f7f\u7528 class \u5173\u952e\u5b57\u6dfb\u52a0\u65b0\u8d44\u6e90\u3002 Puppet \u4e2d\u7684\u6bcf\u79cd\u8bed\u6cd5\u90fd\u6709\u81ea\u5df1\u7684\u7279\u70b9\u3002\u56e0\u6b64\uff0c\u9009\u62e9\u7684\u8bed\u6cd5\u53d6\u51b3\u4e8e\u6761\u4ef6\u3002</p>"},{"location":"chap6_pp/6pp_tmp_cls/#_9","title":"\u53c2\u6570\u5316\u7c7b","text":"<p>\u548c\u4e0a\u9762\u7684\u4f8b\u5b50\u4e00\u6837\uff0c\u6211\u4eec\u5df2\u7ecf\u770b\u5230\u4e86\u5982\u4f55\u521b\u5efa\u4e00\u4e2a\u7c7b\u5e76\u5c06\u5176\u5305\u542b\u5728\u4e00\u4e2a\u8282\u70b9\u4e2d\u3002</p> <p>\u73b0\u5728\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fdb\u884c\u4e0d\u540c\u7684\u914d\u7f6e\uff0c\u4f8b\u5982\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u4f7f\u7528\u76f8\u540c\u7684\u7c7b\u6709\u4e0d\u540c\u7684\u7528\u6237\u3002</p> <p>\u6b64\u529f\u80fd\u5728 Puppet \u4e2d\u4f7f\u7528\u53c2\u6570\u5316\u7c7b\u63d0\u4f9b\u3002\u65b0\u7c7b\u7684\u914d\u7f6e\u5c06\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>[root@puppetmaster ~]# cat /etc/puppet/manifests/site.pp \nclass user_account ($username){ \n   user { $username: \n      ensure =&gt; present, \n      uid    =&gt; '101', \n      shell  =&gt; '/bin/bash', \n      home   =&gt; \"/home/$username\", \n   } \n}  \nnode 'Brcleprod002' { \n   class { user_account: \n      username =&gt; \"G01063908\", \n   } \n} \nnode 'Brcleprod002' { \n   class {user_account: \n      username =&gt; \"G01063909\", \n   } \n} \n</code></pre> <p>\u5f53\u6211\u4eec\u5728\u8282\u70b9\u4e0a\u5e94\u7528\u4e0a\u8ff0 site.pp \u6e05\u5355\u65f6\uff0c\u6bcf\u4e2a\u8282\u70b9\u7684\u8f93\u51fa\u5c06\u5982\u4e0b\u6240\u793a\u3002</p> <p>Brcleprod001</p> <pre><code>[root@puppetagent1 ~]# puppet agent --test \nInfo: Retrieving pluginfacts \nInfo: Retrieving plugin \nInfo: Caching catalog for puppetagent1.testing.dyndns.org \nInfo: Applying configuration version '1419452655' \n\nNotice: /Stage[main]/User_account/User[homer]/ensure: created \nNotice: Finished catalog run in 0.15 seconds \n[root@brcleprod001 ~]# cat /etc/passwd | grep \"vipin\" \nG01063908:x:101:501::/home/G01063909:/bin/bash \n</code></pre> <p>Brcleprod002</p> <pre><code>[root@Brcleprod002 ~]# puppet agent --test \nInfo: Retrieving pluginfacts \nInfo: Retrieving plugin \nInfo: Caching catalog for puppetagent2.testing.dyndns.org \nInfo: Applying configuration version '1419452725' \n\nNotice: /Stage[main]/User_account/User[bart]/ensure: created \nNotice: Finished catalog run in 0.19 seconds \n[root@puppetagent2 ~]# cat /etc/passwd | grep \"varsha\" \nG01063909:x:101:501::/home/G01063909:/bin/bash\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u7c7b\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\uff0c\u5982\u4e0b\u9762\u7684\u4ee3\u7801\u6240\u793a\u3002</p> <pre><code>[root@puppetmaster ~]# cat /etc/puppet/manifests/site.pp \nclass user_account ($username = \u2018g01063908'){ \n   user { $username: \n      ensure =&gt; present, \n      uid    =&gt; '101', \n      shell  =&gt; '/bin/bash', \n      home   =&gt; \"/home/$username\", \n   } \n}  \nnode 'Brcleprod001' { \n   class {user_account:} \n}  \nnode 'Brcleprod002' { \n   class {user_account: \n      username =&gt; \"g01063909\", \n   } \n} \n</code></pre>"},{"location":"chap6_pp/7pp_func/","title":"7 Puppet - Function","text":""},{"location":"chap6_pp/7pp_func/#1-function","title":"1 Function","text":"<p>Puppet \u652f\u6301\u4efb\u4f55\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u7684\u529f\u80fd\uff0c\u56e0\u4e3a Puppet \u7684\u57fa\u672c\u5f00\u53d1\u8bed\u8a00\u662f Ruby\u3002\u5b83\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u51fd\u6570\uff0c\u79f0\u4e3a\u8bed\u53e5statement\u548crvalue\u3002</p> <ul> <li>Statements\u4ee3\u8868\uff0c\u5b83\u4eec\u6ca1\u6709\u4efb\u4f55\u8fd4\u56de\u7c7b\u578b\u3002\u5b83\u4eec\u7528\u4e8e\u6267\u884c\u72ec\u7acb\u4efb\u52a1\uff0c\u4f8b\u5982\u5728\u65b0\u6e05\u5355\u6587\u4ef6\u4e2d\u5bfc\u5165\u5176\u4ed6 Puppet \u6a21\u5757\u3002</li> <li>Rvalue \u8fd4\u56de\u503c\uff0c\u5e76\u4e14\u53ea\u80fd\u5728\u8bed\u53e5\u9700\u8981\u503c\u65f6\u4f7f\u7528\uff0c\u4f8b\u5982\u8d4b\u503c\u6216 case \u8bed\u53e5</li> </ul> <p>Puppet \u4e2d\u51fd\u6570\u6267\u884c\u7684\u5173\u952e\u5728\u4e8e\uff0c\u5b83\u53ea\u5728 Puppet master \u4e0a\u6267\u884c\uff0c\u5b83\u4eec\u4e0d\u5728\u5ba2\u6237\u7aef\u6216 Puppet \u4ee3\u7406\u4e0a\u6267\u884c\u3002</p> <p>\u56e0\u6b64\uff0c\u4ed6\u4eec\u53ea\u80fd\u8bbf\u95ee Puppet Master \u4e0a\u53ef\u7528\u7684\u547d\u4ee4\u548c\u6570\u636e\u3002\u5df2\u7ecf\u5b58\u5728\u4e0d\u540c\u7c7b\u578b\u7684\u529f\u80fd\uff0c\u751a\u81f3\u7528\u6237\u4e5f\u6709\u6743\u6839\u636e\u9700\u8981\u521b\u5efa\u81ea\u5b9a\u4e49\u529f\u80fd\u3002\u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5185\u7f6e\u51fd\u6570\u3002</p>"},{"location":"chap6_pp/7pp_func/#_1","title":"\u6587\u4ef6\u529f\u80fd","text":"<p>\u6587\u4ef6\u8d44\u6e90\u7684\u6587\u4ef6\u529f\u80fd\u662f\u5728 Puppet \u4e2d\u52a0\u8f7d\u4e00\u4e2a\u6a21\u5757\uff0c\u5e76\u4ee5\u5b57\u7b26\u4e32\u7684\u5f62\u5f0f\u8fd4\u56de\u6240\u9700\u7684\u8f93\u51fa\u3002\u5b83\u67e5\u627e\u7684\u53c2\u6570\u662f <code>&lt;module name&gt;/&lt;file&gt;</code> \u5f15\u7528\uff0c\u5b83\u6709\u52a9\u4e8e\u4ece Puppet \u6a21\u5757\u7684\u6587\u4ef6\u76ee\u5f55\u52a0\u8f7d\u6a21\u5757\u3002</p> <p>\u50cf <code>script/tesingscript.sh</code> \u4f1a\u4ece <code>&lt;module name&gt;/script/files/testingscript.sh</code> \u52a0\u8f7d\u6587\u4ef6\u3002</p> <p>\u51fd\u6570\u5177\u6709\u8bfb\u53d6\u548c\u63a5\u53d7\u7edd\u5bf9\u8def\u5f84\u7684\u80fd\u529b\uff0c\u8fd9\u6709\u52a9\u4e8e\u4ece\u78c1\u76d8\u4e0a\u7684\u4efb\u4f55\u4f4d\u7f6e\u52a0\u8f7d\u6587\u4ef6\u3002</p>"},{"location":"chap6_pp/7pp_func/#_2","title":"\u5305\u542b\u51fd\u6570","text":"<p>\u5728 Puppet \u4e2d\uff0cinclude \u51fd\u6570\u4e0e\u4efb\u4f55\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u4e2d\u7684 include \u51fd\u6570\u975e\u5e38\u76f8\u4f3c\u3002\u5b83\u7528\u4e8e\u58f0\u660e\u4e00\u4e2a\u6216\u591a\u4e2a\u7c7b\uff0c\u4ece\u800c\u8bc4\u4f30\u8fd9\u4e9b\u7c7b\u4e2d\u5b58\u5728\u7684\u6240\u6709\u8d44\u6e90\uff0c\u6700\u540e\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230\u76ee\u5f55\u4e2d\u3002\u5b83\u7684\u5de5\u4f5c\u65b9\u5f0f\u662f\uff0cinclude \u51fd\u6570\u63a5\u53d7\u7c7b\u540d\u3001\u7c7b\u5217\u8868\u6216\u4ee5\u9017\u53f7\u5206\u9694\u7684\u7c7b\u540d\u5217\u8868\u3002</p> <p>\u4f7f\u7528 include \u8bed\u53e5\u65f6\u8981\u8bb0\u4f4f\u7684\u4e00\u4ef6\u4e8b\u662f\uff0c\u5b83\u53ef\u4ee5\u5728\u4e00\u4e2a\u7c7b\u4e2d\u591a\u6b21\u4f7f\u7528\uff0c\u4f46\u6709\u4e00\u4e2a\u9650\u5236\uff0c\u5373\u53ea\u80fd\u5305\u542b\u4e00\u4e2a\u7c7b\u3002</p> <p>\u5982\u679c\u5305\u542b\u7684\u7c7b\u63a5\u53d7\u53c2\u6570\uff0c\u5219\u5305\u542b\u51fd\u6570\u5c06\u4f7f\u7528 <code>&lt;class name&gt;::&lt;parameter name&gt;</code> \u4f5c\u4e3a\u67e5\u627e\u952e\u81ea\u52a8\u67e5\u627e\u5b83\u4eec\u7684\u503c\u3002</p> <p>\u5305\u542b\u51fd\u6570\u4e0d\u4f1a\u5bfc\u81f4\u7c7b\u5728\u58f0\u660e\u65f6\u5305\u542b\u5728\u7c7b\u4e2d\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5305\u542b\u51fd\u6570\u3002\u5b83\u751a\u81f3\u4e0d\u4f1a\u5728\u58f0\u660e\u7684\u7c7b\u548c\u56f4\u7ed5\u5b83\u7684\u7c7b\u4e2d\u521b\u5efa\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u5728 include \u51fd\u6570\u4e2d\uff0c\u53ea\u5141\u8bb8\u4f7f\u7528\u7c7b\u7684\u5168\u540d\uff0c\u4e0d\u5141\u8bb8\u4f7f\u7528\u76f8\u5bf9\u540d\u79f0\u3002</p>"},{"location":"chap6_pp/7pp_func/#_3","title":"\u5b9a\u4e49\u51fd\u6570","text":"<p>\u5728 Puppet \u4e2d\uff0c\u5b9a\u4e49\u7684\u51fd\u6570\u6709\u52a9\u4e8e\u786e\u5b9a\u7ed9\u5b9a\u7c7b\u6216\u8d44\u6e90\u7c7b\u578b\u7684\u5b9a\u4e49\u4f4d\u7f6e\uff0c\u5e76\u8fd4\u56de\u5e03\u5c14\u503c\u6216\u4e0d\u8fd4\u56de\u3002\u8fd8\u53ef\u4ee5\u4f7f\u7528define \u6765\u786e\u5b9a\u662f\u5426\u5b9a\u4e49\u4e86\u7279\u5b9a\u8d44\u6e90\u6216\u5b9a\u4e49\u7684\u53d8\u91cf\u662f\u5426\u5177\u6709\u503c\u3002</p> <p>\u4f7f\u7528\u5b9a\u4e49\u51fd\u6570\u65f6\u8981\u8bb0\u4f4f\u7684\u5173\u952e\u70b9\u662f\uff0c\u8be5\u51fd\u6570\u81f3\u5c11\u63a5\u53d7\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570\uff0c\u53ef\u4ee5\u662f\u7c7b\u540d\u3001\u7c7b\u578b\u540d\u3001\u8d44\u6e90\u5f15\u7528\u6216\u201c$name\u201d\u5f62\u5f0f\u7684\u53d8\u91cf\u5f15\u7528\u3002</p> <p>\u5b9a\u4e49\u672c\u673a\u548c\u5df2\u5b9a\u4e49\u51fd\u6570\u7c7b\u578b\u7684\u51fd\u6570\u68c0\u67e5\uff0c\u5305\u62ec\u6a21\u5757\u63d0\u4f9b\u7684\u7c7b\u578b\u3002\u7c7b\u578bType\u548c\u7c7bClass\u7531\u5b83\u4eec\u7684\u540d\u79f0\u5339\u914d\u3002\u8be5\u51fd\u6570\u901a\u8fc7\u4f7f\u7528\u8d44\u6e90\u5f15\u7528\u5339\u914d\u8d44\u6e90\u51cf\u901f\u3002</p> <p>Define Function Matches</p> <pre><code># Matching resource types \ndefined(\"file\") \ndefined(\"customtype\")  \n\n# Matching defines and classes \ndefined(\"testing\") \ndefined(\"testing::java\")  \n\n# Matching variables \ndefined('$name')  \n\n# Matching declared resources \ndefined(File['/tmp/file']) \n</code></pre>"},{"location":"chap6_pp/7pp_func/#2","title":"2 \u81ea\u5b9a\u4e49\u51fd\u6570","text":"<p>\u51fd\u6570\u4e3a\u7528\u6237\u63d0\u4f9b\u4e86\u5f00\u53d1\u81ea\u5b9a\u4e49\u51fd\u6570\u7684\u7279\u6743\u3002 Puppet \u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u81ea\u5b9a\u4e49\u51fd\u6570\u6765\u6269\u5c55\u5176\u89e3\u91ca\u80fd\u529b\u3002\u81ea\u5b9a\u4e49\u51fd\u6570\u6709\u52a9\u4e8e\u589e\u52a0\u548c\u6269\u5c55 Puppet \u6a21\u5757\u548c\u6e05\u5355\u6587\u4ef6\u7684\u529f\u80fd\u3002</p>"},{"location":"chap6_pp/7pp_func/#_4","title":"\u7f16\u5199\u81ea\u5b9a\u4e49\u51fd\u6570","text":"<p>\u5728\u7f16\u5199\u51fd\u6570\u4e4b\u524d\uff0c\u6709\u51e0\u4ef6\u4e8b\u60c5\u9700\u8981\u8bb0\u4f4f\u3002</p> <ul> <li>\u5728 Puppet \u4e2d\uff0c\u51fd\u6570\u7531\u7f16\u8bd1\u5668\u6267\u884c\uff0c\u8fd9\u610f\u5473\u7740\u6240\u6709\u51fd\u6570\u90fd\u5728 Puppet master \u4e0a\u8fd0\u884c\uff0c\u5b83\u4eec\u4e0d\u9700\u8981\u5904\u7406\u4efb\u4f55 Puppet \u5ba2\u6237\u7aef\u3002\u529f\u80fd\u53ea\u80fd\u4e0e\u4ee3\u7406\u4ea4\u4e92\uff0c\u63d0\u4f9b\u7684\u4fe1\u606f\u662f\u4e8b\u5b9e\u7684\u5f62\u5f0f\u3002</li> <li>Puppet master \u6355\u83b7\u81ea\u5b9a\u4e49\u51fd\u6570\uff0c\u8fd9\u610f\u5473\u7740\u5982\u679c\u5bf9 Puppet \u51fd\u6570\u8fdb\u884c\u4e00\u4e9b\u66f4\u6539\uff0c\u5219\u9700\u8981\u91cd\u65b0\u542f\u52a8 Puppet master\u3002</li> <li>\u51fd\u6570\u5c06\u5728\u670d\u52a1\u5668\u4e0a\u6267\u884c\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u51fd\u6570\u9700\u8981\u7684\u4efb\u4f55\u6587\u4ef6\u90fd\u5e94\u8be5\u5b58\u5728\u4e8e\u670d\u52a1\u5668\u4e0a\uff0c\u5982\u679c\u8be5\u51fd\u6570\u9700\u8981\u76f4\u63a5\u8bbf\u95ee\u5ba2\u6237\u7aef\u8ba1\u7b97\u673a\uff0c\u5219\u65e0\u6cd5\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002</li> <li>\u5b8c\u5168\u6709\u4e24\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u51fd\u6570\u53ef\u7528\uff0c\u4e00\u79cd\u662f\u8fd4\u56de\u503c\u7684 Rvalue \u51fd\u6570\u548c\u4e0d\u8fd4\u56de\u4efb\u4f55\u5185\u5bb9\u7684\u8bed\u53e5\u51fd\u6570\u3002</li> <li>\u5305\u542b\u51fd\u6570\u7684\u6587\u4ef6\u540d\u5e94\u4e0e\u6587\u4ef6\u4e2d\u7684\u51fd\u6570\u540d\u76f8\u540c\u3002\u5426\u5219\uff0c\u5b83\u4e0d\u4f1a\u81ea\u52a8\u52a0\u8f7d</li> </ul>"},{"location":"chap6_pp/7pp_func/#_5","title":"\u653e\u7f6e\u81ea\u5b9a\u4e49\u51fd\u6570\u7684\u4f4d\u7f6e","text":"<p>\u6240\u6709\u81ea\u5b9a\u4e49\u51fd\u6570\u90fd\u5b9e\u73b0\u4e3a\u5355\u72ec\u7684 .rb \u6587\u4ef6\u5e76\u5206\u5e03\u5728\u6a21\u5757\u4e4b\u95f4\u3002\u9700\u8981\u5c06\u81ea\u5b9a\u4e49\u51fd\u6570\u653e\u5728 <code>lib/puppet/parser/function</code> \u4e2d\u3002\u53ef\u4ee5\u4ece\u4ee5\u4e0b\u4f4d\u7f6e\u4ece .rb \u6587\u4ef6\u52a0\u8f7d\u51fd\u6570\u3002</p> <ul> <li><code>$libdir/puppet/parser/functions</code></li> <li><code>puppet/parser/functions sub-directories in your Ruby $LOAD_PATH</code></li> </ul>"},{"location":"chap6_pp/7pp_func/#_6","title":"\u521b\u5efa\u65b0\u51fd\u6570","text":"<p>\u4f7f\u7528 <code>puppet::parser::Functions</code> \u6a21\u5757\u4e2d\u7684 newfunction \u65b9\u6cd5\u521b\u5efa\u6216\u5b9a\u4e49\u65b0\u51fd\u6570\u3002\u9700\u8981\u5c06\u51fd\u6570\u540d\u79f0\u4f5c\u4e3a\u7b26\u53f7\u4f20\u9012\u7ed9 newfunction \u65b9\u6cd5\uff0c\u5e76\u5c06\u4ee3\u7801\u4f5c\u4e3a\u5757\u8fd0\u884c\u3002\u4ee5\u4e0b\u793a\u4f8b\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u7528\u4e8e\u5c06\u5b57\u7b26\u4e32\u5199\u5165 /user \u76ee\u5f55\u5185\u7684\u6587\u4ef6\u3002</p> <pre><code>module Puppet::Parser::Functions \n   newfunction(:write_line_to_file) do |args| \n      filename = args[0] \n      str = args[1] \n      File.open(filename, 'a') {|fd| fd.puts str } \n   end \nend\n</code></pre> <p>Once the user has the function declared, it can be used in the manifest file as shown below.</p> <pre><code>write_line_to_file('/user/vipin.txt, \"Hello vipin!\")\n</code></pre>"},{"location":"chap6_pp/8pp_env/","title":"8 Puppet - \u73af\u5883","text":"<p>\u5728\u8f6f\u4ef6\u5f00\u53d1\u548c\u4ea4\u4ed8\u6a21\u578b\u4e2d\uff0c\u6709\u4e0d\u540c\u7c7b\u578b\u7684\u6d4b\u8bd5\u73af\u5883\u7528\u4e8e\u6d4b\u8bd5\u7279\u5b9a\u4ea7\u54c1\u6216\u670d\u52a1\u3002\u4f5c\u4e3a\u6807\u51c6\u5b9e\u8df5\uff0c\u4e3b\u8981\u6709\u5f00\u53d1\u3001\u6d4b\u8bd5\u548c\u751f\u4ea7\u4e09\u79cd\u73af\u5883\uff0c\u5176\u4e2d\u6bcf\u79cd\u73af\u5883\u90fd\u6709\u81ea\u5df1\u7684\u8bbe\u7f6e\u914d\u7f6e\u3002</p> <p>Puppet \u652f\u6301\u4e0e Ruby on Rails \u4e00\u6837\u7684\u591a\u73af\u5883\u7ba1\u7406\u3002\u521b\u5efa\u8fd9\u4e9b\u73af\u5883\u80cc\u540e\u7684\u5173\u952e\u56e0\u7d20\u662f\u63d0\u4f9b\u4e00\u79cd\u7b80\u5355\u7684\u673a\u5236\u6765\u7ba1\u7406\u4e0d\u540c\u7ea7\u522b\u7684 SLA \u534f\u8bae\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u673a\u5668\u603b\u662f\u9700\u8981\u5728\u6ca1\u6709\u4efb\u4f55\u5bb9\u5fcd\u548c\u4f7f\u7528\u65e7\u8f6f\u4ef6\u7684\u60c5\u51b5\u4e0b\u542f\u52a8\u3002\u5176\u4e2d\u5176\u4ed6\u73af\u5883\u662f\u6700\u65b0\u7684\u5e76\u7528\u4e8e\u6d4b\u8bd5\u76ee\u7684\u3002\u5b83\u4eec\u7528\u4e8e\u5347\u7ea7\u66f4\u91cd\u8981\u7684\u673a\u5668\u3002</p> <p>Puppet \u5efa\u8bae\u575a\u6301\u6807\u51c6\u7684\u751f\u4ea7\u3001\u6d4b\u8bd5\u200b\u200b\u548c\u5f00\u53d1\u73af\u5883\u914d\u7f6e\uff0c\u7136\u800c\uff0c\u5b83\u751a\u81f3\u4e3a\u7528\u6237\u63d0\u4f9b\u4e86\u6839\u636e\u9700\u6c42\u521b\u5efa\u81ea\u5b9a\u4e49\u73af\u5883\u7684\u6760\u6746\u4f5c\u7528\u3002</p>"},{"location":"chap6_pp/8pp_env/#_1","title":"\u73af\u5883\u76ee\u6807","text":"<p>\u6309\u73af\u5883\u62c6\u5206\u8bbe\u7f6e\u7684\u4e3b\u8981\u76ee\u6807\u662f Puppet \u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u6a21\u5757\u548c\u6e05\u5355\u6765\u6e90\u3002\u7136\u540e\u53ef\u4ee5\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\u6d4b\u8bd5\u914d\u7f6e\u66f4\u6539\uff0c\u800c\u4e0d\u4f1a\u5f71\u54cd\u751f\u4ea7\u8282\u70b9\u3002\u8fd9\u4e9b\u73af\u5883\u8fd8\u53ef\u7528\u4e8e\u5728\u4e0d\u540c\u7684\u7f51\u7edc\u6765\u6e90\u4e0a\u90e8\u7f72\u57fa\u7840\u8bbe\u65bd\u3002</p>"},{"location":"chap6_pp/8pp_env/#puppet-master","title":"\u5728 Puppet Master \u4e0a\u4f7f\u7528\u73af\u5883","text":"<p>\u73af\u5883\u7684\u91cd\u70b9\u662f\u6d4b\u8bd5\u9700\u8981\u5c06\u6587\u4ef6\u7684\u54ea\u4e2a\u6e05\u5355\u3001\u6a21\u5757\u3001\u6a21\u677f\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u3002\u56e0\u6b64\uff0c\u5fc5\u987b\u5c06 Puppet \u914d\u7f6e\u4e3a\u4e3a\u8fd9\u4e9b\u4fe1\u606f\u63d0\u4f9b\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u6e90\u3002</p> <p>Puppet \u73af\u5883\u7684\u5b9e\u73b0\u53ea\u9700\u5c06 pre-environment \u90e8\u5206\u6dfb\u52a0\u5230\u670d\u52a1\u5668\u7684 <code>puppet.conf</code> \u5e76\u4e3a\u6bcf\u4e2a\u73af\u5883\u9009\u62e9\u4e0d\u540c\u7684\u914d\u7f6e\u6e90\u3002\u7136\u540e\u4f18\u5148\u4f7f\u7528\u8fd9\u4e9b\u9884\u73af\u5883\u90e8\u5206\u800c\u4e0d\u662f\u4e3b\u8981\u90e8\u5206</p> <pre><code>[main]\nmanifest = /usr/testing/puppet/site.pp\nmodulepath = /usr/testing/puppet/modules\n[development]\nmanifest = /usr/testing/puppet/development/site.pp\nmodulepath = /usr/testing/puppet/development/modules\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u5f00\u53d1\u73af\u5883\u4e2d\u7684\u4efb\u4f55\u5ba2\u6237\u7aef\u90fd\u5c06\u4f7f\u7528\u4f4d\u4e8e\u76ee\u5f55 <code>/usr/share/puppet/development</code> \u4e2d\u7684 <code>site.pp</code> \u6e05\u5355\u6587\u4ef6\uff0cPuppet \u5c06\u641c\u7d22 <code>/usr/share/puppet/development/modules</code> \u76ee\u5f55\u4e2d\u7684\u4efb\u4f55\u6a21\u5757.</p> <p>\u5728\u6709\u6216\u6ca1\u6709\u4efb\u4f55\u73af\u5883\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c Puppet \u5c06\u9ed8\u8ba4\u4e3a <code>site.pp</code> \u6587\u4ef6\u4ee5\u53ca\u5728\u4e3b\u914d\u7f6e\u90e8\u5206\u7684\u6e05\u5355\u548c\u6a21\u5757\u8def\u5f84\u503c\u4e2d\u6307\u5b9a\u7684\u76ee\u5f55\u3002</p> <p>\u53ea\u6709\u5c11\u6570\u914d\u7f6e\u5b9e\u9645\u4e0a\u5bf9\u914d\u7f6e\u9884\u73af\u5883\u6709\u610f\u4e49\uff0c\u6240\u6709\u8fd9\u4e9b\u53c2\u6570\u90fd\u56f4\u7ed5\u6307\u5b9a\u7528\u4e8e\u7f16\u8bd1\u5ba2\u6237\u7aef\u914d\u7f6e\u7684\u6587\u4ef6\u3002</p> <p>\u4ee5\u4e0b\u662f\u53c2\u6570\u3002</p> <ul> <li>Modulepath \u2212 \u5728 Puppet \u4e2d\uff0c\u4f5c\u4e3a\u57fa\u672c\u7684\u6807\u51c6\u6a21\u5f0f\uff0c\u6700\u597d\u6709\u4e00\u4e2a\u6240\u6709\u73af\u5883\u5171\u4eab\u7684\u6807\u51c6\u6a21\u5757\u76ee\u5f55\uff0c\u7136\u540e\u662f\u4e00\u4e2a\u53ef\u4ee5\u5b58\u50a8\u81ea\u5b9a\u4e49\u6a21\u5757\u7684\u9884\u73af\u5883\u76ee\u5f55\u3002\u6a21\u5757\u8def\u5f84\u662f Puppet \u67e5\u627e\u6240\u6709\u73af\u5883\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\u3002</li> <li>Templatedir \u2212 \u6a21\u677f\u76ee\u5f55\u662f\u4fdd\u5b58\u6240\u6709\u76f8\u5173\u6a21\u677f\u7248\u672c\u7684\u4f4d\u7f6e\u3002\u8be5\u6a21\u5757\u5e94\u8be5\u4f18\u5148\u4e8e\u8fd9\u4e9b\u8bbe\u7f6e\uff0c\u4f46\u662f\u5b83\u5141\u8bb8\u5728\u6bcf\u4e2a\u73af\u5883\u4e2d\u62e5\u6709\u7ed9\u5b9a\u6a21\u677f\u7684\u4e0d\u540c\u7248\u672c\u3002</li> <li>Manifest - \u8fd9\u5b9a\u4e49\u4e86\u7528\u4f5c\u5165\u53e3\u70b9\u811a\u672c\u7684\u914d\u7f6e\u3002</li> </ul> <p>\u901a\u8fc7\u591a\u4e2a\u6a21\u5757\uff0cPuppets \u6709\u52a9\u4e8e\u83b7\u5f97\u914d\u7f6e\u7684\u6a21\u5757\u5316\u3002\u53ef\u4ee5\u5728 Puppet \u4e2d\u4f7f\u7528\u591a\u79cd\u73af\u5883\uff0c\u5982\u679c\u4e3b\u8981\u4f9d\u8d56\u4e8e\u6a21\u5757\uff0c\u6548\u679c\u4f1a\u66f4\u597d\u3002</p> <p>\u901a\u8fc7\u5c06\u66f4\u6539\u5c01\u88c5\u5728\u6a21\u5757\u4e2d\uff0c\u66f4\u5bb9\u6613\u5c06\u66f4\u6539\u8fc1\u79fb\u5230\u73af\u5883\u4e2d\u3002\u6587\u4ef6\u670d\u52a1\u5668\u4f7f\u7528\u73af\u5883\u7279\u5b9a\u7684\u6a21\u5757\u8def\u5f84\uff1b</p> <p>\u5982\u679c\u4ece\u6a21\u5757\u63d0\u4f9b\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u5355\u72ec\u7684\u6302\u8f7d\u76ee\u5f55\uff0c\u5219\u6b64\u73af\u5883\u5c06\u80fd\u591f\u83b7\u53d6\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u6587\u4ef6\uff0c\u6700\u540e\u5f53\u524d\u73af\u5883\u4e5f\u5c06\u5728\u6e05\u5355\u6587\u4ef6\u4e2d\u7684 <code>$environment</code> \u53d8\u91cf\u4e2d\u53ef\u7528\u3002</p>"},{"location":"chap6_pp/8pp_env/#_2","title":"\u8bbe\u7f6e\u5ba2\u6237\u7aef\u73af\u5883","text":"<p>\u6240\u6709\u4e0e\u73af\u5883\u914d\u7f6e\u76f8\u5173\u7684\u914d\u7f6e\u90fd\u5728 <code>puppet.conf</code> \u6587\u4ef6\u4e2d\u5b8c\u6210\u3002</p> <p>\u8981\u6307\u5b9a Puppet \u5ba2\u6237\u7aef\u5e94\u8be5\u4f7f\u7528\u54ea\u4e2a\u73af\u5883\uff0c\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u7684 puppet.conf \u6587\u4ef6\u4e2d\u4e3a\u73af\u5883\u914d\u7f6e\u53d8\u91cf\u6307\u5b9a\u4e00\u4e2a\u503c</p> <pre><code>[puppetd]\nenvironment = Testing\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u4e0a\u8ff0\u5b9a\u4e49\u5b9a\u4e49\u4e86\u914d\u7f6e\u6587\u4ef6\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u5b83\u6b63\u5728\u6d4b\u8bd5\u7684\u73af\u5883\u3002</p> <p>\u4e5f\u53ef\u4ee5\u5728\u547d\u4ee4\u884c\u4e0a\u4f7f\u7528 -</p> <pre><code>#puppetd -\u2013environment = testing\n</code></pre> <p>\u53e6\u5916\uff0cPuppet \u8fd8\u652f\u6301\u5728\u73af\u5883\u914d\u7f6e\u4e2d\u4f7f\u7528\u52a8\u6001\u503c\u3002\u4e0e\u5b9a\u4e49\u9759\u6001\u503c\u4e0d\u540c\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u5229\u7528\u521b\u5efa\u81ea\u5b9a\u4e49\u4e8b\u5b9e\u6765\u521b\u5efa\u57fa\u4e8e\u4e00\u4e9b\u5176\u4ed6\u5ba2\u6237\u7aef\u5c5e\u6027\u6216\u5916\u90e8\u6570\u636e\u6e90\u7684\u5ba2\u6237\u7aef\u73af\u5883\u3002</p> <p>\u9996\u9009\u7684\u65b9\u6cd5\u662f\u4f7f\u7528\u81ea\u5b9a\u4e49\u5de5\u5177\u3002\u8fd9\u4e9b\u5de5\u5177\u80fd\u591f\u6307\u5b9a\u8282\u70b9\u7684\u73af\u5883\uff0c\u5e76\u4e14\u901a\u5e38\u66f4\u64c5\u957f\u6307\u5b9a\u8282\u70b9\u4fe1\u606f\u3002</p>"},{"location":"chap6_pp/8pp_env/#puppet","title":"Puppet \u641c\u7d22\u8def\u5f84","text":"<p>Puppet \u4f7f\u7528\u7b80\u5355\u7684\u641c\u7d22\u8def\u5f84\u6765\u786e\u5b9a\u9700\u8981\u5728\u76ee\u6807\u673a\u5668\u4e0a\u5e94\u7528\u54ea\u4e9b\u914d\u7f6e\u3002\u540c\u6837\uff0cPuppet \u4e2d\u7684\u641c\u7d22\u8def\u5f84\u5728\u5c1d\u8bd5\u83b7\u53d6\u9700\u8981\u5e94\u7528\u7684\u9002\u5f53\u503c\u65f6\u975e\u5e38\u6709\u7528\u3002\u4e0b\u9762\u5217\u51fa\u4e86\u591a\u4e2a\u4f4d\u7f6e\uff0cPuppet \u5728\u5176\u4e2d\u641c\u7d22\u9700\u8981\u5e94\u7528\u7684\u503c\u3002</p> <ul> <li>\u547d\u4ee4\u884c\u4e2d\u6307\u5b9a\u7684\u503c</li> <li>\u5728\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u90e8\u5206\u4e2d\u6307\u5b9a\u7684\u503c</li> <li>\u5728\u7279\u5b9a\u4e8e\u53ef\u6267\u884c\u6587\u4ef6\u7684\u90e8\u5206\u4e2d\u6307\u5b9a\u7684\u503c</li> <li>\u4e3b\u8981\u90e8\u5206\u4e2d\u6307\u5b9a\u7684\u503c</li> </ul>"},{"location":"chap6_pp/9app_type_pr/","title":"9 Puppet - \u7c7b\u578b\u548c\u63d0\u4f9b\u8005","text":"<p>Puppet \u7c7b\u578b\u7528\u4e8e\u5355\u72ec\u7684\u914d\u7f6e\u7ba1\u7406\u3002 Puppet \u6709\u4e0d\u540c\u7684\u7c7b\u578b\uff0c\u5982\u670d\u52a1\u7c7b\u578b\u3001\u5305\u7c7b\u578b\u3001\u63d0\u4f9b\u8005\u7c7b\u578b\u7b49\u3002\u5176\u4e2d\u6bcf\u79cd\u7c7b\u578b\u90fd\u6709\u63d0\u4f9b\u8005\u3002\u63d0\u4f9b\u8005\u5904\u7406\u4e0d\u540c\u5e73\u53f0\u6216\u5de5\u5177\u4e0a\u7684\u914d\u7f6e\u3002\u4f8b\u5982\uff0c\u5305\u7c7b\u578b\u6709 aptitude\u3001yum\u3001rpm \u548c DGM \u63d0\u4f9b\u7a0b\u5e8f\u3002\u79cd\u7c7b\u5f88\u591a\uff0cPuppet\u6db5\u76d6\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u9891\u8c31\u914d\u7f6e\u7ba1\u7406\u9879\uff0c\u9700\u8981\u7ba1\u7406\u3002</p> <p>Puppet \u4f7f\u7528 Ruby \u4f5c\u4e3a\u5176\u57fa\u7840\u8bed\u8a00\u3002\u5b58\u5728\u7684\u6240\u6709 Puppet \u7c7b\u578b\u548c\u63d0\u4f9b\u7a0b\u5e8f\u90fd\u662f\u7528 Ruby \u8bed\u8a00\u7f16\u5199\u7684\u3002</p> <p>\u7531\u4e8e\u5b83\u9075\u5faa\u6807\u51c6\u7f16\u7801\u683c\u5f0f\uff0c\u56e0\u6b64\u53ef\u4ee5\u7b80\u5355\u5730\u521b\u5efa\u5b83\u4eec\uff0c\u5982\u7ba1\u7406\u5b58\u50a8\u5e93\u7684 repo \u793a\u4f8b\u4e2d\u6240\u793a\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u7c7b\u578b repo \u548c\u63d0\u4f9b\u8005\u7684 svn \u548c git\u3002 repo \u7c7b\u578b\u7684\u7b2c\u4e00\u90e8\u5206\u662f\u7c7b\u578b\u672c\u8eab\u3002\u8fd9\u4e9b\u7c7b\u578b\u901a\u5e38\u5b58\u50a8\u5728 lib/puppet/type \u4e2d\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a repo.rb \u7684\u6587\u4ef6\u3002</p> <pre><code>$ touch repo.rb\n</code></pre> <p>\u5728\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <pre><code>Puppet::Type.newtype(:repo) do  \n@doc = \"Manage repos\"  \n   Ensurable   \n   newparam(:source) do \n      desc \"The repo source\"  \n\n      validate do |value| \n         if value =~ /^git/ \n            resource[:provider] = :git \n         else \n            resource[:provider] = :svn \n         end \n      end \n      isnamevar \n   end  \n\n   newparam(:path) do \n      desc \"Destination path\"  \n      validate do |value| \n         unless value =~ /^\\/[a-z0-9]+/ \n            raise ArgumentError , \"%s is not a valid file path\" % value \n         end \n      end \n   end \nend \n</code></pre> <p>In the above script, we have created a block <code>\"Puppet::Type.newtype(:repo) do\"</code> which creates a new type with the name repo.</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u6709<code>@doc</code>\uff0c\u5b83\u6709\u52a9\u4e8e\u6dfb\u52a0\u60f3\u8981\u6dfb\u52a0\u7684\u4efb\u4f55\u7ea7\u522b\u7684\u7ec6\u8282\u3002\u4e0b\u4e00\u4e2a\u8bed\u53e5\u662f Ensurable\uff1b\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u57fa\u672c\u7684 ensure \u5c5e\u6027\u3002 Puppet \u7c7b\u578b\u4f7f\u7528 ensure \u5c5e\u6027\u6765\u786e\u5b9a\u914d\u7f6e\u9879\u7684\u72b6\u6001\u3002</p>"},{"location":"chap6_pp/9app_type_pr/#example","title":"Example","text":"<pre><code>service { \"sshd\": \n   ensure =&gt; present, \n} \n</code></pre> <p>ensure \u8bed\u53e5\u544a\u8bc9 Puppet \u9664\u4e86\u4e09\u4e2a\u65b9\u6cd5\uff1a\u521b\u5efa\u3001\u9500\u6bc1\u548c\u5b58\u5728\u4e8e\u63d0\u4f9b\u7a0b\u5e8f\u4e2d\u3002\u8fd9\u4e9b\u65b9\u6cd5\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd -</p> <ul> <li>\u521b\u5efa\u8d44\u6e90\u7684\u547d\u4ee4</li> <li>\u5220\u9664\u8d44\u6e90\u7684\u547d\u4ee4</li> <li>\u68c0\u67e5\u8d44\u6e90\u662f\u5426\u5b58\u5728\u7684\u547d\u4ee4</li> </ul> <p>\u7136\u540e\u6211\u4eec\u9700\u8981\u505a\u7684\u5c31\u662f\u6307\u5b9a\u8fd9\u4e9b\u65b9\u6cd5\u53ca\u5176\u5185\u5bb9\u3002 Puppet \u56f4\u7ed5\u5b83\u4eec\u521b\u5efa\u652f\u6301\u57fa\u7840\u8bbe\u65bd\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3a source \u7684\u65b0\u53c2\u6570\u3002</p> <pre><code>newparam(:source) do \n   desc \"The repo source\" \n   validate do |value| \n      if value =~ /^git/ \n         resource[:provider] = :git \n      else \n         resource[:provider] = :svn \n      end \n   end \n   isnamevar \nend\n</code></pre> <p>\u6e90\u5c06\u544a\u8bc9\u5b58\u50a8\u5e93\u7c7b\u578b\u5728\u54ea\u91cc\u68c0\u7d22/\u514b\u9686/\u7b7e\u51fa\u6e90\u5b58\u50a8\u5e93\u3002\u5728\u6b64\uff0c\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3a validate \u7684\u94a9\u5b50\u3002\u5728\u63d0\u4f9b\u8005\u90e8\u5206\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86 git \u548c svn \u6765\u68c0\u67e5\u6211\u4eec\u5b9a\u4e49\u7684\u5b58\u50a8\u5e93\u7684\u6709\u6548\u6027\u3002</p> <p>\u6700\u540e\uff0c\u5728\u4ee3\u7801\u4e2d\u6211\u4eec\u53c8\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a path \u7684\u53c2\u6570\u3002</p> <pre><code>newparam(:path) do \n   desc \"Destination path\" \n   validate do |value| \n      unless value =~ /^\\/[a-z0-9]+/ \n         raise ArgumentError , \"%s is not a valid file path\" % value \n      end \n</code></pre> <p>\u8fd9\u662f\u6307\u5b9a\u5c06\u68c0\u7d22\u5230\u7684\u65b0\u4ee3\u7801\u653e\u5728\u4f55\u5904\u7684\u503c\u7c7b\u578b\u3002\u5728\u8fd9\u91cc\uff0c\u518d\u6b21\u4f7f\u7528 validate \u94a9\u5b50\u521b\u5efa\u4e00\u4e2a\u68c0\u67e5\u9002\u5f53\u6027\u503c\u7684\u5757\u3002</p>"},{"location":"chap6_pp/9app_type_pr/#subversion-provider-use-case","title":"Subversion Provider Use Case","text":"<p>\u8ba9\u6211\u4eec\u4ece\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684\u7c7b\u578b\u7684<code>Subversion Provider Use Case</code>\u5f00\u59cb\u3002</p> <pre><code>require 'fileutils' \nPuppet::Type.type(:repo).provide(:svn) do \n   desc \"SVN Support\"  \n\n   commands :svncmd =&gt; \"svn\" \n   commands :svnadmin =&gt; \"svnadmin\"  \n\n   def create \n      svncmd \"checkout\", resource[:name], resource[:path] \n   end  \n\n   def destroy \n      FileUtils.rm_rf resource[:path] \n   end  \n\n   def exists? \n      File.directory? resource[:path] \n   end \nend\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u9884\u5148\u5b9a\u4e49\u4e86\u6211\u4eec\u9700\u8981 fileutils \u5e93\uff0c\u9700\u8981\u6211\u4eec\u5c06\u4f7f\u7528\u65b9\u6cd5 from \u7684\u201cfileutils\u201d\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u63d0\u4f9b\u8005\u5b9a\u4e49\u4e3a <code>block Puppet::Type.type(:repo).provide(:svn) do</code>\uff0c\u5b83\u544a\u8bc9 Puppet \u8fd9\u662f\u540d\u4e3a repo \u7684\u7c7b\u578b\u7684\u63d0\u4f9b\u8005\u3002</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86 desc\uff0c\u5b83\u5141\u8bb8\u5411\u63d0\u4f9b\u7a0b\u5e8f\u6dfb\u52a0\u4e00\u4e9b\u6587\u6863\u3002\u6211\u4eec\u8fd8\u5b9a\u4e49\u4e86\u6b64\u63d0\u4f9b\u7a0b\u5e8f\u5c06\u4f7f\u7528\u7684\u547d\u4ee4\u3002\u5728\u4e0b\u4e00\u884c\u4e2d\uff0c\u6211\u4eec\u5c06\u68c0\u67e5\u8d44\u6e90\u7684\u7279\u6027\uff0c\u5982\u521b\u5efa\u3001\u5220\u9664\u548c\u5b58\u5728\u3002</p>"},{"location":"chap6_pp/9app_type_pr/#_1","title":"\u521b\u5efa\u8d44\u6e90","text":"<p>\u5b8c\u6210\u4e0a\u8ff0\u6240\u6709\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u5c06\u5728\u6211\u4eec\u7684\u7c7b\u548c\u6e05\u5355\u6587\u4ef6\u4e2d\u4f7f\u7528\uff0c\u5982\u4ee5\u4e0b\u4ee3\u7801\u6240\u793a\u3002</p> <pre><code>repo { \"wp\": \n   source =&gt; \"http://g01063908.git.brcl.org/trunk/\", \n   path =&gt; \"/var/www/wp\", \n   ensure =&gt; present, \n}\n</code></pre>"},{"location":"chap7_argocd/1Intro/","title":"1 Introduction to Continuous Delivery","text":"<p>https://academy.akuity.io/courses/gitops-argocd-intro </p>"},{"location":"chap7_argocd/1Intro/#1-introduction-to-continuous-delivery_1","title":"1 Introduction to Continuous Delivery","text":"<p>Like DevOps, Continuous Delivery (CD) is an organization's technological and cultural transformation.</p>"},{"location":"chap7_argocd/1Intro/#1-1-what-problems-does-continuous-delivery-solve","title":"1-1 What Problems Does Continuous Delivery Solve?","text":"<p>Continuous Delivery automates the manual, error-prone process of releasing code into production (or any environment)</p> <p>The goal is to codify the specialized knowledge from both the developers and operators responsible for releasing the software, freeing them from the toil of releases to focus on delivering value.</p> <p>Codifying the release process improves visibility into it. The steps required to go from a build to running in production are laid out and made accessible. This helps identify constraints to developer productivity and take a collaborative approach to improving daily work.</p> <p>Automating the release of code changes speeds up the delivery of value to the customer. Going from weeks or months before seeing a change in production, to having it in the hands of the users within days or even hours.</p> <p>Scaling a release process dependent on humans requires finding qualified personnel and training them. Continuous delivery can be scaled through improvements to the process that will persist well into the future.</p> <p>Continuous Delivery can include the underlying infrastructure and configuration for an environment.</p> <p>Leading to a better understanding of how environments are comprised and allowing them to be easily reproduced. </p> <p>This enables keeping lower environments as production-like as possible, reducing the risk of problems on release due to inconsistencies between environments.</p>"},{"location":"chap7_argocd/1Intro/#1-2-how-does-continuous-delivery-differ-from-continuous-integration","title":"1-2 How Does Continuous Delivery Differ From Continuous Integration?","text":"<p>Commonly, Continuous Integration (CI) and Continuous Delivery (CD) are found together and referred to as one thing (CI/CD). </p> <p>They are entangled since CI is an essential prerequisite for CD.</p> <p>CI is regularly merging code into a centralized branch. It focuses on detecting issues with the source code early in the development cycle using automated testing and linting to improve the feedback to developers. Enabling them to create value faster and fix issues when it's less costly.</p> <p>CD takes the changes that have been tested and integrated into the code base and automates the deployment of it into an environment.</p> <p>The build process can be considered CI or CD, depending on the implementation. If the automated tests run against the build, it could be considered Cl. </p> <p>If the build is not created until after the code has been integrated into the main branch and as a part of the deployment into an environment, then it would be CD.</p>"},{"location":"chap7_argocd/1Intro/#1-3-what-about-the-other-cd","title":"1-3 What about the other CD?","text":"<p>You may have heard about Continuous Deployment, a similar practice to Continuous Delivery. Both of these are often abbreviated to CD despite having distinct meanings.</p> <p>Continuous Delivery automates deploying a build artifact into an environment. Typically, the production release is gated with a requirement for a human to approve it manually. This practice doesn't account for the promotion between environments (i.e., from staging to production) or when to roll back a release.</p>"},{"location":"chap7_argocd/1Intro/#1-4-what-about-the-other-cd","title":"1-4 What about the other CD?","text":"<p>You may have heard about Continuous Deployment, a similar practice to Continuous Delivery. Both of these are often abbreviated to CD despite having distinct meanings.</p> <p>Continuous Delivery automates deploying a build artifact into an environment.</p> <p>Typically, the production release is gated with a requirement for a human to approve it manually. </p> <p>This practice doesn't account for the promotion between environments (i.e., from staging to production) or when to roll back a release.</p> <p>Continuous Deployment </p> <p>is the practice of automating the entire deployment lifecycle for an application without any human intervention. </p> <p>For example, once the code reaches the repository's main branch, it will </p> <ul> <li>Automatically go through testing</li> <li>Generating a build</li> <li>Releasing it into a staging environment</li> <li>Promoting it to production</li> </ul> <p>Only stopping if tests fail or a problem is detected from the telemetry (e.g., too many 500 status codes or errors in the application logs), triggering a rollback.</p> <p>Continuous Deployment is an essential part of Continuous Delivery.</p> <ul> <li>False</li> </ul> <p>False; </p> <ul> <li>Continuous Deployment is automating the entire deployment lifecycle for an application without any human intervention and requires complete incorporation of CI and CD (Continuous Delivery) practices.</li> </ul>"},{"location":"chap7_argocd/1Intro/#2-introduction-to-gitops","title":"2 Introduction to GitOps","text":""},{"location":"chap7_argocd/1Intro/#2-1-what-is-gitops","title":"2-1 What is GitOps?","text":"<p>The OpenGitOps project has established four key principles that define GitOps.</p> <ul> <li>Declarative - \"A system managed by GitOps must have its desired state expressed declaratively.\"</li> <li>Versioned and Immutable - \"Desired State is stored in a way that supports versioning, immutability of versions, and retains a complete version history.\"</li> <li>Pulled Automatically - \"Software agents automatically pull the desired state declarations from the source.'</li> <li>Continuously Reconciled - \"Software agents continuously observe actual system state and attempt to apply the desired state.\"</li> </ul> <p>GitOps is declaratively storing the desired state with immutable versions and using a software agent to reconcile the live state with the desired state.</p> <p>In the context of Kubernetes: Practicing GitOps is storing the Kubernetes manifests used in a cluster in Git and using a tool (e.g., Argo CD) to apply those manifests.</p>"},{"location":"chap7_argocd/1Intro/#2-2-push-vs-pull-models","title":"2-2 Push vs. Pull Models","text":"<p>Before practicing GitOps, many organizations used the push model, where changes are made to the cluster using a CI/CD pipeline. </p> <p>After changes have been pushed to the repo, it triggers the build of the software. </p> <p>Once the build is complete, it generates the manifests dynamically and applies them to the cluster from the pipeline.</p> <p></p> <p>The push model is considered \"imperative\" - a set of steps necessary to achieve the end goal. Essentially, instructions for how to deploy the build into an environment. </p> <p>This approach has several disadvantages, including:</p> <ul> <li>The workflow requires credentials with write access to the cluster and direct access to the cluster's API server.</li> <li>Since the cluster's state is established imperatively, reproducing it would require re-running all workflows that modify the cluster.</li> <li>To achieve the desired state, you must carefully plan every step in the sequence.Changes to the steps require detailed consideration and meticulous testing.</li> </ul> <p>GitOps uses the pull model. </p> <p>After changes have been made in the repo, it triggers the build and, once complete, updates the manifests for the desired state in the environment configuration repository. </p> <p>The GitOps agent (e.g., Argo CD) will pull the change from the repo and apply it to the cluster.</p> <p></p> <p>The pull model is \"declarative\", meaning that you define what should exist while relying on the tooling to figure out the implementation. This approach has many advantages:</p> <ul> <li>Repeatability: With a declarative desired state, deployments are repeatable, and environments can be easily recreated.</li> <li>Collaboration: Changes are made through Pull Requests, enabling a similar review process as used for changes to source code.</li> <li>Visibility: The commit history indicates how the desired state changed and why.</li> <li>Consistency: Changes to the collective desired state of the cluster must first be integrated into the environment configuration repository.</li> <li>Security: The workflow does not have credentials with write access or direct access to the cluster. The source of truth comes from a trusted repository and is applied using a service operating within your infrastructure (or cluster).</li> </ul>"},{"location":"chap7_argocd/1Intro/#2-3-how-are-gitops-and-continuous-delivery-related","title":"2-3 How are GitOps and Continuous Delivery Related?","text":"<p>GitOps is a framework for managing the state of environments where CD focuses on the automation of the changes.</p> <p>CD and GitOps work together to accomplish the same objective of delivering software faster and with better quality through automation and continuous feedback.</p> <p>GitOps changes how CD workflows interact with the infrastructure, pulling changes from an environment configuration repository instead of pushing them into the cluster.</p> <ul> <li>GitOps implements pushing into the cluster as a part of the CI workflow.</li> </ul> <p>False; GitOps uses the pull model independent of a CI workflow.</p>"},{"location":"chap7_argocd/1Intro/#2-introduction-to-argocd","title":"2 Introduction to ArgoCD","text":""},{"location":"chap7_argocd/1Intro/#2-1-what-is-argo-cd","title":"2-1 What is Argo CD?","text":"<p>The answer depends on who you ask. From the perspective of:</p> <ul> <li>Non-technical business leadership</li> </ul> <p>Argo CD is a software that helps organizations achieve faster time-to-market by automating the deployment of internal and customer-facing application features and updates. </p> <p>It provides better visibility, simplifies compliance, and increases developer productivity.</p> <ul> <li>An application developer</li> </ul> <p>Argo CD is a tool that automates deploying, updating, and managing applications using a command line tool, an elegant web UI, and configurations in git.</p> <ul> <li>A cluster administrator </li> </ul> <p>Argo CD is a control plane for automating Kubernetes cluster management using Continuous Delivery and GitOps practices.</p> <p>Argo CD is a robust tool for deploying applications in multi-cluster environments. </p> <p>It supports a variety of architectures, from running an instance in each cluster to a single-control plane that can manage many clusters.</p> <p></p>"},{"location":"chap7_argocd/1Intro/#2-2-how-does-argo-cd-relate-to-gitops","title":"2-2 How does Argo CD relate to GitOps?","text":"<p>Argo CD is commonly used to implement GitOps practices with Kubernetes. </p> <p>It acts as the software agent that automatically pulls the desired state from the specified source (e.g., the environment configuration repository) and continuously reconciles it with the live state of the cluster. <p></p>"},{"location":"chap7_argocd/1Intro/#2-3-how-does-argo-cd-relate-to-continuous-delivery","title":"**2-3 How does Argo CD relate to Continuous Delivery","text":"<p>(CD)?**</p> <p>In a Continous Delivery workflow, where building, testing, configuring, and deploying an application is automated, Argo CD is used to deploy the application and its configuration to Kubernetes.</p> <p></p> <p>The Argo CD API / CLI can be integrated into workflows to trigger the deployment. </p> <p>When following GitOps principles, the workflows can update the manifests in a configuration repository and Argo CD will automatically pick up the changes and deploy them to the cluster.</p>"},{"location":"chap7_argocd/1Intro/#2-3-argo-cd-and-kubernetes","title":"2-3 Argo CD and Kubernetes","text":"<p>Argo CD and its configurations are represented by Custom Resource Definitions (CRDs) in Kubernetes. </p> <p>Administrators already familiar with Kubernetes will be able to easily understand and work with the configuration in the YAML manifests. </p> <p>The configurations are portable between Kubernetes clusters, regardless of the underlying infrastructure.</p> <p></p> <p>Using CDs promotes declarative management of the configuration. This simplifies the integration of GitOps practices for managing changes to the desired state of Argo CD. </p> <p>After the initial bootstrapping, Argo CD can then manage itself the same way it would any other Kubernetes resource.</p> <p>Beyond the improved usability, being Kubernetes-native allows for better integration with the rest of the Kubernetes ecosystem. </p> <p>This enables community-driven projects to extend the functionality of Argo CD. </p> <p>For example, the \"argocd-vault-plugin\" project, which aims \"at helping to solve the issue of secret management with GitOps and Argo CD.\" </p> <p>More Argo Project ecosystem and community projects can be found https://github.com/argoproj-labs</p>"},{"location":"chap7_argocd/1Intro/#3-the-argo-cd-application-resource","title":"3 The Argo CD Application Resource","text":""},{"location":"chap7_argocd/1Intro/#3-1-what-is-an-argo-cd-application","title":"3-1 What is an Argo CD Application?","text":"<p>The Application CRD is the most significant resource introduced by Argo CD. </p> <p>It declaratively defines the deployment process for manifests into Kubernetes. </p> <p>Including where to source the manifests, how to render them, when to deploy the resources, when to reconcile the live state with the desired state, and much more.</p> <p>Below is a complete and functional example of an Argo CD Application manifest.</p> <p></p> <p>This Application will automatically deploy the Helm chart from the <code>helm-guestbook/</code> path in the <code>argoproj/argocd-example-apps</code> GitHub repository with the <code>values-production.yaml</code> values file to the guestbook namespace in the dev cluster.</p> <p>The sync policy will run automatically as changes are made in the repository</p> <p>self-heal resources that deviate from the desired state, and create the namespace if needed.</p>"},{"location":"chap7_argocd/1Intro/#3-2-how-does-an-application-determine-what-resources-to-deploy","title":"3-2 How Does an Application Determine What Resources to Deploy?","text":"<p>Applications use a config management tool, a source repository and path, and a target revision to render the manifests and determine the difference between the desired and live states.</p> <p>In this example, the source is the <code>argoproj/argocd-example-apps</code> GitHub repository and its <code>helm- guestbook</code> path. </p> <p>The source also specifies to use the values-production.yaml file from the path as a values file for the Helm chart.</p> <pre><code>source:\n    repoURL:https://github.com/argoproj/argocd-example-apps\n    path: helm-guestbook/\nhelm:\n    valueFiles:\n    - values-production.yaml\n</code></pre> <p>Argo CD has built-in support for common config management tools (e.g., Helm, kustomize) and also supports plain YAML. </p> <p>Beyond this, you can integrate any tool into Argo CD using a config management plugin (CMP). This mechanism provides a way to add additional tooling for use by Applications. </p> <p>Tool detection can happen automatically based on the files found in the source repository path.</p> <p>The source can be a Git repository or a Helm chart repository. </p> <p>When using a Git repository, the target revision can track branches or tags, or be pinned to a specific commit. </p> <p>Otherwise, for Helm, the target revision will be the chart version.</p> <p>Argo CD adds labels or annotations (depending on the method used) to the resources deployed by an Application to keep track of them.</p>"},{"location":"chap7_argocd/1Intro/#3-3-how-does-an-application-know-where-to-deploy-resources","title":"3-3 How Does An Application Know Where To Deploy Resources?","text":"<p>Argo CD can deploy resources to the cluster it is running in or to connected clusters. </p> <p>In the Application manifest, the desired location is represented in the \" destination' field with either the name or server URL of the cluster and the namespace in it.</p> <p>In this example, the resources will be deployed to the guestbook namespace in the connected cluster named dev.</p> <pre><code>destination:\n    name: \"dev\"\nnamespace: \"questbook\"\n</code></pre>"},{"location":"chap7_argocd/1Intro/#3-4-what-does-it-mean-to-sync-an-application","title":"3-4 What Does it Mean To Sync An Application?","text":"<p>Syncing an Application will reconcile the live state of the cluster with the desired state as defined in the source. </p> <p>Each Application has a sync policy that defines how to handle the reconciliation.</p> <p>The policy defines whether the sync should be triggered manually ( by clicking a button, using the CLI, or the API) or automatically as the changes are made to the source. Additionally, the policy can customize numerous characteristics of how the Application syncs resources.</p> <p>In this example, it will automatically create the namespace in the destination cluster and self-heal itself if a resource in the cluster deviates from the desired state.</p> <pre><code>syncPolicy:\n    syncOptions:\n    - CreateNamespace=true\n    automated:\n        selfHeal: true\n</code></pre>"},{"location":"chap7_argocd/1Intro/#3-5-what-is-application-health","title":"3-5 What is Application Health?","text":"<p>What is Application Health?</p> <p>Argo CD provides health checks for many common Kubernetes resources, including the standard Deployment resource and other Kubernetes projects like the cert-manager Certificate resource. </p> <p>The Application then provides overall health depending on the health of its resources.</p> <p>There are five health statuses for resources:</p> <ol> <li>Healthy - The resource is running as expected.</li> <li>Progressing - The resource is in the process of being updated or created.</li> <li>Degraded - The resource is running, but a problem requires attention. For example, a pod may be failed due to an ImagePullBackOff error.</li> <li>Missing - The resource does not exist in the cluster because it was not created or deleted</li> <li>Suspended - The resource is waiting for an external event (e.g., a suspended CronJob or a paused Deployment).</li> </ol> <p>When an Application's health is Degraded, a resource is missing or hasn't been created yet. (False)</p> <p>The Degraded status indicates that a resource is running, but a problem requires attention.</p> <p>An Application sync is triggered when a new tag is created in a container registry. (False\uff09</p> <p>An Application sync can be triggered manually via the UI, CLI, or API or automatically when changes are detected in the source.</p>"},{"location":"chap7_argocd/1Intro/#4-lab","title":"4 Lab","text":"<p><code>leaderboard-dev.yaml</code></p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: 'leaderboard-dev'\nspec:\n  destination:\n    name: 'in-cluster'\n    namespace: 'dev'\n  source:\n    path: 'charts/leaderboard'\n    repoURL: 'ssh://root@10.5.0.206/root/argo-cd-learning-assets/'\n    targetRevision: HEAD\n    helm:\n      valueFiles:\n      - values-dev.yaml\n  project: 'default'\n  syncPolicy:\n    syncOptions:\n      - CreateNamespace=true\n</code></pre> <p><code>values-dev.yaml</code></p> <pre><code>replicaCount: 1\nimage:\n  tag: 0.5.3\n</code></pre> <p>This manifest describes an Application.</p> <ul> <li>The name of the Application is <code>leaderboard-dev</code></li> <li>The source is your GitOps repo, pointing to the <code>leaderboard</code> Helm chart.</li> <li>The <code>values-dev.yaml</code> file is being passed to the chart.</li> <li>The destination is the cluster Argo CD is running in and the <code>dev</code> namespace.</li> <li>The sync policy will automatically create the namespace.</li> </ul> <p></p> <p></p> <p></p>"},{"location":"chap7_argocd/1Intro/#auto-sync","title":"Auto Sync","text":"<p>You will enable auto-sync so that this and any future changes will be automatically applied\u2014removing the need for developers to manually trigger a deployment for changes that already made it through the approval processes (e.g., a pull request).</p> <ol> <li>In the top menu, click APP DETAILS.</li> <li>Under the <code>SYNC POLICY</code> section, click <code>ENABLE AUTO-SYNC</code> and on the prompt, click OK.</li> <li>Below that, on the right of <code>\"SELF HEAL\"</code>, click <code>ENABLE</code> and on the prompt, click <code>OK</code>.</li> </ol> <p></p> <p></p> <p></p> <p></p> <p><code>leaderboard-prod.yam</code></p>"}]}